{% load staticfiles %}
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
        <link href="{% static 'vendors/bootstrap/dist/css/bootstrap.min.css' %}" rel="stylesheet">
        <!-- Font Awesome -->
        <link href="{% static 'vendors/font-awesome/css/font-awesome.min.css'%}" rel="stylesheet">
        <!-- NProgress -->
        <link href="{% static 'vendors/nprogress/nprogress.css'%}" rel="stylesheet">
        <!-- bootstrap-daterangepicker -->
        <link href="{% static 'vendors/bootstrap-daterangepicker/daterangepicker.css'%}" rel="stylesheet">
    
        <!-- Custom Theme Style -->
        <link href="{% static 'build/css/custom.css'%}" rel="stylesheet">
        <link rel="stylesheet" href="{% static 'production/plugins/layui-v2.2.5/layui/css/layui.css'%}"  media="all">
        <!--<link rel="stylesheet" href="plugins/calendar/laydate.css" />-->
        <link rel="stylesheet" href="{% static 'production/plugins/calendar/laydate.css'%}" />
	</head>
	<body style="background: #fff">
		<div id="form_box" style="display: none;"style="overflow-x: hidden;">

		</div>
		<div class="title_left">
        	<h3 style="margin: 10px auto;">&nbsp;&nbsp;<small>宿主机</small></h3>
    	</div>
		<div class="container">
			<div class="row">
				<div class="col-md-3 col-sm-3 col-xs-3 col-md-offset-1">
					<input type="text" placeholder="设备名,输入多个请以,隔开" name="country" id="txt-machine" class="form-control col-md-10" autocomplete="off">
                </div>
                <div class="col-md-2 col-sm-2 col-xs-2" >
                	<select class="form-control" id="osel-group">
                       <option value="" selected>全部</option>
							{% for g in  group %}
							<option value="{{g.id}}">{{g.Group_Name}}</option>
	                        <!--<option value="">主机组</option>-->
	                        <!--<option value="1">group1</option>-->
	                        <!--<option value="2">group2</option>-->
	                        <!--<option value="3">group3</option>-->
							{% endfor %}

                    </select>
            	</div>
				<!--<div class="col-md-2 col-sm-2 col-xs-2">-->
					<!--<select class="form-control">	                            	-->
                        <!--<option value="">设备类型</option>-->
                        <!--<option value="1">X86</option>-->
                        <!--<option value="2">小型机</option>-->
                        <!--<option value="3">刀片</option>     -->
                    <!--</select>-->
       			<!--</div>-->
				<div class="col-md-1 col-sm-1 col-xs-1">
					<button type="submit" class="btn btn-success" id="btn-search">查询</button>
				</div>
				
				
			</div>
			<div class="row">
				
			</div>
			<div class="row">
				<div style="width: 90%; margin: 0 auto;">
					<table class="layui-hide" id="test"></table>
				</div>
				
			</div>
			<div class="row" style="text-align: center;">
				<div style="width: 100%; margin: 0 auto;">
					<div class="col-md-1 col-sm-1 col-xs-1 col-md-1 col-md-offset-1">
						<p  style="width: 100%; text-align: center; line-height: 32px;">性能展示</p>
					</div>
					<div class="col-md-3 col-sm-3 col-xs-3">
						<input placeholder="发生时间" class="laydate-icon" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" id="startTime">
					</div>
					<div class="col-md-3 col-sm-3 col-xs-3">
						<input placeholder="结束时间" class="laydate-icon" onclick="laydate({istime: true, format: 'YYYY-MM-DD hh:mm:ss'})" id="endTime">
					</div>
					<div class="col-md-1 col-sm-1 col-xs-1">
						<button type="submit" class="btn btn-success" id="btn-refresh">刷新</button>
					</div>
				</div>
			</div>
			<!--<div class="row">-->
				<!--<div class="col-md-1 col-sm-1 col-xs-1 col-md-1 col-md-offset-1">-->
						<!--<p  style="width: 100%; text-align: center; line-height: 32px;">报表导出</p>-->
				<!--</div>-->
				<!--&lt;!&ndash;<div class="col-md-1 col-sm-1 col-xs-1">&ndash;&gt;-->
						<!--&lt;!&ndash;<div class="checkbox">&ndash;&gt;-->
						  <!--&lt;!&ndash;<label>&ndash;&gt;-->
						    <!--&lt;!&ndash;<input type="checkbox" value="">&ndash;&gt;-->
						    <!--&lt;!&ndash;CPU&ndash;&gt;-->
						  <!--&lt;!&ndash;</label>&ndash;&gt;-->
						<!--&lt;!&ndash;</div>&ndash;&gt;-->
					<!--&lt;!&ndash;</div>&ndash;&gt;-->
				<!--<div class="col-md-1 col-sm-1 col-xs-1">-->
					<!--<div class="checkbox">-->
					  <!--<label>-->
						<!--<input type="checkbox" value="">-->
						<!--内存-->
					  <!--</label>-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class="col-md-1 col-sm-1 col-xs-1">-->
					<!--<div class="checkbox">-->
					  <!--<label>-->
						<!--<input type="checkbox" value="">-->
						<!--磁盘-->
					  <!--</label>-->
					<!--</div>-->
				<!--</div>-->
				<!--&lt;!&ndash;<div class="col-md-2 col-sm-2 col-xs-2">&ndash;&gt;-->
						<!--&lt;!&ndash;<div class="checkbox">&ndash;&gt;-->
						  <!--&lt;!&ndash;<label>&ndash;&gt;-->
						    <!--&lt;!&ndash;<input type="checkbox" value="">&ndash;&gt;-->
						    <!--&lt;!&ndash;网络流量&ndash;&gt;-->
						  <!--&lt;!&ndash;</label>&ndash;&gt;-->
						<!--&lt;!&ndash;</div>&ndash;&gt;-->
					<!--&lt;!&ndash;</div>&ndash;&gt;-->
				<!--<div class="col-md-1 col-sm-1 col-xs-1">-->
					<!--<button type="submit" class="btn btn-success">导出</button>-->
				<!--</div>-->
			<!--</div>-->
			<div class="row" style="height: 400px;margin-top: 30px">
                <div class="col-md-5 col-sm-5 col-xs-5 col-md-offset-1" style="height:450px;">
					<iframe src="" width="450" height="400" frameborder="0" id="p1"></iframe>
				</div>
				<div class="col-md-5 col-sm-5 col-xs-5 col-md-offset-1" style="height:450px;">
					<iframe src="" width="450" height="400" frameborder="0" id="p2"></iframe>
				</div>
				<!--<div class="col-md-5 col-sm-5 col-xs-5 col-md-offset-1" style="height:450px;">-->
					<!--<iframe src="" width="450" height="400" frameborder="0" id="p3"></iframe>-->
				<!--</div>-->
				<!--<div class="col-md-5 col-sm-5 col-xs-5 col-md-offset-1" style="height:450px;">-->
					<!--<iframe src="" width="450" height="400" frameborder="0" id="p4"></iframe>-->
				<!--</div>-->

            </div>

		</div>
		</div>
    <script src="{% static 'vendors/jquery/dist/jquery.min.js'%}"></script>
    <!-- Bootstrap -->
    <script src="{% static 'vendors/bootstrap/dist/js/bootstrap.min.js'%}"></script>
    <!-- FastClick -->
    <script src="{% static 'vendors/fastclick/lib/fastclick.js'%}"></script>
    <!-- NProgress -->
    <script src="{% static 'vendors/nprogress/nprogress.js'%}"></script>
    <!-- Chart.js -->
    <script src="{% static 'vendors/Chart.js/dist/Chart.min.js'%}"></script>
    <!-- jQuery Sparklines -->
    <script src="{% static 'vendors/jquery-sparkline/dist/jquery.sparkline.min.js'%}"></script>
    <!-- Flot -->
    <script src="{% static 'vendors/Flot/jquery.flot.js'%}"></script>
    <script src="{% static 'vendors/Flot/jquery.flot.pie.js'%}"></script>
    <script src="{% static 'vendors/Flot/jquery.flot.time.js'%}"></script>
    <script src="{% static 'vendors/Flot/jquery.flot.stack.js'%}"></script>
    <script src="{% static 'vendors/Flot/jquery.flot.resize.js'%}"></script>
    <!-- Flot plugins -->
    <script src="{% static 'vendors/flot.orderbars/js/jquery.flot.orderBars.js'%}"></script>
    <script src="{% static 'vendors/flot-spline/js/jquery.flot.spline.min.js'%}"></script>
    <script src="{% static 'vendors/flot.curvedlines/curvedLines.js'%}"></script>
    <!-- DateJS -->
    <script src="{% static 'vendors/DateJS/build/date.js'%}"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="{% static 'vendors/moment/min/moment.min.js'%}"></script>
    <script src="{% static 'vendors/bootstrap-daterangepicker/daterangepicker.js'%}"></script>
    
    <!-- Custom Theme Scripts -->
    <script src="{% static 'production/build/js/custom.min.js'%}"></script>
    <script src="{% static 'production/plugins/echarts-2.2.7/build/dist/echarts.js'%}"></script>
    <script src="{% static 'production/plugins/layui-v2.2.5/layui/layui.js'%}" charset="utf-8"></script>
    <script src="{% static 'production/plugins/calendar/laydate.js'%}"></script>  
    <script type="text/html" id="tmpFun">
		<a href="#" class="layui-table-link" onclick="testClick({{d.id}})">修改</a>
		<a href="#" class="layui-table-link" onclick="testClick(1)">删除</a>
		<a href="#" class="layui-table-link" onclick="testClick(1)">上传</a>
	</script>
    <script type="text/javascript">

		function testClick(id) {
			$('#ifContent',window.parent.document).attr("src","{% url 'alarmEvents:alarmEvent' %}")
        }
		function signOutClick(ip){
		    $('#ifContent',window.parent.document).attr("src","{% url 'signbackInformation:signbackInformation' %}")

		}

    	$(function(){
    	    var searchObj = {
			        ip:"",
					group:""
				}
			$('#btn-search').on('click',function(){
					searchObj.ip = $.trim($('#txt-machine').val())
					searchObj.group = $.trim($('#osel-group option:selected').val())
//					alert($.trim($('#txt-machine').val()))
//					alert($.trim($('#osel-group option:selected').val()))
					getData()
					getCharts()
				})

			$('#btn-refresh').on('click',function(){
			    getCharts();
			})

			function getData(){

					layui.use('table', function(){
					var table = layui.table;
					//第一个实例
					table.render({
						elem: '#test'
						,url: '/realtimeMonitor/hosMachine/'
						,method:'post'
						//,limit:searchObj.limit
						,where: searchObj
						,page: true //开启分页
//						,cellMinWidth:'100%'
						,cols: [[ //表头
							 {checkbox: true,width:'5%',minWidth:10}
							 ,{field:'hostname',width:'15%', minWidth:10, title: '主机名', }
							  ,{field:'ip', width:'15%', minWidth:10,title: '主机IP'}
//							  ,{field:'datacenter',width:'10%', minWidth:10,title: '数据中心',}
							  ,{field:'group', width:'15%', minWidth:10,title: '所属组',}
							  ,{field:'jiqun',width:'15%', minWidth:10, title: '所属集群',}
							  ,{field:'status',width:'10%', minWidth:10, title: 'Agent状态',}
							  ,{field:'id',  width:'25%', minWidth:10,title: '功能', templet: function (d) {
								  return '<div>'+
									 '<a href="/alarmEvents/alarmEvent/?ip='+d.ip+'" class="layui-btn layui-btn-sm">告警详情</a>'+
//									 '<a href="#" class="layui-btn layui-btn-sm" onclick="exportClick('+d.id+')">导出</a>'+
//									 '<a href="#" class="layui-btn layui-btn-sm"  onclick="testClick('+d.id+')">签退</a>'+
//									  '<a href="#" class="layui-btn layui-btn-sm" onclick="signOutClick('+d.id+')">签退</a>'+
									  '<a href="#" class="layui-btn layui-btn-sm btn_sign "  data-hostid="'+d.hostid+ '" data-ip="'+d.ip+'" data-zabbix_id="'+d.Zabbix_id+'">签退</a>'
									 '</div>'
												  }}
							]]
						,limits:[5,10,50,100,500]
					});
//
					});

				}
			function getCharts(){


                var table = layui.table;
                var checkStatus = table.checkStatus('test')
                var datajson = checkStatus.data
                console.log(1111)
{#                console.log(table.cache.test[0].group)#}
                var ips = ""
                var group = ""

                for (var i = 0; i < datajson.length; i++) {
                    hostnames = "&var-hosts=" + datajson[i].hostname
                    ips = ips + hostnames
                    group = datajson[0].group
                }

{#                判断是否多选#}
                if (ips == "") {

                    var searchip = $.trim($('#txt-machine').val())

                    if(searchip.length > 0){
                        iplist = searchip.split(",")
{#                        console.log(datajson)#}
                     for (var i = 0; i < iplist.length; i++){
                        hostnames = "&var-hosts=" + iplist[i]
                        ips = ips + hostnames
                     }
                     var ip = ips
                     var group = table.cache.test[0].group
                    }

                    else {
                           for (var hostname=0;hostname<(table.cache.test).length;hostname++){
                             hostnames = "&var-hosts=" + table.cache.test[hostname].hostname
                             ips = ips + hostnames
                        }
                        ip = ips
                        console.log(ip)
                         var group = table.cache.test[0].group
                    }

                } else {
                    var ip = ips
                }



				var startTime = $.trim($('#startTime').val())
				var endTime =$.trim($('#endTime').val())

				var n = 0.5
				if(endTime == '' && startTime != '' ){
			        	var date = new Date(startTime)
			        	startTime = date.getTime()
//						endTime = startTime+n*86400*1000
						var time = new Date()
						endTime = time.getTime()

				}else if(endTime != '' && startTime == '' ){
				    	var date = new Date(endTime)
				    	endTime = date.getTime()
						startTime  = endTime - n*86400*1000

				}else if(endTime == '' && startTime == ''){
				    	var date = new Date()
						endTime = date.getTime()
						startTime = endTime - n*86400*1000
				}else if(endTime != '' && startTime != ''){


						var e_time = Date.parse(endTime)
						var s_time = Date.parse(startTime)
						startTime = s_time.getTime()
						endTime = e_time.getTime()
				}
			if(ip == '' || group == '' || group == '全部') {
                $('#p1').attr('src', "http://10.249.4.212:3000/dashboard-solo/db/su-zhu-ji?orgId=1&panelId=666&from="+startTime+"&to="+endTime+"&var-group="+group+"&var-hosts="+ip+"&var-Application=CPU&var-items=CPU%20cores")
                $('#p2').attr('src', "http://10.249.4.212:3000/dashboard-solo/db/su-zhu-ji?orgId=1&panelId=666&from="+startTime+"&to="+endTime+"&var-group="+group+"&var-hosts="+group+"&var-Application=CPU&var-items=CPU%20cores")
            }else{
				$('#p1').attr('src', "http://10.249.4.212:3000/dashboard-solo/db/su-zhu-ji?orgId=1&panelId=2&from="+startTime+"&to="+endTime+"&var-group="+group+"&var-hosts="+ip+"&var-Application=CPU&var-items=CPU%20cores")
                $('#p2').attr('src', "http://10.249.4.212:3000/dashboard-solo/db/su-zhu-ji?orgId=1&var-group="+group+"&var-hosts="+ip+"&var-Application=CPU&var-items=CPU%20cores&panelId=3&from="+startTime+"&to="+endTime)

			}

			}

			getData();
		})
.on('click', '.btn_sign', function () {
				var ip = $(this).data('ip');
				var hostid = $(this).data('hostid');
				var zabbix_id = $(this).data('zabbix_id');
				var oc_time = '';
				var end_time = '';
				var name = '';
				var desc = '';
				// var name_input = '<input type="text" readonly  name="country" id="form_name" value="'+ name +'" id="form_name">'
				var form_html = '<div class="col-md-11 col-sm-11 col-xs-11 col-md-offset-1" style="margin-top: 20px; margin-bottom: 10px;">'+
					'<label class="col-md-3 col-sm-3 col-xs-3 ">维护名称:&emsp;</label>'+
					'<div class="col-md-7 col-sm7 col-xs-7 " >'+
					'<input type="text" name="country" id="form_name" value="'+ name +'" id="form_name">' +
					'</div>' +
					'</div>' +
					'<div class="col-md-11 col-sm-11 col-xs-11 col-md-offset-1" style="margin-bottom: 10px;">'+
					'<label class="col-md-3 col-sm-3 col-xs-3 ">维护开始时间:&emsp;</label>'+
					'<div class="col-md-7 col-sm7 col-xs-7 " >'+
					'<input class="laydate-icon form-control col-md-10" value="'+ oc_time +'" onclick="laydate({istime: true, format: \'YYYY-MM-DD hh:mm:ss\'})" id="form_startTime">'+
					'</div>'+
					'</div>'+
					'<div class="col-md-11 col-sm-11 col-xs-11 col-md-offset-1" style="margin-bottom: 10px;">'+
					'<label class="col-md-3 col-sm-3 col-xs-3 ">维护结束时间:&emsp;</label>'+
					'<div class="col-md-7 col-sm7 col-xs-7 ">'+
					'<input class="laydate-icon form-control col-md-10" value="'+ end_time +'" onclick="laydate({istime: true, format: \'YYYY-MM-DD hh:mm:ss\'})" id="form_endTime">'+
					'</div>'+
					'</div>'+
					'<div class="col-md-11 col-sm-11 col-xs-11 col-md-offset-1" style="margin-bottom: 10px;">'+
					'<label class="col-md-3 col-sm-3 col-xs-3 ">描述:&emsp;</label>'+
					'<div class="col-md-7 col-sm7 col-xs-7 " >'+
					'<textarea name="" required lay-verify="required" class="layui-textarea" id="form_DESC">'+ desc + '</textarea>'+
					'</div>'+
					'</div>';
				$('#form_box').html(form_html);
				layer.open({
					title: '主机维护' + ip,
					type:1,
					area: ['600px'],
					btn:['签退'],
					content: $('#form_box'),
					yes: function(index, layero){
						var form_name = $('#form_name').val();
						var form_endTime = $('#form_endTime').val();
						var form_startTime = $('#form_startTime').val();
						var description = $('#form_DESC').val();
						if(!form_endTime || !form_startTime){
							layer.open({
								title: '开始时间或结束时间不能为空',
								type: 1,
								time: 5000
							});
						}else if(!form_name){
						    layer.open({
								title: '维护内容不能为空',
								type: 1,
								time: 5000
							})
						}else if(form_endTime && form_startTime){
							if(form_endTime <= form_startTime){
								// layer.msg('结束时间不能早于开始时间',{
								//   time: 5000,
								//   btn: ['明白了']
								// });
								layer.open({
									title: '结束时间不能早于开始时间',
									type: 1,
									time: 5000
								});
							}else{
							    $.get("/signbackInformation/host_maintenance/",
									{ hostids: hostid, zabbix_id: zabbix_id, active_since: form_startTime,
									active_till: form_endTime, name: ip +'主机:'+ form_name, description: description},
									function(res){
								if(res['maintenanceids']){
									layer.msg('ip为：'+ ip +'的设备签退成功',{
										 type: 1,
										 time: 5000,
										 btn: ['确定'],
										 btn1: function(index, layero){
											// getData();
											layer.closeAll();
										 }
											});

									// alert('hostid为：'+ hostid +'的设备签退成功')
								}
								if(res['mgs']){
									   layer.msg('ip为（'+ ip +'）的设备出错了：' + res['mgs'],{
										   type: 1,
										   time: 50000,
										   btn: ['明白了']
										});
									// alert('hostid为（'+ hostid +'）的设备出错了：' + res['mgs'])
								}
							}

								);
							}
						}

					}
				});

        	})
	</script>



	</body>
</html>
