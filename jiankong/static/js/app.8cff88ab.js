"use strict";function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _classCallCheck2(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function getSchedulerStatusStyle(a,b,c){var d,e,f,g="error"===b||"false"!==b;switch(b="error"!==b&&"false"!==b,a){case"success":d=b?"执行成功":"",e="text-success",f="fa fa-check";break;default:d=g?"执行失败":"",e="text-danger",f="fa fa-warning"}return d&&c&&(d=c+d),{text:d,textClass:e,iconClass:f}}var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_systemjsBundles={"/scripts/bundles/dashboard.e5f90e80.js":["dashboard/states.js"],"/scripts/bundles/flows.1c3dc6fb.js":["flows/states.js"]};System.defaultJSExtensions=!0,System.config({baseURL:"/src",bundles:"undefined"==typeof _systemjsBundles?void 0:_systemjsBundles,map:{"plugin-babel":"vendors/systemjs-plugin-babel/plugin-babel.js","systemjs-babel-build":"vendors/systemjs-plugin-babel/systemjs-babel-browser.js"},transpiler:"plugin-babel",packages:{dashboard:{defaultExtension:"js"},flows:{defaultExtension:"js"}},meta:{"*.js":{babelOptions:{stage1:!0}}}});var _requirejsHash={"components/d3":{js:"components/d3-5d9c7872fc113ad9b217.js"},"components/react":{js:"components/react-7580abd6f766935fbbf1.js"},"components/chartjs":{js:"components/chartjs-95e2183764879bff6dbb.js"},"components/apps-topology":{js:"components/apps-topology-44a519f1a480d7774c69.js"},"components/flowchart":{js:"components/flowchart-dc6ccf0def1eadc28209.js"},"components/select-devices":{js:"components/select-devices-94ad01a30e2322305aff.js"},"components/editor":{js:"components/editor-edcff7fc6715205595b3.js"},"components/package-diff":{js:"components/package-diff-bb0f345d1e5fe6a987ca.js"},"components/treemap":{js:"components/treemap-d916da9b163984388078.js"},"components/activities":{js:"components/activities-4f9acd816e784e6b64fc.js"}};!function(){var a=$('meta[name="cdn"]').attr("content")||"";"/"!==a.substr(-1)&&(a+="/");var b={"codemirror/mode":a+"bower_components/codemirror/mode"};window._requirejsHash&&_.forEach(window._requirejsHash,function(a,c){a.js&&(b[c]=a.js.replace(/\.js$/,""))}),requirejs.config({baseUrl:a+"scripts",waitSeconds:60,paths:b,shim:{"components/package-diff":{deps:["components/react"]},"components/select-devices":{deps:["components/react"]},"components/treemap":{deps:["components/d3"]},"components/apps-topology":{deps:["components/d3"]},"components/flowchart":{deps:["components/d3"]}}})}(),function(a){var b=a.EasyOpsConfig||{};angular.module("app",["constants","ui.router","ui.bootstrap","ngAnimate","ngSanitize","ui.codemirror","ui.select","ngClockpicker","ngTagsInput","ngFileUpload","ngStorage","angular-loading-bar","as.sortable","app.controllers","app.directives","app.ui.services","app.services","app.templates","app.components","home","help","auth.route","auth.ctrl","auth.service","delivery","externals","navs","tools.route","tools.ctrl","tools.service","tools.directive","monitor.route","monitor.ctrl","monitor.directive","monitor.service","monitor.dashboard","monitor.components","flows","feedback","cmdb.ctrl","cmdb.route","cmdb.service","cmdb.directive","cmdb.components","cmdb.models","cmdb.resources","cmdb.devices","cmdb.apps","cmdb.overview","user.route","user.ctrl","user.service","itoa.route","itoa.ctrl","itoa.service","permission.route","permission.ctrl","permission.service","capacity.route","capacity.ctrl","capacity.service","admin.route","admin.ctrl","admin.service","itoa.sla.route","itoa.sla.ctrl","itoa.sla.service","monitor.host","monitor.app","monitor.component","monitor.collector","monitor.alarm","monitor.log","monitor.topos","schedulers.route","schedulers.ctrl","schedulers.service","settings","schedulers.directive","userManage.route","userManage.ctrl","userManage.service","tasks.route","tasks.ctrl","tasks.service"]).config(["$stateProvider","navHelperProvider",function(a,b){var c=["sref","url","text","icon"];_.forEach(b.getNavModuleList(),function(b){_.forEach(b.groups,function(b){_.forEach(b.states,function(b){if(b.toolId&&_.every(c,function(a){return _.has(b,a)})){var d={name:b.sref,url:b.url,resolve:{toolData:["Tools",function(a){return a.fetchTool(b.toolId)}]}};b.resolve&&_.assign(d.resolve,b.resolve),b.component?d.component=b.component:(d.tempalteUrl="views/tools/execute.html",d.controller=function(a,c,d){angular.extend(this,a("ToolAbstractCtrl",{$scope:c,toolData:d})),angular.extend(this,a("ToolExecuteCtrl",{$scope:c,toolData:d})),c.pageTitle=b.text,c.hidePageBackBtn=!0},d.controller.$inject=["$controller","$scope","toolData"]),a.state(d)}})})})}]),angular.module("constants",[]).constant("TIME_OFFSET",b.timeOffset).constant("USERNAME",b.username).constant("ORG",b.org).constant("USER_GROUPS",b.userGroups).constant("ROLES",b.roles).constant("IS_SYSTEM_ADMIN",_.includes(b.roles,"系统管理员")).constant("GRANTED_PERMISSIONS",b.grantedPermissions).constant("DENIED_PERMISSIONS",b.deniedPermissions).constant("IGNORE_PERMISSIONS",b.ignorePermissions).constant("FEEDBACK_URL",b.feedbackUrl).constant("BRAND_LOGO",b.brandLogo).constant("BRAND_TEXT",b.brandText).constant("LICENSE_EXPIRING",b.licenseExpiring).constant("IS_COMMUNITY_EDITION",b.isCommunityEdition).constant("LDAP_ENABLED",b.ldapEnabled).constant("EXTERNAL_LINKS",b.externals).constant("CMDB_TOOLKIT",b.cmdbToolkit).constant("DISABLED_MODULES",b.disabledModules).constant("FALLBACK_OBJECT_IDS",b.fallbackObjectIds).constant("ENABLED_FEATURES",b.enabledFeatures).constant("DISABLED_FEATURES",b.disabledFeatures).constant("HOME_DASHBOARD_SLUG",b.homeDashboardSlug).constant("BUILT_IN_EXTERNAL_LINKS",[{id:"dashboard-new",src:"/grafana/dashboard/new"},{id:"dashboard-db",src:function(a){var b="/grafana/dashboard/db/"+a.slug;return a.ip&&(b+="?var-ip="+a.ip),b}}]).constant("DEPLOY_UPLOAD_MAX_SIZE",{text:b.deployUploadMaxSizeText,value:b.deployUploadMaxSize}).constant("BLACK_ALERT_TYPE",[]).constant("ATTRTYPELIST",[{key:"str",text:"字符型"},{key:"int",text:"整型"},{key:"date",text:"日期"},{key:"datetime",text:"时间"},{key:"enum",text:"枚举型"},{key:"arr",text:"数组"},{key:"FK",text:"外键(单个实例)"},{key:"FKs",text:"外键(多个实例)"}]).constant("OBJECTBLACKLIST",["CLUSTER","PROCESS","NET_PORT","stevehack","HOST","APP","USER_GROUP"]).constant("OBJECT_INDEPENDENT_LIST",["HOST","APP"]).constant("ALARMICON",{1:"fa-cog",2:"ti-signal",3:"fa-cogs",4:"ti-layout-grid2-thumb",5:"ti-link"}).constant("OBJECTICONMAP",{APP:"fa fa-cube",BUSINESS:"ti-folder",CLUSTER:"ti-harddrives",PROCESS:"ti-settings",F5_VS:"ti-server",DNS:"ti-layout-grid2-thumb",SSL:"ti-shield",CDN:"ti-cloud",HOST:"fa fa-hdd-o",IDCLINK:"ti-vector",IDCRACK:"ti-layout-menu-v",INTERFACE:"ti-link",DEVICE_NET:"ti-signal",IDC:"ti-map-alt",NET_PORT:"ti-layout-media-center",IP_SCOPE:"ti-layout-cta-left",IP_LIST:"ti-layout-cta-center",PROVIDER:"ti-tag",ISP:"ti-world",USER:"fa fa-user",DEPART:"ti-layout-accordion-list",ROLE:"ti-id-badge",_more_:"ti-more",_less_:"ti-back-left"}).constant("HIDE_FIELD_LIST",["","objectId","deviceId","clusterId","appId","packageId","businessId","_packageList"]).constant("OBJECT_FK_DEFAULT_SHOW",{HOST:["hostname"],CLUSTER:["name",function(a){return _.map(a.deviceList,function(a){return _.filter([a.hostname,a.ip]).join("|")}).join(",")}]}).constant("DEVICE_STATUS_LIST",["运营中","故障中","未上线","下线隔离中","开发机","测试机","维修中","报废"]).constant("PIPELINE_STAGE_NAME_LIST",["构建","测试","预发布","发布"]).constant("PIPELINE_HIDDEN_PARAMS",["APP_ID","PACKAGE_ID"]).constant("CMDB_RESOURCE_FIELDS_SETTINGS",{defaultFields:{APP:["name","businesses","owner","developer","tester"],"APP-HOST":["ip","hostname","status"]},fixedFields:{APP:["name"],"APP-HOST":["ip"]},ignoredFields:{APP:["_packageList","appId","packageId","installPath","runUser","businessId"],CLUSTER:["_packageList","packageId"],HOST:["deviceId"],"APP-HOST":["deviceId"]}}).constant("CMDB_PAGE_SIZE_LIST",[20,50,100]).constant("SAMPLE_TOOL_ID","b6177cfb445a304d573be9c05dd79181"),angular.module("app").factory("checkPermission",["GRANTED_PERMISSIONS","DENIED_PERMISSIONS","IS_SYSTEM_ADMIN","USERNAME","USER_GROUPS","IGNORE_PERMISSIONS",function(a,b,c,d,e,f){var g={"tools.create":"tool:POST:/tools","tools.tool.edit":"tool:PUT:/tools/@packageId","tools.tool.execute":"tool:POST:/tools/execution","tools.tool.detail":"tool:GET:/tools/@packageId","tools.tool.remove":"tool:DELETE:/tools/@packageId","flows.create":"flow:POST:/flows","flows.flow.edit":"flow:PUT:/flows/@packageId","flows.flow.execute":"flow:POST:/flows/execution","flows.flow.detail":"flow:GET:/flows/@packageId","flows.flow.remove":"flow:DELETE:/flows/@packageId","apps.manage":"cmdb:APP_instance_manage","apps.app.deploy.production.install":"deploy:package_production_cluster_install","apps.app.deploy.production.upgrade":"deploy:package_production_cluster_upgrade","apps.app.deploy.production.uninstall":"deploy:package_production_cluster_uninstall","apps.app.deploy.production.restart":"deploy:package_production_cluster_restart","apps.app.deploy.production.start":"deploy:package_production_cluster_start","apps.app.deploy.production.stop":"deploy:package_production_cluster_stop","apps.app.deploy.production.remove":"deploy:package_production_cluster_remove","apps.app.deploy.test.install":"deploy:package_test_cluster_install","apps.app.deploy.test.upgrade":"deploy:package_test_cluster_upgrade","apps.app.deploy.test.uninstall":"deploy:package_test_cluster_uninstall","apps.app.deploy.test.restart":"deploy:package_test_cluster_restart","apps.app.deploy.test.start":"deploy:package_test_cluster_start","apps.app.deploy.test.stop":"deploy:package_test_cluster_stop","apps.app.deploy.test.remove":"deploy:package_test_cluster_remove","apps.app.deploy.develop.install":"deploy:package_develop_cluster_install","apps.app.deploy.develop.upgrade":"deploy:package_develop_cluster_upgrade","apps.app.deploy.develop.uninstall":"deploy:package_develop_cluster_uninstall","apps.app.deploy.develop.restart":"deploy:package_develop_cluster_restart","apps.app.deploy.develop.start":"deploy:package_develop_cluster_start","apps.app.deploy.develop.stop":"deploy:package_develop_cluster_stop","apps.app.deploy.develop.remove":"deploy:package_develop_cluster_remove","clusters.manage":"cmdb:CLUSTER_instance_manage","packages.create":"deploy:package_create","packages.package.edit":"deploy:package_update","packages.package.remove":"deploy:package_delete","packages.package.versions.create":"deploy:package_version_create","packages.package.versions.version.edit":"deploy:package_version_update","packages.package.versions.version.remove":"deploy:package_version_delete","cmdb.devices.manage":"cmdb:HOST_instance_manage","cmdb.cloudKey":"cmdb:cloud_key_pair_admin"};return function(h,i){if(f)return!0;var j=_.includes(a,g[h])||_.includes(a,h);if(!j){var k=_.includes(b,g[h])||_.includes(b,h);k||(j=!0)}if(j&&i&&!c){if(!_.isFunction(i)){var l=i;i=function(a,b){return!(_.size(l._manager)||_.size(l._manager_group))||_.some(l._manager,function(b){return b===a})||_.some(l._manager_group,function(a){return _.includes(b,a)})}}j=i(d,e)}return j}}]).config(["$stateProvider","$animateProvider","$urlRouterProvider","$locationProvider","$httpProvider","$qProvider","cfpLoadingBarProvider","uibDatepickerConfig","uibDatepickerPopupConfig","USERNAME",function(a,b,c,d,e,f,g,h,i,j){d.html5Mode(!0),c.otherwise(j?"/":"/signin"),moment.locale("zh-CN"),e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",f.errorOnUnhandledRejections(!1),g.includeSpinner=!1,_.assign(h,{formatDayTitle:"yyyy年M月",formatMonthTitle:"yyyy年",showWeeks:!1,startingDay:0}),_.assign(i,{showButtonBar:!1,onOpenFocus:!1}),b.classNameFilter(/\banimated\b/)}]).factory("$exceptionHandler",["$log","$window",function(a,b){var c;return function(d){a.warn(d),!c&&d instanceof TypeError&&Function.prototype.bind.toString().indexOf("[native code]")===-1&&(c=!0,b.alert("您可能启用了某些会影响网站正常访问的浏览器插件（如“广告拦截者”，该插件覆盖了浏览器原生函数），请尝试禁用该插件。"))}}]).run(["$rootScope","$state","$transitions","$window","$document","$location","$timeout","$compile","$localStorage","$sessionStorage","PendingRequests","handleAjaxError","Auth","USERNAME","LICENSE_EXPIRING","IS_COMMUNITY_EDITION","EXTERNAL_LINKS","DISABLED_MODULES","ENABLED_FEATURES","DISABLED_FEATURES",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){function u(){w&&w.length||(w=e.find(".navbar")),x.toggleClass("body-nav-breaked",w.height()>75)}function v(){var b=q&&q.links;_.forEach(_.reverse(b),function(b){function c(){var c=a.$new(!0);return c.link=b,h('<li ui-sref-active="active" id="'+f+'"><a ui-sref="'+d+'.externals(link)"><i class="fa fa-'+_.escape(b.icon||"external-link-square")+'"></i>'+_.escape(b.text)+"</a></li>")(c)}if(b&&b.id&&b.system){var d=B[b.system];if(d){var f=_.escape("external-link-"+b.id);if(!e.find("#"+f).length){var g=e.find(".sidebar"),i=g.find(".sidebar-heading");if($.trim(i.text())===b.system){var j,k,l,m;"CMDB"===b.system?b.newCategory?(j=g.find(".sidebar-header > span:first-child"),j.each(function(a){if(!k){var c=j.eq(a),d=$.trim(c.text());d===b.newCategory&&(k=c.closest(".nav-sidebar"))}}),k||(l=$('<div class="nav-sidebar with-op"><div class="sidebar-header"><span>'+_.escape(b.newCategory)+'</span></div><ul class="object-list"></ul></div>'),j.each(function(a){var c=j.eq(a),d=$.trim(c.text());(b.beforeCategory&&b.beforeCategory===d||b.afterCategory&&b.afterCategory===d)&&(k=l,b.beforeCategory&&b.beforeCategory===d?l.insertBefore(c.closest(".nav-sidebar")):l.insertAfter(c.closest(".nav-sidebar")))})),k&&k.find("ul").prepend(c())):(m=g.find("li:not(.divider)"),m.each(function(a){var d=m.eq(a),e=$.trim(d.text());if(b.before&&b.before===e||b.after&&b.after===e){var f=c();b.before&&b.before===e?f.insertBefore(d):f.insertAfter(d)}})):b.newCategory?(j=g.find("li.divider"),j.each(function(a){if(!k){var c=j.eq(a),d=$.trim(c.text());d===b.newCategory&&(k=c)}}),k||(l=$('<li class="divider">'+_.escape(b.newCategory)+"</li>"),j.each(function(a){var c=j.eq(a),d=$.trim(c.text());if(b.beforeCategory&&b.beforeCategory===d||b.afterCategory&&b.afterCategory===d)if(k=l,b.beforeCategory&&b.beforeCategory===d)l.insertBefore(c);else{var e=c.nextAll("li.divider");e.length?l.insertBefore(e.eq(0)):c.parent().append(l)}})),k&&c().insertAfter(k)):(m=g.find("li:not(.divider)"),m.each(function(a){var d=m.eq(a),e=$.trim(d.text());if(b.before&&b.before===e||b.after&&b.after===e){var f=c();b.before&&b.before===e?f.insertBefore(d):f.insertAfter(d)}}))}}}}})}a.username=n,a.isCommunityEdition=p,a.isEnterpriseEdition=!p,a.disabledModulesMap={},_.forEach(r,function(b){a.disabledModulesMap[b]=!0}),a.enabledFeaturesMap={},_.forEach(s,function(b){a.enabledFeaturesMap[b]=!0}),a.disabledFeaturesMap={},_.forEach(t,function(b){a.disabledFeaturesMap[b]=!0}),a.dismissLicenseExpiring=function(b){a.licenseExpiringDismissed=!0,b&&(i.licenseExpiringDismissed=!0,i.licenseExpiringDismissedUntil=+new Date+6048e5)};var w,x=e.find("body"),y=$(d),z=!1;y.resize(u),a.triggerWindowResize=function(){y.trigger("resize")},c.onStart({},function(a){k.clear();var c=a.to(),e=a.params("to"),f=!/^auth\./.test(c.name);if(f&&m.setNextState(c.name,e),!n)return!f||(m.setSignInFrom(c.name,e),d.location.href=b.href("auth.signin"),!1)}),c.onStart({to:"monitor.dashboard.**"},function(a){var c=a.injector(),d=c.get("$sessionStorage"),e=c.get("GrafanaApi"),f=a.to(),g=a.params("to");return d.fromState={stateName:f.name,params:g},e.getActualUser().then(function(){return null}).catch(function(a){return 401===a.status?b.target("monitor.grafanaLogin"):null})});var A;c.onSuccess({},function(b){A&&x.removeClass(A);var c=b.to();A=c.pageClass,A&&x.addClass(A),g(function(){if(x.scrollTop(0),z||(u(),z=!0),v(),o&&o.length){if(i.licenseExpiringDismissed&&i.licenseExpiringDismissedUntil<+new Date&&(delete i.licenseExpiringDismissed,delete i.licenseExpiringDismissedUntil),i.licenseExpiringDismissed)return;a.licenseExpiring=o,e.find("#alert-license-will-expire").remove();var b=h('<div uib-alert class="alert-warning" ng-hide="licenseExpiringDismissed" id="alert-license-will-expire" type="warning" close="dismissLicenseExpiring()">\n提示：<span ng-repeat-start="item in licenseExpiring">{{item.name}}的授权即将于 <span humanize-time="item.expireAt" format="future"></span><strong>过期</strong></span><span ng-repeat-end ng-if="!$last">、</span>，请联系 EasyOps 续期。\n<a href ng-click="dismissLicenseExpiring(true)">不再提示</a>\n</uib-alert>')(a);e.find(".content-body").prepend(b)}}),d.ga&&d.ga("send","pageview",{page:f.url()})}),c.onError({},function(a){var b=a._error;b&&6===b.type&&(b=b.detail),l(b)});var B={CMDB:"cmdb","持续交付":"delivery","智能监控":"monitor","IT 运营分析":"itoa"};a.goBack=function(){d.history.back()},d.addEventListener("message",function(a){if(a.origin===d.location.origin&&"easyops-ready"===a.data){var c=j.fromState;delete j.fromState,c?b.go(c.stateName,c.params):b.go("home")}})}])}(window),angular.module("app.controllers",[]).controller("NavCtrl",["$scope","$state","$timeout","$window","$localStorage","navHelper","checkPermission","Auth","navPin","Dialog","handleAjaxError","FEEDBACK_URL","BRAND_LOGO","Log","USERNAME",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){var b=[],c=i.getPinnedStates();_.forEach(c,function(a){var c=_.find(s,{id:a});c&&(b.push(c),c.newly&&e[c.newlyKey]&&(c.newly=!1))}),a.navPinnedList=b}function q(a){a.pinned?i.unpin(a.id):i.pin(a.id),a.pinned=!a.pinned,p(),c(function(){$(d).trigger("resize")})}a.taskList=[],a.errorShow=!0,a.permissionOfInviteUsers=g("cmdb:user_invite")&&!!o,a.systemList=[{value:null,text:"所有平台"},{value:"deploy",route:"task.deploy",text:"应用管理"},{value:"tool",route:"task.tools",text:"作业平台"},{value:"flow",route:"task.flows",text:"调度平台"},{value:"multiTask",route:"task.batchDeploy",text:"任务编排"}],a.getHrefOfTask=function(c){var d=angular.copy(a.systemList);d.push({value:"cloudHost",route:"task.cloudHost",text:"云主机任务"});var e=_.find(d,{value:c.system});return"task.deploy"===e.route&&"instance.deploy"===c.topic&&(e.route="task.deployInstall"),e?b.href(e.route,c):null},a.getTaskList=function(){a.taskList.length||(a.loadAgainShow=!1,a.showMore=!1,a.errorShow=!1,a.loading=!0,a.noLog=!1),n.fetchLogList({user:"myself",range:"week"},3e4,!0).then(function(b){a.showMore=!0,a.taskList=b.list,a.taskList=_.map(a.taskList,function(a){return _.includes(a.topic,"CloudHost")&&(a.system="cloudHost","getCloudHost"===a.topic?a.target_name="购买云主机":"delCloudHost"===a.topic&&(a.target_name="退还云主机")),"instance.deploy"===a.topic&&(a.event="install"),a}),a.loading=!1,a.taskList.length||(a.noLog=!0)}).catch(function(b){a.showMore=!1,a.loading=!1,a.loadAgainShow=!0,a.errorShow=!0,0===b.status||b.status===-1?a.errorDetail="请求中断":500!==b.status&&503!==b.status||(a.errorDetail="服务器内部错误"),k(b,"查询历史任务")})},a.regetTaskList=function(b){b.stopPropagation(),a.getTaskList()},a.statusMap={success:"成功",ok:"成功",failed:"失败",failedPartly:"部分失败",wait:"执行中",run:"执行中",executing:"执行中",paused:"暂停"},a.actionMap={install:"安装",update:"升级",rollback:"回滚",start:"启动",restart:"重启",stop:"停止",uninstall:"卸载",run:"执行","task.run":"执行"},a.hasSucceed=function(a){return"ok"===a.status||"success"===a.status},a.hasFailed=function(a){return"failed"===a.status},a.isRunning=function(a){return"run"===a.status||"wait"===a.status||"executing"===a.status||"paused"===a.status},a.hasPaused=function(a){return"paused"===a.status},a.hasFailedpartly=function(a){return"failedPartly"===a.status},a.taskHide=function(a){var b=3;return a>b},a.feedbackUrl=l,a.brandLogo=m,a.signout=function(){h.signout().finally(function(){d.location.href=b.href("auth.signin")})},a.navDropdown={isOpen:!1},a.closeNavDropdown=function(){a.navDropdown.isOpen=!1},a.navGroups=_.map(f.getNavModuleList(),function(a){return a.states=_.flatten(_.map(a.groups,"states")),delete a.groups,a});var r=i.getPinnedStates(),s=[],t=[];_.forEach(a.navGroups,function(a){a.id&&a.sref&&(a.pinned=_.indexOf(r,a.id)!==-1,s=s.concat(a),a.pinned&&t.push(a.id)),_.forEach(a.states,function(a){a.pinned=_.indexOf(r,a.id)!==-1,s=s.concat(a),a.pinned&&t.push(a.id)})}),_.forEach(_.difference(r,t),i.unpin),p(),a.togglePin=function(b,c){return c.stopPropagation(),!b.pinned&&a.navPinnedList.length>=6?void j.confirm({type:"info",message:"顶部导航建议不要超过 6 项，点击“确定”继续添加。",stopPropagation:!0,resolved:function(){q(b)}}):void q(b)},a.searchForm={},a.searchGlobal=function(){var c=a.searchForm.q;c&&(b.go("search",{q:c,page:1}),$('input[ng-model="searchForm.q"]').blur())}}]).factory("navPin",["$localStorage",function(a){return a.navPinnedStateList||(a.navPinnedStateList=["cmdb","delivery","monitor","itoa"]),{getPinnedStates:function(){return a.navPinnedStateList||[]},pin:function(b){_.indexOf(a.navPinnedStateList,b)===-1&&a.navPinnedStateList.push(b)},unpin:function(b){var c=_.indexOf(a.navPinnedStateList,b);c!==-1&&a.navPinnedStateList.splice(c,1)}}}]);var moduleList=[{text:"CMDB",id:"cmdb",sref:"cmdb.apps.index",groups:[{states:[{id:"cmdb-apps",sref:"cmdb.apps.index",text:"应用管理",icon:"fa fa-cube",stateIncludes:"cmdb.apps"},{id:"cmdb-hosts",sref:"cmdb.devices.index",text:"主机管理",icon:"fa fa-hdd-o",stateIncludes:"cmdb.devices"},{id:"cmdb-objects",sref:"cmdb.object.cards",text:"资源模型",icon:"fa fa-th-large",stateIncludes:"cmdb.object"}]}]},{text:"持续交付",id:"delivery",sref:"apps.index",groups:[{category:"持续交付",states:[{id:"apps",sref:"apps.index",text:"应用交付",icon:"fa fa-rocket",stateIncludes:"apps"},{id:"tools",sref:"tools.index",text:"作业平台",icon:"fa fa-wrench",stateIncludes:"tools"},{id:"flows",sref:"flows.index",text:"调度平台",icon:"fa fa-flag",stateIncludes:"flows"},{id:"schedulers",sref:"schedulers.index",text:"定时任务",icon:"fa fa-clock-o",stateIncludes:"schedulers"}]},{category:"构件库管理",states:[{id:"packages",sref:"packages.index",text:"程序包管理",icon:"fa fa-briefcase",stateIncludes:"packages"},{id:"config-pkgs",sref:"configPkgs.index",text:"配置包管理",icon:"fa fa-gears",stateIncludes:"configPkgs"}]}]},{text:"智能监控",id:"monitor",sref:"monitor.dashboard.index",newly:!0,newlyKey:"newlyNavIgnoredOfMonitorV3",groups:[{category:"持续监控",states:[{id:"monitor-dashboard",sref:"monitor.dashboard.index",text:"仪表盘",icon:"fa fa-dashboard"},{id:"monitor-app",sref:"monitor.app.index",text:"应用监控",icon:"fa fa-cube"},{id:"monitor-component",sref:"monitor.component.index",text:"组件监控",icon:"fa fa-anchor"},{id:"monitor-host",sref:"monitor.host.index",text:"主机监控",icon:"fa fa-hdd-o"}]},{category:"事件分析",states:[{id:"monitor-alarm",sref:'monitor.alarm.index({sortBy: "time", sortOrder: "desc"})',text:"告警事件",icon:"fa fa-bell"}]},{category:"日志平台",states:[{id:"monitor-log",sref:"monitor.log.search",text:"日志搜索",icon:"fa fa-search"}]},{category:"管理",states:[{id:"monitor-collector",sref:"monitor.collector.index",text:"采集中心",icon:"fa fa-shopping-cart"},{id:"monitor-alarm-rule",sref:'monitor.alarm.home.rule.list({sortBy: "mtime", sortOrder: "asc"})',text:"告警策略",icon:"fa fa-magic"}]}]},{text:"IT 运营分析",id:"itoa",sref:"itoa.capacityIndex",groups:[{category:"容量管理",states:[{id:"itoa-capacity",sref:"itoa.capacityIndex",text:"容量概览",icon:"fa fa-flask"},{id:"itoa-capacity-apps",sref:"itoa.capacityApp",text:"应用容量",icon:"fa fa-cube"},{id:"itoa-capacity-devices",sref:"itoa.capacityDevice",text:"主机容量",icon:"fa fa-hdd-o"}]},{category:"可用性管理",states:[{id:"itoa-sal",sref:"itoa.sal",text:"可用性概览",icon:"fa fa-check-square-o"},{id:"itoa-sla-config",sref:"itoa.slaConfig.index",text:"可用性设置",icon:"fa fa-gear"}]}]},{text:"其它",groups:[{states:[{id:"tasks",sref:"tasksList",text:"任务",icon:"fa fa-history"}]}]}],NavHelperProvider=function(){function a(b,c,d){var e=this;if(_classCallCheck2(this,a),d){var f=_.find(moduleList,{id:"delivery"}),g=_.filter(_.flatten(_.map(f.groups,"states")),function(a){return _.includes(["tools"],a.id)});g.push({id:"file-transfer",sref:"fileTransfer.index",text:"文件传输",icon:"fa fa-exchange",stateIncludes:"fileTransfer"}),f.groups=[{states:g}]}_.remove(moduleList,function(a){return _.includes(b,"delivery"===a.id?"deploy":a.id)}),_.forEach(moduleList,function(a){_.forEach(a.groups,function(a){_.remove(a.states,function(a){return _.includes(c,a.id)})})}),this.$get=function(a){return{getNavModuleOf:function(a){return _.cloneDeep(e.getNavModuleOf(a))},getNavModuleList:function(){return _.cloneDeep(e.getNavModuleList())},isActive:function(b){var c=b.stateIncludes;return _.isString(c)?a.includes(c):_.isArray(c)?_.some(c,function(b){return a.includes(b)}):_.isFunction(c)?c():a.includes(b.sref)}}},this.$get.$inject=["$state"]}return _createClass(a,[{key:"getNavModuleOf",value:function(a){var b=_.find(moduleList,{id:a});return b?b:{groups:[]}}},{key:"getNavModuleList",value:function(){return moduleList}},{key:"customize",value:function(a,b){b(this.getNavModuleOf(a));var c=_.chain(moduleList).map("groups").flatten().map("states").flatten().map("id").flatten().value(),d={},e=[];return _.forEach(c,function(a){_.has(d,a)?e.push(a):d[a]=!0}),e.length,this}}]),a}();NavHelperProvider.$inject=["DISABLED_MODULES","DISABLED_FEATURES","IS_COMMUNITY_EDITION"],angular.module("navs",["constants"]).provider("navHelper",NavHelperProvider),function(){angular.module("app.directives",[]).directive("validateIp",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){d.$validators.ip=function(a,b){return!c.required&&!b||/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(b)}}}}).directive("validateIps",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){d.$validators.ips=function(a,b){return/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/.test(b)}}}}).directive("backgroundJobDotting",function(){return{restrict:"A",scope:{dotting:"=backgroundJobDotting",actionText:"=?"},replace:!0,template:"<span>{{actionText}}{{activeDot}}</span>",controller:"BackgroundJobDottingCtrl"}}).controller("BackgroundJobDottingCtrl",["$scope","$timeout",function(a,b){function c(){function c(){g=!0,f=(f+1)%3,a.activeDot="...".substr(0,f+1),e=b(c,500)}g||(d(),c())}function d(){g=!1,a.activeDot="",e&&(b.cancel(e),e=null)}var e,f=-1,g=!1;a.$watch("dotting",function(a){a?c():d()}),a.$on("$destroy",function(){d()})}]).directive("humanizeTime",["TIME_OFFSET",function(a){function b(b,c,d){if(!c)return void b.html("").attr("title","");var e,f=moment(c),g=moment().add(a),h="LL HH:mm",i="LL ah:mm",j="MMMD日 ah:mm",k="LL HH:mm:ss";switch(d){case"full":e=f.format(h);break;case"default":e=f.format(k);break;case"relative":e=moment.duration(Math.min(f-g,0)).humanize(!0);break;case"future":e=moment.duration(Math.max(f-g,0)).humanize()+"后";break;default:e=f.format(f.year()===g.year()?j:i)}b.html(e).attr("title","full"===d?"":f.format(k))}return{restrict:"A",scope:{time:"=humanizeTime"},replace:!0,link:function(a,c,d){a.$watch("time",function(a){b(c,a,d.format)})}}}]).directive("costTime",function(){function a(a,b,c,d){if(void 0===b&&(!d||"0001-01-01T00:00:00Z"===d))return void a.html("");b||(b=moment(d).diff(c)),b=Math.max(b,0);var e=b%1e3,f=Math.floor(b/1e3)%60,g=Math.floor(b/6e4)%60,h=Math.floor(b/36e5)%24,i=Math.floor(b/864e5),j=[{count:i,unit:"天"},{count:h,unit:"小时"},{count:g,unit:"分钟"},{count:f,unit:"秒"},{count:e,unit:"毫秒"}],k=_.findIndex(j,function(a){return a.count>0});k>=3||k===-1?a.html(+(b/1e3).toFixed(b>=100?1:3)+" 秒"):a.html(_.chain(j.slice(k,k+2)).filter(function(a){return a.count>0}).map(function(a){return a.count+" "+a.unit}).value().join(" "))}return{restrict:"A",scope:{costTime:"=",startTime:"=",endTime:"="},replace:!0,link:function(b,c){b.$watchGroup(["costTime","startTime","endTime"],function(){a(c,b.costTime,b.startTime,b.endTime)})}}}).directive("ngClipboard",["$uibTooltip",function(a){return{restrict:"A",link:function(b,c,d){function e(a){b.$apply(function(){d.$set("uibTooltip",a)})}function f(){e("复制")}var g=new Clipboard(c[0]);angular.isDefined(d.tooltipAppendToBody)||d.$set("tooltipAppendToBody","true"),d.$set("uibTooltip","复制"),a("uibTooltip","tooltip","mouseenter").compile(c)(b,c,d),c.on("mouseleave",f),g.on("success",function(a){if("true"===d.clipboardIp){var b=a.text&&" "!==a.text?a.text.split("\n").length:0;e(b?"已复制 "+b+" 个 IP":"没有选中任何 IP")}else e("已复制");a.clearSelection()}),g.on("error",function(){e("不支持")}),b.$on("$destroy",function(){c.off("mouseleave",f),g.destroy()})}}}]).directive("introTooltip",["$compile","$localStorage","$parse",function(a,b,c){return b.tooltipAutoOpenDisabled||(b.tooltipAutoOpenDisabled={}),{priority:1e3,terminal:!0,restrict:"A",scope:!0,compile:function(d){d.removeAttr("intro-tooltip");var e=_.uniqueId("isOpen");d.attr("tooltip-is-open",e);var f=["disableAutoOpen()"];return angular.isDefined(d.attr("ng-mouseenter"))&&f.unshift(d.attr("ng-mouseenter")),d.attr("ng-mouseenter",f.join(";")),function(d,f,g){a(f)(d);var h=g.introTooltip,i=!(g.introTooltipIf&&!c(g.introTooltipIf)(d));d[e]=i&&!b.tooltipAutoOpenDisabled[h],d.disableAutoOpen=function(){b.tooltipAutoOpenDisabled[h]=!0}}}}}]).directive("selectDevicesModal",["depends",function(a){return{restrict:"EA",scope:{close:"&",dismiss:"&",setShowFields:"&",switchMode:"&",byApp:"=",appList:"=",deviceList:"=",showFields:"=",modelData:"=",selectedList:"=?",specifiedApp:"=?",defaultAppId:"=?",defaultClusterId:"=?"},link:function(b,c,d){c.html('<div style="padding:20px">正在加载...</div>'),a(["components/select-devices"]).then(function(){"true"===d.filterAgent&&(b.deviceList=_.filter(b.deviceList,"agentVersion")),window.ReactDOM.render(window.React.createElement(window[b.byApp?"SelectDevicesByApp":"SelectDevices"],{appList:b.appList,deviceList:b.deviceList,selectedList:b.selectedList,showFields:b.showFields,modelData:b.modelData,selectField:d.selectField,specifiedApp:b.specifiedApp,appId:b.defaultAppId,clusterId:b.defaultClusterId,filterText:d.filterText,username:d.username,isRadio:"true"===d.isRadio,selectSystem:"true"===d.selectSystem,handleClose:function(a){b.close({checkedList:a})},handleDismiss:function(){b.dismiss()},handleShowFields:function(a){b.setShowFields({fields:a})},handleSwitchMode:function(a){b.switchMode({byApp:a})}}),c[0])}).catch(function(){c.html("加载组件失败！")})}}}]).directive("selectDevicesFromCmdb",["$uibModal","$localStorage","handleAjaxError",function(a,b,c){return{restrict:"A",scope:{select:"&",selectedList:"=?",appData:"=?",defaultAppId:"=?",defaultClusterId:"=?",filterFn:"=?",filterText:"=?"},link:function(d,e,f){var g;switch(e.prop("tagName")){case"BUTTON":case"INPUT":g=function(a){e.prop("disabled",a)};break;default:g=angular.noop}var h=f.byApp?"true"===f.byApp:!!b.preferSelectDevicesByApp,i=f.selectField||"ip",j="true"===f.isRadio,k="true"===f.selectSystem,l="true"===f.filterAgent;e.on("click",function(){var f,m=d.$new(!0);m.byApp=h,m.defaultAppId=d.defaultAppId,m.defaultClusterId=d.defaultClusterId,m.specifiedApp=h&&!!d.appData,m.selectedList=d.selectedList,m.selectField=i,m.showFields=b.selectDevicesFromCmdbFields||[],m.isRadio=j,m.selectSystem=k,m.filterAgent=l,m.filterText=d.filterText,m.setShowFields=function(a){b.selectDevicesFromCmdbFields=a,f.dismiss(),e.trigger("click")},m.handleClose=function(a){f.close(a)},m.handleDismiss=function(){f.dismiss()},m.handleSwitchMode=function(a){h=a,b.preferSelectDevicesByApp=h,f.dismiss(),e.trigger("click")},f=a.open({template:'<div select-devices-modal\nby-app="::byApp"\nspecified-app="::specifiedApp"\napp-list="::appList"\ndefault-app-id="::defaultAppId"\ndefault-cluster-id="::defaultClusterId"\ndevice-list="::deviceList"\nselected-list="::selectedList"\nselect-field="{{::selectField}}"\nis-radio="{{::isRadio}}"\nfilter-text="{{::filterText}}"\nselect-system="{{::selectSystem}}"\nfilter-agent="{{::filterAgent}}"\nshow-fields="::showFields"\nmodel-data="::modelData"\nusername="{{::username}}"\nclose="handleClose(checkedList)"\ndismiss="handleDismiss()"\nswitch-mode="handleSwitchMode(byApp)"\nset-show-fields="setShowFields(fields)"\n></div>',
backdrop:"static",scope:m,size:"lg",resolve:{deviceList:["DeviceService","$localStorage",function(a,b){return h?null:a.fetchDeviceList(b.selectDevicesFromCmdbFields,{selectDevicesFromCmdb:!0}).then(function(a){return d.filterFn?_.filter(a,d.filterFn):a})}],appList:["CmdbResourceService",function(a){return h?m.specifiedApp?[angular.copy(d.appData)]:a.fetchInstanceList("APP",["*"]).then(function(a){return d.filterFn&&(a=_.filter(a,d.filterFn)),_.sortBy(a,function(a){return(a.name||"").toLowerCase()})}):null}],modelData:["CmdbModelService",function(a){return h?null:a.fetchModel("HOST")}],deps:["depends",function(a){return a("components/select-devices")}]},controller:"SelectDevicesFromCmdbCtrl"}),g(!0),f.result.then(function(a){g(!1),d.select({devices:a})},function(a){g(!1),a&&"escape key press"!==a&&c(a,"查询主机列表")})})}}}]).controller("SelectDevicesFromCmdbCtrl",["$scope","appList","deviceList","modelData","USERNAME",function(a,b,c,d,e){a.appList=b,a.deviceList=c,a.modelData=d,a.username=e}]).directive("fsmStickyHeader",[function(){return{restrict:"EA",replace:!1,scope:{scrollBody:"@",scrollStop:"=",scrollableContainer:"=",hScrollableContainer:"@",contentOffset:"=",fsmZIndex:"="},link:function(a,b){function c(){if(j.is("tr")||j.is("thead")){var a=j.find("th");i.find("th").each(function(b,c){var d=$(a[b]),e=c.offsetWidth/j.innerWidth()*100;d.css("width",e+"%")})}}function d(){var b=k.scrollTop()+a.scrollStop,c=h.offset().top+m,d=c+h.outerHeight(!1);if(b>c&&b<d)if(j||(f(),j.css({visibility:"visible"})),b<d&&b>d-j.outerHeight(!1)){var g=d-b+a.scrollStop-j.outerHeight(!1);j.css("top",g+"px")}else e();else j&&(i.remove(),i=j,j=null,i.removeClass("fsm-sticky-header"),i.css({position:"relative",left:0,top:0,width:"auto","z-index":0,visibility:"visible"}))}function e(){j.css({top:a.scrollStop,width:i.outerWidth(),left:i.offset().left}),c()}function f(){j=i,i=j.clone(),j.after(i),j.addClass("fsm-sticky-header"),j.css({position:"fixed","z-index":a.fsmZIndex||1e4,visibility:"hidden"}),e()}function g(){k.on("scroll.fsmStickyHeader",d).trigger("scroll"),k.on("resize.fsmStickyHeader",d),l.on("scroll.fsmStickyHeader",d).trigger("scroll"),a.$on("$destroy",function(){k.off(".fsmStickyHeader"),l.off(".fsmStickyHeader")})}var h,i=$(b,this),j=null,k=$(a.scrollableContainer),l=$(a.hScrollableContainer),m=a.contentOffset||0,n=a.$watch("scrollBody",function(){h=$(a.scrollBody),g(),n()});0===k.length&&(k=$(window))}}}]).directive("chartJs",function(){return{restrict:"A",scope:{config:"=chartJs",chartLegend:"@?",chartLegendContainer:"@",watchOn:"=?",getResult:"&?"},link:function(a,b){function c(b,c){var d=$("#"+a.chartLegendContainer);d.html(c.generateLegend())}var d;a.getResult&&b.bind("click",function(b){var c=d.getElementsAtEvent(b);c.length&&a.getResult({datasetIndex:c[0]._datasetIndex,index:c[0]._index})}).bind("mousemove",function(a){var c=d.getElementsAtEvent(a);c.length?b.css("cursor","pointer"):b.css("cursor","default")}),a.$watch("config",function(e){e&&(d?(d.destroy(),d=new Chart(b[0].getContext("2d"),e)):d=new Chart(b[0].getContext("2d"),e),a.chartLegend&&c(b,d))}),a.watchOn&&angular.forEach([].concat(a.watchOn),function(b){a.$watch("config."+b,function(a,b){void 0!==a&&void 0!==b&&d&&d.render(0)},!0)}),a.$on("$destroy",function(){d&&d.destroy()})}}}).directive("chartTreemap",function(){return{restrict:"A",scope:{config:"=chartTreemap",watchOn:"=?"},link:function(a,b){var c;a.$watch("config",function(a){a&&(c?(c.destroy(),c=new new Treemap(b[0],a)):c=new Treemap(b[0],a))}),a.watchOn&&angular.forEach([].concat(a.watchOn),function(b){a.$watch("config."+b,function(a,b){void 0!==a&&void 0!==b&&c&&c.update()},!0)}),a.$on("$destroy",function(){c&&c.destroy()})}}}).directive("taskStatus",["$compile",function(a){function b(a){var b,c,d;switch(a){case"success":case"ok":b="成功",c="text-success",d="fa fa-check";break;case"failed":b="失败",c="text-danger",d="fa fa-warning";break;case"paused":b="暂停",c="text-primary",d="fa fa-pause-circle";break;case"executing":case"run":b="执行中...",d="fa fa-spinner fa-spin";break;case"wait":b="等待中...",d="fa fa-spinner fa-spin";break;case"initial":b="",d="fa fa-spinner fa-spin";break;case"unreachable":b="";break;default:b=a}return{text:b,textClass:c,iconClass:d}}return{restrict:"A",scope:{taskStatus:"="},link:function(c,d){d.html("<i></i> {{text}}"),a(d.contents())(c),c.$watch("taskStatus",function(a){var e=b(a);c.text=e.text,d.removeClass(),e.textClass&&d.addClass(e.textClass);var f=d.find("i").removeClass();e.iconClass&&f.addClass(e.iconClass)})}}}])}(),function(){function a(a,b,d){function e(){event.origin===b.location.origin&&event.data&&"zoomed"===event.data.action&&d(function(){h.zoomed=!0})}function f(){var a=h.range,b=_.find(h.rangeOptionList||c,function(b){return b.value.from===a.from&&b.value.to===a.to});if(b)h.rangeAsText=b.text;else{var d=moment(h.range.from).format("LL"),e="现在";_.isNumber(h.range.to)&&(e=moment(h.range.to).format("LL")),h.rangeAsText=[d,e].join(" - ")}}function g(){h.onChange({range:h.range}),a.$broadcast("datetime range changed",{observer:h.observer,range:h.range})}var h=this;h.$onInit=function(){h.dropdownIsOpen=!1,h.picker={open:{from:!1,to:!1}},f(),h.quickRange=h.range,_.isNumber(h.range.from)&&(h.picker.from=new Date(h.range.from)),_.isNumber(h.range.to)&&(h.picker.to=new Date(h.range.to)),h.datepickerOptions||(h.datepickerOptions={maxDate:new Date}),h.btnClass||(h.btnClass="btn-default"),b.addEventListener("message",e)},h.$onDestroy=function(){b.removeEventListener("message",e)},h.resumeZoom=function(){h.zoomed=!1,g()},h.openDatepicker=function(a){h.picker.open[a]=!0},h.handleQuickChange=function(a){h.picker.from=h.picker.to=null,h.range=_.defaults(a,h.range),f(),h.dropdownIsOpen=!1,g()},h.handleDatePick=function(){h.quickRange=null},h.ok=function(){var a={from:null,to:null};return h.picker.from&&(a.from=+moment(h.picker.from).startOf("day")),h.picker.to&&(a.to=+moment(h.picker.to).endOf("day")),a.from||a.to?(a.from&&a.to&&a.from>a.to&&(a.from=+moment(h.picker.to).startOf("day"),a.to=+moment(h.picker.from).endOf("day")),a.from||(a.from=+moment(h.picker.to).startOf("day")),h.range=_.defaults(a,h.range),f(),h.quickRange=h.range,h.dropdownIsOpen=!1,h.range.to||(h.range.to="now"),void g()):void(h.dropdownIsOpen=!1)}}function b(){var a=this;a.$onInit=function(){a.rangeOptionList||(a.rangeOptionList=_.cloneDeep(c),a.disableMonth&&_.remove(a.rangeOptionList,{text:"近30天"})),a.defaultRange||(a.defaultRange=_.find(a.rangeOptionList,"selected").value),a.range||(a.range=a.defaultRange)},a.handleChange=function(){a.onChange({range:a.range})}}var c=[{value:{from:"now/d",to:"now"},text:"今天"},{value:{from:"now-2d",to:"now"},selected:!0,text:"近2天"},{value:{from:"now-7d",to:"now"},text:"近7天"},{value:{from:"now-30d",to:"now"},text:"近30天"}];angular.module("app.components",[]).component("datetimeRange",{templateUrl:"views/template/_datetime-range.html",bindings:{onChange:"&",range:"<?",defaultRange:"<?",rangeOptionList:"<?",disableMonth:"<?",rangeDisabled:"<?",datepickerOptions:"<?",btnClass:"<?",dropdownMenuRight:"<?",observer:"<?"},controller:a}).component("datetimeQuickRange",{templateUrl:"views/template/_datetime-quick-range.html",bindings:{onChange:"&",range:"<?",defaultRange:"<?",rangeOptionList:"<?",disableMonth:"<?",rangeDisabled:"<?"},controller:b}).factory("DatetimeRangeTranslator",function(){return{grafanaToMonitor:function(a){return{st:_.isNumber(a.from)?Math.round(a.from/1e3):"now/d"===a.from?"-0d":a.from.replace(/^now/,""),et:_.isNumber(a.to)?Math.round(a.to/1e3)-1:(a.to||"").replace(/^now/,"")}},monitorToGrafana:function(a){return{from:_.isNumber(a.st)?1e3*a.st:"-0d"===a.st?"now/d":"now"+a.st,to:_.isNumber(a.et)?1e3*a.et:"now"+(a.et||"")}}}}),a.$inject=["$rootScope","$window","$timeout"]}(),angular.module("app.services",["auth.service","ngStorage"]).factory("depends",["$q","$rootScope","$timeout","cfpLoadingBar",function(a,b,c,d){return function(e){function f(){c.cancel(i),j(),h&&d.complete()}var g=a.defer(),h=!1,i=c(function(){var a=d.status();(!a||a>=1)&&(d.start(),h=!0)},d.latencyThreshold+50),j=b.$on("cfpLoadingBar:completed",function(){c.cancel(i),i=c(function(){d.start(),d.set(.9),h=!0})});return requirejs([].concat(e),function(){f(),g.resolve()},function(a){f(),_.forEach(a.requireModules,function(a){requirejs.undef(a)}),g.reject({data:{error:"加载组件失败: "+a.requireType}})}),g.promise}}]).run(["$templateCache",function(a){a.put("views/pagination/pagination.html",'<li ng-class="{disabled: noPrevious()||ngDisabled}" class="pagination-first"><a href ng-click="selectPage(1, $event)" ng-disabled="noPrevious()||ngDisabled"><i class="fa fa-step-backward"></i></a></li>\n<li ng-class="{disabled: noPrevious()||ngDisabled}" class="pagination-prev"><a href ng-click="selectPage(page - 1, $event)" ng-disabled="noPrevious()||ngDisabled"><i class="fa fa-chevron-left"></i></a></li>\n<li><i>{{page}}/{{totalPages}}</i></li>\n<li ng-class="{disabled: noNext()||ngDisabled}" class="pagination-next"><a href ng-click="selectPage(page + 1, $event)" ng-disabled="noNext()||ngDisabled"><i class="fa fa-chevron-right"></i></a></li>\n<li ng-class="{disabled: noNext()||ngDisabled}" class="pagination-last"><a href ng-click="selectPage(totalPages, $event)" ng-disabled="noNext()||ngDisabled"><i class="fa fa-step-forward"></i></a></li>'),a.put("views/template/loading-modal.html",'<div class="modal-dialog"><div class="modal-content" uib-modal-transclude></div></div>')}]).factory("$aside",["$uibModal",function(a){var b=this.defaults={placement:"right"},c={open:function(c){var d=angular.extend({},b,c);["left","right","bottom","top"].indexOf(d.placement)===-1&&(d.placement=b.placement);var e=["left","right"].indexOf(d.placement)===-1?"vertical":"horizontal";return d.windowClass="ng-aside "+e+" "+d.placement+(d.windowClass?" "+d.windowClass:""),delete d.placement,a.open(d)}},d=angular.extend({},a,c);return d}]).factory("BackgroundJobManager",["$uibModal","$rootScope","$timeout",function(a,b,c){function d(a){if(this._jobs=[],a){var b=this;a.$on("$destroy",function(){b.clear()})}}function e(c,d){_.isString(c)&&(c={message:c}),c=_.defaults({},c,f),this._manager=d;var e=this._scope=c.scope=b.$new(!0);e.message=c.message,e.dotting=c.dotting,delete c.message,delete c.dotting,e.statusMap={success:"fa-check",failed:"fa-warning"},c.windowClass="ng-background-job"+(c.windowClass?" "+c.windowClass:""),this._modal=a.open(c)}var f={backdrop:"static",controller:"BackgroundJobCtrl",dotting:!0,keyboard:!1,message:"Loadding",template:'<span class="status fa" ng-class="statusMap[status]"></span><span class="message" ng-bind="message"></span><span class="dotting" ng-bind="activeDot"></span>',windowTemplateUrl:"views/template/loading-modal.html"};return d.prototype.start=function(a){var b=new e(a,this);return this._jobs.push(b),b},d.prototype.clear=function(){for(var a;a=this._jobs.pop();)a.close()},d.prototype.remove=function(a){var b=_.findIndex(this._jobs,a);b!==-1&&this._jobs.splice(b,1)},e.prototype.setMessage=function(a){return this._scope.message=a,this},e.prototype.setDotting=function(a){return this._scope.dotting=a,this},e.prototype.setStatus=function(a){return this._scope.status=a,this},e.prototype.end=function(a,b,d){if(_.isInteger(b)&&(d=b,b="success"),_.isString(a)&&(this._scope.message=a),this._scope.status=_.isString(a)&&_.isUndefined(b)?"success":b,this._scope.dotting=!1,d){var e=this;c(function(){e.close()},d)}return this},e.prototype.close=function(){return this._modal&&(this._modal.dismiss(),this._modal=null),this._manager&&(this._manager.remove(this),this._manager=null),this},d}]).controller("BackgroundJobCtrl",["$scope","$timeout",function(a,b){function c(){function c(){g=!0,f=(f+1)%3,a.activeDot="...".substr(0,f+1),e=b(c,500)}g||(d(),c())}function d(){g=!1,a.activeDot="",e&&(b.cancel(e),e=null)}var e,f=-1,g=!1;a.$watch("dotting",function(a){a?c():d()}),a.$on("$destroy",function(){d()})}]).factory("PendingRequests",[function(){var a=[];return{push:function(b){a.push(b)},remove:function(b){var c=_.indexOf(a,b);c>-1&&a.splice(c,1)},clear:function(){_.forEach(a,function(a){a.resolve()}),a=[]}}}]).factory("RequestWrapper",["$q","$http","$window","PendingRequests",function(a,b,c,d){function e(c,e,g){g=_.defaults({},g,{track:!0});var h;e.hasOwnProperty("timeout")||(h=a.defer(),e.timeout=h.promise),e.hasOwnProperty("ignoreLoadingBar")||g.track||(e.ignoreLoadingBar=!0);var i=b(e);h&&d.push(h);var j=Date.now(),k=a.defer();return i.then(function(a){var b;switch(c){case"array":b=angular.isArray(a.data);break;case"object":b=angular.isObject(a.data)&&!angular.isArray(a.data);break;case"string":b=angular.isString(a.data);break;case"any":b=!0}b?k.resolve(a.data):(a.TypeError=!0,k.reject(a)),g.track&&f(a.config.url,j,b?"success":"error")},function(a){k.reject(a),0!==a.status&&g.track&&f(a.config.url,j,"exception")}),h&&i.finally(function(){d.remove(h)}),k.promise}function f(a,b,d){if(c.ga){var e=Date.now()-b;c.ga("send","timing","api",a,e,d)}}return{any:function(a,b){return e("any",a,b)},array:function(a,b){return e("array",a,b)},object:function(a,b){return e("object",a,b)},string:function(a,b){return e("string",a,b)}}}]).factory("handleAjaxError",["$log","$state","$window","Dialog","Auth",function(a,b,c,d,e){return function(f,g,h){if(!f||0===f.status||f.status===-1)return null;if(!_.has(f,"status")&&(f.redirected||_.includes([2,3,5],f.type)))return null;var i=f.data;if(403===f.status&&i&&"unsignedin"===i.error){var j=e.getNextState();return j?e.setSignInFrom(j.state,j.params):e.setSignInFrom(b.current.name,b.params),c.location.href=b.href("auth.signin"),null}return 403===f.status&&i&&"license expired"===i.error?(h&&delete h.message,d.alert(_.assign({type:"error",title:"出错了",message:"此项服务的授权已过期！"},h))):!i||i.code%1e4!==203&&6!==Math.floor(i.code%1e4/100)?(angular.isString(i)?i=null:angular.isObject(i)&&(i=i.message||i.error||i.msg||i),a.error("handleAjaxError",f),d.alert(_.assign({type:"error",title:"出错了",message:(_.isString(g)?g:"请求")+"失败！",data:i},h))):(h&&delete h.message,d.alert(_.assign({type:"error",title:"出错了",message:"您没有此操作的权限！"},h)))}}]).factory("Dialog",["$uibModal","$rootScope",function(a,b){function c(a,b,c){a.dismiss=function(a){b.stopPropagation&&a.stopPropagation(),c.dismiss()},a.close=function(a,d){b.stopPropagation&&d.stopPropagation(),c.close(a)}}var d="views/dialog.html",e={title:"提示"};return{alert:function(f){var g=b.$new(!0),h=["title","message","type","html","data","confirmText"];_.defaults(g,_.pick(f,h),e);var i=a.open({templateUrl:d,size:f.size,backdrop:"static",scope:g});return c(g,f,i),i.result.then(f.callback,f.callback),i},confirm:function(f){var g=b.$new(!0),h=["title","message","type","html","isDelete","isDanger","confirmText","cancelText"];_.defaults(g,_.pick(f,h),e),g.showDismiss=!0,g.isDanger=g.isDanger||g.isDelete;var i=a.open({templateUrl:d,size:f.size,backdrop:"static",scope:g});return c(g,f,i),i.result.then(f.resolved,f.rejected),i},prompt:function(f){var g=b.$new(!0),h=["title","message","type","html","isDelete","isDanger","confirmText","cancelText","required","pattern","invalidTips","textarea"];_.defaults(g,_.pick(f,h),{required:!1,pattern:/[\s\S]*/},e),g.showDismiss=!0,g.isPrompt=!0,g.dialogFormId=_.uniqueId("dialog-form-"),g.formData={input:f.value};var i=a.open({templateUrl:d,size:f.size,backdrop:"static",scope:g});return c(g,f,i),i.result.then(f.resolved,f.rejected),i}}}]).filter("dialogTypeIcon",function(){var a={success:"fa fa-check text-success",warning:"fa fa-warning text-warning",error:"fa fa-warning text-danger",info:"fa fa-info-circle text-info"};return function(b){return a[b]||b}}).factory("beforeLeave",["$state","$q","Dialog",function(a,b,c){return function(d,e,f){var g;return d.uiCanExit=function(d){var h=d.to(),i=d.params("to");if(!g&&e(h,i)){var j=b.defer();return c.confirm({type:"warning",message:f||"你的修改还未保存，确定放弃更改离开页面吗？",resolved:function(){g=!0,j.resolve(a.target(h.name,i))},rejected:function(){j.reject(null)}}),j.promise}},function(){g=!0}}}]).factory("Utils",["$timeout","$document",function(a,b){var c={filename:function(a){return a=a||"",/^[^\/]{1,255}$/.test(a)&&!/^(\.\.?)$/.test(a)},filepath:function(a){return a=a||"",/^([^\/]{1,255})(\/[^\/]{1,255})*$/.test(a)&&!/(^|\/)(\.\.?)(\/|$)/.test(a)}};c.dirname=c.filename;var d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return{validate:function(a,b){return c[b](a)},trimFilepath:function(a){return a.replace(/^[\/\s]+|[\/\s]+$/g,"")},escapeHtml:function(a){return String(a).replace(/[&<>"'\/]/g,function(a){return d[a]})},nextVersion:function(a){var b=a.match(/^(.*?)(\d+)(\D*)$/);return b?b[1]+(+b[2]+1)+b[3]:a?a+"2":""},matchIps:function(a){var b=((a||"")+"").match(/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b(?:\[[^[\],;\s]*\])?/g);return b&&_.uniq(b)},ip2long:function(a){a.replace(/\[[^\]]*\]/,"");for(var b=a.split("."),c=0,d=0;d<b.length&&d<4;d+=1)c+=+b[d]*Math.pow(256,b.length-d-1);return b.length>4&&(c=NaN),c},scrollToContentTop:function(){a(function(){b.find("body").scrollTop(0)})},openWindowByPost:function(a,b,c){c=_.defaults({},c,{target:"_blank"});var d=document.createElement("form");d.setAttribute("method","POST"),d.setAttribute("action",a),d.setAttribute("target",c.target),d.className="hide",_.forEach(b,function(a,b){var c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name",b),c.value=a,d.appendChild(c)}),document.body.appendChild(d),d.submit()},sameDir:function(a,b){return!(!a||!b)&&(a+="/"===a.substr(-1)?"":"/",b+="/"===b.substr(-1)?"":"/",a===b)},compareVersions:function(a,b){a+="",b+="";for(var c=a.match(/(?:[a-zA-Z]+|[0-9]+)/g)||[],d=b.match(/(?:[a-zA-Z]+|[0-9]+)/g)||[],e=Math.max(c.length,d.length),f=0;f<e;f+=1){var g=c[f],h=d[f],i=!g,j=!i&&/[0-9]/.test(g),k=!i&&!j,l=!h,m=!l&&/[0-9]/.test(h),n=!l&&!m;if(k&&(g=g.toLowerCase()),n&&(h=h.toLowerCase()),i&&!l)return m?1:-1;if(!i&&l)return j?-1:1;if(j&&m){var o=+h-+g;if(o)return o}else{if(!k||!n)return m-j;if(h>g)return 1;if(h<g)return-1}}return 0},parentState:function(a){return a.substring(0,a.lastIndexOf("."))}}}]).factory("VisitHistory",["$localStorage","TIME_OFFSET",function(a,b){function c(b,c,e){e=e||{},this.namespace=b,this.props=c,this.maxRecords=e.maxRecords||d,this.history=a.visitHistory[b],this.history||(this.history=a.visitHistory[b]=[])}a.visitHistory||(a.visitHistory={});var d=100;return c.prototype.push=function(a){var c=this.history,d=_.remove(c,_.isNil(this.props)?a:_.pick(a,this.props));angular.isObject(a)&&!angular.isArray(a)&&(a.visitedAt=moment().add(b).format(),d.length&&d[0]&&(a.count=(d[0].count||1)+1)),c.push(a),c.length>this.maxRecords&&c.shift()},c.prototype.latest=function(a){return _.takeRight(this.history,a)},c.prototype.frequentlyVisited=function(a){return a=a||5,_.chain(this.history).orderBy([function(a){return a.count||1},"visitedAt"],["desc","desc"]).slice(0,a).value()},c.prototype.all=function(){return this.history},c.getNamespaceByCmdbObjectId=function(a){switch(a){case"APP":return"apps";case"HOST":return"devices";default:return"cmdb-"+a}},c}]).filter("bytes",function(){return function(a,b,c){if(c=c||"B",isNaN(+a)||!isFinite(a))return"-";if(0===a)return"0 "+c;if(!a)return"";b=void 0===b?1:b;var d=["","K","M","G","T","P"],e=Math.floor(Math.log(a)/Math.log(1024)),f=d[e];return+(a/Math.pow(1024,Math.floor(e))).toFixed(b)+" "+f+c}}).filter("diffStatusIcon",function(){return function(a){switch(a){case"A":return"glyphicon glyphicon-plus-sign text-success";case"D":return"glyphicon glyphicon-minus-sign text-danger";case"M":case"X":return"glyphicon glyphicon-info-sign text-warning";default:return null}}}).filter("appPath",function(){return function(a,b){if(!a)return a;var c=[];return c.push(a.name),c.join(void 0===b?" / ":b)}}).filter("allBusinessPath",function(){return function(a,b){if(!a)return a;var c=[],d=!0;return _.has(a,"parents")?c.push("业务:"):_.has(a,"businesses")?c.push("应用:"):_.has(a,"deviceId")&&(d=!1,c.push(a.ip)),d&&c.push(a.name),c.join(void 0===b?" / ":b)}}).filter("dstInterface",function(){return function(a){return a&&_.isObject(a)?a.service+" / "+a.name:a}}).filter("propsFilter",function(){return function(a,b){var c=[];if(angular.isArray(a)){var d=_.keys(b);_.forEach(a,function(a){var e=_.some(d,function(c){var d=b[c].toLowerCase();return a[c].toString().toLowerCase().indexOf(d)!==-1});e&&c.push(a)})}else c=a;return c}}).factory("IMPORT_ERROR",[function(){return{DUPLICATE_KEY_AND_NAME:133326,DUPLICATE_NAME:133327,DB_ERROR_DUPLICATE_KEY:133307}}]).filter("stepStatusIcon",function(){return function(a){switch(a){case"success":return"fa fa-check";case"failed":return"fa fa-warning";case"executing":return"fa fa-spinner fa-spin";case"wait":return"fa fa-circle-o";case"paused":return"fa fa-pause-circle";case"skipped":return"fa fa-ban";case"empty-over":case"empty-wait":return"fa fa-ellipsis-h";default:return""}}}),$.fn.scrollToBottom=function(){return this.each(function(){var a=$(this);a.scrollTop(a.prop("scrollHeight"))})},$.fn.scrollIntoView=function(a){this[0]&&this[0].scrollIntoView&&this[0].scrollIntoView(a)},$.fn.scrollIntoViewInBody=function(){if(this[0]){var a=110;window.scrollBy(0,this.offset().top-$(document.body).prop("scrollTop")-a)}},angular.module("app.templates",[]).run(["$templateCache",function(a){a.put("views/template/_datetime-range.html",'<div class="btn-group"\nuib-dropdown\nauto-close="disabled"\nis-open="$ctrl.dropdownIsOpen">\n<button class="btn"\nng-if="!$ctrl.zoomed"\nng-class="$ctrl.btnClass"\nng-disabled="$ctrl.rangeDisabled"\nuib-dropdown-toggle>\n<i class="fa fa-clock-o" style="margin-right:3px;"></i>\n{{$ctrl.rangeAsText}}\n</button>\n<button class="btn"\nng-if="$ctrl.zoomed"\nng-class="$ctrl.btnClass"\nng-click="$ctrl.resumeZoom()">\n<i class="fa fa-clock-o" style="margin-right:3px;"></i>\n{{"恢复至 " + $ctrl.rangeAsText}}\n</button>\n<div class="dropdown-menu" ng-class="{\'dropdown-menu-right\':$ctrl.dropdownMenuRight}" style="width:455px;padding:20px;">\n<form class="form-validation">\n<div class="form-group">\n<label class="control-label">快速选择:</label>\n<div>\n<datetime-quick-range\non-change="$ctrl.handleQuickChange(range)"\ndefault-range="$ctrl.defaultRange"\nrange="$ctrl.quickRange"\nrange-option-list="$ctrl.rangeOptionList"\ndisable-month="$ctrl.disableMonth"></datetime-quick-range>\n</div>\n</div>\n<div class="form-group">\n<label class="control-label">指定日期:</label>\n<div class="clearfix">\n<div class="input-with-calendar pull-left">\n<input type="text" class="form-control form-control-date"\nname="from"\nng-model="$ctrl.picker.from"\nuib-datepicker-popup\ndatepicker-options="$ctrl.datepickerOptions"\nis-open="$ctrl.picker.open.from"\nng-focus="$ctrl.openDatepicker(\'from\')"\nng-click="$ctrl.openDatepicker(\'from\')"\nng-change="$ctrl.handleDatePick(\'from\')"\nplaceholder="开始日期">\n</div>\n<div class="pull-left margin-left" style="line-height:32px;">\n到\n</div>\n<div class="input-with-calendar pull-left margin-left">\n<input type="text" class="form-control form-control-date"\nname="to"\nng-model="$ctrl.picker.to"\nuib-datepicker-popup\ndatepicker-options="$ctrl.datepickerOptions"\nis-open="$ctrl.picker.open.to"\nng-focus="$ctrl.openDatepicker(\'to\')"\nng-click="$ctrl.openDatepicker(\'to\')"\nng-change="$ctrl.handleDatePick(\'to\')"\nplaceholder="结束日期">\n</div>\n<button type="submit" class="btn btn-primary pull-left margin-left"\nng-click="$ctrl.ok()">\n确定\n</button>\n</div>\n</div>\n</form>\n</div>\n</div>\n')}]).run(["$templateCache",function(a){a.put("views/template/_datetime-quick-range.html",'<div class="btn-group">\n<label class="btn btn-line-primary"\nng-repeat="option in ::$ctrl.rangeOptionList"\nng-model="$ctrl.range"\nuib-btn-radio="option.value"\nng-change="$ctrl.handleChange()"\nng-disabled="$ctrl.rangeDisabled">\n{{option.text}}\n</label>\n</div>\n')}]).run(["$templateCache",function(a){a.put("uib/template/datepicker/datepicker.html",'<div class="uib-datepicker" ng-switch="datepickerMode" role="application" ng-keydown="keydown($event)">\n  <eo-uib-daypicker ng-switch-when="day"></eo-uib-daypicker>\n  <eo-uib-monthpicker ng-switch-when="month"></eo-uib-monthpicker>\n  <div uib-yearpicker ng-switch-when="year"></div>\n</div>\n')}]).run(["$templateCache",function(a){a.put("uib/template/datepicker/day.html",'<table class="uib-daypicker" role="grid" aria-labelledby="{{::uniqueId}}-title" aria-activedescendant="{{activeDateId}}">\n  <thead>\n    <tr>\n      <th><button type="button" class="btn btn-default btn-sm pull-left uib-left" ng-click="move(-1)" tabindex="-1"><i class="fa fa-chevron-left"></i></button></th>\n      <th colspan="{{::5 + showWeeks}}"><button id="{{::uniqueId}}-title" role="heading" aria-live="assertive" aria-atomic="true" type="button" class="btn btn-default btn-sm uib-title" ng-click="toggleMode()" ng-disabled="datepickerMode === maxMode" tabindex="-1">{{title}}</button></th>\n      <th><button type="button" class="btn btn-default btn-sm pull-right uib-right" ng-click="move(1)" tabindex="-1"><i class="fa fa-chevron-right"></i></button></th>\n    </tr>\n    <tr>\n      <th ng-if="showWeeks" class="text-center"></th>\n      <th ng-repeat="label in ::labels track by $index" class="text-center"><small aria-label="{{::label.full}}">{{::label.abbr}}</small></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr class="uib-weeks" ng-repeat="row in rows track by $index">\n      <td ng-if="showWeeks" class="text-center h6"><em>{{ weekNumbers[$index] }}</em></td>\n      <td ng-repeat="dt in row" class="uib-day text-center" role="gridcell"\n        id="{{::dt.uid}}"\n        ng-class="::dt.customClass">\n        <button type="button" class="btn btn-default btn-sm"\n          ng-if="::!dt.secondary"\n          uib-is-class="\n            \'btn-info\' for selectedDt,\n            \'active\' for activeDt\n            on dt"\n          ng-click="select(dt.date)"\n          ng-disabled="::dt.disabled"\n          tabindex="-1"><span ng-class="::{\'text-muted\': dt.secondary, \'text-info\': dt.current}">{{::dt.current ? \'今天\' : dt.label}}</span></button>\n      </td>\n    </tr>\n  </tbody>\n</table>\n')}]).run(["$templateCache",function(a){a.put("uib/template/datepicker/month.html",'<table class="uib-monthpicker" role="grid" aria-labelledby="{{::uniqueId}}-title" aria-activedescendant="{{activeDateId}}">\n  <thead>\n    <tr>\n      <th><button type="button" class="btn btn-default btn-sm pull-left uib-left" ng-click="move(-1)" tabindex="-1"><i class="fa fa-chevron-left"></i></button></th>\n      <th colspan="2"><button id="{{::uniqueId}}-title" role="heading" aria-live="assertive" aria-atomic="true" type="button" class="btn btn-default btn-sm uib-title" ng-click="toggleMode()" ng-disabled="datepickerMode === maxMode" tabindex="-1">{{title}}</button></th>\n      <th><button type="button" class="btn btn-default btn-sm pull-right uib-right" ng-click="move(1)" tabindex="-1"><i class="fa fa-chevron-right"></i></button></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr class="uib-months" ng-repeat="row in rows track by $index">\n      <td ng-repeat="dt in row" class="uib-month text-center" role="gridcell"\n        id="{{::dt.uid}}"\n        ng-class="::dt.customClass">\n        <button type="button" class="btn btn-default"\n          uib-is-class="\n            \'btn-info\' for selectedDt,\n            \'active\' for activeDt\n            on dt"\n          ng-click="select(dt.date)"\n          ng-disabled="::dt.disabled"\n          tabindex="-1"><span ng-class="::{\'text-info\': dt.current}">{{::dt.label}}</span></button>\n      </td>\n    </tr>\n  </tbody>\n</table>\n')}]).run(["$templateCache",function(a){a.put("uib/template/datepicker/year.html",'<table class="uib-yearpicker" role="grid" aria-labelledby="{{::uniqueId}}-title" aria-activedescendant="{{activeDateId}}">\n  <thead>\n    <tr>\n      <th><button type="button" class="btn btn-default btn-sm pull-left uib-left" ng-click="move(-1)" tabindex="-1"><i class="fa fa-chevron-left"></i></button></th>\n      <th colspan="{{::columns - 2}}"><button id="{{::uniqueId}}-title" role="heading" aria-live="assertive" aria-atomic="true" type="button" class="btn btn-default btn-sm uib-title" ng-click="toggleMode()" ng-disabled="datepickerMode === maxMode" tabindex="-1">{{title}}</button></th>\n      <th><button type="button" class="btn btn-default btn-sm pull-right uib-right" ng-click="move(1)" tabindex="-1"><i class="fa fa-chevron-right"></i></button></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr class="uib-years" ng-repeat="row in rows track by $index">\n      <td ng-repeat="dt in row" class="uib-year text-center" role="gridcell"\n        id="{{::dt.uid}}"\n        ng-class="::dt.customClass">\n        <button type="button" class="btn btn-default"\n          uib-is-class="\n            \'btn-info\' for selectedDt,\n            \'active\' for activeDt\n            on dt"\n          ng-click="select(dt.date)"\n          ng-disabled="::dt.disabled"\n          tabindex="-1"><span ng-class="::{\'text-info\': dt.current}">{{::dt.label}}</span></button>\n      </td>\n    </tr>\n  </tbody>\n</table>\n')}]).directive("eoUibDaypicker",function(){return{replace:!0,templateUrl:function(a,b){return b.templateUrl||"uib/template/datepicker/day.html"},require:["^uibDatepicker","eoUibDaypicker"],controller:"EoUibDaypickerController",link:function(a,b,c,d){var e=d[0],f=d[1];f.init(e)}}}).directive("eoUibMonthpicker",function(){return{replace:!0,templateUrl:function(a,b){return b.templateUrl||"uib/template/datepicker/month.html"},require:["^uibDatepicker","eoUibMonthpicker"],controller:"EoUibMonthpickerController",link:function(a,b,c,d){var e=d[0],f=d[1];f.init(e)}}}).controller("EoUibDaypickerController",["$scope","$element","dateFilter",function(a,b,c){function d(a,b){return 1!==b||a%4!==0||a%100===0&&a%400!==0?f[b]:29}function e(a){var b=new Date(a);b.setDate(b.getDate()+4-(b.getDay()||7));var c=b.getTime();return b.setMonth(0),b.setDate(1),Math.floor(Math.round((c-b)/864e5)/7)+1}var f=[31,28,31,30,31,30,31,31,30,31,30,31];this.step={months:1},this.element=b,this.init=function(b){angular.extend(b,this),a.showWeeks=b.showWeeks,b.refreshView()},this.getDates=function(a,b){for(var c,d=new Array(b),e=new Date(a),f=0;f<b;)c=new Date(e),d[f++]=c,e.setDate(e.getDate()+1);return d},this._refreshView=function(){var b=this.activeDate.getFullYear(),d=this.activeDate.getMonth(),f=new Date(this.activeDate);f.setFullYear(b,d,1);var g=this.startingDay-f.getDay(),h=g>0?7-g:-g,i=new Date(f);h>0&&i.setDate(-h+1);for(var j=this.getDates(i,42),k=0;k<42;k++)j[k]=angular.extend(this.createDateObject(j[k],this.formatDay),{secondary:j[k].getMonth()!==d,uid:a.uniqueId+"-"+k});a.labels=new Array(7);for(var l=0;l<7;l++)a.labels[l]={abbr:c(j[l].date,this.formatDayHeader),full:c(j[l].date,"EEEE")};a.title=c(this.activeDate,this.formatDayTitle),a.rows=this.split(j,7);for(var m=a.rows.slice(-2),n=0;n<m.length;n++){for(var o=!0,p=0;p<m[n].length;p++)if(!m[n][p].secondary){o=!1;break}if(o){a.rows.splice(n-2,2-n);break}}if(a.showWeeks){a.weekNumbers=[];for(var q=(11-this.startingDay)%7,r=a.rows.length,s=0;s<r;s++)a.weekNumbers.push(e(a.rows[s][q].date))}},this.compare=function(a,b){var c=new Date(a.getFullYear(),a.getMonth(),a.getDate()),d=new Date(b.getFullYear(),b.getMonth(),b.getDate());return c.setFullYear(a.getFullYear()),d.setFullYear(b.getFullYear()),c-d},this.handleKeyDown=function(a,b){var c=this.activeDate.getDate();if("left"===a)c-=1;else if("up"===a)c-=7;else if("right"===a)c+=1;else if("down"===a)c+=7;else if("pageup"===a||"pagedown"===a){var e=this.activeDate.getMonth()+("pageup"===a?-1:1);this.activeDate.setMonth(e,1),c=Math.min(d(this.activeDate.getFullYear(),this.activeDate.getMonth()),c)}else"home"===a?c=1:"end"===a&&(c=d(this.activeDate.getFullYear(),this.activeDate.getMonth()));this.activeDate.setDate(c)}}]).controller("EoUibMonthpickerController",["$scope","$element","dateFilter",function(a,b,c){this.step={years:1},this.element=b,this.init=function(a){
angular.extend(a,this),a.refreshView()},this._refreshView=function(){for(var b,d=new Array(12),e=this.activeDate.getFullYear(),f=0;f<12;f++)b=new Date(this.activeDate),b.setFullYear(e,f,1),d[f]=angular.extend(this.createDateObject(b,this.formatMonth),{uid:a.uniqueId+"-"+f});a.title=c(this.activeDate,this.formatMonthTitle),a.rows=this.split(d,4)},this.compare=function(a,b){var c=new Date(a.getFullYear(),a.getMonth()),d=new Date(b.getFullYear(),b.getMonth());return c.setFullYear(a.getFullYear()),d.setFullYear(b.getFullYear()),c-d},this.handleKeyDown=function(a,b){var c=this.activeDate.getMonth();if("left"===a)c-=1;else if("up"===a)c-=4;else if("right"===a)c+=1;else if("down"===a)c+=4;else if("pageup"===a||"pagedown"===a){var d=this.activeDate.getFullYear()+("pageup"===a?-1:1);this.activeDate.setFullYear(d)}else"home"===a?c=0:"end"===a&&(c=11);this.activeDate.setMonth(c)}}]),angular.module("url.matcher",[]).constant("encodePathURI",function(a){return a?_.map(a.split("/"),function(a){return encodeURIComponent(a)}).join("/"):""}).constant("decodePathURI",function(a){return a?_.map(a.split("/"),function(a){return decodeURIComponent(a)}).join("/"):""}).config(["$urlMatcherFactoryProvider",function(a){function b(a){return a||""}a.type("pathURI",{encode:b,decode:b,is:function(){return!0}}),a.type("instanceId",{encode:angular.identity,decode:angular.identity,equals:angular.equals,pattern:/[a-f0-9]{13}/}),a.type("hashId",{encode:angular.identity,decode:angular.identity,equals:angular.equals,pattern:/[a-f0-9]{32}/}),a.type("instanceOrHashId",{encode:angular.identity,decode:angular.identity,equals:angular.equals,pattern:/[a-f0-9]{13}[a-f0-9]{19}?/}),a.type("datetimeRange",{encode:function(a){return a&&""+a},decode:function(a){return a&&(/^\d+$/.test(a)?+a:a)},is:function(){return!0}})}]),function(a){var b=a.angular,c=a._;b.module("qgz.clusterType",[]).constant("clusterTypeLabel",[{id:-1,name:"unbind",label:"未绑定集群"},{id:0,name:"develop",label:"开发"},{id:1,name:"test",label:"测试"},{id:2,name:"production",label:"生产"}]).factory("clusterTypeConverter",["clusterTypeLabel",function(a){var b=function(b,d){return function(e){return c.get(c.keyBy(a,b),[e,d])}};return{id2name:function(a){return b("id","name")(a)},id2label:function(a){return b("id","label")(a)},name2id:function(a){return b("name","id")(a)},name2label:function(a){return b("name","label")(a)},label2id:function(a){return b("label","id")(a)},label2name:function(a){return b("label","name")(a)}}}])}(window),function(){angular.module("app.ui.services",[]).factory("toastr",["$window",function(a){return a.toastr.options={closeButton:!0,positionClass:"toast-top-center",timeOut:2e3},a.toastr}])}.call(void 0),angular.module("home",[]).config(["$stateProvider",function(a){a.state("home",{url:"/",templateUrl:"views/home/graphs.html",controller:"HomeIndexCtrl",pageClass:"body-home",redirectTo:function(a){var b=a.injector().get("HOME_DASHBOARD_SLUG");if(b)return"homeDashboard"}}).state("homeDashboard",{url:"/dashboard",template:"<grafana-dashboard db-slug=\"::dbSlug\" db-params=\"{from:'now-30d',to:'now'}\"></grafana-dashboard>",controller:"HomeDashboardCtrl",pageClass:"body-home-dashboard",redirectTo:function(a){var b=a.injector().get("HOME_DASHBOARD_SLUG");if(!b)return"home"}}).state("search",{url:"/search?q&page&objectId",templateUrl:"views/home/search.html",resolve:{abjectData:["Abject",function(a){return a.fetchAbjectList()}]},controller:"HomeSearchCtrl"})}]).controller("HomeIndexCtrl",["$scope","$state",function(a,b){a.formData={},a.search=function(){var c=a.formData.q;c&&b.go("search",{q:c,page:1})}}]).controller("HomeDashboardCtrl",["$scope","HOME_DASHBOARD_SLUG",function(a,b){a.dbSlug=b}]).controller("HomeSearchCtrl",["$scope","$state","$stateParams","$localStorage","$filter","$aside","$document","Dialog","Utils","toastr","Abject","abjectData","IS_SYSTEM_ADMIN","HIDE_FIELD_LIST","OBJECTBLACKLIST","OBJECT_FK_DEFAULT_SHOW","USERNAME",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r=g.find("body");r.addClass("body-search"),a.$on("$destroy",function(){r.removeClass("body-search")});var s={APP:{user:["owner","creator"],tips:"只有创建人和运维负责人才有权限"},HOST:{user:["owner","creator"],tips:"只有创建人和运维负责人才有权限"}};a.isAdmin=function(){return m},a.canModify=function(b,c){if(a.isAdmin())return!0;if("undefined"!=typeof b.__canModify)return b.__canModify;b.__canModify=!0;var d=s[c];if(!d)return!0;for(var e=d.user,f=0;f<e.length;f+=1){var g=e[f];if("creator"===g||"modifier"===g){if(q===b[g])return!0}else if(_.isArray(b[g])){for(var h=0,i=b[g].length;h<i;h+=1)if(q===b[g][h].name)return!0}else if(b[g]&&q===b[g].name)return!0}return b.__canModify=!1,!1},a.getPermTips=function(a){return s[a].tips};var t={};angular.forEach(l,function(a){t[a.objectId]=a,t[a.objectId].attrMapping={},angular.forEach(a.attrList,function(b){t[a.objectId].attrMapping[b.id]=b})}),a.flags={loading:!0,timecost:0},a.pageInfo={page:1,pageSize:20,total:0},a.form={q:c.q||"",page:c.page||1,objectId:c.objectId||"_all_"},a.isDeleteObj=function(a){return!t[a]},a.getField=function(b,c){return!a.isDeleteObj(b)&&t[b].attrMapping[c]},a.hasHighlight=function(a){return _.some(_.values(a._highlight_))};var u=e("json"),v=e("highlight");a.showJsonDetail=function(b,c){var d={};angular.forEach(c,function(a,c){var e=t[b].attrMapping[c];e?d[e.name]=a:d[c]=a}),delete d._highlight_,h.alert({message:'<pre class="json-highlight">'+v(u(d),a.form.q)+"</pre>",html:!0})},a.canEdit=function(b){return!a.isDeleteObj(b)&&o.indexOf(b)===-1},a.isCluster=function(a){return"CLUSTER"===a},a.search=function(d){a.form.page=d||1,c.q=a.form.q,b.transitionTo("search",{q:a.form.q,page:a.form.page,objectId:a.form.objectId},{notify:!1}),a.flags.loading=!0;var e=moment();k.search(a.form).then(function(b){a.pageInfo.total=b.data.total,a.pageInfo.page=b.data.page,a.pageInfo.pageSize=b.data.pageSize,a.result=b.data.list,angular.forEach(a.result,function(a){a._highlight_={}}),a.navList=[{key:"_all_",active:"_all_"===a.form.objectId,count:b.data.total}],angular.forEach(b.data.count,function(b,c){a.navList.push({key:c,active:a.form.objectId===c,count:b})})}).finally(function(){a.flags.loading=!1,a.flags.timecost=((moment()-e)/1e3).toFixed(2)})},a.search(a.form.page),a.select=function(b){a.form.objectId=b.key,a.search()},a.getTotal=function(b){if(_.isEmpty(a.result))return 0;if("_all_"===b){var c=0;return angular.forEach(a.result,function(a){c+=a.length}),c}return a.result[b].length},a.getNavName=function(b){if("_all_"===b)return"全部";if(a.isDeleteObj(b))return"已删除对象";var c=t[b].name;return _.trimEnd(c,"管理")},a.getTitle=function(a,b){var c=p[b]||["name"];return a[c[0]]},a.openInstanceDetail=function(a,c){b.go("cmdb.resources.instance.index",{objectId:c,instanceId:a})}}]),angular.module("delivery",["apps","packages","configPkgs","delivery.directives"]).config(["$stateProvider",function(a){a.state("delivery",{url:"/delivery",abstract:!0,templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl"}).state("delivery.externals",{url:"?id",templateUrl:"views/externals.html",controller:"ExternalsCtrl",resolve:{linkData:["$stateParams","Externals",function(a,b){return b.getLinkById(a.id)}]}})}]).controller("DeliveryAbstractCtrl",["$scope","$state","navHelper",function(a,b,c){a.navGroups=c.getNavModuleOf("delivery").groups,a.isActive=c.isActive}]),function(){function a(a,c,d){var e,f,g;switch(a){case"ok":e="成功",f="text-success",g="fa fa-check";break;case"failed":e="失败",f="text-danger",g="fa fa-warning";break;case"paused":e="暂停",f="text-primary",g="fa fa-pause-circle";break;case"executing":case"run":e=c===!1?"":"中...",g="fa fa-spinner fa-spin";break;case"wait":e="等待中",f="text-muted",g="fa fa-clock-o";break;case"initial":e="",g="fa fa-spinner fa-spin";break;case"unreachable":e="";break;default:e="未知状态"}var h=c===!1?"":b[c]||"未知";return c&&d&&(d.fileOnly?h+=" (文件预下发) ":d.scriptOnly&&(h+=" (执行发布) ")),e=h+e,{text:e,textClass:f,iconClass:g,textClassList:"text-danger text-success text-primary"}}var b={install:"安装",update:"升级",rollback:"回滚",start:"启动",restart:"重启",stop:"停止",uninstall:"卸载",deploy:"部署",getCloudHost:"购买",delCloudHost:"退还",run:"执行","task.run":"执行"},c={install:"fa fa-fw fa-download",update:"fa fa-fw fa-level-up",start:"glyphicon fa-fw glyphicon-play",restart:"glyphicon fa-fw glyphicon-repeat",stop:"glyphicon fa-fw glyphicon-stop",uninstall:"glyphicon fa-fw glyphicon-trash",deploy:"fa fa-fw fa-rocket"};angular.module("delivery.directives",[]).directive("deployResult",["$compile",function(b){return{restrict:"A",scope:{status:"=",action:"=",params:"=?"},link:function(c,d){d.html("<i></i> {{text}}"),b(d.contents())(c),c.$watchGroup(["status","action","params"],function(b){var e=a(b[0],b[1],b[2]);c.text=e.text,d.removeClass(e.textClassList),e.textClass&&d.addClass(e.textClass);var f=d.find("i").removeClass();e.iconClass&&f.addClass(e.iconClass)})}}}]).directive("deployType",["$compile",function(a){return{restrict:"A",scope:{action:"=",params:"=?"},link:function(d,e,f){var g="false"===f.icon?"{{text}}":"<i></i> {{text}}";e.html(g),a(e.contents())(d),d.$watch("action",function(a){d.text=b[a]||"未知";var f=c[a],g=e.find("i").removeClass();f&&g.addClass(f),a&&d.params&&(d.params.fileOnly?d.text+=" (文件预下发)":d.params.scriptOnly&&(d.text+=" (执行发布)"))})}}}]).directive("cloudHostResult",["$compile",function(b){return{restrict:"A",scope:{status:"=",action:"=",params:"=?"},link:function(c,d){d.html("<i></i> {{text}}"),b(d.contents())(c),c.$watchGroup(["status","action","params"],function(b){var e=a(b[0],b[1],b[2]);c.text=e.text,d.removeClass(),e.textClass&&d.addClass(e.textClass);var f=d.find("i").removeClass();e.iconClass&&f.addClass(e.iconClass)})}}}])}(),angular.module("apps",["apps.deploy","apps.app","apps.services","apps.filters","qgz.clusterType","tasks.service","app"]).config(["$stateProvider",function(a){a.state("apps",{url:"/app",abstract:!0,templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl",resolve:{modelData:["CmdbModelService",function(a){return a.fetchModel("APP").then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbListFields-APP",a._$sortKey="cmdbOrderBy-APP",a})}]}}).state("apps.index",{url:"?q&aq&page&pageSize",params:{q:{dynamic:!0,value:null,squash:!0},aq:{dynamic:!1,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0},pageSize:{type:"int",dynamic:!0}},templateUrl:"views/apps/graphs.html",controller:"AppsIndexCtrl",resolve:{instanceList:["$localStorage","$q","CmdbResourceService","modelData",function(a,b,c,d){var e=b.defer();return c.fetchInstanceList("APP",a[d._$storageKey]).then(function(a){e.resolve(a)}).catch(function(a){a.data&&130600===a.data.code?e.resolve(!1):e.reject(a)}),e.promise}]}}).state("apps.uncompletedTasks",{url:"/uncompleted-tasks",templateUrl:"views/apps/uncompleted-tasks.html",controller:"AppsUncompletedTasksCtrl",resolve:{taskList:["Log",function(a){return a.fetchUncompletedBatchDeployTaskList()}]}})}]).controller("AppsUncompletedTasksCtrl",["$scope","taskList",function(a,b){a.taskList=b}]).controller("AppsIndexCtrl",["$controller","$scope","$state","Log","checkPermission","modelData","instanceList","clusterTypeLabel",function(a,b,c,d,e,f,g,h){angular.extend(this,a("CmdbResourceIndexCtrl",{$scope:b,modelData:f,instanceList:g})),b.goDeploy=function(){var a=b.getChecked();a.length&&b.permissionOfReleaseAny&&c.go("apps.deploy",{appIds:_.map(a,"instanceId").join(",")})},d.fetchUncompletedBatchDeployTaskCount().then(function(a){b.uncompletedBatchDeployTaskCount=a.count});var i=_.map(_.filter(h,function(a){return a.id>=0}),"name"),j=["install","upgrade"];b.permissionOfReleaseAny=_.some(i,function(a){return _.some(j,function(b){var c=a+"."+b;return e("apps.app.deploy."+c)})})}]),angular.module("apps.app",["apps.app.packages","apps.app.configPkgs","apps.app.deploy","apps.app.maintain","apps.app.pipeline","apps.app.action","apps.services","packages.services","url.matcher","app","app.services","qgz.clusterType"]).config(["$stateProvider",function(a){a.state("apps.app",{url:"/{instanceId:instanceId}",abstract:!0,template:'<div ui-view="heading"></div><div ui-view></div>',controller:"AppAbstractCtrl",resolve:{appData:["AppService","$stateParams",function(a,b){return a.fetchApp(b.instanceId,{package:1})}]}})}]).controller("AppAbstractCtrl",["$scope","$state","VisitHistory","checkPermission","appData","modelData","clusterTypeLabel",function(a,b,c,d,e,f,g){function h(a){return e.creator===a||_.some(["owner","developer","tester"],function(b){return _.some(e[b],function(b){return b.name===a})})}a.modelData=f,a.modelAttrMap={},_.forEach(f.attrList,function(b){a.modelAttrMap[b.id]=b}),a.appData=e,a.navPipelineActive=function(){return b.includes("apps.app.pipeline")},a.navActionActive=function(){return b.includes("apps.app.action")};var i=new c("apps","instanceId");i.push(_.pick(e,"instanceId"));var j=[1,2,0];e.clusters=_.sortBy(e.clusters,function(a){return j[+a.type]});var k=e._$counts={};k.devices=_.chain(e.clusters).map(function(a){return _.map(a.deviceList,"ip")}).flatten().uniq().value().length,k.packages=e._packageList&&e._packageList.length||0,k.clusters=e.clusters&&e.clusters.length||0,k.configPkgs=_.reduce(e.clusters,function(a,b){return a+=b._packageList&&b._packageList.length||0},0),a.removable=!(e.clusters&&e.clusters.length),a.permissionOfEdit=a.permissionOfRemove=d("apps.manage",e);var l=a.clusterTypes=_.map(_.filter(g,function(a){return a.id>=0}),"name"),m=["install","upgrade"],n=["uninstall","restart","start","stop","remove"],o=m.concat(n),p=a.permissionMapOfDeploy={},q=a.permissionMapOfMaintainAnyCluster={},r=a.permissionMapOfMaintain={},s=a.permissionMapOfRelease={};_.forEach(l,function(a){_.forEach(o,function(b){var c=a+"."+b;p[c]=d("apps.app.deploy."+c,h)}),s[a]=_.some(m,function(b){var c=a+"."+b;return p[c]}),r[a]=_.some(n,function(b){var c=a+"."+b;return p[c]})}),a.permissionOfReleaseAny=_.some(s),a.permissionOfMaintainAny=_.some(r),_.forEach(n,function(a){q[a]=_.some(l,function(b){var c=b+"."+a;return p[c]})})}]).controller("AppTitleCtrl",function(){}),angular.module("apps.app.packages",["packages.services"]).config(["$stateProvider",function(a){a.state("apps.app.index",{url:"/packages?editInstallPath",reloadOnSearch:!1,views:{heading:{templateUrl:"views/apps/app/_heading.html",controller:"AppTitleCtrl"},"":{templateUrl:"views/apps/app/packages.html",controller:"AppPackagesCtrl"}},resolve:{instanceListMap:["$q","PackageService","appData",function(a,b,c){var d=_.uniq(_.map(c._packageList,"packageId"));return a.all(_.zipObject(d,_.map(d,function(a){return b.fetchInstanceList(a)})))}]}})}]).controller("AppPackagesCtrl",["$scope","$state","$stateParams","$uibModal","Dialog","handleAjaxError","toastr","Utils","AppService","checkPermission","appData","instanceListMap",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){a.locked=!0,i.unbindPackage(k.instanceId,a.packageId,a.installPath).then(function(){b.reload()}).catch(function(a){f(a,"解绑程序包")}).finally(function(){a.locked=!1})}a.permissionOfCreatePackage=j("packages.create"),a.packageList=_.slice(k._packageList),a.sortableOptions={containerPositioning:"relative",containment:"#table-app-packages-list"},a.sortableEnabled=!1,a.cancelSort=function(){a.packageList=_.slice(k._packageList),a.sortableEnabled=!1},a.saveOrder=function(){a.savingOrder=!0,i.updateBindingPackageOrder(k.instanceId,_.map(a.packageList,function(a){return{packageId:a.packageId,installPath:a.installPath}})).then(function(){g.success("部署顺序已调整！"),b.reload()}).catch(function(b){a.savingOrder=!1,f(b,"保存程序包顺序")})};var n=[{value:"latest",key:"$latest",text:"最新版本"},{value:"largest",key:"$largest",text:"最大版本"},{value:"specified",text:"指定版本"}],o=_.chain(k.clusters).map("deviceList").flatten().map("deviceId").value();if(_.forEach(a.packageList,function(a){a.currentVersions=_.chain(l[a.packageId]).filter(function(b){return h.sameDir(b.installPath,a.installPath)&&_.includes(o,b.deviceId)}).map("versionName").uniq().value().join(", "),_.defaults(a,{targetVersion:"$latest"});var b=_.find(n,{key:a.targetVersion});b?a.targetVersionDisplay=b.text:a.targetVersionDisplay=a.targetVersion}),a.bindPackage=function(){var b=a.$new(!0);b.ignorePackageList=k._packageList,b.instanceId=k.instanceId,d.open({templateUrl:"views/apps/app/_bind-package.html",backdrop:"static",scope:b,controller:"AppBindPackageCtrl",resolve:{packageList:["PackageService",function(a){return a.fetchPackageList()}]}})},a.$on("bind package",function(){g.success("程序包已绑定！"),b.reload()}),a.setMasterPackage=function(c){"true"!==c.isMaster&&a.permissionOfEdit&&i.updateBindingPackage(k.instanceId,c.packageId,{installPath:c.installPath,isMaster:"true"}).then(function(){b.reload()}).catch(function(a){f(a,"设置主程序包")}).finally(function(){c.locked=!1})},a.unbindPackage=function(b){a.permissionOfEdit&&e.confirm({message:"确定要解除应用 <code>"+_.escape(k.name)+"</code> 和包 <code>"+_.escape(b.name)+"</code> 的关联吗？",html:!0,isDanger:!0,confirmText:"解除绑定",resolved:function(){m(b)}})},a.showDeploySettings=function(b){var c=a.$new(!0);c.appData=k,c.pkg=b,c.targetVersionList=n,c.isPackage=!0,c.isConfigPkg=!1,d.open({templateUrl:"views/apps/app/_deploy-settings.html",backdrop:"static",scope:c,controller:"AppDeploySettingsCtrl",resolve:{versionList:["PackageService",function(a){return a.fetchVersionListAll(b.packageId)}]}})},c.editInstallPath){var p=_.find(a.packageList,{packageId:c.editInstallPath});p&&a.showDeploySettings(p),b.go(b.current.name,{editInstallPath:null},{location:"replace"})}}]).controller("AppBindPackageCtrl",["$scope","$uibModalInstance","handleAjaxError","Dialog","AppService","packageList",function(a,b,c,d,e,f){var g=f;_.forEach(g,function(a){a.lowerCaseName=a.name.toLowerCase()}),a.bindForm={},a.filters={},a.packageList=g,a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.packageList=_.filter(g,function(a){return a.lowerCaseName.indexOf(b)!==-1})):void(a.packageList=g)},a.selectedPackage=null,a.selectPackage=function(b){a.selectedPackage===b?(b.selected=!1,a.selectedPackage=null,a.bindForm.installPath=null):(b.selected=!0,a.selectedPackage&&(a.selectedPackage.selected=!1),a.selectedPackage=b,a.bindForm.installPath=b.installPath)},a.bindSelectedPackage=function(){if(a.selectedPackage&&a.bindForm.installPath){if(!/^(\/|[a-zA-Z]:[\/\\])/.test(a.bindForm.installPath))return void d.alert({type:"warning",message:"请输入有效的部署路径！"});var f=_.pick(a.bindForm,"installPath");f.packageId=a.selectedPackage.packageId,a.binding=!0,e.bindPackage(a.instanceId,f).then(function(){b.close(),a.$emit("bind package")}).catch(function(a){c(a,"绑定程序包")}).finally(function(){a.binding=!1})}}}]).controller("AppDeploySettingsCtrl",["$scope","$document","$timeout","$state","$uibModalInstance","Dialog","handleAjaxError","AppService","ClusterService","versionList",function(a,b,c,d,e,f,g,h,i,j){var k={targetVersion:"$latest"};a.isPackage&&_.assign(k,{preStop:0,forceUpdate:0,postRestart:0,autoStart:0,simulateInstall:0});var l=_.defaults({},a.pkg,k);a.deploySettings={installPath:l.installPath,installPathNew:l.installPath},"linux"===l.platform?a.pathRegex=/^\/.*/:"windows"===l.platform&&(a.pathRegex=/^[a-zA-Z]:\\.*/),a.isPackage&&_.assign(a.deploySettings,{preStop:l.preStop,forceUpdate:l.forceUpdate,postRestart:l.postRestart,autoStart:l.autoStart,simulateInstall:l.simulateInstall}),/^\$/.test(l.targetVersion)?a.deploySettings.targetVersion=l.targetVersion.replace(/^\$/,""):(a.deploySettings.targetVersion="specified",a.deploySettings.targetVersionValue=l.targetVersion),a.versionNameList=_.map(j,"name"),a.targetVersionChanged=function(){"specified"===a.deploySettings.targetVersion&&c(function(){b.find(".form-control[name=targetVersionValue]").focus()})},a.storeDeploySettings=function(){var b=angular.copy(a.deploySettings);if("specified"===b.targetVersion){if(!b.targetVersionValue)return void f.alert({type:"warning",message:"请选择要发布的版本号！"});b.targetVersion=b.targetVersionValue}else b.targetVersion="$"+b.targetVersion;if(delete b.targetVersionValue,!a.isBatch&&!b.installPathNew)return void f.alert({type:"warning",message:"请输入有效的部署路径！"});if(!b.targetVersion)return void f.alert({type:"warning",message:"请输入要发布的版本号！"});if(a.temporary)e.close(b);else{delete b.simulateInstall,a.pkg.locked=!0,a.storing=!0;var c;c=a.isPackage?h.updateBindingPackage(a.appData.instanceId,a.pkg.packageId,b):i.updateBindingConfigPkg(a.clusterData.instanceId,a.pkg.packageId,b),c.then(function(){d.reload()}).catch(function(b){a.storing=!1,g(b,"设置发布策略")}).finally(function(){a.pkg.locked=!1})}}}]),angular.module("apps.app.deploy",["apps.services","packages.services"]).factory("DeployShareData",function(){var a={};return{clear:function(){a={}},empty:function(){return angular.equals(a,{})},complete:function(){return delete a.deploying,a.completed=!0,this},isCompleted:function(){return a.completed},deploy:function(){return delete a.completed,a.deploying=!0,this},isDeploying:function(){return a.deploying},setCheckedDeviceIds:function(b){return a.checkedDeviceIds=b,this},getCheckedDeviceIds:function(){return a.checkedDeviceIds},setCheckedPackageId:function(b){return a.checkedPackageId=b,this},getCheckedPackageId:function(){return a.checkedPackageId},setCheckedClusterId:function(b){return a.checkedClusterId=b,this},getCheckedClusterId:function(){return a.checkedClusterId},setCheckedPackages:function(b){return a.checkedPackages=b,this},getCheckedPackages:function(){return a.checkedPackages},setBatchData:function(b){return a.batchData=b,this},getBatchData:function(){return a.batchData||{}}}}).config(["$stateProvider",function(a){a.state("apps.app.deploy",{url:"/deploy",abstract:!0,template:"<div ui-view></div>",controller:"AppDeployCtrl"}).state("apps.app.deploy.index",{url:"/batch-strategy?packageId&clusterId",templateUrl:"views/apps/app/deploy/batch-strategy.html",controller:"AppDeployBatchStrategyCtrl",resolve:{packageData:["$stateParams","$q","appData",function(a,b,c){var d,e=a.packageId,f=b.defer();return e?(d=_.find(c._packageList,{packageId:e}),d||_.some(c.clusters,function(a){return d=_.find(a._packageList,{packageId:e}),!!d})):(d=_.find(c._packageList,function(a){return"true"===a.isMaster}),!d&&c._packageList&&c._packageList.length&&(d=c._packageList[0])),d?f.resolve(d):f.reject({data:{error:"没有找到程序包"}}),f.promise}],clusterData:["$stateParams","$q","appData",function(a,b,c){var d=a.clusterId,e=b.defer();if(d){var f=_.find(c.clusters,{instanceId:d});f?e.resolve(f):e.reject({data:{error:"没有找到集群"}})}else e.resolve(null);return e.promise}],instanceList:["PackageService","packageData",function(a,b){return a.fetchInstanceList(b.packageId)}]}}).state("apps.app.deploy.selectDevices",{url:"/select-devices?packageId&clusterId",templateUrl:"views/apps/app/deploy/select-devices.html",controller:"AppDeploySelectDevicesCtrl",resolve:{packageData:["$stateParams","$q","appData",function(a,b,c){var d,e=a.packageId,f=b.defer();return e?(d=_.find(c._packageList,{packageId:e}),d||_.some(c.clusters,function(a){return d=_.find(a._packageList,{packageId:e}),!!d})):(d=_.find(c._packageList,function(a){return"true"===a.isMaster}),!d&&c._packageList&&c._packageList.length&&(d=c._packageList[0])),d?f.resolve(d):f.reject({data:{error:"没有找到程序包"}}),f.promise}],clusterData:["$stateParams","$q","appData",function(a,b,c){var d=a.clusterId,e=b.defer();if(d){var f=_.find(c.clusters,{instanceId:d});f?e.resolve(f):e.reject({data:{error:"没有找到集群"}})}else e.resolve(null);return e.promise}],instanceList:["PackageService","packageData",function(a,b){return a.fetchInstanceList(b.packageId)}]}}).state("apps.app.deploy.selectPackages",{url:"/select-packages",templateUrl:"views/apps/app/deploy/select-packages.html",controller:"AppDeploySelectPackagesCtrl",resolve:{clusterData:["DeployShareData","appData",function(a,b){var c=a.getCheckedClusterId();return c?_.find(b.clusters,{instanceId:c}):null}],deviceList:["DeployShareData","clusterData",function(a,b){if(!b)return null;var c=a.getCheckedDeviceIds();return _.filter(b.deviceList,function(a){return _.includes(c,a.instanceId)})}],packageList:["appData","clusterData",function(a,b){return b?_.filter(_.compact(_.concat(a._packageList,b._packageList)),"installPath"):null}],invalidPackageList:["appData","clusterData",function(a,b){return b?_.reject(_.compact(_.concat(a._packageList,b._packageList)),"installPath"):null}],versionListMap:["$q","PackageService","packageList",function(a,b,c){var d=_.uniq(_.map(c,"packageId"));return a.all(_.zipObject(d,_.map(d,function(a){return b.fetchVersionListAll(a)})))}]}}).state("apps.app.deploy.confirm",{url:"/confirm",templateUrl:"views/apps/app/deploy/confirm.html",controller:"AppDeployConfirmCtrl",resolve:{packageList:["DeployShareData",function(a){return a.getCheckedPackages()}],clusterData:["DeployShareData","appData",function(a,b){var c=a.getCheckedClusterId();return c?_.find(b.clusters,{instanceId:c}):null}],deviceList:["DeployShareData","clusterData",function(a,b){if(!b)return null;var c=a.getCheckedDeviceIds();return _.filter(b.deviceList,function(a){return _.includes(c,a.instanceId)})}],versionListMap:["$q","PackageService","packageList",function(a,b,c){var d=_.uniq(_.map(c,"packageId"));return a.all(_.zipObject(d,_.map(d,function(a){return b.fetchVersionListAll(a)})))}],instanceListMap:["$q","PackageService","packageList",function(a,b,c){var d=_.uniq(_.map(c,"packageId"));return a.all(_.zipObject(d,_.map(d,function(a){return b.fetchInstanceList(a)})))}]}})}]).controller("AppDeployCtrl",["$scope","beforeLeave","DeployShareData",function(a,b,c){a.stepList=[{key:"batch-strategy",name:"分批策略"},{key:"select-devices",name:"选择主机"},{key:"select-packages",name:"选择包"},{key:"confirm",name:"确认发布清单"}],a.$on("$destroy",function(){c.clear()}),b(this,function(a){return c.isDeploying()||0!==a.name.indexOf("apps.app.deploy.")&&!c.empty()&&!c.isCompleted()},"发布还未执行，确定放弃发布离开当前页面吗？")}]).controller("AppDeployBatchStrategyCtrl",["$scope","$state","DeployShareData","packageData",function(a,b,c,d){a.activeStepIndex=1,a.packageData=d;var e={batchOn:!0,batchNum:5,batchInterval:3,skipFailed:!0};a.batchData=_.extend({},e,c.getBatchData()),a.checkBatchData=function(){(isNaN(a.batchData.batchNum)||a.batchData.batchNum<1)&&(a.batchData.batchNum=1),(isNaN(a.batchData.batchInterval)||a.batchData.batchInterval<1)&&(a.batchData.batchInterval=0)},a.next=function(){c.setBatchData(a.batchData),b.go("apps.app.deploy.selectDevices")}}]).controller("AppDeploySelectDevicesCtrl",["$scope","$state","Dialog","DeployShareData","appData","instanceList","packageData","clusterData","PackageService","handleAjaxError",function(a,b,c,d,e,f,g,h,i,j){function k(){var b=!1,c=!0;_.forEach(r,function(a){_.forEach(a.packageInstanceList,function(a){a.checked?b=!0:c=!1})}),a.checkedAtLeastOne=b,a.all.checked=c&&b}function l(){var a=[];return _.forEach(r,function(b){_.forEach(b.packageInstanceList,function(b){b.checked&&a.push(b)})}),a}a.activeStepIndex=2,a.packageData=g;var m=a.$parent.$parent.permissionMapOfRelease,n=a.$parent.$parent.clusterTypes,o=a.formPackageList=_.uniqBy(_.map(e._packageList,function(a){return{name:a.name,trackId:a.packageId,group:"程序包"}}),"trackId");_.forEach(e.clusters,function(a){_.forEach(a._packageList,function(b){o.push({name:b.name,packageId:b.packageId,clusterId:a.instanceId,trackId:b.packageId+"-"+a.instanceId,group:"配置包 - "+a.name})})});var p=a.formData={trackId:g.packageId};2===+g.type&&(p.trackId+=h?"-"+h.instanceId:""),a.onPackageChange=function(){var a=p.trackId;if(a){var c=a.split("-"),d={packageId:c[0],clusterId:null};c[1]&&(d.clusterId=c[1]),b.go(b.current.name,d)}};var q={};_.forEach(f,function(a){q[a.deviceId]||(q[a.deviceId]=[]),q[a.deviceId].push(a)}),a.instanceMap=q;var r=e.clusters;h&&(r=[h]),a.clusters=r;var s=d.getCheckedDeviceIds(),t=d.getCheckedClusterId();if(_.forEach(r,function(a){a.packageInstanceList=[],_.forEach(a.deviceList,function(b){b.clusterId=a.instanceId;var c=a.instanceId===t&&_.includes(s,b.instanceId),d=q[b.deviceId];d&&d.length>1?_.forEach(d,function(d){a.packageInstanceList.push({checked:c,device:b,instance:d})}):a.packageInstanceList.push({checked:c,device:b,instance:d&&d.length?d[0]:null})}),1===r.length&&1===a.packageInstanceList.length&&(a.packageInstanceList[0].checked=!0),a.checked=!!a.packageInstanceList.length&&_.every(a.packageInstanceList,"checked")}),!_.some(o,{trackId:p.trackId})){var u=_.filter(o,{packageId:g.packageId}),v=_.map(r,"instanceId"),w=_.find(u,function(a){return _.includes(v,a.clusterId)});w||(w=_.first(u)),w&&(p.trackId=w.trackId)}a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(a){var b=!0,c=!1;_.forEach(a.packageInstanceList,function(a){a.checked?c=!0:b=!1}),a.checked=b&&c,k()},a.groupChecked=function(a){var b=a.checked;_.forEach(a.packageInstanceList,function(a){a.checked=b}),k()},a.allChecked=function(){var b=a.all.checked,c=!1;_.forEach(r,function(a){a.checked=b,_.forEach(a.packageInstanceList,function(a){a.checked=b,b&&(c=!0)})}),a.checkedAtLeastOne=c},a.getPackagesInfo=function(a){if(a&&!a.packageVersionList){var b=a.packageId;i.fetchVersionListAll(b).then(function(b){a.packageVersionList=b}).catch(j)}},a.next=function(){var a=l();if(!a.length)return void c.alert({type:"warning",message:"请选择至少一台主机！"});var f,h=!1,i=_.uniq(_.map(a,function(a){var b=a.device;return void 0===f?f=b.clusterId:f!==b.clusterId&&(h=!0),b.instanceId}));if(h)return void c.alert({type:"warning",message:"请选择同一个集群下的主机！"});var j=_.find(e.clusters,{instanceId:f});return m[n[j.type]]?(d.setCheckedDeviceIds(i),d.setCheckedPackageId(g.packageId),d.setCheckedClusterId(f),void b.go("apps.app.deploy.selectPackages")):void c.alert({type:"warning",message:"您没有所选集群的发布权限！"})}}]).controller("AppDeploySelectPackagesCtrl",["$scope","$state","Dialog","Utils","DeployShareData","appData","clusterData","deviceList","packageList","versionListMap","invalidPackageList",function(a,b,c,d,e,f,g,h,i,j,k){function l(){return _.filter(i,"checked")}if(!g||!h||!h.length)return void b.go("apps.app.deploy.index",null,{location:"replace"});a.simulateInstallTips="<ol><li>模拟安装仅登记包安装实例信息，不会进行复制文件、执行脚本动作，不会影响运行中的服务；</li><li>适用于第一次适用EasyOps部署且不希望影响线上服务的场景。</li></ol>",a.activeStepIndex=3,a.clusterData=g,a.versionListMap=j,a.invalidPackageList=k;var m=e.getCheckedPackageId(),n=e.getCheckedPackages();a.lastParams={packageId:m};var o=["autoStart"],p=["preStop","forceUpdate","postRestart"];a.targetVersionChange=function(a){var b=_.find(j[a.packageId],{versionId:a.targetVersionId});a.targetVersionMemo=b?b.memo:null},n?_.forEach(i,function(a){1===+a.type&&a.checked&&a.related&&a.related.checked&&(a.updateOptions.postRestart=a.related.updateOptions.postRestart,a.installOptions.autoStart=a.related.installOptions.autoStart)}):_.forEach(i,function(b){delete b.checked;var c=j[b.packageId];if(c&&c.length)if("$latest"===b.targetVersion)b.targetVersionId=c[0].versionId;else if("$largest"===b.targetVersion){var e=_.clone(c);e.sort(function(a,b){return d.compareVersions(a.name,b.name)}),b.targetVersionId=e[0].versionId}else{var f=_.find(c,{name:b.targetVersion});f?b.targetVersionId=f.versionId:b.targetVersionId=c[0].versionId}else b.targetVersionId=null;b.packageId===m&&(b.checked=!0),b.installOptions=_.pick(b,o),b.updateOptions=_.pick(b,p),a.targetVersionChange(b)});var q=_.filter(i,"targetVersionId");_.forEach(q,function(a){delete a.related}),_.forEach(q,function(a){if(2===+a.type){var b=_.find(q,function(b){if(b.related||2===+b.type)return!1;var c=b.installPath,d=a.installPath;return!(!c||!d)&&(c+="/"===c.substr(-1)?"":"/",d+="/"===d.substr(-1)?"":"/",0===d.indexOf(c))});b&&(a.related=b,b.related=a)}}),i=[],_.forEach(q,function(a){1===+a.type?(i.push(a),a.related&&i.push(a.related)):a.related?a.related=!0:i.push(a)}),a.packageList=i,a.isPkgGroupChecked=function(a){return a.checked||1===+a.type&&a.related&&a.related.checked},a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(){a.all.checked=_.every(i,"checked"),a.checkedAtLeastOne=_.some(i,"checked")},a.rowChecked(),a.allChecked=function(){var b=a.all.checked;angular.forEach(i,function(a){
a.checked=b}),a.checkedAtLeastOne=b&&!!i.length},a.moveUp=function(a){var b,c=i[a],d=a-(i[a-1].related?2:1);c.related?(b=i.splice(a,2),i.splice(d,0,b[0],b[1])):(b=i.splice(a,1),i.splice(d,0,b[0]))},a.moveDown=function(a){var b,c=i[a],d=a+(i[a+(c.related?2:1)].related?2:1);c.related?(b=i.splice(a,2),i.splice(d,0,b[0],b[1])):(b=i.splice(a,1),i.splice(d,0,b[0]))},a.isLastPkg=function(a){return a===i.length-1||a===i.length-2&&i[a].related},a.next=function(){var a=l();return a.length?(_.forEach(i,function(a,b){if(a.checked)if(1===+a.type)a.related&&a.related.checked&&(a.related.updateOptions.postRestart=a.updateOptions.postRestart,a.updateOptions.postRestart=0,a.related.updateOptions.preStop=0,a.related.updateOptions.forceUpdate=a.updateOptions.forceUpdate,a.related.installOptions.autoStart=a.installOptions.autoStart,a.installOptions.autoStart=0,a.related.installOptions.simulateInstall=a.installOptions.simulateInstall);else if(a.related){var c=i[b-1];c.checked||(a.updateOptions=_.clone(c.updateOptions),a.installOptions=_.clone(c.installOptions))}}),e.setCheckedPackages(a),void b.go("apps.app.deploy.confirm")):void c.alert({type:"warning",message:"请选择至少一个包！"})}}]).controller("AppDeployConfirmCtrl",["$scope","$state","$timeout","$uibModal","Dialog","handleAjaxError","toastr","Utils","DeployService","DeployShareData","appData","clusterData","packageList","deviceList","versionListMap","instanceListMap",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){return _.filter(t,"checked")}function r(a,b){i.getDeployTask(a,{track:!1}).then(function(c){s(c,a,b)}).catch(function(a){f(a,"查询发布状态")})}function s(b,d,e){return _.forEach(b.targetList,function(b,c){var f;_.forEach(a.deployList,function(a,c){c===b.targetId&&(a.status=b.status)}),_.forEach(b.packageStatus,function(g){if(f=_.find(t,function(a){var c=a.instance,d=a.pkg.packageId===g.packageId&&a.device.ip===b.targetId;return d=c?d&&c.installPath===g.installPath:d&&a.installPath===g.installPath})){var h=_.find(b.packageStatus,function(a){return a.packageId===f.pkg.packageId});f.taskStatus=h&&h.status,f.taskId=d,e[c].taskStatus=f.taskStatus,f.progress=g.progress,f.progress&&(_.forEach(f.progress,function(a){switch(a.status){case"ok":a.status="success";break;case"run":a.status="executing"}}),f.activeStep=_.find(f.progress,function(a){return"wait"===a.status||"executing"===a.status||"failed"===a.status})||_.last(f.progress)),a.deployList[b.targetId]&&_.forEach(a.deployList[b.targetId],function(a){a.pkg.packageId===g.param.packageId&&(a.status=g.status,a.activeStep=f.activeStep)}),"ok"===f.taskStatus?(f.activeStepDotting=!1,f.activeStep={name:"完成"}):"failed"===f.taskStatus?(f.activeStepDotting=!1,f.activeStep={name:"失败"}):f.progress&&f.activeStep?"failed"!==f.activeStep.status?f.activeStepDotting=!0:(f.activeStepDotting=!1,f.activeStep={name:"失败"}):"ok"===f.taskStatus?(f.activeStepDotting=!1,f.activeStep={name:"完成"}):"failed"===f.taskStatus?(f.activeStepDotting=!1,f.activeStep={name:"失败"}):"wait"===f.taskStatus&&"failed"===b.status&&(f.taskStatus=f.status="unreachable",f.activeStepDotting=!1,f.activeStep={name:""})}}),"falied"!==b.status||b.packageStatus||a.deployList[b.targetId]&&_.forEach(a.deployList[b.targetId],function(a){a.status="failed"}),"failed"===b.status&&!_.every(b.packageStatus,"progress")}),_.includes(A,b.status)?void j.complete():void(z=c(function(){r(d,e)},3e3))}if(!m||!m.length)return void b.go("apps.app.deploy.index");a.activeStepIndex=4;var t=a.deployList=[],u=a.unchangedList=[];_.forEach(m,function(a){var b=o[a.packageId];a.targetVersionName=_.find(b,{versionId:a.targetVersionId}).name;var c=_.filter(p[a.packageId],function(b){return h.sameDir(b.installPath,a.installPath)}),d={};_.forEach(c,function(a){a.touched=!0,d[a.deviceId]||(d[a.deviceId]=[]),d[a.deviceId].push(a)}),_.forEach(n,function(b){var c=d[b.deviceId];if(c&&c.length>1)_.forEach(c,function(c){return c.versionId===a.targetVersionId?void u.push({pkg:a,device:b,instance:c}):void t.push({checked:!0,pkg:a,device:b,instance:c})});else{var e=c&&c.length?c[0]:null;if(e&&e.versionId===a.targetVersionId)return void u.push({pkg:a,device:b,instance:e});t.push({checked:!0,pkg:a,device:b,instance:e,installPath:a.installPath})}})});var v={};_.forEach(p,function(a,b){var c=angular.copy(_.find(m,{packageId:b}));delete c.targetVersionName,_.forEach(a,function(a){var b=_.pick(a,["packageId","installPath","versionId","versionName"]);v[a.deviceId]||(v[a.deviceId]=[]),v[a.deviceId].push(b)});var d=_.reject(a,"touched"),e={};_.forEach(d,function(a){e[a.deviceId]||(e[a.deviceId]=[]),e[a.deviceId].push(a)}),_.forEach(n,function(a){var b=e[a.deviceId];_.forEach(b,function(b){u.push({pkg:c,device:a,instance:b})})})}),t=_.orderBy(t,"device.ip"),u=_.orderBy(u,"device.ip"),a.deployList=_.groupBy(t,"device.ip"),a.unchangedList=_.groupBy(u,"device.ip"),a.keys=function(a){return _.keys(a)},a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(){a.all.checked=_.every(t,"checked"),a.checkedAtLeastOne=_.some(t,"checked")},a.rowChecked(),a.allChecked=function(){var b=a.all.checked;angular.forEach(t,function(a){a.checked=b}),a.checkedAtLeastOne=b&&!!t.length};var w=j.getBatchData(),x=q(),y={appId:k.instanceId,appName:k.name,batchNum:w.batchOn?w.batchNum:1,batchInterval:w.batchOn?w.batchInterval:0,failedStop:!w.skipFailed,clusterId:l.instanceId,clusterType:""+l.type,packageList:_.map(m,function(a){return{postRestart:_.isNil(a.updateOptions.postRestart)?!!a.postRestart:!!a.updateOptions.postRestart,packageId:a.packageId,packageName:a.name,installPath:a.installPath,simulateInstall:!!a.installOptions.simulateInstall,platform:a.platform,versionId:a.targetVersionId,preStop:_.isNil(a.updateOptions.preStop)?!!a.preStop:!!a.updateOptions.preStop,versionName:a.targetVersionName,force:_.isNil(a.updateOptions.forceUpdate)?!!a.forceUpdate:!!a.updateOptions.forceUpdate,type:a.type,postStart:_.isNil(a.installOptions.autoStart)?!!a.autoStart:!!a.installOptions.autoStart}}),targetList:_.chain(x).map(function(a){return{targetId:a.device.ip,deviceId:a.device.deviceId}}).groupBy("targetId").map(function(a,b){return{targetName:b,targetId:b,instanceInfo:v[a[0].deviceId]||[]}}).value()};a.deploy=function(){var b=q();if(!b.length)return void e.alert({type:"warning",message:"请选择至少一项发布！"});var c=[];_.forEach(b,function(a){var b=a.instance?"pkgUpdate":"pkgInstall",d={packageId:a.pkg.packageId,taskType:b};"pkgUpdate"===b?(d.installPath=a.instance.installPath,d.versionIdFrom=a.instance.versionId):d.installPath=a.installPath;var e=_.find(c,d);e?d=e:(c.push(d),d.ipList=[]),d.items||(d.items=[]),d.items.push(a),d.ipList.push(a.device.ip),"pkgUpdate"===b?(d.versionIdTo=a.pkg.targetVersionId,d.options=a.pkg.updateOptions):(d.versionId=a.pkg.targetVersionId,d.options=a.pkg.installOptions),d.appId=k.instanceId,d.clusterId=l.instanceId});var d=[];c=_.map(c,function(a){var b=a.taskType;return _.forEach(a.options,function(b,c){a[c]=b}),d.push(a.items),delete a.taskType,delete a.options,delete a.items,{taskType:b,params:a}}),a.deploying=!0,i.createDeployTask(y).then(function(b){g.info("正在发布..."),j.deploy();var c=q();_.forEach(c,function(a){a.taskStatus="initial"}),r(b.taskId,_.flatten(d)),a.tooltips.deployStatus=!0,_.find(t,function(a){a.activeStepDotting=!0,a.activeStep={name:"启动任务"}})}).catch(function(b){f(b,"发布"),a.deploying=!1})};var z,A=["ok","failed"];a.tooltips={deployStatus:!1},a.showProgressModal=function(b){a.tooltips.deployStatus=!1;var c=a.$new(!0);c.taskItem=b,d.open({templateUrl:"views/apps/app/deploy/_task-item.html",backdrop:"static",size:"xlg",scope:c})},a.$on("$destroy",function(){z&&c.cancel(z)})}]),angular.module("apps.app.maintain",["apps.services","packages.services"]).config(["$stateProvider",function(a){a.state("apps.app.maintain",{url:"/maintain?packageId&clusterId",templateUrl:"views/apps/app/maintain.html",controller:"AppMaintainCtrl",resolve:{packageData:["$stateParams","$q","appData",function(a,b,c){var d,e=a.packageId,f=b.defer();return e?(d=_.find(c._packageList,{packageId:e}),d||_.some(c.clusters,function(a){return d=_.find(a._packageList,{packageId:e}),!!d})):(d=_.find(c._packageList,function(a){return"true"===a.isMaster}),!d&&c._packageList&&c._packageList.length&&(d=c._packageList[0])),d?f.resolve(d):f.reject({data:{error:"没有找到程序包"}}),f.promise}],clusterData:["$stateParams","$q","appData",function(a,b,c){var d=a.clusterId,e=b.defer();if(d){var f=_.find(c.clusters,{instanceId:d});f?e.resolve(f):e.reject({data:{error:"没有找到集群"}})}else e.resolve(null);return e.promise}],instanceList:["PackageService","packageData",function(a,b){return a.fetchInstanceList(b.packageId)}]}})}]).controller("AppMaintainCtrl",["$scope","$state","Dialog","handleAjaxError","toastr","DeployService","PackageService","appData","instanceList","packageData","clusterData",function(a,b,c,d,e,f,g,h,i,j,k){function l(){var b=!1,c=!0;_.forEach(o,function(a){_.forEach(a.packageInstanceList,function(a){a.checked?b=!0:c=!1})}),a.checkedAtLeastOne=b,a.all.checked=c&&b}function m(){var a=[];return _.forEach(o,function(b){_.forEach(b.packageInstanceList,function(b){b.instance&&b.checked&&a.push(b)})}),a}a.packageData=j;var n,o=h.clusters;k&&(o=[k],n=k.instanceId),a.clusters=o;var p,q=a.formPackageList=_.uniqBy(_.map(h._packageList,function(a,b){var c={name:a.name,packageId:a.packageId,group:"程序包",index:b};return c.packageId!==j.packageId||p||(c.active=!0,p=!0),c}),"packageId");_.forEach(h.clusters,function(a){_.forEach(a._packageList,function(b,c){var d={name:b.name,packageId:b.packageId,clusterId:a.instanceId,group:"配置包 - "+a.name,index:c};n&&d.clusterId!==n||j.packageId!==d.packageId||p||(d.active=!0,p=!0),q.push(d)})});var r={};_.forEach(i,function(a){r[a.deviceId]||(r[a.deviceId]=[]),r[a.deviceId].push(a)}),a.instanceMap=r,_.forEach(o,function(a){delete a.checked,a.packageInstanceList=[],_.forEach(a.deviceList,function(b){b.clusterId=a.instanceId;var c=r[b.deviceId];c&&c.length>1?_.forEach(c,function(c){a.packageInstanceList.push({device:b,instance:c})}):a.packageInstanceList.push({device:b,instance:c&&c.length?c[0]:null})})}),a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(a){var b=!0,c=!1;_.forEach(a.packageInstanceList,function(a){a.checked?c=!0:b=!1}),a.checked=b&&c,l()},a.groupChecked=function(a){var b=a.checked;_.forEach(a.packageInstanceList,function(a){a.instance&&(a.checked=b)}),l()},a.allChecked=function(){var b=a.all.checked,c=!1;_.forEach(o,function(a){a.checked=b,_.forEach(a.packageInstanceList,function(a){a.instance&&(a.checked=b,b&&(c=!0))})}),a.checkedAtLeastOne=c};var s={install:"安装",update:"升级",rollback:"回滚",start:"启动",restart:"重启",stop:"停止",uninstall:"卸载"};a.maintain=function(a,g){var i=s[a],k=g.device,l=g.instance;c.confirm({type:"info",message:"确认要<b"+("stop"===a||"uninstall"===a?' class="text-danger"':"")+">"+i+"</b>主机 <code>"+_.escape(k.ip)+"</code> 的包 <code>"+_.escape(j.name)+"</code> 吗？",html:!0,resolved:function(){f.maintain({packageId:j.packageId,opType:a,ipList:[k.ip],installPath:l.installPath,appId:h.instanceId,clusterId:n||k.clusterId}).then(function(a){e.info("正在"+i+"包 "+j.name),b.go("task.deploy",{event_id:a.taskId})}).catch(function(a){d(a,i)})}})},a.maintainChecked=function(a){var g,i,k=m(),l=!1,o=!1,p=_.map(k,function(a){var b=a.instance,c=a.device;return void 0===i?i=c.clusterId:i!==c.clusterId&&(o=!0),b?(void 0===g?g=b.installPath:g!==b.installPath&&(l=!0),a.device.ip):a.device.ip});if(!k.length)return void c.alert({type:"warning",message:"请选择至少一台主机！"});if(o)return void c.alert({type:"warning",message:"请选择同一个集群下的主机！"});if(l)return void c.alert({type:"warning",message:"请选择相同部署路径的实例！"});if(!g)return void c.alert({type:"warning",message:"请选择已安装包的实例！"});var q=s[a];c.confirm({type:"info",message:"确认要<b"+("stop"===a||"uninstall"===a?' class="text-danger"':"")+">"+q+"</b>这 <b>"+k.length+"</b> 台主机的包 <code>"+_.escape(j.name)+"</code> 吗？",html:!0,resolved:function(){f.maintain({packageId:j.packageId,opType:a,ipList:p,installPath:g,appId:h.instanceId,clusterId:n||i}).then(function(a){e.info("正在"+q+"包 "+j.name),b.go("task.deploy",{event_id:a.taskId})}).catch(function(a){d(a,q)})}})},a.removeInstancesChecked=function(){var f=[];return _.forEach(m(),function(a){a.instance&&f.push(a.instance.instanceId)}),f.length?void c.confirm({type:"info",message:"确认要删除这 <b>"+f.length+"</b> 个包安装记录吗？",html:!0,resolved:function(){a.removingInstances=!0,g.removeInstances(j.packageId,f).then(function(){e.success("包安装记录已删除！"),b.reload()}).catch(function(b){d(b,"删除包安装记录"),a.removingInstances=!1})}}):void c.alert({type:"warning",message:"请选择至少一台有包安装记录的主机！"})},a.removeInstance=function(a){a.instance&&c.confirm({type:"info",message:"确认要删除这 <b>1</b> 个包安装记录吗？",html:!0,resolved:function(){a.removingInstance=!0,g.removeInstances(j.packageId,[a.instance.instanceId]).then(function(){e.success("包安装记录已删除！"),b.reload()}).catch(function(b){d(b,"删除包安装记录"),a.removingInstance=!1})}})}}]),angular.module("apps.app.configPkgs",["apps.services"]).config(["$stateProvider",function(a){a.state("apps.app.configPkgs",{url:"/config-pkgs?editInstallPath&editInstallPathClusterId",reloadOnSearch:!1,views:{heading:{templateUrl:"views/apps/app/_heading.html",controller:"AppTitleCtrl"},"":{templateUrl:"views/apps/app/config-pkgs.html",controller:"AppConfigPkgsCtrl"}},resolve:{instanceListMap:["$q","PackageService","appData",function(a,b,c){var d=_.chain(c.clusters).map("_packageList").compact().flatten().map("packageId").uniq().value();return a.all(_.zipObject(d,_.map(d,function(a){return b.fetchInstanceList(a)})))}]}})}]).controller("AppConfigPkgsCtrl",["$scope","$state","$stateParams","$uibModal","Dialog","handleAjaxError","toastr","Utils","ClusterService","checkPermission","appData","instanceListMap",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a,c){c.unbinding=!0,i.unbindConfigPkg(a.instanceId,c.packageId,c.installPath).then(function(){g.success("配置包已解绑！"),b.reload()}).catch(function(a){f(a,"解绑配置包")}).finally(function(){c.unbinding=!1})}a.permissionOfCreatePackage=j("packages.create");var n=[{value:"latest",key:"$latest",text:"最新版本"},{value:"largest",key:"$largest",text:"最大版本"},{value:"specified",text:"指定版本"}];if(_.forEach(k.clusters,function(a){var b=_.map(a.deviceList,"deviceId");_.forEach(a._packageList,function(a){a.currentVersions=_.chain(l[a.packageId]).filter(function(c){return h.sameDir(c.installPath,a.installPath)&&_.includes(b,c.deviceId)}).map("versionName").uniq().value().join(", "),_.defaults(a,{targetVersion:"$latest"});var c=_.find(n,{key:a.targetVersion});c?a.targetVersionDisplay=c.text:a.targetVersionDisplay=a.targetVersion})}),a.bindConfigPkg=function(b){var c=a.$new(!0);c.appData=k,c.clusterId=b,d.open({templateUrl:"views/apps/app/_bind-config-pkg.html",backdrop:"static",scope:c,controller:"AppBindConfigPkgCtrl",resolve:{packageList:["ConfigPkgService",function(a){return a.fetchConfigPkgList()}]}})},a.$on("bind config pkg",function(){g.success("配置包已绑定！"),b.reload()}),a.unbindConfigPkg=function(a,b){e.confirm({message:"确定要解除集群 <code>"+_.escape(a.name)+"</code> 和包 <code>"+_.escape(b.name)+"</code> 的关联吗？",html:!0,isDanger:!0,confirmText:"解除绑定",resolved:function(){m(a,b)}})},a.showDeploySettings=function(b,c){var e=a.$new(!0);e.appData=k,e.clusterData=b,e.pkg=c,e.targetVersionList=n,e.isPackage=!1,e.isConfigPkg=!0,d.open({templateUrl:"views/apps/app/_deploy-settings.html",backdrop:"static",scope:e,controller:"AppDeploySettingsCtrl",resolve:{versionList:["PackageService",function(a){return a.fetchVersionListAll(c.packageId)}]}})},c.editInstallPath){var o=_.find(k.clusters,{clusterId:c.editInstallPathClusterId});if(o){var p=_.find(o._packageList,{packageId:c.editInstallPath});p&&a.showDeploySettings(o,p)}b.go(b.current.name,{editInstallPath:null,editInstallPathClusterId:null},{location:"replace"})}}]).controller("AppBindConfigPkgCtrl",["$scope","$uibModalInstance","handleAjaxError","Dialog","ClusterService","packageList",function(a,b,c,d,e,f){var g=a.appData,h=_.find(g.clusters,{instanceId:a.clusterId}),i=h?h.instanceId:g.clusters&&g.clusters.length?g.clusters[0].instanceId:null;a.bindForm={clusterId:i},a.filters={};var j=f;_.forEach(f,function(a){a.lowerCaseName=a.name.toLowerCase()}),a.packageList=j,a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.packageList=_.filter(j,function(a){return a.lowerCaseName.indexOf(b)!==-1})):void(a.packageList=j)},a.selectedConfigPkg=null,a.selectConfigPkg=function(b){a.selectedConfigPkg===b?(b.selected=!1,a.selectedConfigPkg=null,a.bindForm.installPath=null):(b.selected=!0,a.selectedConfigPkg&&(a.selectedConfigPkg.selected=!1),a.selectedConfigPkg=b,a.bindForm.installPath=b.installPath)},a.bindSelectedConfigPkg=function(){if(a.selectedConfigPkg&&a.bindForm.clusterId&&a.bindForm.installPath){if(!/^(\/|[a-zA-Z]:[\/\\])/.test(a.bindForm.installPath))return void d.alert({type:"warning",message:"请输入有效的部署路径！"});var f=_.pick(a.bindForm,"installPath");f.packageId=a.selectedConfigPkg.packageId,a.binding=!0,e.bindConfigPkg(a.bindForm.clusterId,f).then(function(){b.close(),a.$emit("bind config pkg")}).catch(function(a){c(a,"绑定配置包")}).finally(function(){a.binding=!1})}}}]),angular.module("apps.app.pipeline",["apps.services","apps.pipeline.services","tools.service","flows.task"]).config(["$stateProvider",function(a){a.state("apps.app.pipeline",{url:"/pipeline",abstract:!0,views:{heading:{templateUrl:"views/apps/app/_heading.html",controller:"AppTitleCtrl"},"":{templateUrl:"views/apps/app/pipeline.html",controller:"AppPipelineAbstractCtrl"}},resolve:{pipelineData:["$q","AppService","PipelineService","appData",function(a,b,c,d){var e=a.defer();return b.pipelineExists(d.instanceId).then(function(a){a.exists?e.resolve({pipelineId:a.data.pipelineId,appId:d.instanceId,flowInputs:a.data.flowInputs,stageList:c.stratifyPipeline(a.data.stepList)}):e.resolve(null)}).catch(function(a){e.reject(a)}),e.promise}]}}).state("apps.app.pipeline.index",{url:"",templateUrl:"views/apps/app/pipeline/graphs.html",controller:"AppPipelineIndexCtrl",resolve:{taskListData:["PipelineService","appData","pipelineData",function(a,b,c){return c?a.fetchPipelineTaskHistory(c.pipelineId):[]}]}}).state("apps.app.pipeline.edit",{url:"/edit?action&clusterId",templateUrl:"views/apps/app/pipeline/edit.html",controller:"AppPipelineEditCtrl",resolve:{toolListData:["Tools",function(a){return a.fetchToolList({detail:"true"})}],pipelineForm:["$stateParams","AppService","PipelineService","pipelineData","appData",function(a,b,c,d,e){return d&&"reinitialize"!==a.action?angular.copy(d):b.fetchPipelineTemplate(e.instanceId,{clusterId:a.clusterId}).then(function(a){return{flowInputs:a.flowInputs,stageList:c.stratifyPipeline(a.stepList)}})}]}})}]).controller("AppPipelineAbstractCtrl",["$scope","pipelineData","PIPELINE_STAGE_NAME_LIST",function(a,b,c){a.stageNameList=c,a.pipelineData=b}]).controller("AppPipelineIndexCtrl",["$scope","$state","$uibModal","$window","handleAjaxError","Dialog","toastr","AppService","PipelineService","appData","pipelineData","taskListData",function(a,b,c,d,e,f,g,h,i,j,k,l){k?(a.taskList=l.list,_.forEach(a.taskList,function(a){i.fetchPipelineTaskResult(a.taskId,{package:1},{track:!1}).then(function(b){a.taskData=b})}),j._packageList&&j._packageList.length?a.toExecutePipeline=function(){var b=a.$new(!0);b.packageList=j._packageList,c.open({templateUrl:"views/apps/app/pipeline/_execute.html",backdrop:"static",scope:b,controller:"AppPipelineExecuteCtrl",resolve:{pipelineData:function(){return k}}})}:a.toExecutePipeline=function(){f.confirm({type:"warning",message:"该应用还没有绑定程序包，现在去绑定？",resolved:function(){b.go("apps.app.index")}})},a.toRemovePipeline=function(){f.confirm({type:"warning",html:!0,isDelete:!0,message:"确定删除这个应用的交付流水线吗？",resolved:function(){h.removePipeline(j.instanceId,k.pipelineId).then(function(){g.success("交付流水线已删除！"),b.reload()}).catch(function(a){e(a,"删除交付流水线")})}})}):j.clusters&&j.clusters.length?a.initializePipeline=function(){var d=a.$new(!0);d.clusterOptions=_.concat({instanceId:null,name:"无预发布环境"},j.clusters||[]),d.formData={clusterId:null},d.doInitialize=function(){d.initializing=!0,b.go("apps.app.pipeline.edit",{action:"create",clusterId:d.formData.clusterId})},c.open({templateUrl:"views/apps/app/pipeline/_initialize.html",backdrop:"static",scope:d})}:a.initializePipeline=function(){f.confirm({type:"warning",message:"该应用还没有任何集群，现在去创建？",resolved:function(){d.open(b.href("cmdb.apps.app.createCluster",{instanceId:j.instanceId}))}})}}]).controller("AppPipelineEditCtrl",["$scope","$state","$stateParams","$timeout","$element","$aside","$uibModal","Dialog","toastr","handleAjaxError","Utils","AppService","PipelineService","appData","pipelineData","toolListData","pipelineForm","PIPELINE_HIDDEN_PARAMS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(a){_.defaults(a,{inputSrc:{},inputField:{},agentSrc:v,agentField:u})}function t(a){return _.includes(r,a.name)}q.flowInputs||(q.flowInputs=[]),a.pipelineForm=q,a.isCreate="create"===c.action,a.isEdit=!a.isCreate;var u="服务器 IP",v={stepName:"交付流水线输入",toolData:{outputList:[u]}},w={stepName:"-- 常量 --",isConst:!0,toolData:{}};_.forEach(p,function(a){a.inputList=angular.copy(a.inputs),a.outputList=a.outputs?a.outputs.split(" "):[]});var x=m.flattenPipeline(q.stageList);_.forEach(x,function(a){var b=_.find(p,{toolId:a.toolId});a.toolData=angular.copy(b),b=b||{},a.execUser=a.execUser||b.defaultExecUser,"powershell"===b.type&&(a.execUser="Administrator");var c=(a.agents||"0.@").split("."),d="#"===c[0],e=+c[0],f=c.slice(1).join(".");a.agentSrc=d?w:e?x[e-1]:v,a.agentField=d||"@"!==f?f:u,s(a),_.forEach(a.inputs,function(b,c){var d=b.split(".");if(d){var e="#"===d[0],f=+d[0],g=d.slice(1).join(".");a.inputSrc[c]=e?w:f?x[f-1]:v,a.inputField[c]=e||"@"!==g?g:u}})}),a.setPipelineSettings=function(){var b=a.$new(!0);b.pipelineForm=q,b.isHiddenParam=t,f.open({templateUrl:"views/apps/app/pipeline/_edit-pipeline-settings.html",scope:b,controller:"AppPipelineEditSettingsCtrl"})},a.$watch("pipelineForm.flowInputs",function(a){v.toolData.outputList=_.chain(a).map("name").compact().push(u).value()},!0),a.toRemoveTask=function(a,b){a.substageName||a.stepList.length?h.confirm({type:"warning",html:!0,message:"确定删除 <code>"+_.escape(a.substageName||"")+"</code> 这个任务吗？",isDelete:!0,resolved:function(){_.remove(b.substageList,a)}}):_.remove(b.substageList,a)},a.appendTask=function(a){var b=_.uniqueId("substage");a.substageList.push({stageId:a.stageId,substageId:b,substageName:null,stepList:[]}),d(function(){e.find('input[name="substageName"][data-substage-id="'+b+'"]').focus()})},a.appendStep=function(b){var c={stageId:b.stageId,substageId:b.substageId,substageName:b.substageName,stepId:_.uniqueId("step")};s(c),b.stepList.push(c),a.showStepDetail(c)};var y;a.showStepDetail=function(b,c){y&&y.dismiss(),a.activeStep=b;var d=a.$new(!0);d.activeStep=b,d.submitted=c;var e=m.flattenPipeline(q.stageList),g=_.indexOf(e,b),h=_.filter(_.slice(e,0,g),function(a){return a.toolData&&a.toolData.outputList.length});d.inputSrcList=[w,v].concat(h),d.isHiddenParam=t,y=f.open({templateUrl:"views/apps/app/pipeline/_edit-step-detail.html",scope:d,controller:"PipelineEditStepDetailCtrl",resolve:{stepList:function(){return e},toolList:function(){return p}}}),y.result.finally(function(){a.activeStep=null})},a.$on("removeStep",function(a,b){var c=_.find(q.stageList,{stageId:b.stageId}),d=_.find(c.substageList,{substageId:b.substageId});_.remove(d.stepList,{stepId:b.stepId})}),a.reinitializePipeline=function(){var c=a.$new(!0);c.clusterOptions=_.concat({instanceId:null,name:"无预发布环境"},n.clusters||[]),c.formData={clusterId:null},c.doInitialize=function(){c.initializing=!0,b.go("apps.app.pipeline.edit",{action:"reinitialize",clusterId:c.formData.clusterId},{reload:!0})},g.open({templateUrl:"views/apps/app/pipeline/_initialize.html",backdrop:"static",scope:c})},a.store=function(){var c,d,e={name:n.name+"-默认部署流水线",flowInputs:angular.copy(_.filter(q.flowInputs,"name")),stepList:[]};_.forEach(e.flowInputs,function(a){delete a.typeText,"enum"===a.type?a.enum&&a.enum.length||(c=a):delete a.enum}),_.forEach(q.stageList,function(a){_.forEach(a.substageList,function(a){_.forEach(a.stepList,function(a,b){b?delete a.before_run_confirm:a.before_run_confirm={enabled:!0}})})});var f=m.flattenPipeline(q.stageList);return _.some(f,function(a,b){var c=_.pick(a,["stageId","substageId","substageName","stepName","execUser","before_run_confirm"]);c.stepId=b+1,c.toolId=a.toolData?a.toolData.toolId:null;var g;if(a.agentSrc.isConst&&(g=k.matchIps(a.agentField),g||(d=a)),d||(a.toolData&&a.stepName&&a.agentSrc&&a.agentField&&a.execUser?_.some(a.inputSrc,function(b,c){return b&&!a.inputField[c]})&&(d=a):d=a),d)return!0;var h=a.agentSrc.isConst?"#":_.indexOf(f,a.agentSrc)+1,i=a.agentSrc.isConst?g.join(" "):a.agentField===u?"@":a.agentField;return c.agents=h+"."+i,_.forEach(a.inputSrc,function(b,d){if(b&&a.inputField[d]){var e=b.isConst?"#":_.indexOf(f,b)+1;c.inputs||(c.inputs={});var g=a.inputField[d];c.inputs[d]=e+"."+(b.isConst||g!==u?g:"@")}}),e.stepList.push(c),!1}),c?(a.setPipelineSettings(),void h.alert({type:"warning",message:"请设置输入参数 "+c.name+" 的枚举列表！"})):d?void a.showStepDetail(d,!0):(a.storing=!0,void(a.isCreate?l.storePipeline(n.instanceId,e).then(function(){b.go("apps.app.pipeline.index",null,{reload:!0})}).catch(function(b){a.storing=!1,j(b,"保存交付流水线")}):m.updatePipeline(o.pipelineId,e).then(function(){b.go("apps.app.pipeline.index",null,{reload:!0})}).catch(function(b){a.storing=!1,j(b,"保存交付流水线")})))}}]).controller("PipelineEditStepDetailCtrl",["$scope","$uibModal","$uibModalInstance","$timeout","Dialog","stepList","toolList",function(a,b,c,d,e,f,g){function h(a){k.stepName&&k.stepName!==a||(k.stepName=k.toolData.name),k.execUser=k.toolData.defaultExecUser,"powershell"===k.toolData.type&&(k.execUser="Administrator"),k.inputSrc={},i(k)}function i(a){_.forEach(f,function(b){_.forEach(b.inputSrc,function(c,d){c===a&&(b.inputSrc[d]=null,b.inputField[d]=null)}),b.agentSrc===a&&(b.agentSrc=null,b.agentField=null)})}function j(){a.$emit("removeStep",k),c.dismiss()}var k=a.activeStep;a.selectTool=function(){var c=a.$new(!0);c.toolId=k.toolData&&k.toolData.toolId;var d=b.open({templateUrl:"views/apps/app/pipeline/_select-tool.html",backdrop:"static",scope:c,controller:"AppPipelineSelectToolCtrl",resolve:{toolList:function(){return g}}});d.result.then(function(a){var b=k.toolData&&k.toolData.name;k.toolData=a,h(b)})},a.removeStep=function(){return k.toolData?void e.confirm({type:"warning",html:!0,message:"确定删除 <code>"+_.escape(k.stepName)+"</code> 这个步骤吗？",isDelete:!0,resolved:j}):void j()},a.validateExecUser=function(b,c){a.formCreateStep.$valid&&(c.whiteList&&c.whiteList.length?(b=b.trim(),c.whiteList.indexOf(b)<0&&a.formCreateStep.execUser.$setValidity("pattern",!1)):c.blackList&&c.blackList.length&&c.blackList.indexOf(b)>-1&&a.formCreateStep.execUser.$setValidity("pattern",!1))},a.agentSrcChanged=function(){k.agentField=null,d(function(){$('.form-control[name="agentField"]').focus()})},a.inputSrcChanged=function(a){k.inputField[a]=null;var b=k.inputSrc[a];b&&d(function(){$('.form-control[name="field_'+a+'"]').focus()})}}]).controller("AppPipelineEditSettingsCtrl",["$scope","$uibModal","$timeout",function(a,b,c){function d(a){var b,c=_.find(f,{value:a.type});return c?(b=c.text,"enum"===a.type&&a.enum&&(b+=" ("+a.enum.length+")")):b="strings",b}var e=a.pipelineForm,f=a.inputTypeList=[{value:"string",text:"单行字符串"},{value:"strings",text:"多行字符串"},{value:"int",text:"整型"},{value:"enum",text:"枚举"},{value:"ips",text:"IP 列表"}];_.forEach(e.flowInputs,function(a){a.typeText=d(a)}),a.selectInputType=function(a,b){a.type=b.value,a.typeText=d(a)},a.setInputOfEnum=function(c){var e=a.$new(!0);e.inputName=c.name,e.enumList=_.map(c.enum,function(a){return{value:a}}),e.enumList.length||e.enumList.push({value:null});var f=b.open({templateUrl:"views/tools/_set-input-enum.html",backdrop:"static",scope:e,controller:["$scope","$timeout",function(a,b){a.appendOne=function(){a.enumList.push({value:null}),b(function(){$("#input-enum-list input").last().focus()})}}]});f.result.then(function(){c.enum=_.compact(_.map(e.enumList,"value")),c.typeText=d(c)})},a.addInput=function(){e.flowInputs.push({name:"",type:"string",typeText:"单行字符串"}),c(function(){$('#table-flow-input input[ng-model="item.name"]').last().focus()})},a.removeInput=function(a){e.flowInputs.splice(a,1)}}]).controller("AppPipelineSelectToolCtrl",["$scope","$timeout","toolList",function(a,b,c){function d(a,b){return{category:b,list:a}}function e(a){return a.category.toLowerCase()}function f(a){return a.name.toLowerCase()}c=_.sortBy(c,f);var g=_.chain(c).groupBy("category").map(d).sortBy(e).value();a.toolListGroup=g,a.toolForm={toolId:a.toolId},a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.toolListGroup=_.chain(c).filter(function(a){return a.name.toLowerCase().indexOf(b)!==-1}).groupBy("category").map(d).sortBy(e).value()):void(a.toolListGroup=g)},b(function(){$(".selected","#select-pipeline-tool").scrollIntoView(!1)})}]).controller("AppPipelineExecuteCtrl",["$scope","$state","$localStorage","handleAjaxError","Utils","PipelineService","pipelineData","PIPELINE_HIDDEN_PARAMS",function(a,b,c,d,e,f,g,h){function i(){return g.pipelineId+"-"+j.PACKAGE_ID}var j=a.executeForm={flowInputs:_.filter(angular.copy(g.flowInputs),function(a){return!_.includes(h,a.name)})},k=_.find(a.packageList,function(a){return"true"===a.isMaster});if(!k&&a.packageList&&a.packageList.length&&(k=a.packageList[0]),k&&(j.PACKAGE_ID=k.packageId),_.forEach(j.flowInputs,function(a){"int"===a.type?a.value=+a.default:a.value=a.default}),c.pipelineRecentExecutions){var l=c.pipelineRecentExecutions[i()];l&&_.forEach(j.flowInputs,function(a){_.has(l,a.name)&&(a.value=l[a.name])})}a.selectDevicesForInput=function(a,b){b.selectedIps=_.uniq(_.map(a,"ip")),b.value=b.selectedIps.join(", ")},a.inputItemChange=function(a){"enum"===a.type&&(a.selectedIps=e.matchIps(a.value))};var m={jenkins_job_url:"Jenkins 任务 URL",git_tag_name:"Git 标签 (版本号)"};a.getPipelineInputName=function(a){return m[a]||a},a.doExecute=function(){a.executing=!0;var e={};angular.forEach(j.flowInputs,function(a){e[a.name]=""+(a.value||"")});var h=_.clone(e);e.APP_ID=g.appId,e.PACKAGE_ID=j.PACKAGE_ID,f.executePipeline(g.pipelineId,e).then(function(a){b.go("task.pipelines",{event_id:a.taskId})}).catch(function(b){a.executing=!1,d(b,"执行交付流水线")}),c.pipelineRecentExecutions||(c.pipelineRecentExecutions={}),c.pipelineRecentExecutions[i()]=h}}]),angular.module("apps.pipeline.services",[]).factory("PipelineService",["RequestWrapper",function(a){return{stratifyPipeline:function(a){var b=_.map(_.groupBy(a,"substageId"),function(a){return{stageId:a[0].stageId,substageId:a[0].substageId,substageName:a[0].substageName,stepList:a}}),c=_.map(_.groupBy(b,"stageId"),function(a){return{stageId:a[0].stageId,substageList:a}});return _.forEach([1,2,3,4],function(a,b){(!c[b]||c[b].stageId>a)&&c.splice(b,0,{stageId:a,substageList:[]})}),c},flattenPipeline:function(a){var b=1;return _.forEach(a,function(a){_.forEach(a.substageList,function(a){a.substageId=b,b+=1,_.forEach(a.stepList,function(b){b.substageId=a.substageId,b.substageName=a.substageName})})}),_.flatten(_.map(_.flatten(_.map(a,"substageList")),"stepList"))},fetchPipeline:function(b){return a.object({method:"GET",url:"/api/pipelines/pipeline/"+b})},updatePipeline:function(b,c){return a.object({method:"PUT",url:"/api/pipelines/pipeline/"+b,data:c})},fetchPipelineTaskHistory:function(b,c){return a.object({method:"GET",url:"/api/pipelines/pipeline/"+b+"/task",params:c})},fetchPipelineTaskResult:function(b,c,d){return a.object({method:"GET",url:"/api/pipelines/task/"+b,params:c},d).then(function(a){var b=_.map(_.groupBy(a.stepList,"substageId"),function(a){var b="wait",c=0,d=0;return _.some(a,function(a){switch(a.status){case"executing":case"failed":case"paused":b=a.status;break;case"skipped":d+=1;break;case"success":c+=1}}),c&&c===a.length-d&&(b="success"),d===a.length&&(b="skipped"),{stageId:a[0].stageId,substageId:a[0].substageId,
substageName:a[0].substageName,stepList:a,status:b}}),c=_.map(_.groupBy(b,"stageId"),function(a){var b="wait",c=0,d=0;return _.some(a,function(a){switch(a.status){case"executing":case"failed":case"paused":b=a.status;break;case"skipped":d+=1;break;case"success":c+=1}}),c&&c===a.length-d&&(b="success"),d===a.length&&(b="skipped"),{stageId:a[0].stageId,substageList:a,status:b}});return _.forEach([1,2,3,4],function(a,b){(!c[b]||c[b].stageId>a)&&c.splice(b,0,{stageId:a,substageList:[],status:!b||_.includes(["success","skipped","empty-over"],c[b-1].status)?"empty-over":"empty-wait"})}),a.stageList=c,a})},executePipeline:function(b,c){return a.object({method:"POST",url:"/api/pipelines/pipeline/"+b+"/task",data:{flowInputs:c}})},continueExecute:function(b,c){return a.object({method:"POST",url:"/api/pipelines/task/"+b+"/continue/"+c})},skipExecute:function(b,c,d){return a.object({method:"POST",url:"/api/pipelines/task/"+b+"/skip/"+c,data:{skipSteps:d}})}}}]),angular.module("apps.app.action",["apps.services","apps.action.services","flows.service","cmdb.devices.cloudHost"]).config(["$stateProvider",function(a){a.state("apps.app.action",{url:"/action",abstract:!0,views:{heading:{templateUrl:"views/apps/app/_heading.html",controller:"AppTitleCtrl"},"":{templateUrl:"views/apps/app/action.html"}}}).state("apps.app.action.index",{url:"",templateUrl:"views/apps/app/action/graphs.html",controller:"AppActionIndexCtrl",resolve:{actionsList:["$stateParams","ActionService",function(a,b){var c=a.instanceId;return b.getActionsList(c)}],awsImageData:["CloudHostService",function(a){return a.getAWSImageData()}]}})}]).controller("AppActionIndexCtrl",["$scope","$state","$stateParams","appData","actionsList","$uibModal","toastr","ActionService","handleAjaxError","awsImageData",function(a,b,c,d,e,f,g,h,i,j){a.actionsList=e,a.canExec=function(a){for(var b=!0,c=_.chain(a.flowInputs).reject({inputType:"default"}).filter({config:!0,require:!0}).value(),d=0;d<c.length;d++){var e=c[d];if(!a.params||!a.params[e.name]){b=!1;break}}return b},a.process=function(e,k){var l=f.open({templateUrl:"views/apps/app/action/_config.html",backdrop:"static",controller:"AppActionConfigCtrl",resolve:{isConfig:function(){return!k},actionData:function(){return e},appData:function(){return d},awsImageList:function(){return j}}});l.result.then(function(d){if(k){var e=d.taskId;b.go("task.flows",{event_id:e})}else g.success("配置成功"),h.getActionsList(c.instanceId).then(function(b){a.actionsList=b}).catch(i)},function(){})}}]).controller("AppActionConfigCtrl",["$scope","$uibModalInstance","$location","$uibModal","ActionService","Flows","handleAjaxError","isConfig","actionData","appData","toastr","awsImageList","Utils",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){var c=i.actionId,d={params:{}};a.isDeploy&&(a.formData.execIps?d.params.execIps=a.formData.execIps:k.warning("请选择流程执行 IP")),_.forEach(a.inputsList,function(b){d.params[b.name]=a.formData[b.name]||""}),d=angular.extend({},i,d),e.editAction(p,c,d).then(function(a){b.close(a)}).catch(g).finally(function(){a.working=!1})}function o(){var d={flowId:i.actionId,flowInputs:{}};"deploy"===i.category&&(d.flowAgents=i.params.execIps),_.forEach(i.flowInputs,function(b){"app"===b.kind?d.flowInputs[b.name]=p:"clientUrl"===b.kind?d.flowInputs[b.name]=c.host():a.formData[b.name]?(d.flowInputs[b.name]=a.formData[b.name],"ip"===b.kind&&(d.flowInputs[b.name]=d.flowInputs[b.name])):i.params[b.name]?d.flowInputs[b.name]=i.params[b.name]:"cloudHost"===i.category&&"provider"===b.name?d.flowInputs[b.name]="AWS":d.flowInputs[b.name]="",_.isArray(d.flowInputs[b.name])?d.flowInputs[b.name]=d.flowInputs[b.name].join(","):_.isNumber(d.flowInputs[b.name])&&(d.flowInputs[b.name]=d.flowInputs[b.name].toString())});var f={deploy:a.isDeploy};e.execAction(p,i.actionId,d,f).then(function(a){b.close(a)}).catch(g).finally(function(){a.working=!1})}var p=j.instanceId;a.appData=j,a.isConfig=h,a.isDeploy="deploy"===i.category,a.packageList=j._packageList,a.clusterList=j.clusters,a.osList=l,a.inputsList=_.chain(i.flowInputs).reject({inputType:"default"}).value(),h?a.inputsList=_.filter(a.inputsList,{config:!0}):a.inputsList=_.reject(a.inputsList,{config:!0}),a.formData={name:i.desc},a.osChanged=function(b){var c=[],d=a.formData[b.name],e=_.find(a.osList,{id:d});e&&(_.forEach(e.instanceType,function(a){var b=a.name,d=a["zh-CN"];_.forEach(a.types,function(a){var e={family:{name:b,zhCN:d},name:a};c.push(e)})}),a.osInstanceTypeList=c)},h&&(_.forEach(i.flowInputs,function(b){a.formData[b.name]=i.params&&i.params[b.name]||"","os"===b.kind&&a.osChanged(b)}),"deploy"===i.category&&(a.formData.execIps=i.params&&i.params.execIps||[],a.formData.execDeviceList=a.formData.execIps.join(", "),a.execDeviceCount=a.formData.execIps.length)),_.forEach(a.inputsList,function(b){if("package"===b.kind)if(b.multi_flag){var c=a.formData[b.name];a.formData[b.name]=_.filter(c,function(a){return!!_.find(j._packageList,{packageId:a})})}else{var d=a.formData[b.name];_.find(j._packageList,{packageId:d})||(a.formData[b.name]="")}}),a.selectExecDevices=function(b){b.length>1&&(k.warning("只能选一个执行 IP"),b=b.slice(0,1)),a.formData.execDeviceList=_.map(b,"ip").join(", "),a.formData.execIps=m.matchIps(a.formData.execDeviceList),a.execDeviceCount=b?b.length:0},a.selectAppDevices=function(b){var c=_.find(a.inputsList,{kind:"cluster"});if(a.deviceList=[],c){var e=a.formData[c.name];if(!e)return void k.warning("请先选择集群！");var f=_.find(j.clusters,{instanceId:e});a.deviceList=f&&f.deviceList||[]}else a.deviceList=_.chain(j.clusters).map("deviceList").flatten().uniqWith(_.isEqual).compact().value();var g=d.open({templateUrl:"views/apps/app/action/_select-devices.html",backdrop:"static",controller:"AppActionSelectDeviceCtrl",resolve:{input:function(){return b},deviceList:function(){if(!a.deviceList.length)return[];var c=a.deviceList;return _.forEach(c,function(c){c.selected=!!a.formData[b.name]&&a.formData[b.name].indexOf(c.ip)>-1}),c}}});g.result.then(function(c){a.formData[b.name]=_.map(c,b.pick||"ip"),a.formData.appDeviceList=_.map(c,"ip").join(", "),a.appDeviceCount=c?c.length:0})},a.process=function(){a.working=!0,h?n():o()}}]).controller("AppActionSelectDeviceCtrl",["$scope","$uibModalInstance","input","deviceList",function(a,b,c,d){a.deviceList=d,a.filters={q:""},a.search=function(){var b=a.filters.q;b?a.deviceList=_.filter(d,function(a){return _.includes(a.ip,b)}):a.deviceList=d},a.selectDevice=function(a){c.multi_flag?a.selected=!a.selected:b.close([a])},a.confirm=function(){var a=_.filter(d,{selected:!0});b.close(a)}}]),angular.module("apps.action.services",[]).factory("ActionService",["RequestWrapper",function(a){return{getActionsList:function(b){return a.array({method:"GET",url:"/api/app/"+b+"/action"})},createAction:function(b,c){return a.object({method:"POST",url:"/api/app/"+b+"/action",data:c})},editAction:function(b,c,d){return a.object({method:"PUT",url:"/api/app/"+b+"/action/"+c,data:d})},execAction:function(b,c,d,e){return a.object({method:"POST",url:"/api/app/"+b+"/action/"+c+"/exec",data:d,params:e})},deleteAction:function(b,c){return a.object({method:"DELETE",url:"/api/app/"+b+"/action/"+c})}}}]),angular.module("apps.deploy",["cmdb.service","flows.service","flows.task"]).config(["$stateProvider",function(a){a.state("apps.deploy",{url:"/deploy?appIds",templateUrl:"views/apps/deploy.html",controller:"AppsDeployCtrl",resolve:{appList:["$stateParams","$q","DeployService",function(a,b,c){return c.getApps(a.appIds.split(","))}],fullPackageList:["appList",function(a){var b=[],c={targetVersion:"$latest",preStop:0,forceUpdate:0,postRestart:0,autoStart:0,simulateInstall:0};return _.forEach(a,function(a){_.forEach(a._packageList,function(d){_.defaults(d,c),d.appData=a,b.push(d)}),_.forEach(a.clusters,function(d){_.forEach(d._packageList,function(e){_.defaults(e,c),e.appData=a,e.clusterData=d,b.push(e)})})}),b}],versionListMap:["$q","PackageService","fullPackageList",function(a,b,c){var d=_.uniq(_.map(c,"packageId"));return b.fetchVersionListOfPackages(d)}],instanceListMap:["$q","PackageService","fullPackageList",function(a,b,c){var d=_.uniq(_.map(c,"packageId"));return b.fetchInstanceListOfPackages(d)}]}})}]).controller("AppsDeployCtrl",["$scope","$state","$uibModal","$q","Utils","handleAjaxError","toastr","Dialog","VisitHistory","DeployService","appList","fullPackageList","versionListMap","instanceListMap",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){if(a.settings.showUnchangedPackages?a.filteredPackageList=a.packageList.slice():a.filteredPackageList=_.filter(a.packageList,function(a){return a.deployList.length}),a.deployForm.name===v){var b=_.uniq(_.map(_.filter(a.packageList,function(a){return a.deployList.length}),"appData"));b.length&&(v=a.deployForm.name="多应用部署: "+b[0].name+"等"+b.length+"个应用")}}function p(){_.forEach(n,function(a){_.forEach(a,function(a){a.touched=!1})}),_.forEach(a.packageList,function(a){var b=_.filter(n[a.packageId],function(b){return e.sameDir(b.installPath,a.installPath)}),c={};_.forEach(b,function(a){a.touched=!0,c[a.deviceId]||(c[a.deviceId]=[]),c[a.deviceId].push(a)});var d=[],f=[];_.forEach((a.appData.selectedCluster||{}).deviceList,function(b){var e=c[b.deviceId];if(e&&e.length>1)_.forEach(e,function(c){a.targetVersionData&&c.versionId!==a.targetVersionData.versionId?f.push({device:b,instance:c}):d.push({device:b,instance:c})});else{var g=e&&e.length?e[0]:null;a.targetVersionData?g&&g.versionId===a.targetVersionData.versionId?d.push({device:b,instance:g}):f.push({device:b,instance:g,installPath:a.installPath}):g&&d.push({device:b,instance:g})}}),a.deployList=f,a.unchangedList=d}),_.forEach(a.packageList,function(a){var b=_.reject(n[a.packageId],"touched"),c={};_.forEach(b,function(a){c[a.deviceId]||(c[a.deviceId]=[]),c[a.deviceId].push(a)}),_.forEach((a.appData.selectedCluster||{}).deviceList,function(b){var d=c[b.deviceId];_.forEach(d,function(c){a.unchangedList.push({device:b,instance:c})})}),a.tooltip=null,a.deployList.length||(a.targetVersionData?a.unchangedList.length?a.tooltip="没有任何变更":a.appData.selectedCluster?a.tooltip="没有找到任何主机":a.tooltip="没有找到对应的集群":a.tooltip="没有找到目标版本")}),o()}function q(b){_.forEach(b,function(a){delete a.related}),_.forEach(b,function(a){if(2===+a.type){var c=_.find(b,function(b){if(b.related||2===+b.type)return!1;var c=b.installPath,d=a.installPath;return!(!c||!d)&&(c+="/"===c.substr(-1)?"":"/",d+="/"===d.substr(-1)?"":"/",0===d.indexOf(c))});c&&(a.related=c,c.related=a)}});var c=[];_.forEach(b,function(a){1===+a.type?(c.push(a),a.related&&c.push(a.related)):a.related?a.related=!0:c.push(a)}),a.packageList=c}function r(c){var d=a.deployForm.name;if(d&&d.length>32)return void h.alert({type:"warning",message:"请输入1-32个字符的任务名称",callback:function(){$('input[ng-model="deployForm.name"]').focus().select()}});if(!a.deployForm.cluster)return void h.alert({type:"warning",message:"请先选择要发布的集群",callback:function(){$('select[ng-model="deployForm.cluster"]').focus()}});_.forEach(l,function(a){a.options=_.pick(a,u)}),_.forEach(a.packageList,function(b,c){if(b.deployList.length)if(1===+b.type)b.related&&b.related.deployList.length&&(b.related.options.postRestart=b.options.postRestart,b.options.postRestart=0,b.related.options.preStop=0,b.related.options.forceUpdate=b.options.forceUpdate,b.related.options.autoStart=b.options.autoStart,b.options.autoStart=0,b.related.options.simulateInstall=b.options.simulateInstall);else if(b.related){var d=a.packageList[c-1];d.deployList.length||(b.options=_.clone(d.options),b.options=_.clone(d.options))}});var e=[];return _.forEach(a.packageList,function(a){if(a.deployList.length){var b=_.find(e,function(b){return b.params.appId===a.appData.instanceId});b||(b={name:a.appData.name,params:{appId:a.appData.instanceId,strategy:{name:"serial"},steps:[]}},e.push(b));var c=[];_.forEach(a.deployList,function(b){var d=b.instance?"pkgUpdate":"pkgInstall",e={packageId:a.packageId,taskType:d};"pkgUpdate"===d?(e.installPath=b.instance.installPath,e.versionIdFrom=b.instance.versionId):e.installPath=b.installPath;var f=_.find(c,e);f?e=f:(c.push(e),e.ipList=[]),e.items||(e.items=[]),e.items.push(b),e.ipList.push(b.device.ip),"pkgUpdate"===d?(e.versionIdTo=a.targetVersionData.versionId,e.options=_.pick(a.options,["preStop","forceUpdate","postRestart"])):(e.versionId=a.targetVersionData.versionId,e.options=_.pick(a.options,["autoStart","simulateInstall"])),e.appId=a.appData.instanceId,e.clusterId=a.appData.selectedCluster.instanceId}),_.forEach(c,function(a){var c=a.taskType;_.forEach(a.options,function(b,c){a[c]=b}),delete a.taskType,delete a.options,delete a.items,b.params.steps.push({taskType:c,params:a})})}}),e=_.filter(e,function(a){return a.params.steps.length}),e.length?(a.deploying=!0,void j.batchDeploy({name:d,type:c,strategy:{name:a.deployForm.mode},taskList:e}).then(function(a){g.success("发布已提交！"),b.go("task.batchDeploy",{event_id:a.taskId})}).catch(function(b){a.deploying=!1,f(b,"发布")})):void h.alert({type:"warning",message:"没有任何需要发布的实例"})}var s=i.getNamespaceByCmdbObjectId("APP"),t=new i(s,"instanceId");_.forEach(k,function(a){t.push({instanceId:a.instanceId})});var u=["preStop","forceUpdate","postRestart","autoStart","simulateInstall"];a.deployModeList=[{value:"parallel",text:"并行"}],a.deployGrayscaleList=[{value:"all",text:"全部"}],a.collapseStatus={aboutPreDeploy:!0},a.deployForm={name:"多应用部署: "+k[0].name+"等"+k.length+"个应用",mode:a.deployModeList[0].value,grayscale:a.deployGrayscaleList[0].value};var v=a.deployForm.name;a.settings={showUnchangedPackages:!1},a.settingsChange=o,a.appList=k,a.clusterNameList=_.chain(k).map("clusters").compact().flatten().map("name").uniq().value();var w=[{value:"latest",key:"$latest",text:"最新版本"},{value:"largest",key:"$largest",text:"最大版本"},{value:"specified",text:"指定版本"}];a.getTargetVersionDisplay=function(a){var b=_.find(w,{key:a.targetVersion});return b?b.text:"指定版本"},a.getTargetVersionData=function(a){var b=m[a.packageId];if(!b||!b.length)return null;if("$latest"===a.targetVersion)return b[0];if("$largest"===a.targetVersion){var c=_.clone(b);return c.sort(function(a,b){return e.compareVersions(a.name,b.name)}),c[0]}return _.find(b,{name:a.targetVersion})},_.forEach(l,function(b){b.targetVersionData=a.getTargetVersionData(b)}),a.clusterChanged=function(){_.forEach(k,function(b){b.selectedCluster=_.find(b.clusters,{name:a.deployForm.cluster})});var b=_.filter(l,function(a){return!a.clusterData||a.clusterData===a.appData.selectedCluster});q(b),p()},a.clusterChanged(),a.showDeploySettings=function(b){var d=a.$new(!0);b?(d.pkg=b,d.isPackage=!b.clusterData,d.isConfigPkg=!!b.clusterData,d.clusterData=b.clusterData):(d.isBatch=!0,d.isPackage=!0,d.isConfigPkg=!1,d.pkg=_.pick(a.packageList[0],_.concat(u,["targetVersion"]))),d.targetVersionList=w,d.temporary=!0;var e=c.open({templateUrl:"views/apps/app/_deploy-settings.html",backdrop:"static",scope:d,controller:"AppDeploySettingsCtrl",resolve:{versionList:function(){return b?m[b.packageId]:_.chain(m).values().flatten().map("name").uniq().map(function(a){return{name:a}}).value()}}});e.result.then(function(c){var d=b?[b]:a.packageList;_.forEach(d,function(b){_.assign(b,_.pick(c,_.concat(u,["targetVersion"]))),b.targetVersionData=a.getTargetVersionData(b)}),p()})},a.showDeployDetail=function(b){var d=a.$new(!0);d.pkg=b,d.options={showUnchangedList:!1},d.showUnchangedList=function(){d.options.showUnchangedList=!0},c.open({templateUrl:"views/apps/_deploy-detail.html",backdrop:"static",scope:d})},a.deploy=function(){r("batchDeploy")},a.preDeploy=function(){r("preDeploy")}}]).controller("AppsDeployTaskCtrl",["$scope","$uibModal","$timeout","$state","$stateParams","$q","handleAjaxError","toastr","Dialog","DeployService","Flows","taskData","CmdbResourceService","$aside",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){if(l.taskList&&l.taskList[0].taskInfo){var b=l.taskList[0].taskInfo.flowInputs.in_cluster_id;b&&m.fetchInstance("CLUSTER",b).then(function(b){a.bindCluster=b}).catch(function(c){switch(c.data.code){case 133116:case 130300:a.bindCluster={name:"集群已被删除",isntanceId:b,status:"deleted"};break;default:g(c)}})}else if(l.taskList&&!l.taskList[0].taskInfo){var c=l.targetConfig.targetId;k.fetchFlow(c).then(function(a){l.taskList[0].taskInfo={},l.taskList[0].taskInfo.stepList=_.map(a.stepList,function(a){return a.status="wait",a})}).catch(g)}}function p(b,c){var e=_.find(a.taskData.taskList[0].taskInfo.stepList,function(a){return"failed"===a.status});e?(b&&b(),a.retrying=!0,k.retryStep(a.taskData.mainTaskId,e.stepId).then(function(){d.reload()}).catch(function(b){c&&c(),a.retrying=!1,g(b,"重试")})):i.alert({type:"warning",message:"没有失败的步骤！"})}function q(b){_.forEach(b.taskList,function(a){if(!a.taskInfo&&a.params.steps)return a.firstStageTaskStatusList=_.fill(Array(a.params.steps.length),"wait"),void(a.secondStageTaskStatus="unreachable");if(!a.firstStageTaskResults&&a.params.steps?a.firstStageTaskStatusList=_.fill(Array(a.params.steps.length),"failed"!==a.taskInfo.totalStatus?"wait":"failed"):a.params.steps&&a.firstStageTaskResults.length<a.params.steps.length&&(a.firstStageTaskStatusList=_.fill(Array(a.params.steps.length),"unreachable"),a.firstStageTaskStatusList[a.firstStageTaskResults.length]="failed"),a.secondStageTaskResults)a.secondStageTaskResults.length<a.params.steps.length&&(a.secondStageTaskStatus="unreachable");else{var b=a.taskInfo&&_.find(a.taskInfo.stepList,{stepId:y}),c=a.taskInfo&&_.find(a.taskInfo.stepList,{stepId:z});a.secondStageTaskStatus=a.taskInfo&&("paused"===a.taskInfo.totalStatus?"paused":b&&"success"!==b.status?"unreachable":c&&c.status?c.status:"unreachable")}}),a.taskData?(_.assign(a.taskData,_.pick(b,["endTime","status","usedTime"])),_.forEach(a.taskData.taskList,function(a,c){var d=b.taskList[c];_.merge(a,d),a.taskInfo&&"failed"!==a.taskInfo.totalStatus&&delete a.retriedDeploy})):a.taskData=b,_.some(a.taskData.taskList,function(a){return a.taskInfo&&"paused"===a.taskInfo.totalStatus})&&_.every(a.taskData.taskList,function(a){var b=_.find(a.taskInfo.stepList,{stepId:y});return a.taskInfo&&("paused"===a.taskInfo.totalStatus||"failed"===a.taskInfo.totalStatus||b&&("success"===b.status||"executing"===b.status))})?a.canContinueDeployAll=!0:a.canContinueDeployAll=!1;var c=!0;switch(a.taskData.status){case"ok":case"failed":c=!1;break;default:s()}if(a.executing=c,!c&&w&&w!==a.taskData.status)switch(a.taskData.status){case"ok":u?h.success("getCloudHost"===a.taskData.type?"购买成功":"退还成功"):h.success("发布成功");break;case"failed":u?h.error("getCloudHost"===a.taskData.type?"购买失败":"退还失败"):h.error("发布失败")}if(w=a.taskData.status,u&&a.taskData.taskList[0].taskInfo)if("getCloudHost"===a.taskData.type){var d=_.find(a.taskData.taskList[0].taskInfo.stepList,{stepId:1});try{a.hostInfo=JSON.parse(d.outputs.host_info)}catch(a){}a.getHostIps=function(){return _.map(a.hostInfo,"PrivateIpAddress").join(", ")},a.bindCluster||o()}else{try{a.hostInfo=JSON.parse(a.taskData.taskList[0].taskInfo.flowInputs.in_ips)}catch(a){}a.getHostIps=function(){return _.map(a.hostInfo,"ip").join(", ")}}}function r(){x&&(x.dismiss(),x=null);var a={};u&&(a.cloud_host=!0),j.getBatchDeployTask(A,a,{track:!1}).then(q).catch(function(a){x=g(a,"查询任务执行结果")})}function s(){v&&c.cancel(v),v=c(function(){v=null,r()},3e3)}function t(){v&&c.cancel(v),v=null,r()}var u=!1;d.is("task.cloudHost")&&(u=!0,o());var v,w,x,y=3,z=4,A=l.mainTaskId;if(a.deployModeMap={parallel:"并行",serial:"串行"},u){var B;a.showStepDetail=function(b){if("wait"!==b.status&&"executing"!==b.status){B&&B.dismiss();var c=a.$new();c.isCloudHostTask=!0,c.step=b,B=n.open({templateUrl:"views/flows/_task-step-detail.html",scope:c,backdrop:!1,windowClass:"no-backdrop",size:"lg",controller:"FLowsTaskStepDetailCtrl"})}},a.retryStep=function(a,b){i.confirm({type:"warning",message:"确定要从失败步骤开始重试吗？",resolved:function(){p(a,b)}})}}a.showDeployAppTask=function(c){if(!u){var d=a.$new();d.appTask=c,d.showStageError=function(){var a,b=c.firstStageTaskMsg;if(b){try{a={data:JSON.parse(b)}}catch(c){a={data:b}}g(a,"发布",{type:null,title:"文件预下发失败",message:null})}},b.open({templateUrl:"views/apps/_deploy-app-task.html",backdrop:"static",size:"xlg",scope:d})}},q(l),a.continuingDeployCount=0,a.continueDeploy=function(b){var c=_.find(b.taskInfo.stepList,{status:"paused"});return c?(b.continuingDeploy=!0,a.continuingDeployCount+=1,void k.continueExecute(b.taskId,c.stepId).then(function(){b.continuedDeploy=!0,a.continuingDeployCount-=1,t()}).catch(function(c){b.continuingDeploy=!1,a.continuingDeployCount-=1,g(c,"执行发布")})):void i.alert({type:"warning",message:"没有找到暂停的步骤！"})},a.continueDeployAll=function(){a.continuingDeployAll=!0,f.all(_.map(a.taskData.taskList,function(a){var b=f.defer(),c=_.find(a.taskInfo.stepList,{status:"paused"});return c?k.continueExecute(a.taskId,c.stepId).then(function(){b.resolve(null)}).catch(function(a){b.resolve(a)}):b.resolve(null),b.promise})).then(function(b){a.continuingDeployAll=!1,a.continuedDeployAll=!0,_.some(b,function(a){return null!==a&&(g(a,"执行发布"),d.reload(),!0)}),t()})},a.retryDeploy=function(a){var b=_.find(a.taskInfo.stepList,{status:"failed"});return b?(a.retryingDeploy=!0,void k.retryStep(a.taskId,b.stepId).then(function(){a.retryingDeploy=!1,a.retriedDeploy=!0,t()}).catch(function(b){a.retryingDeploy=!1,g(b,"重试")})):void i.alert({type:"warning",message:"没有找到暂停的步骤！"})},a.$on("$destroy",function(){v&&c.cancel(v)})}]),angular.module("apps.services",[]).factory("AppService",["RequestWrapper",function(a){return{fetchAppList:function(b){return a.array({method:"GET",url:"/api/app",params:b})},fetchApp:function(b,c){return a.object({method:"GET",url:"/api/app/"+b,params:c})},storeApp:function(b){return a.object({method:"POST",url:"/api/app",data:b})},updateApp:function(b,c){return a.object({method:"PUT",url:"/api/app/"+b,data:c})},removeApp:function(b){return a.object({method:"DELETE",url:"/api/app/"+b})},bindPackage:function(b,c){return a.object({method:"POST",url:"/api/app/"+b+"/package",data:c})},updateBindingPackage:function(b,c,d){return a.object({method:"PUT",url:"/api/app/"+b+"/package/"+c,data:d})},updateBindingPackageOrder:function(b,c){return a.object({method:"PUT",url:"/api/app/"+b+"/packages/order",data:c})},unbindPackage:function(b,c,d){return a.object({method:"DELETE",url:"/api/app/"+b+"/package/"+c,params:{installPath:d}})},pipelineExists:function(b){return a.object({method:"GET",url:"/api/app/"+b+"/pipeline/exists"})},fetchPipelineTemplate:function(b,c){return a.object({method:"GET",url:"/api/app/"+b+"/pipeline/template",params:c})},storePipeline:function(b,c){return a.object({method:"POST",url:"/api/app/"+b+"/pipeline",data:c})},removePipeline:function(b,c){return a.object({method:"DELETE",url:"/api/app/"+b+"/pipeline/"+c})}}}]).factory("ClusterService",["RequestWrapper",function(a){function b(a){return"/api/cluster"+(a?"/"+a:"")}return{getUrl:b,storeCluster:function(c){return a.object({method:"POST",url:b(),data:c})},updateCluster:function(c,d){return a.object({method:"PUT",url:b(c),data:d})},removeCluster:function(c){return a.object({method:"DELETE",url:b(c)})},importDevices:function(c,d){return a.object({method:"POST",url:b(c)+"/devices",data:d})},removeDevices:function(c,d){return a.object({method:"DELETE",url:b(c)+"/devices",headers:{"Content-Type":"application/json; charset=utf-8"},data:d})},bindConfigPkg:function(c,d){return a.object({method:"POST",url:b(c)+"/package",data:d})},updateBindingConfigPkg:function(b,c,d){return a.object({method:"PUT",url:"/api/cluster/"+b+"/package/"+c,data:d})},unbindConfigPkg:function(c,d,e){return a.object({method:"DELETE",url:b(c)+"/package/"+d,params:{installPath:e}})}}}]),angular.module("apps.filters",["qgz.clusterType"]).filter("clusterBadgeClass",function(){var a=[null,"badge-warning","badge-primary"];return function(b){return a[+b.type]||null}}).filter("clusterBadgeName",function(){var a=["D","T","P"];return function(b){return a[+b.type]||null}}).filter("clusterTypeName",["clusterTypeConverter",function(a){return function(b){return a.id2label(b.type)||null}}]).filter("clusterTypeId2Label",["clusterTypeConverter",function(a){return function(b){return a.id2label(b)||null}}]).filter("fileTypeIcon",function(){var a={dir:"glyphicon glyphicon-folder-close",link:"fa fa-link"},b="fa fa-file-text-o";return function(c){return a[c.type]||b}}).filter("shortId",function(){return function(a){return(a||"").substr(0,7)}}),angular.module("packages.services",["url.matcher"]).factory("PackageService",["RequestWrapper",function(a){function b(a){return"/api/package/"+a}return{fetchPackageList:function(){return a.array({url:"/api/package"})},fetchPackage:function(c){return a.object({method:"GET",url:b(c)})},storePackage:function(b){return a.object({method:"POST",url:"/api/package",data:b})},updatePackage:function(b,c){return a.object({method:"PUT",url:"/api/package/"+b,data:c})},removePackage:function(b){return a.object({method:"DELETE",url:"/api/package/"+b})},initWorkspace:function(c){return a.object({method:"PUT",url:b(c)+"/init/workspace"})},initVersion:function(c,d){return a.object({method:"PUT",url:b(c)+"/init/"+d})},fetchVersionList:function(c,d){return a.object({method:"GET",url:b(c)+"/version",params:d})},fetchVersionListOfPackages:function(b){return a.object({method:"POST",url:"/api/package/get-versions",data:b})},fetchVersionListAll:function(c){return a.array({method:"GET",url:b(c)+"/version",params:{all:1}})},fetchTagList:function(c){return a.array({method:"GET",url:b(c)+"/tag"})},fetchLatestVersion:function(c){return a.object({method:"GET",url:b(c)+"/latest/version"})},fetchVersion:function(c,d){return a.object({method:"GET",url:b(c)+"/version/"+d})},storeVersion:function(c,d){return a.object({method:"POST",url:b(c)+"/version",data:d})},updateVersion:function(c,d,e){return a.object({method:"PUT",url:b(c)+"/version/"+d,data:e})},removeVersion:function(c,d){return a.object({method:"DELETE",url:b(c)+"/version/"+d})},fetchWorkspaceStatus:function(c){return a.array({method:"GET",url:b(c)+"/status/workspace"})},getService:function(c,d){return a.object({method:"GET",url:b(c)+"/service/"+d})},storeService:function(c,d){return a.object({method:"POST",url:b(c)+"/service/workspace",data:d})},fetchInstanceList:function(c){return a.array({method:"GET",url:b(c)+"/instances"})},fetchInstanceListOfPackages:function(b){return a.object({method:"POST",url:"/api/package/get-instances",data:b})},removeInstances:function(c,d){return a.object({method:"DELETE",url:b(c)+"/instances",params:{instanceIds:d.join(",")}})},getDiff:function(c,d,e,f){var g=[b(c),"diff",d+"..."+e];return f?g.push(f):g.push(""),a.array({method:"GET",url:g.join("/")})}}}]).factory("PackageFileService",["RequestWrapper","encodePathURI",function(a,b){function c(a,c,d,e){return"/api/package/"+a+"/"+c+"/"+(d||"workspace")+"/"+b(e)}return{getUrl:c,tree:function(b,d,e){return a.array({method:"GET",url:c(b,"tree",d,e)})},blob:function(b,d,e){return a.object({method:"GET",url:c(b,"blob",d,e)})},rm:function(b,d){return a.object({method:"DELETE",url:c(b,"blob",null,d)})},mkdir:function(b,d){return a.object({method:"POST",url:c(b,"tree",null,d)})},rmdir:function(b,d){return a.object({method:"DELETE",url:c(b,"tree",null,d)})},batch:function(b,d,e){return a.object({method:"POST",url:c(d,"batch",null),params:{_method:b},data:e})},revert:function(b,d){return a.object({method:"POST",url:c(b,"revert",null,d)})},updateBlob:function(b,d,e){return a.object({method:"PUT",url:c(b,"blob",null,d),data:e})},storeBlob:function(b,d,e){return a.object({method:"POST",url:c(b,"blob",null,d),data:e})},setExecutable:function(b,d,e){return a.object({method:"PUT",url:c(b,"attr",null,d),data:{executable:e}})}}}]).factory("DeployService",["$http","RequestWrapper",function(a,b){return{getApps:function(a){return b.array({method:"POST",url:"/api/deploy/get-apps",data:a})},install:function(a){return b.object({method:"POST",url:"/api/deploy/install",data:a})},update:function(a){return b.object({method:"POST",url:"/api/deploy/update",data:a})},maintain:function(a){return b.object({method:"POST",url:"/api/deploy/maintain",data:a})},deploy:function(a){return b.object({method:"POST",url:"/api/deploy",data:a})},getDeployStatus:function(a){return b.object({method:"GET",url:"/api/deploy/status/"+a},{track:!1})},batchDeploy:function(a){return b.object({method:"POST",url:"/api/deploy/batch",data:a})},getBatchDeployTask:function(a,c,d){return b.object({method:"GET",url:"/api/deploy/batch/task/"+a,params:c},d)},createDeployTask:function(a){return b.object({method:"POST",url:"/api/deployTask/create",data:a})},getDeployTask:function(a,c){return b.object({method:"GET",url:"/api/deployTask/"+a},c)}}}]),angular.module("packages",["packages.services","packages.create","packages.package"]).config(["$stateProvider",function(a){a.state("packages",{url:"/package",abstract:!0,templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl"}).state("packages.index",{url:"?q&page",params:{q:{dynamic:!0,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0}},templateUrl:"views/packages/graphs.html",controller:"PackageListCtrl",resolve:{packageList:["PackageService",function(a){return a.fetchPackageList()}]}})}]).controller("PackageListCtrl",["$scope","$state","$stateParams","$localStorage","Utils","VisitHistory","checkPermission","USERNAME","packageList",function(a,b,c,d,e,f,g,h,i){function j(){var b=o.order,c=_.find(a.headerList,{field:b});c||(b="_$visitedAt",c=_.find(a.headerList,{field:b}));var d=[c.path||"_$lowerCaseAttrs."+b],e=[o.by];d.push("isRelated","ctime"),e.push("desc","desc"),r=_.orderBy(r,d,e)}function k(a){var b={};return angular.forEach(a,function(a,c){b[c]=p[c]===a?null:a}),b}function l(c){var d,f=a.filters.page,g=a.itemsPerPage,h=(a.filters.q||"").toLowerCase();if(h){var i=h.split(/\s+/g);d=_.filter(r,function(a){return _.some(a._$lowerCaseAttrs,function(a){return _.some(i,function(b){return a.indexOf(b)!==-1})})})}else d=r;a.packageList=d.slice((f-1)*g,f*g),a.totalItems=d.length,a.searched=!!h,c||b.go(b.current.name,k(a.filters),{location:"replace"}),e.scrollToContentTop()}var m=b.includes("configPkgs");a.permissionOfCreate=g("packages.create"),a.headerList=[{field:"name",name:m?"配置包名称":"程序包名称"},{field:"latestVersion",name:"最新版本",defaultBy:"desc"},{field:"instanceCount",name:"实例",defaultBy:"desc",path:"instanceCount"},{field:"creator",name:"作者"},{field:"modifiedAt",name:"最近更新",defaultBy:"desc",path:"modifiedAt"},{field:"_$visitedAt",name:"最近访问",defaultBy:"desc",path:"_$visitedAt"}];var n="orderBy-"+(m?"config-pkgs":"packages"),o=a.sortData=_.defaults({},d[n],{order:"_$visitedAt",by:"desc"});a.sortBy=function(a){d[n]||(d[n]={}),a.field===o.order?o.by=d[n].by="desc"===o.by?"asc":"desc":(o.order=d[n].order=a.field,o.by=d[n].by=a.defaultBy||"asc"),j(),l()},a.getClassOfSortableIcon=function(a){var b=[];return(o.order===a.field?"desc"===o.by:"desc"===a.defaultBy)?b.push("fa-caret-down"):b.push("fa-caret-up"),o.order===a.field&&b.push("active"),b.join(" ")};var p={page:1},q=_.defaults({},c,p);a.filters=q;var r=i,s=new f(m?"config-pkgs":"packages","packageId"),t=s.all(),u={};_.forEach(t,function(a){u[a.packageId]=+moment(a.visitedAt)}),_.forEach(r,function(a){var b={};b.name=a.name.toLowerCase(),b.creator=a.creator.toLowerCase(),b.latestVersion=(a.lastVersionInfo&&a.lastVersionInfo.name||"").toLowerCase(),a._$lowerCaseAttrs=b,a.instanceCount=+a.instanceCount,a._$visitedAt=u[a.packageId]||0,a.modifiedAt=a.mtime||a.ctime,a.lastVersionInfo&&a.lastVersionInfo.ctime>a.modifiedAt&&(a.modifiedAt=a.lastVersionInfo.ctime),a.isRelated=a.creator===h}),j(),a.itemsPerPage=15,a.search=function(){a.filters.page=1,l()},a.pageChange=l,l(!0)}]),angular.module("packages.directives",[]).directive("packageDiff",["$state","depends",function(a,b){return{restrict:"EA",scope:{diffList:"=",tagFromData:"=",tagToData:"="},link:function(c,d){b(["components/package-diff"]).then(function(){window.ReactDOM.render(window.React.createElement(window.PackageDiff,{diffList:c.diffList,tagFromData:c.tagFromData,tagToData:c.tagToData,$state:a
}),d[0])}).catch(function(a){d.html("加载组件失败！")})}}}]),angular.module("packages.create",["packages.services","apps.services"]).config(["$stateProvider",function(a){a.state("packages.create",{url:"/create?appId",templateUrl:"views/packages/create.html",controller:"PackageCreateCtrl",resolve:{packageData:function(){return null},appData:["$stateParams","AppService",function(a,b){return a.appId?b.fetchApp(a.appId):null}]}})}]).controller("PackageCreateCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","PackageService","packageData","appData",function(a,b,c,d,e,f,g,h){function i(b){b.data&&100307===b.data.code?d.alert({type:"error",message:"创建程序包失败，已存在同名的程序包！",callback:function(){var a=$('form[name=formCreatePackage] input[ng-model="packageForm.name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):e(b,"创建程序包"),a.storing=!1}a.isEdit=!!g,a.appData=h,a.isEdit?a.packageForm=_.pick(g,"name","memo","installPath","platform"):a.packageForm={},_.defaults(a.packageForm,{platform:"linux"}),a.store=function(){if(a.formCreatePackage.$invalid){var e=$("form[name=formCreatePackage] .ng-invalid"),j=e.closest(".form-group");return void(j.length?j:e).scrollIntoViewInBody()}var k=_.pick(a.packageForm,"name","memo","installPath","platform");k.memo||(k.memo="无"),h&&(k.appId=h.instanceId),a.storing=!0,a.isEdit?f.updatePackage(g.packageId,k).then(function(a){c.success("程序包已保存！"),b.go("packages.package.index",a,{reload:!0})}).catch(i):f.storePackage(k).then(function(a){a._bindPackageFailed?d.alert({type:"warning",message:"程序包已创建！绑定到应用失败: "+a._bindPackageError,callback:function(){b.go("packages.package.index",a)}}):(c.success("程序包已创建！"),b.go("packages.package.index",a))}).catch(i)}}]),angular.module("packages.package",["packages.package.version.route","packages.package.version.ctrl","packages.services","packages.directives","url.matcher"]).config(["$stateProvider",function(a){a.state("packages.package",{url:"/{packageId:hashId}",abstract:!0,template:"<div ui-view></div>",controller:"PackageAbstractCtrl",resolve:{packageData:["PackageService","$stateParams",function(a,b){return a.fetchPackage(b.packageId)}]}}).state("packages.package.index",{url:"?page",templateUrl:"views/packages/package/graphs.html",controller:"PackageIndexCtrl",resolve:{versionData:["$stateParams","PackageService","packageData",function(a,b,c){return b.fetchVersionList(c.packageId,{page:a.page})}]}}).state("packages.package.edit",{url:"/edit",templateUrl:"views/packages/create.html",controller:"PackageCreateCtrl",resolve:{appData:function(){return null}}}).state("packages.package.instance",{url:"/instance",templateUrl:"views/packages/package/instance.html",controller:"PackageInstanceCtrl",resolve:{instanceList:["$stateParams","PackageService",function(a,b){return b.fetchInstanceList(a.packageId)}]}}).state("packages.package.create",{url:"/create",templateUrl:"views/packages/package/create.html",controller:"PackageCreateVersionCtrl",resolve:{init:["PackageService","packageData",function(a,b){return a.initWorkspace(b.packageId)}],statusData:["PackageService","init","packageData",function(a,b,c){return a.fetchWorkspaceStatus(c.packageId)}],baseVersion:["PackageService","init","packageData",function(a,b,c){return a.fetchLatestVersion(c.packageId)}],existingVersionData:["PackageService","packageData",function(a,b){return a.fetchVersionListAll(b.packageId)}]}}).state("packages.package.diff",{url:"/diff/{path:pathURI}",templateUrl:"views/packages/package/diff.html",controller:"PackageCompareCtrl",resolve:{tagFromData:function(){return{versionId:null,name:"基础版本"}},tagToData:function(){return{versionId:"workspace",name:"工作区"}},diffList:["$stateParams","PackageService","packageData",function(a,b,c){return b.getDiff(c.packageId,"base","workingcopy",a.path)}],versionList:function(){return null}}}).state("packages.package.compare",{url:"/compare/{tagFrom:\\w+}...{tagTo:\\w+}",templateUrl:"views/packages/package/compare.html",controller:"PackageCompareCtrl",resolve:{tagFromData:["$stateParams","PackageService","packageData",function(a,b,c){return b.fetchVersion(c.packageId,a.tagFrom).then(function(a){return{versionId:a.versionId,name:a.name}})}],tagToData:["$stateParams","PackageService","packageData",function(a,b,c){return b.fetchVersion(c.packageId,a.tagTo).then(function(a){return{versionId:a.versionId,name:a.name}})}],diffList:["$stateParams","PackageService","packageData",function(a,b,c){return b.getDiff(c.packageId,a.tagFrom,a.tagTo)}],versionList:["PackageService","packageData",function(a,b){return a.fetchVersionListAll(b.packageId)}]}})}]).controller("PackageAbstractCtrl",["$scope","$state","VisitHistory","checkPermission","packageData",function(a,b,c,d,e){a.packageData=e;var f={linux:"Linux",windows:"Windows",others:"其它"};e.platformName=f[e.platform||"linux"];var g=new c("packages","packageId");g.push(_.pick(e,"packageId")),a.filesActive=function(){return b.includes("packages.package.version.tree")||b.includes("packages.package.version.blob")||b.includes("packages.package.version.edit")||b.includes("packages.package.version.new")},a.getHrefOfTree=function(a,c,d){return b.href("packages.package.version.tree",{tag:a,path:c?c.slice(0,d+1).join("/"):""})},a.goCreate=function(){b.go("packages.package.version.create")},a.isWorkspace=function(a){return"workspace"===a},a.permissionOfEdit=d("packages.package.edit"),a.permissionOfRemove=d("packages.package.remove"),a.permissionOfVersionCreate=d("packages.package.versions.create"),a.permissionOfVersionEdit=d("packages.package.versions.version.edit"),a.permissionOfVersionRemove=d("packages.package.versions.version.remove")}]).controller("PackageIndexCtrl",["$scope","$state","$stateParams","Dialog","Utils","PackageService","toastr","handleAjaxError","packageData","versionData",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b={};return angular.forEach(a,function(a,c){b[c]=o[c]===a?null:a}),b}function l(a,b){a.updating=!0,f.updateVersion(i.packageId,a.versionId,{memo:b}).then(function(){g.success("版本备注已修改!"),a.memo=b}).catch(function(a){h(a,"修改版本备注")}).finally(function(){a.updating=!1})}function m(a){a.removing=!0,f.removeVersion(i.packageId,a.versionId).then(function(){g.success("版本已删除!"),b.reload()}).catch(function(b){h(b,"删除包版本"),a.removing=!1})}function n(){a.removing=!0,f.removePackage(i.packageId).then(function(){g.success("包已删除！"),b.go("^.^.index")}).catch(function(b){h(b,"删除包"),a.removing=!1})}j&&(a.versionList=j.list,a.totalItems=j.total,a.itemsPerPage=j.page_size),a.removable=!(j&&j.total);var o={page:1},p=_.defaults({},c,o);a.filters=p,j&&_.forEach(a.versionList,function(a,b){a.canRemove=!(1===p.page&&0===b&&j.total>1)}),a.pageChange=function(){b.go(b.current.name,k(p))},a.editVersionMemo=function(a){d.prompt({title:"修改版本备注",message:"请给版本 <code>"+e.escapeHtml(a.name)+"</code> 输入新的版本备注:",html:!0,value:a.memo,pattern:/^[\s\S]{1,255}$/,invalidTips:"请输入 1 到 255 个字符",textarea:!0,resolved:function(b){l(a,b)}})},a.removeVersion=function(a){d.confirm({message:"确定要删除版本 "+a.name+" 吗？",isDelete:!0,resolved:function(){m(a)}})},a.removePackage=function(){d.confirm({message:"确实要删除包 <code>"+_.escape(i.name)+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){n()}})}}]).controller("PackageInstanceCtrl",["$scope","$state","instanceList",function(a,b,c){a.PackageinstanceList=c}]).controller("PackageCreateVersionCtrl",["$scope","$state","PackageService","BackgroundJobManager","handleAjaxError","Dialog","Utils","packageData","statusData","baseVersion","existingVersionData",function(a,b,c,d,e,f,g,h,i,j,k){var l={},m="workspace",n=_.map(k,"name");a.tag=m,a.versionData=l,a.diffList=i,a.baseVersion=j;var o=30,p=5;a.diffOverflow=0,a.diffList.length>o+p&&(a.diffList=_.slice(i,0,o),a.diffOverflow=i.length-o),l.name=g.nextVersion(j.name),a.errorHint=function(b,c){_.includes(n,a.versionData.name)&&b[c].$setValidity("repeat",!1)},a.removeErrorHint=function(a,b,c){a[b].$setValidity(c,!0)};var q=new d(a);a.store=function(){if(!a.formCreatePackageVersion.$invalid){a.storing=!0;var d=q.start("正在创建版本");c.storeVersion(h.packageId,_.pick(l,"name","memo")).then(function(){d.end("版本已创建"),b.go("^.index")}).catch(function(b){d.close(),a.storing=!1,b.data&&100307===b.data.code?f.alert({type:"error",message:"生成包版本失败，版本名称重复，请修改！",callback:function(){var a=$('form[name=formCreatePackageVersion] input[ng-model="versionData.name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):e(b,"生成包版本")})}}}]).controller("PackageCompareCtrl",["$scope","$state","diffList","tagFromData","tagToData","versionList",function(a,b,c,d,e,f){a.tagFromData=d,a.tagToData=e,a.versionList=f,a.compareForm={tagFrom:d.versionId,tagTo:e.versionId},a.versionChange=function(){a.stateChanging=!0,b.go(b.current.name,a.compareForm)},a.diffList=c,a.getHrefOfBlob=function(a,c){return b.href("^.version.blob",{tag:a,path:c})}}]),angular.module("packages.package.version.route",["url.matcher"]).config(["$stateProvider",function(a){var b="{tag:workspace|\\w+}",c="{path:pathURI}",d={editorDeps:["depends",function(a){return a("components/editor")}],init:["$stateParams","PackageService","packageData",function(a,b,c){var d=a.tag;return d&&"workspace"!==d?null:b.initWorkspace(c.packageId)}],path:["$stateParams",function(a){var b=(a.path||"").replace(/^\/+|\/+$/g,"").replace(/\/{2,}/g,"");return b}],filePath:["$stateParams",function(a){var b=(a.path||"").replace(/^\/+|\/+$/g,"").replace(/\/{2,}/g,"/");if(!b)throw new Error("empty file path");return b}],pathList:["path",function(a){return a?a.split("/"):[]}],dirList:["path",function(a){var b=a.split("/");return 1===b.length?[]:b.slice(0,-1)}],fileData:["PackageFileService","init","packageData","tagData","path",function(a,b,c,d,e){var f=_.last(e.split("/"));if(!f)throw new Error("empty file name");return a.blob(c.packageId,d.versionId,e)}],tagData:["$stateParams","PackageService","packageData",function(a,b,c){var d=a.tag;return d&&"workspace"!==d?b.fetchVersion(c.packageId,d).then(function(a){return{versionId:a.versionId,name:a.name}}):{versionId:"workspace",name:"新版本"}}]};a.state("packages.package.version",{url:"/version/"+b,abstract:!0,templateUrl:"views/packages/package/_version.html",controller:"PackageVersionAbstractCtrl",resolve:{init:d.init,tagData:d.tagData}}).state("packages.package.version.tree",{url:"/tree/"+c,templateUrl:"views/packages/package/tree.html",controller:"PackageTreeCtrl",resolve:{path:d.path,dirList:d.pathList,fileList:["$stateParams","path","PackageFileService","init","packageData",function(a,b,c,d,e){return c.tree(e.packageId,a.tag,b)}]}}).state("packages.package.version.blob",{url:"/blob/"+c,templateUrl:"views/packages/package/blob.html",controller:"PackageBlobCtrl",resolve:{path:d.filePath,dirList:d.dirList,fileData:d.fileData,deps:d.editorDeps}}).state("packages.package.version.edit",{url:"/edit/"+c,templateUrl:"views/packages/package/edit.html",controller:"PackageEditCtrl",resolve:{path:d.filePath,dirList:d.dirList,fileData:d.fileData,deps:d.editorDeps}}).state("packages.package.version.new",{url:"/new/"+c,templateUrl:"views/packages/package/edit.html",controller:"PackageNewCtrl",resolve:{path:d.path,dirList:d.pathList,deps:d.editorDeps}}).state("packages.package.version.service",{abstract:!0,url:"/service",templateUrl:"views/packages/package/service.html",resolve:{serviceData:["tagData","PackageService","init","packageData",function(a,b,c,d){return b.getService(d.packageId,a.versionId)}],deps:d.editorDeps}}).state("packages.package.version.service.process",{url:"/process",templateUrl:"views/packages/package/service-process.html",controller:"PackageServiceProcessCtrl"}).state("packages.package.version.service.install",{url:"/install",templateUrl:"views/packages/package/service-install.html",controller:"PackageServiceInstallCtrl"}).state("packages.package.version.advanced",{url:"/advanced",templateUrl:"views/packages/package/advanced.html",controller:"PackageAdvancedCtrl",resolve:{statusData:["tagData","PackageService","init","packageData",function(a,b,c,d){return"workspace"!==a.versionId?null:b.fetchWorkspaceStatus(d.packageId)}],baseVersion:["PackageService","packageData",function(a,b){return a.fetchLatestVersion(b.packageId)}]}})}]),angular.module("packages.package.version.ctrl",[]).controller("PackageVersionAbstractCtrl",["$scope","$state","tagData",function(a,b,c){a.tagData=c,a.tag=c.versionId,a.getHrefOfTree=function(a,c,d){return b.href("^.tree",{tag:a,path:c?c.slice(0,d+1).join("/"):""})},a.atWorkspace="workspace"===c.versionId,a.pacakgeViewPath="views/packages/package",a.getHrefOfPackageChildState=function(a){return b.href("packages.package."+a)}}]).controller("PackageTagListCtrl",["$scope","$state","PackageService","handleAjaxError",function(a,b,c,d){var e=a.$eval("packageData");a.tagLoaded=!1,a.tagLoading=!1,a.tagToggled=function(b){!b||a.tagLoading||a.tagLoaded||(a.tagLoading=!0,c.fetchTagList(e.packageId).then(function(b){a.tagList=b,a.tagLoaded=!0}).catch(function(a){d(a,"查询版本列表")}).finally(function(){a.tagLoading=!1}))},a.getHrefOfTag=function(a){return b.href(b.current.name,{tag:a})}}]).controller("PackageTreeCtrl",["$scope","$state","$uibModal","PackageFileService","handleAjaxError","Utils","Dialog","toastr","packageData","tagData","path","dirList","fileList",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(c){return c=f.trimFilepath(c),f.validate(c,"filename")?(a.mkdirring=!0,void d.mkdir(i.packageId,l.concat(c).join("/")).then(function(){h.success("新建目录成功"),b.reload()}).catch(function(a){e(a,"新建目录")}).finally(function(){a.mkdirring=!1})):void g.alert({message:"目录名中不能包含 `/`，且不能超过 255 个字符",type:"warning"})}function o(){a.rmdiring=!0,d.rmdir(i.packageId,k).then(function(){h.success("目录已删除"),b.go("^.tree",{tag:p,path:l.slice(0,-1).join("/")},{reload:!k})}).catch(function(a){e(a,"删除目录")}).finally(function(){a.rmdiring=!1})}var p=j.versionId;a.path=k,a.dirList=l,a.fileList=m,angular.forEach(m,function(a){var b=a.name.split("/");a.filename=b.pop(),a.dirname=b.join("/"),b.length&&(a.dirname+="/")}),a.getHrefOfTreeOrBlob=function(a){return b.href("^."+("dir"===a.type?"tree":"blob"),{tag:p,path:k+(k&&"/")+a.name})},a.goEdit=function(a){b.go("^.edit",{tag:"workspace",path:k+(k&&"/")+a.name})},a.mkdir=function(){g.prompt({title:"新建目录",message:"请输入目录名：",resolved:n})},a.rmdir=function(){var a;a=l.length?"确定删除目录 "+_.last(l)+" 吗？":"确定要删除这个包的全部文件吗？",g.confirm({message:a,isDelete:!0,resolved:o})};var q=d.getUrl(i.packageId,"upload",null,k);a.upload=function(){var b=a.$new(!0);c.open({templateUrl:"views/packages/package/_upload.html",backdrop:"static",controller:"PackageFileUploadCtrl",scope:b,resolve:{uploadUrl:function(){return q}}})},a.$on("upload succeed",function(){b.reload()})}]).controller("PackageFileUploadCtrl",["$scope","$uibModalInstance","$timeout","$window","Upload","toastr","Dialog","DEPLOY_UPLOAD_MAX_SIZE","uploadUrl",function(a,b,c,d,e,f,g,h,i){function j(a){a._customProgress<99&&(a._customProgress+=1),a._isUploading&&c(function(){j(a)},a._uploadTime/50*1.25)}function k(){return window.performance&&window.performance.now?window.performance.now():+moment()}function l(a){a.preventDefault()}a.uploadMaxSizeText=h.text;var m=a.uploadData={attachments:[],unzip:!0,stripFirst:!1};a.drop=function(a){a&&a.length&&m.attachments.push.apply(m.attachments,a)},a.$watch("invalidFiles",function(a){if(a&&a.length){var b=_.map(a,"name").join(", ");g.alert({type:"warning",message:b+" 这 "+a.length+" 个文件的大小超过限制"})}}),a.cancelOne=function(a){a._isUploading&&a._uploader&&a._uploader.abort(),m.attachments=_.filter(m.attachments,function(b){return b!==a})},a.cancelAll=function(){_.forEach(m.attachments,function(a){a._isUploading&&a._uploader&&a._uploader.abort()}),m.attachments=[],b.dismiss()},a.cannotUpload=function(){var a=_.filter(m.attachments,function(a){return!a._isUploading&&!a._isSuccess});return!a.length},a.uploadConfirm=function(){function d(){h-=1,0===h&&_.every(g,"_isSuccess")&&(f.success("文件已上传"),c(function(){a.$emit("upload succeed"),b.dismiss()},1e3))}var g=_.filter(m.attachments,function(a){return!a._isUploading&&!a._isSuccess}),h=g.length;_.forEach(g,function(a){a._isUploading=!0,a._progress=0,delete a._uploader,delete a._isSuccess,delete a._isError,delete a._errorMessage,delete a._uploadedAt,delete a._uploadTime,delete a._customProgress;var b=a._uploader=e.upload({url:i,data:{attachment:a,unzip:m.unzip,stripFirst:m.stripFirst}});b.then(function(){a._isSuccess=!0,a._isUploading=!1,a._progress=100,d()},function(b){a._isError=!0,a._isUploading=!1;var c=b.data;413===b.status?a._errorMessage="文件大小超过限制":a._errorMessage=c?c.message||c.error||"未知错误":b.statusText,d()},function(b){a._progress=Math.min(100,+(100*b.loaded/b.total))})})},a.getProgress=function(a){return a._isUploading?(100===a._progress?a._uploadedAt||(a._uploadedAt=k(),a._uploadTime=a._uploadedAt-a._startedAt,a._customProgress=50,j(a)):a._customProgress=Math.round(a._progress/2),(a._customProgress||0)+"%"):(a._progress||"")+(a._progress?"%":"")},$(d).on("dragover drop",l),a.$on("$destroy",function(){$(d).off("dragover drop",l),_.forEach(m.attachments,function(a){a._isUploading&&a._uploader&&a._uploader.abort()})})}]).controller("PackageBlobCtrl",["$scope","$state","PackageFileService","handleAjaxError","Dialog","toastr","packageData","tagData","path","dirList","fileData",function(a,b,c,d,e,f,g,h,i,j,k){function l(){a.rming=!0,c.rm(g.packageId,i).then(function(){f.success("文件已删除"),b.go("^.tree",{tag:m,path:j.join("/")})}).catch(function(a){d(a,"删除文件")}).finally(function(){a.rming=!1})}var m=h.versionId;a.path=i,a.dirList=j,a.file=angular.copy(k);var n=CodeMirror.findModeByFileName(k.name),o=null;n&&(o=n.mode);var p={lineWrapping:!0,lineNumbers:!0,viewportMargin:1/0,mode:o,readOnly:!0};a.options=p,a.cmLoaded=function(a){CodeMirror.autoLoadMode(a,o)},a.rm=function(){e.confirm({message:"确定删除文件 "+k.name+" 吗？",isDelete:!0,resolved:l})},a.getHrefOfRaw=function(){return c.getUrl(g.packageId,"raw",m,i)};var q;a.setExecutable=function(b){q=a.file.executable,a.file.executable=b,c.setExecutable(g.packageId,i,b).then(function(){f.success("文件已设置为"+(b?"":"不")+"可执行")}).catch(function(b){void 0!==q&&(a.file.executable=q),d(b,"设置文件可执行权限")})}}]).controller("PackageEditCtrl",["$scope","$state","beforeLeave","toastr","PackageFileService","handleAjaxError","Dialog","Utils","packageData","tagData","path","dirList","fileData",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=j.versionId;a.path=k,a.dirList=l,a.file=angular.copy(m),a.isEdit=!0;var o=CodeMirror.findModeByFileName(m.name),p=null;o&&(p=o.mode);var q={lineWrapping:!0,lineNumbers:!0,autofocus:!0,mode:p};a.options=q,a.cmLoaded=function(a){CodeMirror.autoLoadMode(a,p)};var r=c(this,function(){return a.file.content!==m.content});a.valid=function(){return h.validate(a.file.name,"filename")},a.saveBlob=function(){if(!a.valid())return void g.alert({message:"请输入有效的文件名",type:"warning"});var c=!1,h={};if(a.file.name!==m.name&&(c=!0,h.name=a.file.name),a.file.content!==m.content&&(c=!0,h.content=a.file.content,h.charset=m.charset),!c)return void g.alert({message:"没有任何变更！",type:"warning"});a.saving=!0;var j=l.concat(a.file.name).join("/");e.updateBlob(i.packageId,k,h).then(function(){d.success("保存文件成功！"),r(),b.go("^.tree",{tag:n,path:j.split("/").slice(0,-1).join("/")})}).catch(function(b){f(b,"保存文件"),a.saving=!1})}}]).controller("PackageNewCtrl",["$scope","$state","beforeLeave","Dialog","toastr","PackageFileService","handleAjaxError","Utils","packageData","tagData","path","dirList",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=j.versionId;a.path=k,a.dirList=l,a.file={text:!0},a.isCreate=!0;var n={lineWrapping:!0,lineNumbers:!0,mode:null};a.options=n;var o=c(this,function(){return a.file.content});a.valid=function(){return h.validate(a.file.name,"filename")},a.saveBlob=function(){if(!a.valid())return void d.alert({message:"请输入有效的文件路径",type:"warning"});var c=a.file.name,h={content:a.file.content};a.saving=!0;var j=l.concat(c).join("/");f.storeBlob(i.packageId,j,h).then(function(){e.success("保存文件成功！"),o(),b.go("^.tree",{tag:m,path:j.split("/").slice(0,-1).join("/")})}).catch(function(b){g(b,"保存文件"),a.saving=!1})}}]).controller("PackageServiceProcessCtrl",["$scope","$state","$element","$q","Dialog","PackageService","handleAjaxError","toastr","packageData","tagData","serviceData",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b,c){e.alert({type:"warning",message:b||t[a],callback:function(){var b=s[a];b&&b.focus().select(),c&&c()}})}var m=j.versionId;a.guardList=[{text:"无",value:"none"},{text:"停止后启动",value:"stopStart"}];var n=_.pick(angular.copy(k),"proc_list","port_list","proc_guard","port_guard","start_script","stop_script","monitor_script","user");a.serviceData=angular.copy(n);var o="shell",p=[],q={lineWrapping:!0,lineNumbers:!0,viewportMargin:1/0,mode:o,readOnly:"workspace"!==m};a.options=q,a.cmLoaded=function(a){p.push(a),CodeMirror.autoLoadMode(a,o)};var r,s={user:c.find('input[name="user"]'),proc:c.find('tags-input[ng-model="serviceData.proc_list"]'),port:c.find('tags-input[ng-model="serviceData.port_list"]')},t={user:"请输入运行属主！",proc:"请输入有效的监控进程！",port:"请输入有效的监控端口！"};this.uiCanExit=function(c){if(!r&&"workspace"===m&&!angular.equals(a.serviceData,n)){var e=c.to(),h=c.params("to");if(0===e.name.indexOf("packages.package.version")||0===e.name.indexOf("configPkgs.configPkg.version")||"packages.package.create"===e.name||"configPkgs.configPkg.create"===e.name){var j=a.formService;if(j.$invalid)return _.some(s,function(a,b){return!(!j[b]||!j[b].$invalid)&&(l(b),!0)}),!1;var k=angular.copy(a.serviceData);a.storing=!0;var o=d.defer();return f.storeService(i.packageId,k).then(function(){r=!0,o.resolve(b.target(e.name,h,{reload:!0}))}).catch(function(b){g(b,"保存进程服务"),a.storing=!1,o.reject(b)}),o.promise}}}}]).controller("PackageServiceInstallCtrl",["$scope","$state","$q","PackageService","handleAjaxError","toastr","packageData","tagData","serviceData",function(a,b,c,d,e,f,g,h,i){var j=h.versionId,k=_.pick(angular.copy(i),"install_prescript","install_postscript","update_prescript","update_postscript","rollback_prescript","rollback_postscript");a.serviceData=angular.copy(k);var l="shell",m=[],n={lineWrapping:!0,lineNumbers:!0,viewportMargin:1/0,mode:l,readOnly:"workspace"!==j};a.options=n,a.cmLoaded=function(a){m.push(a),CodeMirror.autoLoadMode(a,l)};var o;this.uiCanExit=function(f){if(!o&&"workspace"===j&&!angular.equals(a.serviceData,k)){var h=f.to(),i=f.params("to");if(0===h.name.indexOf("packages.package.version")||0===h.name.indexOf("configPkgs.configPkg.version")||"packages.package.create"===h.name||"configPkgs.configPkg.create"===h.name){var l=angular.copy(a.serviceData);a.storing=!0;var m=c.defer();return d.storeService(g.packageId,l).then(function(){o=!0,m.resolve(b.target(h.name,i,{reload:!0}))}).catch(function(b){e(b,"保存安装/升级服务"),a.storing=!1,m.reject(null)}),m.promise}}}}]).controller("PackageAdvancedCtrl",["$scope","$state","$q","PackageFileService","handleAjaxError","toastr","Dialog","packageData","tagData","statusData","baseVersion",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){a.reverting=!0;var c;c=d.revert(h.packageId,a.file),c.then(function(){f.success("还原文件变更成功"),b.reload()}).catch(function(b){a.reverting=!1,e(b,"还原文件变更")})}function m(){a.reverting=!0;var g=[];angular.forEach(n,function(a){g.push(d.revert(h.packageId,a.file))}),c.all(g).then(function(){f.success("还原文件变更成功"),b.reload()}).catch(function(b){a.reverting=!1,e(b,"还原文件变更")})}var n=j;a.diffList=n,a.baseVersion=k;var o=30,p=5;a.diffOverflow=0,a.diffList.length>o+p&&(a.diffList=_.slice(j,0,o),a.diffOverflow=j.length-o),a.revert=function(a){g.confirm({message:"确定要还原 "+a.file+" 的变更吗？",isDanger:!0,resolved:function(){l(a)}})},a.revertAll=function(){g.confirm({message:"确定要还原所有文件变更吗？",isDanger:!0,resolved:m})}}]),angular.module("configPkgs",["configPkgs.services","configPkgs.create","configPkgs.configPkg"]).config(["$stateProvider",function(a){a.state("configPkgs",{url:"/config-pkg",abstract:!0,templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl"}).state("configPkgs.index",{url:"?q&page",params:{q:{dynamic:!0,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0}},templateUrl:"views/config-pkgs/graphs.html",controller:"PackageListCtrl",resolve:{packageList:["ConfigPkgService",function(a){return a.fetchConfigPkgList()}]}})}]),angular.module("configPkgs.services",["url.matcher"]).factory("ConfigPkgService",["RequestWrapper",function(a){function b(a){return"/api/config-pkg/"+a}return{fetchConfigPkgList:function(){return a.array({url:"/api/config-pkg"})},fetchConfigPkg:function(c){return a.object({method:"GET",url:b(c)})},storeConfigPkg:function(b){return a.object({method:"POST",url:"/api/config-pkg",data:b})},updateConfigPkg:function(b,c){return a.object({method:"PUT",url:"/api/config-pkg/"+b,data:c})},removeConfigPkg:function(b){return a.object({method:"DELETE",url:"/api/config-pkg/"+b})},initWorkspace:function(c){return a.object({method:"PUT",url:b(c)+"/init/workspace"})},initVersion:function(c,d){return a.object({method:"PUT",url:b(c)+"/init/"+d})},fetchVersionList:function(c,d){return a.object({method:"GET",url:b(c)+"/version",params:d})},fetchVersionListAll:function(c){return a.array({method:"GET",url:b(c)+"/version",params:{all:1}})},fetchTagList:function(c){return a.array({method:"GET",url:b(c)+"/tag"})},fetchLatestVersion:function(c){return a.object({method:"GET",url:b(c)+"/latest/version"})},fetchVersion:function(c,d){return a.object({method:"GET",url:b(c)+"/version/"+d})},storeVersion:function(c,d){return a.object({method:"POST",url:b(c)+"/version",data:d})},updateVersion:function(c,d,e){return a.object({method:"PUT",url:b(c)+"/version/"+d,data:e})},removeVersion:function(c,d){return a.object({method:"DELETE",url:b(c)+"/version/"+d})},fetchWorkspaceStatus:function(c){return a.array({method:"GET",url:b(c)+"/status/workspace"})},getService:function(c,d){return a.object({method:"GET",url:b(c)+"/service/"+d})},storeService:function(c,d){return a.object({method:"POST",url:b(c)+"/service/workspace",data:d})},getDiff:function(c,d,e,f){var g=[b(c),"diff",d+"..."+e];return f?g.push(f):g.push(""),a.array({method:"GET",url:g.join("/")})}}}]).factory("ConfigPkgFileService",["RequestWrapper","encodePathURI",function(a,b){function c(a,c,d,e){return"/api/config-pkg/"+a+"/"+c+"/"+(d||"workspace")+"/"+b(e)}return{getUrl:c,tree:function(b,d,e){return a.array({method:"GET",url:c(b,"tree",d,e)})},blob:function(b,d,e){return a.object({method:"GET",url:c(b,"blob",d,e)})},rm:function(b,d){return a.object({method:"DELETE",url:c(b,"blob",null,d)})},mkdir:function(b,d){return a.object({method:"POST",url:c(b,"tree",null,d)})},rmdir:function(b,d){return a.object({method:"DELETE",url:c(b,"tree",null,d)})},batch:function(b,d,e){return a.object({method:"POST",url:c(d,"batch",null),params:{_method:b},data:e})},revert:function(b,d){return a.object({method:"POST",url:c(b,"revert",null,d)})},updateBlob:function(b,d,e){return a.object({method:"PUT",url:c(b,"blob",null,d),data:e})},storeBlob:function(b,d,e){return a.object({method:"POST",url:c(b,"blob",null,d),data:e})},setExecutable:function(b,d,e){return a.object({method:"PUT",url:c(b,"attr",null,d),data:{executable:e}})}}}]),angular.module("configPkgs.create",["configPkgs.services","apps.services"]).config(["$stateProvider",function(a){a.state("configPkgs.create",{url:"/create?appId",templateUrl:"views/config-pkgs/create.html",controller:"ConfigPkgCreateCtrl",resolve:{packageData:function(){return null},appData:["$stateParams","AppService",function(a,b){return a.appId?b.fetchApp(a.appId):null}]}})}]).controller("ConfigPkgCreateCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","ConfigPkgService","packageData","appData",function(a,b,c,d,e,f,g,h){function i(b){b.data&&100307===b.data.code?d.alert({type:"error",message:"创建配置包失败，已存在同名的配置包！",callback:function(){var a=$('form[name=formCreateConfigPkg] input[ng-model="packageForm.name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):e(b,"创建配置包"),a.storing=!1}a.isEdit=!!g,a.appData=h,a.isEdit?a.packageForm=_.pick(g,"name","memo","installPath","platform"):(a.packageForm={},h&&h.clusters&&1===h.clusters.length&&(a.packageForm.clusterId=h.clusters[0].instanceId)),_.defaults(a.packageForm,{platform:"linux"}),a.store=function(){if(a.formCreateConfigPkg.$invalid){var e=$("form[name=formCreateConfigPkg] .ng-invalid"),h=e.closest(".form-group");return void(h.length?h:e).scrollIntoViewInBody()}var j=_.pick(a.packageForm,"name","memo","installPath","clusterId","platform");j.memo||(j.memo="无"),a.storing=!0,a.isEdit?f.updateConfigPkg(g.packageId,j).then(function(a){c.success("配置包已保存！"),b.go("configPkgs.configPkg.index",a,{reload:!0})}).catch(i):f.storeConfigPkg(j).then(function(a){a._bindPackageFailed?d.alert({type:"warning",message:"配置包已创建！绑定到集群失败: "+a._bindPackageError,callback:function(){b.go("configPkgs.configPkg.index",a)}}):(c.success("配置包已创建！"),b.go("configPkgs.configPkg.index",a))}).catch(i)}}]),angular.module("configPkgs.configPkg",["configPkgs.configPkg.version.route","configPkgs.configPkg.version.ctrl","packages.package","url.matcher"]).config(["$stateProvider",function(a){a.state("configPkgs.configPkg",{url:"/{packageId:hashId}",abstract:!0,template:"<div ui-view></div>",controller:"ConfigPkgAbstractCtrl",resolve:{packageData:["ConfigPkgService","$stateParams",function(a,b){return a.fetchConfigPkg(b.packageId)}]}}).state("configPkgs.configPkg.index",{url:"?page",templateUrl:"views/packages/package/graphs.html",controller:"PackageIndexCtrl",resolve:{versionData:["$stateParams","ConfigPkgService","packageData",function(a,b,c){return b.fetchVersionList(c.packageId,{page:a.page})}]}}).state("configPkgs.configPkg.edit",{url:"/edit",templateUrl:"views/config-pkgs/create.html",controller:"ConfigPkgCreateCtrl",resolve:{appData:function(){return null}}}).state("configPkgs.configPkg.instance",{url:"/instance",templateUrl:"views/config-pkgs/config-pkg/instance.html",controller:"PackageInstanceCtrl",resolve:{instanceList:["$stateParams","PackageService",function(a,b){return b.fetchInstanceList(a.packageId)}]}}).state("configPkgs.configPkg.create",{url:"/create",templateUrl:"views/packages/package/create.html",controller:"PackageCreateVersionCtrl",resolve:{init:["ConfigPkgService","packageData",function(a,b){return a.initWorkspace(b.packageId)}],statusData:["ConfigPkgService","init","packageData",function(a,b,c){return a.fetchWorkspaceStatus(c.packageId)}],baseVersion:["ConfigPkgService","init","packageData",function(a,b,c){return a.fetchLatestVersion(c.packageId)}],existingVersionData:["ConfigPkgService","packageData",function(a,b){return a.fetchVersionListAll(b.packageId)}]}}).state("configPkgs.configPkg.diff",{url:"/diff/{path:pathURI}",templateUrl:"views/packages/package/diff.html",controller:"PackageCompareCtrl",resolve:{tagFromData:function(){return{versionId:null,name:"基础版本"}},tagToData:function(){return{versionId:"workspace",name:"工作区"}},diffList:["$stateParams","ConfigPkgService","packageData",function(a,b,c){return b.getDiff(c.packageId,"base","workingcopy",a.path)}],versionList:function(){return null}}}).state("configPkgs.configPkg.compare",{url:"/compare/{tagFrom:\\w+}...{tagTo:\\w+}",templateUrl:"views/packages/package/compare.html",controller:"PackageCompareCtrl",resolve:{tagFromData:["$stateParams","ConfigPkgService","packageData",function(a,b,c){return b.fetchVersion(c.packageId,a.tagFrom).then(function(a){return{versionId:a.versionId,name:a.name}})}],tagToData:["$stateParams","ConfigPkgService","packageData",function(a,b,c){return b.fetchVersion(c.packageId,a.tagTo).then(function(a){return{versionId:a.versionId,name:a.name}})}],diffList:["$stateParams","ConfigPkgService","packageData",function(a,b,c){return b.getDiff(c.packageId,a.tagFrom,a.tagTo)}],versionList:["ConfigPkgService","packageData",function(a,b){return a.fetchVersionListAll(b.packageId)}]}})}]).controller("ConfigPkgAbstractCtrl",["$scope","$state","VisitHistory","packageData","checkPermission",function(a,b,c,d,e){a.packageData=d;var f={
linux:"Linux",windows:"Windows",others:"其它"};d.platformName=f[d.platform||"linux"];var g=new c("config-pkgs","packageId");g.push(_.pick(d,"packageId")),a.filesActive=function(){return b.includes("configPkgs.configPkg.version.tree")||b.includes("configPkgs.configPkg.version.blob")||b.includes("configPkgs.configPkg.version.edit")||b.includes("configPkgs.configPkg.version.new")},a.getHrefOfTree=function(a,c,d){return b.href("configPkgs.configPkg.version.tree",{tag:a,path:c?c.slice(0,d+1).join("/"):""})},a.goCreate=function(){b.go("configPkgs.configPkg.version.create")},a.isWorkspace=function(a){return"workspace"===a},a.permissionOfEdit=e("packages.package.edit"),a.permissionOfRemove=e("packages.package.remove"),a.permissionOfVersionCreate=e("packages.package.versions.create"),a.permissionOfVersionEdit=e("packages.package.versions.version.edit"),a.permissionOfVersionRemove=e("packages.package.versions.version.remove")}]),angular.module("configPkgs.configPkg.version.route",["url.matcher"]).config(["$stateProvider",function(a){var b="{tag:workspace|\\w+}",c="{path:pathURI}",d={editorDeps:["depends",function(a){return a("components/editor")}],init:["$stateParams","ConfigPkgService","packageData",function(a,b,c){var d=a.tag;return d&&"workspace"!==d?b.initVersion(c.packageId,d):b.initWorkspace(c.packageId)}],path:["$stateParams",function(a){var b=(a.path||"").replace(/^\/+|\/+$/g,"").replace(/\/{2,}/g,"");return b}],filePath:["$stateParams",function(a){var b=(a.path||"").replace(/^\/+|\/+$/g,"").replace(/\/{2,}/g,"/");if(!b)throw new Error("empty file path");return b}],pathList:["path",function(a){return a?a.split("/"):[]}],dirList:["path",function(a){var b=a.split("/");return 1===b.length?[]:b.slice(0,-1)}],fileData:["ConfigPkgFileService","init","packageData","tagData","path",function(a,b,c,d,e){var f=_.last(e.split("/"));if(!f)throw new Error("empty file name");return a.blob(c.packageId,d.versionId,e)}],tagData:["$stateParams","ConfigPkgService","packageData",function(a,b,c){var d=a.tag;return d&&"workspace"!==d?b.fetchVersion(c.packageId,d).then(function(a){return{versionId:a.versionId,name:a.name}}):{versionId:"workspace",name:"新版本"}}]};a.state("configPkgs.configPkg.version",{url:"/version/"+b,abstract:!0,templateUrl:"views/packages/package/_version.html",controller:"ConfigPkgVersionAbstractCtrl",resolve:{init:d.init,tagData:d.tagData}}).state("configPkgs.configPkg.version.tree",{url:"/tree/"+c,templateUrl:"views/packages/package/tree.html",controller:"PackageTreeCtrl",resolve:{path:d.path,dirList:d.pathList,fileList:["$stateParams","path","ConfigPkgFileService","init","packageData",function(a,b,c,d,e){return c.tree(e.packageId,a.tag,b)}]}}).state("configPkgs.configPkg.version.blob",{url:"/blob/"+c,templateUrl:"views/packages/package/blob.html",controller:"PackageBlobCtrl",resolve:{path:d.filePath,dirList:d.dirList,fileData:d.fileData,deps:d.editorDeps}}).state("configPkgs.configPkg.version.edit",{url:"/edit/"+c,templateUrl:"views/packages/package/edit.html",controller:"PackageEditCtrl",resolve:{path:d.filePath,dirList:d.dirList,fileData:d.fileData,deps:d.editorDeps}}).state("configPkgs.configPkg.version.new",{url:"/new/"+c,templateUrl:"views/packages/package/edit.html",controller:"PackageNewCtrl",resolve:{path:d.path,dirList:d.pathList,deps:d.editorDeps}}).state("configPkgs.configPkg.version.service",{abstract:!0,url:"/service",templateUrl:"views/packages/package/service.html",resolve:{serviceData:["tagData","ConfigPkgService","init","packageData",function(a,b,c,d){return b.getService(d.packageId,a.versionId)}],deps:d.editorDeps}}).state("configPkgs.configPkg.version.service.process",{url:"/process",templateUrl:"views/config-pkgs/config-pkg/service-process.html",controller:"PackageServiceProcessCtrl"}).state("configPkgs.configPkg.version.service.install",{url:"/install",templateUrl:"views/packages/package/service-install.html",controller:"PackageServiceInstallCtrl"}).state("configPkgs.configPkg.version.advanced",{url:"/advanced",templateUrl:"views/packages/package/advanced.html",controller:"PackageAdvancedCtrl",resolve:{statusData:["tagData","ConfigPkgService","init","packageData",function(a,b,c,d){return"workspace"!==a.versionId?null:b.fetchWorkspaceStatus(d.packageId)}],baseVersion:["ConfigPkgService","packageData",function(a,b){return a.fetchLatestVersion(b.packageId)}]}})}]),angular.module("configPkgs.configPkg.version.ctrl",[]).controller("ConfigPkgVersionAbstractCtrl",["$scope","$state","tagData",function(a,b,c){a.tagData=c,a.tag=c.versionId,a.getHrefOfTree=function(a,c,d){return b.href("configPkgs.configPkg.version.tree",{tag:a,path:c?c.slice(0,d+1).join("/"):""})},a.atWorkspace="workspace"===c.versionId,a.pacakgeViewPath="views/config-pkgs/config-pkg",a.getHrefOfPackageChildState=function(a){return b.href("configPkgs.configPkg."+a)}}]),angular.module("auth.route",[]).config(["$stateProvider",function(a){a.state("auth",{url:"",abstract:!0,template:"<div ui-view></div>",controller:"AuthAbstractCtrl"}).state("auth.signin",{url:"/signin?redirect",templateUrl:"views/pages/signin.html",controller:"AuthSignInCtrl",resolve:{signInType:["Auth",function(a){return a.getSignInType()}]}}).state("auth.forgot-password",{url:"/forgot-password",templateUrl:"views/pages/forgot-password.html",controller:"AuthForgotPassCtrl"}).state("auth.reset-password",{url:"/reset-password?username&code",templateUrl:"views/pages/reset-password.html",controller:"AuthResetPassCtrl"}).state("auth.signup",{url:"/signup?code",templateUrl:"views/pages/signup.html",controller:"AuthSignUpCtrl"})}]),angular.module("auth.ctrl",[]).controller("AuthAbstractCtrl",["$scope","$document","Auth","BRAND_TEXT","GalaxyBackground",function(a,b,c,d,e){e();var f=b.find("body");f.addClass("body-auth"),a.$on("$destroy",function(){f.removeClass("body-auth")}),a.brandText=d}]).controller("AuthSignInCtrl",["$scope","$state","$stateParams","$window","$localStorage","$sessionStorage","Auth","handleAjaxError","Dialog","toastr","LDAP_ENABLED","signInType",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){"normal"===b?(a.activeIndex=0,p=a.formData={username:e.username}):(a.activeIndex=1,p=a.formData={login_id:e.login_id})}if(d.parent!==d){var n=f.fromState;delete f.fromState;var o;return o=n?b.href(n.stateName,n.params):b.href("home"),void(d.parent.location.href=o)}var p={};a.formData=p,a.ldapEnabled=k,a.ldapType="ldap"===l,m(l),a.changeLoginType=function(a){m(a)},a.signin=function(){a.signing||(a.signing=!0,g.signin(p.username,p.password).then(function(){j.success("已登录"),g.setSignInType("normal"),e.username=p.username;var a=g.getSignInFrom();c.redirect&&/\/oauth\/auth/.test(c.redirect)?d.location.href=c.redirect:a?(g.clearSignInFrom(),d.location.href=b.href(a.state,a.params)):d.location.href="/"}).catch(function(b){a.signing=!1;var c=b.data;if(angular.isObject(c))switch(c.code){case 133001:case 133006:case 130303:case 130308:case 130502:case 133011:return void i.alert({type:"error",size:"sm",title:"出错了",message:"用户名(邮箱)或密码错误"});case 133014:return void i.alert({type:"error",size:"sm",title:"出错了",message:"您尝试登录次数过多，请过几分钟后再试"})}return 429===b.status?void i.alert({type:"warning",size:"sm",message:"您的请求太频繁，请过几分钟后再试"}):void h(b,"登录")}))},a.ldapSignin=function(){a.signing||(a.signing=!0,g.ldapSignin(p.login_id,p.password).then(function(){g.setSignInType("ldap"),e.login_id=p.login_id,j.success("已登录");var a=g.getSignInFrom();a?(g.clearSignInFrom(),d.location.href=b.href(a.state,a.params)):d.location.href="/"}).catch(function(a){var b=a.data;if(angular.isObject(b))switch(b.code){case 133001:case 133011:case 133006:return void i.alert({type:"error",size:"sm",title:"出错了",message:"用户名或密码错误"})}429===a.status&&i.alert({type:"warning",size:"sm",message:"你的请求太频繁，请过几分钟再试"})}).finally(function(){a.signing=!1}))}}]).controller("AuthForgotPassCtrl",["$scope","$state","$element","Auth","handleAjaxError","Dialog","toastr",function(a,b,c,d,e,f,g){function h(a,b){f.alert({type:"warning",size:"sm",message:b||k[a],callback:function(){j[a].focus().select()}})}var i={};a.formData=i;var j={email:c.find('input[name="email"]')},k={email:"请输入有效的邮箱地址"};a.send=function(){if(!a.sending){var b=a.formForgotPass;if(b.$invalid){var c=_.some(j,function(a,c){return!!b[c].$invalid&&(h(c),!0)});if(!c)throw new Error("unexpected invalid form of forgot-password")}else a.sending=!0,d.resetEmail(angular.copy(i)).then(function(){g.success("设置新密码的邮件已发送！")}).catch(function(a){var b=a.data;if(angular.isObject(b))switch(b.code){case 130303:return void f.alert({type:"error",size:"sm",title:"出错了",message:"邮箱不存在"})}e(a,"发送重置密码的邮件")}).finally(function(){a.sending=!1})}}}]).controller("AuthResetPassCtrl",["$scope","$state","$element","Auth","handleAjaxError","Dialog","toastr","$stateParams",function(a,b,c,d,e,f,g,h){function i(a,b){f.alert({type:"warning",size:"sm",message:b||n[a],callback:function(){m[a].focus().select()}})}var j=h.code,k=h.username;a.username=k;var l={};a.formData=l;var m={password:c.find('input[name="password"]'),password2:c.find('input[name="password2"]')},n={password:"请输入6至20位密码",password2:"两次输入的密码不一致"};a.reset=function(){if(!a.reseting){var c=a.formResetPass;if(c.$invalid){var f=_.some(m,function(a,b){return!!c[b].$invalid&&(i(b),!0)});if(!f)throw new Error("unexpected invalid form of reset-password")}else{if(l.password!==l.password2)return void i("password2");a.reseting=!0,d.resetPassword(k,l.password,j).then(function(){g.success("已重置密码, 请重新登录!"),b.go("auth.signin")}).catch(function(a){e(a,"重置密码")}).finally(function(){a.reseting=!1})}}}}]).controller("AuthSignUpCtrl",["$scope","$state","$window","$element","$timeout","$stateParams","$uibModal","Auth","handleAjaxError","Dialog","toastr","IS_COMMUNITY_EDITION",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){s-=1,r=e(n,1e3)}function n(){s>0?(a.sendingInviteCodeDelay="("+s+")",m()):(a.sendingInviteCodeDelay="",r=null)}function o(a,b,c){j.alert({type:"warning",size:"sm",message:b||u[a],callback:function(){var b=t[a];b&&b.focus().select(),c&&c()}})}var p={agreeTerms:!0,orgAction:"new"};a.formData=p,f.code&&/^[0-9a-zA-Z]{9}$/.test(f.code)?(p.orgAction="join",p.invite=f.code,a.hideInvite=!0):p.orgAction="new",a.inviteCodePattern=a.hideInvite?/^[0-9a-zA-Z]{9}$/:/^[0-9]{6}$/;var q=l&&"new"===p.orgAction?"验证码":"邀请码";a.orgActionChange=function(){"join"===p.orgAction&&(p.org_name=null)},a.sendingInviteCodeDelay="";var r,s;a.tooltipEnabled={sentInviteCode:!1},a.sendInviteCode=function(){if(!a.sendingInviteCode&&!a.sendingInviteCodeDelay){if(!p.phone||a.formSignUp.phone.$invalid)return void o("phone");var b=_.pick(p,"phone");a.sendingInviteCode=!0,h.sendInviteCode(b).then(function(){a.tooltipEnabled.sentInviteCode=!0,e(function(){a.tooltipEnabled.sentInviteCode=!1},5e3),s=120,n()}).catch(function(a){if(429===a.status||a.data&&133014===a.data.code)return void j.alert({type:"warning",size:"sm",message:"你的请求太频繁，请过几分钟再试"});switch(a.data&&a.data.code){case 133005:return void o("phone","手机号码已被使用，试试换一个号码")}i(a,"获取"+q)}).finally(function(){a.sendingInviteCode=!1})}},a.showTerms=function(){var a=g.open({templateUrl:"views/_terms.html"});a.result.then(function(){p.agreeTerms=!0},function(){p.agreeTerms=!1})};var t={username:d.find('input[name="username"]'),email:d.find('input[name="email"]'),password:d.find('input[name="password"]'),password2:d.find('input[name="password2"]'),phone:d.find('input[name="phone"]'),invite:d.find('input[name="invite"]'),org_name:d.find('input[name="org_name"]')},u={username:"请输入6至20位的用户名，以字母开头，且只包含字母、数字或下划线",email:"请输入有效的邮箱地址",password:"请输入6至20位密码",password2:"两次输入的密码不一致",phone:"请输入有效的手机号码",invite:"请输入有效的"+q,org_name:"请输入1至64位的组织名称，只能包含中文、字母、数字、下划线、横杠、空格"};a.signup=function(){if(!a.signing){var b=a.formSignUp;if(b.$invalid){var d=!1;if(d=_.some(t,function(a,c){return!(!b[c]||!b[c].$invalid)&&(o(c),!0)}),!d)throw new Error("unexpected invalid form of signup")}else{if(p.password!==p.password2)return void o("password2");if(!p.agreeTerms)return void o("agreeTerms","你必须同意网站服务条款才能注册账号",a.showTerms);a.signing=!0,h.signup(_.omit(angular.copy(p),"password2","agreeTerms","orgAction")).then(function(){k.success("注册成功，请登录你的邮箱验证账号。"),c.location.href="/"}).catch(function(b){a.signing=!1;var c=b.data;if(angular.isObject(c))switch(c.code){case 133003:return void o("username","用户名已被使用，试试换一个用户名");case 133004:return void o("email","邮箱已被使用，试试换一个邮箱");case 133005:return void o("phone","手机号码已被使用，试试换一个号码");case 133017:case 133201:return void o("invite",q+"无效，请确认")}return 429===b.status?void o("rateLimit","你的请求太频繁，请过几分钟再试"):void i(b,"注册")})}}},a.$on("$destroy",function(){r&&e.cancel(r)})}]),angular.module("auth.service",[]).factory("Auth",["$http","$sessionStorage","$localStorage","RequestWrapper",function(a,b,c,d){var e=null;return{signup:function(a){return d.object({method:"POST",url:"/api/signup",data:a})},quickSignUp:function(a){return d.object({method:"POST",url:"/api/quick-signup",data:a})},signin:function(a,b){return d.object({method:"POST",url:"/api/signin",data:{username:a,password:b}})},ldapSignin:function(a,b){return d.object({method:"POST",url:"/api/ldap-signin",data:{login_id:a,password:b}})},resetEmail:function(a){return d.object({method:"POST",url:"/api/reset-email",data:a})},resetPassword:function(a,b,c){return d.object({method:"PUT",url:"/api/reset-password",data:{username:a,password:b,password_code:c}})},signout:function(){return d.object({method:"POST",url:"/api/signout"})},setSignInType:function(a){c.signInType=a},getSignInType:function(){return angular.copy(c.signInType)},setSignInFrom:function(a,c){b.signInFrom={state:a,params:c}},getSignInFrom:function(){return angular.copy(b.signInFrom)},clearSignInFrom:function(){delete b.signInFrom},setNextState:function(a,b){e={state:a,params:b}},getNextState:function(){return e},getCode:function(a){return d.object({method:"GET",url:"/api/me/verify/email",params:{code:a}})},sendInviteCode:function(a){return d.object({method:"POST",url:"/api/invite/code",data:a})}}}]).service("GalaxyBackground",[function(){return function(a){function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}}(),d=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(a){return window.clearTimeout(a,1e3/60)}}(),e=document.createElement("div"),f=document.createElement("canvas");e.style.cssText="position: absolute; top: 0; z-index: -1; width: 100%; height: 100%; overflow: hidden;",e.style.backgroundColor="rgb(20, 62, 114)",f.style.cssText="display: block",e.appendChild(f),document.body.appendChild(e);var g=window.innerWidth,h=window.innerHeight;f.setAttribute("width",g),f.setAttribute("height",h);for(var i,j=function(){function a(c,d,e,f){b(this,a),this.x=c,this.y=d,this.z=e,this.shape=f}return a.prototype.project=function(b){var c=(b.x*this.z-this.x*b.z)/(this.z-b.z),d=(b.y*this.z-this.y*b.z)/(this.z-b.z);return new a(c,d,0,this.shape)},a.prototype.drawDot=function(a){var b=arguments.length<=1||void 0===arguments[1]?1:arguments[1];a.save(),a.beginPath(),a.fillStyle="rgb(255,255,255)",a.shadowColor="rgb(255,255,255)",a.shadowBlur=10,a.arc(this.x,this.y,b,0,2*Math.PI),a.fill(),a.closePath(),a.restore()},a.prototype.drawLine=function(a){a.save(),a.beginPath(),a.strokeStyle="rgba(255, 255, 255, 1)",a.shadowColor="rgb(255,255,255)",a.shadowBlur=10,a.moveTo(this.x,this.y),a.lineTo(this.x+3,this.y+3),a.stroke(),a.closePath(),a.restore()},a.prototype.render=function(a){var b=a.context;switch(this.shape){case"smallDot":this.drawDot(b,.6);break;case"bigDot":this.drawDot(b,1);break;default:this.drawLine(b)}},a}(),k=function(){function a(e,f,g){b(this,a),this.canvas=e,this.width=+e.getAttribute("width"),this.height=+e.getAttribute("height"),this.context=e.getContext("2d"),this.eye=f,this.things=g,this.render();var h=this,j=null;window.addEventListener("mousemove",function(a){j||(j={},j.x=a.clientX,j.y=a.clientY),h.eye.x=(a.clientX-j.x)/6+h.width/4,h.eye.y=(a.clientY-j.y)/6+h.height/4,i&&d.call(window,i),i=c.call(window,function(){h.render()})})}return a.prototype.render=function(){var a=this.context,b=this.width,c=this.height,d=this.things,e=this.eye,f=this;a.clearRect(0,0,b,c),a.save(),a.globalAlpha=0,a.fillStyle="rgb(20,62,114)",a.fillRect(0,0,b,c),a.restore(),d.forEach(function(a){var b=a.project(e);b.render(f)})},a}(),l=[],m=0;m<800;m+=1){var n=Math.floor(Math.random()*g*2)-g/2,o=Math.floor(Math.random()*h*2)-h/2,p=Math.floor(1e3*Math.random())+1e3,q=void 0,r=Math.floor(100*Math.random());q=r>=0&&r<80?"smallDot":r>=70&&r<=95?"bigDot":"line",l.push(new j(n,o,p,q))}var s=new j(g/4,h/4,-2500);new k(f,s,l)}}]),angular.module("tools.route",["url.matcher"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/tool/","/tool"),a.state("tools",{abstract:!0,url:"/tool",templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl"}).state("tools.index",{url:"",templateUrl:"views/tools/graphs.html",controller:"ToolsIndexCtrl",resolve:{toolListData:["Tools",function(a){return a.fetchToolList()}]}}).state("tools.create",{url:"/create",templateUrl:"views/tools/create.html",controller:"ToolCreateCtrl",resolve:{toolData:function(){return null},toolCategories:["Tools",function(a){return a.getToolCategories()}],userList:["Abject",function(a){return a.fetchAbjectInstanceListAll("USER","instanceId,name")}],deps:["depends",function(a){return a("components/editor")}]}}).state("tools.store",{url:"/store",templateUrl:"views/tools/store.html",controller:"ToolStoreCtrl"}).state("tools.import",{url:"/import",templateUrl:"views/tools/import.html",controller:"ToolImportCtrl"}).state("tools.tool",{abstract:!0,url:"/{toolId:hashId}",template:"<div ui-view></div>",controller:"ToolAbstractCtrl",resolve:{toolData:["$stateParams","Tools",function(a,b){return b.fetchTool(a.toolId)}]}}).state("tools.tool.detail",{url:"?page&range",params:{range:{dynamic:!0,value:"week",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0}},templateUrl:"views/tools/detail.html",controller:"ToolDetailCtrl",resolve:{historyData:["$stateParams","Tools",function(a,b){return b.getExecutionHistory(angular.copy(a))}],deps:["depends",function(a){return a("components/editor")}]}}).state("tools.tool.edit",{url:"/edit",templateUrl:"views/tools/create.html",controller:"ToolCreateCtrl",resolve:{toolCategories:["Tools",function(a){return a.getToolCategories()}],deps:["depends",function(a){return a("components/editor")}]}}).state("tools.tool.settings",{url:"/settings",templateUrl:"views/tools/settings.html",controller:"ToolSettingsCtrl",resolve:{userList:["Abject",function(a){return a.fetchAbjectInstanceListAll("USER","instanceId,name")}]}}).state("tools.tool.execute",{url:"/execute?fromToolkit",templateUrl:"views/tools/execute.html",controller:"ToolExecuteCtrl"})}]),angular.module("tools.ctrl",[]).controller("ToolsIndexCtrl",["$scope","$state","VisitHistory","checkPermission","toolListData",function(a,b,c,d,e){function f(a,b){return{category:b,list:a}}function g(a){return a.category.toLowerCase()}function h(a){return a.name?a.name.toLowerCase():""}a.permissionOfCreate=d("tools.create");var i=new c("tools","toolId"),j=i.frequentlyVisited();a.filters={q:null,label:null};var k=_.sortBy(e,h),l=_.chain(k).groupBy("category").map(f).sortBy(g).value();a.labelList=_.map(l,"category"),a.setLabel=function(b){a.filters.label===b?a.filters.label=null:a.filters.label=b,a.filtersChange()},j=_.compact(_.map(j,function(a){return _.find(k,_.pick(a,"toolId"))})),j.length&&l.unshift({category:"经常使用的工具",list:j}),a.toolListGroup=l,a.filtersChange=function(){var b=(a.filters.q||"").toLowerCase(),c=a.filters.label;b?a.toolListGroup=_.chain(k).filter(function(a){return!(!a||!a.name)&&a.name.toLowerCase().indexOf(b)!==-1}).groupBy("category").map(f).sortBy(g).value():a.toolListGroup=l,c&&(a.toolListGroup=_.filter(a.toolListGroup,function(a){return a.category===c}))}}]).controller("ToolAbstractCtrl",["$scope","VisitHistory","checkPermission","toolData",function(a,b,c,d){a.toolData=angular.copy(d),a.toolData.inputList=angular.copy(d.inputs),a.toolData.outputList=_.map(d.toolOutputs.columns,"id"),d.whiteList&&d.whiteList.length?a.toolData.execUserRestriction="仅允许以这些用户执行: "+_.join(d.whiteList,"; "):d.blackList&&d.blackList.length?a.toolData.execUserRestriction="不允许以这些用户执行: "+_.join(d.blackList,"; "):a.toolData.execUserRestriction="无限制",a.permissionOfEdit=c("tools.tool.edit",function(a){return d.creator===a}),a.permissionOfRemove=c("tools.tool.remove",function(a){return d.creator===a}),a.permissionOfExecute=c("tools.tool.execute",function(a){if(!d.authUsers||!d.authUsers.length)return!0;var b=[d.creator].concat(d.authUsers);return _.includes(b,a)});var e=new b("tools","toolId");e.push(_.pick(d,"toolId"))}]).controller("ToolDetailCtrl",["$scope","$state","$stateParams","$timeout","$localStorage","$uibModal","Dialog","Utils","handleAjaxError","toastr","Tools","toolData","historyData",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){a.removing=!0,k.removeTool(l.toolId).then(function(){j.success("删除工具成功"),b.go("tools.index")}).catch(function(a){i(a,"删除工具")}).finally(function(){a.removing=!1})}function o(a){var b={};return angular.forEach(a,function(a,c){b[c]=s[c]===a?null:a}),b}function p(b){a.historyList=b.list,a.totalItems=b.total,a.itemsPerPage=b.pageSize,angular.forEach(a.historyList,function(a){"executing"===a.status&&(a.endTime=null)})}a.showToolWarning=!e.toolWarningDismissed,a.dismissToolWarning=function(){e.toolWarningDismissed=!0,a.showToolWarning=!1};var q=l.type,r={lineWrapping:!0,lineNumbers:!0,viewportMargin:1/0,readOnly:!0,mode:q};a.options=r,a.cmLoaded=function(a){CodeMirror.autoLoadMode(a,q)},a.selectToolIcon=function(){if(!l.system_tool&&a.permissionOfEdit){var b=a.$new(!0);b.toolForm=_.pick(l,["toolId","icon","style"]),f.open({templateUrl:"views/tools/_select-icon.html",backdrop:"static",scope:b,controller:"ToolSelectIconCtrl",resolve:{toolStyles:["Tools",function(a){return a.getToolStyles()}]}})}},a.getToolIconStyle=function(){return _.compact([l.style,!l.system_tool&&a.permissionOfEdit?"clickable":null]).join(" ")},a.removeTool=function(){g.confirm({message:"确定删除工具 <code>"+h.escapeHtml(l.name)+"</code> 吗?",html:!0,isDelete:!0,resolved:n})};var s={range:"week",page:1},t=_.defaults({},c,s);a.filters=t,a.rangeList=[{value:"today",text:"今天"},{value:"yesterday",text:"昨天"},{value:"week",text:"近7天"},{value:"month",text:"近30天"}],a.picker={date:null,month:null,now:"date",dateOptions:{maxDate:new Date},monthOptions:{maxDate:new Date,minMode:"month"}},/^\d{4}-\d\d-\d\d$/.test(t.range)?a.picker.date=moment(t.range).toDate():/^\d{4}-\d\d$/.test(t.range)&&(a.picker.month=moment(t.range+"-01").toDate(),a.picker.now="month"),a.pickDate=function(){a.picker.month=null,a.picker.date=null,a.picker.now="date",a.openDatepicker()},a.pickMonth=function(){a.picker.month=null,a.picker.date=null,a.picker.now="month",a.openMonthpicker()},a.datepickerStatus={open:!1},a.openDatepicker=function(){a.datepickerStatus.open=!0},a.monthpickerStatus={open:!1},a.openMonthpicker=function(){a.monthpickerStatus.open=!0},a.$watch("picker.date",function(a,c){a&&+a!==+c&&(t.range=moment(a).format("YYYY-MM-DD"),t.page=null,b.go(b.current.name,o(t)))}),a.$watch("picker.month",function(a,c){a&&+a!==+c&&(t.range=moment(a).format("YYYY-MM"),t.page=null,b.go(b.current.name,o(t)))}),a.rangeChanged=function(){t.page=1,a.picker.date=null,a.picker.month=null,b.go(b.current.name,o(t))},a.pageChange=function(){b.go(b.current.name,o(t))},this.uiOnParamsChanged=function(){var a=angular.copy(t);a.toolId=l.toolId,k.getExecutionHistory(a).then(function(a){p(a),d(function(){$("#panel-tool-history").scrollIntoViewInBody()})}).catch(function(a){i(a,"查询工具历史任务")})},p(m)}]).controller("ToolSelectIconCtrl",["$scope","$state","handleAjaxError","Tools","toolStyles",function(a,b,c,d,e){a.styleList=e.styles,a.iconList=e.icons,a.confirm=function(){a.storing=!0,d.updateTool(a.toolForm.toolId,_.pick(a.toolForm,["icon","style"])).then(function(){b.reload()}).catch(function(b){a.storing=!1,c(b,"设置工具图标和样式")})}}]).controller("ToolCreateCtrl",["$scope","$state","$uibModal","$aside","$timeout","$window","$localStorage","Utils","toastr","Dialog","handleAjaxError","Tools","toolCategories","toolData","SAMPLE_TOOL_ID",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(b){a.storing=!1,b.data&&100307===b.data.code?j.alert({type:"error",message:"保存工具失败，可能已存在同名的工具！",callback:function(){var a=$('form[name="forms.createTool"] input[ng-model="toolForm.name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):k(b,"保存工具")}function q(b){var c=a.$new(!0),e=d.open({templateUrl:"views/tools/_execution-detail.html",scope:c,backdrop:"static",size:"lg",controller:"ToolExecutionCtrl",resolve:{executionResult:["Tools",function(a){return a.getExecutionResult(b.execId)}]}});e.result.then(null,function(a){_.isObject(a)&&k(a,"查看工具执行结果")})}var r="默认";a.isEdit=!!n,a.isCreate=!a.isEdit,a.toolData=n?angular.copy(n):{type:"shell",icon:"wrench",style:"default",category:r,authUsers:[],whiteList:[],blackList:[],toolOutputs:{dimensions:[],columns:[]}},a.activeTabIndex="basics",a.notEditable=!!a.toolData.system_tool,a.SAMPLE_TOOL_ID=o,a.forms={},a.popoverStatus={script:!1},a.$watch("activeTabIndex",function(){a.popoverStatus.script=!1}),_.indexOf(m,r)===-1&&m.push(r),a.toolCategories=_.sortBy(m,function(a){return a.toLowerCase()}),"powershell"===a.toolData.type&&(a.isWindows=!0);var s=a.toolForm=angular.copy(a.toolData);n?s.inputList=angular.copy(n.inputs):s.inputList=[];var t=a.debugData={inputList:[]};a.isCreate&&g.toolCreateData&&(s.content=g.toolCreateData.content);var u=n?n.toolId:"_";g.toolDebugData||(g.toolDebugData={});var v=g.toolDebugData[u];v&&(t.agents=v.agents),a.$watch("toolForm.inputList",function(a){var b=[];angular.forEach(a,function(a){if(a.name){var c=angular.copy(a);c.default&&("int"===c.type?c.value=+c.default:c.value=c.default),b.push(c)}}),t.inputList=b},!0),a.languageTypeList=[{text:"Shell",value:"shell"},{text:"Python",value:"python"},{text:"PowerShell",value:"powershell"}],a.outputTypeList=[{value:"",text:"无"},{value:"taskStatus",text:"任务状态"}],a.getOutputTypeText=function(b){var c=_.find(a.outputTypeList,{value:b});return b&&c?c.text:""},a.inputsSortableOptions={containerPositioning:"relative",containment:"#tool-form-preview"},a.inputsSortableEnabled=!1,a.dimensionsSortableOptions={containerPositioning:"relative",containment:"#table-outputs-dimensions"},a.dimensionsSortableEnabled=!1,a.columnsSortableOptions={containerPositioning:"relative",containment:"#table-outputs-columns"},a.columnsSortableEnabled=!1,a.addInput=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0;var d=c.open({templateUrl:"views/tools/_input-settings.html",backdrop:"static",scope:b,controller:"ToolInputSettingsCtrl"});d.result.then(function(a){s.inputList.push(a)})},a.showInputSettings=function(b){if(!a.storing){var d=a.$new(!0);d.inputForm=angular.copy(b),d.isEdit=!0,d.isCreate=!1;var e=c.open({templateUrl:"views/tools/_input-settings.html",backdrop:"static",scope:d,controller:"ToolInputSettingsCtrl"});e.result.then(function(a){a?_.assign(b,a):_.remove(s.inputList,b)})}},a.addOutputsDimension=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0,b.outputTypeList=a.outputTypeList;var d=c.open({templateUrl:"views/tools/_output-dimension.html",backdrop:"static",scope:b,controller:"ToolOutputSettingsCtrl"});d.result.then(function(a){s.toolOutputs.dimensions.push(a)})},a.showOutputsDimensionSettings=function(b){var d=a.$new(!0);d.outputForm=angular.copy(b),d.isEdit=!0,d.isCreate=!1,d.outputTypeList=a.outputTypeList;var e=c.open({templateUrl:"views/tools/_output-dimension.html",backdrop:"static",scope:d,controller:"ToolOutputSettingsCtrl"});e.result.then(function(a){a?_.assign(b,a):_.remove(s.toolOutputs.dimensions,b)})},a.removeOutputsDimension=function(a){_.remove(s.toolOutputs.dimensions,a)},a.addOutputsColumn=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0,b.outputTypeList=a.outputTypeList;var d=c.open({templateUrl:"views/tools/_output-column.html",backdrop:"static",scope:b,controller:"ToolOutputSettingsCtrl"});d.result.then(function(a){s.toolOutputs.columns.push(a)})},a.showOutputsColumnSettings=function(b){var d=a.$new(!0);d.outputForm=angular.copy(b),d.isEdit=!0,d.isCreate=!1,d.outputTypeList=a.outputTypeList;var e=c.open({templateUrl:"views/tools/_output-column.html",backdrop:"static",scope:d,controller:"ToolOutputSettingsCtrl"});e.result.then(function(a){a?_.assign(b,a):_.remove(s.toolOutputs.columns,b)})},a.removeOutputsColumn=function(a){_.remove(s.toolOutputs.columns,a)},a.previewOutputs=function(){var b=a.$new(!0);b.outputs=s.toolOutputs,c.open({templateUrl:"views/tools/_preview-outputs.html",backdrop:"static",scope:b,size:s.toolOutputs.dimensions.length+s.toolOutputs.columns.length>=5?"xlg":"md"})};var w={shell:["# 说明:","# 使用 `$inputName` 来使用输入参数, 如:","echo $inputA","",'# 使用 `PutStr "outputName" "outputValue"` 来给输出参数赋值, 如:','PutStr "outputB" "hello"'].join("\n"),python:["# 说明:","# 使用 `inputName` 来使用输入参数, 如:","print(inputA)","",'# 使用 `PutStr("outputName", "outputValue")` 来给输出参数赋值, 如:','PutStr("outputB", "hello")'].join("\n")};w.powershell=w.shell;var x={shell:'<div>使用 `$inputName` 来使用输入参数, 如:<br><code>echo $inputA</code><br><br>使用 `PutStr "outputName" "outputValue"` 来给输出参数赋值, 如:<br><code>PutStr "outputB" "hello"</code></div>',python:'<div>使用 `inputName` 来使用输入参数, 如:<br><code>print(inputA)</code><br><br>使用 `PutStr("outputName", "outputValue")` 来给输出参数赋值, 如:<br><code>PutStr("outputB", "hello")</code></div>'};x.powershell=x.shell;var y,z=s.type,A={lineWrapping:!0,lineNumbers:!0,matchBrackets:!0,mode:z,placeholder:w[z],readOnly:a.notEditable};a.options=A,a.scriptPopover=x[z],a.cmLoaded=function(b){y=b,e(function(){y.refresh()}),CodeMirror.autoLoadMode(b,z),a.isCreate&&y.on("change",function(){var a=y.getDoc().getValue();return g.toolCreateData||(g.toolCreateData={}),_.trim(a)?void(g.toolCreateData.content=a):void(g.toolCreateData.content="")})},a.selectTabOfBasics=function(){y&&e(function(){y.refresh()})},a.selectTabOfDebugger=function(){t.execUser||(t.execUser=s.defaultExecUser||"root")},a.$watch("storing",function(b){y&&(a.options.readOnly=y.setOption("readOnly",!!b&&"nocursor"))}),a.typeChanged=function(){z=s.type,y.setOption("mode",z),y.setOption("placeholder",w[z]),CodeMirror.autoLoadMode(y,z),a.scriptPopover=x[z],"powershell"===z?(a.toolForm.defaultExecUser="Administrator",a.debugData.execUser=a.toolForm.defaultExecUser,a.isWindows=!0):(a.isWindows=!1,"Administrator"===a.toolForm.defaultExecUser&&(a.toolForm.defaultExecUser="root",a.debugData.execUser=a.toolForm.defaultExecUser))},a.isFormChanged=function(){var b=_.pick(s,"name","type","category","memo","icon","style","content","defaultExecUser");if(b.inputs=angular.copy(s.inputList),b.outputs=_.map(s.toolOutputs.columns,"id").join(" "),b.toolOutputs=angular.copy(s.toolOutputs),a.isEdit){var c=_.some(b,function(a,b){return!angular.equals(a,n[b])});return c}return!0},a.store=function(){if(a.forms.createTool.$invalid||!s.content){var c=$('form[name="forms.createTool"] .ng-invalid'),d=c.closest(".form-group");return a.activeTabIndex="basics",void(d.length?d:c).scrollIntoViewInBody()}var e=_.pick(s,"name","type","category","memo","icon","style","content","defaultExecUser");if(e.inputs=angular.copy(s.inputList),e.outputs=_.map(s.toolOutputs.columns,"id").join(" "),e.toolOutputs=angular.copy(s.toolOutputs),a.isEdit){var f=_.some(e,function(a,b){return!angular.equals(a,n[b])});if(!f)return void j.alert({type:"warning",message:"没有任何变更！"})}e.defaultExecUser||(e.defaultExecUser="root"),a.storing=!0,a.isEdit?l.updateTool(s.toolId,e).then(function(){i.success("保存工具成功"),b.go("tools.tool.detail",null,{reload:!0})}).catch(p):l.storeTool(e).then(function(a){
g.toolCreateData&&delete g.toolCreateData.content,i.success("保存工具成功"),b.go("tools.tool.detail",a)}).catch(p)},a.selectDevices=function(a){t.agents=_.map(a,"ip").join(", ")},a.$watch("debugData.agents",function(){var b=h.matchIps(t.agents);t.selectedIps=b,a.agentsCount=b?b.length:0}),a.selectDevicesForInput=function(a,b){b.selectedIps=_.uniq(_.map(a,"ip")),b.value=b.selectedIps.join(", ")},a.inputItemChange=function(a){"ips"===a.type&&(a.selectedIps=h.matchIps(a.value))},a.debug=function(){if(!a.forms.debugTool.$invalid&&s.content){var b=h.matchIps(t.agents);if(b){g.toolDebugData[u]={agents:b.join(", ")};var c={};angular.forEach(t.inputList,function(a){c[a.name]=""+(a.value||"")}),a.debugging=!0,l.debugTool({type:s.type,content:s.content,agents:b,inputs:c,inputs_info:angular.copy(t.inputList),execUser:t.execUser,outputs:_.map(s.toolOutputs.columns,"id"),toolOutputs:angular.copy(s.toolOutputs)}).then(function(a){q(a)}).catch(function(a){a.data&&120602===a.data.code?j.alert({type:"error",message:"启动工具调试失败！你没有工具的执行权限或目标主机的运维权限。"}):k(a,"启动工具调试")}).finally(function(){a.debugging=!1})}}}}]).controller("ToolInputSettingsCtrl",["$scope","$uibModal","$uibModalInstance","Dialog",function(a,b,c,d){function e(b){var c,d=_.find(a.inputTypeList,{value:b.type});return d?(c=d.text,"enum"===b.type&&b.enum&&(c+=" ("+b.enum.length+")")):c="strings",c}a.isCreate&&(a.inputForm={name:"",type:"string"}),a.inputTypeList=[{value:"string",text:"单行字符串"},{value:"strings",text:"多行字符串"},{value:"int",text:"整型"},{value:"enum",text:"枚举"},{value:"ips",text:"IP 列表"}],a.inputForm.typeText=e(a.inputForm),a.selectInputType=function(a,b){a.type=b.value,a.typeText=e(a)},a.setInputOfEnum=function(c){var d=a.$new(!0);d.inputName=c.name,d.enumList=_.map(c.enum,function(a){return{value:a}}),d.enumList.length||d.enumList.push({value:null});var f=b.open({templateUrl:"views/tools/_set-input-enum.html",backdrop:"static",scope:d,controller:["$scope","$timeout",function(a,b){a.appendOne=function(){a.enumList.push({value:null}),b(function(){$("#input-enum-list input").last().focus()})}}]});f.result.then(function(){c.enum=_.compact(_.map(d.enumList,"value")),c.typeText=e(c)})},a.confirm=function(){if(!a.formInputSettings.$invalid){var b=angular.copy(a.inputForm);if(delete b.typeText,"enum"===b.type){if(!b.enum||!b.enum.length)return void d.alert({type:"warning",message:"请设置枚举列表！"})}else delete b.enum;c.close(b)}},a.remove=function(){c.close(null)}}]).controller("ToolOutputSettingsCtrl",["$scope","$uibModal","$uibModalInstance",function(a,b,c){a.isCreate&&(a.outputForm={id:"",name:"",type:""}),a.confirm=function(){if(!a.formOutputSettings.$invalid){var b=angular.copy(a.outputForm);c.close(b)}},a.remove=function(){c.close(null)}}]).controller("ToolSettingsCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","Tools","toolData","userList",function(a,b,c,d,e,f,g,h){var i=a.toolForm=angular.copy(a.toolData);!i.timeout||i.timeout<0?i.timeout=0:i.timeout=+i.timeout,a.notEditable=!!a.toolData.system_tool,i.whiteList=_.map(g.whiteList,function(a){return{name:a}}),i.blackList=_.map(g.blackList,function(a){return{name:a}}),i.whiteList.length?i.restrictExecUser="whiteList":i.blackList.length&&(i.restrictExecUser="blackList"),_.forEach(h,function(a){a.lowerName=a.name.toLowerCase()}),a.userList=_.sortBy(h,"lowerName"),a.restrictExecUserChanged=function(){"whiteList"===i.restrictExecUser?i.blackList=[]:i.whiteList=[]},a.isFormChanged=function(){var a=_.pick(i,"defaultExecUser","authUsers","restrictExecUser","whiteList","blackList","timeout");"whiteList"===a.restrictExecUser?a.whiteList=_.map(a.whiteList,"name"):a.whiteList=[],"blackList"===a.restrictExecUser?a.blackList=_.map(a.blackList,"name"):a.blackList=[],delete a.restrictExecUser;var b=_.some(a,function(a,b){return!angular.equals(a,g[b])});return b},a.store=function(){if(!a.formToolSettings.$invalid){var h=_.pick(i,"defaultExecUser","authUsers","restrictExecUser","whiteList","blackList","timeout");"whiteList"===h.restrictExecUser?h.whiteList=_.map(h.whiteList,"name"):h.whiteList=[],"blackList"===h.restrictExecUser?h.blackList=_.map(h.blackList,"name"):h.blackList=[],delete h.restrictExecUser;var j=_.some(h,function(a,b){return!angular.equals(a,g[b])});if(!j)return void d.alert({type:"warning",message:"没有任何变更！"});if(h.defaultExecUser||(h.defaultExecUser="root"),h.whiteList.length&&!_.includes(h.whiteList,h.defaultExecUser)||h.blackList.length&&_.includes(h.blackList,h.defaultExecUser))return void d.alert({type:"warning",message:"默认执行用户 (服务器用户) 不被允许执行，请重新设置！"});a.storing=!0,f.updateTool(i.toolId,h).then(function(){c.success("保存工具成功"),b.go("tools.tool.detail",null,{reload:!0})}).catch(function(b){a.storing=!1,e(b,"保存工具")})}}}]).controller("ToolStoreCtrl",["$scope","$state","$uibModal","Dialog","handleAjaxError","toastr","Tools","checkPermission","IMPORT_ERROR",function(a,b,c,d,e,f,g,h,i){a.permissionOfCreateOrEdit=h("tools.create")||h("tools.tool.edit"),a.loading=!0,g.getToolsInstore().then(function(b){a.loading=!1,a.toolsInStore=b}).catch(function(b){a.loading=!1,e(b,"查询工具商店")});var j=function(a,b){var d=c.open({templateUrl:"views/tools/_overwrite-file.html",backdrop:"static",controller:"ToolOverwriteFileCtrl",resolve:{pkg:function(){return a},duplicateError:function(){return b}}});return d.result};a.importTool=function(c,f,h){c.importing=!0,g.importToolFromStore(c.toolId,f,h).then(function(a){d.alert({type:"success",message:"工具已导入",callback:function(){b.go("tools.tool.detail",{toolId:a.toolId})}})}).catch(function(b){if(b.data.code===i.DUPLICATE_KEY_AND_NAME||b.data.code===i.DUPLICATE_NAME||b.data.code===i.DB_ERROR_DUPLICATE_KEY||130307===b.data.code){var d=b.data,f=d.data.error,g=d.data.pkgInfo;j(g,f).then(function(b){a.importTool(c,!0,b)})}else e(b,"导入工具")}).finally(function(){c.importing=!1})}}]).controller("ToolImportCtrl",["$scope","$state","Dialog","handleAjaxError","toastr","Upload","$uibModal","IMPORT_ERROR",function(a,b,c,d,e,f,g,h){function i(){j=null,$('form[name="formImportTool"] input[name="attachment"]').val(null)}var j;a.drop=function(a){j=a},a.$watch("invalidFile",function(a){a&&c.alert({type:"warning",message:a.name+": 文件不符合条件，请选择一个 tar.gz 或 tar 文件",callback:i})});var k=function(a,b){var c=g.open({templateUrl:"views/tools/_overwrite-file.html",backdrop:"static",controller:"ToolOverwriteFileCtrl",resolve:{pkg:function(){return a},duplicateError:function(){return b}}});return c.result};a.submit=function(e,g){if(!j)return void c.alert({type:"warning",message:"请先选择一个 tar.gz 或 tar 文件"});a.submitting=!0,e=g?_.assignIn({},{file:j},e):{file:j};var i=f.upload({url:"/api/tools/import",data:e});i.then(function(a){return a.data.toolId?void c.alert({type:"success",message:"工具已导入",callback:function(){b.go("tools.tool.detail",{toolId:a.data.toolId})}}):void d(a,"导入工具")},function(b){if(b.data.code===h.DUPLICATE_KEY_AND_NAME||b.data.code===h.DUPLICATE_NAME||b.data.code===h.DB_ERROR_DUPLICATE_KEY||130307===b.data.code){var c=b.data,e=c.data.error,f=c.data.pkgInfo;k(f,e).then(function(b){a.submit(b,!0)},function(){a.submitting=!1})}else d(b,"导入工具"),a.submitting=!1})}}]).controller("ToolOverwriteFileCtrl",["$scope","$timeout","handleAjaxError","Dialog","Upload","$uibModalInstance","pkg","duplicateError",function(a,b,c,d,e,f,g,h){a.pkg=g,a.duplicateDetail={},a.duplicateDetail.error=h,h.idError&&h.nameError?(a.duplicateDetail.title="重复的工具ID和名称",a.duplicateDetail.type=2):h.idError?(a.duplicateDetail.title="重复的工具ID",a.duplicateDetail.type=3):h.nameError&&(a.duplicateDetail.title="重复的工具名称",a.duplicateDetail.type=4),a.change=function(b){a.renameForm=!1;var c={newName:"",force:!0,newId:!1};"rename"===b?d.prompt({message:"请输入新工具的名称",value:g.name,required:!0,pattern:"[\\-\\w一-龥]{1,45}",invalidTips:"请输入1至45个字符，只能包含中文、字母、数字、横杠或下划线",resolved:function(b){c.newName=b,c.newId=2===a.duplicateDetail.type,f.close(c)}}):"replace"===b?(c.newName=a.pkg.name,f.close(c)):"keepBoth"===b&&d.prompt({message:"请输入新工具的名称",value:g.name,required:!0,pattern:"[\\-\\w一-龥]{1,45}",invalidTips:"请输入1至45个字符，只能包含中文、字母、数字、横杠或下划线",resolved:function(a){c.newName=a,c.newId=!0,f.close(c)}})}}]).controller("ToolExecuteCtrl",["$scope","$state","$aside","$stateParams","$sessionStorage","$localStorage","$window","Utils","Dialog","handleAjaxError","Tools","toolData",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){return l.whiteList&&l.whiteList.length?_.includes(l.whiteList,a):!l.blackList||!l.blackList.length||!_.includes(l.blackList,a)}function n(b){var d=a.$new(!0);t=c.open({templateUrl:"views/tools/_execution-detail.html",scope:d,backdrop:"static",size:"lg",controller:"ToolExecutionCtrl",resolve:{executionResult:["Tools","handleAjaxError",function(a,c){return a.getExecutionResult(b.execId).catch(function(a){a.data&&120602===a.data.code?i.alert({type:"error",message:"你没有工具结果查询的权限"}):c(a)})}]}}),t.result.then(null,function(a){_.isObject(a)&&j(a,"查看工具执行结果")})}var o=a.executionData={execUser:l.defaultExecUser,inputList:angular.copy(l.inputs)};"powershell"===l.type&&(a.executionData.execUser="Administrator",a.isWindows=!0);var p=e.toolRetryData,q=f.toolkitSendData;if(p){if(delete e.toolRetryData,p.toolId===l.toolId){o.agents=p.agents.join(", ");var r=p.inputs;r&&angular.forEach(o.inputList,function(a){r.hasOwnProperty(a.name)&&("int"===a.type?a.value=+r[a.name]:a.value=r[a.name])});var s=p.execUser;s&&(o.execUser=s)}}else d.fromToolkit&&q?(delete f.toolkitSendData,o.agents=_.map(q,"ip").join(", ")):_.forEach(o.inputList,function(a){"int"===a.type?a.value=+a.default:a.value=a.default});a.selectDevices=function(a){o.agents=_.uniq(_.map(a,"ip")).join(", ")},a.$watch("executionData.agents",function(){var b=h.matchIps(o.agents);o.selectedIps=b,a.agentsCount=b?b.length:0}),a.selectDevicesForInput=function(a,b){b.selectedIps=_.uniq(_.map(a,"ip")),b.value=b.selectedIps.join(", ")},a.inputItemChange=function(a){"ips"===a.type&&(a.selectedIps=h.matchIps(a.value))},a.execute=function(){if(!a.formExecuteTool.$invalid){var b=h.matchIps(o.agents);if(b){var c=o.execUser;if(!m(c))return void i.alert({type:"warning",message:a.$parent.toolData.execUserRestriction});var d={};angular.forEach(o.inputList,function(a){d[a.name]=""+(a.value||"")}),a.executing=!0,k.executeTool(l.toolId,{agents:b,inputs:d,execUser:c}).then(function(a){n(a)}).catch(function(a){a.data&&120602===a.data.code?i.alert({type:"error",message:"启动工具执行失败！你没有工具的执行权限或目标主机的运维权限。"}):j(a,"启动工具执行")}).finally(function(){a.executing=!1})}}};var t;a.$on("$destroy",function(){t&&t.dismiss()})}]).controller("ToolExecutionCtrl",["$scope","$timeout","$state","$sessionStorage","toastr","handleAjaxError","Tools","checkPermission","executionResult",function(a,b,c,d,e,f,g,h,i){function j(){function c(){t=!0,s=(s+1)%3,a.activeDot=(a.activeLog?"\n":"")+"...".substr(0,s+1),q=b(c,500)}switch(a.executionResult.status[a.activeAgent]){case"success":case"failed":k(),a.activeDot="";break;default:t||(k(),c())}}function k(){t=!1,q&&(b.cancel(q),q=null)}function l(a){o&&(o.dismiss(),o=null),g.getExecutionResult(a,null,{track:!1}).then(m).catch(function(a){o=f(a,"查询工具执行结果")})}function m(c){a.executionResult||(a.executionResult={});var d=_.merge(a.executionResult,c);a.activeAgent||(a.activeAgent=d.agents[0]),a.totalStartTime=_.min(_.values(d.startTime)),_.forEach(d.msg,function(a,b){d.msg[b]=$.trim(a)}),a.activeLog=d.msg[a.activeAgent],d.agents.length&&j();var f=!0;switch(d.totalStatus){case"success":case"failed":case"failedPartly":f=!1,a.totalEndTime=_.max(_.values(d.endTime));break;default:a.totalEndTime=null,n(d.execId)}if(a.executing=f,!f&&r&&r!==d.totalStatus){switch(d.totalStatus){case"success":e.success("工具执行成功");break;case"failed":case"failedPartly":e.error("工具执行失败")}"run"!==d.totalStatus&&(a.canExport=!0,a.canCopyIPs=_.chain(d.status).some(function(a){return"failed"===a}).value(),a.failedIPs=_.chain(d.status).keys().filter(function(a){return"failed"===d.status[a]}).value(),a.exportUrl="/api/tools/export/"+d.execId)}f&&a.userSettings.autoScrollLogs&&b(function(){var a=$(".modal-content");a.length?a.scrollToBottom():$("body").scrollToBottom()}),r=d.totalStatus}function n(a){p=b(function(){p=null,l(a)},2e3)}a.outputsEnabled=!_.isEmpty(i.toolOutputs)&&!_.every(i.toolOutputs,_.isEmpty),a.activeTabIndex=a.outputsEnabled?"toolOutputs":"agentOutputs";var o,p,q,r,s=0,t=!1;a.activeDot="",a.canExport=!1,a.canCopyIPs=!1,a.failedIPs=[],a.exportUrl="",a.userSettings={},"run"!==i.totalStatus&&(a.canExport=!0,a.canCopyIPs=_.chain(i.status).some(function(a){return"failed"===a}).value(),a.failedIPs=_.chain(i.status).keys().filter(function(a){return"failed"===i.status[a]}).value(),a.exportUrl="/api/tools/export/"+i.execId);var u=a.toolData=i.toolData;a.permissionOfExecute=h("tools.tool.execute",function(a){if(!u||!u.authUsers||!u.authUsers.length)return!0;var b=[u.creator].concat(u.authUsers);return _.includes(b,a)}),a.setActiveAgent=function(b){b!==a.activeAgent&&(a.activeAgent=b,a.activeLog=a.executionResult.msg[a.activeAgent],j())},m(i),a.retry=function(){d.toolRetryData=_.pick(i,["toolId","agents","inputs","execUser"]),c.go("tools.tool.execute",{toolId:i.toolId})},a.$on("$destroy",function(){p&&b.cancel(p),k()})}]),angular.module("tools.service",[]).factory("Tools",["RequestWrapper",function(a){return{fetchToolList:function(b){return a.array({method:"GET",url:"/api/tools/tool",params:b})},getToolStyles:function(){return a.object({method:"GET",url:"/api/tools/styles"})},storeTool:function(b){return a.object({method:"POST",url:"/api/tools/tool",data:b})},fetchTool:function(b){return a.object({method:"GET",url:"/api/tools/tool/"+b})},updateTool:function(b,c){return a.object({method:"PUT",url:"/api/tools/tool/"+b,data:c})},removeTool:function(b){return a.object({method:"DELETE",url:"/api/tools/tool/"+b})},executeTool:function(b,c){return a.object({method:"POST",url:"/api/tools/tool/"+b+"/execution",data:c})},getExecutionResult:function(b,c,d){return a.object({method:"GET",url:"/api/tools/execution/"+b,params:c},d)},debugTool:function(b){return a.object({method:"POST",url:"/api/tools/debug",data:b})},getExecutionHistory:function(b){return a.object({method:"GET",url:"/api/tools/execution",params:b})},getToolCategories:function(){return a.array({method:"GET",url:"/api/tools/categories"})},getToolsInstore:function(){return a.array({method:"GET",url:"/api/tools/store"})},importToolFromStore:function(b,c,d){var e={method:"POST",url:"/api/tools/store/import/"+b};return c&&(e=_.assignIn({},{data:d},e)),a.object(e)}}}]),function(){function a(a,b,c){var d,e,f,g="error"===b||"false"!==b;switch(b="error"!==b&&"false"!==b,a){case"success":d=b?"成功":"",e="text-success",f="fa fa-check";break;case"failed":d=g?"失败":"",e="text-danger",f="fa fa-warning";break;case"failedPartly":d=g?"部分失败":"",e="text-warning",f="fa fa-warning";break;case"wait":d="";break;case"paused":d=b?"暂停":"",f="fa fa-pause-circle";break;default:d=b?"执行中":"",f="fa fa-spinner fa-spin"}return d&&c&&(d=c+d),{text:d,textClass:e,iconClass:f}}angular.module("tools.directive",[]).directive("toolResult",["$compile",function(b){return{restrict:"A",scope:{status:"="},replace:!0,link:function(c,d,e){d.html("<i></i> {{text}}"),b(d.contents())(c),c.$watch("status",function(b){var f=a(b,e.showText,e.preText);c.text=f.text,d.removeClass(),f.textClass&&d.addClass(f.textClass);var g=d.find("i").removeClass();f.iconClass&&g.addClass(f.iconClass)})}}}]).directive("toolAgentResult",[function(){return{restrict:"EA",scope:{status:"="},link:function(b,c){b.$watch("status",function(b){var d=a(b);c.removeClass(),d.textClass&&c.addClass(d.textClass),d.iconClass&&c.addClass(d.iconClass)})}}}]).directive("toolIcon",[function(){function a(a,b){var c=a[0];_.forEach(c.className?c.className.split(/\s+/):[],function(b){/^fa(-|$)/.test(b)&&"fa-fw"!==b&&a.removeClass(b)}),a.addClass("fa fa-"+b)}return{restrict:"A",scope:{icon:"=toolIcon"},link:function(b,c){b.$watch("icon",function(b){a(c,b)})}}}])}(),angular.module("help",[]).directive("bnLazySrc",["$window","$document",function(a,b){function c(a){function b(b,c){if(!a.is(":visible"))return!1;null===h&&(h=a.height());var d=a.offset().top,e=d+h;return d<=c&&d>=b||e<=c&&e>=b||d<=b&&e>=c}function c(){g=!0,e()}function d(a){f=a,g&&e()}function e(){a[0].src=f}var f=null,g=!1,h=null;return{isVisible:b,render:c,setSource:d}}function d(a,b,d){var f=new c(b);e.addImage(f),d.$observe("bnLazySrc",function(a){f.setSource(a)}),a.$on("$destroy",function(){e.removeImage(f)})}var e=function(){function c(a){l.push(a),m||h(),u||i()}function d(a){for(var b=0;b<l.length;b++)if(l[b]===a){l.splice(b,1);break}l.length||(g(),j())}function e(){if(!m){var a=q.height();a!==r&&(r=a,h())}}function f(){for(var a=[],b=[],c=o.height(),d=o.scrollTop(),e=d,f=e+c,h=0;h<l.length;h++){var i=l[h];i.isVisible(e,f)?a.push(i):b.push(i)}for(var k=0;k<a.length;k++)a[k].render();l=b,g(),l.length||j()}function g(){clearTimeout(m),m=null}function h(){m=setTimeout(f,n)}function i(){u=!0,o.on("resize.bnLazySrc",k),p.on("scroll.bnLazySrc",k),s=setInterval(e,t)}function j(){u=!1,o.off("resize.bnLazySrc"),p.off("scroll.bnLazySrc"),clearInterval(s)}function k(){m||h()}var l=[],m=null,n=100,o=$(a),p=o,q=b,r=q.height(),s=null,t=2e3,u=!1;return{addImage:c,removeImage:d}}();return{link:d,restrict:"A"}}]).factory("Access",["$http","RequestWrapper",function(a,b){return{fetchAccessKey:function(){return b.object({method:"GET",url:"/api/access-key"})}}}]).constant("helpPage",function(a,b,c){a.state(b,{url:c,templateUrl:function(a){var b=a.page;return b?"views/help/markdown/"+b+".html":"views/help/agent.html"},controller:"HelpAgentCtrl",resolve:{agentKey:["$stateParams","RequestWrapper",function(a,b){return b.object({url:"/api/agent/key",method:"GET"}).then(function(a){return a&&a.data})}]}})}).config(["$stateProvider","helpPage",function(a,b){b(a,"help.agent","/agent"),b(a,"monitor.collector.home.agent","/agent"),b(a,"monitor.collector.home.link","/link?page")}]).config(["$stateProvider",function(a){a.state("help",{url:"/help",abstract:!0,templateUrl:"views/help/home.html",controller:"HelpCtrl"}).state("help.doc",{url:"/doc?page",templateUrl:function(a){var b=a.page;return b?"views/help/markdown/"+b+".html":"views/help/agent.html"},controller:"HelpAgentCtrl",resolve:{agentKey:["$stateParams","RequestWrapper",function(a,b){return a.page?null:b.object({url:"/api/agent/key",method:"GET"}).then(function(a){return a&&a.data})}]}}).state("help.openapi",{url:"/openapi",templateUrl:"views/help/open-api.html",controller:"HelpOpenApiCtrl"})}]).controller("HelpCtrl",["$scope","$state",function(a,b){a.navDocActive=function(a){return a?b.includes("help.doc",{page:a}):b.includes("help.doc",{page:null})},a.navApiActive=function(){return b.includes("help.openapi")}}]).controller("HelpAgentCtrl",["$scope","$window","IS_SYSTEM_ADMIN","agentKey","checkPermission",function(a,b,c,d,e){var f="没有权限";if(a.permissionOfInstallAgent=e("cmdb:agent_install"),a.isAdmin=function(){return c},d){var g=b.location.origin+"/agent/sh/"+d+"/install.sh";a.installUrl="curl -L "+g+" | bash",a.installProxyUrl="curl -L "+g+"?type=proxy | bash",a.installUrlByProxy='curl -H "Host:'+b.location.host+'" -L http://YOUR-PROXY-IP/agent/sh/'+d+"/install.sh?proxy_ip=YOUR-PROXY-IP | bash",a.installUrlWindows=g+"?os=windows",a.installUrlWindowsByProxy="http://YOUR-PROXY-IP/agent/sh/"+d+"/install.sh?os=windows&proxy_ip=YOUR-PROXY-IP",a.hideProxyTips=!0}a.permissionOfInstallAgent||(a.installUrl=a.installProxyUrl=a.installUrlByProxy=a.installUrlWindows=a.installUrlWindowsByProxy=f)}]).controller("HelpOpenApiCtrl",["$scope","IS_SYSTEM_ADMIN","Access",function(a,b,c){a.isAdmin=function(){return b},a.showing=!1,a.showKey=function(){a.showing=!a.showing},a.isAdmin()&&c.fetchAccessKey().then(function(b){a.accessKey=b.access_key,a.secretKey=b.secret_key}).catch(function(){}).finally(function(){})}]),angular.module("flows.service",[]).factory("Flows",["RequestWrapper",function(a){return{fetchFlowList:function(b){return a.array({method:"GET",url:"/api/flows/flow",params:b})},fetchFlow:function(b){return a.object({method:"GET",url:"/api/flows/flow/"+b})},storeFlow:function(b){return a.object({method:"POST",url:"/api/flows/flow",data:b})},updateFlow:function(b,c){return a.object({method:"PUT",url:"/api/flows/flow/"+b,data:c})},removeFlow:function(b){return a.object({method:"DELETE",url:"/api/flows/flow/"+b})},executeFlow:function(b,c){return a.object({method:"POST",url:"/api/flows/flow/"+b+"/task",data:c})},getTaskResult:function(b,c){return a.object({method:"GET",url:"/api/flows/task/"+b},c)},getTaskHistory:function(b){return a.object({method:"GET",url:"/api/flows/task",params:b})},continueExecute:function(b,c){return a.object({method:"POST",url:"/api/flows/task/"+b+"/continue/"+c})},skipExecute:function(b,c,d){return a.object({method:"POST",url:"/api/flows/task/"+b+"/skip/"+c,data:{skipSteps:d}})},retryStep:function(b,c){return a.object({method:"POST",url:"/api/flows/task/"+b+"/retry/"+c})}}}]),angular.module("flows.task",[]).controller("FlowsTaskCtrl",["$scope","$aside","$window","$timeout","$sce","$state","$sessionStorage","$location","toastr","handleAjaxError","Dialog","Flows","checkPermission","taskResult",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){return $(".flow-execution-panel").width()}function p(){return c.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight-document.querySelector(".flow-execution-panel").offsetHeight-60}function q(){var b=a.$$phase;"$apply"!==b&&"$digest"!==b&&a.$digest()}function r(){z.setSize([o(),p()])}function s(){var b=180,c=$("#flow-timeline"),d=c.width(),e=Math.ceil(d/b),f=d3.scaleUtc().domain([0,C]).range([0,d]),g=_.map(f.ticks(e),function(a){return+a});g.length<2&&(g=_.range(Math.max(1,e)+1));var h=g[g.length-1],i=_.find(J,function(a){return h>=a.unitRange});a.timelineLabels=_.chain(g).filter(function(a){return(1-a/C)*d>=60}).map(function(a){return{text:a?a/i.unitRange+" "+H[i.unitName]:"0",left:a/C*100+"%"}}).value()}function t(a){D=d(function(){D=null,u(a)},2e3)}function u(a){E&&(E.dismiss(),E=null),l.getTaskResult(a,{track:!1}).then(v).catch(function(a){E=j(a,"查询流程执行结果")})}function v(b){a.taskResult||(a.taskResult={});var c=_.merge(a.taskResult,b);_.some(c.stepList,{stepId:0})&&_.forEach(c.stepList,function(a){a.stepId+=1}),_.forEach(c.stepList,function(a,b){var c;c=a.stepId?_.find(y,{stepId:a.stepId}):y[b+1],c.$.setStatus(a.status)}),_.forEach(z.links,function(a){"success"!==a.source.$.status&&a.source!==z.startNode||("gateway"===a.source.type&&"gateway"===a.target.type?0===a.source.exitStatus&&a.$.setStatus("passed"):_.includes(["executing","success","failed"],a.target.$.status)&&a.$.setStatus("passed"))});var d="executing"===c.totalStatus;d&&(c.endTime=null),_.forEach(c.stepList,function(b,d){0===d?b.times.stepStartTime=c.startTime:b.times.stepStartTime=a.taskResult.stepList[d-1].times.stepEndTime});var f=c.endTime;if(f||(f=_.chain(c.stepList).map("times").map(function(a){return _.values(a)}).flatten().compact().max().value()),C=f-c.startTime,C<0&&(C=0),_.forEach(c.stepList,function(a){if("wait"!==a.status){a.costTime=a.times.stepEndTime-a.times.stepStartTime,a.progressStyle={width:a.costTime/C*100+"%",marginLeft:(a.times.stepStartTime-c.startTime)/C*100+"%"};var b=[{key:"request",text:"下发",value:a.times.toolStartTime-a.times.stepStartTime},{key:"execution",text:"执行",value:(a.times.toolEndTime||a.times.stepEndTime)-a.times.toolStartTime}];a.progressWidths={},a.progressTitle=e.trustAsHtml('<div class="text-left">'+_.map(b,function(b){return a.progressWidths[b.key]=b.value/a.costTime*100+"%",b.text+": "+ +(b.value/1e3).toFixed(b.value>1e4?1:3)+"s"}).join("<br/>")+"</div>")}}),s(),d)t(c.taskId);else if(G&&G!==c.totalStatus)switch(c.totalStatus){case"success":i.success("流程执行成功");break;case"failed":i.error("流程执行失败")}G=c.totalStatus}function w(){F&&d.cancel(F),F=d(s,300)}function x(b,c){var d=_.find(a.taskResult.stepList,function(a){return"failed"===a.status});d?(b&&b(),a.retrying=!0,l.retryStep(a.taskResult.taskId,d.stepId).then(function(){f.reload()}).catch(function(b){c&&c(),a.retrying=!1,j(b,"重试交付流水线任务")})):k.alert({type:"warning",message:"没有失败的步骤！"})}a.outputsEnabled=!_.isEmpty(n.flowOutputs)&&!_.every(n.flowOutputs,_.isEmpty),a.activeTabIndex="executing"!==n.totalStatus&&a.outputsEnabled?"flowOutputs":"flowchart";var y=angular.copy(n.stepList);_.some(y,"root")&&_.some(y,"_x")&&_.some(y,"_y")?_.forEach(y,function(a){a.root&&delete a.parents}):_.forEach(y,function(a,b){0===b?a.root=!0:a.parents=[{stepId:b}],a.uid=_.uniqueId("step"),a.stepId=b+1,a.type="task",a._x=200+150*b,a._y=100}),a.showTimeline=!_.some(y,function(a){return a.parents&&a.parents.length>1}),_.forEach(y,function(a,b){"plugin"===a.type&&(a.type="task",a.plugin=!0),a.parents&&_.forEach(a.parents,function(c){var d=_.find(y,function(a){return a.stepId===c.stepId});if(d){d.children||(d.children=[]);var e={index:b,stepId:a.stepId,detail:a,sourcePoint:c.sourcePoint,targetPoint:c.targetPoint};0===c.if?e.branch="yes":1===c.if&&(e.branch="no"),d.children.push(e)}}),delete a.parents});var z,A,B=".flow-viewport-execution";d(function(){var b={keyId:"uid",appendTo:B,baseHref:h.url(),size:[o(),p()],zoomEnabled:!0,classed:"execution",selectNodeEnabled:!0,dragNodeEnabled:!1,appendLinkEnabled:!1,selectLinkEnabled:!1,guideLineEnabled:!1,shortcutsEnabled:!1};z=new Flowchart({nodes:y},b),z.on("activeChange",function(b,c){if("node"===b&&c&&"task"===c.type){var d=_.find(a.taskResult.stepList,{stepId:c.stepId});d||(d=a.taskResult.stepList[c.stepId-1]),d&&(d.execId?a.showStepDetail(d):i.warning("步骤暂未执行"))}else A&&A.dismiss();q()});var c,d,e;z.zooms.on("start",function(){var a=d3.event.transform;c=a.x,d=a.y,e=a.k}).on("end",function(){var a=d3.event.transform,b=a.x,f=a.y,g=a.k;e===g&&Math.abs(b-c)+Math.abs(f-d)<4&&z.unsetActive()}),v(n)}),$(c).on("resize",r);var C,D,E,F,G;a.permissionOfExecute=m("flows.flow.execute");var H={millisecond:"ms",second:"s",minute:"m",hour:"h",day:"d",week:"W",month:"M",year:"Y"},I={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5,week:6048e5,month:24192e5,year:314496e5},J=_.chain(I).map(function(a,b){return{unitRange:a,unitName:b}}).orderBy("unitRange","desc").value();a.showStepDetail=function(c){A&&A.dismiss();var d=a.$new();d.step=c,A=b.open({templateUrl:"views/flows/_task-step-detail.html",scope:d,backdrop:!1,windowClass:"no-backdrop",size:"lg",controller:"FLowsTaskStepDetailCtrl"})},$(c).on("resize",w),a.retryAgain=function(){g.flowRetryData=_.pick(n,["flowId","flowAgents","flowInputs"]),f.go("flows.flow.execute",{flowId:n.flowId})},a.retryStep=function(a,b){k.confirm({type:"warning",message:"确定要从失败步骤开始重试吗？",resolved:function(){x(a,b)}})},a.$on("$destroy",function(){D&&d.cancel(D),$(c).off("resize",w),$(c).off("resize",r)})}]).controller("FLowsTaskStepDetailCtrl",["$scope","$timeout","handleAjaxError","Tools","Dialog","$uibModalInstance",function(a,b,c,d,e,f){function g(){function c(){p=!0,o=(o+1)%3,a.activeDot=(a.activeLog?"\n":"")+"...".substr(0,o+1),n=b(c,500)}switch(a.executionResult.status[a.activeAgent]){case"success":case"failed":h(),a.activeDot="";break;default:p||(h(),c())}}function h(){p=!1,n&&(b.cancel(n),n=null)}function i(a){l&&(l.dismiss(),l=null),d.getExecutionResult(a,null,{track:!1}).then(j).catch(function(a){120602===a.data.code?(e.alert({type:"danger",message:a.data.message}),f.dismiss()):l=c(a,"查询工具执行结果")})}function j(b){a.executionResult||(a.executionResult={});var c=_.merge(a.executionResult,b);switch(a.activeAgent=c.agents[0],"executing"===a.step.status?a.totalStartTime=_.min(_.values(c.startTime)):(a.totalStartTime=a.step.times.stepStartTime,a.totalEndTime=a.step.times.stepEndTime),_.forEach(c.msg,function(a,b){c.msg[b]=$.trim(a)}),a.activeLog=c.msg[a.activeAgent],g(),c.totalStatus){case"success":case"failed":case"failedPartly":a.step.executionResult=c;break;default:a.totalEndTime=null,k(c.execId)}"run"!==c.totalStatus&&(a.canExport=!0,a.canCopyIPs=_.chain(c.status).some(function(a){return"failed"===a}).value(),a.failedIPs=_.chain(c.status).keys().filter(function(a){return"failed"===c.status[a]}).value(),a.exportUrl="/api/tools/export/"+c.execId)}function k(a){m=b(function(){m=null,i(a)},2e3)}var l,m,n,o=0,p=!1;a.activeDot="",a.canExport=!1,a.canCopyIPs=!1,a.failedIPs=[],a.exportUrl="",a.setActiveAgent=function(b){b!==a.activeAgent&&(a.activeAgent=b,a.activeLog=a.executionResult.msg[a.activeAgent],g())},a.step.executionResult?j(a.step.executionResult):i(a.step.execId),a.$on("$destroy",function(){m&&b.cancel(m),h()})}]),angular.module("flows",["url.matcher"]).config(["$stateProvider",function(a){a.state({name:"flows.**",url:"/flow",lazyLoad:function(){return System.import("flows/states").then(function(a){return a.default})}})}]),angular.module("flows.create",[]).config(["$stateProvider",function(a){a.state("flows.create",{url:"/create",templateUrl:"views/flows/create.html",controller:"FlowsCreateCtrl",resolve:{flowData:function(){return null},toolListData:["Tools",function(a){return a.fetchToolList({detail:"true",plugin:"true"})}],deps:["depends",function(a){return a("components/flowchart")}]}})}]).controller("FlowsCreateCtrl",["$scope","$state","$stateParams","$timeout","$uibModal","$window","$location","toastr","Dialog","Utils","handleAjaxError","Flows","beforeLeave","flowData","toolListData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){var b=a.$$phase;"$apply"!==b&&"$digest"!==b&&a.$digest()}function q(){var a=d3.mouse(z[0]),b=C.getZoomTransform();return b.invert(a)}function r(){var a=window.innerHeight-document.querySelector(".navbar").offsetHeight-65;C.setSize([z.width(),a])}function s(a){"task"===a.type&&_.defaults(a,{inputSrc:{},inputField:{},agentSrc:K,agentField:M})}function t(){if(null!==a.activeStep){var b=_.filter(C.getAncestors(a.activeStep),function(a){return a.toolData});a.inputSrcList=[L,K].concat(b),a.whenSrcList=[K].concat(b)}}function u(b){a.activeStep.stepName&&a.activeStep.stepName!==b||(a.activeStep.stepName=a.activeStep.toolData.name),a.activeStep.execUser=a.activeStep.toolData.defaultExecUser,"powershell"===a.activeStep.toolData.type&&(a.activeStep.execUser="Administrator"),a.activeStep.inputSrc={},v(a.activeStep)}function v(a){angular.forEach(x,function(b){_.forEach(b.inputSrc,function(c,d){c===a&&(b.inputSrc[d]=null,b.inputField[d]=null)}),b.agentSrc===a&&(b.agentSrc=null,b.agentField=null)})}function w(a){function b(a){for(var b=!1,c=0;c<a.length;c++){var d=a[c];if(d.parents&&d.parents.length>1){b=!1;break}b=!0}if(b){var e=_.chain(a).reject({root:!0}).map(function(a){return a.parents[0].stepId}).value(),f=_.uniq(e);e.length!==f.length&&(b=!1)}if(b){var g=_.findIndex(a,{root:!0});a.unshift(a[g]),a.splice(g+1,1);var h=[0];h.push(_.findIndex(a,{root:!0})),_.forEach(a,function(b,c){if(0!==c&&b.parents&&b.parents[0].stepId!==b.stepId-1){var d=_.findIndex(a,function(a,c){return a.stepId===b.parents[0].stepId});a.splice(c,0,a[d]);for(var e=0;e<a.length;e++){var f=a[e];if(f.stepId===a[c].stepId&&e!==c){a.splice(e,1);break}}}})}}var c,d={name:J.name,flowInputs:angular.copy(J.inputList),flowOutputs:angular.copy(J.flowOutputs),stepList:[]},e=[],f=C.getData();if(f.invalid){var g="";return f.circled?g="circled":f.detached?g="detached":f.noStart&&(g="noStart"),{invalid:!0,invalidDetail:g,data:[]}}return e=f.nodes,d.stepList=[],_.some(e,function(b,f){var g=f+1,h={stepId:g};if("task"===b.type){var i;if(b.agentSrc.isConst&&(i=j.matchIps(b.agentField),i||(c=b)),c||(b.toolData&&b.stepName&&b.agentSrc&&b.agentField&&b.execUser?_.some(b.inputSrc,function(a,c){return a&&!b.inputField[c]})&&(c=b):c=b),c&&!a)return!0;h.stepName=b.stepName,h.toolId=b.toolData?b.toolData.toolId:null,h.execUser=b.execUser,h.failureExit=b.failureExit,b.toolData.system_plugin&&(h.plugin=!0);var k=b.agentSrc.isConst?"#":_.indexOf(e,b.agentSrc)+1,l=b.agentSrc.isConst?i.join(" "):b.agentField===M?"@":b.agentField;h.agents=k+"."+l,angular.forEach(b.inputSrc,function(a,c){if(a&&b.inputField[c]){var d=a.isConst?"#":_.indexOf(e,a)+1;h.inputs||(h.inputs={});var f=b.inputField[c];h.inputs[c]=d+"."+(a.isConst||f!==M?f:"@");
}})}else"exclusive"===b.subtype&&"fork"===b.action?(h.stepName=b.stepName,h.branchLayout=b.branchLayout,h.when=[],_.forEach(b.whenList,function(a){if(a.src){var b="";switch(a.field){case M:b="@";break;case"返回码":b="$",a.threshold=+a.threshold;break;default:b=a.field}h.when.push({key:_.indexOf(e,a.src)+1+"."+b,comparator:a.comparator,threshold:a.threshold})}})):"join"===b.action&&(h.parent_type="exclusive"===b.subtype?"or":"and");return _.assign(h,_.pick(b,["type","_x","_y"])),"gateway"===h.type&&_.assign(h,_.pick(b,["subtype","action"])),_.forEach(C.links,function(a){if("start"===a.source.type)return void(a.target===b&&(h.root=!0,h._dx=a.source._x-h._x,h._dy=a.source._y-h._y));if(a.target===b){h.parents||(h.parents=[]);var c=_.find(_.find(e,a.source).children,function(a){return b.stepId?a.stepId===b.stepId:a.uid===b.uid}),d={stepId:_.indexOf(e,a.source)+1,sourcePoint:c.sourcePoint,targetPoint:c.targetPoint};a.branch&&(d.if=+("no"===a.branch)),h.parents.push(d)}}),d.stepList.push(h),!1}),b(d.stepList),{data:d,invalidStep:c}}a.isCreate=!n,a.isEdit=!a.isCreate,a.thresholdRegex="";var x=[];a.isEdit?(x=angular.copy(n.stepList),_.some(x,"root")||_.forEach(x,function(a,b){0===b?a.root=!0:a.parents=[{stepId:b}],a.stepId=b+1,a.type="task",a._x=200+150*b,a._y=100})):x=[{root:!0,_x:200,_y:100}],_.forEach(x,function(b,c){if("plugin"===b.type&&(b.type="task",b.plugin=!0),!a.isCreate&&"task"===b.type&&b.toolData){var d=_.keys(b.inputs),e=_.map(b.toolData.inputs,"name"),f=_.difference(d,e);_.forEach(f,function(a){delete b.inputs[a]})}"task"===b.type&&_.isNil(b.failureExit)&&(b.failureExit=!0),b.uid=_.uniqueId("step"),b.parents&&_.forEach(b.parents,function(a){var d=_.find(x,function(b){return b.stepId===a.stepId});if(d){d.children||(d.children=[]);var e={index:c,stepId:b.stepId,detail:b,sourcePoint:a.sourcePoint,targetPoint:a.targetPoint};0===a.if?e.branch="yes":1===a.if&&(e.branch="no"),d.children.push(e)}}),delete b.parents});var y=".flow-viewport",z=$(y),A=window.innerHeight-document.querySelector(".navbar").offsetHeight-65,B={keyId:"uid",appendTo:y,baseHref:g.url(),size:[z.width(),A],zoomEnabled:!0,pullToLeft:a.isCreate},C=new Flowchart({nodes:x},B);a.canUndo=!1,a.canRedo=!1,C.on("history",function(){a.canUndo=C.history.canUndo(),a.canRedo=C.history.canRedo(),p()});var D,E,F={code:[{value:"equal",text:"等于"},{value:"notEual",text:"不等于"}],content:[{value:"contain",text:"包含"},{value:"notContain",text:"不包含"}]};C.on("activeChange",function(b,c){!c||"link"===b&&"exclusive-fork"!==c.source.$.category||"node"===b&&"parallel-fork"===c.$.category?(a.showPanels=!1,a.activeStep=null,a.currentType=null,D=E=null):"link"===b&&"exclusive-fork"===c.source.$.category?(a.showPanels=!0,a.activeLink=c,a.currentType=b,D=b,E=c.source.$.category):("gateway"===c.type&&"exclusive-fork"===c.$.category&&(c.whenList=_.map(c.whenList,function(a){return"返回码"===a.field?a.comparatorList=F.code:a.comparatorList=F.content,a})),c.toolId||delete c.toolData,"task"===c.type&&(c.failureExit=!!_.isNil(c.failureExit)||c.failureExit),a.showPanels=!0,a.activeStep=c,a.currentType=b,D=c.type,E=c.$.category),p()}),C.on("err",function(a){switch(a){case"multiRoot":return void h.error("流程只能有一个起点");case"linkToStart":return void h.error("不允许连回起点");case"removeStart":return void h.error("不能删除起点");default:return void h.error("流程存在错误")}}),a.isActive=function(a,b){return a===D&&!("gateway"===a&&b!==E)},a.remove=function(){var b=a.currentType;if(b)switch(b){case"node":"start"===a.activeStep.type?h.error("不能删除起点"):C.removeNode();break;case"link":C.unlink()}},C.on("stateChange",function(b){a.linking=b===Flowchart.STATE_LINKING,p()}),a.undo=function(){C.undo()},a.redo=function(){C.redo()},a.link=function(){C.toLink()};var G,H=d3.select(f.document.body),I=d3.drag().on("start",function(){d3.event.sourceEvent.stopPropagation(),d3.event.sourceEvent.preventDefault(),C.idle(),H.classed("flow-dragging",!0);var a=q(),b=d3.select(this);G={uid:_.uniqueId("step"),type:b.attr("data-type"),_new:!0,_temp:!0,_x:a[0],_y:a[1]},"gateway"===G.type&&(G.subtype=b.attr("data-subtype")||"exclusive",G.action=b.attr("data-action")||"fork"),C.appendTempNode(G)}).on("drag",function(){var a=q();G._x=a[0],G._y=a[1],C.alignToGuide(G),G.$.tick()}).on("end",function(){H.classed("flow-dragging",!1),C.hideGuide().removeTempNode(G);var b=d3.mouse(z[0]);b[0]>0&&b[1]>0&&(delete G._temp,s(G),a.submitted=!1,C.appendNode(G).setActive("node",G))});d3.selectAll(".flowchart-drag-btn").call(I),$(f).on("resize",r);var J;J=n?a.flowForm=_.pick(n,"name","inputList","flowOutputs"):a.flowForm={inputList:[],flowOutputs:{dimensions:[],columns:[]}};var K={stepName:"流程输入",toolData:{}},L={stepName:"-- 常量 --",isConst:!0,toolData:{}},M="流程目标IP",N=o;angular.forEach(N,function(a){a.inputList=angular.copy(a.inputs),a.outputList=_.map(a.toolOutputs.columns,"id"),a.gatewayOutputList=a.outputList.concat(["返回码"])}),angular.forEach(x,function(a){if("task"===a.type){a.toolData=angular.extend({},a.toolData,_.find(N,{toolId:a.toolId})),a.execUser=a.execUser||a.toolData.defaultExecUser||"root","powershell"===a.toolData.type&&(a.execUser="Administrator");var b=(a.agents||"0.@").split("."),c="#"===b[0],d=+b[0],e=b.slice(1).join(".");a.agentSrc=c?L:d?x[d]:K,a.agentField=c||"@"!==e?e:M,s(a),angular.forEach(a.inputs,function(b,c){var d=b.split(".");if(d){var e="#"===d[0],f=+d[0],g=d.slice(1).join(".");a.inputSrc[c]=e?L:f?x[f]:K,a.inputField[c]=e||"@"!==g?g:M}})}else"gateway"===a.type&&"exclusive"===a.subtype&&"fork"===a.action&&(a.whenList=[],_.forEach(a.when,function(b){var c=b.key.split(".");if(c){var d=+c[0],e=c.slice(1).join("."),f="";switch(e){case"@":f=M;break;case"$":f="返回码";break;default:f=e}a.whenList.push({src:d?x[d]:K,field:f,comparator:b.comparator,threshold:b.threshold})}}))}),a.outputTypeList=[{value:"",text:"无"},{value:"taskStatus",text:"任务状态"}],a.getOutputTypeText=function(b){var c=_.find(a.outputTypeList,{value:b});return b&&c?c.text:""},a.inputsSortableOptions={containerPositioning:"relative",containment:"#flow-form-preview"},a.inputsSortableEnabled=!1,a.dimensionsSortableOptions={containerPositioning:"relative",containment:"#table-outputs-dimensions"},a.dimensionsSortableEnabled=!1,a.columnsSortableOptions={containerPositioning:"relative",containment:"#table-outputs-columns"},a.columnsSortableEnabled=!1,a.addInput=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0;var c=e.open({templateUrl:"views/tools/_input-settings.html",backdrop:"static",scope:b,controller:"ToolInputSettingsCtrl"});c.result.then(function(a){J.inputList.push(a)})},a.showInputSettings=function(b){if(!a.storing){var c=a.$new(!0);c.inputForm=angular.copy(b),c.isEdit=!0,c.isCreate=!1;var d=e.open({templateUrl:"views/tools/_input-settings.html",backdrop:"static",scope:c,controller:"ToolInputSettingsCtrl"});d.result.then(function(a){a?_.assign(b,a):_.remove(J.inputList,b)})}},a.addOutputsDimension=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0,b.outputTypeList=a.outputTypeList;var c=e.open({templateUrl:"views/tools/_output-dimension.html",backdrop:"static",scope:b,controller:"ToolOutputSettingsCtrl"});c.result.then(function(a){J.flowOutputs.dimensions.push(a)})},a.showOutputsDimensionSettings=function(b){var c=a.$new(!0);c.outputForm=angular.copy(b),c.isEdit=!0,c.isCreate=!1,c.outputTypeList=a.outputTypeList;var d=e.open({templateUrl:"views/tools/_output-dimension.html",backdrop:"static",scope:c,controller:"ToolOutputSettingsCtrl"});d.result.then(function(a){a?_.assign(b,a):_.remove(J.flowOutputs.dimensions,b)})},a.removeOutputsDimension=function(a){_.remove(J.flowOutputs.dimensions,a)},a.addOutputsColumn=function(){var b=a.$new(!0);b.isEdit=!1,b.isCreate=!0,b.outputTypeList=a.outputTypeList;var c=e.open({templateUrl:"views/tools/_output-column.html",backdrop:"static",scope:b,controller:"ToolOutputSettingsCtrl"});c.result.then(function(a){J.flowOutputs.columns.push(a)})},a.showOutputsColumnSettings=function(b){var c=a.$new(!0);c.outputForm=angular.copy(b),c.isEdit=!0,c.isCreate=!1,c.outputTypeList=a.outputTypeList;var d=e.open({templateUrl:"views/tools/_output-column.html",backdrop:"static",scope:c,controller:"ToolOutputSettingsCtrl"});d.result.then(function(a){a?_.assign(b,a):_.remove(J.flowOutputs.columns,b)})},a.removeOutputsColumn=function(a){_.remove(J.flowOutputs.columns,a)},a.previewOutputs=function(){var b=a.$new(!0);b.outputs=J.flowOutputs,e.open({templateUrl:"views/tools/_preview-outputs.html",backdrop:"static",scope:b,size:J.flowOutputs.dimensions.length+J.flowOutputs.columns.length>=5?"xlg":"md"})},a.$watch("flowForm.inputList",function(a){K.toolData.outputList=_.chain(a).map("name").compact().push(M).value()},!0),a.addWhen=function(){a.activeStep.whenList||(a.activeStep.whenList=[]),a.activeStep.whenList.push({src:null,field:null,comparator:"equal"})},a.removeWhen=function(b){a.activeStep.whenList.splice(b,1)},a.$watch("activeStep",function(){a.activeStepIndex=a.activeStep?_.indexOf(x,a.activeStep)+1:null,a.formCreateStep.name.$setUntouched(),t()}),a.$watch("activeStep.stepName",function(){a.activeStep&&a.activeStep.$.renderText()}),a.$watch("activeStep.branchLayout",function(){a.activeStep&&"exclusive-fork"===a.activeStep.$.category&&(_.forEach(a.activeStep._links,function(b){b.data.source===a.activeStep&&b.tick()}),a.activeStep.$.tickBranches())}),a.subtypeChanged=function(){a.activeStep.$.changeJoinSubtype()},a.linkTypeChanged=function(){var b=a.activeLink;b.$.setText(b.branch.toUpperCase())},a.validateExecUser=function(b,c){a.formCreateStep.execUser.$valid&&(c.whiteList&&c.whiteList.length?(b=b.trim(),c.whiteList.indexOf(b)<0&&a.formCreateStep.execUser.$setValidity("pattern",!1)):c.blackList&&c.blackList.length&&c.blackList.indexOf(b)>-1&&a.formCreateStep.execUser.$setValidity("pattern",!1))},a.selectTool=function(){var b=a.$new(!0);b.toolId=a.activeStep.toolData&&a.activeStep.toolData.toolId;var c=e.open({templateUrl:"views/flows/_select-tool.html",backdrop:"static",scope:b,controller:"FlowSelectToolCtrl",resolve:{toolList:function(){return N}}});c.result.then(function(b){var c=a.activeStep.toolData&&a.activeStep.toolData.name;a.activeStep.toolId=b.toolId,a.activeStep.toolData=b,b.system_plugin&&(a.activeStep.plugin=!0),u(c)})},a.whenFieldChanged=function(b){"返回码"===b.field?(b.comparatorList=F.code,a.thresholdRegex="^\\d+$"):(b.comparatorList=F.content,a.thresholdRegex="")},a.agentSrcChanged=function(){a.activeStep.agentField=null,d(function(){$('.form-control[name="agentField"]').focus()})},a.inputSrcChanged=function(b){a.activeStep.inputField[b]=null;var c=a.activeStep.inputSrc[b];c&&d(function(){$('.form-control[name="field_'+b+'"]').focus()})},a.appendStepTooltipOpen=!0;var O;a.isEdit&&(O=_.pick(n,"name","flowInputs","flowOutputs"),O.stepList=_.map(n.stepList,function(a){return _.pick(a,"stepName","toolId","agents","inputs")})),a.store=function(){if(a.submitted=!0,a.formCreateFlow.$invalid)return void C.setActive("node",C.startNode);if(x.length<2)return void i.alert({type:"warning",message:"流程需要包含至少一个步骤！"});var c=w(),d=c.data,e=c.invalidStep;if(c.invalid){var f="流程存在问题，请修改后保存。";switch(c.invalidDetail){case"circled":f="流程存在回环，请去除回环。";break;case"detached":f="流程存在分离的步骤";break;case"noStart":f="流程没有起点。"}return void i.alert({type:"warning",message:f})}return e?void C.setActive("node",e):(d.stepList.forEach(function(a){a.plugin&&(a.type="plugin",delete a.plugin)}),a.storing=!0,void(a.isEdit?l.updateFlow(n.flowId,d).then(function(){h.success("修改流程成功"),b.go("flows.flow.detail",null,{reload:!0})}).catch(function(b){k(b,"修改流程"),a.storing=!1}):l.storeFlow(d).then(function(a){h.success("创建流程成功"),b.go("flows.flow.detail",a)}).catch(function(b){k(b,"创建流程"),a.storing=!1})))},a.$on("$destroy",function(){$(f).off("resize",r)})}]).controller("FlowSelectToolCtrl",["$scope","$timeout","$uibModalInstance","Tools","handleAjaxError","toolList",function(a,b,c,d,e,f){function g(a,b){return{category:b,list:a}}function h(a){return a.category.toLowerCase()}function i(a){return a.name.toLowerCase()}f=_.sortBy(f,i);var j=_.chain(f).groupBy("category").map(g).sortBy(h).value();a.toolListGroup=j,a.toolForm={toolId:a.toolId},a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.toolListGroup=_.chain(f).filter(function(a){return a.name.toLowerCase().indexOf(b)!==-1}).groupBy("category").map(g).sortBy(h).value()):void(a.toolListGroup=j)},a.selectTool=function(a){c.close(a)},b(function(){$(".selected","#select-flow-tool").scrollIntoView(!1)})}]),angular.module("flows.detail",[]).config(["$stateProvider",function(a){a.state("flows.flow.detail",{url:"",templateUrl:"views/flows/detail.html",controller:"FlowsDetailCtrl",resolve:{deps:["depends",function(a){return a("components/flowchart")}]}})}]).controller("FlowsDetailCtrl",["$scope","$state","$stateParams","$timeout","$location","$window","toastr","Dialog","Utils","handleAjaxError","Flows","flowData",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){s.setSize([q.width(),q.height()])}function n(){a.removing=!0,k.removeFlow(l.flowId).then(function(){g.success("流程已删除"),b.go("flows.index")}).catch(function(a){j(a,"删除流程")}).finally(function(){a.removing=!1})}var o=angular.copy(l.stepList);a.exportUrl="/api/flows/flow/"+l.flowId+"/export",_.some(o,"root")?_.forEach(o,function(a){a.root&&delete a.parents}):_.forEach(o,function(a,b){0===b?a.root=!0:a.parents=[{stepId:b}],a.uid=_.uniqueId("step"),a.stepId=b+1,a.type="task",a._x=200+150*b,a._y=100}),_.forEach(o,function(a,b){"plugin"===a.type&&(a.type="task",a.plugin=!0),a.parents&&_.forEach(a.parents,function(c){var d=_.find(o,function(a){return a.stepId===c.stepId});if(d){d.children||(d.children=[]);var e={index:b,stepId:a.stepId,detail:a,sourcePoint:c.sourcePoint,targetPoint:c.targetPoint};0===c.if?e.branch="yes":1===c.if&&(e.branch="no"),d.children.push(e)}}),delete a.parents});var p=".flow-viewport-detail",q=$(p),r={keyId:"uid",appendTo:p,baseHref:e.url(),size:[q.width(),q.height()],zoomEnabled:!0,crispEdges:!1,classed:"readonly",interactEnabled:!1},s=new Flowchart({nodes:o},r);$(f).on("resize",m),a.removeFlow=function(){h.confirm({isDelete:!0,message:"确认要删除流程 <code>"+i.escapeHtml(l.name)+"</code> 吗？",html:!0,resolved:function(){n()}})},a.$on("$destroy",function(){$(f).off("resize",m)})}]),angular.module("flows.edit",[]).config(["$stateProvider",function(a){a.state("flows.flow.edit",{url:"/edit?step",templateUrl:"views/flows/create.html",controller:"FlowsCreateCtrl",resolve:{toolListData:["Tools",function(a){return a.fetchToolList({detail:"true",plugin:"true"})}],deps:["depends",function(a){return a("components/flowchart")}]}})}]),angular.module("flows.execute",[]).config(["$stateProvider",function(a){a.state("flows.flow.execute",{url:"/execute",templateUrl:"views/flows/execute.html",controller:"FlowsExecuteCtrl"})}]).controller("FlowsExecuteCtrl",["$scope","$state","$sessionStorage","Utils","handleAjaxError","Flows","flowData",function(a,b,c,d,e,f,g){var h=a.executeForm={inputList:angular.copy(g.inputList)},i=c.flowRetryData;if(i){if(delete c.flowRetryData,i.flowId===g.flowId){h.agents=i.flowAgents.join(", ");var j=i.flowInputs;j&&angular.forEach(h.inputList,function(a){j.hasOwnProperty(a.name)&&("int"===a.type?a.value=+j[a.name]:a.value=j[a.name])})}}else _.forEach(h.inputList,function(a){"int"===a.type?a.value=+a.default:a.value=a.default});a.selectDevices=function(a){h.agents=_.map(a,"ip").join(", ")},a.$watch("executeForm.agents",function(){var b=d.matchIps(h.agents);h.selectedIps=b,a.agentsCount=b?b.length:0}),a.selectDevicesForInput=function(a,b){b.selectedIps=_.uniq(_.map(a,"ip")),b.value=b.selectedIps.join(", ")},a.inputItemChange=function(a){"ips"===a.type&&(a.selectedIps=d.matchIps(a.value))},a.execute=function(){if(!a.formExecuteFlow.$invalid){var c=d.matchIps(h.agents);if(c){var i={};angular.forEach(h.inputList,function(a){"ips"===a.type?i[a.name]=a.value.split(/,\s?/).join(" "):i[a.name]=""+(a.value||"")}),a.executing=!0,f.executeFlow(g.flowId,{flowAgents:c,flowInputs:i}).then(function(a){b.go("task.flows",{event_id:a.taskId})}).catch(function(b){e(b,"启动流程执行"),a.executing=!1})}}}}]),angular.module("flows.import",[]).config(["$stateProvider",function(a){a.state("flows.import",{url:"/import",templateUrl:"views/flows/import.html",controller:"FlowsImportCtrl"})}]).controller("FlowsImportCtrl",["$scope","$state","Dialog","handleAjaxError","toastr","Upload","$uibModal","IMPORT_ERROR",function(a,b,c,d,e,f,g,h){function i(){j=null,$('form[name="formImportFlow"] input[name="attachment"]').val(null)}var j;a.drop=function(a){j=a},a.$watch("invalidFile",function(a){a&&c.alert({type:"warning",message:a.name+": 文件不符合条件，请选择一个 tar.gz 或 tar 文件",callback:i})});var k=function(a,b){var c=g.open({templateUrl:"views/flows/_overwrite-file.html",backdrop:"static",controller:"FlowsOverwriteFileCtrl",resolve:{pkg:function(){return a},duplicateError:function(){return b}}});return c.result};a.submit=function(e,g){if(!j)return void c.alert({type:"warning",message:"请先选择一个 tar.gz 或 tar 文件"});a.submitting=!0,e=g?_.assignIn({},{file:j},e):{file:j};var i=f.upload({url:"/api/flows/import",data:e});i.then(function(a){return a.data.flowId?void c.alert({type:"success",message:"流程已导入",callback:function(){b.go("flows.flow.detail",{flowId:a.data.flowId})}}):void d(a,"导入流程")},function(b){if(b.data.code===h.DUPLICATE_KEY_AND_NAME||b.data.code===h.DUPLICATE_NAME||b.data.code===h.DB_ERROR_DUPLICATE_KEY||130307===b.data.code){var c=b.data,e=c.data&&c.data.error||c.error,f=c.data&&c.data.pkgInfo;k(f,e).then(function(b){a.submit(b,!0)},function(){a.submitting=!1})}else d(b,"导入流程"),a.submitting=!1})}}]).controller("FlowsOverwriteFileCtrl",["$scope","$timeout","handleAjaxError","Dialog","Upload","$uibModalInstance","pkg","duplicateError",function(a,b,c,d,e,f,g,h){a.pkg=g,a.duplicateDetail={},a.duplicateDetail.error=h,h.idError&&h.nameError?(a.duplicateDetail.title="重复的流程ID和名称",a.duplicateDetail.type=2):h.idError?(a.duplicateDetail.title="重复的流程ID",a.duplicateDetail.type=3):h.nameError&&(a.duplicateDetail.title="重复的流程名称",a.duplicateDetail.type=4),a.change=function(b){a.renameForm=!1;var c={newName:"",force:!0,newId:!1};"rename"===b?d.prompt({message:"请输入新流程的名称",value:g.name,required:!0,pattern:"[\\-\\w一-龥]{1,45}",invalidTips:"请输入1至45个字符，只能包含中文、字母、数字、横杠或下划线",resolved:function(b){c.newName=b,c.newId=2===a.duplicateDetail.type,f.close(c)}}):"replace"===b?(c.newName=a.pkg.name,f.close(c)):"keepBoth"===b&&d.prompt({message:"请输入新流程的名称",value:g.name,required:!0,pattern:"[\\-\\w一-龥]{1,45}",invalidTips:"请输入1至45个字符，只能包含中文、字母、数字、横杠或下划线",resolved:function(a){c.newName=a,c.newId=!0,f.close(c)}})}}]),angular.module("feedback",["feedback.service","feedback.list","feedback.detail"]).config(["$stateProvider",function(a){a.state("newFeedback",{url:"/feedback",templateUrl:"views/feedback/feedback.html",controller:"FeedbackCtrl"})}]).controller("FeedbackCtrl",["$scope","$window","handleAjaxError","Dialog","Utils","Upload",function(a,b,c,d,e,f){function g(a){a.preventDefault()}a.feedbackForm={attachments:[],replyExpected:!1},a.drop=function(b){b&&b.length&&a.feedbackForm.attachments.push.apply(a.feedbackForm.attachments,b)},a.$watch("invalidFiles",function(a){if(a&&a.length){var b=_.map(a,"name").join(", ");d.alert({type:"warning",message:b+" 等 "+a.length+" 个文件不符合条件"})}}),a.removeAttachment=function(b){a.feedbackForm.attachments=_.filter(a.feedbackForm.attachments,function(a){return a!==b})},a.submit=function(){if(!a.formFeedback.$invalid){a.submitting=!0;var e=f.upload({url:"/api/feedback",data:_.pick(a.feedbackForm,"title","content","attachments","replyExpected")});e.then(function(){d.confirm({type:"success",message:"感谢您的反馈和支持！点击确定将回到前一个页面",resolved:function(){b.history.back()}})},function(b){c(b,"提交反馈"),a.submitting=!1})}},$(b).on("dragover drop",g),a.$on("$destroy",function(){$(b).off("dragover drop",g)})}]),angular.module("feedback.service",[]).factory("Feedback",["RequestWrapper",function(a){return{getFeedbackList:function(b){return a.array({method:"GET",url:"/api/feedback",params:b})},getFeedback:function(b){return a.object({method:"GET",url:"/api/feedback/item/"+b})}}}]),angular.module("feedback.list",[]).config(["$stateProvider",function(a){a.state("feedbackList",{url:"/feedback/list",templateUrl:"views/feedback/list.html",controller:"FeedbackListCtrl",resolve:{feedbackList:["Feedback",function(a){return a.getFeedbackList()}]}})}]).controller("FeedbackListCtrl",["$scope","feedbackList",function(a,b){a.feedbackList=b}]),angular.module("feedback.detail",[]).config(["$stateProvider",function(a){a.state("feedbackDetail",{url:"/feedback/detail/{id:\\w+}",templateUrl:"views/feedback/detail.html",controller:"FeedbackDetailCtrl",resolve:{feedbackDetail:["$stateParams","Feedback",function(a,b){return b.getFeedback(a.id)}]}})}]).controller("FeedbackDetailCtrl",["$scope","feedbackDetail",function(a,b){a.feedbackDetail=b}]),angular.module("cmdb.ctrl",["schedulers.service"]).controller("CmdbObjectCardsCtrl",["$scope","$state","$window","checkPermission","$uibModal","abjectData","OBJECTICONMAP","OBJECTBLACKLIST","Abject","toastr","Dialog","handleAjaxError","limit","Schedulers",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=m.data;a.permissionOfCreate=d("cmdb:object_create"),a.overLimit=!1,null===o.limit||o.remain?!o.remain&&a.permissionOfCreate||(a.canNotCreate="没权限!"):(a.overLimit=!0,a.canNotCreate="您已经创建"+o.limit+"个资源模型,已达上限");var p=f,q=_.groupBy(p,"category");a.multiObjects=q,a.allCatogery=_.sortBy(_.keys(q)),n.getSchedulersList({page_size:50,__sortby__:"-create_time",__select__:"id,name,disable,task_type"}).then(function(b){a.schedulersList=b.data}).catch(l),a.objectIconMap=function(a){return g[a]||"ti-layout-cta-left"},a.isShow=function(a){return"true"!==a.virtual&&!_.includes(h,a.objectId)};var r=[],s=[],t={};angular.forEach(f,function(a){r.push(_.toUpper(a.objectId)),s.push(a.name),t[_.toUpper(a.objectId)]=a.name});var u;a.addAbject=function(){var b=a.$new();b.allCatogery=_.sortBy(_.keys(q)),b.objectData={delete:"true",view:{visible:!0}},b.isEdit=!1,b.isCreate=!0,u=e.open({templateUrl:"views/cmdb/object/_add-abject.html",backdrop:"static",scope:b})},a.addAbjectConfirm=function(d){_.includes(r,_.toUpper(d.objectId))?k.alert({type:"warning",message:"ID: <code>"+d.objectId+"</code> 已存在, 对应资源是: <code>"+_.escape(t[_.toUpper(d.objectId)])+"</code>",html:!0}):_.includes(s,d.name)?k.alert({type:"warning",message:"资源名称:<code>"+d.name+"</code> 重复",html:!0}):(a.storing=!0,i.addAbject(d).then(function(a){j.success("资源模型已保存！"),u.close(),c.location.href=b.href("cmdb.object.detail",{objectId:a.data.objectId})}).catch(function(b){a.storing=!1,l(b,"新建资源模型")}))}}]).controller("CmdbObjectDetailCtrl",["$scope","$state","$stateParams","$uibModal","toastr","Abject","abjectData","modelData","OBJECTICONMAP","OBJECTBLACKLIST","ATTRTYPELIST","Dialog","handleAjaxError","checkPermission","OBJECT_INDEPENDENT_LIST","Schedulers",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(c){a.deleting=!0,f.deleteAbject(c).then(function(){e.success("资源模型已删除！"),b.go("cmdb.object.cards","",{reload:!0})}).catch(function(b){a.deleting=!1,m(b,"删除资源模型")})}var r=angular.copy(h.attrList);a.abjectAttrList=h,p.getSchedulersList({page_size:50,__sortby__:"-create_time",__select__:"id,name,disable,task_type"}).then(function(b){a.abjectAttrList.scheduler=_.find(b.data,function(b){return b.id===a.abjectAttrList.auto_detect}),a.schedulersList=b.data}).catch(m);var s=_.groupBy(g,"category");a.objectIconMap=function(a){return i[a]||"ti-layout-cta-left"},a.permissionOfEdit=a.permissionOfRemove=n("cmdb:"+h.objectId+"_object_manage"),a.sortableOptions={containerPositioning:"relative",containment:"#table-cmdb-model-attributes"},a.saveOrder=function(){var c=a.abjectAttrList.view;_.isObject(c)&&!_.isArray(c)||(c={}),c.attr_order=_.map(a.abjectAttrList.attrList,"id"),a.savingOrder=!0,f.updateAbject(a.abjectAttrList.objectId,{view:c}).then(function(){e.success("属性顺序已调整！"),b.reload()}).catch(function(b){a.savingOrder=!1,m(b,"保存属性顺序")})},a.cancelSort=function(){a.abjectAttrList.attrList=_.slice(r),a.sortableEnabled=!1},a.isShow=function(a){return"true"!==a.virtual&&!_.includes(j,a.objectId)};var t={},u={};angular.forEach(k,function(a){t[a.key]=a.text}),angular.forEach(g,function(a){u[a.objectId]=a.name}),a.typeNameMap=t,a.objectNameMap=u,a.deleteAbject=function(a,c,d){d>0?l.confirm({type:"warning",message:"资源 <code>"+_.escape(c)+'</code> 下有 <b><span class="text-danger">'+d+"</span></b> 个实例，不能删除该资源",html:!0,confirmText:"先删除实例",resolved:function(){b.go("cmdb.resources.index",{objectId:a})}}):l.confirm({type:"warning",message:"确定删除资源 <code> "+_.escape(c)+" </code> 吗?",isDelete:!0,html:!0,resolved:function(){q(a)}})};var v=[],w=[],x={};angular.forEach(g,function(a){v.push(_.toUpper(a.objectId)),w.push(a.name),x[_.toUpper(a.objectId)]=a.name});var y,z=_.map(_.filter(g,function(a){return!(_.includes(o,a.objectId)||"true"!==a.virtual&&!_.includes(j,a.objectId))}),"objectId");a.modifyAbject=function(b,c,e){var f=a.$new();f.allCatogery=_.sortBy(_.keys(s)),f.focusField=e,f.objectData={name:c.name,memo:c.memo,category:c.category,auto_detect:c.auto_detect,view:{visible:!_.has(c.view,"visible")||c.view.visible}},_.includes(z,h.objectId)&&(f.objectData.view.visible=!1),w=_.without(w,c.name),f.objectId=b,f.isEdit=!0,f.isCreate=!1,f.visibleDisabled=_.includes(z,h.objectId)||_.includes(o,h.objectId),y=d.open({templateUrl:"views/cmdb/object/_add-abject.html",backdrop:"static",scope:f})},a.modifyAbjectConfirm=function(c,d){_.includes(w,d.name)?l.alert({type:"warning",message:"资源名称:<code>"+d.name+"</code> 重复",html:!0}):(a.storing=!0,f.updateAbject(c,d).then(function(){e.success("资源模型已修改！"),y.close(),b.go("cmdb.object.detail",{objectId:c},{reload:!0})}).catch(function(b){a.storing=!1,m(b,"修改资源模型")}))}}]).controller("CmdbObjectAttrCtrl2",["$scope","$stateParams","$q","$filter","$uibModal","$state","beforeLeave","checkPermission","abjectAttrList","toastr","Dialog","handleAjaxError","Abject","abjectData","ATTRTYPELIST",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){a.abjectAttrList=null!==i?i.data:null,a.isCreate=!b.attrId,a.adding=!1;var p=i.data.objectId;a.permissionOfEdit=h("cmdb:"+p+"_object_manage"),a.categoryList=_.chain(i.data.attrList).map("category").compact().uniq().value(),a.typeList=o,a.attr={value:{},required:"false",readonly:"false",unique:"false",tag:[]},a.newAttr={value:{type:"str"},required:"false",readonly:"false",unique:"false",tag:[]},a.allAttrIds=["creator","ctime","instanceId","modifier","mtime","name","org"],a.allAttrNames=[];var q={};a.isCreate?(a.currentAttr=a.newAttr,a.unique=!1,a.readonly=!1,a.required=!1):(angular.forEach(i.data.attrList,function(a){q[a.id]=a.value.type}),a.currentAttr=_.find(i.data.attrList,{id:b.attrId}),a.unique="true"===a.currentAttr.unique,a.readonly="true"===a.currentAttr.readonly,a.required="true"===a.currentAttr.required),angular.forEach(a.abjectAttrList.attrList,function(b){a.allAttrIds.push(b.id),a.allAttrNames.push(b.name),a.isCreate||b.id!==a.currentAttr.id||a.allAttrIds.pop(),a.isCreate||b.name!==a.currentAttr.name||a.allAttrNames.pop()}),a.attrTypeChanged=function(b){a.attr.value.rule={},a.attr.value.external={},"FK"!==a.currentAttr.value.type&&"FKs"!==a.currentAttr.value.type||(a.required=a.unique=!1,b.required=b.unique="false")},a.attrIdInputYes=function(b){return!(_.includes(a.allAttrIds,b)||b&&"_"===b.substring(0,1))},a.isCustomAttrValid=function(){var b=a.currentAttr,c=!1;return b.id?a.isCreate&&!a.attrIdInputYes(b.id)?(c=!1,j.warning("重复的属性ID")):b.name?a.allAttrNames.indexOf(b.name)!==-1?(c=!1,j.warning("重复的属性名称")):b.value.type?c=!0:(c=!1,j.warning("请选择属性类型")):(c=!1,j.warning("请填写属性名称")):(c=!1,j.warning("请填写属性ID")),c&&("FK"!==b.value.type&&"FKs"!==b.value.type||(c=b.value.rule&&!!b.value.rule.obj,c||j.warning("请选择属性外键"))),c},a.setUnique=function(b){a.unique&&(a.required=!0,b.required="true"),b.unique=a.unique?"true":"false"},a.setReadonly=function(b){b.readonly=a.readonly?"true":"false"},a.setRequired=function(b){b.required=a.required?"true":"false"},a.addAttrConfirm=function(b){a.adding=!0,a.change(b)};var r;a.change=function(b,c,d,e){if(!b.$invalid&&a.isCustomAttrValid()){a.storing=!0;var g={value:{},tag:[]};if(a.modifingId=c.id,a.errorRegex=!1,g.name=c.name,g.value={},g.value.type=c.value.type,g.view=c.view,_.has(c.value,"default")&&(g.value.default=c.value.default),c.category&&g.tag.push(c.category),g.required=c.required,g.readonly=c.readonly,g.unique=c.unique,"enum"===c.value.type)g.value.regex=_.map(c.value.regex,"text");else if("FK"===c.value.type||"FKs"===c.value.type)g.value=angular.copy(c.value),_.forEach(g.value.external,function(a){delete a.protected});else try{var h=new RegExp(c.value.regex);h&&(g.value.regex=c.value.regex)}catch(b){a.errorRegex=!0,b instanceof SyntaxError}if(d){g.value.rule={},g.value.rule.obj=d;var k=[];angular.forEach(e,function(a){a.checked&&k.push({org_attr:a.id,name:a.name})}),g.value.external=k}if(a.errorRegex)j.error("正则有误"),a.storing=!1;else if(a.isCreate)g.id=c.id,"true"===g.unique&&(g.required="true"),m.addAttr(i.data.objectId,g).then(function(){j.success("保存成功"),f.go("cmdb.object.detail",{objectId:i.data.objectId},{reload:!0})}).catch(function(b){a.storing=!1,l(b,"添加属性")});else if("false"===c.custom){var n={name:g.name,tag:g.tag,value:{external:g.value.external},view:g.view};m.updateAttr(i.data.objectId,c.id,n).then(function(){j.success("保存成功"),d&&r.close(),f.go("cmdb.object.detail",{objectId:i.data.objectId},{reload:!0})}).catch(function(a){l(a,"修改属性")}).finally(function(){a.storing=!1})}else m.updateAttr(i.data.objectId,c.id,g).then(function(){j.success("保存成功"),d&&r.close(),f.go("cmdb.object.detail",{objectId:i.data.objectId},{reload:!0})}).catch(function(b){a.storing=!1,l(b,"修改属性")})}},a.choose_fk=function(b,c,d,f,g){var h=a.$new();h.fkId=b,h.fkMode=c,h.attrList={},g?h.addFlag=!0:h.addFlag=!1;var j=angular.copy(n);if(angular.forEach(j,function(a){h.attrList[a.objectId]=a.attrList}),h.checkedAtLeastOne=!1,h.all={checked:!1},h.modifing=!1,d){var k={};angular.forEach(d,function(a){k[a.org_attr]=a.name}),h.modifing=!0,h.originRow=angular.copy(f);var l=f.view&&f.view.visibleExternals||[],m=_.map(d,function(a){return a.org_attr}),o=!0;angular.forEach(h.attrList[b],function(a){_.includes(m,a.id)?(a.checked=!0,a.name=k[a.id],a.visible=_.includes(l,a.id),a.relationProtected=_.find(d,{org_attr:a.id}).protected):a.checked=!1,"name"===a.id&&(a.checked=!0),"HOST"===b?("ip"!==a.id&&"hostname"!==a.id||(a.checked=!0),"hostname"===a.id&&(a.visible=!0)):"name"===a.id&&(a.checked=!0,a.visible=!0),a.checked||(o=!1)}),h.all.checked=o}h.keyData={abjectId:i.data.objectId,abjectName:i.data.name,abjectData:j,abjectAttr:{}},h.makeNameChecked=function(a){angular.forEach(h.attrList[a],function(b){"HOST"===a?("ip"!==b.id&&"hostname"!==b.id||(b.checked=!0),"hostname"===b.id&&(b.visible=!0)):"name"===b.id&&(b.checked=!0,b.visible=!0)})},h.rowChecked=function(a){a.checked||(a.visible=!1);var b=!0;angular.forEach(h.attrList[h.fkId],function(a){a.checked?a.checked=!0:b=!1}),h.all.checked=b},h.allChecked=function(a){var b=h.all.checked;angular.forEach(h.attrList[a],function(c){"FK"===c.value.type||"FKs"===c.value.type?c.checked=!1:c.checked=b,"name"===c.id&&(c.checked=!0),"HOST"===a&&("ip"!==c.id&&"hostname"!==c.id||(c.checked=!0))})},h.visibleChecked=function(a){var b=_.map(_.filter(h.attrList[h.fkId],"visible"),"id");b=_.without(b,"HOST"===h.fkId?"hostname":"name"),b.length>1&&_.every(_.without(b,a.id),function(a){_.find(h.attrList[h.fkId],{id:a}).visible=!1})},r=e.open({templateUrl:"views/cmdb/object/_fk.html",backdrop:"static",scope:h})},a.addFK=function(b,c,d){var e="outer";a.currentAttr.value.rule={},a.currentAttr.value.rule.obj=b,a.currentAttr.value.rule.mode=c||e;var f=[];angular.forEach(d,function(a){a.checked&&f.push({org_attr:a.id,name:a.name})}),a.currentAttr.value.external=f,a.currentAttr.view={visibleExternals:_.without(_.map(_.filter(d,"visible"),"id"),"HOST"===b?"hostname":"name")},r.close()},a.deleteAbjAttr=function(a){k.confirm({type:"warning",message:"确定删除 "+a+" 属性吗?",html:!0,isDelete:!0,resolved:function(){
m.deleteAttr(i.data.objectId,a).then(function(){j.success("属性已删除！"),f.go("cmdb.object.detail",{objectId:i.data.objectId},{reload:!0})}).catch(function(a){l(a,"删除属性")})}})}}]).controller("CmdbAbstractCtrl",["$scope","$state","$stateParams","abjectData","OBJECTICONMAP","OBJECTBLACKLIST","$localStorage","IS_SYSTEM_ADMIN","USERNAME",function(a,b,c,d,e,f,g,h,i){a.navObjectActive=function(){return b.includes("cmdb.object.list")||b.includes("cmdb.object.attr",{type:null})||b.includes("cmdb.object.cards")||b.includes("cmdb.object.detail")||b.includes("cmdb.overview.graph")};var j=_.filter(d,function(a){return"true"!==a.virtual&&!_.includes(f,a.objectId)});j=_.filter(j,function(a){return _.has(a,"view")?_.has(a.view,"visible")||(a.view.visible=!0):a.view={visible:!0},a.view.visible}),a.multiObjects=_.groupBy(j,"category"),a.multiObjects["基础资源管理"]||(a.multiObjects["基础资源管理"]=[]),a.multiObjects["业务资源管理"]||(a.multiObjects["业务资源管理"]=[]);var k=_.find(d,{objectId:"HOST"}),l=_.find(d,{objectId:"APP"});a.hostModelName=k?k.name:"主机管理",a.appModelName=l?l.name:"应用管理",a.allCatogery=_.sortBy(_.keys(a.multiObjects)),a.allCatogery=_.chain(a.multiObjects).keys().sortBy().map(function(a){var b=_.find(g.sidebarCategories,{name:a});return{name:a,hide:!!b&&b.hide}}).value(),a.isShow=function(a){return"true"!==a.virtual&&!_.includes(f,a.objectId)},a.toggleCategory=function(b){b.hide=!b.hide,g.sidebarCategories=a.allCatogery},a.getObjectListStyle=function(){},setTimeout(function(){a.getObjectListStyle=function(b){var c=36,d=a.multiObjects[b.name].length,e=0;return"基础资源管理"!==b.name&&"业务资源管理"!==b.name||(d+=1),e=d*c,{height:e+"px"}}}),a.objectIcon=function(a){return e[a]||"ti-layout-cta-left"},a.navObjectInstanceActive=function(a){return b.includes("cmdb.resources",{objectId:a})},a.navDevicesActive=function(){return b.includes("cmdb.devices")},a.navAppsActive=function(){return b.includes("cmdb.apps")},g.objectInstancePageSize||(g.objectInstancePageSize={}),a.instancePageSize=function(a){return _.has(g.objectInstancePageSize,a+"_pageSize_local")?g.objectInstancePageSize[a+"_pageSize_local"]:15};var m={APP:{user:["owner","creator"],tips:"只有创建人和运维负责人才有权限"},HOST:{user:["owner","creator"],tips:"只有创建人和运维负责人才有权限"}};a.isAdmin=function(){return h},a.canModify=function(b,c){if(a.isAdmin())return!0;if("undefined"!=typeof b.__canModify)return b.__canModify;b.__canModify=!0;var d=m[c];if(!d)return!0;for(var e=d.user,f=0;f<e.length;f+=1){var g=e[f];if("creator"===g||"modifier"===g){if(i===b[g])return!0}else if(_.isArray(b[g])){for(var h=0,j=b[g].length;h<j;h+=1)if(i===b[g][h].name)return!0}else if(b[g]&&i===b[g].name)return!0}return b.__canModify=!1,!1},a.getPermTips=function(a){return m[a].tips}}]).controller("CmdbHostResolvedCtrl",["$scope","$state","$stateParams","Abject","unresolvedHostList","$localStorage","conflictInstanceList",function(a,b,c,d,e,f,g){a.requesting=!1,a.hostResolved=e.data.list,a.hostInfo={};for(var h=g.data.list,i=h.length,j=0;j<i;j+=1)a.hostInfo[h[j].instanceId]=h[j];a.moreHostInfo=function(a){var b="<div>主机名: "+a.hostname+"</div>";return a.osSystem&&(b+="<div>操作系统类型: "+a.osSystem+"</div>"),a.osDistro&&(b+="<div>操作系统发行版本: "+a.osDistro+"</div>"),a.agentVersion&&(b+="<div>agent版本: "+a.agentVersion+"</div>"),a.cpuModel&&(b+="<div>CPU型号: "+a.cpuModel+"</div>"),a.cpuHz&&(b+="<div>CPU频率(MHz): "+a.cpuHz+"</div>"),a.cpus&&(b+="<div>CPU总数: "+a.cpus+"</div>"),b},a.params=angular.copy(c),a.pagesizes=[15,30,50,100],a.totalItems=+e.data.total,f.objectInstancePageSize.HOSTRESOLVED_pageSize_local=+e.data.pageSize,a.params.pageSize=f.objectInstancePageSize.HOSTRESOLVED_pageSize_local,a.pageFilters={page:c.page||1},a.pageChange=function(c){a.params.page=c,b.go(b.current,a.params,{reload:!0})},a.resolveHost=function(c,e){if(!a.requesting){a.requesting=!0;var f={action:c,host:e};d.updateHostResolved(f).then(function(a){0===a.code&&b.go(b.current,null,{reload:!0})})}}}]),angular.module("cmdb.route",[]).config(["$stateProvider",function(a){a.state("cmdb",{abstract:!0,url:"/cmdb",resolve:{abjectData:["Abject",function(a){return a.fetchAbjectList()}]},templateUrl:"views/cmdb/cmdb.html",controller:"CmdbAbstractCtrl"}).state("cmdb.externals",{url:"?id",templateUrl:"views/externals.html",controller:"ExternalsCtrl",resolve:{linkData:["$stateParams","Externals",function(a,b){return b.getLinkById(a.id)}]}}).state("cmdb.object",{abstract:!0,url:"/object",template:"<div ui-view></div>"}).state("cmdb.object.cards",{url:"/cards",templateUrl:"views/cmdb/object/cards.html",controller:"CmdbObjectCardsCtrl",resolve:{limit:["CmdbResourceService",function(a){return a.getResourceLimit()}]}}).state("cmdb.object.detail",{url:"/detail/:objectId",templateUrl:"views/cmdb/object/objectDetail.html",resolve:{modelData:["CmdbModelService","$stateParams",function(a,b){return a.fetchModel(b.objectId)}]},controller:"CmdbObjectDetailCtrl"}).state("cmdb.object.attrEdit",{url:"/attr?objectId&attrId",templateUrl:"views/cmdb/object/attr2.html",resolve:{abjectAttrList:["Abject","$stateParams",function(a,b){return a.fetchAbjectAttrList(angular.copy(b))}]},controller:"CmdbObjectAttrCtrl2"}).state("cmdb.object.attrCreate",{url:"/create/:objectId",templateUrl:"views/cmdb/object/attr2.html",resolve:{abjectAttrList:["Abject","$stateParams",function(a,b){return a.fetchAbjectAttrList(angular.copy(b))}]},controller:"CmdbObjectAttrCtrl2"}).state("cmdb.object.hostResolved",{url:"/instance/:objectId/resolved?page&pageSize",templateUrl:"views/cmdb/object/_host_resolved_details.html",resolve:{unresolvedHostList:["Abject","$stateParams",function(a,b){return a.fetchHostResolved(_.defaults(b,{page:1,pageSize:15}))}],conflictInstanceList:["Abject","unresolvedHostList","$stateParams",function(a,b,c){for(var d=[],e=b.data.list,f=e.length,g=0;g<f;++g)d.push(e[g].conflictInstanceId);return a.fetchAbjectInstanceList({objectId:"HOST",pageSize:c.pageSize,filter:{instanceId:d}})}]},controller:"CmdbHostResolvedCtrl"})}]),angular.module("cmdb.service",["app.services"]).filter("userNameFilter",function(){return function(a,b){_.isArray(a)||(a=[a]);var c=_.map(a,function(a){return _.isObject(a)?a.name:a});return b&&(c=_.sortBy(c,function(a){return a?a.toLowerCase():""})),c.join("; ")}}).filter("cmdbFieldValueFormat",function(){function a(a){return function(b){var c="HOST"===a.value.rule.obj?"hostname":"name",d=a.view&&a.view.visibleExternals&&a.view.visibleExternals[0],e=b[c];return d&&b.hasOwnProperty(d)&&!_.isNil(b[d])&&(e+="("+b[d]+")"),e}}return function(b,c){if(_.isNil(b))return"";var d;switch(c&&c.value.type){case"FK":d=a(c)(b)||"";break;case"FKs":d=_.map(b,a(c)).join("; ");break;case"arr":d=_.join(b,"; ");break;default:d=b+""}return d}}).factory("Device",["RequestWrapper",function(a){return{fetchDeviceAllList:function(b){return a.object({method:"GET",url:"/api/deviceAllList",params:b})}}}]).factory("Business",["RequestWrapper",function(a){return{fetchAllList:function(b){return a.object({method:"GET",url:"/api/allList",params:{key:b}})}}}]).factory("Abject",["$window","RequestWrapper",function(a,b){return{fetchAbjectList:function(){return b.array({method:"GET",url:"/api/abjectList"})},fetchAbjectAttrList:function(a){return b.object({method:"GET",url:"/api/abjectAttrList/"+a.objectId})},changeAbjectAttrOrder:function(a,c){return b.object({method:"PUT",url:"api/abjectAttrOrder/"+a.objectId,data:c})},fetchAbjectInstanceList:function(a){return b.object({method:"GET",url:"/api/abjectInstanceList/"+a.objectId,params:a})},fetchAbjectInstanceListAll:function(a,c){return b.array({method:"GET",url:"/api/abjectInstanceListAll/"+a,params:{fields:c}})},searchAbjectInstanceList:function(a){return b.array({method:"GET",url:"/api/abjectInstanceList/search/"+a.objectId,params:a})},fetchAbjectInstanceAttrList:function(a,c,d,e){return b.object({method:"GET",url:"/api/abjectInstanceAttrDistinctList/"+a+"/"+c,params:{pageSize:d,filter:e}})},updateAttr:function(a,c,d){return b.object({method:"PUT",url:"/api/abjectAttrUpdate/"+a+"/"+c,data:d})},importInstance:function(a,c){return b.object({method:"POST",url:"/api/abjectInstanceImport/"+a,data:c})},addAttr:function(a,c){return b.object({method:"POST",url:"/api/abjectAttrAdd/"+a,data:c})},deleteAttr:function(a,c){return b.object({method:"DELETE",url:"/api/abjectAttrDelete/"+a+"/"+c})},deleteInstance:function(a,c){return b.object({method:"DELETE",url:"/api/abjectInstance/"+a+"/"+c})},updateInstance:function(a,c,d){return b.object({method:"PUT",url:"/api/abjectInstance/"+a+"/"+c,data:d})},getInstance:function(a,c){return b.object({method:"GET",url:"/api/abjectInstance/"+a+"/"+c})},updateAllInstance:function(a,c){return b.object({method:"PUT",url:"/api/abjectInstance/"+a,data:c})},instanceDownload:function(b,c){a.open("/api/instanceDownload/"+b+"?filter="+c,"_blank")},getInstanceHistory:function(a,c,d,e){return b.object({method:"GET",url:"/api/abjectInstanceHistory/"+a+"/"+c,params:{month:d,page:e}})},batchDelete:function(a,c){return b.object({method:"DELETE",url:"/api/abjectInstance/"+a,params:{ids:c.join(";")}})},batchUpdate:function(a,c,d,e){return b.object({method:"PUT",url:"/api/abjectInstance/"+a+"/attr/"+d,data:{ids:c.join(";"),value:e}})},getAppIpList:function(a){return b.object({method:"GET",url:"/api/abjectInstance/APP/"+a+"/ip"})},getAppVsList:function(a){return b.object({method:"GET",url:"/api/abjectInstance/APP/"+a+"/vs"})},getAppDnsList:function(a){return b.object({method:"GET",url:"/api/abjectInstance/APP/"+a+"/dns"})},addAppCluster:function(a,c){return b.object({method:"POST",url:"/api/abjectInstance/APP/"+a+"/cluster",data:c})},removeAppCluster:function(a,c){return b.object({method:"DELETE",url:"/api/abjectInstance/APP/"+a+"/cluster/"+c})},search:function(a){var c;c=a.q.search(/[\u4E00-\u9FA5\uF900-\uFA2D]/)===-1?"*"+a.q+"*":a.q;var d="_all_"===a.objectId?null:a.objectId;return b.object({method:"GET",url:"/api/abjectInstance/search",params:_.extend({},a,{q:c,objectId:d})})},addAbject:function(a){return b.object({method:"POST",url:"/api/abjectAdd/",data:a})},deleteAbject:function(a){return b.object({method:"DELETE",url:"/api/abjectDelete/"+a})},updateAbject:function(a,c){return b.object({method:"PUT",url:"/api/abjectUpdate/"+a,data:c})},objectSampleDownload:function(b){a.open("/api/objectSampleDownload/"+b)},fetchHostResolved:function(a){return b.object({method:"GET",url:"/api/storage/hostResolved/document",params:a})},updateHostResolved:function(a){return b.object({method:"PUT",url:"/api/storage/hostResolved/document",data:a})},getReferencedAbject:function(a){return b.array({method:"GET",url:"/api/abjectRef",params:a})},getInstanceReferencedAbject:function(a,c){return b.array({method:"GET",url:"/api/abjectRef/"+a,params:c})}}}]).factory("CmdbModelService",["RequestWrapper",function(a){return{fetchModel:function(b){return a.object({method:"GET",url:"/api/cmdb/model/"+b})},getImportableAttributes:function(b){return a.array({method:"GET",url:"/api/cmdb/model/"+b+"/attributes/importable"})}}}]).factory("CmdbResourceService",["RequestWrapper",function(a){return{fetchInstanceList:function(b,c){return a.array({method:"GET",url:"/api/cmdb/resource/"+b,params:{fields:_.join(c,",")}})},searchInstanceList:function(b,c){return a.object({method:"POST",url:"/api/cmdb/resource/"+b+"/search",data:c})},fetchInstance:function(b,c){return a.object({method:"GET",url:"/api/cmdb/resource/"+b+"/instance/"+c})},storeInstance:function(b,c){return a.object({method:"POST",url:"/api/cmdb/resource/"+b+"/instance",data:c})},updateInstance:function(b,c,d){return a.object({method:"PUT",url:"/api/cmdb/resource/"+b+"/instance/"+c,data:d})},removeInstance:function(b,c){return a.object({method:"DELETE",url:"/api/cmdb/resource/"+b+"/instance/"+c})},fetchInstanceChangelog:function(b,c,d){return a.array({method:"GET",url:"/api/cmdb/resource/"+b+"/instance/"+c+"/changelog",params:d})},getArchivedInstancesList:function(b){return a.array({method:"GET",url:"/api/cmdb/resource/"+b+"/instance/archive"})},archiveInstance:function(b,c){return a.object({method:"POST",url:"/api/cmdb/resource/"+b+"/instance/archive",data:c})},activateInstance:function(b,c){return a.object({method:"POST",url:"/api/cmdb/resource/"+b+"/instance/activate",data:c})},showAttributeAsTable:function(a,b){var c=a.value.type;return("FKs"===c||"FK"===c)&&a.value.external.length>=2&&!!b},getResourceLimit:function(){return a.object({method:"GET",url:"/api/resourceLimit"})}}}]).factory("UserService",["$q","CmdbResourceService",function(a,b){return{fetchUserAndGroupList:function(){var c=a.defer();return b.fetchInstanceList("USER_GROUP",["name"]).then(function(a){c.resolve(a)}).catch(function(){c.resolve([])}),a.all([b.fetchInstanceList("USER",["name"]),c.promise]).then(function(a){return _.map(a[0],function(a){return{type:"用户",className:"ui-select-match-item-of-user",name:a.name,display:a.name,key:"u:"+a.name}}).concat(_.map(a[1],function(a){return{type:"用户组",className:"ui-select-match-item-of-group",name:a.name,display:a.name,key:"g:"+a.name}}))})}}}]),angular.module("cmdb.directive",["ui.bootstrap","ui.router","app","cmdb.service","qgz.clusterType"]).directive("formField",function(){return{restrict:"E",replace:!0,scope:{method:"=method",field:"=field",form:"=form",formData:"=formData"},templateUrl:"/views/cmdb/object/_form-field.html",controller:"formFieldCtrl",link:function(a,b){a.isHidden()&&b.addClass("hidden")}}}).controller("formFieldCtrl",["$scope","$stateParams","$uibModal","Abject","HIDE_FIELD_LIST","clusterTypeConverter",function(a,b,c,d,e,f){a.field||(a.field={id:"",name:"",value:{}}),a.getType=function(){return a.field.value.type},a.$watch("field",function(){a._pattern=null}),a._pattern=null,a.getPattern=function(){if(!a._pattern){var b;b="enum"===a.getType()?[]:"name"===a.field.id&&"str"===a.getType()?".{1,255}":"";var c=a.field.value.regex||b;a._pattern=c}return a._pattern},a.getName=function(){return a.field.name.indexOf("(")?a.field.name.split("(")[0]:a.field.name.indexOf("（")?a.field.name.split("（")[0]:a.field.name},a.getId=function(){return a.field.id},a.getPlaceholder=function(){var b=a.field.name;return a.isRequired()&&(b+="，必填"),"enum"===a.getType()?b+"，单选":"date"===a.getType()||"datetime"===a.getType()?b+"，点击选择":a.getPattern().length?b+"，匹配正则 "+a.getPattern():"Fks"===a.getType()?b+"，多选":"FK"===a.getType()||"enum"===a.getType()?b+"，单选":"arr"===a.getType()?b+"，输入多个, 空格或回车保存":b},a.isRequired=function(){return"true"===a.field.required},a.allowClear=function(){return"true"===a.field.required?"false":"true"},a.isReadonly=function(){return"update"===a.method&&"true"===a.field.readonly},a.isForeignKey=function(){return["FK","FKs"].indexOf(a.getType())!==-1},a.getFkObj=function(){return a.field.value.rule.obj},a.isInnerKey=function(){return a.isForeignKey()&&"inner"===a.field.value.rule.mode},a.isList=function(){return["arr","FKs"].indexOf(a.getType())!==-1},a.isError=function(){var b=!1;return b=!(!a.form||!a.form[a.getId()])&&(a.form[a.getId()].$invalid&&!a.form[a.getId()].$pristine)},a.isHidden=function(){return e.indexOf(a.getId())!==-1},a.choices={},a.searchInstances=function(b,c){var e=200;return d.searchAbjectInstanceList({objectId:a.getFkObj(),q:b,pageSize:e,visibleExternals:(a.field.view&&a.field.view.visibleExternals||[]).join(",")}).then(function(b){a.choices[a.getFkObj()]||(a.choices[a.getFkObj()]=[]),angular.forEach(b,function(b){if(c&&a.formData[a.getId()]){var d=a.formData[a.getId()].indexOf(b.instanceId);d!==-1&&(a.formData[a.getId()][d]=b.instanceId)}for(var e=!1,f=0,g=a.choices[a.getFkObj()].length;f<g;f+=1)if(a.choices[a.getFkObj()][f].instanceId===b.instanceId){e=!0;break}e||a.choices[a.getFkObj()].push(b)})})};var g=function(){var b=a.getId();if(a.isForeignKey()&&!a.isInnerKey()&&a.formData[b]){var c;c=_.isArray(a.formData[b])?a.formData[b].join(","):a.formData[b],c+=",",a.searchInstances(c,!0)}"datetime"!==a.getType()&&"date"!==a.getType()||!a.formData[b]||angular.isString(a.formData[b])&&(a.formData[b]=new Date(a.formData[b].replace(/-/g,"/")))},h=!1;a.$watch("formData",function(a){_.isEmpty(a)||h||(h=!0,g())}),a.isList()&&!a.formData[a.getId()]&&(a.formData[a.getId()]=[]),a.formatEnumValue=function(b){return"CLUSTER"===a.objectId&&"type"===a.getId()?f.id2label(b):b},a.attrMap={},a.addInnerField=function(b){function e(){var d=c.open({templateUrl:"views/cmdb/object/_add-inner-field.html",backdrop:"static",size:"md",scope:g,controller:["$scope","$timeout","$stateParams","$uibModalInstance",function(a,b,c,d){a.ok=function(a){d.close(a)},a.cancel=function(){d.dismiss("cancel")},a.canSubmit=function(){return a.myform.$valid}}]});return d.result.then(function(b){f||(a.isList()?a.formData[a.getId()]?a.formData[a.getId()].push(b):a.formData[a.getId()]=[b]:a.formData[a.getId()]=b),a.form[a.getId()]={$dirty:!0},a.form.$setDirty()},function(){angular.copy(f,b)}),d}var f=angular.copy(b),g=a.$new(!0);if(g.innerField=a.field,g.innerFormData=b||{},g.method=b?"update":"add",g.attrMap=a.attrMap,_.isEmpty(g.attrMap)){var h={};angular.forEach(g.innerField.value.external,function(a){h[a.org_attr]=a.name}),d.fetchAbjectAttrList({objectId:g.innerField.value.rule.obj}).then(function(b){angular.forEach(b.data.attrList,function(b){a.attrMap[b.id]=b,b.name=h[b.id]||b.name}),e()})}else e()},a.removeInner=function(b){a.isList()?a.formData[a.getId()].splice(a.formData[a.getId()].indexOf(b),1):a.formData[a.getId()]=null,a.form[a.getId()]={$dirty:!0},a.form.$setDirty()},a.change=function(){a.form[a.getId()].$setTouched(),a.form[a.getId()].$setDirty()},a.popup={opened:!1},a.openPopup=function(){a.popup.opened=!0},a.paste2Select=function(a){var b=this,c=a.split(",").map(function(a){return a.trim().toLowerCase()});b.selected.forEach(function(a){var b=c.indexOf(a.text.toLowerCase());b!==-1&&c.splice(b,1)}),0!==c.length&&b.items.forEach(function(a){c.indexOf(a.text.toLowerCase())!==-1&&b.select(a,!0)})}}]).directive("uiSelectRequired",function(){return{require:"ngModel",link:function(a,b,c,d){d.$validators.uiSelectRequired=function(b){return!a.isRequired()||!!(b&&b.length>0)}}}}).directive("fieldName",function(){return{restrict:"E",replace:!0,scope:{field:"=field"},templateUrl:"/views/cmdb/object/_field-name.html",controller:["$scope","$uibModal","Abject","HIDE_FIELD_LIST",function(a,b,c,d){a.field||(a.field={id:"",name:"",value:{}}),a.getType=function(){return a.field.value.type},a.getName=function(){if(a.field)return a.field.name.indexOf("(")?a.field.name.split("(")[0]:a.field.name.indexOf("（")?a.field.name.split("（")[0]:a.field.name},a.getId=function(){return a.field.id},a.isHidden=function(){return d.indexOf(a.getId())!==-1}}],link:function(a,b){a.isHidden()&&b.parent().addClass("hidden")}}}).directive("fieldValue",function(){return{restrict:"E",replace:!0,scope:{field:"=field",value:"=value",highlightChar:"=highlightChar",hasHighlight:"=?hasHighlight"},templateUrl:"/views/cmdb/object/_field-value.html",controller:["$scope","$uibModal","Abject","HIDE_FIELD_LIST","OBJECT_FK_DEFAULT_SHOW",function(a,b,c,d,e){function f(){if(_.isNil(a.value))return"";if(!a.isForeignKey())return a.isList()&&_.isArray(a.value)?a.value.join("、"):a.value.toString();var b,c=e[a.getFkObj()]||["name"];return a.isList()&&_.isArray(a.value)?(b=[],angular.forEach(a.value,function(a){b.push(g(c,a))}),b.join("、")):(b=g(c,a.value),b||a.value.instanceId)}a.field||(a.field={id:"",name:"",value:{}}),a.getType=function(){if(a.field)return a.field.value.type},a.getName=function(){return a.field.name.indexOf("(")?a.field.name.split("(")[0]:a.field.name.indexOf("（")?a.field.name.split("（")[0]:a.field.name},a.getId=function(){return a.field.id},a.isForeignKey=function(){return"FK"===a.getType()||"FKs"===a.getType()},a.isInnerKey=function(){return a.isForeignKey()&&"inner"===a.field.value.rule.mode},a.isList=function(){return["enum","arr","FKs"].indexOf(a.getType())!==-1},a.getFkObj=function(){return a.field.value.rule.obj};var g=function(a,b){var c=b[a[0]],d=[];return angular.forEach(a.slice(1),function(a){"function"==typeof a?d.push(a(b)):d.push(b[a])}),d.length?c+"("+d.join(",")+")":c};if(a.getValue=function(){return _.escape(f())},a.isHidden=function(){return d.indexOf(a.getId())!==-1},a.isHighlight=function(){return a.highlightChar&&a.highlightChar.length>0},a.isHighlight()&&!a.isHidden()){var h=new RegExp(a.highlightChar,"i");a.hasHighlight=a.getValue().search(h)!==-1}else a.hasHighlight=!1}],link:function(a,b){a.isHidden()&&b.parent().addClass("hidden")}}}).directive("addInstanceInModal",function(){return{restrict:"EA",scope:{selected:"=?selected",select:"=select",objectId:"@objectId",queryAttr:"@queryAttr",saveAttr:"@saveAttr"},controller:["$scope","$stateParams","$uibModal","$localStorage","HIDE_FIELD_LIST",function(a,b,c,d,e){a.selected=a.selected||[],a.queryAttr=a.queryAttr||"name",a.saveAttr=a.saveAttr||"instanceId",d.defaultShowAttr=d.defaultShowAttr||{},a.defaultShowAttr=d.defaultShowAttr,a.openModal=function(){var b=a.$new(!0);b.objectId=a.objectId,b.selected=a.selected,b.queryAttr=a.queryAttr,b.saveAttr=a.saveAttr,a.defaultShowAttr[a.objectId]=a.defaultShowAttr[a.objectId]||[],b.showAttrIds=a.defaultShowAttr[a.objectId];var d=c.open({templateUrl:"/views/cmdb/object/_add-instance-in-modal.html",backdrop:"static",scope:b,size:"lg",controller:["$scope","$uibModalInstance","Abject",function(a,b,c){a.flags={checkAll:!1},a.allList=[],a.loaded=!1,a.pageInfo={page:1,pageSize:10,total:0,pageSizes:[10,30,50,100,200]},a.form={q:""},a.pageChange=function(){a.pageInfo.page=1,a.searchInstances()},a.searchInstances=function(){var b={};b[a.queryAttr]=a.form.q,c.fetchAbjectInstanceList({objectId:a.objectId,searchKey:a.queryAttr,searchInput:a.form.q,page:a.pageInfo.page,pageSize:a.pageInfo.pageSize}).then(function(b){a.loaded=!0,a.allList=b.data.list,a.pageInfo.total=b.data.total,a.pageInfo.page=b.data.page,angular.forEach(a.allList,function(b){a.selected.indexOf(b[a.saveAttr])!==-1&&(b.disabled=!0,b.checked=!0),b.state&&"invalid"===b.state&&(b.forbidden=!0,b.disabled=!0)})})},a.showAttr=[],a.queryName="",a.attrInfoList={},a.getAttrList=function(){c.fetchAbjectAttrList({objectId:a.objectId,pageSize:299}).then(function(b){if(a.attrInfo=b.data,angular.forEach(a.attrInfo.attrList,function(b){a.attrInfoList[b.id]=b}),a.queryName=a.attrInfoList[a.queryAttr].name,a.showAttrIds&&a.showAttrIds.length)angular.forEach(a.showAttrIds,function(b){a.attrInfoList[b].show=!0});else{for(var c=0,d=a.attrInfo.attrList.length;c<d;c+=1){if("true"===a.attrInfo.attrList[c].required){var e=a.attrInfo.attrList[c].id;a.attrInfoList[e].show=!0,a.showAttrIds.push(e)}if(a.showAttrIds.length>4)break}if(a.showAttrIds.length<5)for(var f=0,g=a.attrInfo.attrList.length;f<g;f+=1){if(a.showAttrIds.indexOf(a.attrInfo.attrList[f].id)===-1){var h=a.attrInfo.attrList[f].id;a.attrInfoList[h].show=!0,a.showAttrIds.push(h)}if(a.showAttrIds.length>4)break}}})};var d=function(a){return"FK"===a.value.type||"FKs"===a.value.type};a.hideAttr=function(a){return e.indexOf(a.id)!==-1},a.setSearchKey=function(b){a.queryAttr=d(b)?b.id+":name":b.id,a.queryName=b.name},a.saveDefaultShowAttr=function(b){b.show?a.showAttrIds.push(b.id):_.pull(a.showAttrIds,b.id)},a.getObjectName=function(){if(a.attrInfo){var b=a.attrInfo.name;return _.trimEnd(b,"管理")}return""},a.$watch("flags.checkAll",function(b){angular.forEach(a.allList,function(a){a.checked=b})}),a.save=function(){var c=[];angular.forEach(a.allList,function(b){b.checked&&!b.disabled&&c.push(b[a.saveAttr])}),b.close(c)},a.getAttrList(),a.searchInstances()}]});d.result.then(function(b){a.select=b})}}],link:function(a,b){b.on("click",function(){a.openModal()})}}}).directive("selectOnBlur",function(){return{require:"uiSelect",link:function(a,b,c,d){b.on("blur","input.ui-select-search",function(a){d.open&&(d.tagging.isActivated||d.activeIndex>=0)&&d.search.length&&d.select(d.items[d.activeIndex]),a.target.value=""})}}}).directive("autoFocus",function(){return{restrict:"AE",replace:!0,scope:{autoFocus:"="},link:function(a,b){a.autoFocus&&(b[0].autofocus=!0)}}}).directive("cmdbFieldValue",function(){return{restrict:"A",scope:{attrData:"=cmdbFieldValue",attrModel:"="},templateUrl:"views/cmdb/_cmdb-field-value.html",controller:"CmdbFieldValueCtrl",link:function(a,b){b.addClass("cmdb-field-value")}}}).controller("CmdbFieldValueCtrl",["$scope","CmdbResourceService",function(a,b){if(a.showAsTable=b.showAttributeAsTable(a.attrModel,a.attrData),a.showAsTable){var c=a.attrModel.value.type;a.dataList=_.map("FKs"===c?a.attrData:[a.attrData],function(b){var c={};return _.forEach(a.attrModel.value.external,function(a){var d=b[a.org_attr];_.isArray(d)?d=_.map(d,function(a){return _.isObject(a)?a.name||a.hostname:a}).join("; "):_.isObject(d)&&(d=d.name||d.hostname),c[a.org_attr]=d}),c})}}]).run(["$templateCache",function(a){a.put("views/cmdb/_cmdb-field-value.html",'<span ng-if="::!showAsTable">{{::attrData | cmdbFieldValueFormat:attrModel}}</span>\n<div class="panel panel-default" ng-if="::showAsTable && dataList.length">\n<table class="table table-default">\n<thead>\n<tr>\n<th ng-repeat="ext in ::attrModel.value.external">{{::ext.name}}</th>\n</tr>\n</thead>\n<tbody>\n<tr ng-repeat="item in ::dataList">\n<td ng-repeat="ext in ::attrModel.value.external">{{::item[ext.org_attr]}}</td>\n</tr>\n</tbody>\n</table>\n</div>')}]).filter("cmdbObjectAttrType",["ATTRTYPELIST",function(a){return function(b){var c=_.find(a,{key:b});return c?c.text:""}}]),function(){function a(){var a=this;a.$onInit=function(){var b,c;if("visitors"===a.managerType)b="_visitor",c="_visitor_group";else{if("managers"!==a.managerType)return;b="_manager",c="_manager_group"}a.list=_.map(a.instanceData[b],function(a){return{name:a,className:"instance-manager-user"}}).concat(_.map(a.instanceData[c],function(a){return{name:a,className:"instance-manager-group"}}))}}angular.module("cmdb.components",[]).component("cmdbInstanceManagers",{template:'<span ng-repeat-start="item in ::$ctrl.list" ng-class="::item.className">{{::item.name}}</span><span ng-repeat-end ng-if="::!$last">; </span>',bindings:{instanceData:"<",managerType:"@"},controller:a})}(),angular.module("cmdb.models",[]).config(["$stateProvider",function(a){a.state("cmdb.model",{abstract:!0,url:"/model",template:"<div ui-view></div>"})}]),angular.module("cmdb.resources",["cmdb.resources.create","cmdb.resources.instance","cmdb.resources.import","cmdb.resources.archive"]).config(["$stateProvider",function(a){a.state("cmdb.resources",{abstract:!0,url:"/resource/{objectId:\\w+}",template:"<div ui-view></div>",controller:"CmdbResourceAbstractCtrl",resolve:{available:["$q","$stateParams","OBJECTBLACKLIST",function(a,b,c){var d=a.defer();return _.includes(c,b.objectId)?d.reject({status:404,data:{error:"找不到对象"}}):d.resolve(),d.promise}],modelData:["CmdbModelService","$stateParams",function(a,b){return a.fetchModel(b.objectId).then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbListFields-"+a.objectId,a._$sortKey="cmdbOrderBy-"+a.objectId,a})}]}}).state("cmdb.resources.index",{url:"?q&aq&page&pageSize",params:{q:{dynamic:!0,value:null,squash:!0},aq:{dynamic:!1,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0},pageSize:{type:"int",dynamic:!0}},templateUrl:"views/cmdb/resources/graphs.html",controller:"CmdbResourceIndexCtrl",redirectTo:function(a){var b=a.params("to"),c=a.injector().get("FALLBACK_OBJECT_IDS");return"APP"===b.objectId?"cmdb.apps.index":"HOST"===b.objectId?"cmdb.devices.index":_.includes(c,b.objectId)?{state:"cmdb.resources.fallbackIndex",params:b}:void 0},resolve:{instanceList:["$localStorage","$q","CmdbResourceService","modelData",function(a,b,c,d){var e=b.defer();return c.fetchInstanceList(d.objectId,a[d._$storageKey]).then(function(a){e.resolve(a)}).catch(function(a){a.data&&130600===a.data.code?e.resolve(!1):e.reject(a)}),e.promise}]}}).state("cmdb.resources.fallbackIndex",{url:"/fallback?q&aq&page&pageSize",templateUrl:"views/cmdb/resources/graphs.html",controller:"CmdbResourceFallbackIndexCtrl",resolve:{available:["$q","modelData","FALLBACK_OBJECT_IDS",function(a,b,c){var d=a.defer();return _.includes(c,b.objectId)?d.resolve():d.reject({status:404,data:{error:"找不到对象"}}),d.promise}],instanceListData:["$stateParams","$localStorage","CmdbResourceService","modelData","CMDB_PAGE_SIZE_LIST",function(a,b,c,d,e){var f="cmdbPageSize-"+d.objectId,g=+(a.pageSize||b[f]);_.includes(e,g)||(g=e[0]);var h=b[d._$storageKey],i=_.defaults({},b[d._$sortKey],{order:null,by:"asc"});return c.searchInstanceList(d.objectId,{q:a.q,aq:a.aq,page:a.page,page_size:g,order:i.order,by:i.by,fields:h})}]}})}]).controller("CmdbResourceAbstractCtrl",["$scope","modelData",function(a,b){a.modelData=b}]).controller("CmdbResourceIndexCtrl",["$scope","$state","$stateParams","$timeout","$uibModal","$localStorage","$filter","VisitHistory","Utils","checkPermission","modelData","instanceList","CMDB_RESOURCE_FIELDS_SETTINGS","CMDB_PAGE_SIZE_LIST",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){var b=F.order,c=["_$visitedAt"===b?b:function(a){var c=a._$lowerCaseAttrs[b];return null===c||void 0===c?"":c}],d=[F.by];"name"!==b&&(c.push("_$lowerCaseAttrs.name"),d.push("asc")),a.fullList=_.orderBy(a.fullList,c,d)}function p(c){var d=y.page,e=y.pageSize,f=_.filter(a.advancedSearchList,"value");a.filteredList=_.filter(a.fullList,function(a){return _.every(f,function(b){var c=a._$lowerCaseAttrs[b.field];return b.operator.compare(c,b.value.toLowerCase())})}),a.instanceList=a.filteredList.slice((d-1)*e,d*e),a.totalItems=a.filteredList.length,a.searched=!0,c||b.go(b.current.name,a.trim(y),{location:"replace"}),i.scrollToContentTop()}if(a.permissionOfCreate=a.permissionOfEdit=j("cmdb:"+k.objectId+"_instance_manage"),l===!1)return void(a.accessDenied=!0);var q="cmdbPageSize-"+k.objectId,r=m.fixedFields[k.objectId]||[],s=m.defaultFields[k.objectId]||_.map(k.attrList,"id").slice(0,8),t=m.ignoredFields[k.objectId]||[],u=a.attributesMap={};_.forEach(k.attrList,function(a){u[a.id]=a}),a.selectedFields=_.filter(f[k._$storageKey],function(a){return u.hasOwnProperty(a)}),a.selectedFields.length||(a.selectedFields=s);var v=_.map(k.attrList,"id");a.selectedFields=_.orderBy(a.selectedFields,[function(a){var b=_.indexOf(v,a);return b===-1?1/0:b},_.identity],["asc","asc"]),a.collapseStatus={advancedSearch:!0,simpleSearch:!1},a.operatorList=[{text:"包含",value:"contain",compare:function(a,b){return a&&a.indexOf(b)!==-1}},{text:"等于",value:"equal",compare:function(a,b){return a&&a===b}},{text:"不等于",value:"notEqual",compare:function(a,b){return a!==b}}],a.advancedSearchList=_.map(a.selectedFields,function(b){return{field:b,operator:a.operatorList[0],value:null}}),a.doAdvancedSearch=function(){var c=_.filter(a.advancedSearchList,"value"),d=_.map(c,function(a){return[a.field,a.operator.value,a.value]});a.advancedSearching=!0,b.go(b.current.name,{page:null,q:null,aq:d.length?JSON.stringify(d):null},{reload:!0})},a.getTableStyle=function(){return{width:"100%","min-width":167*a.selectedFields.length+"px"}},a.selectFields=function(){var c=a.$new(!0);c.modelData=k,c.fixedFields=r,c.ignoredFields=t,c.selectedFields=angular.copy(a.selectedFields);var d=e.open({templateUrl:"views/cmdb/resources/_select-fields.html",backdrop:"static",scope:c,size:"md",controller:"SelectCmdbResourceFieldsCtrl"});d.result.then(function(a){f[k._$storageKey]=a,b.reload()})},a.pageSizeList=angular.copy(n);var w=f[q];_.includes(a.pageSizeList,w)||(w=a.pageSizeList[0]);var x={page:1,pageSize:w},y=a.filters=_.defaults({},c,x);if(y.aq)try{y.aq=JSON.parse(y.aq)}catch(a){delete y.aq}if(y.aq){angular.forEach(y.aq,function(b){var c=b[0],d=b[1],e=b[2],f=_.find(a.advancedSearchList,{field:c});if(f){var g=_.find(a.operatorList,{value:d});g&&(f.operator=g,f.value=e)}});var z=_.filter(a.advancedSearchList,"value");z.length||delete y.aq}y.aq&&(y.q=null,a.collapseStatus.advancedSearch=!1,a.collapseStatus.simpleSearch=!0),y.pageSize=+y.pageSize,_.includes(a.pageSizeList,y.pageSize)||(y.pageSize=x.pageSize),a.showAdvancedSearch=function(){a.collapseStatus.advancedSearch=!1,a.collapseStatus.simpleSearch=!0,d(function(){$(".table-advanced-search input").first().focus();
})},a.hideAdvancedSearch=function(){y.aq?b.go(b.current.name,{page:null,q:null,aq:null},{reload:!0}):(a.collapseStatus.advancedSearch=!0,a.collapseStatus.simpleSearch=!1)},a.fullList=l,a.filteredList=a.fullList;var A=h.getNamespaceByCmdbObjectId(k.objectId),B=new h(A,"instanceId"),C=B.all(),D={};_.forEach(C,function(a){D[a.instanceId]=+moment(a.visitedAt)});var E=g("cmdbFieldValueFormat");_.forEach(a.fullList,function(a){var b={},c={};_.forEach(a,function(a,d){if("instanceId"!==d){var e=u[d];if(e){var f=E(a,e);c[d]=f,b[d]=f.toLowerCase()}}}),a._$lowerCaseAttrs=b,a._$displayAttrs=c,a._$visitedAt=D[a.instanceId]||0});var F=a.sortData=_.defaults({},f[k._$sortKey],{order:a.fallback?null:"_$visitedAt",by:a.fallback?"asc":"desc"});a.sortBy=function(b){f[k._$sortKey]||(f[k._$sortKey]={}),b===F.order?F.by=f[k._$sortKey].by="desc"===F.by?"asc":"desc":(F.order=f[k._$sortKey].order=b,F.by=f[k._$sortKey].by="_$visitedAt"===b?"desc":"asc"),o(),y.aq?p():a.filter()},a.search=function(){y.page=1,a.filter()},a.trim=function(a){var b={};return angular.forEach(a,function(a,c){"aq"===c?b.aq=a?JSON.stringify(a):null:b[c]=x[c]===a?null:a}),b},a.filter=function(c){var d=y.page,e=y.pageSize,f=(y.q||"").toLowerCase();if(f){var g=f.split(/\s+/g);a.filteredList=_.filter(a.fullList,function(a){return _.some(a._$lowerCaseAttrs,function(a){return _.some(g,function(b){return a.indexOf(b)!==-1})})})}else a.filteredList=a.fullList;a.instanceList=a.filteredList.slice((d-1)*e,d*e),a.totalItems=a.filteredList.length,a.searched=!!f,c||b.go(b.current.name,a.trim(y),{location:"replace"}),i.scrollToContentTop()},a.pageChange=function(b){"pageSize"===b&&(f[q]=y.pageSize,y.page=1),y.aq?p():a.filter()},a.fallback||(o(),y.aq?p(!0):a.filter(!0)),a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(){a.all.checked=_.every(a.instanceList,"checked"),a.checkedAtLeastOne=_.some(a.instanceList,"checked")},a.allChecked=function(){var b=a.all.checked;angular.forEach(a.instanceList,function(a){a.checked=b}),a.checkedAtLeastOne=b&&!!a.instanceList.length};var G=a.getChecked=function(){return _.filter(a.instanceList,{checked:!0})},H="/api/cmdb/resource/"+k.objectId+"/export";if(a.exportAsCsv=function(){var b=G();b.length?i.openWindowByPost(H,{instanceIds:_.map(b,"instanceId").join(",")}):a.filteredList.length!==a.fullList.length?i.openWindowByPost(H,{instanceIds:_.map(a.filteredList,"instanceId").join(",")}):window.open(H)},a.batchEdit=function(){var c=a.$new(!0);c.instanceIds=_.map(G(),"instanceId"),c.modelData=k;var d=e.open({templateUrl:"views/cmdb/resources/_batch-edit.html",backdrop:"static",size:"md",scope:c,controller:"CmdbResourcesBatchEditCtrl"});d.result.then(function(){b.reload()})},a.userSettings={autoBreakLine:!1},/firefox/i.test(navigator.userAgent)){var I;a.setAutoBreakLine=function(){I||(I=!0,d(function(){$("#table-cmdb-resource-instances").css("table-layout","auto"),d(function(){$("#table-cmdb-resource-instances").css("table-layout","fixed")},17)},17))}}}]).controller("CmdbResourceFallbackIndexCtrl",["$controller","$scope","$state","$stateParams","$localStorage","$timeout","Utils","modelData","instanceListData",function(a,b,c,d,e,f,g,h,i){b.fallback=!0,angular.extend(this,a("CmdbResourceIndexCtrl",{$scope:b,modelData:h,instanceList:i.list})),b.instanceList=i.list,b.totalItems=i.total;var j=b.filters,k=b.sortData,l="cmdbPageSize-"+h.objectId;b.filter=function(){c.go(c.current.name,b.trim(j),{reload:!0})},b.pageChange=function(a){"pageSize"===a&&(e[l]=j.pageSize,j.page=1),b.filter()},b.sortBy=function(a){e[h._$sortKey]||(e[h._$sortKey]={}),a===k.order?k.by=e[h._$sortKey].by="desc"===k.by?"asc":"desc":(k.order=e[h._$sortKey].order=a,k.by=e[h._$sortKey].by="_$visitedAt"===a?"desc":"asc"),j.page=1,b.filter()},b.search=function(){j.page=1,b.filter()}}]).controller("SelectCmdbResourceFieldsCtrl",["$scope","$uibModalInstance","Dialog",function(a,b,c){a.checkList=_.map(_.filter(a.modelData.attrList,function(b){return!_.includes(a.ignoredFields,b.id)}),function(b){var c=_.includes(a.fixedFields,b.id);return{id:b.id,name:b.name,checked:c||_.includes(a.selectedFields,b.id),fixed:c}}),a.close=function(){var d=_.map(_.filter(a.checkList,"checked"),"id");return d.length?void b.close(d):void c.alert({type:"warning",message:"请至少选择一项！"})},a.reset=function(){b.close()}}]).controller("CmdbResourcesBatchEditCtrl",["$scope","$uibModalInstance","handleAjaxError","VisitHistory","Abject","CMDB_RESOURCE_FIELDS_SETTINGS",function(a,b,c,d,e,f){var g=a.formData={},h=a.attrData={},i=f.ignoredFields[a.modelData.objectId]||[];a.editableAttributes=_.filter(a.modelData.attrList,function(a){return!_.includes(i,a.id)&&"false"===a.readonly&&"false"===a.unique}),a.close=function(){if(h.attr||!h.attr.id){var f=_.map(a.instanceIds,function(a){var b={instanceId:a};return b[h.attr.id]=g[h.attr.id],b}),i=d.getNamespaceByCmdbObjectId(a.modelData.objectId),j=new d(i,"instanceId");_.forEach(f,function(a){j.push(_.pick(a,"instanceId"))}),a.storing=!0,e.updateAllInstance(a.modelData.objectId,f).then(function(d){d.code?(a.storing=!1,c({status:500,data:d},"批量编辑"+a.modelData._$shortName)):b.close()}).catch(function(b){a.storing=!1,c(b,"批量编辑"+a.modelData._$shortName)})}}}]);var _window=window,angular=_window.angular,_=_window._,InstanceGraphGenerator=function(a){var b={FKLabelText:"外键",constructHierarchy:function(a,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{name:b.getCanonicalNameOfInstance(a,c),children:_.map(b.getCanonicalAttrListOfModel(a),function(e){var f=e.name,g=e.id,h=e.value,i=_.includes(["FK","FKs"],_.get(h,"type")),j={name:f,value:b.getCanonicalValueOfInstance(a,c,g),isFK:_.includes(["FK","FKs"],_.get(h,"type")),isVisible:_.get(d,[a.objectId,g],!0),propId:g};return i&&(j.fkDefinition=h),j}),isVisible:!0,isInstanceRoot:!0,modelId:a.objectId}},hashHierarchyData:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0";a.id=c;var d=a.children;if(_.isArray(d)&&0!==d.length)for(var e=0;e<d.length;e+=1){var f=c+"."+e;b.hashHierarchyData(d[e],f)}},findHierarchyNode:function(a,b){return"0"===b?a:_.get(a,_.flatMap(b.split(".").slice(1),function(a){return["children",a]}))},addLeavesToId:function(a,c,d){var e=b.findHierarchyNode(a,c);void 0!==e&&(e.children=(e.children||[]).concat(d))},putLeavesOnId:function(a,c,d){var e=b.findHierarchyNode(a,c);void 0!==e&&(e.children=d)},stashLeavesOnId:function(a,c){var d=b.findHierarchyNode(a,c);void 0!==d&&(d.stashedChidlren=d.children,delete d.children)},applyLeavesOnId:function(a,c){var d=b.findHierarchyNode(a,c);void 0!==d&&(d.children=d.stashedChidlren,delete d.stashedChidlren)},applyVisibilityConfig:function(a,c){var d=a.children;if(_.isArray(d)&&0!==d.length){var e=function(b,d){return a.isVisible===!0&&_.get(c,[b,d],!0)};_.forEach(d,function(d){var f=e(a.modelId,d.propId);_.assign(d,{isVisible:f}),d.isFK&&(_.forEach(d.children,function(a){_.assign(a,{isVisible:d.isVisible}),b.applyVisibilityConfig(a,c)}),_.forEach(d.stashedChidlren,function(a){b.applyVisibilityConfig(a,c)}))})}},generateConfig:function(){var a={marginTop:20,marginRight:20,marginBottom:20,marginLeft:20,nodeHeight:40,nodeWidth:250,duration:500,linkStraightLineLength:60,gapPropertyValue:12,gapForeignKeyTipsArrow:"0.5em",arrayValueLineHeight:18},b=a.marginLeft+a.marginRight,c=a.marginTop+a.marginBottom;return _.assign(a,{width:b,height:c})},mountGraphs:function(a){var c=window,d=c.d3,e=b.generateConfig(),f=d.select(a).append("svg").attr("width",e.width).attr("height",e.height);return f.append("g").attr("class","link-list").attr("transform","translate("+e.marginLeft+","+e.height/2+")"),f.append("g").attr("class","node-list").attr("transform","translate("+e.marginLeft+","+e.height/2+")"),f},diagonal:function(a){var c=b.generateConfig(),d=c.linkStraightLineLength;return["M"+a.y+","+a.x,"h"+-d,"C"+(a.y+d+a.parent.y)/2+","+a.x+" "+(a.y+d+a.parent.y)/2+","+a.parent.x+" "+a.parent.y+","+a.parent.x].join(" ")},backgroundPath:function(a,b){var c=a.width,d=a.height,e=b.borderTopLeftRadius,f=void 0===e?0:e,g=b.borderTopRightRadius,h=void 0===g?0:g,i=b.borderBottomLeftRadius,j=void 0===i?0:i,k=b.borderBottomRightRadius,l=void 0===k?0:k,m=b.paddingTop,n=void 0===m?0:m,o=b.paddingRight,p=void 0===o?0:o,q=b.paddingBottom,r=void 0===q?0:q,s=b.paddingLeft,t=void 0===s?0:s,u=c+t+p,v=d+n+r;return["M"+f+",0","h"+(u-f-h),"a"+h+","+h+" 0 0 1 "+h+","+h,"v"+(v-h-l),"a"+l+","+l+" 0 0 1 "+-l+","+l,"h"+-(u-j-l),"a"+j+","+j+" 0 0 1 "+-j+","+-j,"v"+-(v-j-f),"a"+f+","+f+" 0 0 1 "+f+","+-f,"z"].join(" ")},renderTextBackground:function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d3.selectAll(a).each(function(){var a=this.nextSibling.getBBox(),d=a.width,e=a.height,f=8,g=8,h=4.5,i=4.5;d3.select(this).attr("d",b.backgroundPath({width:d,height:e},_.assign({paddingLeft:f,paddingRight:g,paddingBottom:i,paddingTop:h,borderTopLeftRadius:12,borderTopRightRadius:12,borderBottomLeftRadius:12,borderBottomRightRadius:12},c))).attr("transform","translate("+-f+","+-(h+e/2)+")")})},renderHierarchy:function(a,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},e=window,f=e.d3;b.hashHierarchyData(c);var g=f.hierarchy(c),h=b.generateConfig(),i=h.duration,j=h.marginLeft,k=h.marginTop,l=h.nodeHeight,m=h.nodeWidth,n=h.linkStraightLineLength,o=h.gapPropertyValue,p=h.arrayValueLineHeight,q=h.gapForeignKeyTipsArrow,r=function(a){var b=a.data;return b.isFK===!1&&_.isArray(b.value)&&b.value.length>0?(b.value.length+1)/2:1},s=function(a){var b=a.data;return b.isVisible?1:0},t=f.tree(g).nodeSize([l,m]).separation(function(a,b){return(r(a)+r(b))/2*(a.parent===b.parent?(s(a)+s(b))/2:2)});t(g);var u=_.filter(g.descendants(),function(a){var b=a.data;return b.isVisible}),v=_.min(_.map(u,"x"));g.x0="x0"in g?g.x0:0,g.y0="y0"in g?g.y0:0;var w=f.transition().duration(i),x=a.select(".link-list"),y=a.select(".node-list");x.attr("transform","translate("+j+","+(k-v)+")"),y.attr("transform","translate("+j+","+(k-v)+")");var z=y.selectAll(".node").data(u,function(a){var b=a.data;return(b.isVisible?1:0)+" "+b.id}),A=z.enter().append("g").attr("class","node").attr("transform","translate("+g.y0+","+g.x0+")"),B=A.append("g").attr("class",function(a){var b=a.data;return b.isFK&&_.isObject(b.value)?_.isArray(b.value)&&0===b.value.length?"property":"property fk":b.isInstanceRoot?"property instance-root":"property"});B.append("path"),B.append("text").text(function(a){var b=a.data;return b.name}),B.select("text").filter(function(a){var b=a.data;return!!b.isFK&&!(_.isUndefined(b.value)||_.isArray(b.value)&&0===b.value.length)}).append("tspan").attr("class","arrow").attr("dx",q),B.select("text").filter(function(a){var b=a.data;return b.isInstanceRoot}).append("tspan").attr("class","eye").attr("dx",q).text(""),B.on("click",d(a,c));var C=A.filter(function(a){var b=a.data;return!b.isFK&&(!_.isNil(b.value)&&(!_.isArray(b.value)||0!==b.value.length))}).append("g").attr("class","value");C.append("path"),C.append("text"),C.filter(function(a){var b=a.data;return!_.isArray(b.value)}).select("text").text(function(a){var b=a.data;return b.value});var D=C.filter(function(a){var b=a.data;return _.isArray(b.value)}).select("text").attr("class","value-is-array").selectAll("tspan").data(function(a){var b=a.data;return b.value}).enter();D.append("tspan").text(_.identity).attr("x",0).attr("y",function(a,b,c){return(b-(c.length-1)/2)*p}),D.exit().remove(),z.exit().remove(),A.merge(z).attr("transform",function(a){var b=a.x,c=a.y;return"translate("+c+","+b+")"}).selectAll("tspan.arrow").text(function(a){var b=a.data;return b.isExpanded?"":""}),b.renderTextBackground(".property path"),b.renderTextBackground(".value path"),a.selectAll(".value").attr("transform",function(){return"translate("+(this.previousSibling.getBBox().width+o)+", 0)"});var E=x.selectAll(".link").data(u.slice(1),_.property(["data","id"])),F=E.enter().append("g").attr("class","link");F.append("path").attr("class",function(a){return _.get(a,["parent","data","isFK"])===!0?"line fk-outer":"line"}).attr("d",function(){var a={x:g.x0,y:g.y0};return a.parent=a,b.diagonal(a)});var G=F.filter(function(a){var b=a.data;return b.isFK}).append("g").attr("class","fk-label");G.append("path"),G.append("text"),E.exit().remove();var H=F.merge(E);H.select(".line").attr("d",b.diagonal),H.select(".fk-label").attr("transform",function(){var a=this.previousSibling,b=a.getPointAtLength(0),c=b.x,d=b.y;return"translate("+(c-n)+","+d+")"}).select("text").text(b.FKLabelText),b.renderTextBackground(".fk-label path",{paddingLeft:2,paddingRight:12,paddingBottom:2,paddingTop:3,borderTopLeftRadius:2,borderTopRightRadius:2,borderBottomLeftRadius:2,borderBottomRightRadius:2}),u.forEach(function(a){a.x0=a.x,a.y0=a.y}),a.transition(w).each(function(){var a=this.getBBox(),b=a.width,c=a.x,d=a.y,e=a.height;f.select(this).attr("width",c+b).attr("height",d+e)})},getCanonicalNameOfInstance:function(b,c){var d=a.OBJECT_FK_DEFAULT_SHOW,e=d[b.objectId];if(void 0===e)return c.name;var f=_slicedToArray(e,1),g=f[0],h=_.isFunction(e[1])?e[1]:_.property(g);return _.get(c,g,h(c))},getCanonicalValueOfInstance:function(b,c,d){var e=a.clusterTypeConverter;return"CLUSTER"===b.objectId&&"type"===d?e.id2label(c[d]):c[d]},getCanonicalAttrListOfModel:function(b){var c=a.CMDB_RESOURCE_FIELDS_SETTINGS,d=c.ignoredFields;return _.reject(b.attrList,function(a){return _.includes(_.get(d,b.objectId,[]),a.id)})},processExpanded:function(a,c,d,e){b.stashLeavesOnId(c,e.id),_.assign(e,{isStashed:!0,isExpanded:!1}),b.renderHierarchy(a,c,d)},processStashed:function(a,c,d,e){b.applyLeavesOnId(c,e.id),_.assign(e,{isStashed:!1,isExpanded:!0}),b.renderHierarchy(a,c,d)},processToBeExpand:function(a,c,d,e,f){b.addLeavesToId(c,e.id,f),_.assign(e,{isStashed:!1,isExpanded:!0}),b.renderHierarchy(a,c,d)},restoreNotExpanded:function(a,c,d,e){_.assign(e,{isExpanded:!1}),b.renderHierarchy(a,c,d)}};return b},VisibilityConfigHelper={constructStructureForVisibilityModal:function(a){return{basicChildren:_.filter(a.data.children,function(a){return a.isFK===!1}),foreignKeyChildren:_.filter(a.data.children,function(a){return a.isFK===!0}),modelId:a.data.modelId}},generateVisibilityConfig:function(a,b){return _defineProperty({},a,_.zipObject(_.map(b,"propId"),_.map(b,"isVisible")))},updateVisibilityConfig:function(a,b){return _.assign({},a,b)}};angular.module("cmdb.resources.service",["qgz.clusterType","app"]).factory("InstanceGraph",["clusterTypeConverter","CMDB_RESOURCE_FIELDS_SETTINGS","OBJECT_FK_DEFAULT_SHOW",function(a,b,c){return InstanceGraphGenerator({clusterTypeConverter:a,CMDB_RESOURCE_FIELDS_SETTINGS:b,OBJECT_FK_DEFAULT_SHOW:c})}]).factory("VisibilityConfigHelper",function(){return VisibilityConfigHelper}),angular.module("cmdb.resources.create",[]).config(["$stateProvider",function(a){a.state("cmdb.resources.create",{url:"/create",templateUrl:"views/cmdb/resources/create.html",controller:"CmdbResourceInstanceCreateCtrl",resolve:{instanceData:function(){return null},userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}]}})}]).controller("CmdbResourceInstanceCreateCtrl",["$scope","$state","$timeout","BackgroundJobManager","handleAjaxError","Dialog","CmdbResourceService","modelData","instanceData","userAndGroupList",function(a,b,c,d,e,f,g,h,i,j){function k(b){o.close(),a.storing=!1,b.data&&130313===b.data.code?f.alert({type:"error",message:"保存"+h._$shortName+"失败，可能已存在重复的"+h._$shortName+"！",callback:function(){var a=$('input[name="name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):e(b,"保存"+h._$shortName)}a.isEdit=!!i,a.instanceData=i,a.userAndGroupList=j,a.collapseStatus={optional:!0},a.formData={},a.permissionData={visitors:[],managers:[]},a.isEdit&&(_.forEach(i,function(b,c){var d=_.find(h.attrList,{id:c});d&&(d.value.rule&&"inner"===d.value.rule.mode?a.formData[c]=b:"FK"===d.value.type?a.formData[c]=b&&b.instanceId:"FKs"===d.value.type?a.formData[c]=_.map(b,"instanceId"):a.formData[c]=b)}),a.permissionData.visitors=_.map(i._visitor,function(a){return"u:"+a}).concat(_.map(i._visitor_group,function(a){return"g:"+a})),a.permissionData.managers=_.map(i._manager,function(a){return"u:"+a}).concat(_.map(i._manager_group,function(a){return"g:"+a})));var l=a.requiredAttributes=[],m=a.optionalAttributes=[],n=[];_.forEach(h.attrList,function(b){"true"===b.required?l.push(b):m.push(b),a.isEdit&&"true"===b.readonly&&n.push(b)});var o,p=new d(a);a.store=function(d){if(d&&d.$invalid){var e=$("form[name="+d.$name+"] .ng-invalid"),f=e.closest(".form-group"),j=f.closest('div[uib-collapse="collapseStatus.optional"]');return j.length&&(a.collapseStatus.optional=!1),void c(function(){(f.length?f:e).scrollIntoViewInBody()})}var q=angular.copy(a.formData);if(d&&("formRequired"===d.$name?q=_.pick(q,_.map(_.difference(l,n),"id")):"formOptional"===d.$name&&(q=_.pick(q,_.map(_.difference(m,n),"id")))),!d||"formPermissions"===d.$name){var r={_visitor:[],_visitor_group:[],_manager:[],_manager_group:[]};_.forEach(a.permissionData.visitors,function(a){var b=a.split(":");"u"===b[0]?r._visitor.push(b[1]):r._visitor_group.push(b[1])}),_.forEach(a.permissionData.managers,function(a){var b=a.split(":");"u"===b[0]?r._manager.push(b[1]):r._manager_group.push(b[1])}),d?q=r:_.assign(q,r)}_.forEach(q,function(a,b){_.isUndefined(a)&&(q[b]=null)}),o=p.start("正在保存"+h._$shortName),a.storing=!0,a.isEdit?g.updateInstance(h.objectId,i.instanceId,q).then(function(){o.end(h._$shortName+"已保存！",3e3),b.go("cmdb.resources.instance.index",null,{reload:!0})}).catch(k):g.storeInstance(h.objectId,q).then(function(a){o.end(h._$shortName+"已保存！",3e3),b.go("cmdb.resources.instance.index",a)}).catch(k)}}]),angular.module("cmdb.resources.instance",["url.matcher","cmdb.resources.service","cmdb.service","user.service","ui.bootstrap"]).config(["$stateProvider",function(a){a.state("cmdb.resources.instance",{abstract:!0,url:"/{instanceId:instanceId}",templateUrl:"views/cmdb/resources/instance.html",controller:"CmdbResourceInstanceAbstractCtrl",resolve:{instanceData:["$stateParams","CmdbResourceService","modelData",function(a,b,c){return b.fetchInstance(c.objectId,a.instanceId)}]}}).state("cmdb.resources.instance.index",{url:"",templateUrl:"views/cmdb/resources/instance/graphs.html",controller:"CmdbResourceInstanceIndexCtrl",redirectTo:function(a){var b=a.params("to");return"APP"===b.objectId?"cmdb.apps.app.index":"HOST"===b.objectId?"cmdb.devices.device.index":void 0}}).state("cmdb.resources.instance.permissions",{url:"/permissions",templateUrl:"views/cmdb/resources/instance/permissions.html"}).state("cmdb.resources.instance.changelog",{url:"/changelog?range",params:{range:{value:"this month",squash:!0}},templateUrl:"views/cmdb/resources/instance/changelog.html",controller:"CmdbResourceInstanceChangelogCtrl",resolve:{changelogList:["$stateParams","CmdbResourceService","modelData","instanceData",function(a,b,c,d){return b.fetchInstanceChangelog(c.objectId,d.instanceId,{range:a.range})}]}}).state("cmdb.resources.instance.edit",{url:"/edit",views:{"@cmdb.resources":{templateUrl:"views/cmdb/resources/create.html",controller:"CmdbResourceInstanceCreateCtrl"}},resolve:{userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}]}}).state("cmdb.resources.instance.graph",{url:"/graph",templateUrl:"views/cmdb/resources/instance/graph.html",controller:"CmdbResourceInstanceGraphCtrl",resolve:{deps:["depends",function(a){return a("components/d3")}],visibilityConfig:["User","$q","$window","modelData","handleAjaxError",function(a,b,c,d,e){return a.getUserProfile({namespace:"cmdb_resources_instance_graph_visibility_config",key:d.objectId}).catch(function(a){e(a)})}]}})}]).controller("CmdbResourceInstanceAbstractCtrl",["$scope","$state","$stateParams","BackgroundJobManager","Dialog","toastr","handleAjaxError","VisitHistory","checkPermission","CmdbResourceService","modelData","instanceData",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){var a=p.start("正在删除"+k._$shortName);j.removeInstance(k.objectId,l.instanceId).then(function(){a.end(k._$shortName+"已删除！"),b.go("cmdb.resources.index")}).catch(function(b){a.close();var c=b.data;if(c&&133117===c.code){var d=_.map(c.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";e.alert({type:"error",html:!0,message:"无法删除"+_.escape(k._$shortName)+"，有关联的"+d+"。"})}else g(b,"删除"+k._$shortName)})}a.instanceData=l;var n=h.getNamespaceByCmdbObjectId(k.objectId),o=new h(n,"instanceId");o.push({instanceId:l.instanceId}),a.permissionOfEdit=a.permissionOfRemove=i("cmdb:"+k.objectId+"_instance_manage",l);var p=new d(a);a.archiveInstance=function(a){var d={instance_id:a.instanceId},f=p.start("正在归档"+k._$shortName);j.archiveInstance(c.objectId,d).then(function(){f.end(k._$shortName+"已归档！"),b.go("cmdb.resources.index")}).catch(function(a){f.close();var b=a.data;if(b&&133117===b.code){var c=_.map(b.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";e.alert({type:"error",message:"无法归档"+k._$shortName+"，有关联的"+c+"。"})}else g(a,"归档"+k._$shortName)})},a.removeInstance=function(){e.confirm({message:"确实要删除"+_.escape(k._$shortName)+" <code>"+_.escape(l.name)+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){m()}})}}]).controller("CmdbResourceInstanceIndexCtrl",["$scope","CmdbResourceService","modelData","instanceData",function(a,b,c,d){a.showAsTable=_.some(c.attrList,function(a){return b.showAttributeAsTable(a,d[a.id])});var e=Math.ceil(c.attrList.length/2);a.colLeft=c.attrList.slice(0,e),a.colRight=c.attrList.slice(e),a.categoryList=[],_.forEach(c.attrList,function(b){var c=b.category||"默认属性",d=_.find(a.categoryList,{name:c});d||(d={name:c,attrList:[]},a.categoryList.push(d)),d.attrList.push(b)}),_.forEach(a.categoryList,function(a){var b=Math.ceil(a.attrList.length/2);a.colLeft=a.attrList.slice(0,b),a.colRight=a.attrList.slice(b)})}]).controller("CmdbResourceInstanceChangelogCtrl",["$scope","$state","$stateParams","modelData","changelogList",function(a,b,c,d,e){function f(a){var b={};return _.forEach(a,function(a,c){b[c]=h[c]===a?null:a}),b}a.operationLabel={update:"修改",insert:"新增"};var g=a.attributesMap={};_.forEach(d.attrList,function(a){g[a.id]=a}),_.forEach(e,function(a){a.differenceOfAttributes=_.filter(a.difference,function(a){return _.has(g,a.attr)}),a.permissionDataFrom={},a.permissionDataTo={};var b=["_visitor","_visitor_group","_manager","_manager_group"];_.forEach(b,function(b){var c=_.find(a.difference,{attr:b});c&&(a.permissionDataFrom[b]=c.from||[],a.permissionDataTo[b]=c.to||[])}),a.differenceOfPermissions=[],(a.permissionDataFrom._visitor||a.permissionDataFrom._visitor_group)&&a.differenceOfPermissions.push({name:"查询权限",type:"visitors"}),(a.permissionDataFrom._manager||a.permissionDataFrom._manager_group)&&a.differenceOfPermissions.push({name:"管理权限",type:"managers"})}),a.changelogList=e;var h={range:"this month"},i=_.defaults({},c,h);a.filters=i,a.rangeList=[{value:"this month",text:"本月"}],a.picker={month:null,monthOptions:{maxDate:new Date,minMode:"month"}},/^\d{4}-\d\d$/.test(i.range)&&(a.picker.month=moment(i.range+"-01").toDate()),a.monthpickerStatus={open:!1},a.openMonthpicker=function(){a.monthpickerStatus.open=!0},a.$watch("picker.month",function(a,c){a&&+a!==+c&&(i.range=moment(a).format("YYYY-MM"),b.go(b.current.name,f(i)))}),a.rangeChanged=function(){a.picker.month=null,b.go(b.current.name,f(i))}}]).controller("CmdbResourceInstanceGraphCtrl",["$scope","$window","modelData","instanceData","InstanceGraph","CmdbResourceService","CmdbModelService","visibilityConfig","$q","VisibilityConfigHelper","$uibModal","handleAjaxError",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=b._;m.assign(a,{visibilityConfig:h});var n=".instance-graph",o=e.mountGraphs(n),p=e.constructHierarchy(c,d,h),q=function b(d,n){return function(o){var p=o.data;if(p.isFK!==!0||m.isUndefined(p.value)||m.isArray(p.value)&&0===p.value.length){if(0===o.depth||o.parent.data.isFK){var q=j.constructStructureForVisibilityModal(o);k.open({templateUrl:"views/cmdb/resources/instance/edit-visibility.html",controller:"CmdbResourceInstanceGraphVisibilityCtrl",controllerAs:"$ctrl",scope:m.assign(a.$new(),q,{rootModelId:c.objectId,rerenderGraph:function(c){e.applyVisibilityConfig(n,c),e.renderHierarchy(d,n,b),m.assign(a,{visibilityConfig:c})}}),ariaLabelledBy:"modal-title",ariaDescribedBy:"modal-body"}).result.catch(m.noop)}}else{if(p.isExpanded===!0)return void e.processExpanded(d,n,b,p);if(p.isStashed===!0)return void e.processStashed(d,n,b,p);var r=function(a){if("inner"===p.fkDefinition.rule.mode)return i.resolve(m.castArray(p.value));var b=m.reject(m.map(m.castArray(p.value),"instanceId"),m.isEmpty);if(0===b.length){var c={data:{error:"没有权限查看或实例不存在"}};throw c}return i.all(m.map(b,function(b){return f.fetchInstance(a,b)}))};g.fetchModel(p.fkDefinition.rule.obj).then(function(a){return r(a.objectId).then(function(c){var f=m.map(c,function(b){return e.constructHierarchy(a,b,h)});e.processToBeExpand(d,n,b,p,f)})}).catch(function(a){l(a,"重试"),e.restoreNotExpanded(d,n,b,p)})}}};e.renderHierarchy(o,p,q)}]).controller("CmdbResourceInstanceGraphVisibilityCtrl",["$scope","$uibModalInstance","handleAjaxError","VisibilityConfigHelper","User",function(a,b,c,d,e){var f=angular.copy(a.basicChildren),g=angular.copy(a.foreignKeyChildren);_.assign(a,{ok:function(f,g){var h=a.modelId,i=a.rootModelId,j=a.rerenderGraph,k=_.concat([],f,g),l=d.generateVisibilityConfig(h,k),m=a.visibilityConfig,n=d.updateVisibilityConfig(m,l);_.assign(a,{storing:!0}),e.putUserProfile({namespace:"cmdb_resources_instance_graph_visibility_config",key:i,value:n}).then(function(){j(n),_.assign(a,{visibilityConfig:n,storing:!1}),b.close()}).catch(function(b){_.assign(a,{storing:!1}),c(b)})},cancel:function(){a.reset(),b.dismiss("cancel")},reset:function(){a.basicChildren=angular.copy(f),a.foreignKeyChildren=angular.copy(g)}}),a.reset()}]),angular.module("cmdb.resources.import",[]).config(["$stateProvider",function(a){a.state("cmdb.resources.import",{url:"/import",templateUrl:"views/cmdb/resources/import.html",controller:"CmdbResourceInstanceImportCtrl",resolve:{importableAttrList:["CmdbModelService","modelData",function(a,b){return a.getImportableAttributes(b.objectId)}]}})}]).controller("CmdbResourceInstanceImportCtrl",["$scope","$state","$localStorage","Dialog","handleAjaxError","Upload","modelData","importableAttrList",function(a,b,c,d,e,f,g,h){function i(){m=null,$('form[name="formImportInstances"] input[name="attachment"]').val(null)}a.importableAttrList=h,a.unimportableRequiredAttrList=_.filter(_.differenceBy(g.attrList,h,"id"),function(a){return"true"===a.required}),a.unimportable=!!a.unimportableRequiredAttrList.length;var j=["HOST"===g.objectId?"ip":"name"],k="cmdbImportKeys-"+g.objectId,l=c[k];l=_.filter(l,function(a){return _.find(h,{id:a})}),l.length||(l=j),a.formData={keys:l},a.sampleUrl="/api/cmdb/resource/"+g.objectId+"/sample.csv";var m;a.drop=function(a){m=a},a.$watch("invalidFile",function(a){a&&d.alert({type:"warning",message:a.name+": 文件不符合条件",callback:i})}),a.submit=function(){if(!a.formData.keys.length)return void d.alert({type:"warning",message:"请设置至少一个唯一键！"});if(!m)return void d.alert({type:"warning",message:"请先选择一个 csv 文件！"});c[k]=angular.copy(a.formData.keys),a.submitting=!0;var h=f.upload({url:"/api/cmdb/resource/"+g.objectId+"/import",data:{attachment:m,keys:a.formData.keys}});h.then(function(c){if(c.data&&c.data.data){var f=c.data.data,h=f.insert_count+f.update_count,j="";if(h&&f.insert_count&&f.update_count){var k=[];f.insert_count&&k.push(f.insert_count+" 个新增"),f.update_count&&k.push(f.update_count+" 个更新"),j="其中 "+k.join("，")+"，"}d.confirm({type:"success",message:(h?h+" 个"+g._$shortName:"")+"已导入，"+j+"现在将回到"+g.name+"页面。",resolved:function(){b.go("cmdb.resources.index",{objectId:g.objectId})},rejected:function(){a.submitting=!1,i()}})}else e(c,"导入"),a.submitting=!1},function(b){if(b.data&&133121===b.data.code){var c=b.data.data,f=c?c.insert_count+c.update_count:null,h="";if(f&&c.insert_count&&c.update_count){var i=[];c.insert_count&&i.push(c.insert_count+" 个新增"),c.update_count&&i.push(c.update_count+" 个更新"),h="其中 "+i.join("，")+"，"}c&&c.failed_count&&(h+='<span class="text-danger">'+c.failed_count+" 个导入失败",c.data.length&&(h+="，"+_.map(c.data,function(a){return a.error+" (第"+_.map(a.data,function(a){return a.__line_number__}).join("、")+"行)"}).join("，")),h+="</span>"),d.alert({type:"error",html:!0,message:(f?f+" 个"+_.escape(g._$shortName)+"已导入，":"")+h+"。",callback:function(){a.submitting=!1}})}else e(b,"导入"),a.submitting=!1})}}]),angular.module("cmdb.resources.archive",[]).config(["$stateProvider",function(a){a.state("cmdb.resources.archive",{url:"/archive?q&page&pageSize",reloadOnSearch:!1,templateUrl:"views/cmdb/resources/archive.html",controller:"CmdbResourceArchiveCtrl",resolve:{modelData:["CmdbModelService","$stateParams",function(a,b){return a.fetchModel(b.objectId).then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbListFields-"+a.objectId,a})}],instancesData:["CmdbResourceService","$stateParams",function(a,b){return a.getArchivedInstancesList(b.objectId)}]}})}]).controller("CmdbResourceArchiveCtrl",["$scope","$state","$stateParams","CmdbResourceService","Utils","handleAjaxError","VisitHistory","$localStorage","$filter","BackgroundJobManager","toastr","checkPermission","modelData","instancesData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){var b={};return angular.forEach(a,function(a,c){b[c]=r[c]===a?null:a}),b}function p(c){var d=s.page,f=s.pageSize,g=(s.q||"").toLowerCase();if(g){var h=g.split(/\s+/g);u=_.filter(t,function(a){return _.some(a._$lowerCaseAttrs,function(a){return _.some(h,function(b){return a.indexOf(b)!==-1})})}),a.totalItems=u.length}else u=t,a.totalItems=t.length;a.instanceList=u.slice((d-1)*f,d*f),a.searched=!!g,c||b.go(b.current.name,o(s),{location:"replace"}),e.scrollToContentTop()}a.permissionOfManageOne=function(a){return l("cmdb:"+m.objectId+"_instance_manage",a)},a.modelData=m,a.instanceList=_.chain(n).map(function(a){return a._archive_ts*=1e3,a.checked=!1,a}).orderBy(["_archive_ts"],["desc"]).value(),a.fields=_.map(m.attrList,"id");var q=a.attributesMap={};_.forEach(m.attrList,function(a){q[a.id]=a}),a.pageSizeList=[20,50,100];var r={page:1,pageSize:a.pageSizeList[0]},s=a.filters=_.defaults({},c,r);a.all={checked:!1};var t=a.instanceList,u=t,v=i("cmdbFieldValueFormat");_.forEach(t,function(a){var b={},c={};_.forEach(a,function(a,d){if("instanceId"!==d){var e=q[d];if(e){var f=v(a,e);c[d]=f,b[d]=f.toLowerCase()}}}),a._$lowerCaseAttrs=b,a._$displayAttrs=c}),a.search=function(){s.page=1,p()},p(!0),a.allChecked=function(){_.forEach(a.instanceList,function(b){b.checked=a.all.checked})},a.getTableStyle=function(){var b=a.fields.length;return"HOST"===m.objectId?b=4:"APP"===m.objectId&&(b=3),{width:"100%","min-width":167*b+"px"}},a.pageChange=function(a){"pageSize"===a&&(s.page=1),p()};var w=g.getNamespaceByCmdbObjectId(m.objectId),x=new g(w,"instanceId"),y=new j(a);a.activateInstance=function(b){var e=c.objectId;"HOST"===m.objectId?e="HOST":"APP"===m.objectId&&(e="APP");var g={instance_id:b.instanceId};x.push({instanceId:b.instanceId});var h=y.start("正在处理");d.activateInstance(e,g).then(function(){h.end("已激活",1e3),t=_.reject(t,{instanceId:b.instanceId}),a.totalItems=t.length,p()}).catch(function(a){h.close(),f(a,"激活")})}}]),angular.module("cmdb.devices",["cmdb.devices.create","cmdb.devices.import","cmdb.devices.device","cmdb.devices.services","cmdb.devices.cloudHost","cmdb.service"]).config(["$stateProvider",function(a){a.state("cmdb.devices",{abstract:!0,url:"/device",template:"<div ui-view></div>",controller:"CmdbDevicesAbstractCtrl",resolve:{modelData:["CmdbModelService",function(a){return a.fetchModel("HOST").then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbDeviceListFields",a._$sortKey="cmdbOrderBy-"+a.objectId,a})}],deviceAttributes:["modelData",function(a){return a.attrList}]}}).state("cmdb.devices.index",{url:"?q&aq&page&pageSize",params:{q:{dynamic:!0,value:null,squash:!0},aq:{
dynamic:!1,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0},pageSize:{type:"int",dynamic:!0}},templateUrl:"views/cmdb/devices/graphs.html",redirectTo:function(a){var b=a.params("to"),c=a.injector().get("FALLBACK_OBJECT_IDS");if(_.includes(c,"HOST"))return{state:"cmdb.devices.fallbackIndex",params:b}},resolve:{deviceListData:["DeviceService","$localStorage","$q",function(a,b,c){var d=c.defer();return a.fetchDeviceList(b.cmdbDeviceListFields).then(function(a){d.resolve(a)}).catch(function(a){a.data&&130600===a.data.code?d.resolve(!1):d.reject(a)}),d.promise}],agentList:["Admin",function(a){return a.listAgent().then(function(a){return a.data||[]})}]},controller:"CmdbDevicesIndexCtrl"}).state("cmdb.devices.fallbackIndex",{url:"/fallback?q&aq&page&pageSize",templateUrl:"views/cmdb/devices/graphs.html",controller:"CmdbDevicesFallbackIndexCtrl",resolve:{available:["$q","modelData","FALLBACK_OBJECT_IDS",function(a,b,c){var d=a.defer();return _.includes(c,b.objectId)?d.resolve():d.reject({status:404,data:{error:"找不到对象"}}),d.promise}],deviceListData:["$stateParams","$localStorage","CmdbResourceService","modelData","CMDB_PAGE_SIZE_LIST",function(a,b,c,d,e){var f="cmdbPageSize-"+d.objectId,g=+(a.pageSize||b[f]);_.includes(e,g)||(g=e[0]);var h=b[d._$storageKey],i=_.defaults({},b[d._$sortKey],{order:null,by:"asc"});return c.searchInstanceList(d.objectId,{q:a.q,aq:a.aq,page:a.page,page_size:g,order:i.order,by:i.by,fields:h})}]}}).state("cmdb.devices.archive",{url:"/archive?q&aq&page&pageSize",reloadOnSearch:!1,templateUrl:"views/cmdb/resources/archive.html",controller:"CmdbResourceArchiveCtrl",resolve:{instancesData:["CmdbResourceService",function(a){var b="HOST";return a.getArchivedInstancesList(b)}]}})}]).controller("CmdbDevicesAbstractCtrl",["$scope","modelData","deviceAttributes",function(a,b,c){a.modelData=b,a.modelAttrMap={},_.forEach(c,function(b){a.modelAttrMap[b.id]=b})}]).controller("SelectCmdbDeviceFieldsCtrl",["$scope","$uibModalInstance",function(a,b){var c=_.map(a.deviceAttributes,function(b){var c=_.includes(a.fixedFields,b.id),d=_.indexOf(a.orderedFields,b.id);return{id:b.id,name:b._$displayName,checked:c||_.includes(a.selectedFields,b.id),fixed:c,index:d===-1?1/0:d}});a.checkList=_.orderBy(c,["index","id"],["asc","asc"]),a.close=function(){b.close(_.map(_.filter(c,"checked"),"id"))},a.reset=function(){b.close()}}]).controller("CmdbDevicesFallbackIndexCtrl",["$scope","$controller","$state","$localStorage","modelData","deviceAttributes","deviceListData",function(a,b,c,d,e,f,g){a.fallback=!0,angular.extend(this,b("CmdbDevicesIndexCtrl",{$scope:a,modelData:e,deviceAttributes:f,deviceListData:g.list,agentList:null})),a.deviceList=g.list,a.totalItems=g.total;var h=a.filters,i=a.sortData,j="cmdbPageSize-"+e.objectId;a.filter=function(){c.go(c.current.name,a.trim(h),{reload:!0})},a.pageChange=function(b){"pageSize"===b&&(d[j]=h.pageSize,h.page=1),a.filter()},a.sortBy=function(b){d[e._$sortKey]||(d[e._$sortKey]={}),b===i.order?i.by=d[e._$sortKey].by="desc"===i.by?"asc":"desc":(i.order=d[e._$sortKey].order=b,i.by=d[e._$sortKey].by="_$visitedAt"===b?"desc":"asc"),h.page=1,a.filter()},a.search=function(){h.page=1,a.filter()}}]).controller("CmdbDevicesIndexCtrl",["$scope","$state","$stateParams","$uibModal","$localStorage","$window","$filter","$timeout","Utils","VisitHistory","Abject","DeviceService","checkPermission","USERNAME","modelData","deviceAttributes","deviceListData","agentList","CMDB_TOOLKIT","CMDB_PAGE_SIZE_LIST",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){function u(a,b){if(_.isNil(a))return"";switch(b.id){case"cpuHz":return O(1024*a*1024,1,"Hz");case"memSize":case"diskSize":return O(1024*a,1,"B")}return g("cmdbFieldValueFormat")(a,b)}function v(){var a=Q.order,b=["_$visitedAt"===a?a:function(b){var c=b._$lowerCaseAttrs[a];return null===c||void 0===c?"":c},"_$isRelated"],c=[Q.by,"desc"];"hostname"!==a&&(b.push("_$lowerCaseAttrs.hostname"),c.push("asc")),J=_.orderBy(J,b,c)}function w(c){var d=H.page,e=H.pageSize,f=_.filter(a.advancedSearchList,"value");K=_.filter(J,function(a){return _.every(f,function(b){var c=a._$lowerCaseAttrs[b.field];return b.operator.compare(c,b.value.toLowerCase())})}),a.deviceList=K.slice((d-1)*e,d*e),a.totalItems=K.length,a.searched=!0,c||b.go(b.current.name,a.trim(H),{location:"replace"}),i.scrollToContentTop()}function x(){var b=$(".tool-row-container"),c=$(".tool-row");c.length>1&&(b.addClass("slide"),c.addClass("slide"),a.toolRowWidth=c.width(),c.each(function(b){var c=$(this);c.css("left",b*a.toolRowWidth)}))}function y(a,b,c,d){b=b||"post",d=!!_.isUndefined(d)||d;var e=document.createElement("form");e.setAttribute("method",b),e.setAttribute("action",a),d&&e.setAttribute("target","_blank"),_.forEach(c,function(a,b){if(c.hasOwnProperty(b)){var d=document.createElement("input");d.setAttribute("type","hidden"),d.setAttribute("name",b),d.setAttribute("value",JSON.stringify(a)),e.appendChild(d)}}),document.body.appendChild(e),e.submit(),document.body.removeChild(e)}function z(){return _.filter(a.deviceList,{checked:!0})}if(a.permissionOfCreate=a.permissionOfEdit=m("cmdb.devices.manage"),a.showAgentStatus=!!r,q===!1)return void(a.accessDenied=!0);var A="cmdbPageSize-HOST";k.fetchHostResolved({page:1}).then(function(b){b.data.list.length>=1&&(a.hostResolved=b.data.list)});var B=["hostname","ip"],C=["hostname","ip","cpuModel","memSize","osDistro","owner"],D=_.map(p,"id"),E=a.deviceAttributesMap={};_.forEach(p,function(a){a._$displayName=a.name.replace("（KB）","").replace("（MHz）",""),E[a.id]=a}),a.selectedFields=_.filter(e.cmdbDeviceListFields,function(a){return E.hasOwnProperty(a)}),a.selectedFields.length||(a.selectedFields=C),a.selectedFields=_.orderBy(a.selectedFields,[function(a){var b=_.indexOf(D,a);return b===-1?1/0:b},_.identity],["asc","asc"]),a.collapseStatus={advancedSearch:!0,simpleSearch:!1},a.operatorList=[{text:"包含",value:"contain",compare:function(a,b){return a&&a.indexOf(b)!==-1}},{text:"等于",value:"equal",compare:function(a,b){return a&&a===b}},{text:"不等于",value:"notEqual",compare:function(a,b){return a!==b}}],a.advancedSearchList=_.map(a.selectedFields,function(b){return{field:b,operator:a.operatorList[0],value:null}}),a.doAdvancedSearch=function(){var c=_.filter(a.advancedSearchList,"value"),d=_.map(c,function(a){return[a.field,a.operator.value,a.value]});a.advancedSearching=!0,b.go(b.current.name,{page:null,q:null,aq:d.length?JSON.stringify(d):null},{reload:!0})},a.getTableStyle=function(){return{width:"100%","min-width":167*a.selectedFields.length+"px"}},a.selectFields=function(){var c=a.$new(!0);c.deviceAttributes=p,c.fixedFields=B,c.orderedFields=D,c.selectedFields=angular.copy(a.selectedFields),c.showAgentStatus=a.showAgentStatus;var f=d.open({templateUrl:"views/cmdb/devices/_select-fields.html",backdrop:"static",scope:c,size:"md",controller:"SelectCmdbDeviceFieldsCtrl"});f.result.then(function(a){e.cmdbDeviceListFields=a,b.reload()})},a.pageSizeList=angular.copy(t);var F=e[A];_.includes(a.pageSizeList,F)||(F=a.pageSizeList[0]);var G={page:1,pageSize:F},H=a.filters=_.defaults({},c,G);if(H.aq)try{H.aq=JSON.parse(H.aq)}catch(a){delete H.aq}if(H.aq){angular.forEach(H.aq,function(b){var c=b[0],d=b[1],e=b[2],f=_.find(a.advancedSearchList,{field:c});if(f){var g=_.find(a.operatorList,{value:d});g&&(f.operator=g,f.value=e)}});var I=_.filter(a.advancedSearchList,"value");I.length||delete H.aq}H.aq&&(H.q=null,a.collapseStatus.advancedSearch=!1,a.collapseStatus.simpleSearch=!0),H.pageSize=+H.pageSize,_.includes(a.pageSizeList,H.pageSize)||(H.pageSize=G.pageSize),a.showAdvancedSearch=function(){a.collapseStatus.advancedSearch=!1,a.collapseStatus.simpleSearch=!0,h(function(){$(".table-advanced-search input").first().focus()})},a.hideAdvancedSearch=function(){H.aq?b.go(b.current.name,{page:null,q:null,aq:null},{reload:!0}):(a.collapseStatus.advancedSearch=!0,a.collapseStatus.simpleSearch=!1)};var J=q,K=J,L=new j("devices","instanceId"),M=L.all(),N={};_.forEach(M,function(a){N[a.instanceId]=+moment(a.visitedAt)});var O=g("bytes");_.forEach(J,function(a){var b=_.map(a.owner,"name"),c=_.map(a.backupowner,"name"),d={},e={};_.forEach(a,function(a,b){if("instanceId"!==b){var c=E[b];if(c){var f=u(a,c);e[b]=f,d[b]=f.toLowerCase()}}}),a._$lowerCaseAttrs=d,a._$displayAttrs=e,a._$visitedAt=N[a.instanceId]||0,a._$isRelated=_.includes(b,n)||_.includes(c,n);var f=a._uuid,g=_.findIndex(r,function(b){return f?b.uuid===f:a.ip===b.agent});if(g>=0){var h=r[g];a._$agentStatus=l.getHeartBeatStatus(h),r.splice(g,1)}});var P=o._$sortKey,Q=a.sortData=_.defaults({},e[P],{order:a.fallback?null:"_$visitedAt",by:a.fallback?"asc":"desc"});a.sortBy=function(b){e[P]||(e[P]={}),b===Q.order?Q.by=e[P].by="desc"===Q.by?"asc":"desc":(Q.order=e[P].order=b,Q.by=e[P].by="_$visitedAt"===b?"desc":"asc"),v(),a.filter()},a.search=function(){H.page=1,a.filter()},a.trim=function(a){var b={};return angular.forEach(a,function(a,c){"aq"===c?b.aq=a?JSON.stringify(a):null:b[c]=G[c]===a?null:a}),b},a.filter=function(c){var d=H.page,e=H.pageSize,f=(H.q||"").toLowerCase();if(f){var g=f.split(/\s+/g);K=_.filter(J,function(a){return _.some(a._$lowerCaseAttrs,function(a){return _.some(g,function(b){return a.indexOf(b)!==-1})})})}else K=J;a.deviceList=K.slice((d-1)*e,d*e),a.totalItems=K.length,a.searched=!!f,c||b.go(b.current.name,a.trim(H),{location:"replace"}),i.scrollToContentTop()},a.pageChange=function(b){"pageSize"===b&&(e[A]=H.pageSize,H.page=1),H.aq?w():a.filter(),a.all.checked=!1,a.checkedAtLeastOne=_.some(a.deviceList,"checked")},a.fallback||(v(),H.aq?w(!0):a.filter(!0)),a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(){a.all.checked=_.every(a.deviceList,"checked"),a.checkedAtLeastOne=_.some(a.deviceList,"checked")},a.fullToolkit=s.tools||[];var R,S=8;R=Math.ceil(a.fullToolkit.length/S),a.toolkit=[];for(var T=0;T<R;T+=1)a.toolkit.push(a.fullToolkit.slice(T*S,(T+1)*S));var U=angular.copy(a.toolkit);a.slide={index:1},a.slide.canSlideLeft=a.slide.index>1,a.slide.canSlideRight=a.slide.index<U.length,a.toolRowWidth=0,a.slideToolkit=function(b){var c=angular.copy(a.toolkit),d=a.toolRowWidth;b<1||b>c.length||(_.forEach(c,function(a,c){var e=$(".tool-row").eq(c),f=parseInt(e.css("left"),10);f=(c+1-b)*d,setTimeout(function(){e.css("left",f+"px")})}),a.slide.index=b,a.slide.canSlideLeft=a.slide.index>1,a.slide.canSlideRight=a.slide.index<c.length)},setTimeout(x),a.connectTool=function(c){var d=_.filter(a.deviceList,"checked");if("internal"===c.type){var g=b.href("tools.tool.execute",{toolId:c.detail.id,fromToolkit:1});e.toolkitSendData=d,f.open(g)}else if("external"===c.type){var h=_.chain(d).map(function(a){return _.pick(a,c.detail.pick)}).value();y(c.detail.url,"post",{devices:h})}},a.refundCloudHost=function(){if(a.checkedAtLeastOne){var c=_.map(z(),"instanceId");b.go("cmdb.devices.cloudHost.refund",{instanceIds:c.join(",")})}},a.allChecked=function(){var b=a.all.checked;angular.forEach(a.deviceList,function(a){a.checked=b}),a.checkedAtLeastOne=b&&!!a.deviceList.length},a.getCheckedIps=function(){return _.map(z(),"ip").join("\n")};var V="/api/cmdb/resource/"+o.objectId+"/export";if(a.exportAsCsv=function(){var a=z();a.length?i.openWindowByPost(V,{instanceIds:_.map(a,"instanceId").join(",")}):K.length!==J.length?i.openWindowByPost(V,{instanceIds:_.map(K,"instanceId").join(",")}):window.open(V)},a.batchEdit=function(){var c=a.$new(!0);c.instanceIds=_.map(z(),"instanceId"),c.modelData=o;var e=d.open({templateUrl:"views/cmdb/resources/_batch-edit.html",backdrop:"static",size:"md",scope:c,controller:"CmdbResourcesBatchEditCtrl"});e.result.then(function(){b.reload()})},a.userSettings={autoBreakLine:!1},/firefox/i.test(navigator.userAgent)){var W;a.setAutoBreakLine=function(){W||(W=!0,h(function(){$("#table-cmdb-resource-instances").css("table-layout","auto"),h(function(){$("#table-cmdb-resource-instances").css("table-layout","fixed")},17)},17))},a.setAutoBreakLine()}}]),angular.module("cmdb.devices.create",["cmdb.devices.services"]).config(["$stateProvider",function(a){a.state("cmdb.devices.create",{url:"/create",templateUrl:"views/cmdb/devices/create.html",controller:"DeviceCreateCtrl",resolve:{deviceData:function(){return null},userList:["CmdbResourceService",function(a){return a.fetchInstanceList("USER",["instanceId","name"])}],userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}],agentKey:["$stateParams","RequestWrapper",function(a,b){return a.page?null:b.object({url:"/api/agent/key",method:"GET"}).then(function(a){return a&&a.data})}]}})}]).controller("DeviceCreateCtrl",["$scope","$state","$timeout","$q","$window","toastr","Utils","Dialog","handleAjaxError","DeviceService","deviceAttributes","deviceData","userList","userAndGroupList","agentKey","DEVICE_STATUS_LIST",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){if(o){var q=e.location.origin+"/agent/sh/"+o+"/install.sh";a.installUrl="curl -L "+q+" | bash",a.installProxyUrl="curl -L "+q+"?type=proxy | bash",a.installUrlByProxy='curl -H "Host:'+e.location.host+'" -L http://YOUR-PROXY-IP/agent/sh/'+o+"/install.sh?proxy_ip=YOUR-PROXY-IP | bash",a.installUrlWindows=q+"?os=windows",a.installUrlWindowsByProxy="http://YOUR-PROXY-IP/agent/sh/"+o+"/install.sh?os=windows&proxy_ip=YOUR-PROXY-IP",a.hideProxyTipsOfLinux=!0,a.hideProxyTipsOfWindows=!0}if(a.deviceData=l,a.customAttributes=_.filter(k,{custom:"true"}),a.userAndGroupList=n,a.permissionData={visitors:[],managers:[]},a.advancedFields=[{type:"text",name:"provider",displayName:"供应商"},{type:"text",name:"location",displayName:"地域"},{type:"text",name:"city",displayName:"城市"},{type:"text",name:"memo",displayName:"备注说明"}],a.discoverableFields=[{type:"text",name:"osVersion",displayName:"操作系统"},{type:"text",name:"osArchitecture",displayName:"操作系统架构"},{type:"text",name:"osSystem",displayName:"操作系统类型"},{type:"text",name:"osDistro",displayName:"操作系统发行版本"},{type:"text",name:"osRelease",displayName:"操作系统内核发行版本"},{type:"text",name:"cpuModel",displayName:"CPU 型号"},{type:"number",name:"cpuHz",displayName:"CPU 频率"},{type:"number",name:"cpus",displayName:"CPU 物理核数"},{type:"number",name:"memSize",displayName:"内存大小（KB）"},{type:"number",name:"diskSize",displayName:"磁盘大小（KB）"},{type:"text",name:"_mac",displayName:"MAC 地址"}],a.isEdit=!!l,a.isEdit){a.activeTab="manually",a.formData={},_.forEach(l,function(b,c){var d=_.find(a.customAttributes,{id:c});_.isObject(b)||d||(a.formData[c]=b)});var r=["owner","backupowner"];_.forEach(r,function(a){_.forEach(l[a],function(a){a.lowerName=a.name.toLowerCase()})}),_.forEach(r,function(b){_.forEach(l[b],function(a){a.lowerName=a.name.toLowerCase()}),a.formData[b]=_.map(_.sortBy(l[b],"lowerName"),"instanceId")}),a.permissionData.visitors=_.map(l._visitor,function(a){return"u:"+a}).concat(_.map(l._visitor_group,function(a){return"g:"+a})),a.permissionData.managers=_.map(l._manager,function(a){return"u:"+a}).concat(_.map(l._manager_group,function(a){return"g:"+a}))}else a.activeTab="install",a.formData={status:p[0]};a.installData={username:"root",port:22},angular.forEach(l,function(b,c){var d=_.find(a.customAttributes,{id:c});d&&(d.value.rule&&"inner"===d.value.rule.mode?a.formData[c]=b:"FK"===d.value.type?a.formData[c]=b&&b.instanceId:"FKs"===d.value.type?a.formData[c]=_.map(b,"instanceId"):a.formData[c]=b)}),_.forEach(m,function(a){a.lowerName=a.name.toLowerCase()}),a.userList=_.sortBy(m,"lowerName"),a.statusList=_.clone(p),a.collapseStatus={advanced:!0,discoverable:!0,customizable:!0};var s;a.setScopeInstall=function(a){s=a};var t;a.setScopeManually=function(a){t=a},a.store=function(){if(t.formCreateDevice.$invalid){var d=$("form[name=formCreateDevice] .ng-invalid"),e=d.closest(".form-group"),g=e.closest('div[uib-collapse="collapseStatus.customizable"]');return g.length&&(a.collapseStatus.customizable=!1),void c(function(){(e.length?e:d).scrollIntoViewInBody()})}var h=angular.copy(a.formData),k={_visitor:[],_visitor_group:[],_manager:[],_manager_group:[]};_.forEach(a.permissionData.visitors,function(a){var b=a.split(":");"u"===b[0]?k._visitor.push(b[1]):k._visitor_group.push(b[1])}),_.forEach(a.permissionData.managers,function(a){var b=a.split(":");"u"===b[0]?k._manager.push(b[1]):k._manager_group.push(b[1])}),_.assign(h,k),a.storing=!0,a.isEdit?j.updateDevice(l.instanceId,h).then(function(a){f.success("主机已修改！"),b.go("cmdb.devices.device.index",a,{reload:!0})}).catch(function(b){i(b,"保存主机"),a.storing=!1}):j.storeDevice(h).then(function(a){f.success("主机已创建！"),b.go("cmdb.devices.device.index",a)}).catch(function(b){i(b,"保存主机"),a.storing=!1})};var u;a.installAgentDots="",a.install=function(){if(s.formInstallAgent.$invalid){var e=$("form[name=formInstallAgent] .ng-invalid"),f=e.closest(".form-group");return void c(function(){(f.length?f:e).scrollIntoViewInBody()})}var i=angular.copy(a.installData),k=g.matchIps(i.ips);delete i.ips,a.installing=!0,a.total=k.length;var l=a.succeed=[],m=a.failed=[],n=_.map(k,function(b){function e(d,h){j.getInstallAgentStatus(f).then(function(f){switch(f.status){case"ok":return void g.resolve({ip:b,error:!1});case"failed":return void g.resolve({ip:b,error:!0,reason:{data:f.detail}});case"run":break;default:if(h>3)return void g.resolve({ip:b,error:!0,reason:{data:"查询安装结果失败"}});h+=1}d+=1,a.installAgentDots=_.map(_.range(d%3+1),function(){return"."}).join(""),u=c(function(){e(d,h)},1e4)}).catch(function(a){g.resolve({ip:b,error:!0,reason:a})})}var f=angular.copy(i);f.ip=b;var g=d.defer();return j.installAgent(f).then(function(){e(0,0)}).catch(function(a){g.resolve({ip:b,error:!0,reason:a})}),g.promise});d.all(n).then(function(c){_.forEach(c,function(a){a.error?m.push(a):l.push(a)}),a.installing=!1;var d=[];if(l.length&&d.push(l.length+" 台主机已录入"),m.length){var e=_.map(m,function(a){var b=a.ip,c=a.reason.data;return c&&(b+=": "+(c.error||c.message||c)),b});return d.push(m.length+" 台主机录入失败 ( "+e.join(", ")+" )"),void h.alert({type:l.length?"warning":"error",message:d.join("，")+"。"})}h.confirm({type:"success",message:d.join("，")+"，点击确定跳转到主机管理页面。",resolved:function(){b.go("cmdb.devices.index")}})})},a.$on("$destroy",function(){u&&c.cancel(u)})}]),angular.module("cmdb.devices.import",["cmdb.devices.services"]).config(["$stateProvider",function(a){a.state("cmdb.devices.import",{url:"/import",templateUrl:"views/cmdb/resources/import.html",controller:"CmdbResourceInstanceImportCtrl",resolve:{importableAttrList:["CmdbModelService","modelData",function(a,b){return a.getImportableAttributes(b.objectId)}]}})}]),angular.module("cmdb.devices.device",["cmdb.devices.device.edit","cmdb.devices.services","cmdb.resources.instance","url.matcher","monitor.service"]).config(["$stateProvider",function(a){a.state("cmdb.devices.device",{abstract:!0,url:"/{instanceId:instanceId}",templateUrl:"views/cmdb/devices/device.html",resolve:{deviceData:["$stateParams","DeviceService",function(a,b){return b.fetchDevice(a.instanceId)}],instanceData:["deviceData",function(a){return a}]},controller:"CmdbDeviceAbstractCtrl"}).state("cmdb.devices.device.index",{url:"?range&redirected",params:{range:{value:"today",squash:!0}},templateUrl:"views/cmdb/devices/device/graphs.html",controller:"CmdbDeviceIndexCtrl",resolve:{agentStatus:["Admin","deviceData",function(a,b){return a.listAgent({ip:b.ip}).then(function(a){return a.data?a.data[0]:null})}],deps:["depends",function(a){return a("components/chartjs")}]}}).state("cmdb.devices.device.permissions",{url:"/permissions",templateUrl:"views/cmdb/resources/instance/permissions.html"}).state("cmdb.devices.device.advanced",{url:"/advanced",templateUrl:"views/cmdb/devices/device/advanced.html"}).state("cmdb.devices.device.customize",{url:"/customize",templateUrl:"views/cmdb/devices/device/customize.html"}).state("cmdb.devices.device.changelog",{url:"/changelog?range",params:{range:{value:"this month",squash:!0}},templateUrl:"views/cmdb/resources/instance/changelog.html",controller:"CmdbResourceInstanceChangelogCtrl",resolve:{changelogList:["$stateParams","CmdbResourceService","modelData","instanceData",function(a,b,c,d){return b.fetchInstanceChangelog(c.objectId,d.instanceId,{range:a.range})}]}}).state("cmdb.devices.device.graph",{url:"/graph",templateUrl:"views/cmdb/resources/instance/graph.html",controller:"CmdbResourceInstanceGraphCtrl",resolve:{deps:["depends",function(a){return a("components/d3")}],visibilityConfig:["User","$q","$window","modelData",function(a,b,c,d){var e=c._;return a.getUserProfile({namespace:"cmdb_resources_instance_graph_visibility_config",key:d.objectId}).catch(function(a){return 130308===e.get(a,["data","code"])?b.resolve({}):b.reject(a)})}]}})}]).controller("CmdbDeviceAbstractCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","VisitHistory","checkPermission","DeviceService","CmdbResourceService","deviceData","deviceAttributes",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){return a?(a.name+"").toLowerCase():""}function m(){a.removing=!0,h.removeDevice(j.instanceId).then(function(){c.success("主机已删除！"),b.go("cmdb.devices.index")}).catch(function(b){var c=b.data;if(c&&133117===c.code){var f=_.map(c.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";d.alert({type:"error",html:!0,message:"无法删除主机，有关联的"+f+"。"})}else e(b,"删除主机");a.removing=!1})}a.deviceData=j,a.instanceData=j,a.customAttributes=_.filter(k,{custom:"true"}),j.disk=_.sortBy(j.disk,l),j.eth=_.sortBy(j.eth,l),j.service=_.sortBy(j.service,l),a.archiveInstance=function(a){var f="HOST",g={instance_id:a.instanceId};i.archiveInstance(f,g).then(function(){c.success("主机已归档！"),b.go("cmdb.devices.index")}).catch(function(a){var b=a.data;if(b&&133117===b.code){var c=_.map(b.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";d.alert({type:"error",message:"无法归档主机，有关联的"+c+"。"})}else e(a,"归档主机")})},a.removeDevice=function(){d.confirm({message:"确实要删除主机 <code>"+_.escape(j.hostname)+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){m()}})};var n=new f("devices","instanceId");n.push(_.pick(j,"instanceId")),a.permissionOfEdit=a.permissionOfRemove=g("cmdb.devices.manage",j)}]).controller("CmdbDeviceIndexCtrl",["$scope","$state","$stateParams","Collector","DeviceService","deviceData","agentStatus","TIME_OFFSET","DISABLED_MODULES",function(a,b,c,d,e,f,g,h,i){function j(a){var b={};return angular.forEach(a,function(a,c){b[c]=w.filters[c]===a?null:a}),b}function k(){var b=_.find(a.rangeList,{value:x.range});if(b)return b;if(/^\d{4}-\d\d-\d\d$/.test(x.range)){var c=+moment(x.range,"YYYY-MM-DD")/1e3;return{params:{st:c,et:c+86400-1}}}return a.rangeList[0]}function l(a){if(isNaN(+a)||!isFinite(a))return{number:+a,unit:"",exponent:0,text:"-"};if(0===a)return{number:0,unit:"",exponent:0,text:"0"};if(!a)return{number:+a,unit:"",exponent:0,text:""};var b=["","K","M","G","T","P"],c=Math.min(b.length-1,Math.floor(Math.log(Math.abs(a))/Math.log(1024))),d=b[c],e=m(a,c);return{number:e,unit:d,text:e+" "+d+"B",exponent:c}}function m(a,b){var c=a/Math.pow(1024,Math.floor(b));return c>=100?Math.round(c):+c.toFixed(1)}function n(a,b,c){if(null===a)return"";var d=_.minBy(_.map(_.compact(c),function(a){return l(a)}),"exponent"),e=m(a,d.exponent);return e+" "+d.unit+"B"}function o(a,b,c){return null===a?"":n(a,b,c).toLowerCase()+"/s"}function p(a){return null===a?"":l(a).text}function q(a){return null===a?"":l(a).text.toLowerCase()+"/s"}function r(a){return null===a?"":a+"%"}function s(a,b,c){function d(a,b){return _.map(a,function(a,c){return{x:g+h*c,y:null===a?null:a*(b?-1:1)}})}var e=D[a];if(!e.shared){var f,g=c.startTime,h=c.step,i=e.valueFormat||_.identity,j=e.tickFormat||i,k=e.lineColor||w.lineColor,l=e.gridLineColor||w.gridLineColor,m=e.tickFontColor||w.tickFontColor,n=e.crosshairColor||w.crosshairColor,o=e.zeroLineColor||w.zeroLineColor,p=e.backgroundColor,q={type:"line",data:{datasets:[{borderColor:k,label:E(a),borderWidth:w.lineWidth,fill:!!p,backgroundColor:p,pointHoverRadius:0,pointRadius:0,hidden:v.getValueOrDefault(e.hidden,w.hidden),lineTension:v.getValueOrDefault(e.lineTension,w.lineTension),data:d(b)}]},options:{crosshair:{color:n,pointRadius:4,pointBorderWidth:2,showTooltipValue:!1},maintainAspectRatio:!1,hover:{mode:"index",intersect:!1,onHover:function(b){f&&v.cancelAnimFrame.call(window,f),f=v.requestAnimFrame.call(window,function(){B(b,a)})}},legend:e.legend||w.legend,tooltips:{enabled:!1},scales:{xAxes:[{type:"time",gridLines:{color:l,zeroLineColor:l,tickMarkLength:8,drawOnChartArea:!1,drawTicks:!0},ticks:{maxRotation:0,fontColor:m,callback:function(a,b,c){var d=c[b],e=d.format("H:mm");return"0:00"===e?d.format("MMMD日"):e}},time:{tooltipFormat:"MMMD日 ah:mm",min:g,max:H.getMaxTime(g),unit:H.unit,unitStepSize:H.unitStepSize}}],yAxes:[{type:e.yAxesType||"linear",afterFit:function(a){a.width=w.scaleWidth},ticks:{beginAtZero:e.beginAtZero,min:e.tickMin,max:e.tickMax,callback:j,maxTicksLimit:3,fontColor:m},gridLines:{color:l,zeroLineColor:o,drawBorder:!1,drawTicks:!1}}]}}};e.relativeDatasets&&_.forEach(e.relativeDatasets,function(a){var b=D[a];q.data.datasets.push({borderColor:b.lineColor||w.lineColor,label:E(a),borderWidth:w.lineWidth,fill:!!b.backgroundColor,backgroundColor:b.backgroundColor,pointHoverRadius:0,pointRadius:0,hidden:v.getValueOrDefault(b.hidden,w.hidden),lineTension:v.getValueOrDefault(b.lineTension,w.lineTension),data:d(c.result[a],b.negative)})}),F[a]=q}}a.monitorEnabled=!_.includes(i,"monitor");var t=0;g&&g.hb_agent_time&&(t=g.hb_server_time-g.hb_agent_time,a.showAgentTimeTips=Math.abs(t)>1800,a.agentTimeTips=(t>0?"慢了":"快了")+" "+moment.duration(1e3*t).humanize());var u=e.getHeartBeatStatus(g);a.heartBeatStatus=u.valid,a.heartBeatError=u.error,a.heartBeatTips=u.tips;var v=Chart.helpers,w={filters:{range:"today",redirected:null},rangeConfig:{unit:"hour",unitStepSize:3,getMaxTime:function(a){return a+864e5}},lineColor:"#333",lineWidth:2,gridLineColor:"rgb(238,238,238)",zeroLineColor:"rgb(238,238,238)",tickFontColor:"#aaa",crosshairColor:"#aaa",scaleWidth:80,hidden:!1,lineTension:.4,legend:{display:!1}},x=a.filters=_.defaults({},c,w.filters);if("today"===x.range&&"yes"!==x.redirected&&a.showAgentTimeTips){var y=moment().add(h-1e3*t),z=y.format("YYYY-MM-DD");z!==moment().add(h).format("YYYY-MM-DD")&&b.go(b.current.name,{range:z,redirected:"yes"},{location:"replace"})}a.picker={date:null,maxDate:new Date},a.datepickerStatus={open:!1},a.openDatepicker=function(){a.datepickerStatus.open=!0},a.$watch("picker.date",function(){a.picker.date&&(x.range=moment(a.picker.date).format("YYYY-MM-DD"),b.go(b.current.name,j(x)))}),/^\d{4}-\d\d-\d\d$/.test(x.range)&&(a.picker.date=moment(x.range).toDate()),a.rangeList=[{value:"today",text:"今天",params:{st:"-0d"}},{value:"yesterday",text:"昨天",params:{timerange:"-1d"}},{value:"week",text:"近7天",config:{unit:"day",unitStepSize:1,getMaxTime:function(a){return a+6048e5}},params:{st:"-6d"}}],a.rangeChanged=function(){b.go(b.current.name,j(x))};var A;A="Windows"===f.osSystem?a.chartItems=["host.cpu.used_total","host.mem.percent","host.mem.available","host.net.bits_in","host.net.bits_out","host.net.conn_total"]:a.chartItems=["host.cpu.used_total","host.load.1","host.load.5","host.load.15","host.mem.percent","host.mem.available","host.io.util","host.net.bits_in","host.net.bits_out","host.net.conn_total"];var B,C,D=a.chartSettingsMap={"host.cpu.used_total":{title:"CPU 使用率",beginAtZero:!0,tickMax:100,valueFormat:r},"host.load.1":{title:"1 分钟平均负载",lineColor:"#1d7fb3",beginAtZero:!0,legend:{display:!0,labels:{boxWidth:12,generateLabels:function(a){return _.map(a.data.datasets,function(b,c){return{text:b.label,fillStyle:b.borderColor,hidden:!a.isDatasetVisible(c),lineWidth:0,strokeStyle:"transparent",datasetIndex:c}})}}},relativeDatasets:["host.load.5","host.load.15"]},"host.load.5":{title:"5 分钟平均负载",lineColor:"#1db34f",shared:!0},"host.load.15":{title:"15 分钟平均负载",lineColor:"#c39be8",shared:!0},"host.mem.percent":{title:"内存使用率",beginAtZero:!0,tickMax:100,valueFormat:r},"host.mem.available":{title:"剩余可用内存",yAxesType:"byte",valueFormat:p,tickFormat:n,multiply:1024},"host.io.util":{title:"磁盘 IO 率",beginAtZero:!0,tickMax:100,valueFormat:r},"host.net.bits_in":{title:"网络入流量",yAxesType:"byte",valueFormat:q,tickFormat:o,multiply:1024,lineColor:"#1db34f",backgroundColor:"rgba(29,179,79,.15)",zeroLineColor:"rgba(0,0,0,.15)",relativeDatasets:["host.net.bits_out"]},"host.net.bits_out":{title:"网络出流量",yAxesType:"byte",valueFormat:q,tickFormat:o,multiply:1024,lineColor:"#1d7fb3",backgroundColor:"rgba(29,127,179,.15)",zeroLineColor:"rgba(0,0,0,.15)",shared:!0,negative:!0},"host.net.packages_in":{title:"网络入包量/秒",lineColor:"#1db34f",backgroundColor:"rgba(29,179,79,.15)",zeroLineColor:"rgba(0,0,0,.15)",relativeDatasets:["host.net.packages_out"]},"host.net.packages_out":{title:"网络出包量/秒",lineColor:"#1d7fb3",backgroundColor:"rgba(29,127,179,.15)",zeroLineColor:"rgba(0,0,0,.15)",shared:!0,negative:!0},"host.net.conn_total":{title:"网络连接数"}},E=a.getChartShortName=function(a){return D[a]&&D[a].title||a.substr(5)},F=a.chartConfigMap={},G=k(),H=_.defaults(G.config,w.rangeConfig),I=_.defaults(G.params,{name:"host",ip:f.ip,__select__:A.join(",")});a.isEmpty=function(b){var c=!a.loading&&(!C||!C[b]||!C[b].length);return c},a.monitorEnabled&&(a.loading=!0,d.getMetricResultList(I).then(function(b){function c(){d(l)}function d(b,c){_.forEach(F,function(a,d){a.options.crosshair.xIndex=c?b:null,a.options.crosshair.showTooltip=d===k}),j!==b&&(j=b,a.currentTime=g+j*f,a.currentData={},_.forEach(e,function(b,c){if(_.includes(A,c)){var d=D[c]&&D[c].valueFormat||_.identity;a.currentData[c]=d(b.length>=j+1?b[j]:null)}}))}var e=b.data[0],f=1e3*b.step,g=1e3*b.st,h=1e3*b.et,i=[0];C=e,_.forEach(e,function(a,b){if(_.includes(A,b)&&a){for(var c=a.length-1;c>=0;c-=1)if(null!==a[c]){i.push(c);break}var d=D[b].multiply||1;1!==d&&(e[b]=_.map(a,function(a){return null===a?null:a*d}))}});var j,k,l=_.max(i);c(),B=function(b,e){return k=e,b.length?(d(_.min([b[0]._index,l]),!0),void a.$digest()):(c(),void a.$digest())},_.forEach(e,function(a,b){_.includes(A,b)&&s(b,a,{result:e,step:f,startTime:g,endTime:h})})}).finally(function(){a.loading=!1}))}]),angular.module("cmdb.devices.device.edit",["cmdb.devices.services","cmdb.devices.create"]).config(["$stateProvider",function(a){a.state("cmdb.devices.device.edit",{url:"/edit",views:{"@cmdb.devices":{templateUrl:"views/cmdb/devices/device/edit.html",controller:"DeviceCreateCtrl"}},resolve:{userList:["CmdbResourceService",function(a){return a.fetchInstanceList("USER",["instanceId","name"])}],userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}],agentKey:function(){return null}}})}]),angular.module("cmdb.devices.services",[]).factory("DeviceService",["RequestWrapper","TIME_OFFSET",function(a,b){return{fetchDeviceList:function(b,c){return a.array({method:"GET",url:"/api/devices",params:{fields:_.join(b,","),selectDevicesFromCmdb:c&&c.selectDevicesFromCmdb?"true":null}})},fetchDevice:function(b){return a.object({method:"GET",url:"/api/devices/device/"+b})},batchFetchDevice:function(b){return a.array({method:"GET",url:"/api/devices/device",params:{instanceIds:b.join(",")}})},storeDevice:function(b){return a.object({method:"POST",url:"/api/devices/device",data:b})},updateDevice:function(b,c){return a.object({method:"PUT",url:"/api/devices/device/"+b,data:c})},removeDevice:function(b){return a.object({method:"DELETE",url:"/api/devices/device/"+b})},installAgent:function(b){return a.object({method:"POST",url:"/api/devices/install/agent",data:b})},getInstallAgentStatus:function(b){return a.object({method:"POST",url:"/api/devices/install/agent/status",data:b,ignoreLoadingBar:!0})},getHeartBeatStatus:function(a){var c={valid:!1,error:!1,tips:null,version:a&&a.version};if(a&&"number"==typeof a.hb_server_time){c.valid=!0;var d=Date.now()+b-1e3*a.hb_server_time;d>9e4&&(c.error=!0,c.tips="Agent 大约 "+moment.duration(d).humanize()+"无上报")}return c}}}]).factory("CloudHostService",["RequestWrapper",function(a){return{getAWSImageData:function(){return a.array({method:"GET",url:"/api/devices/cloud-host/aws-image"})},submitOrder:function(b){return a.object({method:"POST",url:"/api/devices/cloud-host/order",
data:b})},refund:function(b){return a.object({method:"POST",url:"/api/devices/cloud-host/refund",data:{ips:b}})}}}]),function(){function a(a,b,c,d,e,f,g,h,i,j,k,l){function m(a,b,c,d){var e=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,f=a+e,g=c-e,h=b+e,i=d-e;return["M"+a+" "+h,"A"+e+" "+e+" 0 0 1 "+f+" "+b,"H"+g,"A"+e+" "+e+" 0 0 1 "+c+" "+h,"V"+i,"A"+e+" "+e+" 0 0 1 "+g+" "+d,"H"+f,"A"+e+" "+e+" 0 0 1 "+a+" "+i,"z"].join("")}a.themeLight=!0;var n,o={width:0,height:0},p={nodes:i,links:[]};_.forEach(p.nodes,function(a){a.shape="Dot",_.forEach(a.attrList,function(b){if("FK"===b.value.type||"FKs"===b.value.type){var c={source:a.objectId,target:b.value.rule.obj};if(c.source===c.target)return;var d=_.find(p.links,c);d?(d.text+=","+b.name,"FKs"===b.value.type&&(d.linkClass="one-on-multiple")):(p.links.push(c),c.text=b.name,c.linkClass="FK"===b.value.type?"one-on-one":"one-on-multiple")}})});var q=!1;if(j&&j.nodes){var r=_.zipObject(_.map(j.nodes,"objectId"),j.nodes);q=!0,_.forEach(p.nodes,function(a){var b=r[a.objectId];b?_.assign(a,_.pick(b,["x","y"]),{px:b.x,py:b.y}):q=!1})}p.fixed=q,a.storeViewConfig=function(){a.storing=!0,h.putUserProfile({namespace:"cmdb_resources_models_graph",key:"view_config",value:{nodes:_.map(p.nodes,function(a){return _.pick(a,["objectId","x","y"])})}}).then(function(){g.success("视图已保存"),c(function(){a.storing=!1},2e3)}).catch(function(b){e(b,"保存"),a.storing=!1})},a.isFullscreen=!1;var s=$("#topo-canvas").width(),t=window.innerHeight-document.querySelector(".navbar").offsetHeight-60;o={width:s,height:t};var u="objectId",v={appendTo:"#topo-canvas",keyId:u,nodeFields:["name"],initialized:!1,size:[s,t],linkDistance:200,baseHref:d.url(),linkTextOffset:0,linkStartOffset:0,linkEndOffset:1.5,linkMirrorGap:14,linkThroughTextEnabled:!0,selectLinkEnabled:!1,hoverLinkEnabled:!1,capacityEnabled:!1,autoScaleToFitCanvas:!0,linkTextRender:function(a){a.append("path").attr("class","link-text-bg"),a.append("text").attr("dy",4.5).attr("class","link-text").text(function(a){return""+a.text}),a.each(function(){var a=d3.select(this),b=a.select(".link-text"),c=a.select(".link-text-bg"),d=b.node().getBBox();c.attr("d",m(-d.width/2-3,-d.height/2-1,d.width/2+3,d.height/2+1,3))})}};n=new AppsTopology(p,v),$(window).on("resize",function(){if(!(document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.fullscreenElement)){var a=$("#topo-canvas").width(),b=window.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight;n.setSize([a,b]),o={width:a,height:b}}});var w=function(b,c){if(!_.eq(a[b],c)){var d=a.$$phase;"$apply"!==d&&"$digest"!==d&&a.$apply(function(){a[b]=c}),a[b]=c}};q&&n.showLinkText(),n.on("forceEnd",function(){w("loading",!1),n.showLinkText()}),n.on("stateChange",function(a){if(a===AppsTopology.STATE_ZOOMING_CANVAS)w("zoomRate",n.getScaleLevel());else if(a===AppsTopology.STATE_DBLCLICK){var c=n.getHovedNode();if(!c)return;!_.includes(k,c.objectId)||_.includes(l,c.objectId)?b.go("cmdb.resources.index",{objectId:c.objectId}):f.alert({message:"没有"+c.name+"的相关页面。"})}}),a.zoomRate=1,a.zoomTopo=function(b){var c=n.getScaleRange();"in"===b?a.zoomRate=Math.floor(a.zoomRate/5*10)/10*5+.5:"out"===b&&(a.zoomRate=Math.ceil(a.zoomRate/5*10)/10*5-.5),a.zoomRate<c[0]&&(a.zoomRate=c[0]),a.zoomRate>c[1]&&(a.zoomRate=c[1]),n.setCanvasScale(a.zoomRate)},a.topoToggleFullscreen=function(){var b=!a.isFullscreen,d=document.querySelector(".topo-detail-wrapper"),e=window.outerWidth,f=window.outerHeight;b?(d.webkitRequestFullscreen&&d.webkitRequestFullscreen(),d.mozRequestFullScreen&&d.mozRequestFullScreen(),d.msRequestFullscreen&&d.msRequestFullscreen(),d.requestFullscreen&&d.requestFullscreen(),n.setSize([e,f]),a.isFullscreen=b):(document.webkitExitFullscreen&&document.webkitExitFullscreen(),document.mozCancelFullScreen&&document.mozCancelFullScreen(),document.msExitFullscreen&&document.msExitFullscreen(),document.exitFullscreen&&document.exitFullscreen(),c(function(){n.setSize([o.width,o.height]),a.isFullscreen=b},500))}}angular.module("cmdb.overview",[]).config(["$stateProvider",function(b){b.state("cmdb.overview",{url:"/overview",template:"<div ui-view></div>",abstract:!0}).state("cmdb.overview.graph",{url:"/graph",templateUrl:"views/cmdb/overview/graph.html",controller:a,resolve:{viewConfig:["User",function(a){return a.getUserProfile({namespace:"cmdb_resources_models_graph",key:"view_config"})}],deps:["depends",function(a){return a("components/apps-topology")}]}})}]),a.$inject=["$scope","$state","$timeout","$location","handleAjaxError","Dialog","toastr","User","abjectData","viewConfig","OBJECTBLACKLIST","OBJECT_INDEPENDENT_LIST"]}(),angular.module("cmdb.apps",["cmdb.service","cmdb.apps.create","cmdb.apps.app","apps.services","apps.filters"]).config(["$stateProvider",function(a){a.state("cmdb.apps",{url:"/app",abstract:!0,template:"<div ui-view></div>",controller:"CmdbAppsAbstractCtrl",resolve:{modelData:["CmdbModelService",function(a){return a.fetchModel("APP").then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbListFields-APP",a._$sortKey="cmdbOrderBy-APP",a})}]}}).state("cmdb.apps.index",{url:"?q&aq&biz&page&pageSize",params:{q:{dynamic:!0,value:null,squash:!0},aq:{dynamic:!1,value:"",squash:!0},page:{type:"int",dynamic:!0,value:1,squash:!0},pageSize:{type:"int",dynamic:!0},biz:{value:"",squash:!0,dynamic:!0}},templateUrl:"views/cmdb/apps/graphs.html",controller:"CmdbAppsIndexCtrl",resolve:{instanceList:["$localStorage","$q","CmdbResourceService","modelData",function(a,b,c,d){var e=b.defer();return c.fetchInstanceList("APP",a[d._$storageKey]).then(function(a){e.resolve(a)}).catch(function(a){a.data&&130600===a.data.code?e.resolve(!1):e.reject(a)}),e.promise}]}}).state("cmdb.apps.archive",{url:"/archive?q&aq&page&pageSize",reloadOnSearch:!1,templateUrl:"views/cmdb/resources/archive.html",controller:"CmdbResourceArchiveCtrl",resolve:{modelData:["CmdbModelService",function(a){var b="APP";return a.fetchModel(b).then(function(a){return a._$shortName=a.name.replace(/管理$/,""),a._$storageKey="cmdbListFields-"+a.objectId,a})}],instancesData:["CmdbResourceService",function(a){var b="APP";return a.getArchivedInstancesList(b)}]}})}]).controller("CmdbAppsAbstractCtrl",["$scope","modelData",function(a,b){a.modelData=b,a.modelAttrMap={},_.forEach(b.attrList,function(b){a.modelAttrMap[b.id]=b})}]).controller("CmdbAppsIndexCtrl",["$controller","$scope","$state","$timeout","Utils","modelData","instanceList",function(a,b,c,d,e,f,g){function h(){var a=window.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight,b=a-document.querySelector(".search-panel").offsetHeight-document.querySelector(".aside-header").offsetHeight-50;document.querySelector(".content-panel").style.minHeight=a+"px",document.querySelector(".aside-inner").style.height=b+"px"}angular.extend(this,a("CmdbResourceIndexCtrl",{$scope:b,modelData:f,instanceList:g})),setTimeout(h),window.addEventListener("resize",h),b.filter=function(a){var d=b.filters.page,f=b.filters.pageSize,g=(b.filters.q||"").toLowerCase(),h=b.filters.biz;if(g){var i=g.split(/\s+/g);b.filteredList=_.filter(b.fullList,function(a){return _.some(a._$lowerCaseAttrs,function(a){return _.some(i,function(b){return a.indexOf(b)!==-1})})})}else b.filteredList=b.fullList;h&&(b.filteredList=_.filter(b.filteredList,function(a){return!!a.businesses&&a.businesses.instanceId===h})),b.instanceList=b.filteredList.slice((d-1)*f,d*f),b.totalItems=b.filteredList.length,b.searched=!!g,a||c.go(c.current.name,b.trim(b.filters),{location:"replace"}),e.scrollToContentTop()},b.isAsideShowed=!1,b.businessesList=_.chain(b.fullList).map("businesses").compact().uniqBy("instanceId").sortBy(function(a){return a.name.toLowerCase()}).value(),b.showSidebar=function(){b.isAsideShowed=!b.isAsideShowed,d(function(){$(window).trigger("resize")})},b.filterAppsByBusiness=function(a){b.filters.biz=a&&a.instanceId||"",b.filter()},b.$on("$destroy",function(){window.removeEventListener("resize",h)})}]),angular.module("cmdb.apps.create",["apps.services"]).config(["$stateProvider",function(a){a.state("cmdb.apps.create",{url:"/create",templateUrl:"views/cmdb/apps/create.html",controller:"CmdbAppCreateCtrl",resolve:{appData:function(){return null},userList:["CmdbResourceService",function(a){return a.fetchInstanceList("USER",["instanceId","name"])}],userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}],businessList:["CmdbResourceService",function(a){return a.fetchInstanceList("BUSINESS",["instanceId","name"])}]}})}]).controller("CmdbAppCreateCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","AppService","appData","userList","userAndGroupList","businessList","modelData","USERNAME",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){b.data&&130313===b.data.code?d.alert({type:"error",message:"保存应用失败，可能已存在重复的应用！",callback:function(){var a=$('form[name=formCreateApp] input[ng-model="appForm.name"]'),b=a.closest(".form-group");(b.length?b:a).scrollIntoViewInBody()}}):e(b,"保存应用"),a.storing=!1}var n;if(a.appData=g,a.customAttributes=_.filter(k.attrList,{custom:"true"}),a.userAndGroupList=i,a.permissionData={visitors:[],managers:[]},a.collapseStatus={customizable:!0},a.isEdit=!!g,a.isEdit){n=a.appForm=_.pick(g,"name","memo");var o=["owner","developer","tester"];_.forEach(o,function(a){_.forEach(g[a],function(a){a.lowerName=a.name.toLowerCase()}),n[a]=_.map(_.sortBy(g[a],"lowerName"),"instanceId")});var p=["businesses"];_.forEach(p,function(a){g[a]&&(n[a]=g[a].instanceId)}),a.permissionData.visitors=_.map(g._visitor,function(a){return"u:"+a}).concat(_.map(g._visitor_group,function(a){return"g:"+a})),a.permissionData.managers=_.map(g._manager,function(a){return"u:"+a}).concat(_.map(g._manager_group,function(a){return"g:"+a}))}else{n=a.appForm={};var q=_.find(h,{name:l});q&&(n.owner=[q.instanceId])}_.forEach(g,function(b,c){var d=_.find(a.customAttributes,{id:c});d&&(d.value.rule&&"inner"===d.value.rule.mode?a.formData[c]=b:"FK"===d.value.type?n[c]=b&&b.instanceId:"FKs"===d.value.type?n[c]=_.map(b,"instanceId"):n[c]=b)}),_.forEach(h,function(a){a.lowerName=a.name.toLowerCase()}),a.userList=_.sortBy(h,"lowerName"),_.forEach(j,function(a){a.lowerName=a.name.toLowerCase()}),a.businessList=_.sortBy(j,"lowerName"),a.store=function(){if(a.formCreateApp.$invalid){var d=$("form[name=formCreateApp] .ng-invalid"),e=d.closest(".form-group");return void(e.length?e:d).scrollIntoViewInBody()}var h=angular.copy(n),i={_visitor:[],_visitor_group:[],_manager:[],_manager_group:[]};_.forEach(a.permissionData.visitors,function(a){var b=a.split(":");"u"===b[0]?i._visitor.push(b[1]):i._visitor_group.push(b[1])}),_.forEach(a.permissionData.managers,function(a){var b=a.split(":");"u"===b[0]?i._manager.push(b[1]):i._manager_group.push(b[1])}),_.assign(h,i),a.storing=!0,a.isEdit?f.updateApp(g.instanceId,h).then(function(a){c.success("应用已修改！"),b.go("cmdb.apps.app.index",a,{reload:!0})}).catch(m):f.storeApp(h).then(function(a){c.success("应用已创建！"),b.go("cmdb.apps.app.index",a)}).catch(m)}}]),angular.module("cmdb.apps.app",["cmdb.apps.app.devices","cmdb.apps.app.edit","cmdb.resources.instance","apps.services","url.matcher"]).config(["$stateProvider",function(a){a.state("cmdb.apps.app",{url:"/{instanceId:instanceId}",abstract:!0,template:'<div ui-view="heading"></div><div ui-view></div>',controller:"CmdbAppAbstractCtrl",resolve:{appData:["AppService","$stateParams",function(a,b){return a.fetchApp(b.instanceId)}],instanceData:["appData",function(a){return a}],clusterModel:["CmdbModelService",function(a){return a.fetchModel("CLUSTER")}],hostModel:["CmdbModelService",function(a){return a.fetchModel("HOST")}],appHostModel:["clusterModel","hostModel",function(a,b){var c=_.find(a.attrList,{id:"deviceList"}),d=_.filter(b.attrList,function(a){var b=_.find(c.value.external,{org_attr:a.id});return b&&b.name&&(a.name=b.name),b&&"ip"===a.id&&(a.name="集群 / IP"),b}),e=_.remove(d,{id:"ip"});return{attrList:e.concat(d),objectId:"APP-HOST",_$storageKey:"cmdbListFields-APP-HOST"}}]}}).state("cmdb.apps.app.changelog",{url:"/changelog?range",params:{range:{value:"this month",squash:!0}},views:{heading:{templateUrl:"views/cmdb/apps/app/_heading.html",controller:"CmdbAppTitleCtrl"},"":{templateUrl:"views/cmdb/apps/app/changelog.html",controller:"CmdbResourceInstanceChangelogCtrl"}},resolve:{changelogList:["$stateParams","CmdbResourceService","modelData","instanceData",function(a,b,c,d){return b.fetchInstanceChangelog(c.objectId,d.instanceId,{range:a.range})}]}}).state("cmdb.apps.app.graph",{url:"/graph",views:{heading:{templateUrl:"views/cmdb/apps/app/_heading.html",controller:"CmdbAppTitleCtrl"},"":{templateUrl:"views/cmdb/apps/app/graph.html",controller:"CmdbResourceInstanceGraphCtrl"}},resolve:{deps:["depends",function(a){return a("components/d3")}],visibilityConfig:["User","$q","$window","modelData",function(a,b,c,d){var e=c._;return a.getUserProfile({namespace:"cmdb_resources_instance_graph_visibility_config",key:d.objectId}).catch(function(a){return 130308===e.get(a,["data","code"])?b.resolve({}):b.reject(a)})}]}})}]).controller("CmdbAppAbstractCtrl",["$scope","VisitHistory","checkPermission","appData",function(a,b,c,d){a.appData=d;var e=new b("apps","instanceId");e.push(_.pick(d,"instanceId"));var f=[1,2,0];d.clusters=_.sortBy(d.clusters,function(a){return f[+a.type]});var g=d._$counts={};g.devices=_.chain(d.clusters).map(function(a){return _.map(a.deviceList,"ip")}).flatten().uniq().value().length,g.clusters=d.clusters&&d.clusters.length||0,a.removable=!(d.clusters&&d.clusters.length),a.permissionOfEdit=a.permissionOfRemove=c("apps.manage",d)}]).controller("CmdbAppTitleCtrl",["$scope","$state","Dialog","handleAjaxError","toastr","AppService","appData","CmdbResourceService",function(a,b,c,d,e,f,g,h){function i(){a.removing=!0,f.removeApp(g.instanceId).then(function(){e.success("应用已删除！"),b.go("cmdb.apps.index")}).catch(function(b){var e=b.data;if(e&&133117===e.code){var f=_.map(e.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";c.alert({type:"error",html:!0,message:"无法删除应用，有关联的"+f+"。"})}else d(b,"删除应用");a.removing=!1})}a.archiveInstance=function(a){var f="APP",g={instance_id:a.instanceId};h.archiveInstance(f,g).then(function(){e.success("应用已归档！"),b.go("cmdb.apps.index")}).catch(function(a){var b=a.data;if(b&&133117===b.code){var e=_.map(b.data,function(a){return a.object_name.replace(/管理$/,"")}).join("、")||"实例";c.alert({type:"error",message:"无法归档应用，有关联的"+e+"。"})}else d(a,"归档应用")})},a.removeApp=function(){c.confirm({message:"确实要删除应用 <code>"+_.escape(g.name)+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){i()}})}}]),angular.module("cmdb.apps.app.edit",["apps.services","cmdb.apps.create"]).config(["$stateProvider",function(a){a.state("cmdb.apps.app.edit",{url:"/edit",views:{"@cmdb.apps":{templateUrl:"views/cmdb/apps/create.html",controller:"CmdbAppCreateCtrl"}},resolve:{userList:["CmdbResourceService",function(a){return a.fetchInstanceList("USER",["instanceId","name"])}],userAndGroupList:["UserService",function(a){return a.fetchUserAndGroupList()}],businessList:["CmdbResourceService",function(a){return a.fetchInstanceList("BUSINESS",["instanceId","name"])}]}})}]),angular.module("cmdb.apps.app.devices",["apps.services"]).config(["$stateProvider",function(a){a.state("cmdb.apps.app.index",{url:"",views:{heading:{templateUrl:"views/cmdb/apps/app/_heading.html",controller:"CmdbAppTitleCtrl"},"":{templateUrl:"views/cmdb/apps/app/devices.html",controller:"CmdbAppDevicesCtrl"}}}).state("cmdb.apps.app.importDevices",{url:"/devices/import?clusterId",templateUrl:"views/cmdb/apps/app/import-devices.html",controller:"CmdbAppImportDevicesCtrl"}).state("cmdb.apps.app.createCluster",{url:"/cluster/create",templateUrl:"views/cmdb/apps/app/create-cluster.html",controller:"CmdbAppCreateClusterCtrl"})}]).controller("CmdbAppDevicesCtrl",["$scope","$state","$q","$uibModal","$localStorage","Dialog","handleAjaxError","toastr","ClusterService","checkPermission","appData","appHostModel","CMDB_RESOURCE_FIELDS_SETTINGS",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){var b=!1,c=!0;_.forEach(k.clusters,function(a){_.forEach(a.deviceList,function(a){a.checked?b=!0:c=!1})}),a.checkedAtLeastOne=b,a.all.checked=c&&b}function o(d){a.removingDevices=!0,c.all(_.map(d,function(a,b){return i.removeDevices(b,a)})).then(function(){h.success("所选主机已移除！"),b.reload()}).catch(function(a){g(a,"移除主机")}).finally(function(){a.removingDevices=!1})}function p(a){a.removing=!0,i.removeCluster(a.instanceId).then(function(){h.success("集群已删除！"),b.reload()}).catch(function(a){g(a,"删除集群")}).finally(function(){a.removing=!1})}a.permissionOfClusterCreate=a.permissionOfClusterEdit=a.permissionOfClusterRemove=j("clusters.manage");var q=m.fixedFields["APP-HOST"]||[],r=m.defaultFields["APP-HOST"]||[],s=m.ignoredFields["APP-HOST"]||[],t=a.attributesMap={};_.forEach(l.attrList,function(a){t[a.id]=a}),a.selectedFields=_.filter(e[l._$storageKey],function(a){return t.hasOwnProperty(a)}),a.selectedFields.length||(a.selectedFields=r);var u=_.map(l.attrList,"id");a.selectedFields=_.orderBy(a.selectedFields,[function(a){var b=_.indexOf(u,a);return b===-1?1/0:b},_.identity],["asc","asc"]),a.selectFields=function(){var c=a.$new(!0);c.modelData=l,c.fixedFields=q,c.ignoredFields=s,c.selectedFields=angular.copy(a.selectedFields),c.noVisitedAt=!0;var f=d.open({templateUrl:"views/cmdb/resources/_select-fields.html",backdrop:"static",scope:c,size:"md",controller:"SelectCmdbResourceFieldsCtrl"});f.result.then(function(a){e[l._$storageKey]=a,b.reload()})},_.forEach(k.clusters,function(a){delete a.checked,_.forEach(a.deviceList,function(a){delete a.checked})}),a.checkedAtLeastOne=!1,a.all={checked:!1},a.rowChecked=function(a){var b=!0,c=!1;_.forEach(a.deviceList,function(a){a.checked?c=!0:b=!1}),a.checked=b&&c,n()},a.groupChecked=function(a){var b=a.checked;_.forEach(a.deviceList,function(a){a.checked=b}),n()},a.allChecked=function(){var b=a.all.checked,c=!1;_.forEach(k.clusters,function(a){a.checked=b,_.forEach(a.deviceList,function(a){a.checked=b,b&&(c=!0)})}),a.checkedAtLeastOne=c},a.removeDevices=function(){var a=0,b={};_.forEach(k.clusters,function(c){_.forEach(c.deviceList,function(d){d.checked&&(b[c.instanceId]||(b[c.instanceId]=[]),b[c.instanceId].push(d.instanceId),a+=1)})}),a&&f.confirm({message:"确定要移除所选的 "+a+" 台主机吗？",isDanger:!0,resolved:function(){o(b)}})},a.removeCluster=function(a){f.confirm({message:"确定要删除集群 <code>"+_.escape(a.name)+"</code> 吗？",html:!0,isDanger:!0,resolved:function(){p(a)}})},a.editCluster=function(b){var c=a.$new(!0);c.clusterForm=angular.copy(b),d.open({templateUrl:"views/cmdb/apps/app/_edit-cluster.html",backdrop:"static",scope:c,controller:"CmdbAppEditClusterCtrl"})},a.$on("update cluster",function(){h.success("集群已修改！"),b.reload()})}]).controller("CmdbAppEditClusterCtrl",["$scope","$uibModalInstance","handleAjaxError","ClusterService",function(a,b,c,d){a.updateCluster=function(){if(!a.formEditCluster.$invalid){var e=_.pick(a.clusterForm,"name","type");a.storing=!0,d.updateCluster(a.clusterForm.instanceId,e).then(function(){b.close(),a.$emit("update cluster")}).catch(function(a){c(a,"修改集群")}).finally(function(){a.storing=!1})}}}]).controller("CmdbAppImportDevicesCtrl",["$scope","$state","$stateParams","handleAjaxError","toastr","ClusterService","appData",function(a,b,c,d,e,f,g){a.importForm={};var h=_.find(g.clusters,{instanceId:c.clusterId});h?a.importForm.clusterId=h.instanceId:g.clusters&&g.clusters.length&&(a.importForm.clusterId=g.clusters[0].instanceId),a.selectDevices=function(b){a.importForm.ipList=_.map(b,"ip").join(", "),a.importForm.deviceIds=_.map(b,"instanceId"),a.deviceCount=b?b.length:0},a.store=function(){if(a.formImportDevices.$invalid){var c=$("form[name=formImportDevices] .ng-invalid"),g=c.closest(".form-group");return void(g.length?g:c).scrollIntoViewInBody()}a.importForm.deviceIds&&a.importForm.deviceIds.length&&(a.storing=!0,f.importDevices(a.importForm.clusterId,a.importForm.deviceIds).then(function(){e.success("主机已添加！"),b.go("cmdb.apps.app.index",null,{reload:!0})}).catch(function(a){d(a,"添加主机")}).finally(function(){a.storing=!1}))}}]).controller("CmdbAppCreateClusterCtrl",["$scope","$state","toastr","Dialog","handleAjaxError","ClusterService","appData",function(a,b,c,d,e,f,g){a.clusterForm={},a.selectDevices=function(b){a.clusterForm.ipList=_.map(b,"ip").join(", "),a.clusterForm.deviceList=_.map(b,"instanceId"),a.deviceCount=b?b.length:0},a.store=function(){if(a.formCreateCluster.$invalid){var d=$("form[name=formCreateCluster] .ng-invalid"),h=d.closest(".form-group");return void(h.length?h:d).scrollIntoViewInBody()}var i=_.pick(a.clusterForm,"name","type","deviceList");i.appId=g.instanceId,a.storing=!0,f.storeCluster(i).then(function(){c.success("集群已创建！"),b.go("cmdb.apps.app.index",null,{reload:!0})}).catch(function(a){e(a,"创建集群")}).finally(function(){a.storing=!1})}}]),angular.module("user.route",[]).config(["$stateProvider",function(a){a.state("user",{abstract:!0,url:"/me",templateUrl:"views/user/user.html",resolve:{userData:["User",function(a){return a.fetchMe()}]},controller:"UserAbstractCtrl"}).state("user.profile",{url:"/profile",templateUrl:"views/user/profile.html",controller:"UserProfileCtrl"}).state("user.passwd",{url:"/passwd",templateUrl:"views/user/passwd.html",controller:"UserPasswdCtrl"}).state("user.key",{url:"/key",templateUrl:"views/user/key.html",controller:"UserKeyCtrl"}).state("user.verifyEmail",{url:"/verify/email?username&code",templateUrl:"views/user/verify-email.html",controller:"UserVerifyEmailCtrl"}).state("user.invitation",{url:"/invitation",templateUrl:"views/user/invitation.html",controller:"UserInvitationCtrl",resolve:{invitationData:["User",function(a){return a.getInvitation()}]}})}]),angular.module("user.ctrl",[]).controller("UserAbstractCtrl",["$scope","checkPermission","userData",function(a,b,c){a.userData=c,a.permissionOfInviteUsers=b("cmdb:user_invite")}]).controller("UserProfileCtrl",["$scope","$state","User","userData","toastr","handleAjaxError","Dialog",function(a,b,c,d,e,f,g){function h(a,b){g.alert({type:"warning",size:"sm",message:b})}a.userForm=angular.copy(d),a.modify=function(){var g=_.pickBy(_.pick(a.userForm,"email","phone"),function(a,b){return a&&a!==d[b]});a.modifing=!0,c.modifyUser(g).then(function(a){e.success("用户信息已修改"),b.go("user.profile",a,{reload:!0})}).catch(function(a){var b=a.data;if(angular.isObject(b))switch(b.code){case 130304:return void h("email","邮箱已被使用，请换一个邮箱");case 130305:return void h("email","手机号已被使用，请换一个号码")}f(a,"修改用户信息")}).finally(function(){a.updating=!1})}}]).controller("UserPasswdCtrl",["$scope","$state","userData","User","toastr","Dialog","handleAjaxError",function(a,b,c,d,e,f,g){a.passData={username:c.username},a.updatePasswd=function(){return a.passData.oldPassword===a.passData.password?void f.alert({type:"warning",message:"新密码不能和老密码相同！"}):a.passData.password!==a.passData.passwordSecond?void f.alert({type:"warning",message:"两次输入的密码不一致！"}):(a.updating=!0,void d.updatePasswd(_.pick(a.passData,"oldPassword","password")).then(function(){e.success("密码已修改"),b.reload()}).catch(function(a){var b=a.data;if(angular.isObject(b))switch(b.code){case 133006:return void f.alert({type:"error",size:"sm",title:"出错了",message:"密码错误"})}g(a,"修改密码")}).finally(function(){a.updating=!1}))}}]).controller("UserKeyCtrl",["$scope","userData",function(a,b){a.userData=b}]).controller("UserVerifyEmailCtrl",["$scope","$state","$stateParams","handleAjaxError","userData","User",function(a,b,c,d,e,f){var g=c.code;return c.username===e.username&&g?(a.verifying=!0,void f.verifyEmail(g).then(function(){a.verified=!0}).catch(function(a){d(a,"验证邮箱")}).finally(function(){a.verifying=!1})):void b.go("user.profile")}]).controller("UserInvitationCtrl",["$scope","$timeout","$window","User","Dialog","handleAjaxError","toastr","invitationData",function(a,b,c,d,e,f,g,h){function i(){a.invitationData.url=c.location.origin+"/signup?code="+a.invitationData.code}function j(){a.updating=!0,d.updateInvitation().then(function(b){g.success("邀请链接已重置！"),a.invitationData=b,i()}).catch(function(a){f(a,"重置邀请链接")}).finally(function(){a.updating=!1})}a.invitationData=h,i(),a.updateInvitation=function(){e.confirm({type:"warning",message:"确定要重置邀请链接？重置后现有的邀请链接将会失效。新的邀请链接有效期为 3 天。",resolved:j})}}]),angular.module("user.service",[]).factory("User",["$http","RequestWrapper",function(a,b){return{fetchMe:function(){return b.object({method:"GET",url:"/api/me"})},updatePasswd:function(a){var c=_.pick(a,"username","oldPassword","password");return b.object({method:"PUT",url:"/api/me/password",data:c})},modifyUser:function(a){var c=_.pick(a,"username","email","phone");return b.object({method:"PUT",url:"/api/me/update",data:c})},verifyEmail:function(a){return b.object({method:"GET",url:"/api/me/verify/email",params:{code:a}})},userAllList:function(){return b.array({method:"GET",url:"/api/me/user",params:{userName:"*"}})},getInvitation:function(){return b.object({method:"GET",url:"/api/me/invitation"})},updateInvitation:function(){return b.object({method:"PUT",url:"/api/me/invitation"})},getUserProfile:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=a.namespace,d=a.key;return void 0===d?b.any({method:"GET",url:"/api/me/profile/"+c}):b.any({method:"GET",url:"/api/me/profile/"+c+"/"+d})},putUserProfile:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=a.namespace,d=a.key,e=a.value;return b.object({method:"PUT",url:"/api/me/profile/"+c+"/"+d,data:{value:e}})}}}]),angular.module("itoa.route",[]).config(["$stateProvider",function(a){a.state("itoa",{abstract:!0,url:"/itoa",templateUrl:"views/itoa/itoa.html",controller:"CapacityAbstractCtrl"}).state("itoa.externals",{url:"?id",templateUrl:"views/externals.html",controller:"ExternalsCtrl",resolve:{linkData:["$stateParams","Externals",function(a,b){return b.getLinkById(a.id)}]}})}]),angular.module("itoa.ctrl",[]).controller("CapacityAbstractCtrl",["$scope","$state",function(a,b){a.navCapacityList=function(){return b.includes("itoa.capacityList")||b.includes("itoa.capacityIndex")},a.navCapacityApp=function(){return b.includes("itoa.capacityApp")},a.navCapacityDevice=function(){return b.includes("itoa.capacityDevice")},a.navCapacitySal=function(){return b.includes("itoa.sal")||b.includes("itoa.bSal")},a.navCapacitySalSet=function(){return b.includes("itoa.slaConfig")}}]),angular.module("itoa.service",[]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]).factory("Itoa",["$http","RequestWrapper",function(a,b){return{fetchCapacity:function(a){return b.object({method:"GET",url:"/api/load-trend",params:{range:a}})},fetchCpuNet:function(a,c){return b.object({method:"GET",url:"/api/load-trend-app",params:{range:a,appId:c}})},fetchIpLoadList:function(a){return b.object({method:"GET",url:"/api/ip-load-list",params:a})},fetchCapacityArea:function(a){return b.object({method:"GET",url:"/api/load-trend-area",params:{range:a}})},fetchLoadList:function(a){return b.object({method:"GET",url:"/api/load-list",params:a})},fetchAppList2:function(a){return b.object({method:"GET",url:"/api/app-list2",params:{"appIds[]":a}})},fetchAppList:function(){return b.object({method:"GET",url:"/api/app-list"})},getAppLoad:function(a){return b.object({method:"GET",url:"/api/app-load",params:{"appIds[]":a}})},getAppsInfo:function(a){return b.object({method:"GET",url:"/api/apps-info",params:{"appIds[]":a}})}}}]).factory("Serviceability",["$http","RequestWrapper",function(a,b){return{getDashboard:function(){return b.object({method:"GET",url:"/api/sal-dashboard"})},fetchSalData:function(a){return b.object({method:"GET",url:"/api/sal-data",params:a})},fetchAppSalList:function(a){return b.object({method:"GET",url:"/api/business-sal-data",params:a})},fetchBusinessSal:function(a,c){return b.object({method:"GET",url:"/api/load-trend-app",params:{range:a,appId:c}})},fetchBusinessList:function(){return b.object({method:"GET",url:"/api/sal-business-list"})},fetchBusinessSet:function(a){return b.object({method:"GET",url:"/api/sal-business-set/"+a})},fetchBusinessTrendData:function(a){return b.object({method:"GET",url:"/api/business-trend-data",params:a})},getSalDetails:function(a){return b.object({method:"GET",url:"/api/get-details",params:{_id:a}})},fetchBusinessAppList:function(a){return b.object({method:"GET",url:"/api/get-business-apps/"+a})},postSet:function(a){return b.object({method:"POST",url:"/api/set-business/",data:a})},changeReasons:function(a,c){return b.object({method:"PUT",url:"/api/change-reasons/"+a,data:c})},getAppTestList:function(a,c){return b.object({method:"GET",url:"/api/detect/test-list-for-itoa",params:{appId:a,page:c}})}}}]),angular.module("monitor.route",["apps.filters"]).config(["$stateProvider",function(a){a.state("monitor",{abstract:!0,url:"/monitor",templateUrl:"views/monitor/monitor.html",controller:"MonitorAbstractCtrl"}).state("monitor.externals",{url:"?id",templateUrl:"views/externals.html",controller:"ExternalsCtrl",resolve:{linkData:["$stateParams","Externals",function(a,b){return b.getLinkById(a.id)}]}})}]),angular.module("monitor.ctrl",[]).controller("MonitorAbstractCtrl",["$scope","$state","$timeout","$localStorage","Dialog",function(a,b,c,d,e){a.navDashboardActive=function(){return b.includes("monitor.dashboard")},a.navAppActive=function(){return b.includes("monitor.app")||b.includes("monitor.topos")},a.navComponentActive=function(){return b.includes("monitor.component")},a.navHostActive=function(){return b.includes("monitor.host")},a.navDutyActive=function(){return b.includes("monitor.alarm")&&!b.includes("monitor.alarm.home.rule")},a.navLogActive=function(){return b.includes("monitor.log")},a.navCollectorActive=function(){return b.includes("monitor.collector")},a.navRuleActive=function(){return b.includes("monitor.alarm.home.rule")};var f="newlyNavIgnoredOfMonitorV3";d[f]||c(function(){var b=e.alert({html:!0,type:"fa fa-thumbs-o-up text-warning",title:"监控 V3.0 发布！",message:'监控 V3.0，全新界面体验！以应用监控为核心，辐射主机监控和组件监控。提供大屏展示，为不同的岗位提供不同的监控视图。<br><a href="/help/doc?page=monitorV3">查看详情</a>',confirmText:"立即体验",callback:function(){d[f]=1}});a.$on("$destroy",function(){b.close()})},300)}]),angular.module("monitor.service",[]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]).filter("alertWay",function(){var a=[null,'<i class="ti ti-email"></i>','<i class="ti ti-comment"></i>','<i class="ti ti-email"></i>&nbsp;<i class="ti ti-comment"></i>'];return function(b){return a[+b]||null}}).filter("comparatorThreshold",function(){var a="";return function(b){switch(b){case 1:a="大于";break;case 2:a="小于";break;case 3:a="比昨天同期波动大于";break;case 4:a="比上周同期波动大于"}return a}}).filter("toNumber",function(){return function(a){return _.toNumber(a)}}).filter("toMinutes",function(){return function(a){if(a>60){var b=_.floor(a/60),c=(a-60*b).toPrecision(2);return b+"小时 "+c+"分钟"}return a?a+"分钟":"1小时"}}).filter("filterParamPre",function(){return function(a,b){return _.includes(b,a.substring(2,a.length-2))?a.substring(2,a.length-2):a}}).factory("GrafanaApi",["$http","RequestWrapper",function(a,b){return{getActualUser:function(){return b.object({method:"GET",url:"/grafana/api/user"})},searchDashboards:function(a){return b.array({method:"GET",url:"/grafana/api/search",params:a})},getDashboard:function(a){return b.object({method:"GET",url:"/grafana/api/dashboards/db/"+a})},starDashboard:function(a){return b.object({method:"POST",url:"/grafana/api/user/stars/dashboard/"+a})},unstarDashboard:function(a){return b.object({method:"DELETE",url:"/grafana/api/user/stars/dashboard/"+a})},removeDashboard:function(a){return b.object({method:"DELETE",url:"/grafana/api/dashboards/db/"+a})}}}]).factory("DashboardService",["$http","RequestWrapper",function(a,b){return{setDefaultDashboard:function(a){return b.object({
method:"PUT",url:"/api/dashboards/default",data:{dashboardId:a}})},getDefaultDashboard:function(){return b.object({method:"GET",url:"/api/dashboards/default"})}}}]).factory("Monitor",["$http","RequestWrapper",function(a,b){return{getSubType:function(){return b.object({method:"GET",url:"/api/alert-sub-type-pie"})},getAlarmTypeDims:function(a){return b.object({method:"GET",url:"/api/alarm-type-dims",params:{alert_item:a}})},getAlarmTypeList:function(){return b.object({method:"GET",url:"/api/alarm-type-list"})},getComparatorList:function(a){return null===a?b.object({method:"GET",url:"/api/comparator-list"}):b.object({method:"GET",url:"/api/comparator-list",params:{alert_type:a}})},getAlarmRuleList:function(a,c){var d={};for(var e in a)d[e.replace(/\./g,"```")]=a[e];var f={method:"GET",url:"/api/rule-list",params:d};return c&&(f.timeout=null),b.object(f)},getNotRecoverAlarmList:function(a){return b.object({method:"GET",url:"/api/monitor/not-recover-alarm",params:a})},getAlarmList:function(a){return b.object({method:"GET",url:"/api/alarm-list",params:a})},getAlarmIpList:function(a){return b.object({method:"GET",url:"/api/alarm-list/ip",params:a})},createRule:function(a){return b.object({method:"POST",url:"/api/create-rule",data:a})},modifyRule:function(a,c){return b.object({method:"PUT",url:"/api/alarm/update/"+a,data:c})},getRuleOne:function(a){return b.object({method:"GET",url:"/api/alarm-rule-one/"+a})},getAppPie:function(){return b.object({method:"GET",url:"/api/app-pie"})},deleteAlarmRule:function(a){return b.object({method:"DELETE",url:"/api/deleteRule/"+a})},getOwnerMap:function(a){return b.object({method:"GET",url:"/api/get-owner-map",params:{timerange:a}})},getIpList:function(a,c){return b.object({method:"GET",url:"/api/get-ip-list",params:{timerange:a,page:c}})},getBusinessTrend:function(a){return b.object({method:"GET",url:"/api/get-business-trend",params:{timerange:a}})},getAppTrend:function(a){return b.object({method:"GET",url:"/api/get-app-trend",params:{timerange:a}})},getAlarmTypeTrend:function(a){return b.object({method:"GET",url:"/api/get-alarm-type-trend",params:{timerange:a}})},getAlarmDeviceList:function(a){return b.object({method:"GET",url:"/api/get-alarm-device-list",params:a})},getDeviceDetails:function(a){return b.object({method:"GET",url:"/api/get-show-ip-details",params:a})},getDeviceDetails2:function(a){return b.object({method:"GET",url:"/api/get-monitor-ip-details",params:a})}}}]).factory("monitorAppHealth",["$http","RequestWrapper",function(a,b){return{getHealthStat:function(){return b.object({method:"GET",url:"/api/app-health-stat"})},getAppCompletionDegree:function(a){return b.object({method:"GET",url:"/api/app-health-completion-degree/"+a})},getAppHealthConfig:function(a){return b.object({method:"GET",url:"/api/app-health-config/"+a})},getHealthAlarmList:function(a){return b.array({method:"GET",url:"/api/app-health-alarm-list",params:a})},getAppHealthList:function(){return b.object({method:"GET",url:"/api/app-health-list"})},getAppHealth:function(a){return b.object({method:"GET",url:"/api/app-health",params:a})},getAppHealthTrend:function(a){return b.object({method:"GET",url:"/api/app-health-trend",params:a})},getIndicatorsTrend:function(a,c){return b.object({method:"GET",url:"/api/app-health-indicators-trend/"+a,params:c})},getIndicatorDetailTrend:function(a,c){return b.object({method:"GET",url:"/api/app-health-indicators-details-trend/"+a,params:c})}}}]).factory("MonitorLink",["$http","RequestWrapper",function(a,b){return{fetchRouteInterface:function(a){return b.object({method:"GET",url:"/api/monitor/link/interface",params:a})},fetchTrendResult:function(a){return b.object({method:"GET",url:"/api/monitor/link/trend",params:a})},fetchRetCodeDist:function(a){return b.object({method:"GET",url:"/api/monitor/link/stat",params:a})},fetchSrcNameStat:function(a){return b.object({method:"GET",url:"/api/monitor/link/stat",params:a})},fetchSrcIPStat:function(a){return b.object({method:"GET",url:"/api/monitor/link/stat",params:a})},fetchDstIPStat:function(a){return b.object({method:"GET",url:"/api/monitor/link/stat",params:a})},fetchDetailResult:function(a){return b.object({method:"GET",url:"/api/monitor/link/details",params:a})},linkSearch:function(a,c){return b.object({method:"GET",url:"/api/monitor/link/search/"+a,params:c})}}}]).factory("MonitorDevice",["$http","RequestWrapper",function(a,b){return{getAlarmDeviceList:function(a){return a.ip=a.ip.trim(),b.object({method:"GET",url:"/api/monitor/device/alarm",params:a})},getDeviceList:function(a){return b.object({method:"GET",url:"/api/monitor/device",params:a})},getDeviceAlarm:function(a){return b.object({method:"GET",url:"/api/alarm/device",params:a})}}}]).factory("MonitorApp",["$http","RequestWrapper",function(a,b){return{fetchApp:function(){return b.object({method:"GET",url:"/api/monitor/app"})},fetchDeviceByApp:function(a){return b.object({method:"GET",url:"/api/monitor/app/"+a+"/device"})}}}]).factory("Collector",["$http","RequestWrapper",function(a,b){return{getComponentList:function(a){return b.object({method:"GET",url:"/api/monitor/collector/component",params:a})},testCollector:function(a){return b.object({method:"POST",url:"/api/monitor/collector/test",data:a})},fetchTestResult:function(a){return b.object({method:"GET",url:"/api/monitor/collector/test/"+a})},createCollector:function(a){return b.object({method:"POST",url:"/api/monitor/collector",data:a})},listCollector:function(a){return b.object({method:"GET",url:"/api/monitor/collector",params:a})},deleteCollector:function(a){return b.object({method:"DELETE",url:"/api/monitor/collector/"+a})},listCollectorMetric:function(a){return b.object({method:"GET",url:"/api/monitor/collector/metric",params:a})},getMetricResultList:function(a){return b.object({method:"GET",url:"/api/monitor/collector/result",params:a})},relateAppToComponent:function(a,c){return b.object({method:"PUT",url:"/api/monitor/collector/"+a+"/relate-app",data:c})},relateComponentToApp:function(a,c){return b.object({method:"PUT",url:"/api/monitor/collector/"+a+"/relate-component",data:c})},getLastResult:function(a,c){return b.object({method:"GET",url:"/api/monitor/result/last/"+a,params:c})},getAllConfigCount:function(){return b.object({method:"GET",url:"/api/monitor/collector/count"})}}}]).factory("MonitorOld",["$http","RequestWrapper",function(a,b){return{getSubType:function(){return b.object({method:"GET",url:"/api/alert-sub-type-pie-old"})},getAlarmTypeDims:function(a){return b.object({method:"GET",url:"/api/alarm-type-dims-old",params:{alert_item:a}})},getAlarmTypeList:function(){return b.object({method:"GET",url:"/api/alarm-type-list-old"})},getComparatorList:function(a){return null===a?b.object({method:"GET",url:"/api/comparator-list-old"}):b.object({method:"GET",url:"/api/comparator-list-old",params:{alert_type:a}})},getAlarmRuleList:function(a,c){var d={};for(var e in a)d[e.replace(/\./g,"```")]=a[e];var f={method:"GET",url:"/api/rule-list-old",params:d};return c&&(f.timeout=null),b.object(f)},getAlarmList:function(a){return b.object({method:"GET",url:"/api/alarm-list-old",params:a})},getAlarmIpList:function(a){return b.object({method:"GET",url:"/api/alarm-list/ip-old",params:a})},createRule:function(a){return b.object({method:"POST",url:"/api/create-rule-old",data:a})},getRuleOne:function(a){return b.object({method:"GET",url:"/api/alarm-rule-one-old/"+a})},getAppPie:function(){return b.object({method:"GET",url:"/api/app-pie-old"})},deleteAlarmRule:function(a){return b.object({method:"DELETE",url:"/api/deleteRule-old/"+a})},getOwnerMap:function(a){return b.object({method:"GET",url:"/api/get-owner-map-old",params:{timerange:a}})},getIpList:function(a,c){return b.object({method:"GET",url:"/api/get-ip-list-old",params:{timerange:a,page:c}})},getBusinessTrend:function(a){return b.object({method:"GET",url:"/api/get-business-trend-old",params:{timerange:a}})},getAppTrend:function(a){return b.object({method:"GET",url:"/api/get-app-trend-old",params:{timerange:a}})},getAlarmTypeTrend:function(a){return b.object({method:"GET",url:"/api/get-alarm-type-trend-old",params:{timerange:a}})},getAlarmDeviceList:function(a){return b.object({method:"GET",url:"/api/get-alarm-device-list-old",params:a})},getDeviceDetails:function(a){return b.object({method:"GET",url:"/api/get-show-ip-details-old",params:a})},getDeviceDetails2:function(a){return b.object({method:"GET",url:"/api/get-monitor-ip-details-old",params:a})}}}]),angular.module("monitor.directive",[]).directive("easyTable",function(){return{restrict:"E",replace:!0,scope:{allData:"=allData",fields:"=fields",extraSearch:"=?extraSearch",showSearch:"@?showSearch",showPagination:"@?showPagination",ellipsis:"@?ellipsis",getRowClass:"=?getRowClass",searchBackend:"@?searchBackend",notData:"@?notData",statList:"=?statList"},templateUrl:"/views/monitor/_easy-table.html",controller:["$scope","$state","$stateParams","$localStorage",function(a,b,c,d){a.allData=a.allData||{data:[]},a.fields=a.fields||[],a.extraSearch=a.extraSearch||[],a.showSearch=a.showSearch||"true",a.showPagination=a.showPagination||"true",a.ellipsis=a.ellipsis||"true",a.searchBackend=a.searchBackend||"false",a.getRowClass=a.getRowClass||function(){return""},a.notData=a.notData||"无数据",a.statList=a.statList||[];var e=b.current.name;d[e]=d[e]||{};var f={};_.forEach(a.fields,function(a){"undefined"==typeof a.sort&&(a.sort=!0),f[a.key]=a}),a.getValueByDefault=function(a,b){return _.isUndefined(b[a])?"":b[a]},a.clickField=function(a,b){a.click&&a.click(a.key,b)},a.filters={q:"",data:[],page:1,pageSize:20,pageSizeList:[20,50,100,300],total:0,sortBy:"alarmCount",sortOrder:"desc"};var g=function(b,c){var d=!0;if(b){d=!1;for(var e="",f="",g=0;g<a.fields.length;g+=1)if(e=a.fields[g],e.filter&&(f=e.getValue?e.getValue(e.key,c):c[e.key],!_.isNil(f)&&f.toString().toLowerCase().indexOf(b.toLowerCase())!==-1)){d=!0;break}}return d},h=function(b,c,d){return _.orderBy(b,function(b){if(_.isNumber(b[c]))return b[c];if(_.isEmpty(b[c]))return"";var d=f[c],e="";return e=d&&d.getValue?d.getValue(d.key,b):a.getValueByDefault(c,b)},[d])},i=function(c,d){a.filters.data=_.filter(a.allData.data,function(b){var c=!0;return a.extraSearch.forEach(function(d){c&&(c="q"!==d.type||d.fun?d.fun(a.filters[d.key],b):g(a.filters.q,b))}),a.statList.forEach(function(a){c&&a.activeFilter&&(c=_[a.comparator](b[a.key],a.threshold))}),c}),""!==a.filters.sortOrder&&(a.filters.data=h(a.filters.data,a.filters.sortBy,a.filters.sortOrder)),a.filters.total=a.filters.data.length,a.filters.data=a.filters.data.slice((a.filters.page-1)*a.filters.pageSize,a.filters.page*a.filters.pageSize),"init"!==d&&b.transitionTo(b.current.name,c,{notify:!1})},j=function(c,d){"init"!==d&&b.go(b.current.name,c,{location:"replace",reload:!0,inherit:!1}),a.filters.data=a.allData.data,a.filters.total=a.allData.total},k=function(){d[e].pageSize=a.filters.pageSize,_.has(b.params,"onlyAlarm")&&(d[e].onlyAlarm=a.filters.onlyAlarm),_.has(b.params,"onlyMe")&&(d[e].onlyMe=a.filters.onlyMe)};a.search=function(c){var d={};_.forEach(b.params,function(b,c){d[c]="undefined"==typeof a.filters[c]?b:a.filters[c]}),k(),"true"!==a.searchBackend?i(d,c):j(d,c)},a.pageChange=function(){a.search()},a.sortBy=function(b){b.key!==a.filters.sortBy?a.filters.sortOrder="desc":""===a.filters.sortOrder?a.filters.sortOrder="desc":"desc"===a.filters.sortOrder?a.filters.sortOrder="asc":a.filters.sortOrder="",a.filters.sortBy=b.key,a.search()};var l=function(){_.each(a.allData.data,function(b){_.each(a.statList,function(a){a.value+=_[a.comparator](b[a.key],a.threshold)?1:0})})};a.filterByStat=function(b){var c=b.activeFilter;_.each(a.statList,function(a){a.activeFilter=!1}),b.activeFilter=!c,a.search()};var m=function(){var b=d[e];a.filters.page=_.toInteger(c.page)||a.filters.page,a.filters.pageSize=_.toInteger(c.pageSize)||_.toInteger(b.pageSize)||a.filters.pageSize,a.filters.q=c.q||a.filters.q,a.filters.sortBy=c.sortBy||a.filters.sortBy,a.filters.sortOrder=c.sortOrder||a.filters.sortOrder,a.extraSearch.forEach(function(d){a.filters[d.key]=c[d.key]||b[d.key]||""}),l(),a.search("init")};a.getStatClass=function(){return"col-sm-"+12/a.statList.length+" col-md-"+12/a.statList.length},a.$watch("allData",function(){m()},!0)}]}}).directive("isEllipsis",function(){return{link:function(a,b){b[0].offsetWidth+2<b[0].scrollWidth&&b.addClass("aaaa")}}}).directive("noticePannel",function(){return{restrice:"AE",showNotice:"=",noticeFont:"=",link:function(a,b){for(var c=b.innerWidth(),d=0,e=0,f=$('<div class="marquee"><strong>公告</strong>：</div>'),g=0;g<a.showNotice.length;g+=1){var h=a.noticeFont,i=$('<i class="fa fa-lightbulb-o" aria-hidden="true"></i><span style="padding-right: 25px; font-size:'+h+'px"> '+a.showNotice[g]+"</span>"),j=(a.showNotice[g].length+1)*h+2;if(d+=j,f.append(i),d>=c){e=a.showNotice.length-g;break}}b.append(f),e&&b.append('<a href="/monitor/alarm/notice?sortBy=update_time&sortOrder=desc" class="more-notice">更多('+e+")</a>")}}}),function(){function a(a,b,c,d){function e(a){a.origin===c.location.origin&&a.data&&"dashboard loaded"===a.data.action&&(d(function(){h.onLoad()}),i())}var f,g,h=this,i=angular.noop;h.iframeId=_.uniqueId("grafana-iframe-"),h.$onInit=function(){var b=a.trustAsResourceUrl("/grafana/"+h.uri);h.src=b,h.height&&(h.style={height:h.height+"px"}),h.onLoad&&(c.addEventListener("message",e),i=function(){c.removeEventListener("message",e)})},h.$postLink=function(){g=b.find("iframe"),h.height||g.on("load",function(){g.iFrameResize({heightCalculationMethod:"bodyScroll"}),f=g[0].iFrameResizer})},h.$onDestroy=function(){f&&(f.close(),f=null),i()}}function b(a,b,c,d){function e(a){if(i)try{i[0].contentWindow.postMessage(a,b.location.origin)}catch(a){}}function f(a){e({action:"time changed",time:a})}function g(a){e({action:"params changed",params:a})}function h(){e({action:"scroll"})}var i,j=this;j.$onInit=function(){j.uri="dashboard/db/"+j.dbSlug;var a=_.defaults({},j.dbParams);_.assign(a,j.range);var b=$.param(a,!0);b&&(j.uri+="?"+b)},j.$onChanges=function(a){var b=a.dbParams;if(b&&!b.isFirstChange()){var c=_.pick(b.currentValue,["from","to"]);_.isEmpty(c)||f(c);var d=_.omit(b.currentValue,["from","to"]);_.isEmpty(d)||g(d)}var e=a.range;e&&!e.isFirstChange()&&(_.isEmpty(e.currentValue)||f(e.currentValue))},j.$postLink=function(){i=a.find("iframe"),c.on("scroll",h)},j.handleLoad=function(){j.onLoad&&j.onLoad()};var k=d.$on("datetime range changed",function(a,b){b.observer===j.observer&&f(b.range)});j.$onDestroy=function(){k(),c.off("scroll",h)}}angular.module("monitor.components",[]).component("grafanaDashboard",{template:'<div style="margin:0 -25px;">\n<grafana-page uri="::$ctrl.uri" height="::$ctrl.height" on-load="$ctrl.handleLoad()"></grafana-page>\n</div>',bindings:{dbSlug:"<",dbParams:"<?",range:"<?",observer:"<?",height:"<?",onLoad:"&?"},controller:b}).component("grafanaPage",{template:'<div><iframe id="{{::$ctrl.iframeId}}" ng-src="{{::$ctrl.src}}" style="border:0;margin:0;width:100%;" scrolling="no" ng-style="$ctrl.style"></iframe></div>',bindings:{uri:"<",height:"<?",onLoad:"&?"},controller:a}),a.$inject=["$sce","$element","$window","$timeout"],b.$inject=["$element","$window","$document","$rootScope"]}(),angular.module("monitor.dashboard",["url.matcher"]).config(["$stateProvider",function(a){a.state("monitor.grafanaLogin",{url:"/grafana/login",template:'<div style="margin-top:-60px;padding:20px;">{{loadError ? loadErrorMessage : "正在加载..."}}</div><iframe ng-src="/grafana/easyops-ready" style="border:0;margin:0;width:100%;height:0;display:block"></iframe>',controller:"GrafanaLoginCtrl"}).state({name:"monitor.dashboard.**",url:"/dashboard",lazyLoad:function(){return System.import("dashboard/states").then(function(a){return a.default})}})}]).controller("GrafanaLoginCtrl",["$scope","$window","Dialog",function(a,b,c){function d(d){if(d.origin===b.location.origin&&d.data&&"error"===d.data.action){var e=d.data.data;a.loadError=!0,a.loadErrorMessage=e.error,c.alert({type:"error",title:("/grafana/login/generic_oauth"===e.pathname?"登录":"加载")+"仪表盘发生异常",message:e.error})}}b.addEventListener("message",d),a.$on("$destroy",function(){b.removeEventListener("message",d)})}]),angular.module("capacity.route",[]).config(["$stateProvider",function(a){a.state("itoa.capacityIndex",{url:"/capacity/index",templateUrl:"views/itoa/cap/graphs.html",resolve:{capacityDistribution:["Capacity",function(a){return a.fetchCapacityDistribution()}],capacityAverage:["Capacity",function(a){return a.fetchCapacityAverage()}],capacityTopApp:["Capacity",function(a){return a.fetchCapacityTopApp()}],capacityTopDevice:["Capacity",function(a){return a.fetchCapacityTopDevice()}]},controller:"CapacityIndexCtrl"}).state("itoa.capacityApp",{url:"/capacity/app?page&page_size&date&sort",templateUrl:"views/itoa/cap/app.html",resolve:{appCapacityDistribution:["Capacity","$stateParams",function(a,b){return a.fetchAppCapacityDistribution(b.date)}],appCapacityList:["Capacity","$stateParams",function(a,b){return a.fetchAppCapacityList(angular.copy(b))}],deps:["depends",function(a){return a("components/chartjs")}]},controller:"CapacityAppCtrl"}).state("itoa.capacityDevice",{url:"/capacity/device?page&page_size&date&sort",templateUrl:"views/itoa/cap/device.html",resolve:{deviceCapacityDistribution:["Capacity","$stateParams",function(a,b){return a.fetchDeviceCapacityDistribution(b.date)}],deviceCapacityList:["Capacity","$stateParams",function(a,b){return a.fetchDeviceCapacityList(angular.copy(b))}],deps:["depends",function(a){return a("components/chartjs")}]},controller:"CapacityDeviceCtrl"})}]),angular.module("capacity.ctrl",[]).controller("CapacityIndexCtrl",["$scope","$state","capacityDistribution","capacityAverage","capacityTopApp","capacityTopDevice",function(a,b,c,d,e,f){a.capacityDistribution=c.data,a.capacityAverage=d.data;var g=e.appIdMap,h=_.map(e.data,function(a){return{appId:a.appId,name:g[a.appId],y:+(100*a["cap.app.app__max"]).toPrecision(15)}}),i=_.map(f.data,function(a){return{ip:a.ip,name:a.ip,y:+(100*a["cap.host.host__max"]).toPrecision(15)}});a.appNameMap=g,a.appTopData=h,a.deviceTopData=i}]).controller("CapacityAppCtrl",["$scope","$state","$stateParams","$uibModal","appCapacityDistribution","appCapacityList","Dialog","Capacity",function(a,b,c,d,e,f,g,h){var i=e.data.high+e.data.medium+e.data.low;a.appCapacityDistribution=e.data,a.appCapacityTotal=i,a.appCapacityList=f.data,a.appNameMap=f.appIdMap,a.appOwnerMap=f.appOwnerMap;var j={page:1,sort:"desc"},k={page:c.page||j.page,sort:c.sort||j.sort};a.filters=k,a.totalItems=+f.total||0,a.itemsPerPage=f.page_size;var l,m=new Date,n=moment(m).format("YYYYMMDD"),o=moment(m).subtract(1,"days").format("YYYYMMDD"),p=moment(m).subtract(2,"days").format("YYYYMMDD"),q=new Date;q.setDate(q.getDate()-1);var r=new Date;r.setDate(r.getDate()-2);var s={today:m,yesterday:q,beforeYesterday:r};if(c.date)switch(c.date){case n:a.dt=m,l="today";break;case o:a.dt=q,l="yesterday";break;case p:a.dt=r,l="beforeYesterday";break;default:a.fakeDate=c.date.substr(0,4)+"-"+c.date.substr(4,2)+"-"+c.date.substr(6,2),a.dt=new Date(c.date.substr(0,4),c.date.substr(4,2)-1,c.date.substr(6,2))}else a.dt=m,l="today";var t=function(){b.go("itoa.capacityApp",{page:k.page===j.page?null:k.page,date:moment(a.dt).format("YYYYMMDD"),sort:k.sort},{reload:!0})};a.dateList=[{label:"今天",value:"today"},{label:"昨天",value:"yesterday"},{label:"前天",value:"beforeYesterday"}],a.isActiveType=function(a){return a.value===l},a.setActiveType=function(b){a.loading=!0,l=b.value,a.dt=s[b.value],t()},a.maxDate=m,a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={formatYear:"yy",startingDay:1},a.changeDate=function(){t()};var u;a.appTrendShowChart=function(b,e,f){var g=a.$new();g.appName=e;var i=c.date||n,j=f||"day";g.dateList=[{label:"当天",value:"day"},{label:"1周",value:"week"},{label:"1月",value:"month"}],g.isActiveType=function(a){return a.value===j};var k=function(){h.fetchAppCapacityHistory(b,i,j).then(function(c){var d={},e={};d.st=c.st,d.step=c.step,d.et=c.et;var f=[],g=[],h=[],i={};_.forEach(c.data,function(a){i[a.appId]=a["cap.app.app"],e[a.appId]=[]});for(var k=0;k<i[b].length;k++)e[b][k]={x:1e3*c.st+c.step*k*1e3,y:i[b][k]},g[k]={x:1e3*c.st+c.step*k*1e3,y:.3},h[k]={x:1e3*c.st+c.step*k*1e3,y:.8};var l=_.max(i[b]),m=_.indexOf(i[b],l);a.topValueDes=moment(f[m]).format("YYYY年M月DD日 ah:mm")+", 最大容量: "+(100*l).toPrecision(4)+"%";for(var n=0,o=i[b].length-1,p=0;p<i[b].length&&null===i[b][p];p++)n++;for(var q=i[b].length-1;q>0&&null===i[b][q];q--)o--;a.appConfig={type:"line",data:{labels:f,datasets:[{label:"容量",fill:!1,pointRadius:0,borderWidth:2,borderColor:"#0070CC",data:e[b]},{label:"低容量",fill:!1,pointRadius:0,pointHoverRadius:0,pointHoverBorderWidth:2,borderWidth:2,borderColor:"#EBCB8B",borderDash:[5,2],data:g},{label:"高容量",fill:!1,pointRadius:0,pointHoverRadius:0,pointHoverBorderWidth:2,borderWidth:2,borderColor:"#ff6161",borderDash:[5,2],data:h}]},options:{crosshair:{hover:!0,color:"#aaa",pointRadius:4,pointBorderWidth:2,showTooltip:!0},legend:{labels:{boxWidth:20,generateLabels:function(a){return _.map(a.data.datasets,function(b,c){return{text:b.label,fillStyle:b.borderColor,hidden:!a.isDatasetVisible(c),lineWidth:2,strokeStyle:b.borderColor,datasetIndex:c}})}}},hover:{mode:"index",intersect:!1,onHover:function(b){if(b.length){var c=b[0]._index;c<n?a.appConfig.options.crosshair.xIndex=n:c>o?a.appConfig.options.crosshair.xIndex=o:a.appConfig.options.crosshair.xIndex=c}else a.appConfig.options.crosshair.xIndex=null}},tooltips:{enabled:!1},scales:{xAxes:[{type:"time",time:{displayFormats:{hour:"H:mm",day:"M月D日",week:"M月D日"},tooltipFormat:"MMMD日 ah:mm",unit:"day"===j?"hour":"day",unitStepSize:"day"===j?3:"week"===j?1:4},gridLines:{drawBorder:!0,drawOnChartArea:!1},ticks:{maxRotation:0,callback:function(a,b,d){var e=moment(d[b]),f=new Date(e),g=f.getTime();return"month"===j&&(g/1e3-c.st)/86400%4?"":"0:00"===e.format("H:mm")?e.format("M月D日"):a}}}],yAxes:[{ticks:{min:0,stepSize:.25,suggestedMax:1,callback:function(a){return 100*a+"%"}},gridLines:{display:!1,drawBorder:!1}}]}}}}).catch(function(){}).finally(function(){})};g.setActiveType=function(a){j=a.value,k()},u=d.open({templateUrl:"views/itoa/cap/_app.html",backdrop:"static",scope:g}),u.rendered.then(k())},a.pageChange=function(){var a=c.date||n;b.go("itoa.capacityApp",{page:k.page===j.page?null:k.page,date:a,sort:k.sort},{reload:!0})},a.sortCapacity=function(){"asc"===a.filters.sort?k.sort="desc":k.sort="asc",a.pageChange()}}]).controller("CapacityDeviceCtrl",["$scope","$state","$stateParams","deviceCapacityDistribution","deviceCapacityList","Dialog","$uibModal","Capacity",function(a,b,c,d,e,f,g,h){var i=d.data.high+d.data.medium+d.data.low;a.deviceCapacityDistribution=d.data,a.deviceCapacityTotal=i,a.deviceCapacityList=e.data,a.deviceNameMap=e.deviceIdMap,a.deviceOwnerMap=e.deviceOwnerMap;var j={"cap.host.cpu":"CPU","cap.host.io":"磁盘IO","cap.host.net":"网卡"};a.characterMap=j;var k={page:1,sort:"desc"},l={page:c.page||k.page,sort:c.sort||k.sort};a.filters=l,a.totalItems=+e.total||0,a.itemsPerPage=e.page_size;var m,n=new Date,o=moment(n).format("YYYYMMDD"),p=new Date;p.setDate(p.getDate()-1);var q=moment(p).format("YYYYMMDD"),r=new Date;r.setDate(r.getDate()-2);var s=moment(r).format("YYYYMMDD"),t={today:n,yesterday:p,beforeYesterday:r};if(c.date)switch(c.date){case o:a.dt=n,m="today";break;case q:a.dt=p,m="yesterday";break;case s:a.dt=r,m="beforeYesterday";break;default:a.fakeDate=c.date.substr(0,4)+"-"+c.date.substr(4,2)+"-"+c.date.substr(6,2),a.dt=new Date(c.date.substr(0,4),c.date.substr(4,2)-1,c.date.substr(6,2))}else a.dt=n,m="today";var u=function(){b.go("itoa.capacityDevice",{page:l.page===k.page?null:l.page,date:moment(a.dt).format("YYYYMMDD"),sort:l.sort},{reload:!0})};a.dateList=[{label:"今天",value:"today"},{label:"昨天",value:"yesterday"},{label:"前天",value:"beforeYesterday"}],a.isActiveType=function(a){return a.value===m},a.setActiveType=function(b){a.loading=!0,m=b.value,a.dt=t[b.value],u()},a.maxDate=n,a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={formatYear:"yy",startingDay:1},a.changeDate=function(){u()},a.getCharacterMap=function(a){return a.indexOf("_")>-1&&(a=a.split("_")[1]),j[a]};var v;a.deviceTrendShowChart=function(b,d,e){var f=a.$new();d.indexOf("_")>-1&&(d=d.split("_")[1]),f.ip=b,f.character=j[d];var i=c.date||o,k=e||"day";f.dateList=[{label:"当天",value:"day"},{label:"1周",value:"week"},{label:"1月",value:"month"}],f.isActiveType=function(a){return a.value===k};var l=function(){h.fetchDeviceCapacityHistory(b,i,k).then(function(c){var d={},e=[],f=[],g=[],h={};_.forEach(c.data,function(a){h[a.ip]=a["cap.host.host"],d[a.ip]=[]});for(var i=0;i<h[b].length;i++)d[b][i]={x:1e3*c.st+c.step*i*1e3,y:h[b][i]},f[i]={x:1e3*c.st+c.step*i*1e3,y:.3},g[i]={x:1e3*c.st+c.step*i*1e3,y:.8};var j=_.max(h[b]),l=_.indexOf(h[b],j);a.topValueDes=moment(e[l]).format("YYYY年M月DD日 ah:mm")+", 最大容量: "+(100*j).toPrecision(4)+"%";for(var m=0,n=h[b].length-1,o=0;o<h[b].length&&null===h[b][o];o++)m++;for(var p=h[b].length-1;p>0&&null===h[b][p];p--)n--;a.deviceConfig={type:"line",data:{datasets:[{label:"容量",fill:!1,pointRadius:0,borderWidth:2,borderColor:"#0070CC",data:d[b]},{label:"低容量",fill:!1,pointRadius:0,pointHoverRadius:0,pointHoverBorderWidth:2,borderWidth:2,borderColor:"#EBCB8B",borderDash:[5,2],data:f},{label:"高容量",fill:!1,pointRadius:0,pointHoverRadius:0,pointHoverBorderWidth:2,borderWidth:2,borderColor:"#ff6161",borderDash:[5,2],data:g}]},options:{crosshair:{hover:!0,color:"#aaa",pointRadius:4,pointBorderWidth:2,showTooltip:!0},legend:{labels:{boxWidth:20,generateLabels:function(a){return _.map(a.data.datasets,function(b,c){return{text:b.label,fillStyle:b.borderColor,hidden:!a.isDatasetVisible(c),lineWidth:2,strokeStyle:b.borderColor,datasetIndex:c}})}}},tooltips:{enabled:!1},hover:{mode:"index",intersect:!1,onHover:function(b){if(b.length){var c=b[0]._index;c<m?a.deviceConfig.options.crosshair.xIndex=m:c>n?a.deviceConfig.options.crosshair.xIndex=n:a.deviceConfig.options.crosshair.xIndex=c}else a.deviceConfig.options.crosshair.xIndex=null}},scales:{xAxes:[{type:"time",time:{tooltipFormat:"MMMD日 H:mm",displayFormats:{minute:"H:mm",hour:"H:mm",day:"M月D日",week:"M月D日"},unit:"day"===k?"hour":"day",unitStepSize:"day"===k?3:"week"===k?1:4},gridLines:{drawBorder:!0,drawOnChartArea:!1},ticks:{maxRotation:0,callback:function(a,b,d){var e=moment(d[b]),f=new Date(e),g=f.getTime();return"month"===k&&(g/1e3-c.st)/86400%4?"":"0:00"===e.format("H:mm")?e.format("M月D日"):a}}}],yAxes:[{ticks:{min:0,stepSize:.25,suggestedMax:1,callback:function(a){return 100*a+"%"}},gridLines:{display:!1,drawBorder:!1}}]}}}}).catch(function(){}).finally(function(){})};f.setActiveType=function(a){k=a.value,l()},v=g.open({templateUrl:"views/itoa/cap/_device.html",backdrop:"static",scope:f}),v.rendered.then(l())},a.pageChange=function(){var a=c.date||o;b.go("itoa.capacityDevice",{page:l.page===k.page?null:l.page,date:a,sort:l.sort},{reload:!0})},a.sortCapacity=function(){"asc"===a.filters.sort?l.sort="desc":l.sort="asc",a.pageChange()}}]),angular.module("capacity.service",[]).factory("Capacity",["$http","RequestWrapper",function(a,b){return{fetchCapacityDistribution:function(){return b.object({method:"GET",url:"/api/capacity-index"})},fetchCapacityAverage:function(){return b.object({method:"GET",url:"/api/capacity-average"})},fetchCapacityTopApp:function(a){return b.object({method:"GET",url:"/api/capacity-app-top",params:{limit:a}})},fetchCapacityTopDevice:function(a){return b.object({method:"GET",url:"/api/capacity-device-top",params:{limit:a}})},fetchAppCapacityDistribution:function(a){return b.object({method:"GET",url:"/api/capacity-app-distribution",params:{date:a}})},fetchAppCapacityList:function(a){return b.object({method:"GET",url:"/api/capacity-app-list",params:a})},fetchAppCapacityHistory:function(a,c,d){return b.object({method:"GET",url:"/api/capacity-app-history/"+a,params:{date:c,dateType:d}})},fetchDeviceCapacityDistribution:function(a){return b.object({method:"GET",url:"/api/capacity-device-distribution",params:{date:a}})},fetchDeviceCapacityList:function(a){return b.object({method:"GET",url:"/api/capacity-device-list",params:a})},fetchDeviceCapacityHistory:function(a,c,d){return b.object({method:"GET",url:"/api/capacity-device-history",params:{ip:a,date:c,dateType:d}})}}}]),angular.module("permission.route",[]).config(["$stateProvider",function(a){a.state("permission",{abstract:!0,url:"/permission",templateUrl:"views/permission/permission.html",controller:"PermAbstractCtrl",resolve:{systemData:["Permission",function(a){return a.fetchRoleList({role:"系统管理员"})}]}}).state("permission.list",{url:"/list?q&role&page&pageSize",templateUrl:"views/permission/list.html",resolve:{roleList:["Permission",function(a){return a.fetchRoleList()}],permList:["Permission","$stateParams",function(a,b){return a.fetchPermList(angular.copy(b))}]},controller:"PermListCtrl"}).state("permission.role",{url:"/role",templateUrl:"views/permission/role.html",resolve:{roleList:["Permission",function(a){return a.fetchRoleList()}]},controller:"RoleListCtrl"}).state("permission.roleDetail",{url:"/detail?id",templateUrl:"views/permission/role-detail.html",resolve:{userList:["UserManage",function(a){return a.fetchUserList()}],roleData:["Permission","$stateParams",function(a,b){return a.fetchRoleDetail(angular.copy(b))}],permList:["Permission","$stateParams",function(a,b){return a.fetchPermList(angular.copy(b))}]},controller:"RoleDetailCtrl"})}]),angular.module("permission.ctrl",[]).controller("PermAbstractCtrl",["$scope","$state",function(a,b){a.navPermissionActive=function(){return b.includes("permission.list")},a.navRoleActive=function(){return b.includes("permission.role")||b.includes("permission.roleDetail")}}]).controller("PermListCtrl",["$scope","$state","$stateParams","$filter","Dialog","toastr","handleAjaxError","Permission","systemData","USERNAME","permList","roleList",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=i[0].user;a.search=c.q,a.isAdmin=function(){return _.includes(m,j)},a.roleList=l,a.permList=k,a.flags={searchRole:_.find(a.roleList,function(a){return a.role===c.role}),editPermFlag:!1,roles:{},changeFlag:{}},a.form={},a.roleChoices=[{role:"全部角色",id:""}],_.forEach(l,function(b){a.roleChoices.push(b),a.form[b.id]={},a.flags.changeFlag[b.id]={},a.flags.roles[b.id]=!1,_.forEach(b.permission,function(c){a.form[b.id][c]=!0})}),a.flags.searchRole||(a.flags.searchRole=a.roleChoices[0]),a.filterSysAndPerm=function(b){return!a.search||(b.remark=b.remark||"",b.system=b.system||"",b.system.toLowerCase().indexOf(a.search.toLowerCase())!==-1||b.remark.toLowerCase().indexOf(a.search.toLowerCase())!==-1)},a.inRole=function(a,b){return _.includes(a,b)},a.editPerm=function(){a.flags.editPermFlag=!0},a.exitEditPerm=function(){b.go("permission.list",{role:a.flags.searchRole.role,q:a.search},{reload:!0})},a.changeRolePerm=function(b,c){var d=a.form[b][c]?h.addRolePerm:h.deleteRolePerm,e=a.form[b][c]?"添加权限":"删除权限";d(b,[c]).then(function(d){d.code?f.error(e+"失败","",{timeOut:2e3}):(f.success(e+"成功","",{timeOut:2e3}),a.flags.changeFlag[b][c]=!a.flags.changeFlag[b][c])}).catch(function(a){g(a,e)})},a.changeRolePermBatch=function(b){var c=a.flags.roles[b]?h.addRolePerm:h.deleteRolePerm,i=a.flags.roles[b]?"批量添加权限":"批量删除权限",j=_.map(d("filter")(a.permList,a.search),"id");e.confirm({type:"warning",message:"确定 <code>"+i+"</code> 吗？共 "+j.length+" 个",html:!0,resolved:function(){c(b,j).then(function(c){c.code?f.error(i+"失败","",{timeOut:2e3}):(f.success(i+"成功","",{timeOut:2e3}),_.forEach(j,function(c){a.form[b][c]=a.flags.roles[b],a.flags.changeFlag[b][c]=!a.flags.changeFlag[b][c]}))}).catch(function(a){g(a,i)})},rejected:function(){return a.flags.roles[b]=!a.flags.roles[b]}})}}]).controller("RoleListCtrl",["$scope","$state","$uibModal","toastr","handleAjaxError","Permission","roleList","systemData","USERNAME",function(a,b,c,d,e,f,g,h,i){a.roleList=g;var j=h[0].user;a.isAdmin=function(){return _.includes(j,i);
},a.roleDetail=function(a){b.go("permission.roleDetail",{id:a})};var k;a.addRole=function(){var b=a.$new();k=c.open({templateUrl:"views/permission/_add-role.html",backdrop:"static",scope:b})},a.form={name:""},a.duplicateRoleName=function(){return!_.isEmpty(_.find(a.roleList,function(b){return b.role===a.form.name}))},a.canSubmit=function(){return!!a.form.name&&(!a.duplicateRoleName()&&!(a.form.name.length>30))},a.addRoleConfirm=function(){f.addRole(a.form.name).then(function(a){a.code?d.error("添加角色失败，"+a.msg):d.success("添加角色成功"),k.close(),b.go("permission.role",{},{reload:!0})}).catch(function(a){e(a,"添加角色")}).finally(function(){})}}]).controller("RoleDetailCtrl",["$scope","$state","$stateParams","$uibModal","Dialog","toastr","roleData","systemData","permList","Abject","Permission","handleAjaxError","USERNAME","userList",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b){var c=[];return _.forEach(a.permissionSystem,function(a){var d=b[a],e=_.filter(d,{available:!0});e.length&&(c[a]=e)}),c}var p=[];_.forEach(g.user,function(a){var b=_.find(n,{name:a});b&&p.push(b)}),a.totalItems=p.length,a.filter={userName:"",permission:"",page:1},a.itemsPerPage=20,a.showUserList=angular.copy(p).splice((a.filter.page-1)*a.itemsPerPage,a.itemsPerPage),a.pageChange=function(){a.showUserList=angular.copy(p).splice((a.filter.page-1)*a.itemsPerPage,a.itemsPerPage)},a.roleData=g;var q=[];a.hasPermission=!0,a.permissionCheckList=[],a.permissionIdMap=g.permissionIdMap,a.permissionSystem=["作业平台","调度平台","持续部署","CMDB"],_.forEach(i,function(b){_.forEach(a.permissionSystem,function(a){b.system===a&&(q[a]||(q[a]=[]),_.find(g.permission,function(a){return a===b.id})?q[a].push({permissionId:b.id,name:b.remark,system:b.system,available:!0}):q[a].push({permissionId:b.id,name:b.remark,system:b.system,available:!1}))})}),a.showPermissionList=q,a.showExistedPermissions=!1,a.roleData=g;var r=c.id,s=h[0].user;a.flags={loading:!1},a.adminRole=function(){return"5719ec04d881088534e4a358"===r},a.isAdmin=function(){return _.includes(s,m)},a.isAdminRole=function(a){return"系统管理员"===a.role},a.deleteMode=!1,a.deleteUserSwitch=function(){a.deleteMode=!a.deleteMode},a.searchByName=function(){var b=_.filter(p,function(b){var c=a.filter.userName.toLowerCase()||a.filter.userName,d=b.name;return d.indexOf(c)!==-1});a.showUserList=b,a.totalItems=b.length};var t=function(b){a.hasPermission=!1;for(var c=Object.keys(b),d=[],e=0;e<c.length;e+=1){var f=b[c[e]],g=a.filter.permission.toLowerCase()||a.filter.permission,h=_.filter(f,function(a){return a.name.toLowerCase().indexOf(g)!==-1});h.length&&(a.hasPermission=!0,d[c[e]]=h)}return d};a.searchByPermission=function(){a.showExistedPermissions?a.showPermissionList=t(o(q)):a.showPermissionList=t(q)},a.deleteUser=function(d){a.isAdmin()&&(a.roleData.user.length<=1&&a.isAdminRole(a.roleData)?e.alert({type:"warning",message:"至少需要一个系统管理员！"}):e.confirm({type:"warning",message:"确定删除 <code>"+d.name+"</code> 吗?",isDelete:!0,html:!0,resolved:function(){k.deleteUser(r,d.name).then(function(){f.success("用户"+d.name+"已删除");var a=c.id;b.go("permission.roleDetail",{id:a},{reload:!0})}).catch(function(a){l(a,"用户删除")}).finally(function(){})}}))},a.changeRolePerm=function(b){if(!a.isAdmin())return!1;var c,d=Object.keys(q);_.forEach(d,function(a){if(c=_.find(q[a],{permissionId:b}))return!1});var e=c.available,h=e?k.addRolePerm:k.deleteRolePerm,i=e?"添加权限":"删除权限";h(g.id,[b]).then(function(a){a.code?f.error(i+"失败","",{timeOut:2e3}):f.success(i+"成功","",{timeOut:2e3})}).catch(function(a){l(a,i)})},a.togglePerm=function(){a.showExistedPermissions=!a.showExistedPermissions,a.showExistedPermissions?a.showPermissionList=t(o(q)):a.showPermissionList=t(q)},a.deleteRole=function(){e.confirm({type:"warning",message:"确定删除 <code>"+g.role+"</code> 吗? 其关联有 "+g.user.length+" 个用户",isDelete:!0,html:!0,resolved:function(){k.deleteRole(r).then(function(){f.success("该角色已删除"),b.go("permission.role",{},{reload:!0})}).catch(function(a){l(a,"角色删除")}).finally(function(){})}})},a.form={users:[],permissions:[]},a.$watch("form.users",function(a){a.length&&k.addUser(r,a).then(function(){f.success("用户添加成功"),b.go("permission.roleDetail",{id:r},{reload:!0})}).catch(function(a){l(a,"用户添加")}).finally(function(){})},!0),a.$watch("form.permissions",function(a){a.length&&k.addUser(r,a).then(function(){f.success("权限添加成功"),b.go("permission.roleDetail",{id:r},{reload:!0})}).catch(function(a){l(a,"权限添加")}).finally(function(){})},!0);var u;a.addPermConfirm=function(c){_.has(c,"id")?_.includes(a.form.permissions,c.id)?e.alert({type:"warning",message:"<code>"+g.permissionIdMap[c.id]+"</code> 已存在，请重新选择",html:!0}):k.addPerm(r,c.id).then(function(){f.success("权限添加成功"),u.close(),b.go("permission.roleDetail",{id:r},{reload:!0})}).catch(function(a){l(a,"权限添加")}).finally(function(){}):e.alert({type:"warning",message:"权限未正确选择，请重新选择",html:!0})}}]),angular.module("permission.service",[]).filter("permFilter",function(){return function(a,b){var c="";return angular.forEach(a,function(a){c+="<span>"+b[a]+"</span><br/>"}),c}}).factory("Permission",["$http","RequestWrapper",function(a,b){return{fetchPermList:function(){return b.array({method:"GET",url:"/api/permission-list"})},fetchRoleList:function(a){return b.array({method:"GET",url:"/api/permRole-list",params:a})},fetchPermDetail:function(a){return b.object({method:"GET",url:"/api/permission-detail/"+a})},fetchRoleDetail:function(a){return b.object({method:"GET",url:"/api/role-detail/"+a.id})},addUser:function(a,c){return b.object({method:"PUT",url:"/api/role-add-user/"+a,data:{operate_user:c}})},deleteUser:function(a,c){return b.object({method:"PUT",url:"/api/role-delete-user/"+a,data:{operate_user:c}})},addRolePerm:function(a,c){return b.object({method:"PUT",url:"/api/role-add-perm/"+a,data:{permission:c}})},deleteRolePerm:function(a,c){return b.object({method:"PUT",url:"/api/role-delete-permission/"+a,data:{permission:c}})},addRole:function(a){return b.object({method:"POST",url:"/api/role-add/",data:{name:a}})},deleteRole:function(a){return b.object({method:"DELETE",url:"/api/role-delete/"+a,data:{}})}}}]),angular.module("itoa.sla.route",[]).config(["$stateProvider",function(a){a.state("itoa.sal",{url:"/sla?page",templateUrl:"views/itoa/sla/sla.html",resolve:{salData:["Serviceability","$stateParams",function(a,b){return a.fetchSalData(angular.copy(b))}],dashBoardData:["salData",function(a){for(var b=a.data,c=b.length,d=0,e=0,f=0;f<c;++f)0==b[f].status&&++d,e+=b[f].value;var g=_.round(e/c,4);return{total:c,success:d,value:g}}]},controller:"SalCtrl"}).state("itoa.bSal",{url:"/bSla?range&businessId&_id",templateUrl:"views/itoa/sla/bSla.html",resolve:{businessTrendData:["Serviceability","$stateParams",function(a,b){if(b.businessId)return a.fetchBusinessTrendData(angular.copy(b))}],deps:["depends",function(a){return a("components/chartjs")}]},controller:"BSalCtrl"}).state("itoa.appDetectCaseFailDetail",{url:"/failDetail?q&date&businessId&appId&page&page_size",templateUrl:"views/itoa/sla/failDetail.html",resolve:{failDetails:["Availability","$stateParams",function(a,b){return a.fetchFailDetail(angular.copy(b))}]},controller:"AppSlaFailDetail"}).state("itoa.slaConfig",{url:"/sla",abstract:!0,template:"<div ui-view></div>",resolve:{businessAppList:["Availability",function(a){return a.fetchBusinessAppList()}],detectCaseStat:["Availability",function(a){return a.fetchDetectCaseStat()}],slaConfig:["Availability",function(a){return a.fetchSlaConfig()}],reSlaConfig:["businessAppList","detectCaseStat","slaConfig",function(a,b,c){for(var d=a.data.list,e=d.length,f=[],g=0;g<e;++g){var h=d[g];if(h.businesses){var i=h.businesses.instanceId,j=_.find(f,function(a){return a.businessId===i});if(j)j.apps.push({appId:h.appId,appName:h.name});else{var j={};j.businessId=i,j.businessName=h.businesses.name,j.apps=[{appId:h.appId,appName:h.name}],f.push(j)}}}for(var e=f.length,k=c.data.businessConfigData,l=c.data.appConfigData,g=0;g<e;++g){var m=f[g].apps,n=m.length,o=[];if(f[g].hasConfig=!1,f[g].isCalcSla=1,f[g].expectedValue=.9,k.length){var j=_.find(k,function(a){return a.businessId===f[g].businessId});j&&(f[g].isCalcSla=j.isCalcSla,f[g].expectedValue=j.expectedValue,f[g].hasConfig=!0)}f[g].detectCaseCount=0;for(var p=0;p<n;++p){if(o.push(m[p].appName),m[p].detectCaseNumber=0,0==b.code){var q=_.find(b.data,function(a){return a.app_id===m[p].appId});q&&(f[g].detectCaseCount+=q.count,m[p].detectCaseNumber=q.count)}if(m[p].weight=5,f[g].hasConfig&&(m[p].weight=0),l.length){var j=_.find(l,function(a){return a.appId===m[p].appId});j&&(m[p].weight=j.weight)}}f[g].appName=_.join(o,", ")}return f}]}}).state("itoa.slaConfig.index",{url:"/config",templateUrl:"/views/itoa/sla/slaConfig.html",controller:"SlaConfigCtrl"}).state("itoa.slaConfig.edit",{url:"/config/edit?businessId",templateUrl:"/views/itoa/sla/slaConfigEdit.html",controller:"SlaConfigEditCtrl"})}]),angular.module("itoa.sla.ctrl",[]).controller("SalCtrl",["$scope","$filter","$stateParams","$state","salData","dashBoardData","Serviceability",function(a,b,c,d,e,f,g){var h={page:1},i={page:c.page||h.page};a.dashBoardData=f,a.salList=e.data,a.date=moment().subtract(1,"days").format("YYYY-MM-DD"),a.totalItems=+e.total,a.itemsPerPage=e.pageSize,a.filters=i,a.searchQ=c.q,a.pageChange=function(){d.go("itoa.sal",{page:i.page===h.page?null:i.page})},a.hasTips=function(a){return a.last_fail_remark&&a.last_fail_remark.length};for(var j=e.data,k=j.length,l=0;l<k;++l)if(j[l].last_fail_day){var m=b("date")(1e3*j[l].time,"yyyy-MM-dd");j[l].last_fail_day!=m&&!function(){var a=j[l],b={date:a.last_fail_day.replace(/-/g,""),business_id:a.business_id};g.fetchSalData(b).then(function(b){0==b.code&&b.data.length&&(a.last_fail_remark=b.data[0].last_fail_remark)})}()}}]).controller("AppSlaFailDetail",["$scope","$stateParams","$state","Availability","failDetails","Dialog","$filter","Utils",function(a,b,c,d,e,f,g,h){a.businessId=b.businessId,a.itemsPerPage=e.page_size,a.totalItems=e.total,a.details=e.data,a.filters={q:b.q,page:b.page?b.page:1};var i=function(){var c={appId:b.appId,date:b.date,page:a.filters.page,page_size:a.itemsPerPage,q:a.filters.q};return c};a.search=function(){var a=i();c.go(c.current.name,a)},a.pageChange=function(){var a=i();c.go(c.current.name,a)},a.showDetail=function(a){var b=a;f.alert({message:"<pre>"+h.escapeHtml(g("json")(JSON.parse(b)))+"</pre>",html:!0})}}]).controller("BSalCtrl",["$scope","$stateParams","$state","$uibModal","toastr","Serviceability","businessTrendData",function(a,b,c,d,e,f,g){var h=[];a.nobusiness=!1,a.showInput=!1,"nobusiness"===g?a.nobusiness=!0:(b.businessId?a.business_id=b.businessId:a.business_id=businessList.data[0].business_id,a.business_name=g.data[0].business,g.data=_.sortBy(g.data,"time"),g.data.forEach(function(b){var c={};c.id=b.id,c.y=b.value,c.x=1e3*b.time,null!==b.last_fail_remark&&""!==b.last_fail_remark?c.z=b.last_fail_remark.split(";"):c.z=[],c.last_fail_day=b.last_fail_day,c.baseline_name="期望值",c.baseline=b.baseline,c.name="可用性",c.status=b.status,b.status&&(c.color="red"),a.showInput=0!=c.status,h.push(c)}));var i={page:1},j={page:b.page||i.page};a.filters=j,b.range?a.activeType=b.range:a.activeType="-7d",a.dateList=[{label:"1周",value:"-7d"},{label:"2周",value:"-14d"},{label:"1月",value:"-30d"}],a.isActiveType=function(b){return b.value===a.activeType},a.setActiveType=function(b){a.activeType=b.value,c.go("itoa.bSal",{businessId:a.business_id,range:b.value})},a.busiChanged=function(){c.go("itoa.bSal",{businessId:a.business_id,range:a.activeType,id:null})};var k=function(b,c){var d=[],e=[],f=[];_.forEach(b,function(a){f.push(a.x),a.status?(d.push(0),e.push(a.y)):(d.push(a.y),e.push(0))}),a.chartConfig={type:"bar",data:{labels:f,datasets:[{backgroundColor:"#7cb5ec",data:d},{backgroundColor:"red",data:e}]},options:{maintainAspectRatio:!1,title:{display:!0,text:"业务可用性趋势"},legend:{display:!1},scales:{xAxes:[{stacked:!0,categoryPercentage:.5,ticks:{callback:function(a){var b=moment(a);return b.format("M月D日")}},gridLines:{drawOnChartArea:!1}}],yAxes:[{stacked:!0,ticks:{suggestedMax:1,min:0,maxTicksLimit:2,callback:function(a){return(100*a).toFixed(2)+"%"}},gridLines:{drawBorder:!1}}]},tooltips:{footerFontColor:"red",footerFontSize:14,callbacks:{title:function(a){var b=a[0].index;return moment(f[b]).format("Y年M月D日 ah:mm")},label:function(a,c){var d=a.datasetIndex,e=a.index;return b[e].name+(100*c.datasets[d].data[e]).toFixed(2)+"%"},afterLabel:function(a){var c=a.index;return b[c].baseline_name+(100*b[c].baseline).toFixed(2)+"%"},footer:function(a){var c=a[0].index;return b[c].status?"不达标":""}}}}}},l=function(b){angular.forEach(g.data,function(c){c.id===b&&(a.salData={},a.salData.date=1e3*c.time,a.salData.currentValue=c.y,a.salData.last_fail_day=c.last_fail_day,a.salData.reasons=c.last_fail_remark?c.last_fail_remark.split(";"):[],a.showFlagId=c.id)}),f.getSalDetails(b).then(function(b){a.details=b.data.app}).catch(function(){}).finally(function(){})};a.addReason=function(b){a.showInput=0!==b.status,l(b.id),k(h,b.id)},a.changeReasons=function(b,d){f.changeReasons(d,[b.trim()]).then(function(){f.getSalDetails(d).then(function(b){a.details=b.data.app}).catch(function(){}).finally(function(){})}).catch(function(){}).finally(function(){e.success("修改成功!"),c.go("itoa.bSal",{id:d},{reload:!0})})},"nobusiness"!==g&&(b.id?(k(h,b.id),l(b.id)):(k(h,_.last(h).id),l(_.last(h).id)))}]).controller("SlaConfigCtrl",["$scope","$state","businessAppList","detectCaseStat","slaConfig","reSlaConfig",function(a,b,c,d,e,f){a.slaConfigList=f,a.edit=function(a){b.go("itoa.slaConfig.edit",{businessId:a.businessId})}}]).controller("SlaConfigEditCtrl",["$scope","$state","$stateParams","reSlaConfig","Availability","Detect","$uibModal",function(a,b,c,d,e,f,g){var h=_.find(d,function(a){return a.businessId===c.businessId});a.businessName=h.businessName,a.slaConfig={businessId:h.businessId,isCalcSla:h.isCalcSla,expectedValue:h.expectedValue,detectCaseCount:h.detectCaseCount,hasConfig:h.hasConfig,apps:h.apps};var i=angular.copy(a.slaConfig);a.calcSlaOptions=[{label:"是",value:1},{label:"否",value:0}],a.isActiveType=function(b){return b.value===Number(a.slaConfig.isCalcSla)},a.setActiveType=function(b){a.slaConfig.isCalcSla=b.value},a.isSlaConfigDirty=!1,a.canReset=function(){var b=angular.copy(a.slaConfig);_.omit(b.apps,"$$hashKey"),a.isSlaConfigDirty=!_.isEqual(i,b);var c=0;for(var d in a.dcaseDirty)c+=a.dcaseDirty[d].length;return a.isSlaConfigDirty||c},a.reset=function(){a.slaConfig=angular.copy(i),a.dcaseDirty={}},a.canSave=function(){return a.canReset()&&a.formSet.$valid},a.save=function(){var c={},d=[];for(var f in a.dcaseDirty)a.dcaseDirty[f].length&&(d=d.concat(a.dcaseDirty[f]));if(d.length&&(c.detect=d),a.isSlaConfigDirty){var g={};if(g.isCreate=!1,i.hasConfig)for(var f in i)if("apps"===f)for(var h=i[f].length,j=0;j<h;++j)a.slaConfig.apps[j].weight!==i.apps[j].weight&&(g.apps||(g.apps=[]),g.apps.push({appId:a.slaConfig.apps[j].appId,weight:a.slaConfig.apps[j].weight}));else a.slaConfig[f]!==i[f]&&(g.businessId=i.businessId,g[f]=a.slaConfig[f]);else{var g={};g.businessId=i.businessId,g.isCalcSla=a.slaConfig.isCalcSla,g.expectedValue=a.slaConfig.expectedValue,g.apps=_.omit(a.slaConfig.apps,["appName","detectCaseNumber"]),g.isCreate=!0}c.sla=g}e.postSlaDetectConfig(c).then(function(a){b.go("itoa.slaConfig.index",{},{reload:!0})})},a.dcaseDirty={},a.showDetectCaseModal=function(b){var c=a.$new();void 0===a.dcaseDirty[b.appId]&&(a.dcaseDirty[b.appId]=[]),c.dcaseDirtyList=a.dcaseDirty[b.appId],c.checkAll=function(a,b){for(var c=a.length,d=0;d<c;++d)a[d].checked=b},c.cancel=function(){return a.reset(),!0},c.updateDirtyList=function(a){a.checked!=Boolean(a.sla_enable)?c.dcaseDirtyList.push({id:a.id,sla_enable:+a.checked}):_.remove(c.dcaseDirtyList,function(b,c,d){return d[c].id==a.id})},c.checkDirty=function(a){for(var b=a.length,d=0;d<b;++d)c.updateDirtyList(a[d])};var d=!1,e=function(){c.app=b,c.allCheck={checked:!1},c.allCheckChange=function(){c.checkAll(c.caseList,c.allCheck.checked),c.checkDirty(c.caseList)},c.rowCheckChange=function(a){c.updateDirtyList(a)},d=!0,g.open({templateUrl:"views/itoa/sla/_app_detectcase.html",scope:c})};c.pageChange=function(){f.fetchCaseListByPage({app_id:b.appId,__select__:"name,app_id,sla_enable",page:c.page,page_size:c.itemsPerPage}).then(function(a){for(var b=a.data.length,f=0;f<b;++f){void 0===a.data[f].sla_enable&&(a.data[f].sla_enable=0);var g=_.find(c.dcaseDirtyList,function(b){return b.id===a.data[f].id});g?a.data[f].checked=Boolean(g.sla_enable):a.data[f].checked=Boolean(a.data[f].sla_enable)}c.caseList=a.data,c.totalItems=a.total,c.itemsPerPage=a.page_size,c.page=a.page,d||e()}).catch(function(a){})},c.pageChange()}}]),angular.module("itoa.sla.service",[]).factory("Availability",["RequestWrapper",function(a){return{fetchBusinessAppList:function(){return a.object({method:"GET",url:"/api/abjectInstanceList/APP",params:{objectId:"APP",pageSize:200}})},fetchDetectCaseStat:function(){return a.object({method:"GET",url:"/api/detect/case/stat"})},fetchSlaConfig:function(b){return a.object({method:"GET",url:"/api/sla/config",params:_.defaults(b,{page_size:300})})},fetchFailDetail:function(b){return a.object({method:"GET",url:"/api/sla/app/case/failDetail",params:_.defaults(b,{page:1,page_size:15})})},postSlaDetectConfig:function(b){return a.object({method:"POST",url:"/api/sla-detect/config",data:b})}}}]),angular.module("monitor.host",["monitor.host.home.detail","monitor.host.home.net","monitor.host.home.multiple"]).config(["$stateProvider",function(a){a.state("monitor.host",{abstract:!0,url:"/host",template:"<ui-view/>"}).state("monitor.host.index",{url:"/index?q&onlyAlarm&onlyMe&page&pageSize&sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/host/graphs.html",controller:"MonitorHostListCtrl",resolve:{data:["MonitorDevice",function(a){return a.getDeviceList()}],alarmData:["Monitor",function(a){return a.getNotRecoverAlarmList({type:"ip"})}],hostData:["data","alarmData",function(a,b){var c=a.data;return _.forEach(c,function(a){void 0!==b[a.ip]?a.alarmCount=b[a.ip]:a.alarmCount=0}),a}]}}).state("monitor.host.home",{url:"/home?ip&instanceId&pageSize",views:{"@":{abstract:!0,controller:"MonitorHostHomeCtrl",templateUrl:"views/monitor/host/home.html",resolve:{}}}})}]).controller("MonitorHostHomeCtrl",["$scope","$state","$stateParams",function(a,b,c){a.commonParams={ip:c.ip,instanceId:c.instanceId},a.navDetailActive=function(){return b.includes("monitor.host.home.detail")},a.navMultipleActive=function(){return b.includes("monitor.host.home.multiple")},a.navAlarmActive=function(){return b.includes("monitor.host.home.alarm")}}]).controller("MonitorHostListCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME","hostData",function(a,b,c,d,e,f){a.allData=f;var g=function(a,b){return a/1024>1?(a/1024).toFixed(1)+"m"+b.substr(1):a/1024/1024>1?(a/1024/1024).toFixed(1)+"g"+b.substr(1):(+a).toFixed(1)+b},h=function(a){return function(b,c){return _.isEmpty(c[b])?"":c[b].join(a)}},i=function(a){return function(b,c){return _.isNil(c[b])?"-":"kbps"===a||"kbytes"===a?g(c[b],a):c[b]+a}},j=function(a,b){return b[a]?"label label-warning clickable":"label label-success clickable"},k=function(){return"monitor.host.home.detail({ip: item.ip, instanceId: item.instanceId})"},l=function(a,c){b.go("monitor.host.home.alarm",{ip:c.ip,st:"-3d",type:"host"})};a.fields=[{key:"ip",name:"IP",filter:!0,getLink:k},{key:"owner",name:"负责人",filter:!0,getValue:h(", ")},{key:"app",name:"所属应用",filter:!0,getValue:h(", ")},{key:"host.cpu.used_total__last",name:"CPU利用率",getValue:i("%"),tooltip:"显示近5分钟的最新数据，如果没有，该机器可能没有安装Agent或Agent运行不正常"},{key:"host.mem.percent__last",name:"内存使用率",getValue:i("%")},{key:"host.disk.max_used_percent__last",name:"磁盘使用率",getValue:i("%"),tooltip:"按分区计算使用率，取最大"},{key:"host.net.bits_in__last",name:"入流量",getValue:i("kbps")},{key:"host.net.bits_out__last",name:"出流量",getValue:i("kbps")},{key:"alarmCount",name:"告警数",getClass:j,click:l}];var m=function(a,b){return!a||0!==b.alarmCount},n=function(a,b){return!a||!_.isEmpty(b.owner)&&(b.owner&&b.owner.indexOf(e)!==-1||b.developer&&b.developer.indexOf(e)!==-1||b.tester&&b.tester.indexOf(e)!==-1)},o=function(a,b){return!a||("true"===a?!_.isNil(b["host.cpu.used_total__last"]):"false"===a?_.isNil(b["host.cpu.used_total__last"]):void 0)};a.extraSearch=[{type:"q",label:"按IP、负责人、所属应用搜索"},{key:"host.cpu.used_total__last",type:"select",choices:[{id:"",text:"全部"},{id:"true",text:"有数据"},{id:"false",text:"无数据"}],fun:o,label:""},{key:"onlyMe",type:"checkbox",fun:n,label:"我的主机"},{key:"onlyAlarm",type:"checkbox",fun:m,label:"告警主机"}],a.statList=[{value:0,key:"host.cpu.used_total__last",comparator:"gt",threshold:90,text:"CPU利用率超过90%"},{value:0,key:"host.mem.percent__last",comparator:"gt",threshold:90,text:"内存使用率超过90%"},{value:0,key:"host.disk.max_used_percent__last",comparator:"gt",threshold:90,text:"磁盘使用率超过90%"},{value:0,key:"alarmCount",comparator:"gt",threshold:0,text:"告警机器"}]}]),angular.module("monitor.host.home.detail",[]).config(["$stateProvider",function(a){a.state("monitor.host.home.detail",{url:"/detail?from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},templateUrl:"views/monitor/host/detail.html",controller:"MonitorHostDetailCtrl"})}]).controller("MonitorHostDetailCtrl",["$scope","$state","$stateParams",function(a,b,c){a.instanceId=c.instanceId,a.dbSlug="__easyops_host",a.range=_.pick(c,["from","to"]),a.params={"var-ip":c.ip},a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})}}]),angular.module("monitor.host.home.net",[]).config(["$stateProvider",function(a){a.state("monitor.host.home.net",{url:"/net?from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},templateUrl:"views/monitor/host/net.html",controller:"MonitorHostNetCtrl"})}]).controller("MonitorHostNetCtrl",["$scope","$state","$stateParams",function(a,b,c){a.instanceId=c.instanceId,a.dbSlug="__easyops_host_net",a.range=_.pick(c,["from","to"]),a.params={"var-ip":c.ip},a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})}}]),angular.module("monitor.host.home.multiple",[]).config(["$stateProvider",function(a){a.state("monitor.host.home.multiple",{url:"/multiple?from&to&versus",templateUrl:"views/monitor/host/multiple.html",controller:"MonitorHostMultipleCtrl",params:{from:{dynamic:!0,type:"datetimeRange",value:"now-2d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0},versus:{array:!0,dynamic:!0,squash:!0}},resolve:{linkData:["$stateParams","Monitor","Externals",function(a,b,c){return c.getLinkById("dashboard-db",_.defaults(a,{slug:"easyops_host"}))}]}})}]).controller("MonitorHostMultipleCtrl",["$scope","$state","$stateParams","Dialog",function(a,b,c,d){a.dbSlug="__easyops_host_multiple",a.range=_.pick(c,["from","to"]);var e=[c.ip];c.versus&&(e=e.concat(c.versus),e=_.uniq(e)),a.params={"var-ip":e},a.form={selectedIps:e},a.selectedText=e.join(" + "),a.selectDevices=function(e){if(e.length>3)d.alert({type:"warning",message:"最多只能比较3台主机"});else{a.form.selectedIps=_.map(e,"ip"),a.params={"var-ip":a.form.selectedIps},a.selectedText=a.form.selectedIps.join(" + ");var f=_.filter(a.form.selectedIps,function(a){return a!==c.ip});b.go(b.current.name,{versus:f},{location:"replace"})}},a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})}}]),angular.module("monitor.app",["monitor.app.home.health","monitor.app.home.detect","monitor.app.home.link","monitor.app.home.host","monitor.app.home.ping","monitor.app.home.component"]).config(["$stateProvider",function(a){a.state("monitor.app",{abstract:!0,url:"/app",template:"<ui-view/>",resolve:{}}).state("monitor.app.index",{url:"/index?q&onlyAlarm&onlyMe&page&pageSize&sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/app/graphs.html",controller:"MonitorAppIndexCtrl",resolve:{data:["MonitorApp",function(a){return a.fetchApp()}],alarmData:["Monitor",function(a){return a.getNotRecoverAlarmList({type:"app_id"})}],AppData:["data","alarmData",function(a,b){var c=a.data;return _.forEach(c,function(a){void 0!==b[a.instanceId]?a.alarmCount=b[a.instanceId]:a.alarmCount=0}),a}]}}).state("monitor.app.home",{url:"/home?appId&pageSize",reloadOnSearch:!1,views:{"@":{abstract:!0,templateUrl:"views/monitor/app/home.html",controller:"MonitorAppHomeCtrl"}},resolve:{appData:["AppService","$stateParams",function(a,b){return a.fetchApp(b.appId)}],componentData:["Collector","$stateParams",function(a,b){return a.listCollector({appId:b.appId})}]}})}]).controller("MonitorAppIndexCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME","AppData",function(a,b,c,d,e,f){a.allData=f;var g=function(a,b){return function(c,d){return d[c]?_.map(d[c],a).join(b):""}},h=function(a){return function(b,c){return c[b]?c[b][a]:""}},i=function(a){return function(b,c){return _.isNil(c[b])?"-":c[b]+a}},j=function(a,b){var c={healthy:"健康",warning:"一般",critical:"危险"};return c[b[a]]||"暂无"},k=function(a,b){return b[a]?"label label-warning clickable":"label label-success clickable"},l=function(a,b){var c={healthy:"label-success clickable",warning:"label-warning clickable",critical:"label-danger clickable"};return"label "+(c[b[a]]||"label-default")},m=function(){return"monitor.app.home.health.detail({appId: item.instanceId})"},n=function(a,c){b.go("monitor.app.home.alarm",{appId:c.instanceId,st:"-3d",type:"app"})},o=function(a,c){c[a]&&b.go("monitor.app.home.health.detail",{appId:c.instanceId})};a.fields=[{key:"name",name:"应用",filter:!0,getLink:m},{key:"owner",name:"运维负责人",filter:!0,getValue:g("name",", ")},{key:"tester",name:"测试负责人",filter:!0,getValue:g("name",", ")},{key:"developer",name:"研发负责人",filter:!0,getValue:g("name",", ")},{key:"businesses",name:"所属业务",filter:!0,getValue:h("name")},{key:"configCover",name:"监控覆盖度",getValue:i("%"),tooltip:"监控点的接入程度，分为5层（网络、系统、组件、应用、用户），详见帮助文档",tooltipLink:"/help/doc?page=apphealth"},{key:"health",name:"健康指数",getValue:j,getClass:l,click:o,tooltip:"抽取各层黄金指标计算所得，立体化综合评判应用的健康情况，详见帮助文档",tooltipLink:"/help/doc?page=apphealth"},{key:"alarmCount",name:"告警数",getClass:k,click:n}];var p=function(a,b){return!a||0!==b.alarmCount},q=function(a,b){return!a||(_.some(b.owner,{name:e})||_.some(b.developer,{name:e})||_.some(b.tester,{name:e}))};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"onlyMe",type:"checkbox",fun:q,label:"我的应用"},{key:"onlyAlarm",type:"checkbox",fun:p,label:"告警应用"}],a.statList=[{value:0,key:"health",comparator:"eq",threshold:"critical",text:"危险应用"},{value:0,key:"configCover",comparator:"lt",threshold:70,text:"覆盖度小于70%"},{value:0,key:"alarmCount",comparator:"gt",threshold:0,text:"告警应用"}]}]).controller("MonitorAppHomeCtrl",["$scope","$state","$stateParams","$localStorage","Dialog","$uibModal","appData","componentData",function(a,b,c,d,e,f,g,h){c.appId||e.confirm({type:"warning",message:"非法输入",isDelete:!0,resolved:function(){b.go("monitor.app.index")}}),a.commonParams={appId:c.appId,name:g.name,componentList:[]};var i=[];_.each(h.data,function(a){var b=["mongodb","mysql","redis","memcached"].indexOf(a.name)!==-1,c=["nginx","apache"].indexOf(a.name)!==-1,d=!b&&!c;i.push({name:a.name,isDb:b,isWeb:c,isApp:d})}),a.commonParams.componentList=_.uniqBy(i,"name"),a.relateComponent=function(){var c=a.$new(!0);c.appId=a.commonParams.appId,c.appName=a.commonParams.name;var d=f.open({templateUrl:"views/monitor/app/_relate-component.html",backdrop:"static",size:"md",scope:c,controller:"ComponentRelateAppCtrl"});d.result.then(function(){b.reload()})},a.navHealthActive=function(){return b.includes("monitor.app.home.health")},a.navDetectActive=function(){return b.includes("monitor.app.home.detect")},a.navLinkActive=function(){return b.includes("monitor.app.home.link")},a.navHostActive=function(){return b.includes("monitor.app.home.host")},a.navComponentActive=function(a){return b.includes("monitor.app.home.component")&&a===c.component},a.navAlarmActive=function(){return b.includes("monitor.app.home.alarm")}}]).controller("ComponentRelateAppCtrl",["$scope","$uibModalInstance","handleAjaxError","Collector",function(a,b,c,d){a.formData={collectorIds:[]},a.loading=!0,a.componentChoices=[],d.listCollector().then(function(b){_.each(b.data,function(b){b.app_id||a.componentChoices.push({id:b.id,name:b.name+"-"+b.ip+":"+b.kwargs.port})})}).finally(function(){a.loading=!1}),a.close=function(){0!==a.formData.collectorIds.length&&(a.storing=!0,d.relateComponentToApp(a.appId,{collectorIds:a.formData.collectorIds}).then(function(d){d.code?(a.storing=!1,c({status:500,data:d},"关联采集实例失败，请刷新检查")):b.close()}).catch(function(b){a.storing=!1,c(b,"关联采集实例失败")}))}}]),angular.module("monitor.app.home.health",["monitor.app.home.health.detail","monitor.app.home.health.config"]).config(["$stateProvider",function(a){a.state("monitor.app.home.health",{url:"/health",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.app.home.health.detail",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.health.detail",{url:"/detail?from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},templateUrl:"views/monitor/app/health/detail.html",controller:"MonitorAppHealthDetailCtrl",resolve:{appCompletionDegree:["$stateParams","monitorAppHealth",function(a,b){var c=a.appId;return b.getAppCompletionDegree(c)}],appHealth:["$stateParams","monitorAppHealth",function(a,b){var c=a.appId,d={app_id__in:c};return b.getAppHealth(d)}],lastHealthData:["$stateParams","monitorAppHealth",function(a,b){var c={select:"app_id,app_health.score.network__avg,app_health.score.system__avg,app_health.score.component__avg,app_health.score.application__avg,app_health.score.user__avg",app_id:a.appId,st:"-5m",et:"-1m"};return b.getAppHealthTrend(c)}],deps:["depends",function(a){return a("components/chartjs")}]}})}]).directive("percentBar",function(){return{restrict:"AE",template:'<div style="width:220px;height:10px;border-radius: 100px;background-color: #e5e8eb"><div id="percent"></div></div>',link:function(a,b,c){$("#percent").css({width:c.percent,height:"100%",borderRadius:"100px",backgroundColor:"#feab16"})}}}).controller("MonitorAppHealthDetailCtrl",["$scope","$stateParams","$state","$anchorScroll","$location","Log","monitorAppHealth","Collector","appCompletionDegree","appHealth","appData","lastHealthData",function(a,b,c,d,e,f,g,h,i,j,k,l){a.appId=b.appId,a.appName=k.name,a.healthStatus=j.data[0].status,a.healthReason=j.data[0].reason||"未知";var m,n,o=[];k.clusters&&null!==k.clusters&&(m=k.clusters.length,m&&(n=0,_.forEach(k.clusters,function(a){a.deviceList&&(n+=a.deviceList.length,o=_.concat(o,_.map(a.deviceList,"ip")))}))),o=_.uniq(o),a.textOverFlow=!1,a.showAppName=function(b){a.currentAppName=b;var c=$("#appName")[0].scrollWidth,d=$("#appName")[0].clientWidth;c>d&&(a.textOverFlow=!0)},a.clustersCount=m||0,a.devicesCount=n||0,a.appCompletionDegree=i.data.degree+"%";var p={};_.each(l.data[0],function(a,b){"app_id"!==b&&(p[b]=_.findLast(a))});var q=[];q[0]=p["app_health.score.network__avg"]?p["app_health.score.network__avg"]:10,q[1]=p["app_health.score.system__avg"]?p["app_health.score.system__avg"]:10,q[2]=p["app_health.score.component__avg"]?p["app_health.score.component__avg"]:10,q[3]=p["app_health.score.application__avg"]?p["app_health.score.application__avg"]:10,q[4]=p["app_health.score.user__avg"]?p["app_health.score.user__avg"]:10;var r=["网络层","系统层","组件层","应用层","用户层"],s={labels:r,datasets:[{backgroundColor:"rgba(164, 195, 252, 0.7)",data:q,pointRadius:0,pointHoverRadius:1}]};a.appLevelsScoreRadarConfig={type:"radar",data:s,options:{legend:{display:!1,labels:{fontColor:"#fff",generateLabels:function(a){return _.map(a.data.datasets,function(){return{fillStyle:"rgba(255,255,255,0)",strokeStyle:"rgba(255,255,255,0)"}})}}},tooltips:{enabled:!1},maintainAspectRatio:!1,scale:{ticks:{min:0,max:100,stepSize:50,callback:function(){return""}},pointLabels:{fontColor:"#878b8f",
fontSize:12}}}};var t=["nginx","apache","memcached","mysql","mongodb","jvm","tomcat","zookeeper","kafka","redis"],u=i.data.detail;u[0]&&u[0].available||t.push("ping"),u[1]&&u[1].available||(t.push("CPU"),t.push("内存"),t.push("IO"),t.push("磁盘")),u[2]&&u[2].available&&_.each(u[2].name,function(a){t=_.without(t,a)}),u[3]&&u[3].available||t.push("接口调用"),u[4]&&u[4].available||t.push("拨测"),o=o.length?o:[""],a.dbSlug="__easyops_apphealth",a.params={"var-appId":b.appId,"var-ip":o,hidePanelTitle:t.join(",")},a.range=_.pick(b,["from","to"]),a.onRangeChange=function(a){c.go(c.current.name,a,{location:"replace"})}}]),angular.module("monitor.app.home.health.config",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.health.config",{url:"/config",templateUrl:"views/monitor/app/health/config.html",controller:"MonitorAppHealthConfigCtrl",resolve:{appCompletionDegree:["$stateParams","monitorAppHealth",function(a,b){var c=a.appId;return b.getAppCompletionDegree(c)}]}})}]).controller("MonitorAppHealthConfigCtrl",["$scope","$stateParams","appCompletionDegree",function(a,b,c){a.appId=b.appId;var d=["网络层","系统层","组件层","应用层","用户层"],e='cmdb.apps.app.index({instanceId:"'+a.appId+'"})',f=[e,e,"monitor.collector","monitor.link","monitor.detect.caseCreate_single"],g=["监控应用中主机的网络状况","监控操作系统资源利用状况","监控应用中使用的公共组件指标","应用调用外部服务的成功率、延时指标","从用户角度监控成功率和延时指标"],h=["主机到其他机器的ping丢包率、延时","主机的CPU、内存、IO、磁盘使用率","MySQL、Nginx、Java等公共组件内部服务指标","链路监控的成功率、延时指标","服务拨测的成功率、延时指标"],i=["安装/升级agent至2.16， 并在应用管理页面绑定主机","在应用管理页面绑定主机","安装/升级agent至2.16，并在组件监控页面配置组件采集","在链路监控页面配置链路采集","在服务拨测页面配置服务拨测采集"];a.levelsAvailable=[];var j=_.orderBy(c.data.detail,"level");_.forEach(j,function(b){var c=b.level-1;1!==b.level&&2!==b.level||!b.name.length||(f[c]="help.doc"),a.levelsAvailable.push({name:d[c],available:b.available?"已接入":"未接入",url:f[c],desc:g[c],indexSource:h[c],link:i[c]})})}]),angular.module("monitor.app.home.detect",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.detect",{url:"/detect",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.app.home.link",["monitor.app.home.link.list","monitor.app.home.link.detail"]).config(["$stateProvider",function(a){a.state("monitor.app.home.link",{url:"/link",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.app.home.link.list",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.link.list",{url:"/list?dst_name&dst_interface&sortBy&sortOrder&page&page_size&st&et",params:{st:{type:"datetimeRange",value:"-30m"},et:{type:"datetimeRange"}},reloadOnSearch:!1,templateUrl:"views/monitor/app/link/list.html",controller:"MonitorAppLinkListCtrl",resolve:{dataBySrc:["MonitorLink","$state","$stateParams",function(a,b,c){var d=c.st,e=c.et,f=c.appId;return a.fetchRouteInterface({source_app_id:f,st:d,et:e,page:1,page_size:300})}],dataByDest:["MonitorLink","$state","$stateParams",function(a,b,c){var d=c.st,e=c.et,f=c.appId;return a.fetchRouteInterface({target_app_id:f,st:d,et:e,page:1,page_size:300})}]}})}]).controller("MonitorAppLinkListCtrl",["$scope","$state","$stateParams","$log","$sce","toastr","dataBySrc","dataByDest","DatetimeRangeTranslator",function(a,b,c,d,e,f,g,h,i){a.dataByDest=h,a.dataBySrc=g;var j=function(a){return function(b,c){return _.isUndefined(c[b])||_.isNull(c[b])?"":c[b]+a}},k=function(){var a='"'+(c.st||"")+'"',b='"'+(c.et||"")+'"';return 0!==_.toInteger(c.st)&&(a=c.st),0!==_.toInteger(c.et)&&(b=c.et),'monitor.app.home.link.detail({dst_name: item["route_interface.stat.dst_name"], dst_interface: item["route_interface.stat.dst_interface"], st: '+a+", et: "+b+"})"};a.fields=[{key:"route_interface.stat.dst_interface",name:"接口",filter:!0,getLink:k,maxWidth:"50%"},{key:"route_interface.stat.dst_name",name:"服务名称",filter:!0},{key:"route_interface.stat.avg_delay__avg",name:"时延(ms)"},{key:"route_interface.stat.fail_count__sum",name:"失败数"},{key:"route_interface.stat.total_count__sum",name:"总数"},{key:"route_interface.stat.succ_rate",name:"成功率",getValue:j("%")}],a.extraSearch=[{type:"q",label:"关键字搜索"}],a.rangeOptionList=[{value:{from:"now-30m",to:"now"},selected:!0,text:"近30分钟"},{value:{from:"now-3h",to:"now"},text:"近3小时"},{value:{from:"now/d",to:"now"},text:"今天"},{value:{from:"now-2d",to:"now"},text:"近2天"}];var l=i.monitorToGrafana(c),m=_.find(a.rangeOptionList,function(a){return a.value.from===l.from&&a.value.to===l.to});m?a.range=m.value:a.range=l,a.onRangeChange=function(a){var d=i.grafanaToMonitor(a);b.go(b.current.name,_.assign({},c,d),{inherit:!1,reload:!0})}}]),angular.module("monitor.app.home.link.detail",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.link.detail",{url:"/detail?delay&only_fail&dst_name&dst_interface&st&et&page&pageSize",params:{st:{dynamic:!0,type:"datetimeRange",value:"-30m"},et:{dynamic:!0,type:"datetimeRange"}},reloadOnSearch:!1,templateUrl:"views/monitor/app/link/detail.html",controller:"MonitorAppLinkDetailCtrl",resolve:{}})}]).controller("MonitorAppLinkDetailCtrl",["$scope","$state","$stateParams","Dialog","Utils","MonitorLink","DatetimeRangeTranslator",function(a,b,c,d,e,f,g){function h(d,e){var h=e?g.grafanaToMonitor(e):{};f.fetchDetailResult(_.assign({},{page:1,pageSize:300,__sortby__:"-time"},c,h)).then(function(e){a.allData=e,"init"!==d&&b.go(b.current.name,_.defaults(h,c),{location:"replace",inherit:!1})}).catch(function(){a.allData={data:[]}})}a.dbSlug="__easyops_link",a.params={"var-dst_name":c.dst_name,"var-dst_interface":c.dst_interface},a.rangeOptionList=[{value:{from:"now-30m",to:"now"},selected:!0,text:"近30分钟"},{value:{from:"now-3h",to:"now"},text:"近3小时"},{value:{from:"now/d",to:"now"},text:"今天"},{value:{from:"now-2d",to:"now"},text:"近2天"}];var i=g.monitorToGrafana(c),j=_.find(a.rangeOptionList,function(a){return a.value.from===i.from&&a.value.to===i.to});j?a.range=j.value:a.range=i,a.onRangeChange=function(a){h("",a)},h("init",null);var k=function(a,b){return b["route.route.dst_ip"]+":"+b["route.route.dst_port"]},l=function(a,b){return moment.unix(b[a]).format("YYYY-MM-DD HH:mm:ss")},m=function(a,b){var c=_.escape(b[a]).replace(/\t/g,"<br/>");d.alert({message:'<pre class="wrap">'+c+"</pre>",html:!0})},n=function(){return"btn-link clickable"};a.fields=[{key:"time",name:"时间",getValue:l},{key:"route.route.src_name",name:"主调服务名",filter:!0},{key:"route.route.src_ip",name:"主调IP",filter:!0},{key:"route.route.dst_name",name:"被调服务名",filter:!0},{key:"route.route.dst_interface",name:"被调接口",filter:!0},{key:"route.route.dst_ip",name:"被调IP",filter:!0,getValue:k},{key:"route.route.ret_code",name:"返回码"},{key:"route.route.delay",name:"耗时(ms)"},{key:"route.route.stack",name:"错误堆栈",maxWidth:"20px",click:m,getClass:n}],a.extraSearch=[]}]),angular.module("monitor.app.home.host",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.host",{url:"/host?st&sortBy&sortOrder&from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},reloadOnSearch:!1,templateUrl:"views/monitor/app/host/list.html",controller:"MonitorAppHostCtrl",resolve:{data:["MonitorApp","$stateParams",function(a,b){return a.fetchDeviceByApp(b.appId)}],alarmData:["Monitor",function(a){return a.getNotRecoverAlarmList({type:"ip"})}],hostData:["data","alarmData",function(a,b){var c=a.data;return _.forEach(c,function(a){void 0!==b[a.ip]?a.alarmCount=b[a.ip]:a.alarmCount=0}),a}]}})}]).controller("MonitorAppHostCtrl",["$scope","$state","$stateParams","Dialog","$localStorage","hostData","appData",function(a,b,c,d,e,f,g){a.allData=f,a.appData=g;var h=function(a,b){return a/1024>1?(a/1024).toFixed(1)+"m"+b.substr(1):a/1024/1024>1?(a/1024/1024).toFixed(1)+"g"+b.substr(1):(+a).toFixed(1)+b},i=function(a){return function(b,c){return _.isUndefined(c[b])||_.isNull(c[b])?"-":"kbps"===a||"kbytes"===a?h(c[b],a):c[b]+a}},j=function(a,b){return b[a]?"label label-warning clickable":"label label-success clickable"},k=function(){return"monitor.host.home.detail({ip: item.ip})"},l=function(a,c){var d=b.href("monitor.host.home.alarm",{ip:c.ip,st:"-3d"});window.open(d,"_blank")};a.fields=[{key:"ip",name:"IP",filter:!0,getLink:k,target:"_blank"},{key:"host.cpu.used_total__last",name:"CPU利用率",getValue:i("%")},{key:"host.mem.percent__last",name:"内存使用率",getValue:i("%")},{key:"host.disk.max_used_percent__last",name:"磁盘使用率(最大)",getValue:i("%")},{key:"host.net.bits_in__last",name:"入流量",getValue:i("kbps")},{key:"host.net.bits_out__last",name:"出流量",getValue:i("kbps")},{key:"alarmCount",name:"告警数",getClass:j,click:l}],a.dbSlug="__easyops_host_multiple",a.range=_.pick(c,["from","to"]),a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})},a.params={"var-ip":[]},a.form={selectedIps:[]},a.selectedText="",a.selectDevices=function(b){b.length>3?d.confirm({type:"warning",message:"最多只能同时比较 3 台主机",resolved:function(){}}):(a.form.selectedIps=_.map(b,"ip"),a.params={"var-ip":a.form.selectedIps},a.selectedText=a.form.selectedIps.join(" + "))}}]),angular.module("monitor.app.home.ping",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.ping",{url:"/ping?st&clusterId",templateUrl:"views/monitor/app/ping/graphs.html",controller:"MonitorAppPingIndexCtrl",resolve:{}})}]).controller("MonitorAppPingIndexCtrl",["$scope","$state","$stateParams","Dialog","appData",function(a,b,c,d,e){a.grafanaDashboardLink="/grafana/dashboard/db/__easyops_ping?",a.params={"var-ip":[]},a.appData=e,a.clusterData={},a.form={selectedCluster:c.clusterId},a.appData.clusters&&(_.each(a.appData.clusters,function(b){a.clusterData[b.instanceId]={name:b.name,deviceList:b.deviceList}}),a.form.selectedCluster||(a.form.selectedCluster=a.appData.clusters[0].instanceId),a.params["var-ip"]=_.map(a.clusterData[a.form.selectedCluster].deviceList,"ip")),a.changeCluster=function(){a.params["var-ip"]=_.map(a.clusterData[a.form.selectedCluster].deviceList,"ip")}}]),angular.module("monitor.app.home.component",[]).config(["$stateProvider",function(a){a.state("monitor.app.home.component",{url:"/component?st&component&from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},templateUrl:"views/monitor/app/component/graphs.html",controller:"MonitorAppComponentIndexCtrl",resolve:{}})}]).controller("MonitorAppComponentIndexCtrl",["$scope","$state","$stateParams","Dialog","appData","componentData",function(a,b,c,d,e,f){a.component=c.component;var g={mongodb:"mongo",memcached:"mcache"},h=g[a.component]||a.component;a.grafanaDashboardLink="/grafana/dashboard/db/__easyops_"+h+"?",a.dbSlug="__easyops_"+h,a.range=_.pick(c,["from","to"]),a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})},a.instanceList=[],_.each(f.data,function(b){b.name===a.component&&a.instanceList.push({"var-ip":b.ip,"var-port":b.kwargs.port})})}]),angular.module("monitor.topos",["monitor.topos.ctrl","monitor.topos.route","monitor.topos.service"]),angular.module("monitor.topos.route",["url.matcher"]).config(["$stateProvider",function(a){a.state("monitor.topos",{url:"/topos",abstract:!0,template:"<ui-view/>"}).state("monitor.topos.index",{url:"?base",templateUrl:"views/monitor/topos/detail.html",controller:"ToposDetailCtrl",resolve:{defaultTopo:["$stateParams","Topos",function(a,b){return a.base?{id:null}:b.getDefaultTopo()}],pageType:["defaultTopo",function(a){var b=a.id?"default":"base";return b}],topoData:["defaultTopo","Topos",function(a,b){return a.id?b.getUserTopo(a.id):b.getBaseTopo()}],deps:["depends",function(a){return a("components/apps-topology")}]}}).state("monitor.topos.list",{url:"/list?page",templateUrl:"views/monitor/topos/list.html",controller:"ToposListCtrl",resolve:{toposData:["$stateParams","Topos",function(a,b){return b.getUserToposList(angular.extend({},{page:1,page_size:15,__sortby__:"-ctime"},a))}]}}).state("monitor.topos.create",{url:"/create?copyBy",templateUrl:"views/monitor/topos/create.html",controller:"ToposCreateCtrl",resolve:{topoData:["$stateParams","Topos",function(a,b){return a.copyBy?b.getUserTopo(a.copyBy):b.getBaseTopo()}],deps:["depends",function(a){return a("components/apps-topology")}],pageStatus:["$stateParams",function(a){return a.copyBy?"copy":"create"}]}}).state("monitor.topos.topo",{abstract:!0,url:"/{id:\\w{7,}}",template:"<ui-view />"}).state("monitor.topos.topo.index",{url:"",templateUrl:"/views/monitor/topos/detail.html",controller:"ToposDetailCtrl",resolve:{pageType:[function(){return"detail"}],topoData:["$stateParams","Topos",function(a,b){return b.getUserTopo(a.id)}],deps:["depends",function(a){return a("components/apps-topology")}]}}).state("monitor.topos.topo.edit",{url:"/edit",templateUrl:"/views/monitor/topos/create.html",controller:"ToposCreateCtrl",resolve:{deps:["depends",function(a){return a("components/apps-topology")}],topoData:["$stateParams","Topos",function(a,b){return b.getUserTopo(a.id)}],pageStatus:[function(){return"edit"}]}})}]),angular.module("monitor.topos.ctrl",[]).constant("NODETYPES",[{name:"TCP",value:"Sphere"},{name:"HTTP",value:"Sphere"},{name:"RCP",value:"Cube"},{name:"RD",value:"Cube"},{name:"NoSql",value:"Cylinder"},{name:"Cache",value:"Cylinder"},{name:"Files",value:"Cylinder"}]).controller("ToposListCtrl",["$scope","$state","$stateParams","handleAjaxError","$uibModal","toastr","Topos","toposData",function(a,b,c,d,e,f,g,h){a.toposList=_.map(h.data,function(a){return a.ctime*=1e3,a}),a.pagingConf={total:h.total,current:c.page||1,page_size:c.page_size||15},a.pagingConf.change=function(){b.go("monitor.topos.list",{page:a.pagingConf.current,page_size:a.pagingConf.page_size})},a.deleteTopo=function(a){var c=e.open({templateUrl:"views/monitor/topos/_delete-topo.html",controller:"ToposDeleteCtrl",resolve:{topo:a}});c.result.then(function(){f.success(a.name+" 删除成功"),b.reload("monitor.topos.list")},function(){})},a.setDefault=function(b,c){var e={default:c};g.setDefaultTopo(b,e).then(function(){_.forEach(a.toposList,function(a){a.default=!1,a.id===b&&(a.default=c)}),f.success("默认视图修改成功！")}).catch(d)}}]).controller("ToposDeleteCtrl",["$scope","$uibModalInstance","handleAjaxError","toastr","Topos","topo",function(a,b,c,d,e,f){a.topo=f,a.busy=!1,a.delete=function(){a.busy=!0,e.deleteUserTopo(a.topo.id).then(function(a){b.close(a)}).catch(c).finally(function(){a.busy=!1})},a.cancel=function(){b.dismiss()}}]).controller("ToposCreateCtrl",["$scope","$state","$stateParams","$location","$uibModal","handleAjaxError","toastr","Topos","AppService","TopoUtil","topoData","pageStatus","NODETYPES",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n;a.creating=!1,a.pageStatus=l,a.loading="create"===l,a.topo={id:"edit"===l?k.id:"",name:"edit"===l?k.name:"",description:"edit"===l?k.description:""},a.validateTopo={name:!0,description:!0},a.appendingType=null,a.clearInputStatus=function(b){a.validateTopo[b]=!0},a.saveTopo=function(){a.creating=!0;var d=e.open({templateUrl:"views/monitor/topos/_save-topo.html",backdrop:"static",controller:"TopoSaveAppCtrl",resolve:{topo:function(){return a.topo},topoData:function(){return n.getData()},pageStatus:function(){return l}}});d.result.then(function(d){a.creating=!1,"edit"===l?(g.success("拓扑视图修改成功！"),b.go("monitor.topos.topo.index",c)):(g.success("拓扑视图创建成功！"),b.go("monitor.topos.topo.index",d))},function(){a.creating=!1})},a.nodeTypes=m,a.asideOpened=!1,a.asideData={},a.currentNote="",a.canUndo=!1,a.canRedo=!1,a.zoomVal=1,a.zoomTopo=function(b){var c=$("#topo-canvas svg");"in"===b?a.zoomVal*=1.2:"out"===b&&(a.zoomVal*=.8),c.css("transform","scale("+a.zoomVal+")")},a.closeAside=function(){a.asideOpened=!1};var o={};o="create"===l?j.assemBaseData(k,!1):j.assemUserData(k);var p=$("#topo-canvas").width(),q=window.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight,r="appId",s={appendTo:"#topo-canvas",keyId:r,nodeFields:["name"],size:[p,q],linkDistance:100,baseHref:d.url(),hoverEnabled:!1,autoScaleToFitCanvas:!0};n=new AppsTopology(o,s),$(window).on("resize",function(){var a=$("#topo-canvas").width(),b=window.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight;n.setSize([a,b])});var t=function(b,c){if(!_.eq(a[b],c)){var d=a.$$phase;"$apply"!==d&&"$digest"!==d&&a.$apply(function(){a[b]=c}),a[b]=c}};n.on("forceEnd",function(){t("loading",!1)}),n.on("activeChange",function(a,b){b?(t("asideData",angular.extend({},{type:a,node:b})),"link"===a&&t("asideOpened",!0),"note"===a&&t("currentNote",b.content)):(t("asideOpened",!1),t("asideData",{}))}),n.on("stateChange",function(a){switch(a){case AppsTopology.STATE_DRAGGING_NODE:case AppsTopology.STATE_DRAGGING_NOTE:case AppsTopology.STATE_DRAGGING_AREA:t("asideOpened",!1);break;case AppsTopology.STATE_DRAG_END:t("asideOpened",!0)}switch(a){case AppsTopology.STATE_LINKING:t("appendingType","link");break;case AppsTopology.STATE_DRAWING_AREA:t("appendingType","area");break;case AppsTopology.STATE_DRAWING_NOTE:t("appendingType","note");break;case AppsTopology.STATE_DRAWING_NODE:t("appendingType","node");break;default:t("appendingType",null)}}),n.on("history",function(){t("canUndo",n.history.canUndo()),t("canRedo",n.history.canRedo())}),a.undo=function(){n.undo()},a.redo=function(){n.redo()},a.append=function(b){switch(b){case"node":var c=e.open({templateUrl:"views/monitor/topos/_choose-app.html",backdrop:"static",controller:"TopoChooseAppCtrl",resolve:{appList:function(){return i.fetchAppList()},exitAppList:function(){return n.nodes}}});c.result.then(function(c){var d={appId:c.appId,name:c.name,shape:"Cube",x:n.options.size[0]/2,y:n.options.size[1]/2};n.appendNode(d),n.setActive("node",d),a.asideData=angular.extend({},{type:b,node:d}),a.asideOpened=!0});break;case"link":n.toLink();break;case"area":n.toAppendArea();break;case"note":n.toAppendNote()}},a.changeNodeType=function(b,c){a.asideData.node&&b&&n.setNodeShape(void 0,b,c)},a.changeNote=function(a){n.setNoteContent(void 0,a)},a.remove=function(){var b=a.asideData.type;switch(b){case"node":n.removeNode();break;case"link":n.unlink();break;case"area":n.removeArea();break;case"note":n.removeNote()}a.asideOpened=!1}}]).controller("TopoSaveAppCtrl",["$scope","$uibModalInstance","handleAjaxError","Topos","topo","topoData","pageStatus",function(a,b,c,d,e,f,g){a.topo=e,a.save=function(){if(!a.topo.name)return $("#name").focus();if(!a.topo.description)return $("#description").focus();var e={};return e.name=a.topo.name,e.description=a.topo.description,e.nodes=_.map(f.nodes,function(a){return delete a.name,{id:a.appId,style:a}}),e.links=_.map(f.links,function(a){return{source:a.source,target:a.target,style:a}}),e.areas=_.map(f.areas,function(a){return{style:a}}),e.notes=_.map(f.notes,function(a){return{style:a}}),"edit"===g?d.updateUserTopo(a.topo.id,e).then(function(a){b.close(a)}).catch(c):d.createUserTopo(e).then(function(a){b.close(a)}).catch(c)}}]).controller("TopoChooseAppCtrl",["$scope","$uibModalInstance","appList","exitAppList",function(a,b,c,d){var e=_.map(d,"appId");c=_.map(c,function(a){return _.includes(e,a.appId)&&(a.disabled=!0),a}),a.selectedApp=null,a.appList=_.map(c,function(a){return a.selected=!1,a}),a.selectApp=function(b){b.selected=!b.selected,a.selectedApp=b.selected&&b||null,_.forEach(a.appList,function(a){a.appId!==b.appId&&(a.selected=!1)})},a.appendNode=function(){b.close(a.selectedApp)}}]).controller("ToposDetailCtrl",["$scope","$location","$timeout","$state","$stateParams","$uibModal","handleAjaxError","toastr","TopoUtil","Topos","topoData","pageType",function(a,b,c,d,e,f,g,h,i,j,k,l){a.themeLight=!0,a.loading="base"===l,a.deleting=!1,a.topo={id:k.id||"",name:k.name||"",creator:k.creator||"",default:k.default},a.show={node:{capacity:!1,detectSuccRate:!1},link:{interfaceTrendSuccRate:!1,interfaceTrendDelay:!1}},a.isDetailPage=function(){return"detail"===l},a.isFullscreen=!1;var m,n,o={width:0,height:0};n="base"===l?i.assemBaseData(k):i.assemUserData(k);var p=$("#topo-canvas").width(),q=window.innerHeight-document.querySelector(".navbar").offsetHeight-60;o={width:p,height:q};var r="appId",s={appendTo:"#topo-canvas",keyId:r,nodeFields:["name"],size:[p,q],linkDistance:100,baseHref:b.url(),interactEnabled:!1,autoScaleToFitCanvas:!0};m=new AppsTopology(n,s),$(window).on("resize",function(){if(!(document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.fullscreenElement)){var a=$("#topo-canvas").width(),b=window.innerHeight-document.querySelector(".navbar").offsetHeight-document.querySelector(".page-title-container").offsetHeight;m.setSize([a,b]),o={width:a,height:b}}});var t=function(b,c){if(!_.eq(a[b],c)){var d=a.$$phase;"$apply"!==d&&"$digest"!==d&&a.$apply(function(){a[b]=c}),a[b]=c}};m.on("forceEnd",function(){t("loading",!1)}),m.on("stateChange",function(a){if(a===AppsTopology.STATE_ZOOMING_CANVAS)t("zoomRate",m.getScaleLevel());else if(a===AppsTopology.STATE_DBLCLICK){var b=m.getHovedNode();b&&d.go("cmdb.apps.app.graph",{instanceId:b.appId})}}),a.setDefaultTopo=function(){var b=a.topo.id,c={default:!a.topo.default};j.setDefaultTopo(b,c).then(function(){a.topo.default=!a.topo.default,h.success("默认视图修改成功！")}).catch(g)},a.deleteTopo=function(){a.deleting=!0;var b=f.open({templateUrl:"views/monitor/topos/_delete-topo.html",controller:"ToposDeleteCtrl",resolve:{topo:a.topo}});b.result.then(function(){a.deleting=!1,h.success(a.topo.name+" 删除成功"),d.go("monitor.topos.list")},function(){a.deleting=!1})},a.zoomRate=1,a.zoomTopo=function(b){var c=m.getScaleRange();"in"===b?a.zoomRate=Math.floor(a.zoomRate/5*10)/10*5+.5:"out"===b&&(a.zoomRate=Math.ceil(a.zoomRate/5*10)/10*5-.5),a.zoomRate<c[0]&&(a.zoomRate=c[0]),a.zoomRate>c[1]&&(a.zoomRate=c[1]),m.setCanvasScale(a.zoomRate)},a.topoToggleFullscreen=function(){var b=!a.isFullscreen,d=document.querySelector(".topo-detail-wrapper"),e=window.outerWidth,f=window.outerHeight;b?(d.webkitRequestFullscreen&&d.webkitRequestFullscreen(),d.mozRequestFullScreen&&d.mozRequestFullScreen(),d.msRequestFullscreen&&d.msRequestFullscreen(),d.requestFullscreen&&d.requestFullscreen(),m.setSize([e,f]),a.isFullscreen=b):(document.webkitExitFullscreen&&document.webkitExitFullscreen(),document.mozCancelFullScreen&&document.mozCancelFullScreen(),document.msExitFullscreen&&document.msExitFullscreen(),document.exitFullscreen&&document.exitFullscreen(),c(function(){m.setSize([o.width,o.height]),a.isFullscreen=b},500))};var u=function(){var a=m.getData(),b=_.map(a.nodes,"appId"),c={appIds:b.join(",")};return j.getCapacity(c).catch(g)},v=function(){var a=m.getData(),b=_.map(a.nodes,"appId"),c={appIds:b.join(",")};return j.getDetectSuccRate(c).catch(g)},w=function(){var a=m.getData(),b=_.map(a.nodes,"appId"),c={appIds:b.join(",")};return j.getInterfaceTrendSuccRate(c).catch(g)},x=function(){var a=m.getData(),b=_.map(a.nodes,"appId"),c={appIds:b.join(",")};return j.getInterfaceTrendDelay(c).catch(g)};a.showOptions=function(b){switch(b){case"node.capacity":m.setCapacityVisibility(!1);var c=!a.show.node.capacity;_.forEach(a.show.node,function(b,c){a.show.node[c]=!1}),a.show.node.capacity=c,c&&u().then(function(a){m.setCapacityVal(a,!0),m.setCapacityVisibility(!0)}).catch(function(){a.show.node.capacity=!1});break;case"node.detectSuccRate":m.setCapacityVisibility(!1);var d=!a.show.node.detectSuccRate;_.forEach(a.show.node,function(b,c){a.show.node[c]=!1}),a.show.node.detectSuccRate=d,d&&v().then(function(a){var b=_.map(a,function(a){var b={appId:a.appId,capacity:a.succ_rate/100};return b});m.setCapacityVal(b,!0,[0,.33,.66,1],["#F22E20","#DEB704","#1CD521","#13A7D5"]),m.setCapacityVisibility(!0)}).catch(function(){a.show.node.detectSuccRate=!1});break;case"link.interfaceTrendSuccRate":m.showLinkText(!1);var e=!a.show.link.interfaceTrendSuccRate;_.forEach(a.show.link,function(b,c){a.show.link[c]=!1}),a.show.link.interfaceTrendSuccRate=e,e&&w().then(function(a){var b=_.map(a,function(a){return a.text=a.succ_rate,a});m.setLinksText(b,"%",!0),m.showLinkText(!0)}).catch(function(){a.show.link.interfaceTrendSuccRate=!1});break;case"link.interfaceTrendDelay":m.showLinkText(!1);var f=!a.show.link.interfaceTrendDelay;_.forEach(a.show.link,function(b,c){a.show.link[c]=!1}),a.show.link.interfaceTrendDelay=f,f&&x().then(function(a){var b=_.map(a,function(a){return a.text=a.delay,a});m.setLinksText(b,"ms"),m.showLinkText(!0)}).catch(function(){a.show.link.interfaceTrendDelay=!1})}},a.switchTheme=function(b){a.themeLight="light"===b}}]),angular.module("monitor.topos.service",[]).factory("Topos",["$http","RequestWrapper",function(a,b){return{getBaseTopo:function(){return b.array({method:"GET",url:"/api/topos/base"})},getDefaultTopo:function(a){return b.object({method:"GET",url:"/api/topos/topo/default",params:a})},setDefaultTopo:function(a,c){return b.object({method:"PUT",url:"/api/topos/topo/"+a+"/default",data:c})},createUserTopo:function(a){return b.object({method:"POST",url:"/api/topos/create",data:a})},getUserToposList:function(a){return b.object({method:"GET",url:"/api/topos/list",params:a})},getUserTopo:function(a){return b.object({method:"GET",url:"/api/topos/topo/"+a})},updateUserTopo:function(a,c){return b.object({method:"PUT",url:"/api/topos/topo/"+a,data:c})},deleteUserTopo:function(a){return b.object({method:"DELETE",url:"/api/topos/topo/"+a})},getCapacity:function(a){return b.array({method:"GET",url:"/api/topos/capacity",params:a})},getDetectSuccRate:function(a){return b.array({method:"GET",url:"/api/topos/detect-succ-rate",params:a})},getInterfaceTrendSuccRate:function(a){return b.array({method:"GET",url:"/api/topos/interface-trend/succ-rate",params:a})},getInterfaceTrendDelay:function(a){return b.array({method:"GET",url:"/api/topos/interface-trend/delay",params:a})}}}]).filter("nodeType",[function(){return function(a){switch(a){case"Cylinder":return"数据库";case"Sphere":return"服务器";case"Cube":return"应用";default:return"切换类型"}}}]).filter("shapeType",function(){return function(a){switch(a){case"node":return"节点";case"link":return"关系";case"area":return"区域";case"note":return"注释";default:return""}}}).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]).service("TopoUtil",[function(){return{assemBaseData:function(a,b){_.isUndefined(b)&&(b=!1);var c=[],d=[];return _.forEach(a,function(a){c.push({node_name:a.node_name,type:a.type,name:a.name,capacity:a.capacity}),c=c.concat(a.edge_list),_.forEach(a.edge_list,function(b){d.push({source:a.node_name,target:b.node_name})})}),c=_.uniqBy(c,"node_name"),c=_.map(c,function(a){return{name:a.name,appId:a.node_name,capacity:a.capacity,shape:"Cube"}}),{appId:1,fixed:b,nodes:c,links:d}},assemUserData:function(a,b){_.isUndefined(b)&&(b=!0);var c=_.map(a.nodes,function(a){return _.assignIn({},{name:a.name,capacity:a.capacity},a.style)}),d=_.map(a.links,"style"),e=_.map(a.areas,"style"),f=_.map(a.notes,"style");return{appId:1,topoId:a.id,fixed:b,nodes:c,links:d,areas:e,notes:f}}}}]),angular.module("monitor.component",["monitor.component.home.detail"]).config(["$stateProvider",function(a){a.state("monitor.component",{abstract:!0,url:"/component",template:"<ui-view/>"}).state("monitor.component.index",{url:"/index?q&onlyAlarm&onlyMe&component&page&pageSize&sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/component/graphs.html",controller:"MonitorComponentIndexCtrl",resolve:{collectorData:["Collector","$stateParams",function(a,b){return a.listCollector(b)}],appData:["AppService",function(a){return a.fetchAppList()}],alarmData:["Monitor",function(a){return a.getNotRecoverAlarmList({type:"component"})}],componentData:["collectorData","appData","alarmData",function(a,b,c){var d={};return _.each(b,function(a){d[a.instanceId]=a.name}),_.each(a.data,function(a){d[a.app_id]?a.app={id:a.app_id,name:d[a.app_id]||"已删除应用"}:a.app={id:a.app_id};var b=a.name+"__"+a.ip+"__"+a.kwargs.port;a.alarmCount=c[b]||0}),a}]}}).state("monitor.component.home",{url:"/home?ip&port&component&pageSize",views:{"@":{abstract:!0,templateUrl:"views/monitor/component/home.html",controller:"MonitorComponentHomeCtrl",resolve:{}}}})}]).controller("MonitorComponentHomeCtrl",["$scope","$state","$stateParams","$localStorage","Dialog",function(a,b,c,d,e){c.ip&&c.component||e.confirm({type:"warning",message:"非法输入",resolved:function(){b.go("monitor.component.index")}}),a.commonParams={ip:c.ip,port:c.port,component:c.component},a.navDetailActive=function(){return b.includes("monitor.component.home.detail")},a.navAlarmActive=function(){return b.includes("monitor.component.home.alarm")}}]).controller("MonitorComponentIndexCtrl",["$scope","$state","$stateParams","$localStorage","$uibModal","USERNAME","componentData","appData",function(a,b,c,d,e,f,g,h){a.allData=g;var i=function(a,b){return b.name+"-"+b.ip+":"+b.kwargs.port},j=function(a,b){return b[a]&&b[a].name?b[a].name:"点击关联"},k=function(){return'<a><i class="fa fa-edit"></i></a>'},l=function(a,b){return b[a]?"label label-warning clickable":"label label-success clickable"},m=function(){return"monitor.component.home.detail({component: item.name , ip: item.ip , port: item.kwargs.port})"},n=function(a,c){b.go("monitor.component.home.alarm",{component:c.name,name:c.name,ip:c.ip,port:c.kwargs.port,st:"-3d",type:"component"})},o=function(c,d){var f=a.$new(!0);f.collectorData=d,f.appData=h;var g=e.open({templateUrl:"views/monitor/component/_relate-app.html",backdrop:"static",size:"md",scope:f,controller:"CollectorRelateAppCtrl"});g.result.then(function(){b.reload()})},p=function(){return"btn-link clickable"},q=function(a,b){if(_.isEmpty(b[a]))return"-";var c=b[a];return"apache"===b.name?"每秒请求数"+c["apache.net.request_per_s__last"]+"，每秒流量"+c["apache.net.bytes_per_s__last"]:"nginx"===b.name?"每秒请求数"+c["nginx.net.request_per_s__last"]+"，当前连接数"+c["nginx.net.connections__last"]:"mysql"===b.name?"当前连接数"+c["mysql.net.connections__last"]+"，每秒查询请求"+c["mysql.performance.com_select__last"]+"，每秒写请求"+(c["mysql.performance.com_update__last"]+c["mysql.performance.com_delete__last"]):"mongodb"===b.name?"当前连接数"+c["mongodb.connections.current__last"]+"，每秒查询请求"+c["mongodb.opcounters.queryps__last"]:"memcached"===b.name?c["memcache.cmd_get_rate__last"]?"缓存命中率"+100*c["memcache.get_hits_rate__last"]/c["memcache.cmd_get_rate__last"]+"%":"缓存命中率0%":"kafka"===b.name?"每秒消息量"+c["kafka.server.messages_in_per_sec__last"]:"jvm"===b.name?"fgc时间"+c["jvm.fgc.time__last"]+"ms":"tomcat"===b.name?c["tomcat.global.request_count__last"]?"每秒请求量"+c["tomcat.global.request_count__last"]+"，成功率"+100*(c["tomcat.global.request_count__last"]-c["tomcat.global.error_count__last"])/c["tomcat.global.request_count__last"]:"每秒请求量"+c["tomcat.global.request_count__last"]+"，成功率0%":"zookeeper"===b.name?"当前连接数"+c["zookeeper.current.connections__last"]+"，时延"+c["zookeeper.latency.avg__last"]+"ms":""};a.fields=[{key:"ip",name:"实例名",filter:!0,getValue:i,getLink:m},{key:"name",name:"类型",filter:!0},{key:"creator",name:"创建人",filter:!0},{key:"app",name:"关联应用",filter:!0,getValue:j,getPostValue:k,click:o,getClass:p},{key:"kpi",name:"关键指标",getValue:q,tooltip:"显示近5分钟的最新数据，如果没有，请重新编辑该采集项，调试检查是否正常"},{key:"alarmCount",name:"告警数",getClass:l,click:n}];var r=function(a,b){return!a||0!==b.alarmCount},s=function(a,b){return!a||b.creator===f},t=function(a,b){return!a||a===b.name},u=function(a,b){return!a||("true"===a?!_.isEmpty(b.kpi):"false"===a?_.isEmpty(b.kpi):void 0)};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"component",type:"select",choices:[{id:"",text:"全部类型"},{id:"apache",text:"apache"},{id:"jvm",text:"jvm"},{id:"kafka",text:"kafka"},{id:"memcached",text:"memcached"},{id:"mongodb",text:"mongodb"},{id:"mysql",text:"mysql"},{id:"nginx",text:"nginx"},{id:"redis",text:"redis"},{id:"tomcat",text:"tomcat"},{id:"zookeeper",text:"zookeeper"}],fun:t,label:""},{key:"kpi",type:"select",choices:[{id:"",text:"有无数据"},{id:"true",text:"有数据"},{id:"false",text:"无数据"}],fun:u,label:""},{key:"onlyMe",type:"checkbox",fun:s,label:"我创建的"},{key:"onlyAlarm",type:"checkbox",fun:r,label:"告警实例"}]}]).controller("CollectorRelateAppCtrl",["$scope","$uibModalInstance","handleAjaxError","VisitHistory","Collector",function(a,b,c,d,e){
a.formData={appId:""},a.appChoices=a.appData,a.close=function(){a.storing=!0,e.relateAppToComponent(a.collectorData.id,{appId:a.formData.appId}).then(function(d){d.code?(a.storing=!1,c({status:500,data:d},"关联应用失败")):b.close()}).catch(function(b){a.storing=!1,c(b,"关联应用失败")})}}]),angular.module("monitor.component.home.detail",[]).config(["$stateProvider",function(a){a.state("monitor.component.home.detail",{url:"/detail?st&from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0}},templateUrl:"views/monitor/component/detail.html",controller:"MonitorComponentDetailCtrl"})}]).controller("MonitorComponentDetailCtrl",["$scope","$state","$stateParams",function(a,b,c){var d=a.component=c.component,e={mongodb:"mongo",memcached:"mcache"},f=e[d]?e[d]:d;a.dbSlug="__easyops_"+f,a.params={"var-ip":c.ip,"var-port":c.port},a.range=_.pick(c,["from","to"]),a.rangeOptionList=[{value:{from:"now/d",to:"now"},selected:!0,text:"今天"},{value:{from:"now-2d",to:"now"},text:"近2天"},{value:{from:"now-7d",to:"now"},text:"近7天"}],a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})}}]),angular.module("monitor.collector",["monitor.collector.home.host","monitor.collector.home.component","monitor.collector.home.detect","monitor.collector.home.zabbix","monitor.collector.home.link","monitor.collector.home.custom"]).config(["$stateProvider",function(a){a.state("monitor.collector",{abstract:!0,url:"/collector",template:"<ui-view/>"}).state("monitor.collector.index",{url:"/index?q&onlyAlarm&onlyMe&component&page&pageSize&sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/collector/graphs.html",controller:"MonitorCollectorIndexCtrl",resolve:{collectorCount:["Collector",function(a){return a.getAllConfigCount()}]}}).state("monitor.collector.home",{views:{"@":{abstract:!0,url:"/collector/home",controller:"MonitorCollectorHomeCtrl",templateUrl:"views/monitor/collector/home.html",resolve:{}}}}).state("monitor.collector.component",{url:"/component",reloadOnSearch:!1,templateUrl:"views/monitor/collector/component.html",controller:"CollectorListCtrl",resolve:{componentList:["Collector",function(a){return a.getComponentList()}]}})}]).controller("MonitorCollectorIndexCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME","collectorCount",function(a,b,c,d,e,f){a.collectorCount=f}]).controller("MonitorCollectorHomeCtrl",["$scope","$state","$stateParams","$localStorage","Dialog",function(a,b,c,d,e){a.navAgentActive=function(){return b.includes("monitor.collector.home.agent")},a.navDetectActive=function(){return b.includes("monitor.collector.home.detect")},a.navLinkActive=function(){return b.includes("monitor.collector.home.link")},a.navCustomActive=function(){return b.includes("monitor.collector.home.custom")},a.navComponentActive=function(a){return b.includes("monitor.collector.home.component")&&c.name===a},a.navComponentMoreActive=function(a){return b.includes("monitor.collector.home.component.list")},a.navZabbixActive=function(){return b.includes("monitor.collector.home.zabbix")}}]),angular.module("monitor.collector.home.host",[]),angular.module("monitor.collector.home.component",["monitor.collector.home.component.list","monitor.collector.home.component.detail"]).config(["$stateProvider",function(a){a.state("monitor.collector.home.component",{url:"/component",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.collector.home.component.list",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.component.list",{url:"/list",templateUrl:"views/monitor/collector/component/list.html",controller:"MonitorCollectorComponentCtrl",resolve:{componentList:["Collector",function(a){return a.getComponentList()}]}})}]).controller("MonitorCollectorComponentCtrl",["$scope","$state","$stateParams","componentList",function(a,b,c,d){a.flags={q:c.q};var e=function(b){var c=a.flags.q;a.componentList={},angular.forEach(d.data,function(b){c&&b.name.search(new RegExp(c,"i"))===-1||(a.componentList[b.architecture]?a.componentList[b.architecture].push(b):a.componentList[b.architecture]=[b])})};e(),a.$watch("flags.q",function(a,b){e()}),a.redirectTab=function(a){return a.count>0?"list":"config"},a.isShow=function(a){return a.count>0},a.isShowArchitecture=function(b){if(a.componentList[b])return!0}}]),angular.module("monitor.collector.home.component.detail",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.component.detail",{url:"/detail?name&tab&page",templateUrl:"views/monitor/collector/component/detail.html",controller:"MonitorCollectorComponentDetailCtrl",resolve:{collectorList:["Collector","$stateParams",function(a,b){return a.listCollector(b)}]}})}]).controller("MonitorCollectorComponentDetailCtrl",["$scope","$uibModal","$state","$stateParams","$timeout","$filter","$q","toastr","handleAjaxError","Dialog","Utils","Collector","collectorList",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){function b(){f+=1,l.fetchTestResult(a).then(function(a){if(f<h)switch(a.data.code){case-1:case 0:d.resolve(a);break;default:c()}else a.data.msg={msg:"timeout",code:1},d.resolve(a)}).catch(function(a){0===a.status||403===a.status?d.reject(a):c()})}function c(){e(b,2e3)}var d=g.defer(),f=0,h=100;return c(),d.promise}d.name?a.componentName=d.name:c.go("monitor.collector.home.component.list"),a.steps=[{active:!0},{active:!1},{active:!1},{active:!1}],a.selectStep=function(b){a.steps[b].active=!a.steps[b].active},a.pageInfo={page:d.page||1,pageSize:m.page_size||200,total:m.total},a.collectorList=m.data,a.pageChange=function(){c.go("monitor.collector.home.component.detail",{name:a.componentName,tab:"list",page:a.pageInfo.page})},a.getActiveIndex=function(){return"config"===d.tab?0:"list"===d.tab?1:"metric"===d.tab?2:void 0},a.flags={tagIndex:a.getActiveIndex(),unSelected:!0,loading:!1,isUntested:!0,testing:!1,hasTestResult:!1,storing:!1,selectApp:null},a.goToConfigTab=function(){a.activeIndex=0};var o={nginx:{kwargs:[{key:"port",value:80,name:"监听端口",type:"number"},{key:"uri",value:"/nginx_status",name:"状态URI",type:"text",hide:!1},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"curl http://127.0.0.1/nginx_status"},apache:{kwargs:[{key:"port",value:80,name:"监听端口",type:"number"},{key:"uri",value:"/server-status",name:"状态URI",type:"text"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"curl http://127.0.0.1/server-status"},jvm:{kwargs:[{key:"port",value:1e4,name:"JMX端口",type:"number"},{key:"username",value:"",name:"用户名",type:"text"},{key:"password",value:"",name:"密码",type:"text"},{key:"java_bin",value:"java",name:"JAVA路径",type:"text"},{key:"timeout",value:8,name:"超时(s)",type:"number",hide:!0}],tips:"JMX"},kafka:{kwargs:[{key:"port",value:1e4,name:"JMX端口",type:"number"},{key:"username",value:"",name:"用户名",type:"text"},{key:"password",value:"",name:"密码",type:"text"},{key:"java_bin",value:"java",name:"JAVA路径",type:"text"},{key:"timeout",value:8,name:"超时(s)",type:"number",hide:!0}],tips:"JMX"},tomcat:{kwargs:[{key:"port",value:1e4,name:"JMX端口",type:"number"},{key:"username",value:"",name:"用户名",type:"text"},{key:"password",value:"",name:"密码",type:"text"},{key:"java_bin",value:"java",name:"JAVA路径",type:"text"},{key:"timeout",value:8,name:"超时(s)",type:"number",hide:!0}],tips:"JMX"},zookeeper:{kwargs:[{key:"port",value:1e4,name:"JMX端口",type:"number"},{key:"zkcli_port",value:2181,name:"ZK端口",type:"number"},{key:"username",value:"",name:"用户名",type:"text"},{key:"password",value:"",name:"密码",type:"text"},{key:"java_bin",value:"java",name:"java路径",type:"text"},{key:"timeout",value:8,name:"超时(s)",type:"number",hide:!0}],tips:"JMX"},redis:{kwargs:[{key:"port",value:6379,name:"监听端口",type:"number"},{key:"password",value:"easyops",name:"密码",type:"text"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"INFO",help:"注：只支持3.0版本以上"},memcached:{kwargs:[{key:"port",value:11211,name:"监听端口",type:"number"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"stats"},mongodb:{kwargs:[{key:"port",value:27017,name:"监听端口",type:"number"},{key:"username",value:"",name:"用户名",type:"text"},{key:"password",value:"",name:"密码",type:"text"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"db.serverStatus 和 db.dbStats"},mysql:{kwargs:[{key:"port",value:3306,name:"监听端口",type:"number"},{key:"username",value:"easyops",name:"用户名",type:"text"},{key:"password",value:"easyops",name:"密码",type:"text"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"SHOW GLOBAL STATUS"},storm_topology_collector:{kwargs:[{key:"port",value:8080,name:"监听端口",type:"number"},{key:"uri",value:"/api/v1/topology/",name:"URI",type:"text"},{key:"timeout",value:5,name:"超时(s)",type:"number",hide:!0}],tips:"curl http://127.0.0.1/api/v1/topology/"}};a.form={app_id:null,ips:[],kwargs:{host:"127.0.0.1"}},a.getKwargs=function(){return o[a.componentName].kwargs};var p=function(){angular.forEach(a.getKwargs(),function(b){a.form.kwargs[b.key]=b.value})};p(),a.getTips=function(){return o[a.componentName].tips},a.getHelp=function(){return o[a.componentName].help},a.editMode={port:!1},a.enterEditMode=function(b){a.editMode[b]=!0},a.isEdit=function(){var b=!1;return angular.forEach(a.editMode,function(a){a&&(b=!0)}),b},a.getCollectorConfigView=function(){return"views/monitor/collector/component/example/"+a.componentName+".html"},a.$watch("form",function(){a.flags.isUntested=!0},!0),a.showTestResult=function(){},a.selectDevices=function(b){a.form.ips=_.map(b,"ip"),_.isEmpty(a.form.ips)?(a.flags.unSelected=!0,a.steps[1].active=!1):(a.flags.unSelected=!1,a.steps[1].active=!0)},a.removeIp=function(b){var c=a.form.ips.indexOf(b);c>-1&&a.form.ips.splice(c,1),0===a.form.ips.length&&(a.flags.unSelected=!0)},a.clearIp=function(){a.form.ips.length=0,a.flags.unSelected=!0};var q=function(){return{name:a.componentName,app_id:a.form.app_id,ip:a.form.ips.join(","),kwargs:a.form.kwargs}},r=f("json"),s="";a.test=function(){a.flags.testing=!0,a.flags.isUntested=!0,l.testCollector(q()).then(function(a){return a.data.id}).then(n).then(function(b){var c=!0;if(b.data.data){s=b.data.data;try{s=JSON.parse(s)}catch(a){s=[{msg:"返回数据格式错误",code:1}]}}else s=b.data.msg,c=!1;a.flags.hasTestResult=!0;for(var d=!1,e=0;e<s.length;e+=1){if(!c)try{s[e].data=JSON.parse(s[e].data)}catch(a){}if(0!==s[e].code){var f=c?s[e].ip:e;h.error("立即测试失败！<br/><b>"+f+": <br/>"+s[e].msg),d=!0}}d||(a.flags.isUntested=!1,h.success("立即测试成功，现在可以保存！"))}).catch(function(a){i(a,"立即测试")}).finally(function(){a.flags.testing=!1})},a.showTestResult=function(){j.alert({message:"<pre>"+k.escapeHtml(r(s))+"</pre>",html:!0})},a.save=function(){l.createCollector(q()).then(function(a){0===a.code?(h.success("保存成功"),c.go(c.current.name,{tab:"list"})):h.error("保存失败: "+a.msg)})};var t=function(b){l.deleteCollector(b).then(function(c){0===c.code?(h.success("删除成功"),_.each(a.collectorList,function(c,d){c.id===b&&a.collectorList.splice(d,1)})):h.error("删除失败: "+c.msg)}).catch(function(a){i(a,"删除组件采集")})};a.delete=function(a){j.confirm({type:"warning",message:"确定删除所选实例吗?",isDelete:!0,resolved:function(){t(a)}})},a.collectorMetric=[],a.selectMetricTab=function(){0!==a.collectorMetric.length||a.flags.loading||(a.flags.loading=!0,l.listCollectorMetric({name:a.componentName}).then(function(b){b.data&&b.data[0]&&b.data[0].formats&&b.data[0].formats[0].fields&&(a.collectorMetric=_.filter(b.data[0].formats[0].fields,{field_type:"value"}))}).catch(function(){h.error("获得组件指标列表失败")}).finally(function(){a.flags.loading=!1}))},a.goConfigTab=function(){a.flags.tab.config=!0,a.flags.tab.list=!1,a.flags.tab.metric=!1}}]),angular.module("monitor.collector.home.detect.service",[]).filter("targetIPs",function(){return function(a){return"__all__"===a?"全部":a}}).filter("isSynced",function(){return function(a){return 0===+a?'<span class="label label-success">下发成功</span>':1===+a?'<span class="label label-warning">下发中</span>':'<span class="label label-danger">下发失败，待重试</span>'}}).filter("shortId",function(){return function(a){return(a||"").substr(0,7)}}).factory("Detect",["RequestWrapper",function(a){return{fetchCaseList:function(b){return a.array({method:"GET",url:"/api/detect/case",params:b})},fetchCaseListByPage:function(b){return a.object({method:"GET",url:"/api/detect/case-onepage",params:b})},storeCase:function(b){return a.object({method:"POST",url:"/api/detect/case",data:b})},execute:function(b){return a.object({method:"POST",url:"/api/detect/execute",data:b})},fetchExecuteResult:function(b){return a.object({method:"GET",url:"/api/detect/execute/"+b})}}}]).factory("DetectCase",["RequestWrapper",function(a){function b(a){return["/api/detect","case",a].join("/")}return{fetchCase:function(c,d){return a.object({method:"GET",url:b(c),params:d})},updateCase:function(c,d){return a.object({method:"PUT",url:b(c),data:d})},enableCase:function(c){return a.object({method:"PUT",url:b(c)+"/enable"})},disableCase:function(c){return a.object({method:"PUT",url:b(c)+"/disable"})},removeCase:function(c){return a.object({method:"DELETE",url:b(c)})},fetchFailedRecordList:function(c,d,e,f,g){return a.object({method:"GET",url:b(c)+"/failed",params:{page:d,st:e,et:f,ip:g}})},fetchSuccRecord:function(c,d,e){return a.object({method:"GET",url:b(c)+"/succeed",params:{st:d,et:e}})},fetchRecordDetail:function(c,d){return a.object({method:"GET",url:b(c)+"/record/"+d})},fetchAgentGroupList:function(){return a.array({method:"GET",url:"/api/detect/agents"})},getAgentGroup:function(b){return a.object({method:"GET",url:"/api/detect/agents/"+b})},createAgentGroup:function(b){return a.object({method:"POST",url:"/api/detect/agents",data:b})},updateAgentGroup:function(b,c){return a.object({method:"PUT",url:"/api/detect/agents/"+b,data:c})},deleteAgentGroup:function(b){return a.array({method:"DELETE",url:"/api/detect/agents/"+b})},fetchNodesData:function(c,d,e,f){return a.object({method:"GET",url:b(c)+"/node-list",params:{page:d,st:e,et:f}})},getCaseStatus:function(b){return a.object({method:"GET",url:"/api/detect/case/status",params:b})}}}]),angular.module("monitor.collector.home.detect",["monitor.collector.home.detect.list","monitor.collector.home.detect.detail","monitor.collector.home.detect.create","monitor.collector.home.detect.agent","monitor.collector.home.detect.service"]).config(["$stateProvider",function(a){a.state("monitor.collector.home.detect",{url:"/detect",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.collector.home.detect.list",[]).constant("detectList",function(a,b){a.state(b+".detect.list",{url:"/list?agent_groups&onlyAlarm&onlyMe&page&pageSize",reloadOnSearch:!1,templateUrl:"views/monitor/collector/detect/list.html",controller:"MonitorCollectorDetectCtrl",resolve:{caseListData:["$stateParams","Detect",function(a,b){return b.fetchCaseList({withAppData:1,agent_groups:a.agent_groups,appId:a.appId})}],caseStatus:["$stateParams","DetectCase",function(a,b){return b.getCaseStatus()}],caseData:["caseListData","caseStatus",function(a,b){var c=b.data?_.keyBy(b.data,"test_case_id"):{};return _.isEmpty(c)?a:(_.each(a,function(a){a.status_text=c[a.id]?c[a.id].status_text:"not_data"}),a)}],agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}]}})}).config(["$stateProvider","detectList",function(a,b){b(a,"monitor.collector.home"),b(a,"monitor.app.home")}]).controller("MonitorCollectorDetectCtrl",["$scope","$state","$stateParams","toastr","handleAjaxError","Detect","DetectCase","caseData","agentGroups","USERNAME",function(a,b,c,d,e,f,g,h,i,j){a.allData={data:h};var k=function(a){return function(b,c){return c[b]?c[b][a]:""}},l=function(a,b){return"success"!==b[a]?"label label-warning":"label label-success"},m=function(a,c){return b.current.name.indexOf("monitor.collector")!==-1?'monitor.collector.home.detect.detail({caseId: "'+c.id+'", st: "-0d", et: "-0h"})':'monitor.app.home.detect.detail({caseId: "'+c.id+'", st: "-0d", et: "-0h"})'},n=function(a){return function(b,c){return c.disabled?"禁用":a[c[b]]||"未知"}},o=function(a,b){return(b[a]?b[a].length:0)+"个"},p=function(a,b){return moment(b[a]).fromNow()};a.fields=[{key:"name",name:"任务",filter:!0,getLink:m},{key:"appData",name:"所属应用",filter:!0,getValue:k("name")},{key:"creator",name:"作者",filter:!0},{key:"update_time",name:"修改时间",getValue:p},{key:"agent_groups",name:"拨测节点",getValue:o},{key:"status_text",name:"状态",getValue:n({success:"正常",warning:"异常",not_data:"没数据"}),getClass:l}];var q=function(a,b){return!a||!b.disabled&&"success"!==b.status_text},r=function(a,b){return!a||b.creator===j};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"onlyMe",type:"checkbox",fun:r,label:"我创建的"},{key:"onlyAlarm",type:"checkbox",fun:q,label:"异常任务"}],a.showAgentGroup=function(){return"monitor.collector.home.detect.list"===b.current.name}}]),angular.module("monitor.collector.home.detect.create",[]).constant("detectCreate",function(a,b){a.state(b+".detect.create-single",{url:"/create-single?caseId",templateUrl:"views/monitor/collector/detect/create-single.html",controller:"MonitorCollectorDetectCreateSingleCtrl",resolve:{appData:["AppService","$stateParams",function(a,b){return b.appId?a.fetchApp(b.appId):null}],appListData:["AppService",function(a){return a.fetchAppList()}],caseData:["DetectCase","$stateParams",function(a,b){return b.caseId?a.fetchCase(b.caseId,{withAppData:1}):null}],agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}],deps:["depends",function(a){return a("components/editor")}]}}).state(b+".detect.create-multiple",{url:"/create-multiple?caseId",templateUrl:"views/monitor/collector/detect/create-multiple.html",controller:"MonitorCollectorDetectCreateMultipleCtrl",resolve:{appData:["AppService","$stateParams",function(a,b){return b.appId?a.fetchApp(b.appId):null}],appListData:["AppService",function(a){return a.fetchAppList()}],caseData:["DetectCase","$stateParams",function(a,b){return b.caseId?a.fetchCase(b.caseId,{withAppData:1}):null}],agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}],deps:["depends",function(a){return a("components/editor")}]}})}).config(["$stateProvider","detectCreate",function(a,b){b(a,"monitor.collector.home"),b(a,"monitor.app.home")}]).controller("MonitorCollectorDetectCreateSingleCtrl",["$scope","$stateParams","$state","$localStorage","$q","$timeout","$uibModal","$log","$filter","$aside","toastr","handleAjaxError","Dialog","Utils","beforeLeave","Detect","DetectCase","Abject","appData","caseData","agentGroups","appListData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(){H=[],I=[],_.forEach(a.baseData.appSelected.clusters,function(a){H=H.concat(a.deviceList||[]),a.deviceList&&a.deviceList.length&&I.push({name:a.name,deviceList:a.deviceList})})}function x(b,c){angular.equals(b,c)||(a.pauseWatching?(a.allDetectSteps[a.currentStep]=angular.copy(S[b]),U(),a.pauseWatching=!1,U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)):m.confirm({message:'切换类型后, 当前步骤的数据会清空！确定从 <span class="text-danger">'+c+'</span> -> <span class="text-danger">'+b+"</span> 吗？",html:!0,resolved:function(){a.allDetectSteps[a.currentStep]=angular.copy(S[b])},rejected:function(){a.allDetectSteps[a.currentStep].fun=c,U(),a.pauseWatching=!1,U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)}}))}function y(a){var b=[];return angular.forEach(a,function(a){a.key&&b.push(a.key+"="+a.value)}),b.join("&")}function z(a){var b=[];if(a){var c=a.split("&");angular.forEach(c,function(a){var c=a.split("=");c[0]&&b.push({key:c[0],value:c[1]})})}return b}function A(){var b,c=-1;"GET"!==a.allDetectSteps[a.currentStep].params_data.method&&(b=a.allDetectSteps[a.currentStep].contentType),angular.forEach(a.allDetectSteps[a.currentStep].headers,function(a,d){a.key&&"content-type"===a.key.toLowerCase()&&(c=d,b&&(a.value=b))}),b&&c===-1?a.allDetectSteps[a.currentStep].headers.unshift({key:"Content-Type",value:b}):b||c===-1||a.allDetectSteps[a.currentStep].headers.splice(c,1)}function B(b){var c={};return"http"===b.fun?(c=_.defaults(angular.copy(b),{params_data:{uri:"http://",method:"GET"},queries:[],headers:[],response:[],contentType:J,body:"",expect_httpcode:200,params:[],rtype:"json",follow_redirect:1}),a.hasBody(b)&&(_.some(b.params_data.header_params,function(a,b){return"content-type"===b.toLowerCase()&&(c.contentType=a,!0)}),a.contentTypeIsJson(b)?c.body=b.params_data.post_params:c.params=z(b.params_data.post_params)),angular.forEach(b.params_data.header_params,function(a,b){c.headers.push({key:b,value:a})}),angular.forEach(b.output,function(a,b){c.response.push({key:b,value:a})}),b.expect_httpcode?c.expect_httpcode=parseInt(b.expect_httpcode,10):c.expect_httpcode=200):"ping"===b.fun?(c=_.defaults(angular.copy(b),{params_data:{dest_addr:void 0,timeout:2,count:4,psize:64},follow_redirect:1}),c.expect=_.toNumber(c.expect)):c=_.defaults(angular.copy(b),{expect:5,params_data:{dest_addr:void 0,timeout:2,port:80},follow_redirect:1}),c}function C(){U(),a.pauseWatching=!1,angular.forEach(a.allDetectSteps,function(b,c){a.allDetectSteps[c]=B(b)})}function D(b){var c=angular.copy(a.caseData);if(delete c.appData,0===a.baseData.agent_groups.length)return m.alert({message:"至少需要选择1个拨测节点",type:"warning",callback:function(){G="base"}}),null;if(c.agent_groups=a.baseData.agent_groups,!a.baseData.appSelected&&"test"!==b)return m.alert({message:"请先录入基本信息",type:"warning",callback:function(){G="base"}}),null;a.baseData.appSelected&&(c.app_id=a.baseData.appSelected.appId);var d=angular.copy(a.allDetectSteps);c.steps=[];var e,f;return angular.forEach(d,function(b,d){var g=angular.copy(b);return _.isUndefined(g.name)?(e=g,f=d,!0):(g.params_data.header_params={},g.output={},angular.forEach(g.headers,function(a){a.key&&""!==a.key&&(g.params_data.header_params[a.key]=a.value)}),angular.forEach(g.response,function(a){a.key&&""!==a.key&&(g.output[a.key]=a.value)}),_.isEmpty(g.output)&&delete g.output,_.isEmpty(g.params_data.header_params)&&delete g.params_data.header_params,a.isEdit||"GET"!==g.params_data.method&&(g.contentType===J?g.params_data.post_params=a.post_params.value:g.params_data.post_params=y(g.params)),_.includes(g.params_data.uri,"http")||(g.params_data.uri="http://"+g.params_data.uri),delete g.contentType,delete g.headers,delete g.body,delete g.params,delete g.queries,delete g.response,_.isUndefined(g.expect_httpcode)&&(e=g,f=d),"全部"===g.target&&(g.target="__all__"),c.steps.push(g),!!e)}),{data:c,invalidStep:e,invalidStepIndex:f}}function E(a){function b(){aa=null,g+=1,p.fetchExecuteResult(a).then(function(a){if(g<h)switch(a.code){case-1:case 0:d.resolve(a);break;default:c()}else a.code="306",d.resolve(a)}).catch(function(a){d.reject(a)})}function c(){aa=f(b,2e3)}var d=e.defer(),g=0,h=30;return c(),d.promise}function F(){a.deleting=!0,q.removeCase(t.id).then(function(){k.success("删除拨测任务成功"),Z(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"删除拨测任务")}).finally(function(){a.deleting=!1})}a.caseId=b.caseId||"",b.type?a.detectType=b.type:null!==t&&(a.detectType=t.steps[0].fun),a.retdata="",!s&&t&&t.appData&&(s=t.appData),a.activeTabIndex=0,0===u.length&&(m.alert({message:"无拨测节点，请联系管理员"}),c.go(c.previous.name,c.previous.params)),a.isEdit=!!t,a.caseData=t||{steps:[],agent_groups:_.map(u,"id"),interval:60},a.baseData={appSelected:s,agent_groups:a.caseData.agent_groups},""===a.baseData.appSelected&&(a.baseData.appSelected=d.appSelected),a.agentChoices=u,a.intervalOptions=[{key:"1分钟",value:60},{key:"5分钟",value:300},{key:"15分钟",value:900},{key:"30分钟",value:1800},{key:"60分钟",value:3600}],a.selectedIps=[],a.selectDevices=function(b){a.selectedIps=_.uniq(_.map(b,"ip")),a.caseData.target=a.selectedIps.join(","),a.changed=!0},a.appChoices=v,a.getApp=function(b){b=String(b).trim().toLowerCase(),a.appChoices=_.filter(v,function(a){return _.includes(String(a.name).toLowerCase(),b)})},a.headerList=["Cache-Control","Connection","Date","Pragma","Trailer","Transfer-Encoding","Upgrade","Via","Warning","Accept","Accept-Charset","Accept-Encoding","Accept-Language","Authorization","Expect","From","Host","If-Match","If-Modified-Since","If-None-Match","If-Range","If-Unmodified-Since","Max-Forwards","Proxy-Authorization","Range","Referer","TE","User-Agent","Allow","Content-Encoding","Content-Language","Content-Length","Content-Location","Content-MD5","Content-Range","Content-Type","Expires","Last-Modified","extension-header"];var G="base";t?a.stepsDisabled=!1:a.stepsDisabled=!0,a.setCurrent=function(b){if("steps"===b){if(a.stepsDisabled)return;w()}G=b},a.isCurrent=function(a){return G===a},a.baseIsOk=function(){return a.caseData.name&&angular.isObject(a.baseData.appSelected)},a.clickTab=function(){a.refreshCodemirror=!0},a.goToSteps=function(){a.stepsDisabled=!1,G="steps",w()};var H=[],I=[];a.caseTypeList=["http","tcp","ping"],a.rTypeList=["string","json"],a.methodList=["GET","POST","PUT","DELETE"];var J="application/json",K="application/x-www-form-urlencoded";a.contentTypeList=[{value:J,text:"JSON"},{value:K,text:"x-www-form-urlencoded"},{value:null,text:"无"}];var L={name:"第1步",fun:"http",params_data:{uri:"http://",method:"GET"},queries:[{key:"",value:""}],headers:[{key:"",value:""}],response:[{key:"",value:"R"}],contentType:J,body:"",expect_httpcode:200,params:[],rtype:"string",follow_redirect:1,target:""},M={name:"",fun:"tcp",params_data:{dest_addr:void 0,timeout:5,port:80},follow_redirect:1,target:""},N={name:"",fun:"ping",params_data:{dest_addr:void 0},follow_redirect:1,target:""},O={http:L,tcp:M,ping:N};a.contentTypeIsJson=function(b){return b?b.contentType===J:a.allDetectSteps[a.currentStep].contentType===J},a.hasBody=function(b){return b?"GET"!==b.params_data.method:"GET"!==a.allDetectSteps[a.currentStep].params_data.method};var P=B(O.http),Q=B(O.tcp),R=B(O.ping),S={http:P,tcp:Q,ping:R},T=a.caseData.steps||null;a.caseName=angular.copy(a.caseData.name)||"-",T.length?a.allDetectSteps=angular.copy(T):(a.allDetectSteps=[],a.allDetectSteps.push(angular.copy(L))),a.pauseWatching=!1;var U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0);a.modifyInfo=function(){a.changed=!0},a.refreshCodemirror=!0,f(function(){a.refreshCodemirror=!1},100),a.currentStep=0,a.setCurrentStep=function(b){a.baseIsOk()?(U(),a.pauseWatching=!1,a.goToSteps(),a.currentStep=b,"__all__"===a.allDetectSteps[a.currentStep].target&&(a.allDetectSteps[a.currentStep].target="全部"),U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)):m.alert({message:"请先录入基本信息",type:"warning",callback:function(){G="base"}})},a.addStep=function(){a.submitted=!1,a.errorStepIDs=[],a.allDetectSteps.push(angular.copy(O[a.allDetectSteps[a.currentStep].fun])),a.setCurrentStep(a.allDetectSteps.length-1)},a.addSpecificStep=function(b){a.submitted=!1,a.errorStepIDs=[],a.allDetectSteps.splice(b,0,angular.copy(O[a.allDetectSteps[a.currentStep].fun])),a.setCurrentStep(b)},a.removeStep=function(b){var c;c=b>=0?b:a.currentStep,m.confirm({message:"确定删除 <code>"+a.allDetectSteps[c].name+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){U(),a.pauseWatching=!1,a.allDetectSteps.splice(c,1),a.currentStep=0}})},a.showQueries=!1,a.showQuery=function(){a.showQueries=!a.showQueries},a.addQuery=function(){a.allDetectSteps[a.currentStep].queries.push({key:"",value:""})},a.removeQuery=function(b){a.allDetectSteps[a.currentStep].queries.splice(b,1),a.queriesChanged()},a.urlChanged=function(){var b=a.allDetectSteps[a.currentStep].params_data.uri||"",c=b.match(/^([^\?#]*)(\?([^#]*))?(?:#.*)?$/),d=[];b&&(d=z(c[3])),a.allDetectSteps[a.currentStep].queries=d,a.addQuery()},a.queriesChanged=function(){var b=a.allDetectSteps[a.currentStep].params_data.uri||"",c=b.match(/^([^\?#]*)(\?([^#]*))?(?:#.*)?$/),d=[c[1]],e=y(a.allDetectSteps[a.currentStep].queries);e&&d.push(e),a.allDetectSteps[a.currentStep].params_data.uri=d.join("?")},a.addHeader=function(){a.allDetectSteps[a.currentStep].headers.push({key:"",value:""})},a.removeHeader=function(b){a.allDetectSteps[a.currentStep].headers.splice(b,1)},a.addParam=function(){a.allDetectSteps[a.currentStep].params.push({key:"",value:""})},a.removeParam=function(b){a.allDetectSteps[a.currentStep].params.splice(b,1)},a.addOutput=function(){var b={json:{key:"",value:""},string:{key:"",value:"R"}};a.allDetectSteps[a.currentStep].response.push(b[a.allDetectSteps[a.currentStep].rtype])},a.removeOutput=function(b){a.allDetectSteps[a.currentStep].response.splice(b,1)},a.rTypeChanged=function(){a.allDetectSteps[a.currentStep].response=[],a.addOutput()},a.contentTypeChanged=function(){A()},a.setMethod=function(b){"GET"===b&&2===a.activeTabIndex&&(a.activeTabIndex=0),a.modifyInfo(),a.allDetectSteps[a.currentStep].params_data.method=b,A()},a.undoAllChanged=function(){m.confirm({message:"撤销 <code>"+a.allDetectSteps[a.currentStep].name+"</code> 的变更，该步骤将恢复到未修改前的状态",html:!0,isDelete:!1,resolved:function(){U(),a.pauseWatching=!1,a.caseData.steps[a.currentStep]?a.allDetectSteps[a.currentStep]=angular.copy(a.caseData.steps[a.currentStep]):a.allDetectSteps[a.currentStep]=angular.copy(O[a.allDetectSteps[a.currentStep].fun]),a.allDetectSteps[a.currentStep]=B(a.allDetectSteps[a.currentStep]),U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)}})},C(),a.$watch("allDetectSteps[currentStep]",function(b,c){angular.equals(angular.copy(c),angular.copy(S[c.fun]))?a.pauseWatching=!0:a.pauseWatching=!1},!0);var V="javascript",W=[],X={lineWrapping:!0,lineNumbers:!1,matchBrackets:!0,mode:V};a.options=X,a.cmLoaded=function(a){W.push(a),CodeMirror.autoLoadMode(a,V);var b=a.getDoc();b.markText({line:1,ch:1},{line:1,ch:10},{css:"color:yellow"})},a.untested=!0;var Y;a.isUntested=function(){return a.untested},a.isChanged=function(){return!angular.equals(a.allDetectSteps,Y)};var Z=o(a,function(){return!a.isChanged()});a.headerCount=0;var aa;a.hasTestResult=!1;var ba,ca=i("json");try{ba=JSON.parse(a.allDetectSteps[a.currentStep].params_data.post_params)}catch(a){}finally{a.post_params=ba?{value:ca(ba)}:{value:a.allDetectSteps[a.currentStep].params_data.post_params}}a.changed=!1,a.clickTest=!1;var ca=i("json");i("highlight");a.refreshCodemirror=!0,f(function(){a.refreshCodemirror=!1},100),a.test=function(b,c){if(!(c&&13!==c.keyCode||a.testing||(a.clickTest=!0,b.caseUrl.$error.pattern||b.caseUrl.$error.required))){var e=D("test");if(e){var g=e.data;a.testing=!0,a.untested=!0,a.firstTest=!0,d.appSelected=a.baseData.appSelected,a.changed=!1,a.refreshCodemirror=!0,f(function(){a.activeTabIndex=4,a.refreshCodemirror=!1,a.hasTestResult=!1,a.testResult={value:""}},500),p.execute(g).then(function(a){return a.id}).then(E).then(function(b){if($.isEmptyObject(b))return void m.alert({type:"error",message:"拉取后台接口失败！"});if(!b.steps.length)return void m.alert({type:"error",message:"命令通道失败！"});var c=!1;a.costTime=b.timecost,a.http_code=b.steps[0].http_code;var d;try{d=JSON.parse(b.steps[0].data)}catch(a){}finally{a.testResult=d?{value:ca(d)}:{value:b.steps[0].data}}_.forEach(b.steps,function(a,d){if(1===a.code)return m.alert({type:"error",message:b.steps[0].msg}),void(c=!0)}),c||(k.success("拨测测试成功,现在可以保存!"),a.untested=!1,a.hasTestResult=!0)}).catch(function(a){l(a,"拨测测试")}).finally(function(){a.testing=!1})}}},a.lackCaseName=!1,a.clickStore=!1,a.store=function(b){if(a.clickStore=!0,!a.baseIsOk())return a.activeTabIndex=0,void(null===t&&(a.lackCaseName=!0,$("input[name='caseName']").focus()));var e=D("store");e&&(a.storing=!0,d.appSelected=a.baseData.appSelected,e.data.disabled=0,_.forEach(e.data.steps,function(a,b){a.name="第"+(b+1)+"步"}),t?(delete e.data.id,q.updateCase(t.id,e.data).then(function(a){h.log("DetectCase.updateCase",a),k.success("修改测试用例成功"),Z(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"修改测试用例")}).finally(function(){a.storing=!1})):p.storeCase(e.data).then(function(a){h.log("Detect.storeTask",a),k.success("创建测试用例成功"),Z(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"创建测试用例")}).finally(function(){a.storing=!1}))},a.removeCase=function(){m.confirm({message:"确定删除拨测任务 <code>"+n.escapeHtml(t.name)+"</code> 吗？",
html:!0,isDelete:!0,resolved:F})},a.$on("$destroy",function(){aa&&f.cancel(aa)})}]).controller("MonitorCollectorDetectCreateMultipleCtrl",["$scope","$stateParams","$state","$localStorage","$q","$timeout","$uibModal","$log","$filter","$aside","toastr","handleAjaxError","Dialog","Utils","beforeLeave","Detect","DetectCase","Abject","appData","caseData","agentGroups","appListData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(){H=[],I=[],_.forEach(a.baseData.appSelected.clusters,function(a){H=H.concat(a.deviceList||[]),a.deviceList&&a.deviceList.length&&I.push({name:a.name,deviceList:a.deviceList})})}function x(b,c){angular.equals(b,c)||(a.pauseWatching?(a.allDetectSteps[a.currentStep]=angular.copy(S[b]),U(),a.pauseWatching=!1,U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)):m.confirm({message:'切换类型后, 当前步骤的数据会清空！确定从 <span class="text-danger">'+c+'</span> -> <span class="text-danger">'+b+"</span> 吗？",html:!0,resolved:function(){a.allDetectSteps[a.currentStep]=angular.copy(S[b])},rejected:function(){a.allDetectSteps[a.currentStep].fun=c,U(),a.pauseWatching=!1,U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)}}))}function y(a){var b=[];return angular.forEach(a,function(a){a.key&&b.push(a.key+"="+a.value)}),b.join("&")}function z(a){var b=[];if(a){var c=a.split("&");angular.forEach(c,function(a){var c=a.split("=");c[0]&&b.push({key:c[0],value:c[1]})})}return b}function A(){var b,c=-1;"GET"!==a.allDetectSteps[a.currentStep].params_data.method&&(b=a.allDetectSteps[a.currentStep].contentType),angular.forEach(a.allDetectSteps[a.currentStep].headers,function(a,d){a.key&&"content-type"===a.key.toLowerCase()&&(c=d,b&&(a.value=b))}),b&&c===-1?a.allDetectSteps[a.currentStep].headers.unshift({key:"Content-Type",value:b}):b||c===-1||a.allDetectSteps[a.currentStep].headers.splice(c,1)}function B(b){var c={};return"http"===b.fun?(c=_.defaults(angular.copy(b),{params_data:{uri:"http://",method:"GET"},queries:[],headers:[],response:[],contentType:J,body:"",expect_httpcode:200,params:[],rtype:"json",follow_redirect:1}),a.hasBody(b)&&(_.some(b.params_data.header_params,function(a,b){return"content-type"===b.toLowerCase()&&(c.contentType=a,!0)}),a.contentTypeIsJson(b)?c.body=b.params_data.post_params:c.params=z(b.params_data.post_params)),angular.forEach(b.params_data.header_params,function(a,b){c.headers.push({key:b,value:a})}),angular.forEach(b.output,function(a,b){c.response.push({key:b,value:a})}),b.expect_httpcode?c.expect_httpcode=parseInt(b.expect_httpcode,10):c.expect_httpcode=200):"ping"===b.fun?(c=_.defaults(angular.copy(b),{params_data:{dest_addr:void 0,timeout:2,count:4,psize:64},follow_redirect:1}),c.expect=_.toNumber(c.expect)):c=_.defaults(angular.copy(b),{expect:5,params_data:{dest_addr:void 0,timeout:2,port:80},follow_redirect:1}),c}function C(){U(),a.pauseWatching=!1,angular.forEach(a.allDetectSteps,function(b,c){a.allDetectSteps[c]=B(b)})}function D(b){var c=angular.copy(a.caseData);if(delete c.appData,0===a.baseData.agent_groups.length)return m.alert({message:"至少需要选择1个拨测节点",type:"warning",callback:function(){G="base"}}),null;if(c.agent_groups=a.baseData.agent_groups,!a.baseData.appSelected&&"test"!==b)return m.alert({message:"请先录入基本信息",type:"warning",callback:function(){G="base"}}),null;a.baseData.appSelected&&(c.app_id=a.baseData.appSelected.appId);var d=angular.copy(a.allDetectSteps);c.steps=[];var e,f;return angular.forEach(d,function(b,d){var g=angular.copy(b);return _.isUndefined(g.name)?(e=g,f=d,!0):(g.params_data.header_params={},g.output={},angular.forEach(g.headers,function(a){a.key&&""!==a.key&&(g.params_data.header_params[a.key]=a.value)}),angular.forEach(g.response,function(a){a.key&&""!==a.key&&(g.output[a.key]=a.value)}),_.isEmpty(g.output)&&delete g.output,_.isEmpty(g.params_data.header_params)&&delete g.params_data.header_params,a.isEdit||"GET"!==g.params_data.method&&(g.contentType===J||(g.params_data.post_params=y(g.params))),_.includes(g.params_data.uri,"http")||(g.params_data.uri="http://"+g.params_data.uri),delete g.contentType,delete g.headers,delete g.body,delete g.params,delete g.queries,delete g.response,_.isUndefined(g.expect_httpcode)&&(e=g,f=d),"全部"===g.target&&(g.target="__all__"),c.steps.push(g),!!e)}),{data:c,invalidStep:e,invalidStepIndex:f}}function E(a){function b(){ca=null,g+=1,p.fetchExecuteResult(a).then(function(a){if(g<h)switch(a.code){case-1:case 0:d.resolve(a);break;default:c()}else a.code="306",d.resolve(a)}).catch(function(a){d.reject(a)})}function c(){ca=f(b,2e3)}var d=e.defer(),g=0,h=30;return c(),d.promise}function F(){a.deleting=!0,q.removeCase(t.id).then(function(){k.success("删除拨测任务成功"),ba(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"删除拨测任务")}).finally(function(){a.deleting=!1})}b.type?a.detectType=b.type:null!==t&&(a.detectType=t.steps[0].fun),a.retdata="",!s&&t&&t.appData&&(s=t.appData),a.activeTabIndex=0,0===u.length&&(m.alert({message:"无拨测节点，请联系管理员"}),c.go(c.previous.name,c.previous.params)),a.isEdit=!!t,a.intervalOptions=[{key:"1分钟",value:60},{key:"5分钟",value:300},{key:"15分钟",value:900},{key:"30分钟",value:1800},{key:"60分钟",value:3600}],a.caseData=t||{steps:[],agent_groups:_.map(u,"id"),interval:60,target:""},a.baseData={appSelected:s,agent_groups:a.caseData.agent_groups},""===a.baseData.appSelected&&(a.baseData.appSelected=d.appSelected),a.agentChoices=u,a.selectedIps=[],a.selectDevices=function(b){a.selectedIps=_.uniq(_.map(b,"ip")),a.caseData.target=a.selectedIps.join(","),a.changed=!0},a.appChoices=v,a.getApp=function(b){b=String(b).trim().toLowerCase(),a.appChoices=_.filter(v,function(a){return _.includes(String(a.name).toLowerCase(),b)})},a.headerList=["Cache-Control","Connection","Date","Pragma","Trailer","Transfer-Encoding","Upgrade","Via","Warning","Accept","Accept-Charset","Accept-Encoding","Accept-Language","Authorization","Expect","From","Host","If-Match","If-Modified-Since","If-None-Match","If-Range","If-Unmodified-Since","Max-Forwards","Proxy-Authorization","Range","Referer","TE","User-Agent","Allow","Content-Encoding","Content-Language","Content-Length","Content-Location","Content-MD5","Content-Range","Content-Type","Expires","Last-Modified","extension-header"];var G="base";t?a.stepsDisabled=!1:a.stepsDisabled=!0,a.setCurrent=function(b){if("steps"===b){if(a.stepsDisabled)return;w()}G=b},a.isCurrent=function(a){return G===a},a.baseIsOk=function(){return a.caseData.name&&angular.isObject(a.baseData.appSelected)&&a.caseData.interval},a.goToSteps=function(){a.stepsDisabled=!1,G="steps",w()};var H=[],I=[];a.caseTypeList=["http","tcp","ping"],a.rTypeList=["string","json"],a.methodList=["GET","POST","PUT","DELETE"];var J="application/json",K="application/x-www-form-urlencoded";a.contentTypeList=[{value:J,text:"JSON"},{value:K,text:"x-www-form-urlencoded"},{value:null,text:"无"}];var L={name:"第1步",fun:"http",params_data:{uri:"http://",method:"GET"},queries:[{key:"",value:""}],headers:[{key:"",value:""}],response:[{key:"",value:"R"}],contentType:J,body:"",expect_httpcode:200,params:[],rtype:"string",follow_redirect:1,target:""},M={name:"",fun:"tcp",params_data:{dest_addr:void 0,timeout:5,port:80},follow_redirect:1,target:""},N={name:"",fun:"ping",params_data:{dest_addr:void 0},follow_redirect:1,target:""},O={http:L,tcp:M,ping:N};a.contentTypeIsJson=function(b){return b?b.contentType===J:a.allDetectSteps[a.currentStep].contentType===J},a.hasBody=function(b){return b?"GET"!==b.params_data.method:"GET"!==a.allDetectSteps[a.currentStep].params_data.method};var P=B(O.http),Q=B(O.tcp),R=B(O.ping),S={http:P,tcp:Q,ping:R},T=a.caseData.steps||null;a.caseName=angular.copy(a.caseData.name)||"-",T.length?a.allDetectSteps=angular.copy(T):a.allDetectSteps=[],a.pauseWatching=!1;var U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0);a.changed=!1,a.modifyInfo=function(){a.changed=!0},a.currentStep=0,a.setCaseType=function(b){a.allDetectSteps[a.currentStep].fun=b},a.invalidPattern=!0,a.costTime=[],a.http_code=[],a.testResult=[],a.failDetail=[],a.fail=[],a.activeTabIndex=[],_.forEach(a.allDetectSteps,function(b,c){a.activeTabIndex[c]=0});var V=i("json");i("highlight");a.setCurrentStep=function(b){var c=a.$new(!0);c.caseData=a.caseData,c.step=b,c.removeHeader=a.removeHeader,c.changed=a.changed,c.modifyInfo=a.modifyInfo,c.allDetectSteps=a.allDetectSteps,c.methodList=a.methodList,c.baseData=a.baseData,c.getApp=a.getApp,c.appChoices=a.appChoices,c.caseTypeList=a.caseTypeList,c.activeTabIndexList=a.activeTabIndex,c.activeTabIndex=isNaN(b)?0:c.activeTabIndexList[b],c.firstTest=a.firstTest,c.headerList=a.headerList,c.testResultList=a.testResult,c.failList=a.fail,c.failDetailList=a.failDetail,c.httpCodeList=a.http_code,c.costTimeList=a.costTime,c.options_readonly=a.options_readonly,c.options_editable=a.options_editable,c.cmLoaded=isNaN(b)?a.cmLoaded:"",c.http_code=!isNaN(b)&&a.http_code.length?a.http_code[b]:"",c.costTime=!isNaN(b)&&a.costTime.length?a.costTime[b]:"",c.testResult=!isNaN(b)&&a.testResult.length?{value:a.testResult[b]}:{value:""},c.fail=!isNaN(b)&&a.fail[b],c.failDetail=!isNaN(b)&&a.failDetail.length?{value:a.failDetail[b]}:{value:""};var d=g.open({templateUrl:"views/monitor/collector/detect/_multi-step.html",scope:c,backdrop:"static",size:"lg",controller:"DetectCaseCreateStepCtrl"});d.result.then(function(b){a.changed=b})},a.addStep=function(b){a.fail_step="",a.submitted=!1,a.errorStepIDs=[];var c=angular.copy(O[b]);a.setCurrentStep(c),a.untested=!0,a.firstTest=!1},a.addSpecificStep=function(b){a.submitted=!1,a.errorStepIDs=[],a.allDetectSteps.splice(b,0,angular.copy(O[a.allDetectSteps[a.currentStep].fun])),a.setCurrentStep(b)},a.removeStep=function(b){var c;c=b>=0?b:a.currentStep,m.confirm({message:"确定删除<code>第"+(c+1)+"步</code>吗？",html:!0,isDelete:!0,resolved:function(){a.pauseWatching=!1,a.allDetectSteps.splice(c,1),a.currentStep=0,a.fail_step=""}})},a.showQueries=!1,a.showQuery=function(){a.showQueries=!a.showQueries},a.addQuery=function(){a.allDetectSteps[a.currentStep].queries.push({key:"",value:""})},a.removeQuery=function(b){a.allDetectSteps[a.currentStep].queries.splice(b,1),a.queriesChanged()},a.urlChanged=function(){var b=a.allDetectSteps[a.currentStep].params_data.uri||"",c=b.match(/^([^\?#]*)(\?([^#]*))?(?:#.*)?$/),d=[];b&&(d=z(c[3])),a.allDetectSteps[a.currentStep].queries=d,a.addQuery()},a.queriesChanged=function(){var b=a.allDetectSteps[a.currentStep].params_data.uri||"",c=b.match(/^([^\?#]*)(\?([^#]*))?(?:#.*)?$/),d=[c[1]],e=y(a.allDetectSteps[a.currentStep].queries);e&&d.push(e),a.allDetectSteps[a.currentStep].params_data.uri=d.join("?")},a.addHeader=function(){a.changed=!0,a.allDetectSteps[a.currentStep].headers.push({key:"",value:""})},a.removeHeader=function(b){a.allDetectSteps[a.currentStep].headers.splice(b,1),a.changed=!0},a.addParam=function(){a.changed=!0,a.allDetectSteps[a.currentStep].params.push({key:"",value:""})},a.removeParam=function(b){a.changed=!0,a.allDetectSteps[a.currentStep].params.splice(b,1)},a.addOutput=function(){var b={json:{key:"",value:""},string:{key:"",value:"R"}};a.allDetectSteps[a.currentStep].response.push(b[a.allDetectSteps[a.currentStep].rtype])},a.removeOutput=function(b){a.allDetectSteps[a.currentStep].response.splice(b,1)},a.rTypeChanged=function(){a.allDetectSteps[a.currentStep].response=[],a.addOutput()},a.contentTypeChanged=function(){A()},a.setMethod=function(b){"GET"===b&&2===a.activeTabIndex&&(a.activeTabIndex=0),a.changed=!0,a.allDetectSteps[a.currentStep].params_data.method=b,A()},a.undoAllChanged=function(){m.confirm({message:"撤销 <code>"+a.allDetectSteps[a.currentStep].name+"</code> 的变更，该步骤将恢复到未修改前的状态",html:!0,isDelete:!1,resolved:function(){U(),a.pauseWatching=!1,a.caseData.steps[a.currentStep]?a.allDetectSteps[a.currentStep]=angular.copy(a.caseData.steps[a.currentStep]):a.allDetectSteps[a.currentStep]=angular.copy(O[a.allDetectSteps[a.currentStep].fun]),a.allDetectSteps[a.currentStep]=B(a.allDetectSteps[a.currentStep]),U=a.$watch("allDetectSteps[currentStep].fun",function(a,b){x(a,b)},!0)}})},C();var W="javascript",X=[],Y={lineWrapping:!0,lineNumbers:!1,matchBrackets:!0,mode:W,readOnly:"noccursor"},Z={lineWrapping:!0,lineNumbers:!1,matchBrackets:!0,mode:W,readOnly:!1};a.options_readonly=Y,a.options_editable=Z,a.cmLoaded=function(a){X.push(a),CodeMirror.autoLoadMode(a,W)},a.untested=!0;var aa;a.isUntested=function(){return a.untested},a.isChanged=function(){return!angular.equals(a.allDetectSteps,aa)};var ba=o(a,function(){return!a.isChanged()});a.headerCount=0;var ca;a.hasTestResult=!1;a.changed=!1,a.clickTest=!1,a.testing=!1,a.test=function(b,c){a.fail_step="";var e=D("test");if(e){var g=e.data;a.clickTest=!0,a.testing=!0,a.untested=!0,a.firstTest=!0,d.appSelected=a.baseData.appSelected,a.changed=!1,f(function(){a.activeTabIndex=[],a.testResult=[],a.hasTestResult=!1},500),p.execute(g).then(function(a){return a.id}).then(E).then(function(b){if(a.testing=!1,$.isEmptyObject(b))return void m.alert({type:"error",message:"拉取后台接口失败！"});if(!b.steps.length)return void m.alert({type:"error",message:"命令通道失败！"});for(var c=0;c<a.allDetectSteps.length;c++)a.fail[c]=!1;_.forEach(b.steps,function(c,d){if(a.costTime[d]=c.timecost,a.http_code[d]=c.http_code,c.resp_header){var e;try{e=JSON.parse(c.data)}catch(a){}finally{e?a.testResult[d]=V(e):a.testResult[d]=c.data}}if(a.activeTabIndex[d]=3,1===c.code)return m.alert({type:"error",message:b.steps[d].msg}),a.fail[d]=!0,a.fail_step=d,void _.forEach(b.steps,function(b,c){a.failDetail[c]=b.msg})}),_.indexOf(a.fail,!0)===-1&&(k.success("拨测测试成功,现在可以保存!"),a.untested=!1,a.hasTestResult=!0)}).catch(function(a){l(a,"拨测测试")}).finally(function(){a.testing=!1})}},a.failStep=function(b){return b===a.fail_step},a.lackCaseName=!1,a.clickStore=!1,a.store=function(b){if(a.clickStore=!0,a.baseIsOk()){var e=D("store");e&&(_.forEach(e.data.steps,function(a,b){a.name="第"+(b+1)+"步"}),a.storing=!0,d.appSelected=a.baseData.appSelected,e.data.disabled=0,t?(delete e.data.id,q.updateCase(t.id,e.data).then(function(a){h.log("DetectCase.updateCase",a),k.success("修改测试用例成功"),ba(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"修改测试用例")}).finally(function(){a.storing=!1})):p.storeCase(e.data).then(function(a){h.log("Detect.storeTask",a),k.success("创建测试用例成功"),ba(),c.go(n.parentState(c.current.name)+".list")}).catch(function(a){l(a,"创建测试用例")}).finally(function(){a.storing=!1}))}},a.removeCase=function(){m.confirm({message:"确定删除拨测任务 <code>"+n.escapeHtml(t.name)+"</code> 吗？",html:!0,isDelete:!0,resolved:F})},a.$on("$destroy",function(){ca&&f.cancel(ca)}),a.changeHighConfig=function(){a.changed=!0}}]).controller("DetectCaseCreateStepCtrl",["$scope","$filter","$uibModalInstance","$timeout",function(a,b,c,d){function e(){var b,c=-1;"GET"!==a.newStep.params_data.method&&(b=a.newStep.contentType),angular.forEach(a.newStep.headers,function(a,d){a.key&&"content-type"===a.key.toLowerCase()&&(c=d,b&&(a.value=b))}),b&&c===-1?a.newStep.headers.unshift({key:"Content-Type",value:b}):b||c===-1||a.newStep.headers.splice(c,1)}isNaN(a.step)||(a.stepName="第"+(a.step+1)+"步"),a.refreshCodemirror=!0,d(function(){a.refreshCodemirror=!1},100),a.storeActiveTabIndex=function(b){isNaN(a.step)||(a.activeTabIndexList[a.step]=b,a.refreshCodemirror=!0)};var f=b("json");a.isEdit=!isNaN(a.step),a.newStep=angular.copy(a.allDetectSteps[a.step])||a.step;var g,h=angular.copy(a.newStep);try{g=JSON.parse(a.newStep.params_data.post_params)}catch(a){}finally{a.post_params=g?{value:f(g)}:{value:a.newStep.params_data.post_params}}a.backwardInvalid=function(){return a.step<=0||0===a.allDetectSteps.length||isNaN(a.step)},a.forwardInvalid=function(){return a.step>=a.allDetectSteps.length-1||isNaN(a.step)},a.goToPrevStep=function(){if(!a.backwardInvalid()&&a.step>0){a.step--,a.stepName="第"+(a.step+1)+"步",a.newStep=a.allDetectSteps[a.step],a.testResult={value:a.testResultList[a.step]},a.costTime=a.costTimeList[a.step],a.http_code=a.httpCodeList[a.step],a.activeTabIndex=0,a.fail=a.failList[a.step],a.failDetail={value:a.failDetailList[a.step]};var b;try{b=JSON.parse(a.newStep.params_data.post_params)}catch(a){}finally{a.post_params=b?{value:f(b)}:{value:a.newStep.params_data.post_params}}}},a.goToNextStep=function(){if(!a.forwardInvalid()&&a.step<a.allDetectSteps.length-1){a.step++,a.stepName="第"+(a.step+1)+"步",a.newStep=a.allDetectSteps[a.step],a.costTime=a.costTimeList[a.step],a.testResult={value:a.testResultList[a.step]},a.http_code=a.httpCodeList[a.step],a.activeTabIndex=0,a.fail=a.failList[a.step],a.failDetail={value:a.failDetailList[a.step]};var b;try{b=JSON.parse(a.newStep.params_data.post_params)}catch(a){}finally{a.post_params=b?{value:f(b)}:{value:a.newStep.params_data.post_params}}}},a.hasBody=function(){return"GET"!==a.newStep.params_data.method},a.addHeader=function(){a.newStep.headers.push({key:"",value:""})},a.$watchCollection("newStep",function(b,c){b!==c&&(a.changed=!0)}),a.removeHeader=function(b){a.newStep.headers.splice(b,1)},a.setMethod=function(b){"GET"===b&&2===a.activeTabIndex&&(a.activeTabIndex=0),a.newStep.params_data.method=b,e()},a.clickStoreStep=!1,a.clickTab=function(){a.refreshCodemirror=!0,d(function(){a.refreshCodemirror=!1},100)},a.storeStep=function(b){if(a.clickStoreStep=!0,b.params_data.post_params=a.post_params.value,angular.equals(h,a.newStep)||(a.changed=!0),a.isEdit)a.allDetectSteps[a.step]=b;else{a.allDetectSteps.push(b);a.allDetectSteps.length}c.close(a.changed)}}]),angular.module("monitor.collector.home.detect.detail",["monitor.collector.home.detect.detail.nodes"]).constant("detectDetail",function(a,b){a.state(b+".detect.detail",{url:"/detail?caseId&page&pageSize&from&to",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0},page:{dynamic:!0},pageSize:{dynamic:!0}},templateUrl:"views/monitor/collector/detect/detail.html",controller:"MonitorCollectorDetectDetailCtrl",resolve:{caseOriginalData:["DetectCase","$stateParams",function(a,b){return a.fetchCase(b.caseId,{withAppData:1})}],caseStatus:["$stateParams","DetectCase",function(a,b){return b.getCaseStatus({caseId:a.caseId})}],caseData:["caseOriginalData","caseStatus",function(a,b){var c=b.data?_.keyBy(b.data,"test_case_id"):{};return _.isEmpty(c)?a:(a.status_text=c[a.id]?c[a.id].status_text:"not_data",a)}],agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}]}});var c={};c["@"+b+".detect"]={},a.state(b+".detect.detail.nodes",{url:"/nodes",views:c})}).config(["$stateProvider","detectDetail",function(a,b){b(a,"monitor.collector.home"),b(a,"monitor.app.home")}]).controller("MonitorCollectorDetectDetailCtrl",["$scope","$sce","$state","$filter","$uibModal","caseData","agentGroups","$stateParams","Dialog","$timeout","DetectCase","toastr","handleAjaxError","DatetimeRangeTranslator","Utils",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){a.deleting=!0,k.removeCase(f.id).then(function(){l.success("删除拨测任务成功"),c.go("monitor.collector.home.detect.list")}).catch(function(a){m(a,"删除拨测任务")}).finally(function(){a.deleting=!1})}a.caseData=f,a.caseId=h.caseId,a.caseEnabled=1!==f.disabled;var q=_.keyBy(g,"id");a.explainAgentGroupName=function(a){return _.map(a,function(a){return q[a]?q[a].name:"已删除拨测节点"}).join("<br/>")},a.explainSteps=function(a){return _.map(a,function(a){var b=a.name+": ";return"http"===a.fun?b+a.params_data.method+" "+a.params_data.uri:"tcp"===a.fun?b+"TCP "+a.params_data.dest_addr+":"+a.params_data.port:"ping"===a.fun?b+"PING "+a.params_data.dest_addr:void 0}).join("<br/>")},a.dbSlug="__easyops_detect",a.range=_.pick(h,["from","to"]),a.params={"var-caseId":a.caseId},a.onRangeChange=function(a){c.go(c.current.name,a,{location:"replace"})},1===a.caseData.disabled?a.status="禁用":"success"===a.caseData.status_text?a.status="正常":"not_data"===a.caseData.status_text?a.status="无数据":"warning"===a.caseData.status_text?a.status="异常":a.status="未知",a.statusChanged=function(){a.statusChanging=!0;var b=a.caseEnabled?"enableCase":"disableCase",c="disableCase"===b?"禁用":"启用";k[b](a.caseId).then(function(){l.success(c+"拨测任务成功"),"disableCase"===b?a.status="禁用":a.status="启用"}).catch(function(b){m(b,c+"拨测任务"),a.caseEnabled=!a.caseEnabled}).finally(function(){a.statusChanging=!1})},a.removeCase=function(){i.confirm({message:"确定删除拨测任务 <code>"+o.escapeHtml(f.name)+"</code> 吗？",html:!0,isDelete:!0,resolved:p})}}]).controller("MonitorCollectorDetectFailDetailCtrl",["$scope","$timeout",function(a,b){a.refreshCodemirror=!0,b(function(){a.refreshCodemirror=!1},100)}]),angular.module("monitor.collector.home.detect.agent",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.detect.agent",{url:"/agent",templateUrl:"views/monitor/collector/detect/agent.html",controller:"MonitorCollectorDetectAgentCtrl",resolve:{agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}]}}).state("monitor.collector.home.detect.agent-edit",{url:"/agent/edit?id",templateUrl:"views/monitor/collector/detect/agent-edit.html",controller:"MonitorCollectorDetectAgentEditCtrl",resolve:{agentList:["Admin",function(a){return a.listAgent()}],agentGroups:["DetectCase",function(a){return a.fetchAgentGroupList()}]}})}]).controller("MonitorCollectorDetectAgentCtrl",["$scope","$state","$stateParams","agentGroups","ORG","TIME_OFFSET","Admin",function(a,b,c,d,e,f,g){a.agentGroups=d;var h=[];_.forEach(d,function(a){var b=_.filter(h,{groupName:a.group});b.length?b[0].agents.push(a):h.push({groupName:a.group||"默认分组",agents:[a],isCollapsed:!1})}),a.groups=h,a.toggleCollapsed=function(a){h[a].isCollapsed=!h[a].isCollapsed},a.agentStatus={},a.hbThreshold=90;var i=function(b){return Date.now()+f-1e3*b<1e3*a.hbThreshold},j=function(){var b=[];a.agentGroups.forEach(function(a){b=_.union(b,_.map(a.agents,"ip"))}),g.listAgent({ip:b.join(",")}).then(function(b){b.data.forEach(function(b){a.agentStatus[b.agent]||(a.agentStatus[b.agent]=i(b.hb_server_time))})})};j(),a.isOffline=function(b){return!a.agentStatus[b.ip]},a.isOtherAgent=function(a){return a.org!==e}}]).controller("MonitorCollectorDetectAgentEditCtrl",["$scope","$state","$stateParams","toastr","handleAjaxError","Dialog","DetectCase","Detect","agentList","TIME_OFFSET","ORG","agentGroups",function(a,b,c,d,e,f,g,h,i,j,k,l){a.flags={isEdit:c.id,storing:!1,canDelete:!1},a.formData={isp:"默认",region:"默认"},a.testCases=[],a.isOtherAgent=function(a){return a.org!==k};a.groupList=_.uniq(_.map(l,function(a){var b=_.isEmpty(a.group)?"默认分组":a.group;return b}));c.id&&g.getAgentGroup(c.id).then(function(d){a.isOtherAgent(d)&&(e(reason,"他人共享的拨测节点不允许修改"),b.go("monitor.collector.home.detect.agent")),a.formData=d,a.formData.agents=_.map(d.agents,"ip"),h.fetchCaseList({agent_groups:c.id}).then(function(b){a.testCases=b,_.isEmpty(a.testCases)&&(a.flags.canDelete=!0)})}).catch(function(a){e(a,"获取拨测节点详情失败"),b.go("monitor.collector.home.detect.agent")}),a.isError=function(a){return a&&a.$invalid},a.hbThreshold=90;var m=function(b){return Date.now()+j-1e3*b<1e3*a.hbThreshold},n=function(a,b){for(var c=a.split("."),d=b.split("."),e=0;e<3;e++){var f=parseInt(d[e]),g=parseInt(c[e]);if(isNaN(f)||f>g)return!0;if(f<g)return!1}return!0};a.agentChoices=[],i.data.forEach(function(b){m(b.hb_server_time)&&n("2.18.3",b.version)&&a.agentChoices.push(b.agent)}),a.agentChoices=_.sortBy(_.uniq(a.agentChoices)),a.store=function(){var f=angular.copy(a.formData);delete f.id;var h=[];if(f.agents.forEach(function(a){h.push({ip:a})}),f.agents=h,a.flags.storing=!0,a.flags.isEdit)var i=g.updateAgentGroup(c.id,f),j="修改";else var i=g.createAgentGroup(f),j="创建";i.then(function(){d.success(j+"拨测节点成功"),b.go("monitor.collector.home.detect.agent")}).catch(function(a){e(a,j+"拨测节点")}).finally(function(){a.flags.storing=!1})},a.delete=function(){f.confirm({message:"确定删除 <code>"+a.formData.name+"</code> 吗？",html:!0,isDelete:!0,resolved:function(){a.flags.storing=!0,g.deleteAgentGroup(c.id).then(function(){d.success("删除拨测节点成功"),b.go("monitor.collector.home.detect.agent")}).catch(function(a){e(a,"删除拨测节点")}).finally(function(){a.flags.storing=!1})}})},a.redirectTestCaseList=function(){b.go("monitor.collector.home.detect.list",{agent_groups:c.id})}}]),angular.module("monitor.collector.home.detect.detail.nodes",[]).constant("detectNodes",function(a,b){a.state(b+".detect.detail.nodes.list",{url:"/list",templateUrl:"views/monitor/collector/detect/detail-nodes.html",controller:"MonitorCollectorDetectDetailNodesCtrl",resolve:{nodeListData:["DetectCase","$stateParams",function(a,b){var c=b.st||"-0d",d=b.et||"-0m",e=b.page||1;return a.fetchNodesData(b.caseId,e,c,d)}],nodeData:["nodeListData","agentGroups",function(a,b){var c=_.keyBy(b,"id");return _.each(a.data,function(a){a.region=c[a.agent_group_id]?c[a.agent_group_id].region:"",a.isp=c[a.agent_group_id]?c[a.agent_group_id].isp:"",a.group=c[a.agent_group_id]?c[a.agent_group_id].group:"",a.name=c[a.agent_group_id]?c[a.agent_group_id].name:""}),a}]}}).state(b+".detect.detail.nodes.detail",{url:"/detail?ip&agent_group_id&from&to&page&pageSize",params:{from:{dynamic:!0,type:"datetimeRange",value:"now/d",squash:!0},to:{dynamic:!0,type:"datetimeRange",value:"now",squash:!0},page:{dynamic:!0},pageSize:{dynamic:!0}},templateUrl:"views/monitor/collector/detect/detail-node-detail.html",controller:"MonitorCollectorDetectDetailNodeDetailCtrl",resolve:{}})}).config(["$stateProvider","detectNodes",function(a,b){b(a,"monitor.collector.home"),b(a,"monitor.app.home")}]).controller("MonitorCollectorDetectDetailNodesCtrl",["$scope","$state","$stateParams","toastr","handleAjaxError","Detect","DetectCase","caseData","nodeData",function(a,b,c,d,e,f,g,h,i){a.caseData=h,a.allData=i;var j=function(a,b){return Math.round(b[a])+"ms"},k=function(a,b){return b.failed+" / "+b.total},l=function(){return"^.detail({agent_group_id: item.agent_group_id})"},m=function(){return"趋势"};a.fields=[{key:"name",name:"节点名称",filter:!0},{key:"group",name:"组别",filter:!0},{key:"region",name:"区域",filter:!0},{key:"isp",name:"运营商",filter:!0},{key:"timecost",name:"平均时延",getValue:j},{key:"failed",name:"失败/总次数",maxWidth:"30px",getValue:k},{key:"detail",name:"趋势",maxWidth:"30px",getValue:m,getLink:l}],a.extraSearch=[{type:"q",label:"关键字搜索"}]}]).controller("MonitorCollectorDetectDetailNodeDetailCtrl",["$scope","$state","$stateParams","$uibModal","toastr","handleAjaxError","DatetimeRangeTranslator","Detect","DetectCase","caseData","agentGroups",function(a,b,c,d,e,f,g,h,i,j,k){var l=_.keyBy(k,"id");a.agentGroup=l[c.agent_group_id]||{},a.caseData=j,a.dbSlug="__easyops_detect_node",a.range=_.pick(c,["from","to"]),a.params={"var-ip":_.map(l[c.agent_group_id].agents,"ip"),"var-caseId":c.caseId},a.onRangeChange=function(a){b.go(b.current.name,a,{location:"replace"})}}]),angular.module("monitor.collector.home.link",[]),angular.module("monitor.collector.home.custom.service",[]).factory("MonitorCustom",["$http","RequestWrapper",function(a,b){return{fetchConfigList:function(a){return b.object({method:"GET",url:"/api/monitor/custom/config",params:a})},fetchConfigDetail:function(a){return b.object({method:"GET",url:"/api/monitor/custom/config/"+a})},newConfig:function(a){return b.object({method:"POST",url:"/api/monitor/custom/config",data:a})},updateConfig:function(a,c){return b.object({method:"PUT",url:"/api/monitor/custom/config/"+a,data:c})},deleteConfig:function(a){return b.object({method:"DELETE",url:"/api/monitor/custom/config/"+a})},fetchCustomData:function(a,c){var d=angular.copy(c);return delete d.data_name,b.object({method:"GET",url:"/api/monitor/custom/data/"+a,params:d})},fetchCustomTrend:function(a,c){var d=angular.copy(c);return delete d.data_name,b.object({method:"GET",url:"/api/monitor/custom/trend/"+a,params:d})},fetchAppList:function(a){return b.object({method:"GET",url:"/api/abjectInstanceList/APP",params:a})}}}]),angular.module("monitor.collector.home.custom",["monitor.collector.home.custom.list","monitor.collector.home.custom.create","monitor.collector.home.custom.detail","monitor.collector.home.custom.service"]).config(["$stateProvider",function(a){a.state("monitor.collector.home.custom",{url:"/custom",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.collector.home.custom.list",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.custom.list",{url:"/list",templateUrl:"views/monitor/collector/custom/list.html",controller:"MonitorCollectorListCtrl",resolve:{customList:["MonitorCustom",function(a){return a.fetchConfigList({pageSize:300})}]}})}]).controller("MonitorCollectorListCtrl",["$scope","$state","$stateParams","customList","USERNAME",function(a,b,c,d,e){a.allData=d;var f=function(a,b){return _.map(b.formats,"table").join(", ")},g=function(){return'monitor.collector.home.custom.detail({id: item._id, st: "-0d", table: item.formats[0].table})'};a.fields=[{key:"data_name",name:"名称",filter:!0,getLink:g},{key:"formats",name:"采集表",filter:!0,getValue:f},{key:"creator",name:"创建者",filter:!0},{key:"ctime",name:"创建时间"},{key:"modifier",name:"修改者",filter:!0},{key:"mtime",name:"修改时间"}];var h=function(a,b){return!a||(b.creator===e||b.modifier===e)};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"onlyMe",type:"checkbox",fun:h,label:"我创建的"}]}]),angular.module("monitor.collector.home.custom.create",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.custom.create",{url:"/create?id",templateUrl:"views/monitor/collector/custom/create.html",controller:"MonitorCollectorCreateCtrl",resolve:{configData:["MonitorCustom","$stateParams",function(a,b){return b.id?a.fetchConfigDetail(b.id):null}]}})}]).controller("MonitorCollectorCreateCtrl",["$scope","$state","$stateParams","$log","$sce","toastr","MonitorCustom","configData","handleAjaxError","Dialog",function(a,b,c,d,e,f,g,h,i,j){if(a.isEdit=!0,a.getFocus=function(){a.nameFocus=!0},a.lostFocus=function(){a.nameFocus=!1},a.showAdvanced=!1,h){a.config={id:h.data.id,data_name:h.data.data_name,description:h.data.description,colDefinition:_.find(h.data.formats,{aggregation:!1}),aggDefinitions:_.filter(h.data.formats,{aggregation:!0})},_.forEach(a.config.colDefinition.fields,function(a){a.stat_period=""+a.stat_period}),_.forEach(a.config.aggDefinitions,function(b){if(a.showAdvanced=!0,b.valid=!0,b.tableNameValid=!0,_.find(b.fields,{field_name:"ip"}))b.dimRadio="ip";else if(_.find(b.fields,{field_name:"_app_id"}))b.dimRadio="_app_id";else{b.dims=[],b.dimRadio="custom";for(var c=_.remove(b.fields,{field_type:"dim"}),d=c.length,e=0;e<d;++e)b.dims.push(c[e].field_name)}_.forEach(b.fields,function(a){a.stat_period=""+a.stat_period})});var k=_.find(a.config.colDefinition.fields,{field_name:"ip"});k.reserve=!0,a.config.colDefinition.fields=_.sortBy(a.config.colDefinition.fields,["reserve","field_type","field_name"]),a.config.colDefinition.tableNameValid=!0}else a.isEdit=!1,a.config={data_name:"",description:"",colDefinition:{table:"",tableNameValid:!0,fields:[{field_name:"ip",field_type:"dim",field_value_type:"string",description:"IP",reserve:!0},{}]},aggDefinitions:[]};a.currentStep="base",a.isCurrentStep=function(b){return a.currentStep===b},a.setCurrentStep=function(b){a.currentStep!==b&&(a.currentStep=b)},a.colFieldTypeChange=function(a){"dim"==a.field_type&&(a.field_value_type="string",a.unit="")},a.addField=function(b){a.config.colDefinition.fields.push({})},a.delField=function(b){a.config.colDefinition.fields.splice(b,1);a.colDefinitionForm.$dirty=!0},a.currentAggStep=0,a.currentAgg=null,a.setAggStep=function(b){a.currentStep="aggDefinitions",a.currentAggStep=b,a.currentAgg=a.config.aggDefinitions[b],l(b)};var l=function(b){var c=a.config.aggDefinitions[b],d=c.fields,e=d.length,f=[],g=0,h=[];c.dims&&(g=c.dims.length);for(var i=0;i<g;++i)_.find(a.config.colDefinition.fields,{field_name:c.dims[i],field_type:"dim"})&&f.push(c.dims[i]);for(var i=0;i<e;++i)h.indexOf(d[i].stat_field)===-1&&h.push(d[i].stat_field);c.dims=f,c.cols=h,("custom"==c.dimRadio&&0==f.length||0==h.length)&&(c.valid=!1)};a.addAggStep=function(){var b={table:"",dims:[],cols:[],fields:[],valid:!1,newAgg:!0};a.config.aggDefinitions.push(b);
var c=a.config.aggDefinitions.length;a.setAggStep(c-1)},a.removeAggStep=function(b){a.config.aggDefinitions.splice(b,1);var c=a.config.aggDefinitions.length;0==c?a.setCurrentStep("colDefinition"):a.setAggStep(c-1)},a.refreshCurrentAggFields=function(){for(var b=[],c=a.currentAgg.cols,d=c.length,e=0;e<d;++e){var f=_.find(a.currentAgg.fields,function(a){return a.stat_field==c[e]});if(f)b.push(f);else{var f=_.find(a.config.colDefinition.fields,{field_name:c[e]});if(f){var g=angular.copy(f);g.stat_period="",g.stat_field=g.field_name,b.push(g)}}}a.currentAgg.fields=b},a.agg={dimChoices:[],colChoices:[]},a.refreshChoices=function(){var b=a.config.colDefinition.fields,c=b.length;a.agg.dimChoices=[],a.agg.colChoices=[];for(var d=0;d<c;++d)"ip"!=b[d].field_name&&("dim"===b[d].field_type?a.agg.dimChoices.push(b[d].field_name):a.agg.colChoices.push(b[d].field_name))},a.refreshAggFields=function(){for(var b=a.config.aggDefinitions,c=b.length,d=0;d<c;++d){for(var e=b[d].fields,f=e.length,g=[],h=0;h<f;++h){var i=_.find(a.config.colDefinition.fields,{field_name:e[h].stat_field});i&&"dim"!=i.field_type&&g.push({field_name:e[h].field_name,stat_field:i.field_name,field_type:i.field_type,field_value_type:i.field_value_type,unit:i.unit,stat_type:e[h].stat_type,stat_period:e[h].stat_period,description:e[h].description})}b[d].fields=g,l(d)}},a.$watch("config.colDefinition.fields",function(b,c){a.refreshChoices(),a.refreshAggFields()},!0),a.$watch("aggForm.$valid",function(b,c){b!==c&&a.isCurrentStep("aggDefinitions")&&(a.currentAgg.valid=b&&a.currentAgg.dimRadio)}),a.isInputTableValid={base:!1,col:!1,agg:!1},a.isDataNameValid=function(b){return!!b&&(a.isInputTableValid.base=!1,!(b.indexOf("__")>=0)&&(a.isInputTableValid.base=!0,!0))},a.isTableNameValid=function(b,c){if(!b)return!1;var d=!0;return a.isInputTableValid.col=!0,a.isInputTableValid.agg=!0,b.indexOf("__")>=0?d=!1:(_.filter(a.config.aggDefinitions,{table:b}).length>=2&&(d=!1,a.isInputTableValid.agg=!1),_.find(a.config.aggDefinitions,{table:a.config.colDefinition.table})&&(d=!1,a.isInputTableValid.col=!1,a.isInputTableValid.agg=!1)),a.currentAgg&&(a.currentAgg.tableNameValid=d),d};var m=["st","et","date","timerange","page","page_size","pageSize","org"];a.fieldNameTooltip="需要唯一, 仅限字母数字和下划线, 且不能以数字和下划线开头. 系统保留字: "+m.join(", "),a.isColFieldValid=function(b){return!_.startsWith(b,"__")&&(!(_.filter(a.config.colDefinition.fields,{field_name:b}).length>=2)&&!(m.indexOf(b)>=0))},a.confirmAggValid=function(){for(var b=a.config.aggDefinitions,c=b.length,d=[],e=[],f=0;f<c;++f)d.indexOf(b[f].table)===-1?d.push(b[f].table):e.push(b[f].table);a.config.colDefinition.tableNameValid=!0,d.indexOf(a.config.colDefinition.table)>=0&&(e.push(a.config.colDefinition.table),a.config.colDefinition.tableNameValid=!1),_.forEach(b,function(a){a.tableNameValid=!0});for(var g=e.length,f=0;f<g;++f){var h=_.filter(b,{table:e[f]});_.forEach(h,function(a){a.tableNameValid=!1})}a.currentAgg&&(a.currentAgg.valid=a.currentAgg.dimRadio&&a.aggForm.$valid)},a.isStatFieldValid=function(b){if(_.startsWith(b,"__")||!b)return!1;if(m.indexOf(b)>=0)return!1;var c=!0;return _.filter(a.currentAgg.fields,{field_name:b}).length>=2&&(c=!1),a.currentAgg.valid=c&&a.aggForm.$valid&&a.currentAgg.dimRadio,c},a.saving=!1,a.canSave=function(){if(a.saving)return!1;if(a.configBaseForm.$invalid)return!1;if(a.colDefinitionForm.$invalid)return!1;if(!a.isInputTableValid.base||!a.isInputTableValid.col)return!1;for(var b=a.config.aggDefinitions,c=b.length,d=0;d<c;++d)if(!b[d].valid||!b[d].tableNameValid)return!1;return!(!(a.configBaseForm.$dirty||a.colDefinitionForm.$dirty||a.aggForm.$dirty)||a.aggForm.$invalid)};var n=function(){var b={};b.data_name=a.config.data_name,b.description=a.config.description,b.formats=[];for(var c=[],d=a.config.colDefinition.fields,e=d.length,f=0;f<e;++f){var g={field_name:d[f].field_name,field_type:d[f].field_type,field_value_type:d[f].field_value_type,description:d[f].description||""};"value"===d[f].field_type&&(g.stat_type="last",g.unit=d[f].unit,g.stat_period=+d[f].stat_period||0),c.push(g)}b.formats.push({table:a.config.colDefinition.table,fields:c,aggregation:!1});for(var h=a.config.aggDefinitions,e=h.length,f=0;f<e;++f){var c=[],i=h[f].fields,j=h[f].fields.length;if("ip"==h[f].dimRadio)c.push({field_name:"ip",field_type:"dim",field_value_type:"string",description:"IP"});else if("_app_id"==h[f].dimRadio)c.push({field_name:"_app_id",field_type:"dim",field_value_type:"string",description:"应用"});else for(var k=h[f].dims,l=k.length,m=0;m<l;++m){var g=_.find(a.config.colDefinition.fields,{field_name:k[m]});g&&c.push({field_name:g.field_name,field_type:g.field_type,field_value_type:g.field_value_type,description:g.description||""})}for(var m=0;m<j;++m){var g={field_name:i[m].field_name,field_type:i[m].field_type,field_value_type:i[m].field_value_type,description:i[m].description||"",stat_field:i[m].stat_field,unit:i[m].unit,stat_type:i[m].stat_type,stat_period:+i[m].stat_period};c.push(g)}b.formats.push({table:h[f].table,fields:c,aggregation:!0})}return b};a.save=function(){if(!a.saving){a.saving=!0;var d=n();if(c.id){var e=c.id;g.updateConfig(e,d).then(function(a){b.go("monitor.collector.home.custom.list")}).catch(function(a){i(a,"更新自定义监控配置")}).finally(function(){a.saving=!1})}else g.newConfig(d).then(function(a){b.go("monitor.collector.home.custom.list")}).catch(function(a){i(a,"创建自定义监控配置")}).finally(function(){a.saving=!1})}},a.delConfig=function(){a.saving||a.config.id&&j.confirm({type:"warning",message:"确定删除该配置吗?",isDelete:!0,resolved:function(){g.deleteConfig(a.config.id).then(function(a){0==a.code&&b.go("monitor.collector.home.custom.list")}).catch(function(a){i(a,"删除自定义监控配置")}).finally(function(){})}})}}]),angular.module("monitor.collector.home.custom.detail",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.custom.detail",{url:"/detail/:id?table&st&pageSize&page",templateUrl:"views/monitor/collector/custom/detail.html",controller:"MonitorCollectorDetailCtrl",resolve:{customConfig:["MonitorCustom","$stateParams",function(a,b){return a.fetchConfigDetail(b.id)}],customData:["MonitorCustom","$stateParams","$state","customConfig","$localStorage",function(a,b,c,d,e){var f=e[c.current.name]||{},g=_.toInteger(b.pageSize)||_.toInteger(f.pageSize)||20,h=b.st||"-0d",i=b.page||1,j=b.table;return b.table||(j=d.data.formats[0].table),a.fetchCustomData(d.data.data_name,{st:h,__table:j,page:i,pageSize:g,__sortby__:"-time"})}],appData:["AppService",function(a){return a.fetchAppList()}]}})}]).controller("MonitorCollectorDetailCtrl",["$scope","$state","$stateParams","customConfig","customData","appData",function(a,b,c,d,e,f){a.id=c.id,a.customConfig=d.data,a.allData=e;var g=_.keyBy(f,"instanceId"),h=_.keyBy(a.customConfig.formats,"table");a.currentTable=h[c.table];var i=function(a,b){return moment.unix(b[a]).format("YYYY-MM-DD HH:mm")},j=function(a,b){return g[b[a]]?g[b[a]].name:"已删除应用"};a.fields=[{key:"time",name:"时间",sort:!1,getValue:i}];var k=["ip","_app_id","_business_level1_id","_business_level2_id","_business_level3_id"];_.each(a.currentTable.fields,function(b){var d=b.field_name;b.unit&&b.unit.length&&(d=b.field_name+"("+b.unit+")");var e=a.customConfig.data_name+"."+c.table+"."+b.field_name;k.indexOf(b.field_name)!==-1&&(e=b.field_name,d=b.description),"_app_id"===e?a.fields.push({key:e,name:d,sort:!1,getValue:j}):a.fields.push({key:e,name:d,sort:!1})});var l=[];_.each(h,function(a,b){l.push({id:b,text:b+"表"})}),a.extraSearch=[{key:"table",type:"select",choices:l,fun:null,label:""},{key:"st",type:"date",choices:[{id:"-0d",text:"今天"},{id:"-3d",text:"过去3天"},{id:"-7d",text:"过去7天"}],fun:null,label:"",class:"pull-right"}]}]),angular.module("monitor.collector.home.zabbix",[]).config(["$stateProvider",function(a){a.state("monitor.collector.home.zabbix",{url:"/zabbix?instanceId",templateUrl:"views/monitor/collector/zabbix/graphs.html",controller:"MonitorCollectorZabbixCtrl",resolve:{}})}]).controller("MonitorCollectorZabbixCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME",function(a,b,c,d,e){}]),angular.module("monitor.alarm",["monitor.alarm.notice","monitor.alarm.notice.service","monitor.alarm.home.rule"]).config(["$stateProvider",function(a){a.state("monitor.alarm",{abstract:!0,url:"/alarm",template:"<ui-view/>",resolve:{}}).state("monitor.alarm.index",{url:"/index?q&onlyMe&page&pageSize&sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/alarm/graphs.html",controller:"MonitorAlarmDutyCtrl",resolve:{alarmData:["Monitor",function(a){return a.getNotRecoverAlarmList()}],alertTypeData:["Monitor",function(a){return a.getAlarmTypeList()}],alertTypeDict:["alertTypeData",function(a){var b={};return _.each(a.data,function(a){b[a.id]={name:a.name,alertSubType:{}},_.each(a.alert_sub_type,function(c){b[a.id].alertSubType[c.id]={name:c.name,alertItem:{}},_.each(c.alert_item,function(d){b[a.id].alertSubType[c.id].alertItem[d.id]=d})})}),b}],noticeList:["monitorNotice",function(a){return a.getNoticeList()}]}}).state("monitor.alarm.home",{url:"/home",template:"<ui-view/>",resolve:{alertTypeData:["Monitor",function(a){return a.getAlarmTypeList()}],alertTypeDict:["alertTypeData",function(a){var b={};return _.each(a.data,function(a){b[a.id]={name:a.name,alertSubType:{}},_.each(a.alert_sub_type,function(c){b[a.id].alertSubType[c.id]={name:c.name,alertItem:{}},_.each(c.alert_item,function(d){b[a.id].alertSubType[c.id].alertItem[d.id]=d})})}),b}]}})}]).constant("alarmList",function(a,b,c){a.state(b,{url:c+"?q&onlyMe&page&pageSize&sortBy&sortOrder&st&level&alertType&name&type",reloadOnSearch:!1,templateUrl:"views/monitor/alarm/list.html",controller:"MonitorAlarmListCtrl",resolve:{alarmData:["Monitor","$state","$stateParams","$localStorage",function(a,b,c,d){var e=d[b.current.name]||{},f=_.toInteger(c.pageSize)||_.toInteger(e.pageSize)||20,g={};return _.forEach(c,function(a,b){"#"!==b&&(g[b]=a)}),g.pageSize=f,a.getAlarmList(g)}],alertTypeData:["Monitor",function(a){return a.getAlarmTypeList()}],alertTypeDict:["alertTypeData",function(a){var b={};return _.each(a.data,function(a){b[a.id]={name:a.name,alertSubType:{}},_.each(a.alert_sub_type,function(c){b[a.id].alertSubType[c.id]={name:c.name,alertItem:{}},_.each(c.alert_item,function(d){b[a.id].alertSubType[c.id].alertItem[d.id]=d})})}),b}]}})}).config(["$stateProvider","alarmList",function(a,b){b(a,"monitor.alarm.list","/list"),b(a,"monitor.app.home.alarm","/alarm"),b(a,"monitor.host.home.alarm","/alarm"),b(a,"monitor.component.home.alarm","/alarm")}]).controller("MonitorAlarmDutyCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME","AlarmRuleCommonFun","alarmData","alertTypeDict","noticeList",function(a,b,c,d,e,f,g,h,i){function j(a){var b=moment(),c=moment(a.start_time),d=moment(a.end_time),e=!1;return c.isBefore(b)&&d.isAfter(b)&&(e=!0),e}a.allData=g,a.alertTypeDict=h,a.noticeFont=14,a.noticeCount=0;var k=[];_.forEach(i,function(a){j(a)&&k.push(a.content)}),a.showNotice=k,a.allData.data.sort(function(a,b){return b.time-a.time});var l=function(a){return function(b,c){return _.isEmpty(c[b])?"":c[b].join(a)}},m=function(a,b){return 1==b[a]?"label label-warning":2==b[a]?"label label-danger":void 0},n=function(a,b){return 999999===b[a]?"3 天以上":moment.duration(b[a],"seconds").humanize()},o=function(a,b){return moment.unix(b[a]).format("MM-DD HH:mm")},p=function(a,b){var c={0:"一般",1:"告警",2:"严重"};return c[b[a]]},q=function(b,c){try{var d=(a.alertTypeDict[c.alert_type].name,a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].name,a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].name),e=a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].unit}catch(a){var d="已删除策略"}var g={0:"等于",1:"大于",2:"小于"};d.indexOf("告警")!=-1&&(d=d.substring(0,d.indexOf("告警")));var h=[f.metaData.alert_type.detect,f.metaData.alert_type.process,f.metaData.alert_type.stop];return h.indexOf(c.alert_type)!==-1?d:d+g[c.comparator]+c.threshold+e},r=function(b,c){if(c.alert_type===f.metaData.alert_type.detect)return c.msg;if(c.alert_type===f.metaData.alert_type.stop)return"无数据上报";if(c.alert_type===f.metaData.alert_type.process)return f.getProcessAlarmContent(c);var d={0:" = ",1:"↑",2:"↓"},e=a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].unit;return c.value+e+" "+d[c.comparator]};a.fields=[{key:"level",name:"等级",getValue:p,getClass:m},{key:"alart_type",name:"告警策略",filter:!0,getValue:q},{key:"value",name:"告警值",filter:!0,getValue:r},{key:"target",name:"告警对象",filter:!0,maxWidth:"10%"},{key:"receiver",name:"通知人",filter:!0,getValue:l(", ")},{key:"time",name:"最近告警",getValue:o},{key:"alert_duration",name:"持续时间",getValue:n}];var s=function(a,b){return!a||!_.isEmpty(b.receiver)&&b.receiver.indexOf(e)!==-1},t=function(a,b){return""===a||a==b.level};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"level",type:"select",choices:[{id:"",text:"全部等级"},{id:0,text:"一般"},{id:1,text:"告警"},{id:2,text:"严重"}],fun:t,label:""},{key:"onlyMe",type:"checkbox",fun:s,label:"我的告警"}]}]).controller("MonitorAlarmListCtrl",["$scope","$state","$stateParams","$localStorage","USERNAME","AlarmRuleCommonFun","alarmData","alertTypeData","alertTypeDict",function(a,b,c,d,e,f,g,h,i){a.allData=g,a.alertTypeDict=i,a.showPageBack=function(){return"monitor.alarm.list"===b.current.name};var j=function(a){return function(b,c){return _.isEmpty(c[b])?"":c[b].join(a)}},k=function(a,b){return moment.unix(b[a]).format("MM-DD HH:mm")},l=function(a,b){var c={0:"一般",1:"告警",2:"严重"};return c[b[a]]},m=function(b,c){try{var d=(a.alertTypeDict[c.alert_type].name,a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].name,a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].name),e=a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].unit}catch(a){var d="已删除策略"}var g={0:"等于",1:"大于",2:"小于"};d.indexOf("告警")!=-1&&(d=d.substring(0,d.indexOf("告警")));var h=[f.metaData.alert_type.detect,f.metaData.alert_type.process,f.metaData.alert_type.stop];return h.indexOf(c.alert_type)!==-1?d:d+g[c.comparator]+c.threshold+e},n=function(b,c){if(c.alert_type===f.metaData.alert_type.detect)return c.msg;if(c.alert_type===f.metaData.alert_type.stop)return"无数据上报";if(c.alert_type===f.metaData.alert_type.process)return f.getProcessAlarmContent(c);var d={0:" = ",1:"↑",2:"↓"},e=a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].unit;return c.value+e+" "+d[c.comparator]},o=function(a,b){var c={0:"告警已发送",1:"告警被收敛",2:"告警恢复",3:"告警被屏蔽"};return c[b[a]]};a.fields=[{key:"level",name:"等级",sort:!1,getValue:l},{key:"alert_type",name:"告警策略",sort:!1,filter:!0,getValue:m},{key:"value",name:"告警值",sort:!1,filter:!0,getValue:n},{key:"target",name:"告警对象",sort:!1,filter:!0,maxWidth:"30%"},{key:"receiver",name:"通知人",sort:!1,filter:!0,getValue:j(", ")},{key:"time",name:"告警时间",sort:!1,getValue:k},{key:"status",name:"状态",sort:!1,getValue:o}];for(var p=function(a,b){return!a||!_.isEmpty(b.receiver)&&b.receiver.indexOf(e)!==-1},q=function(a,b){return""===a||a===b.level},r=function(a,c){b.go(b.current.name,{st:a})},s=[{id:"",text:"全部类型"}],t=0,u=h.data.length;t<u;t++){var v=h.data[t];b.includes("monitor.host")&&[1,6].indexOf(v.id)===-1||b.includes("monitor.component")&&4!==v.id||b.includes("monitor.app")&&[2,3,5,7,8].indexOf(v.id)===-1||(b.includes("monitor.app")?s.push({id:v.id+".",text:v.name}):b.includes("monitor.component")?_.forEach(v.alert_sub_type,function(a){a.name.indexOf(c.component)!==-1&&s.push({id:v.id+"."+a.id,text:a.name})}):_.forEach(v.alert_sub_type,function(a){s.push({id:v.id+"."+a.id,text:v.name+"/"+a.name})}))}a.extraSearch=[{key:"alertType",type:"select",choices:s,fun:q,label:""},{key:"level",type:"select",choices:[{id:"",text:"全部等级"},{id:"0",text:"一般"},{id:"1",text:"告警"},{id:"2",text:"严重"}],fun:q,label:""},{key:"onlyMe",type:"checkbox",fun:p,label:"我的告警"},{key:"st",type:"date",choices:[{id:"-0d",text:"今天"},{id:"-3d",text:"过去3天"},{id:"-7d",text:"过去7天"}],fun:r,label:"",class:"pull-right"}],b.includes("monitor.alarm")&&a.extraSearch.unshift({type:"q",label:"输入告警对象或通知人搜索"}),a.getRowClass=function(a){return 2==a.level?"danger":1==a.level?"warning":""}}]).controller("MonitorAlarmHomeCtrl",["$scope","$state","$stateParams",function(a,b,c){}]),angular.module("monitor.alarm.notice",["monitor.alarm.notice.service"]).config(["$stateProvider",function(a){a.state("monitor.alarm.notice",{url:"/notice",abstract:!0}).state("monitor.alarm.notice.list",{url:"?sortBy&sortOrder",reloadOnSearch:!1,templateUrl:"views/monitor/alarm/notice/graphs.html",controller:"monitorNoticeIndexCtrl",resolve:{noticeList:["monitorNotice",function(a){return a.getNoticeList()}]}}).state("monitor.alarm.notice.detail",{url:"/detail/:id",templateUrl:"views/monitor/alarm/notice/add-notice.html",controller:"monitorNoticeCreateCtrl",resolve:{noticeData:["monitorNotice","$stateParams",function(a,b){var c=b.id;return a.getNoticeDetail(c)}]}}).state("monitor.alarm.notice.add",{url:"/add",templateUrl:"views/monitor/alarm/notice/add-notice.html",controller:"monitorNoticeCreateCtrl",resolve:{noticeData:function(){return null}}})}]).controller("monitorNoticeIndexCtrl",["$scope","noticeList","$state",function(a,b,c){function d(a){var b=moment();return b.isAfter(moment(a))}a.allData={data:b},a.allData.data.sort(function(a,b){return moment(b.start_time).isAfter(moment(a.start_time))});var e=function(a,b){d(b.end_time)||c.go("monitor.alarm.notice.detail",{id:b.id})},f=function(a,b){return d(b.end_time)?"text-muted":"link"};a.getRowClass=function(a){if(d(a.end_time))return"text-muted"},a.fields=[{key:"content",name:"内容",getClass:f,maxWidth:400,click:e},{key:"start_time",name:"起始时间"},{key:"end_time",name:"结束时间"},{key:"creator",name:"创建者",filter:!0},{key:"update_time",name:"修改时间"}]}]).controller("monitorNoticeCreateCtrl",["$scope","$state","$stateParams","handleAjaxError","toastr","Dialog","monitorNotice","noticeData",function(a,b,c,d,e,f,g,h){function i(){var a=c.id;g.deleteNotice(a).then(function(a){a.code||(e.error("删除公告成功!"),b.go("monitor.alarm.notice.list",{sortBy:"update_time",sortOrder:"desc"},{reload:!0}))}).catch(function(a){d(a)})}var j={};if(a.isEdit=!!h,a.datepickerStatus={startTimeOpen:!1,endTimeOpen:!1},a.openStartDatepicker=function(){a.datepickerStatus.startTimeOpen=!0},a.openEndDatepicker=function(){a.datepickerStatus.endTimeOpen=!0},a.isEdit){var k=h.data;j.startTime=new Date(k.start_time),j.endTime=new Date(k.end_time),j.content=k.content,a.noticeForm=j}else j=a.noticeForm={startTime:new Date,endTime:new Date};a.timeError=!1,a.saving=!1,a.save=function(f){var h=moment(j.startTime),i=moment(j.endTime),k=moment();if(!f.$invalid){if(i.isBefore(h))return void(a.timeError=!0);if(a.timeError=!1,i.isBefore(k))return void(a.timeExpired=!0);a.timeExpired=!1;var l={content:j.content,start_time:h.format("YYYY-MM-DD HH:mm:ss"),end_time:i.format("YYYY-MM-DD HH:mm:ss")};if(a.saving=!0,a.isEdit){var m=c.id;g.modifyNotice(m,l).then(function(a){a.code||(e.success("修改公告成功!"),b.go("monitor.alarm.notice.list",{sortBy:"update_time",sortOrder:"desc"}))}).catch(function(a){d(a)}).finally(function(){scope.saving=!1})}else g.createNotice(l).then(function(a){a.code||(e.success("新建公告成功!"),b.go("monitor.alarm.notice.list",{sortBy:"update_time",sortOrder:"desc"}))}).catch(function(a){d(a)}).finally(function(){scope.saving=!1})}},a.delete=function(){f.confirm({message:"确实要删除该公告吗？",html:!0,isDelete:!0,resolved:function(){i()}})}}]),angular.module("monitor.alarm.notice.service",[]).factory("monitorNotice",["$http","RequestWrapper",function(a,b){return{getNoticeList:function(){return b.array({method:"GET",url:"/api/monitor/get-notice-list"})},getNoticeDetail:function(a){return b.object({method:"GET",url:"/api/monitor/get-notice-detail/"+a})},modifyNotice:function(a,c){return b.object({method:"PUT",url:"/api/monitor/modify-notice/"+a,data:c})},createNotice:function(a){return b.object({method:"PUT",url:"/api/monitor/create-notice",data:a})},deleteNotice:function(a){return b.object({method:"DELETE",url:"/api/monitor/delete-notice/"+a})}}}]),angular.module("monitor.alarm.home.rule.service",[]).factory("AlarmRuleCommonFun",[function(){return{metaData:{needAddNameKeys:["_app_id","_business_level1_id","_business_level2_id","_business_level3_id"],objectNameMap:{_app_id:"app_name",_business_level1_id:"business_level1_name",_business_level2_id:"business_level2_name",_business_level3_id:"business_level3_name"},cluster_type:{develop:"0",test:"1",production:"2",unbind:"-1"},alert_type:{host:1,detect:2,component:4,stop:6,process:7}},getRuleData:function(a){var b={};return b._id=a._id,b.alert_type=_.toString(a.alert_type),b.alert_sub_type=_.toString(a.alert_sub_type),b.alert_item=_.toString(a.alert_item),b.threshold=a.threshold,a.extra_receiver&&(b.extra_receiver=_.map(a.extra_receiver,function(a){return{text:a}})),b.rule_priority=a.rule_priority,b.comparator=_.toString(a.comparator),a.app_id&&(b.business={},b.business.appId=a.app_id,b.business.name=a.app_name),a.business_id&&(b.business={},b.business.businessId=a.business_id,b.business.name=a.business_name),a._app_id&&(b._app_id={},b._app_id.appId=a._app_id,b._app_id.name=a.app_name),a.ip&&(b.ip=a.ip),a.alert_interval?b.alert_interval=a.alert_interval:b.alert_interval=60,b.disable_alert=a.disable_alert,b.rule_name=a.rule_name,b.alert_way={email:!1,massage:!1},3===a.alert_way?(b.alert_way.email=!0,b.alert_way.message=!0):2===a.alert_way?b.alert_way.message=!0:1===a.alert_way&&(b.alert_way.email=!0),b.receiver_group=a.receiver_group,b.handle_steps=a.handle_steps,b.create_user=a.create_user,b.src_name=a.src_name,b.dst_name=a.dst_name,_.isObject(a.dst_interface)?b.dst_interface=a.dst_interface.name:b.dst_interface=a.dst_interface,_.has(a,"handle_method")?b.handle_method=a.handle_method:b.handle_method=[{type:"tool"}],b.level=a.level?String(a.level):"0",_.assignIn(a,b)},explainAlarmType:function(a){var b={},c=[],d={},e={},f={},g={},h={},i=[];return a.data&&(g=a.data.group_to_alert_param,h=a.data.group_to_target_param,angular.forEach(_.keys(a.data.type),function(b){c.push(b);var g=a.data.type[b];angular.forEach(_.keys(g),function(a){d[a]=g[a];var b=g[a];angular.forEach(_.keys(b),function(a){e[a]=b[a],f[a]=b[a].unit,b[a].disable_comparator&&i.push(a)})})})),b={alarm_type:c,alarm_sub_type:d,alarm_sub_group:e,alarm_sub_units:f,group_to_alert_param:g,group_to_target_param:h,disable_comparator_list:i}},getProcessAlarmContent:function(a){var b="";if(!_.isEmpty(a.process_process_abnormal_ports)){var c=a.process_process_abnormal_ports.split("##");b=c.join(",")+"端口异常"}if(!_.isEmpty(a.process_process_abnormal_processes)){var d=a.process_process_abnormal_processes.split("##"),e=[],f=[];_.each(d,function(a){var b=a.split("|"),c=b[0].split(":")[0],d=b[1];"0"===d?e.push(c):f.push(c)}),_.isEmpty(e)||(b+="; "+e.join(",")+"进程不存在"),_.isEmpty(f)||(b+="; "+f.join(",")+"进程少于指定数量")}return b}}}]),angular.module("monitor.alarm.home.rule",["monitor.alarm.home.rule.service","monitor.alarm.home.rule.list","monitor.alarm.home.rule.create","monitor.alarm.home.rule.detail"]).config(["$stateProvider",function(a){a.state("monitor.alarm.home.rule",{url:"/rule",template:"<div ui-view></div>",resolve:{}})}]),angular.module("monitor.alarm.home.rule.list",[]).config(["$stateProvider",function(a){a.state("monitor.alarm.home.rule.list",{url:"/list?sortBy&sortOrder",templateUrl:"views/monitor/alarm/rule/list.html",controller:"MonitorAlarmRuleListCtrl",reloadOnSearch:!1,resolve:{alarmRuleList:["Monitor",function(a){return a.getAlarmRuleList()}],comparatorList:["Monitor",function(a){return a.getComparatorList()}]}})}]).controller("MonitorAlarmRuleListCtrl",["$scope","$state","$stateParams","alarmRuleList","alertTypeData","alertTypeDict","comparatorList","USERNAME","AlarmRuleCommonFun",function(a,b,c,d,e,f,g,h,i){a.allData=d,a.alertTypeDict=f;var j=function(){return"monitor.alarm.home.rule.detail({id: item.id})"},k={0:"等于",1:"大于",2:"小于",3:"波动大于",4:"波动小于"},l=function(b,c){var d=c.alert_type;if(d===i.metaData.alert_type.detect)return"拨测任务异常";if(d===i.metaData.alert_type.stop)return"无数据上报";if(d===i.metaData.alert_type.process)return"进程/端口异常";var e=a.alertTypeDict[c.alert_type].alertSubType[c.alert_sub_type].alertItem[c.alert_item].unit;return 3!==c.comparator&&4!==c.comparator||(e="%"),k[c.comparator]+c.threshold+e},m=function(a,b){return _.isEmpty(b[a])?"全部":_.map(b[a],"display_value").join(", ")},n=function(a,b){return 1===b[a]?"✉️":"无"},o=function(a,b){return b[a]?"禁用":"启用"},p=function(a,b){var c=_.map(b[a],"translate").join(", ");return _.isEmpty(b.extra_receiver)||(""!==c&&(c+=", "),c+=b.extra_receiver.join(", ")),c},q=function(a,b){return b[a]?"label label-warning":"label label-success"},r=function(a,b){return b[a]?moment.unix(b[a]).fromNow():"-"},s=function(a,b){var c={0:"一般",1:"告警",2:"严重"};return c[b[a]]};a.fields=[{key:"rule_name",name:"名称",filter:!0,getLink:j},{key:"threshold",name:"告警条件",filter:!0,getValue:l},{key:"alert_dims",name:"告警对象",getValue:m},{key:"alert_way",name:"通知",getValue:n},{key:"receiver_group",name:"通知组/人",filter:!0,getValue:p},{key:"create_user",name:"创建者",filter:!0},{key:"mtime",name:"修改时间",getValue:r},{key:"level",name:"等级",getValue:s},{key:"disable_alert",name:"启动",getValue:o,getClass:q}];var t=function(a,b){return!a||b.create_user===h},u=function(a,b){return!a||1===b.disable_alert},v=function(a,b){return""===a||_.toInteger(a)===b.level};a.extraSearch=[{type:"q",label:"关键字搜索"},{key:"level",type:"select",choices:[{id:"",text:"全部等级"},{id:0,text:"一般"},{id:1,text:"告警"},{id:2,text:"严重"}],fun:v,label:""},{key:"onlyMe",type:"checkbox",fun:t,label:"我创建的"},{key:"onlyDisabled",type:"checkbox",fun:u,label:"禁用的"}]}]),angular.module("monitor.alarm.home.rule.create",[]).config(["$stateProvider",function(a){a.state("monitor.alarm.home.rule.create",{url:"/create?_id",templateUrl:"views/monitor/alarm/rule/create.html",controller:"MonitorAlarmRuleCreateCtrl",resolve:{alarmTypeList:["MonitorOld",function(a){return a.getAlarmTypeList()}],allUserList:["User",function(a){return a.userAllList()}],modifiedRule:["MonitorOld","$stateParams",function(a,b){return b._id?a.getRuleOne(b._id).then(function(a){if(404===a.code)throw new Error("该策略不存在");if(0!==a.code)throw new Error("查询策略失败");return a}):null}]}}).state("monitor.alarm.home.rule.create.type",{url:"/type",templateUrl:"views/monitor/alarm/rule/create-steps/step-type.html"}).state("monitor.alarm.home.rule.create.multi",{url:"/multi",templateUrl:"views/monitor/alarm/rule/create-steps/step-multi.html"}).state("monitor.alarm.home.rule.create.object",{url:"/object",templateUrl:"views/monitor/alarm/rule/create-steps/step-object.html"}).state("monitor.alarm.home.rule.create.strategy",{url:"/strategy",templateUrl:"views/monitor/alarm/rule/create-steps/step-strategy.html"})}]).controller("MonitorAlarmRuleCreateCtrl",["$scope","$state","$stateParams","$q","$timeout","$filter","$location","$uibModal","toastr","Dialog","MonitorOld","Business","allUserList","alarmTypeList","$aside","Abject","modifiedRule","handleAjaxError","BLACK_ALERT_TYPE","Tools","Flows","AlarmRuleCommonFun",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){a.modifiedId=c._id||null,a.stepActive=function(a){var c="monitor.alarm.home.rule.create."+a;return b.includes(c)},angular.forEach(s,function(a){delete n.data.type[a]});var w=v.explainAlarmType(n);a.activeType="app",a.checkClusterType={develop:!1,test:!1,production:!0,unbind:!1},a.customAlert=!1;var x=[{label:"业务 / 应用",value:"app",group:["process","app","ip"]},{label:"IP",value:"ip",group:["ip"]},{label:"主调服务",value:"src_name",group:["interface"]},{label:"被调服务",value:"dst_name",group:["interface"]},{label:"被调接口",value:"dst_interface",group:["interface"]}];a.preparedMap={ip:"IP",_app_id:"应用",_business_level1_id:"一级业务",_business_level2_id:"二级业务",_business_level3_id:"三级业务"};var y=["ip","_app_id","_business_level1_id","_business_level2_id","_business_level3_id"];a.needPullFromApiCheck=function(a){return _.includes(y,a)},a.needAddNameKeys=v.metaData.needAddNameKeys,a.objectNameMap=v.metaData.objectNameMap;var z=[{key:"ip",value:1e8},{key:"app_id",value:1e6},{key:"business_id",value:1e4},{key:"src_name",value:2e6},{key:"dst_name",value:2e6},{key:"dst_interface",value:5e6},{key:"_app_id",value:1e6},{key:"_business_level1_id",value:5e3},{key:"_business_level2_id",value:5100},{key:"_business_level3_id",value:5200}];a.setList=x,a.isActiveType=function(b){return b.value===a.activeType},a.setActiveType=function(b){a.activeType=b.value},a.getAllBusiness=function(a){return l.fetchAllList(a).then(function(a){return _.union(a.data.businesses,a.data.apps)})},a.srcNameChoices=[],a.getSrcName=function(b){return p.fetchAbjectInstanceAttrList("INTERFACE","service",10,{service:b}).then(function(b){a.srcNameChoices=b.data.list})},a.dstNameChoices=[],a.getDstName=function(b){return p.fetchAbjectInstanceAttrList("INTERFACE","service",10,{service:b}).then(function(b){a.dstNameChoices=b.data.list})},a.getDstInterface=function(a){return p.fetchAbjectInstanceAttrList("INTERFACE","name",10,{name:a}).then(function(a){return p.fetchAbjectInstanceList({objectId:"INTERFACE",filter:{name:a.data.list}}).then(function(a){return a.data.list})})},a.getIpList=function(a){return p.fetchAbjectInstanceAttrList("HOST","ip",10,{ip:a}).then(function(a){return a.data.list})},a.getBusinessList=function(a,b){return p.fetchAbjectInstanceList({objectId:"BUSINESS",filter:{level:[{min:b,max:b}]},searchKey:"name",searchInput:a}).then(function(a){return a.data.list})},a.getAppList=function(a){return p.fetchAbjectInstanceList({objectId:"APP",searchKey:"name",searchInput:a}).then(function(a){return a.data.list})};var A=_.map(m,"name");a.loadUsers=function(a){var b=d.defer();return b.resolve(f("filter")(A,a)),b.promise},a.alarm_type_level1=w.alarm_type,a.alarm_type=n.data.type,a.alarm_sub_group=w.alarm_sub_group,a.alarm_sub_units=w.alarm_sub_units,a.alarm_sub_type=w.alarm_sub_type,a.group_to_alert_param=w.group_to_alert_param,a.group_to_target_param=w.group_to_target_param,a.disable_comparator_list=w.disable_comparator_list,a.alarmName=n.data.name;var B=function(){var b=_.toInteger(a.formData.alert_type);return b!==v.metaData.alert_type.process&&b!==v.metaData.alert_type.stop&&b!==v.metaData.alert_type.detect&&(!_.has(a.formData,"alert_item")||!_.includes(a.disable_comparator_list,a.formData.alert_item))};a.customObjList=[],a.customReceiverType=[];var C=function(){k.getAlarmTypeDims(a.formData.alert_sub_type).then(function(b){a.customObjList=_.uniq(b.dims),a.customReceiverType=b.receiver_group;for(var c=0;c<a.customReceiverType.length;c+=1){var d=a.customReceiverType[c];if(d.selected=!1,null!==a.modifiedId)for(var e=0;e<a.formData.receiver_group.length;e+=1){var f=a.formData.receiver_group[e];if(d.object_id===f.object_id&&d.object_attr_id===f.object_attr_id){d.selected=!0;break}}}a.formData.receiver_group=a.customReceiverType}).catch(function(){}).finally(function(){})},D=function(b){k.getComparatorList(b).then(function(b){a.comparatorList=b.data}).catch(function(){}).finally(function(){})};a.comparatorList={};var E=function(b){"100"===b?a.customAlert=!0:a.customAlert=!1};a.alert_type_change=function(b){a.formData.alert_type=b,null===a.modifiedId&&(a.formData.receiver_group=[]),D(b),E(b),null===a.modifiedId&&(c.alert_sub_type&&_.includes(Object.keys(n.data.type[a.formData.alert_type]),c.alert_sub_type)?a.formData.alert_sub_type=c.alert_sub_type:Object.keys(n.data.type[a.formData.alert_type]).indexOf(a.formData.alert_sub_type)===-1&&(a.formData.alert_sub_type=Object.keys(n.data.type[a.formData.alert_type])[0])),a.alert_sub_type_change()},a.alert_sub_type_change=function(){null===a.modifiedId&&(delete a.formData.alert_item,c.alert_item&&_.includes(Object.keys(a.alarm_sub_type[a.formData.alert_sub_type]),c.alert_item)?a.formData.alert_item=c.alert_item:a.formData.alert_item=Object.keys(a.alarm_sub_type[a.formData.alert_sub_type])[0]),"5"===a.formData.alert_type?(a.activeType="src_name",delete a.formData.business,
delete a.formData.ip):"3"===a.formData.alert_type?(a.activeType="app",delete a.formData.ip,delete a.formData.src_name,delete a.formData.dst_name,delete a.formData.dst_interface):(c.ip?a.activeType="ip":a.activeType="app",delete a.formData.src_name,delete a.formData.dst_name,delete a.formData.dst_interface),a.needComparator=B(),C()};var F;a.showDetails=function(b,c){var d=a.$new(!0);return d.formData=b,c?d.conflicted=!0:d.conflicted=!1,_.has(d.formData,"dst_interface")&&(_.isObject(d.formData.dst_interface)?d.formData.dst_interface=d.formData.dst_interface.name:d.formData.dst_interface=d.formData.dst_interface),d.needComparator=a.needComparator,d.alarm_type=n.data.type,d.alarm_sub_group=w.alarm_sub_group,d.alarm_sub_units=w.alarm_sub_units,d.alarm_sub_type=w.alarm_sub_type,d.alarmName=n.data.name,d.comparatorList=a.comparatorList,F?(F.close(),void(F=null)):void(F=o.open({templateUrl:"views/monitor/alarm/_show-rule.html",placement:"right",backdrop:!1,windowClass:"no-backdrop show-nav",scope:d}))};var G=function(b){t.fetchTool(b).then(function(b){a.toolInputList=b.inputs}).catch(function(){a.toolInputList=null}).finally(function(){})},H=function(b){u.fetchFlow(b).then(function(b){a.flowInputList=b.flowInputs?_.map(b.flowInputs,function(a){return{key:a}}):[]}).catch(function(){a.flowInputList=null}).finally(function(){})};a.paramAlready=function(a,b){return!!b&&!!_.includes(a,b.substring(2,b.length-2))};var I=function(b){b&&("tool"===a.formData.handle_method[0].type?G(b):H(b))};if(a.isAdd=!0,a.isClone=!1,a.modifiedId){a.isAdd=!1,"clone"===c.fun&&(a.isClone=!0);var J=q.data.data;if(a.formData=v.getRuleData(J),a.checkClusterType={develop:!1,test:!1,production:!1,unbind:!1},null!=a.formData.cluster_types)for(var K=0;K<a.formData.cluster_types.length;K+=1)a.formData.cluster_types[K]===v.metaData.cluster_type.develop?a.checkClusterType.develop=!0:a.formData.cluster_types[K]===v.metaData.cluster_type.test?a.checkClusterType.test=!0:a.formData.cluster_types[K]===v.metaData.cluster_type.production?a.checkClusterType.production=!0:a.formData.cluster_types[K]===v.metaData.cluster_type.unbind&&(a.checkClusterType.unbind=!0);E(a.formData.alert_type),_.has(a.formData.handle_method[0],"id")&&I(a.formData.handle_method[0].id);var L=function(){return a.modifiedId&&_.has(a.formData.business,"appId")},M=function(){return a.modifiedId&&_.has(a.formData.business,"businessId")};angular.forEach(a.setList,function(b,c){if("app"===b.value){var d={},e=!1;L()?(d.label="应用",e=!0):M()&&(d.label="业务",e=!0),d.value="app",d.group=angular.copy(b.group),e&&(a.setList[c]=d)}});var N=angular.copy(a.formData);a.changed=!1,a.$watch("formData",function(c){var d=angular.copy(c),e=angular.copy(N);angular.equals(d,e)?a.changed=!1:(b.includes("monitor.alarm.home.rule.create.strategy")?a.changed||(a.changed=!0,a.ischecked=!0):(a.changed=!0,a.ischecked=!1),F&&F.close())},!0),a.undoChange=function(){var b=angular.copy(N);a.formData=b,a.activeHandleType=b.handle_method[0].type||"tool",I(a.formData.handle_method[0].id)}}else a.formData={},a.formData.handle_method=[{}],a.formData.handle_method[0].type="tool",a.formData.handle_method[0].param_mapping={},a.formData.disable_alert=0,a.formData.level="1",a.formData.alert_way={email:!0,massage:!1},a.formData.alert_interval=60,a.formData.receiver_group=[],a.needComparator=B(),a.needComparator&&(a.formData.comparator=Object.keys(a.comparatorList)[0]),c.ip&&(a.formData.ip=angular.copy(c.ip));a.$watchCollection("checkClusterType",function(){a.formData.cluster_types=[],angular.forEach(a.checkClusterType,function(b,c){b&&("unbind"===c?a.formData.cluster_types.push(v.metaData.cluster_type.unbind):"develop"===c?a.formData.cluster_types.push(v.metaData.cluster_type.develop):"test"===c?a.formData.cluster_types.push(v.metaData.cluster_type.test):"production"===c&&a.formData.cluster_types.push(v.metaData.cluster_type.production))})}),a.modifiedId?a.alert_type_change(a.formData.alert_type):c.alert_type?a.alert_type_change(c.alert_type):a.alert_type_change(1),a.multiDisabled=function(){return a.needComparator=B(),!(a.formData.alert_type&&a.formData.alert_sub_type&&a.formData.alert_item&&(a.needComparator&&a.formData.threshold>=0&&a.formData.comparator||!a.needComparator))},a.multiOK=function(){var b=!1;return!!(a.formData.extra_receiver||a.formData.receiver_group.length>0)||b},a.showFlowTool=!1,a.showMore=function(){a.showFlowTool=!a.showFlowTool},a.strategyDisabled=function(){return a.multiDisabled()||!a.multiOK()},a.goMulti=function(){a.ischecked=!1,b.go("monitor.alarm.home.rule.create.multi")},a.goStrategy=function(){b.go("monitor.alarm.home.rule.create.strategy")},a.$watch(function(){return _.has(a.formData,"business")?a.formData.business:null},function(b){b&&(_.has(a.formData.business,"appId")||_.has(a.formData.business,"businessId")?a.businessError=!1:a.businessError=!0)}),a.$watch(function(){return _.has(a.formData,"dst_interface")?a.formData.dst_interface:null},function(b){b&&_.isObject(b)&&(a.formData.dst_name=angular.copy(a.formData.dst_interface.service))}),a.$watch(function(){return _.has(a.formData,"ip")?a.formData.ip:null},function(b){b?b.match(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/)?a.ipError=!1:a.ipError=!0:a.ipError=!1});var O=function(b){var c=0;return angular.forEach(z,function(a){b[a.key]&&(c+=a.value)}),angular.forEach(a.customObjList,function(a){var d=!1;angular.forEach(z,function(b){b.key===a&&(d=!0)}),d===!1&&b[a]&&(c+=100)}),c},P=function(a){var b=[];return a.ip&&b.push({name:"ip",type:"default",value:a.ip,translate:"IP",search_value:a.ip}),a.business&&(a.business.appId&&b.push({name:"app_id",type:"default",value:a.business.appId,translate:"应用名",search_value:a.business.name}),a.business.businessId&&b.push({name:"business_id",value:a.business.businessId,type:"default",translate:"业务名",search_value:a.business.name})),a.src_name&&b.push({name:"src_name",type:"default",value:a.src_name,translate:"主调服务名",search_value:a.src_name}),a.dst_name&&b.push({name:"dst_name",type:"default",value:a.dst_name,translate:"被调服务名",search_value:a.dst_name}),_.isObject(a.dst_interface)?b.push({name:"dst_interface",type:"default",value:a.dst_interface.name,translate:"被调接口名",search_value:a.dst_interface.name}):a.dst_interface&&b.push({name:"dst_interface",type:"default",value:a.dst_interface,translate:"被调接口名",search_value:a.dst_interface}),b},Q=function(){if(!a.modifiedId||a.modifiedId&&a.isClone)if(a.formData.rule_name=a.alarmName[a.formData.alert_item],a.customAlert)a.formData.rule_name+="-自定义",angular.forEach(a.customObjList,function(b){a.formData[b]&&!_.isUndefined(a.formData[b])&&(_.includes(a.needAddNameKeys,b)?_.has(a.formData[b],"name")&&(a.formData.rule_name+="-"+a.formData[b].name):a.formData.rule_name+="-"+a.formData[b])});else for(var b=P(a.formData),c=0;c<b.length;c+=1)a.formData.rule_name+="-"+b[c].search_value;a.formData.rule_name=a.formData.rule_name.substring(0,44)};a.disabledHandle=function(){a.formData.handle_method[0]={},a.toolInputList=[],a.flowInputList=[]},_.has(a.formData.handle_method[0],"type")?a.activeHandleType=angular.copy(a.formData.handle_method[0].type):a.activeHandleType="tool",a.handleTypeList=[{label:"工具",value:"tool"},{label:"流程",value:"flow"}],a.isActiveHandleType=function(b){return b.value===a.activeHandleType},a.setActiveHandleType=function(b){_.has(a.formData.handle_method[0],"id")?j.confirm({message:"切换类型后, 当前的数据会清空！确定切换么？",resolved:function(){a.activeHandleType=b.value,a.formData.handle_method[0]={},a.formData.handle_method[0].type=b.value,a.toolInputList=[],a.flowInputList=[]},rejected:function(){}}):(a.activeHandleType=b.value,a.formData.handle_method[0]={},a.formData.handle_method[0].type=b.value,a.toolInputList=[],a.flowInputList=[])};var R=[];a.toolIdToIcon={},a.toolIdToName={},t.fetchToolList().then(function(b){R=b,angular.forEach(R,function(b){a.toolIdToIcon[b.toolId]=b.icon,a.toolIdToName[b.toolId]=b.name})}).catch(function(){}),a.selectTool=function(){var b=a.$new(!0);b.toolId=a.formData.handle_method[0]&&a.formData.handle_method[0].id;var c=h.open({templateUrl:"views/monitor/alarm/_select-tool.html",backdrop:"static",scope:b,controller:"AlarmSelectToolCtrl",resolve:{toolList:function(){return R}}});c.result.then(function(b){a.formData.handle_method[0]={id:b.toolId},G(b.toolId)})},a.getKeys=function(a){return _.keys(a)};var S=[];a.flowIdToName={},u.fetchFlowList().then(function(b){S=b,angular.forEach(S,function(b){a.flowIdToName[b.flowId]=b.name})}).catch(function(){}),a.selectFlow=function(){var b=a.$new(!0);b.flowId=a.formData.handle_method[0]&&a.formData.handle_method[0].id;var c=h.open({templateUrl:"views/monitor/alarm/_select-flow.html",backdrop:"static",scope:b,controller:"AlarmSelectFlowCtrl",resolve:{flowList:function(){return S}}});c.result.then(function(b){a.formData.handle_method[0]={id:b.flowId},H(b.flowId)})};var T=function(a,b){"_app_id"===b&&(a[b].dId=a[b].appId),"_business_level1_id"!==b&&"_business_level2_id"!==b&&"_business_level3_id"!==b||(a[b].dId=a[b].businessId)};a.addRule=function(c){if(a.multiDisabled())b.go("monitor.alarm.home.rule.create.type"),i.warning("请先完善告警类型");else{var d={};c._id&&!a.isClone&&(d._id=c._id),d.alert_type=parseInt(c.alert_type,10),d.alert_sub_type=c.alert_sub_type,d.alert_item=c.alert_item,a.needComparator&&(d.threshold=c.threshold,d.comparator=c.comparator),c.alert_interval?d.alert_interval=c.alert_interval:d.alert_interval=60;var e=[];c.extra_receiver&&(e=_.map(c.extra_receiver,"text")),d.extra_receiver=e,d.detect_window=5,d.alert_count=3,d.rule_name=c.rule_name,d.handle_steps=c.handle_steps;var f=[];c.business&&(_.has(c.business,"appId")?(f.push(c.business.name),d.app_id=c.business.appId,d.app_name=f.join(" / "),d.business_id=null,d.business_name=null):_.has(c.business,"businessId")&&(f.push(c.business.name),d.business_id=c.business.businessId,d.business_name=f.join(" / "),d.app_id=null,d.app_name=null)),a.customAlert&&angular.forEach(a.customObjList,function(b){if(_.includes(a.needAddNameKeys,b)){if(c[b]&&!_.isUndefined(c[b])&&_.has(c[b],"instanceId")){T(c,b),d[b]=c[b].dId;var e=a.objectNameMap[b];d[e]=c[b].name}}else d[b]=c[b]}),c.src_name&&(d.src_name=c.src_name),c.dst_name&&(d.dst_name=c.dst_name),_.isObject(c.dst_interface)?d.dst_interface=c.dst_interface.name:c.dst_interface&&(d.dst_interface=c.dst_interface),d.ip=c.ip,a.customObjList.indexOf("ip")!==-1?d.cluster_types=c.cluster_types:d.cluster_types=[],d.disable_alert=c.disable_alert,d.rule_priority=O(d),d.receiver_group=[];for(var g=0;g<c.receiver_group.length;g+=1){var h=c.receiver_group[g];h.selected===!0&&d.receiver_group.push(h)}var j;j=c.alert_way.message&&c.alert_way.mail?3:c.alert_way.message?2:c.alert_way.email?1:0,d.alert_way=j,d.handle_method=c.handle_method,_.has(d.handle_method[0],"id")?(_.isArray(d.handle_method[0].target_ip)||(d.handle_method[0].target_ip=d.handle_method[0].target_ip?_.map(d.handle_method[0].target_ip.split(/[,，]+/),function(a){return a}):[]),d.handle_method[0].type=a.activeHandleType,d.handle_method[0].param_mapping=_.toPlainObject(c.handle_method[0].param_mapping)):d.handle_method=[],d.level=c.level,k.createRule(d).then(function(){i.success(a.isAdd?"添加成功":a.isClone?"克隆成功":"修改成功"),b.go("monitor.alarm.home.rule.list",{sortBy:"mtime",sortOrder:"desc"})}).catch(function(a){r(a,"告警策略添加")}).finally(function(){})}},a.ischecked=!1,a.checking=!1,a.conflictCheck=function(){Q(),a.conflictData={},a.checking=!0;var d=angular.copy(a.formData);if(d.alert_sub_type&&d.alert_item){var e={};e.alert_type=parseInt(d.alert_type,10),e.alert_sub_type=d.alert_sub_type,e.alert_item=d.alert_item;var f=[];d.business&&(_.has(d.business,"appId")?(f.push(d.business.name),e.app_id=d.business.appId,e.business_id=null):_.has(d.business,"businessId")&&(f.push(d.business.name),e.business_id=d.business.businessId,e.app_id=null)),a.customAlert&&angular.forEach(a.customObjList,function(b){if(_.includes(a.needAddNameKeys,b)){if(d[b]){e[b]=d[b].instanceId;var c=a.objectNameMap[b];e[c]=d[b].name}}else e[b]=d[b]}),d.ip&&(e.ip=d.ip),e.src_name=d.src_name,e.dst_name=d.dst_name,_.isObject(d.dst_interface)?e.dst_interface=d.dst_interface.name:e.dst_interface=d.dst_interface,e.rule_priority=O(e),k.getAlarmRuleList(e,!0).then(function(d){d.data.total>0?c._id!==d.data.data[0]._id||a.isClone?(a.conflictId=d.data.data[0]._id,a.conflictData=d.data.data[0],b.go("monitor.alarm.home.rule.create.multi"),a.showDetails(v.getRuleData(d.data.data[0]),!0)):a.conflictId=!1:(a.conflictId=!1,a.conflictData={},a.showDetails(angular.copy(a.formData))),a.conflictId||b.go("monitor.alarm.home.rule.create.strategy")}).catch(function(){}).finally(function(){a.ischecked=!0,a.checking=!1})}else i.warning("请先选择告警类型")}}]).controller("AlarmSelectToolCtrl",["$scope","$timeout","$uibModalInstance","toolList",function(a,b,c,d){function e(a,b){return{category:b,list:a}}function f(a){return a.category.toLowerCase()}function g(a){return a.name.toLowerCase()}d=_.sortBy(d,g);var h=_.chain(d).groupBy("category").map(e).sortBy(f).value();a.toolListGroup=h,a.toolForm={toolId:a.toolId},a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.toolListGroup=_.chain(d).filter(function(a){return a.name.toLowerCase().indexOf(b)!==-1}).groupBy("category").map(e).sortBy(f).value()):void(a.toolListGroup=h)},a.selectTool=function(a){c.close(a)},b(function(){$(".selected","#select-flow-tool").scrollIntoView(!1)})}]).controller("AlarmSelectFlowCtrl",["$scope","$timeout","$uibModalInstance","flowList",function(a,b,c,d){a.flowList=d,a.flowForm={flowId:a.flowId},a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.flowList=_.chain(d).filter(function(a){return a.name.toLowerCase().indexOf(b)!==-1}).value()):void(a.flowList=d)},a.selectFlow=function(a){c.close(a)},b(function(){$(".selected","#select-flow").scrollIntoView(!1)})}]),angular.module("monitor.alarm.home.rule.detail",[]).config(["$stateProvider",function(a){a.state("monitor.alarm.home.rule.detail",{url:"/detail/:id",templateUrl:"views/monitor/alarm/rule/detail.html",controller:"MonitorAlarmRuleDetailCtrl",resolve:{alarmTypeList:["Monitor",function(a){return a.getAlarmTypeList()}],comparatorList:["Monitor",function(a){return a.getComparatorList()}],detailRule:["Monitor","$stateParams",function(a,b){return b.id?a.getRuleOne(b.id).then(function(a){if(404===a.code)throw new Error("该策略不存在");if(0!==a.code)throw new Error("查询策略失败");return a}):null}],deps:["depends",function(a){return a("components/editor")}]}})}]).controller("MonitorAlarmRuleDetailCtrl",["$scope","$state","$stateParams","$aside","Dialog","toastr","Monitor","alarmTypeList","comparatorList","detailRule","BLACK_ALERT_TYPE","ALARMICON","Flows","Tools","handleAjaxError","AlarmRuleCommonFun",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q="javascript",r={lineWrapping:!0,lineNumbers:!0,viewportMargin:1/0,readOnly:!0,mode:q};a.options=r,a.cmLoaded=function(a){CodeMirror.autoLoadMode(a,q)},a.alarmIcon=function(a){return l[a]||"fa-flag"};var s=p.explainAlarmType(h);a.comparatorList=i.data,a.alarm_type=h.data.type,a.alarmName=h.data.name,a.formData=j.data,a.formData.alert_type_detail=_.find(h.data,function(b){return b.id===a.formData.alert_type}),a.formData.alert_sub_type_detail=_.find(a.formData.alert_type_detail.alert_sub_type,function(b){return b.id===a.formData.alert_sub_type}),a.formData.alert_item_detail=_.find(a.formData.alert_sub_type_detail.alert_item,function(b){return b.id===a.formData.alert_item}),a.formData.alert_way={email:1===a.formData.alert_way||3===a.formData.alert_way,message:2===a.formData.alert_way||3===a.formData.alert_way},_.has(a.formData,"dst_interface")&&(_.isObject(a.formData.dst_interface)?a.formData.dst_interface=a.formData.dst_interface.name:a.formData.dst_interface=a.formData.dst_interface),a.alarm_type=h.data.type,a.comparatorList=i.data,a.alarm_sub_type=s.alarm_sub_type,a.alarm_sub_units=s.alarm_sub_units,a.alarm_sub_group=s.alarm_sub_group,a.disable_comparator_list=s.disable_comparator_list,a.alarmName=h.data.name,a.black_alert_type=k,a.alarmObject=_.isEmpty(a.formData.alert_dims)?"全部":_.map(a.formData.alert_dims,"display_value").join(", "),a.statusMap={0:"告警已发送",1:"告警被收敛",2:"告警恢复",3:"告警被屏蔽"};var t=function(){return a.formData.alert_type!==p.metaData.alert_type.process&&a.formData.alert_type!==p.metaData.alert_type.stop&&a.formData.alert_type!==p.metaData.alert_type.detect&&(!_.has(a.formData,"alert_item")||!_.includes(a.disable_comparator_list,a.formData.alert_item))};a.needComparator=t();var u=function(b){n.fetchTool(b).then(function(b){a.toolData=b}).catch(function(){a.toolData=null}).finally(function(){})},v=function(b){m.fetchFlow(b).then(function(b){a.flowData=b}).catch(function(){a.flowData=null}).finally(function(){})};if(_.has(j.data,"handle_method")){var w;w=_.has(a.formData.handle_method[0],"id")?a.formData.handle_method[0].id:null,w&&("tool"===a.formData.handle_method[0].type?(a.isTool=!0,u(w)):(a.isFlow=!0,v(w)))}g.getAlarmList({rule_id:j.data.id,st:"-3d",pageSize:30}).then(function(b){a.alarmList=b.data,a.todayAll=+b.total}).catch(function(){}).finally(function(){}),a.deleteRule=function(a){e.confirm({message:"确定删除该条策略吗?",isDelete:!0,resolved:function(){g.deleteAlarmRule(a).then(function(){b.go("monitor.alarm.home.rule.list",{sortBy:"mtime",sortOrder:"asc"},{reload:!0}),f.success("策略删除成功")}).catch(function(){}).finally(function(){})}})},a.storing=!1,a.ruleEnable=function(c){a.storing=!0,c.disable_alert=Number(!c.disable_alert);var d={rule_name:c.rule_name,alert_type:c.alert_type,alert_sub_type:c.alert_sub_type,alert_item:c.alert_item,threshold:c.threshold,comparator:c.comparator,receiver_group:c.receiver_group,extra_receiver:c.extra_receiver,disable_alert:c.disable_alert,alert_dims:c.alert_dims,alert_count:c.alert_count,detect_window:c.detect_window,alert_interval:c.alert_interval};g.modifyRule(c.id,d).then(function(){c.disable_alert?f.success("告警关闭成功"):f.success("告警启用成功"),a.storing=!1,b.go("monitor.alarm.home.rule.list",{sortBy:"mtime",sortOrder:"asc"})}).catch(function(b){o(b),c.disable_alert=!c.disable_alert,a.storing=!1})}}]),angular.module("monitor.log.service",[]).factory("MonitorLog",["RequestWrapper",function(a){return{search:function(b){return a.object({method:"GET",url:"/api/log/search",params:b})},listType:function(){return a.object({method:"GET",url:"/api/log/list-type"})},executeLogSearch:function(b){return a.object({method:"PUT",url:"/api/log/log_search",data:b})}}}]),angular.module("monitor.log",["monitor.log.service"]).config(["$stateProvider",function(a){a.state("monitor.log",{abstract:!0,url:"/log",template:"<ui-view/>"}).state("monitor.log.search",{url:"/search?q&page&pageSize&type&ip&path&report_time__lt&report_time__gt&desc",reloadOnSearch:!1,templateUrl:"views/monitor/log/search.html",controller:"MonitorLogSearchCtrl",resolve:{}})}]).controller("MonitorLogSearchCtrl",["$scope","$timeout","$state","$stateParams","USERNAME","$filter","toastr","MonitorLog","DeviceService","Utils","handleAjaxError",function(a,b,c,d,e,f,g,h,i,j,k){a.onlyMyOwn=function(a){return _.some(a.owner,{name:e})};var l=a.executionData={execUser:e,inputList:{log_file_name:"",keyword:""}};a.selectDevices=function(a){l.agents=_.uniq(_.map(a,"ip")).join(", ")},a.lackIp=!0,a.lackFilePath=!0,a.$watch("executionData.agents",function(){var b=j.matchIps(l.agents);l.selectedIps=b,a.agentsCount=b?b.length:0,a.agentsCount&&(a.lackIp=!1)}),a.filePathChange=function(){""!==a.executionData.inputList.log_file_name&&(a.lackFilePath=!1)},a.userSettings={autoBreakLine:!0,autoScrollLogs:!0},a.logResult=[],a.notResult="",a.searchLogs=function(){var b=j.matchIps(l.agents);if(b){a.executing=!0;var c=l.execUser;h.executeLogSearch({agents:b,inputs:l.inputList,execUser:c}).then(function(b){a.logResult=b.data,a.executing=!1,a.notResult=a.executionData.inputList.keyword.length?"目标文件：无符合过滤关键字的内容":"目标文件：为空"}).catch(function(b){a.executing=!1,k(b)})}},a.maxLinesTips=function(a){return!!(a.content&&a.content.split("\n").length>=a.limit_num)}}]),angular.module("admin.route",[]).config(["$stateProvider",function(a){a.state("admin",{abstract:!0,url:"/admin",templateUrl:"views/admin/graphs.html",controller:"AdminAbstractCtrl",resolve:{}}).state("admin.ens",{url:"/ens",templateUrl:"views/admin/ens.html",controller:"AdminEnsCtrl",resolve:{ensList:["Admin",function(a){return a.listEns()}]}}).state("admin.agent",{url:"/agent?q&page&page_size&justAbnormal",templateUrl:"views/admin/agent.html",controller:"AdminAgentCtrl",reloadOnSearch:!1,resolve:{agentList:["Admin",function(a){return a.listAgent()}]}})}]),angular.module("admin.ctrl",[]).controller("AdminAbstractCtrl",["$scope","$state","$stateParams",function(a,b,c){a.navEnsActive=function(){return b.includes("admin.ens")},a.navAgentActive=function(){return b.includes("admin.agent")}}]).controller("AdminEnsCtrl",["$scope","$state","$stateParams","toastr","Admin","ensList",function(a,b,c,d,e,f){a.ensList=f}]).controller("AdminAgentCtrl",["$scope","$state","$stateParams","$filter","toastr","Admin","agentList","TIME_OFFSET",function(a,b,c,d,e,f,g,h){a.agentList=g,a.pageInfo={total:a.agentList.total,page:c.page||1,pageSize:_.toNumber(c.page_size||50),pageSizes:[50,100,200,500]},a.q=c.q||null,a.justAbnormal="true"===c.justAbnormal,a.hbThreshold=90,a.diffThreshold=15,a.isAlive=function(b){return Date.now()+h-1e3*b<1e3*a.hbThreshold},a.timeDiff=function(b){if(b.hb_server_time&&b.hb_agent_time){var c=Math.abs(b.hb_server_time-b.hb_agent_time);return c>a.diffThreshold?"异常":"正常"}return"-"},_.forEach(a.agentList.data,function(b){b.isAlive=a.isAlive(b.hb_server_time)?"在线":"异常",b.timeDiff=a.isAlive(b.hb_server_time)?a.timeDiff(b):"-",_.forEach(b.status,function(b){b.isAlive=a.isAlive(b.hb_server_time)?"在线":"异常"})}),a.humanizeTime=function(a){if(!a||""===a)return"-";var b=moment.unix(a);return b.isValid()?b.fromNow():"-"},a.aliveTips=function(b){return a.hbThreshold+"s内没有心跳，最近心跳时间为 "+a.humanizeTime(b.hb_server_time)},a.timeDiffTips=function(a){var b=a.hb_agent_time>a.hb_server_time?"快":"慢",c=moment.unix(a.hb_agent_time).to(moment.unix(a.hb_server_time));return c=c.substr(0,c.length-1),"服务器时间"+b+" "+c+"，请做ntp同步"},a.search=function(c){c&&(a.pageInfo.page=c),b.go(b.current.name,{q:a.q,page:a.pageInfo.page,page_size:a.pageInfo.pageSize,justAbnormal:a.justAbnormal}),a.searchResult=d("filter")(a.agentList.data,function(b){if(a.justAbnormal&&"在线"===b.isAlive&&"异常"!==b.timeDiff)return!1;if(!a.q)return!0;var c=a.q.toLowerCase();return b.agent.toLowerCase().indexOf(c)!==-1||(b.version.toLowerCase().indexOf(c)!==-1||b.isAlive.indexOf(c)!==-1)}),a.pageInfo.total=a.searchResult.length},a.search(a.pageInfo.page)}]),angular.module("admin.service",[]).factory("Admin",["RequestWrapper",function(a){return{listEns:function(b){return a.object({method:"GET",url:"/api/admin/list-ens",params:b})},listAgent:function(b){return a.object({method:"GET",url:"/api/admin/list-agent",params:b})}}}]),angular.module("task.service",[]).factory("Task",["RequestWrapper",function(a){return{fetchTaskList:function(b,c){return a.object({method:"GET",url:"/api/task",params:b,timeout:c})},fetchTaskDetail:function(b,c){return a.object({method:"GET",url:"/api/task/"+b,ignoreLoadingBar:c})}}}]),angular.module("tasks.ctrl",[]).controller("taskListCtrl",["$scope","$state","$stateParams","taskListData","appData","flowData",function(a,b,c,d,e,f){function g(a){var b={};return angular.forEach(a,function(a,c){b[c]=i[c]===a?null:a}),b}a.appData=e,a.flowData=f;var h={deploy:"应用管理",tool:"作业平台",flow:"调度平台",pipeline:"交付流水线",multiTask:"任务编排",cloudHost:"云主机任务"};a.systemList=[{value:null,text:"所有平台"},{value:"deploy",route:"task.deploy",text:"应用管理"},{value:"tool",route:"task.tools",text:"作业平台"},{value:"flow",route:"task.flows",text:"调度平台"},{value:"pipeline",route:"task.pipelines",text:"交付流水线"},{value:"multiTask",route:"task.batchDeploy",text:"任务编排"}],a.getSystemName=function(a){return a?h[a]:"所有平台"},a.getHrefOfTask=function(c){var d=angular.copy(a.systemList);d.push({value:"cloudHost",route:"task.cloudHost",text:"云主机任务"});var e=_.find(d,{value:c.system});return"task.deploy"===e.route&&"instance.deploy"===c.topic&&(e.route="task.deployInstall"),e?b.href(e.route,c):null},a.rangeList=[{value:"today",text:"今天"},{value:"yesterday",text:"昨天"},{value:"week",text:"近7天"},{value:"month",text:"近30天"}];var i={range:"week",page:1,user:"myself",appId:null,system:null},j=_.defaults({},c,i);a.filters=j,a.itemsPerPage=d.pageSize,a.totalItems=d.total,a.taskList=d.list,a.picker={date:null,month:null,now:"date",dateOptions:{maxDate:new Date},monthOptions:{maxDate:new Date,minMode:"month"}},a.pickDate=function(){a.picker.month=null,a.picker.date=null,a.picker.now="date",a.openDatepicker()},a.pickMonth=function(){a.picker.month=null,a.picker.date=null,a.picker.now="month",a.openMonthpicker()},a.datepickerStatus={open:!1},a.openDatepicker=function(){a.datepickerStatus.open=!0},a.monthpickerStatus={open:!1},a.openMonthpicker=function(){a.monthpickerStatus.open=!0},a.$watch("picker.date",function(c,d){a.picker.date&&(j.range=moment(a.picker.date).format("YYYY-MM-DD"),+c!==+d&&(j.page=null),b.go(b.current.name,g(j)))}),a.$watch("picker.month",function(c,d){a.picker.month&&(j.range=moment(a.picker.month).format("YYYY-MM"),+c!==+d&&(j.page=null),b.go(b.current.name,g(j)))}),/^\d{4}-\d\d-\d\d$/.test(j.range)?a.picker.date=moment(j.range).toDate():/^\d{4}-\d\d$/.test(j.range)&&(a.picker.month=moment(j.range+"-01").toDate(),a.picker.now="month"),angular.forEach(a.taskList,function(a){a.ipCount=a.ipList?a.ipList.split(";").length:0,_.includes(a.topic,"CloudHost")&&(a.system="cloudHost","getCloudHost"===a.topic?a.target_name="购买云主机":"delCloudHost"===a.topic&&(a.target_name="退还云主机")),"instance.deploy"===a.topic&&(a.event="install")}),a.filtersChanged=function(){j.page=1,b.go(b.current.name,g(j))},a.pageChange=function(){b.go(b.current.name,g(j))}}]).controller("taskDetailCtrl",["$scope","$state","$stateParams","$timeout","Task","handleAjaxError","taskData",function(a,b,c,d,e,f,g){function h(b){a.taskResult=b.result,a.taskDetail=b.detail,"ok"!==b.result.status&&"failed"!==b.result.status&&i()}function i(){p=d(j,l)}function j(){p=null,e.fetchTaskDetail(k,!0).then(h).catch(function(a){q&&q.dismiss(),q=f(a,"查询任务结果"),0!==a.status&&403!==a.status&&i()})}var k=c.event_id,l=5e3,m=g.result.param||{};if(a.isConfigPkg=2===m.type,a.isPackage=!a.isConfigPkg,"install"===g.result.opType){var n={withConfig:2===m.type||m.configVersionId};a.installData=n,n.packageVersionName=m.versionName,n.configVersionName=n.withConfig&&(2===m.type?m.versionName:m.configVersionName),n.packageParams={packageId:g.result.packageId,tag:m.versionId},n.configParams=n.withConfig&&{packageId:g.result.packageId,clusterId:m.clusterId,tag:2===m.type?m.versionId:m.configVersionId}}else if("update"===g.result.opType){var o={withPackage:1===m.type,withConfig:2===m.type||m.configVersionIdTo};a.updateData=o,o.packageVersionNameFrom=m.versionNameFrom,o.packageVersionNameTo=m.versionNameTo,o.packageVersionIdFrom=m.versionIdFrom,o.packageVersionIdTo=m.versionIdTo,o.configVersionNameFrom=o.withConfig&&(2===m.type?m.versionNameFrom:m.configVersionNameFrom),o.configVersionNameTo=o.withConfig&&(2===m.type?m.versionNameTo:m.configVersionNameTo),o.configVersionIdFrom=o.withConfig&&(2===m.type?m.versionIdFrom:m.configVersionIdFrom),o.configVersionIdTo=o.withConfig&&(2===m.type?m.versionIdTo:m.configVersionIdTo),o.packageParams={packageId:g.result.packageId,tag:m.versionIdTo},o.configParams=o.withConfig&&{packageId:g.result.packageId,clusterId:m.clusterId,tag:2===m.type?m.versionIdTo:m.configVersionIdTo}}a.toggleParam=function(){a.paramShown=!a.paramShown},h(g);var p,q;a.$on("$destroy",function(){p&&d.cancel(p)})}]).controller("DeployTaskCtrl",["$scope","$state","$timeout","taskData","$window","DeployService","handleAjaxError",function(a,b,c,d,e,f,g){function h(b){var c=b.status;_.includes(i,c)||f.getDeployTask(b.taskId).then(function(b){var c=b.status;a.taskResult=b,_.includes(i,c)||h(a.taskResult)}).catch(g)}_.forEach(d.targetList,function(a){a.packageStatus=_.filter(a.packageStatus,function(a){return a.param.versionId!==a.param.preVersionId}),"failed"===a.status&&_.forEach(a.packageStatus,function(a){"wait"===a.status&&(a.status="unreachable")})}),a.taskResult=d;var i=["ok","failed"];_.includes(i,a.taskResult.status)||h(a.taskResult),a.showMsg=function(a,b){var c=e.open(""),d=c.document;d.open(),d.write("<pre>"+_.escape(a||b||"")+"</pre>"),d.close()}}]).controller("PipelineTaskCtrl",["$scope","$state","$timeout","$aside","handleAjaxError","toastr","Dialog","PipelineService","Flows","taskData","PIPELINE_STAGE_NAME_LIST",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){q=c(function(){q=null,m(a)},2e3)}function m(a){p&&(p.dismiss(),p=null),h.fetchPipelineTaskResult(a,null,{track:!1}).then(n).catch(function(a){p=e(a,"查询交付流水线执行结果")})}function n(b){a.taskData||(a.taskData={});var c=_.merge(a.taskData,b),d="executing"===c.totalStatus;if((d||"paused"===c.totalStatus)&&(c.endTime=null),d)l(c.taskId);else if(r&&r!==c.totalStatus)switch(c.totalStatus){case"success":f.success("交付流水线执行成功");break;case"failed":f.error("交付流水线执行失败")}r=c.totalStatus}function o(c,d){var f=_.find(a.taskData.stepList,function(a){return"failed"===a.status});f?(c&&c(),a.retrying=!0,i.retryStep(a.taskData.taskId,f.stepId).then(function(){b.reload()}).catch(function(b){d&&d(),a.retrying=!1,e(b,"重试交付流水线任务")})):g.alert({type:"warning",message:"没有失败的步骤！"})}var p,q,r,s;a.stageNameList=k,a.stepAvailable=function(a){return a.execId},a.continueExecute=function(b){a.processing||(a.processing=!0,h.continueExecute(j.taskId,b.stepList[0].stepId).then(function(){a.processing=!1,b.status="executing",q&&c.cancel(q),m(j.taskId)}).catch(function(b){a.processing=!1,e(b,"继续执行")}))},a.skipExecute=function(b){if(!a.processing){a.processing=!0;var d=_.map(b.stepList,"stepId"),f=d.shift();h.skipExecute(j.taskId,f,d).then(function(){a.processing=!1,b.status="skipped",q&&c.cancel(q),m(j.taskId)}).catch(function(b){a.processing=!1,e(b,"跳过")})}},a.retryStep=function(a,b){g.confirm({type:"warning",message:"确定要从失败步骤开始重试吗？",resolved:function(){o(a,b)}})},a.showStepDetail=function(b){s&&s.dismiss(),a.activeStep=b;var c=a.$new(!0);c.step=b,c.showRetryStepBtn=!0,c.retryStep=function(){a.retryStep(function(){c.retrying=!0},function(){c.retrying=!1})},s=d.open({templateUrl:"views/flows/_task-step-detail.html",scope:c,size:"lg",controller:"FLowsTaskStepDetailCtrl"}),s.result.finally(function(){a.activeStep=null})},n(j),a.$on("$destroy",function(){q&&c.cancel(q)})}]),angular.module("tasks.route",["tools.service","tasks.service","apps.services","apps.deploy","apps.pipeline.services","cmdb.devices.cloudHost","tools.ctrl","packages.services"]).config(["$stateProvider",function(a){a.state("task",{url:"/task",abstract:!0,templateUrl:"views/tasks/tasks.html"}).state("task.flows",{url:"/flows/{event_id:\\w+}",templateUrl:"views/tasks/flow_task.html",controller:"FlowsTaskCtrl",resolve:{taskResult:["$stateParams","Flows",function(a,b){return b.getTaskResult(a.event_id)}],deps:["depends",function(a){return a("components/flowchart")}]}}).state("task.tools",{url:"/tools/{event_id:\\w+}",templateUrl:"views/tasks/tool_exec.html",controller:"ToolExecutionCtrl",resolve:{executionResult:["$stateParams","Tools",function(a,b){return b.getExecutionResult(a.event_id,{toolData:1})}]}}).state("task.deploy",{url:"/deploy/{event_id:\\w+}",templateUrl:"views/tasks/deploy_task.html",controller:"taskDetailCtrl",resolve:{taskData:["$stateParams","Task",function(a,b){return b.fetchTaskDetail(a.event_id)}]}}).state("task.deployInstall",{url:"/deployInstall/{event_id:\\w+}",templateUrl:"views/tasks/deploy_task_install.html",controller:"DeployTaskCtrl",resolve:{taskData:["$stateParams","DeployService",function(a,b){return b.getDeployTask(a.event_id)}]}}).state("task.pipelines",{url:"/pipeline/{event_id:\\w+}",templateUrl:"views/tasks/pipeline_task.html",controller:"PipelineTaskCtrl",resolve:{taskData:["$stateParams","PipelineService",function(a,b){
return b.fetchPipelineTaskResult(a.event_id,{app:1,package:1})}]}}).state("task.batchDeploy",{url:"/batch-deploy/{event_id:\\w+}",templateUrl:"views/tasks/batch_deploy_task.html",controller:"AppsDeployTaskCtrl",resolve:{taskData:["$stateParams","DeployService",function(a,b){return b.getBatchDeployTask(a.event_id)}]}}).state("task.cloudHost",{url:"/cloud-host/{event_id:\\w+}",templateUrl:"views/tasks/cloud_host_task.html",controller:"AppsDeployTaskCtrl",resolve:{taskData:["$stateParams","DeployService",function(a,b){return b.getBatchDeployTask(a.event_id,{cloud_host:!0})}]}}).state("tasksList",{url:"/tasks?system&appId&flowId&range&user&page",templateUrl:"views/tasks/list.html",controller:"taskListCtrl",params:{range:{value:"week",squash:!0},page:{type:"int",value:1,squash:!0},user:{value:"myself",squash:!0},appId:{value:"",squash:!0},system:{value:"",squash:!0}},resolve:{taskListData:["$stateParams","Log",function(a,b){return b.fetchLogList(angular.copy(a))}],appData:["AppService","$stateParams",function(a,b){return b.appId?a.fetchApp(b.appId):null}],flowData:["Flows","$stateParams",function(a,b){return b.flowId?a.fetchFlow(b.flowId):null}]}})}]),angular.module("tasks.service",[]).factory("Task",["RequestWrapper",function(a){return{fetchTaskDetail:function(b,c){return a.object({method:"GET",url:"/api/task/"+b,ignoreLoadingBar:c})}}}]).factory("Log",["RequestWrapper",function(a){return{fetchLogList:function(b,c,d){var e={method:"GET",url:"/api/log",params:b,ignoreLoadingBar:d};return void 0!==c&&(e.timeout=c),a.object(e)},fetchAllLogs:function(b,c,d){var e={method:"GET",url:"/api/log-all",params:b,ignoreLoadingBar:d};return void 0!==c&&(e.timeout=c),a.array(e)},fetchUncompletedBatchDeployTaskCount:function(){return a.object({method:"GET",url:"/api/log/batch-deploy/uncompleted/count",ignoreLoadingBar:!0})},fetchUncompletedBatchDeployTaskList:function(){return a.array({method:"GET",url:"/api/log/batch-deploy/uncompleted"})}}}]),angular.module("schedulers.route",["url.matcher"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("/schedulers/","/schedulers"),a.state("schedulers",{abstract:!0,url:"/schedulers",templateUrl:"views/delivery/delivery.html",controller:"DeliveryAbstractCtrl"}).state("schedulers.index",{url:"?page",templateUrl:"views/schedulers/graphs.html",controller:"SchedulersIndexCtrl",resolve:{schedulersData:["$stateParams","Schedulers",function(a,b){return b.getSchedulersList(angular.extend({},{page:1,page_size:15,__sortby__:"-create_time"},a))}]}}).state("schedulers.create",{url:"/create",templateUrl:"views/schedulers/create.html",controller:"SchedulersCreateCtrl",resolve:{toolList:["Tools",function(a){return a.fetchToolList({detail:"true"})}],scheduler:[function(){return{}}]}}).state("schedulers.scheduler",{abstract:!0,url:"/{id:\\w+}",template:"<ui-view />"}).state("schedulers.scheduler.index",{url:"",templateUrl:"/views/schedulers/detail.html",controller:"SchedulersDetailCtrl",resolve:{schedulerData:["$stateParams","Schedulers",function(a,b){return b.getScheduler(a.id)}]}}).state("schedulers.scheduler.edit",{url:"/edit",templateUrl:"views/schedulers/create.html",controller:"SchedulersCreateCtrl",resolve:{toolList:["Tools",function(a){return a.fetchToolList({detail:"true"})}],scheduler:["$stateParams","Schedulers",function(a,b){return b.getScheduler(a.id)}]}})}]),angular.module("schedulers.ctrl",[]).controller("SchedulersIndexCtrl",["$scope","$timeout","$state","$stateParams","toastr","handleAjaxError","$uibModal","schedulersData","Schedulers",function(a,b,c,d,e,f,g,h,i){var j=function(a,b,c){return _.orderBy(_.map(a,function(a){return a.enable=1!==a.disable,a.switchinging=!1,a}),b,c)};a.schedulersList=j(h.data),a.filters={q:""},a.pagingConf={total:h.total,current:d.page||1,page_size:d.page_size||15},a.pagingConf.change=function(){c.go("schedulers.index",{page:a.pagingConf.current,page_size:a.pagingConf.page_size})},a.search=function(){},a.schedulerEnable=function(a){"once"===a.task_type&&a.disable||(a.switching=!0,a.disable=a.enable?0:1,i.updateScheduler(a.id,{disable:a.disable}).then(function(b){e.success(a.name+" 已"+(a.enable?"启用":"停止!"))}).catch(function(b){f(b),a.enable=!a.enable}).finally(function(){a.switching=!1}))},a.deleteScheduler=function(b){var d=g.open({templateUrl:"views/schedulers/_delete-scheduler.html",controller:"SchedulersDeleteCtrl",resolve:{scheduler:b}});d.result.then(function(d){e.success(b.name+" 删除成功!"),i.getSchedulersList().then(function(b){c.reload("schedulers.index"),a.schedulersList=j(b)}).catch(f)},function(){})},a.showIPs=function(a){g.open({templateUrl:"views/schedulers/_agents-modal.html",controller:"SchedulersShowIPsCtrl",windowClass:"modal__limit-height",resolve:{agents:function(){return a}}})}}]).controller("SchedulersDeleteCtrl",["$scope","$uibModalInstance","handleAjaxError","toastr","Schedulers","scheduler",function(a,b,c,d,e,f){a.scheduler=f,a.busy=!1,a.delete=function(){a.busy=!0,e.deleteScheduler(a.scheduler.id).then(function(a){b.close(a)}).catch(function(a){c(a)}).finally(function(){a.busy=!1})},a.cancel=function(){b.dismiss()}}]).controller("SchedulersCreateCtrl",["$scope","$timeout","$state","Utils","handleAjaxError","toastr","$uibModal","toolList","scheduler","Schedulers",function(a,b,c,d,e,f,g,h,i,j){a.isCreate=!0,i.id&&(a.isCreate=!1),a.schedulerData={mode:"crontab",isAdvanced:!1,name:"",toolData:{},agents:"",execUser:"root"};var k=function(a,b){var c;if(b){c="^(\\*(\\/%n)?|%s-%s(\\/%n)?|%s(,%s)*)$";var d=c.replace(/%n/g,"("+b+")");return new RegExp(d.replace(/%s/g,"("+a+")"))}return c="^(\\*(\\/%s)?|%s-%s(\\/%s)?|%s(,%s)*)$",new RegExp(c.replace(/%s/g,"("+a+")"))};if(a.Regex={crontab:{minute:k("[0-5]?\\d"),hour:k("[01]?\\d|2[0-3]"),date:k("0?[1-9]|[12]\\d|3[01]"),month:k("[1-9]|1[012]|[jJ]an|[fF]eb|[mM]ar|[aA]pr|[mM]ay|[jJ]un|[jJ]ul|[aA]ug|[sS]ep|[oO]ct|[nN]ov|[dD]ec","[1-9]|1[012]"),dow:k("[0-6]|[mM]on|[tT]ue|[wW]ed|[tT]hu|[fF]ri|[sS]at|[sS]un","[0-6]")}},a.crontabTimeObj={minute:"*",hour:"*",date:"*",month:"*",dow:"*"},a.normalTime=new Date,a.crontabTime="",!a.isCreate)if(a.schedulerData=angular.extend({},a.schedulerData,{mode:i.task_type,name:i.name,toolData:_.find(h,{toolId:i.cmd_config.params.toolId}),agents:i.cmd_config.params.agents?i.cmd_config.params.agents.join(", "):[],execUser:i.cmd_config.params.execUser}),a.schedulerData.toolData.inputList=_.map(a.schedulerData.toolData.inputs,function(a){return{key:a.name,value:i.cmd_config.params.inputs[a.name]}}),"crontab"===i.task_type){var l=i.task_scheduler.split(" ");a.crontabTimeObj={minute:l[0],hour:l[1],date:l[2],month:l[3],dow:l[4]}}else a.normalTime=new Date(i.task_scheduler);a.schedulerModeChange=function(b){a.schedulerData.mode=b,"once"===b?a.schedulerData.time=a.normalTime:a.schedulerData.time=a.crontabTime},a.$watchCollection("crontabTimeObj",function(b,c){a.crontabTime=_.values(b).join(" ").trim()}),a.timeChange=function(b){angular.equals(a.schedulerData.mode,"once")?a.normalTime=b:a.crontabTime=_.values(a.crontabTimeObj).join(" ").trim()},a.selectTool=function(){var b=a.$new(!0);b.toolId=a.schedulerData.toolData&&a.schedulerData.toolData.toolId;var c=g.open({templateUrl:"views/schedulers/_select-tool.html",backdrop:"static",scope:b,controller:"SchedulersSelectToolCtrl",resolve:{toolList:function(){return h}}});c.result.then(function(b){a.schedulerData.toolData&&a.schedulerData.toolData.name;a.schedulerData.toolData=b,a.schedulerData.toolData.inputList=_.map(b.inputs,function(a){return{key:a.name,value:""}}),a.schedulerData.execUser="powershell"===b.type?"Administrator":b.defaultExecUser,a.schedulerData.name=b.name})},a.selectDevices=function(b){a.schedulerData.agents=_.map(b,"ip").join(", ")},a.validateExecUser=function(b,c){a.formScheduler.execUser.$valid&&(c.whiteList&&c.whiteList.length?(b=b.trim(),c.whiteList.indexOf(b)<0&&a.formScheduler.execUser.$setValidity("pattern",!1)):c.blackList&&c.blackList.length&&c.blackList.indexOf(b)>-1&&a.formScheduler.execUser.$setValidity("pattern",!1))},a.$watch("schedulerData.agents",function(){var b=d.matchIps(a.schedulerData.agents);a.schedulerData.selectedIps=b,a.agentsCount=b?b.length:0}),a.$watchGroup(["normalTime","crontabTime"],function(b,c,d){"once"===a.schedulerData.mode?a.schedulerData.time=b[0]:a.schedulerData.time=b[1]}),a.isModified=function(){var b=angular.copy(a.schedulerData),c={};c.name=b.name,c.tool_id=b.toolData.toolId,c.agents=d.matchIps(b.agents),c.inputs={},_.forEach(b.toolData.inputList,function(a){c.inputs[a.key]=a.value}),c.execUser=b.execUser,"once"===b.mode?(c.task_type="once",c.task_scheduler=moment(b.time).format("YYYY-MM-DD HH:mm:ss")):(c.task_type="crontab",c.task_scheduler=b.time),delete c.src_id;var e={agents:i.cmd_config.params.agents,execUser:i.cmd_config.params.execUser,inputs:_.isArray(i.cmd_config.params.inputs)&&0===i.cmd_config.params.inputs.length?{}:i.cmd_config.params.inputs,name:i.name,task_scheduler:i.task_scheduler,task_type:i.task_type,tool_id:i.cmd_config.params.toolId};return!_.isEqual(e,c)},a.storing=!1,a.store=function(){if(!a.formScheduler.$invalid){var b=d.matchIps(a.schedulerData.agents);if(b){a.storing=!0;var g=angular.copy(a.schedulerData),h={};if(h.name=g.name,h.src_id=g.toolData.toolId,h.tool_id=g.toolData.toolId,h.agents=b,h.inputs={},_.forEach(g.toolData.inputList,function(a){h.inputs[a.key]=a.value}),h.execUser=g.execUser,"once"===g.mode?(h.task_type="once",h.task_scheduler=moment(g.time).format("YYYY-MM-DD HH:mm:ss")):(h.task_type="crontab",h.task_scheduler=g.time),a.isCreate)j.createScheduler(h).then(function(a){f.success("定时任务创建成功!"),c.go("schedulers.index")}).catch(function(a){"The count of tasks has reached the MAX number: 50"===a.data.msg?f.warning("定时任务数量已经到最大值：50"):e(a)}).finally(function(){a.storing=!1});else{delete h.src_id;var k={agents:i.cmd_config.params.agents,execUser:i.cmd_config.params.execUser,inputs:_.isArray(i.cmd_config.params.inputs)&&0===i.cmd_config.params.inputs.length?{}:i.cmd_config.params.inputs,name:i.name,task_scheduler:i.task_scheduler,task_type:i.task_type,tool_id:i.cmd_config.params.toolId};if(_.isEqual(k,h))return f.success("没做任何修改"),void c.go("schedulers.scheduler.index",{id:i.id});j.updateScheduler(i.id,h).then(function(a){f.success("定时任务修改成功"),c.go("schedulers.scheduler.index",{id:i.id})}).catch(e).finally(function(){a.storing=!1})}}}}}]).controller("SchedulersSelectToolCtrl",["$scope","$timeout","$uibModalInstance","toolList",function(a,b,c,d){function e(a,b){return{category:b,list:a}}function f(a){return a.category.toLowerCase()}function g(a){return a.name.toLowerCase()}d=_.sortBy(d,g);var h=_.chain(d).groupBy("category").map(e).sortBy(f).value();a.toolListGroup=h,a.toolForm={toolId:a.toolId},a.search=function(){var b=(a.filters.q||"").toLowerCase();return b?void(a.toolListGroup=_.chain(d).filter(function(a){return a.name.toLowerCase().indexOf(b)!==-1}).groupBy("category").map(e).sortBy(f).value()):void(a.toolListGroup=h)},a.selectTool=function(a){c.close(a)},b(function(){$(".selected","#select-flow-tool").scrollIntoView(!1)})}]).controller("SchedulersDetailCtrl",["$scope","$state","$stateParams","$uibModal","handleAjaxError","toastr","Schedulers","schedulerData",function(a,b,c,d,e,f,g,h){a.schedulerData=h,a.deleting=!1,a.toolHistory={data:[],paging:{total:0,current:1,page_size:10}},a.getSchedulerHistory=function(){g.getSchedulerHistory({task_id:a.schedulerData.id,page:a.toolHistory.paging.current,page_size:a.toolHistory.paging.page_size}).then(function(b){a.toolHistory.data=b.data,a.toolHistory.paging.total=b.total}).catch(e)},a.getSchedulerHistory(),a.deleteScheduler=function(){a.deleting=!0;var c=d.open({templateUrl:"views/schedulers/_delete-scheduler.html",controller:"SchedulersDeleteCtrl",resolve:{scheduler:a.schedulerData}});c.result.then(function(c){f.success(a.schedulerData.name+" 删除成功!"),a.deleting=!1,b.go("schedulers.index")},function(){a.deleting=!1})},a.showIPs=function(a){d.open({templateUrl:"views/schedulers/_agents-modal.html",controller:"SchedulersShowIPsCtrl",windowClass:"modal__limit-height",resolve:{agents:function(){return a}}})}}]).controller("SchedulersShowIPsCtrl",["$scope","$uibModalInstance","agents",function(a,b,c){a.agents=c,a.cancel=function(){b.dismiss()}}]),angular.module("schedulers.service",[]).factory("Schedulers",["RequestWrapper",function(a){return{createScheduler:function(b){return a.object({method:"POST",url:"/api/schedulers/create",data:b})},getScheduler:function(b){return a.object({method:"GET",url:"/api/schedulers/scheduler/"+b})},updateScheduler:function(b,c){return a.object({method:"PUT",url:"/api/schedulers/scheduler/"+b,data:c})},deleteScheduler:function(b){return a.object({method:"DELETE",url:"/api/schedulers/scheduler/"+b})},getSchedulersList:function(b){return a.object({method:"GET",url:"/api/schedulers/list",params:b})},getSchedulerHistory:function(b){return a.object({method:"GET",url:"/api/schedulers/history",params:b})}}}]).filter("schedulerStatus",[function(){return function(a,b){if(b)if("disable"===b)switch(a){case 0:return"已启用";case 1:return"已停止";default:return a}else if("status"===b)switch(a){case 0:return"正常";case 1:return"异常";default:return a}}}]).filter("schedulerTaskType",[function(){return function(a){switch(a){case"once":return"一次性任务";case"interval":case"crontab":return"周期性任务";default:return a}}}]),angular.module("schedulers.directive",[]).directive("schedulersTimepicker",["$compile","$timeout",function(a,b){return{restrict:"EA",scope:{time:"=",change:"&onChange",className:"@className",name:"@"},replace:!0,templateUrl:"/views/schedulers/_timepicker.html",controller:["$scope",function(a){a.name=angular.isUndefined(a.name)?"scheduler":a.name,a.timeShadow={date:new Date,time:new Date},angular.isDate(a.time)&&(a.timeShadow.date=a.timeShadow.time=angular.copy(a.time)),a.popup={opened:!1,minDate:new Date},a.popup.open=function(){a.popup.opened=!0},a.timeChange=function(){angular.isDate(a.timeShadow.date)&&angular.isDate(a.timeShadow.time)&&(a.time=new Date(a.timeShadow.date.getFullYear(),a.timeShadow.date.getMonth(),a.timeShadow.date.getDate(),a.timeShadow.time.getHours(),a.timeShadow.time.getMinutes(),a.timeShadow.time.getSeconds())),b(function(){a.change(a.time)})}}]}}]).directive("selectOnClick",["$window",function(a){return{restrict:"A",link:function(b,c,d){c.on("click",function(b){a.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]).directive("schedulerResult",["$compile",function(a){return{restrict:"A",scope:{status:"="},replace:!0,link:function(b,c,d){c.html("<i></i> {{text}}"),a(c.contents())(b),b.$watch("status",function(a){var e=getSchedulerStatusStyle(a,d.showText,d.preText);b.text=e.text,c.removeClass(),e.textClass&&c.addClass(e.textClass);var f=c.find("i").removeClass();e.iconClass&&f.addClass(e.iconClass)})}}}]),angular.module("cmdb.devices.cloudHost",["cmdb.service","apps.services","packages.services","flows.service","flows.task","settings.service"]).config(["$stateProvider",function(a){a.state("cmdb.devices.cloudHost",{abstract:"/cloud-host",template:"<ui-view />"}).state("cmdb.devices.cloudHost.purchase",{url:"/cloud-host/purchase",templateUrl:"views/cmdb/devices/cloud-host/purchase.html",controller:"CmdbDevicesCloudHostPurchaseCtrl",resolve:{awsImageData:["CloudHostService",function(a){return a.getAWSImageData()}],appList:["CmdbResourceService",function(a){var b="APP";return a.fetchInstanceList(b)}]}}).state("cmdb.devices.cloudHost.refund",{url:"/cloud-host/refund?instanceIds",templateUrl:"views/cmdb/devices/cloud-host/refund.html",controller:"CmdbDevicesCloudHostRefundCtrl",resolve:{devices:["DeviceService",function(a){return a.fetchDeviceList()}]}})}]).controller("CmdbDevicesCloudHostPurchaseCtrl",["$scope","$state","$stateParams","$timeout","$location","CloudHostService","handleAjaxError","toastr","Flows","AppService","DeployService","$uibModal","appList","awsImageData","Dialog","$aside","Keys","$localStorage",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(b,c){"ok"===a.taskData.status||"failed"===a.taskData.status?_.isFunction(c)&&c():w=d(function(){w=null,t(b,c)},3e3)}function t(b,c){var d=!a.taskData;k.getBatchDeployTask(b,{cloud_host:!0},{track:!1}).then(function(b){a.taskData=_.merge(a.taskData,b),d&&$("html body").animate({scrollTop:$(document).height()},"fast");try{var c=_.find(a.taskData.taskList[0].taskInfo.stepList,{stepId:1});c.outputs.host_info&&(a.hostInfo=JSON.parse(c.outputs.host_info))}catch(a){}if(a.taskData.taskList&&!a.taskData.taskList[0].taskInfo){var e=a.taskData.targetConfig.targetId;i.fetchFlow(e).then(function(b){a.taskData.taskList[0].taskInfo={},a.taskData.taskList[0].taskInfo.stepList=_.map(b.stepList,function(a){return a.status="wait",a})}).catch(g)}}).catch(g).finally(function(){s(b,c)})}function u(){"ok"===a.taskData.status?h.success("购买成功"):h.error("购买失败，请重试"),a.submitting=!1}q.getKeysList().then(function(b){a.keys=b.list}).catch(g),a.dismissAwsCN=r.dismissAwsCN,a.dismissAlert=function(b,c){"awsCN"===b?(a.dismissAwsCN=!0,c&&(r.dismissAwsCN=!0)):"patient"===b&&(a.dismissAlertPatient=!0)};var v=[{index:0,name:"云主机列表",path:"views/cmdb/devices/cloud-host/_list.html"},{index:1,name:"云主机配置",path:"views/cmdb/devices/cloud-host/_config.html"}];a.stepTpl=v[0],a.imageList=n,a.instanceTypeList=[],a.submitting=!1,a.host={image:null,instance_type:"",count:1,app:null,cluster:null,proxy_ip:""},a.hostInfo=[],a.selectApp=function(){var b=a.$new(!0),c=l.open({templateUrl:"views/cmdb/devices/cloud-host/_select-app.html",backdrop:"static",scope:b,controller:"CmdbDevicesCloudHostSelectAppCtrl",resolve:{appList:function(){return m}}});c.result.then(function(b){a.host.app=b,j.fetchApp(b.instanceId).then(function(b){b.clusters?(a.clusterList=b.clusters,a.host.cluster=a.clusterList[0]):a.clusterList=a.host.cluster=null}).catch(g)})},a.createCluster=function(b){var c=l.open({templateUrl:"views/cmdb/devices/cloud-host/_create-cluster.html",backdrop:"static",controller:"CmdbDevicesCloudHostCreateClusterCtrl",resolve:{appData:function(){return b}}});c.result.then(function(){h.success("集群创建成功！"),j.fetchApp(b.instanceId).then(function(b){b.clusters?(a.clusterList=b.clusters,a.host.cluster=a.clusterList[0]):a.clusterList=a.host.cluster=null}).catch(g)})},a.lastStep=function(){var b=a.stepTpl.index-1;b<0||(a.stepTpl=v[b],a.taskData=null,a.submitting=!1)},a.nextStep=function(b){if(a.keys.length){var c=a.stepTpl.index+1;if(!(c>=v.length)){a.stepTpl=v[c],a.host={image:b,instance_type:"",count:1,app:null,cluster:null};var d=[];_.forEach(b.instanceType,function(a){var b=a.name,c=a["zh-CN"];_.forEach(a.types,function(a){var e={family:{name:b,zhCN:c},name:a};d.push(e)})}),a.instanceTypeList=d}}},a.getHostIps=function(){return _.map(a.hostInfo,"PrivateIpAddress").join("\n")},a.clearOptionInputs=function(){a.host.app=null,a.host.cluster=null,a.clusterList=null,a.host.proxy_ip=""};var w;a.submit=function(){if(!a.host.image)return void h.warning("请选择主机！");a.submitting=!0;var b={image_id:a.host.image.id,instance_type:a.host.instance_type,count:a.host.count,client_url:e.host()};a.host.cluster&&(b.cluster_id=a.host.cluster.instanceId),a.host.proxy_ip&&(b.proxy_ip=a.host.proxy_ip),a.taskData=null,f.submitOrder(b).then(function(a){var b=a.taskId;t(b,u)}).catch(function(b){g(b,"购买云主机"),a.submitting=!1})};var x;a.showStepDetail=function(b){if("wait"!==b.status&&"executing"!==b.status){x&&x.dismiss();var c=a.$new();c.step=b,c.isCloudHostTask=!0,x=p.open({templateUrl:"views/flows/_task-step-detail.html",scope:c,backdrop:!1,windowClass:"no-backdrop",size:"lg",controller:"FLowsTaskStepDetailCtrl"})}},a.retryDeploy=function(b){var c=_.find(b.taskInfo.stepList,{status:"failed"});return c?void i.retryStep(b.taskId,c.stepId).then(function(){var b=a.taskData.mainTaskId;t(b,u)}).catch(function(a){g(a,"重试")}):void o.alert({type:"warning",message:"没有找到暂停的步骤！"})},a.$on("$destroy",function(){w&&d.cancel(w)})}]).controller("CmdbDevicesCloudHostSelectAppCtrl",["$scope","$uibModalInstance","appList",function(a,b,c){a.appList=c,a.filters={q:""},a.search=function(){var b=a.filters.q;b?a.appList=_.filter(c,function(a){return _.includes(a.name.toLowerCase(),b.toLowerCase())}):a.appList=c},a.selectApp=function(a){b.close(a)}}]).controller("CmdbDevicesCloudHostCreateClusterCtrl",["$scope","$uibModalInstance","toastr","appData","handleAjaxError","ClusterService",function(a,b,c,d,e,f){a.storing=!1,a.appData=d,a.clusterForm={},a.selectDevices=function(b){a.clusterForm.ipList=_.map(b,"ip").join(", "),a.clusterForm.deviceList=_.map(b,"instanceId"),a.deviceCount=b?b.length:0},a.store=function(){if(a.formCreateCluster.$invalid){var c=$("form[name=formCreateCluster] .ng-invalid"),g=c.closest(".form-group");return void(g.length?g:c).scrollIntoViewInBody()}var h=_.pick(a.clusterForm,"name","type","deviceList");h.appId=d.instanceId,a.storing=!0,f.storeCluster(h).then(function(a){b.close(a)}).catch(function(a){e(a,"创建集群")}).finally(function(){a.storing=!1})}}]).controller("CmdbDevicesCloudHostRefundCtrl",["$scope","$state","$stateParams","handleAjaxError","toastr","DeviceService","DeployService","$timeout","Flows","CloudHostService","Abject","devices","Dialog","$aside",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b,c){"run"===a.taskData.status?r=h(function(){r=null,p(b,c)},3e3):_.isFunction(c)&&c()}function p(b,c){g.getBatchDeployTask(b,{cloud_host:!0},{track:!1}).then(function(b){if(a.taskData=_.merge(a.taskData,b),a.taskData.taskList&&!a.taskData.taskList[0].taskInfo){var c=a.taskData.targetConfig.targetId;i.fetchFlow(c).then(function(b){a.taskData.taskList[0].taskInfo={},a.taskData.taskList[0].taskInfo.stepList=_.map(b.stepList,function(a){return a.status="wait",a})}).catch(d)}}).catch(d).finally(function(){o(b,c)})}function q(){"failed"===a.taskData.status?(e.error("退还失败，请重试"),a.busy=!1):e.success("退还成功！")}a.devicesList=_.filter(l,function(a){var b=c.instanceIds&&c.instanceIds.split(",")||[];return _.includes(b,a.instanceId)}),a.devicesCanRefund=a.devicesList,a.isCloudHost=function(a){var b=["AWS"];return _.includes(b,a.provider)},_.forEach(a.devicesList,function(a){a._displayOwner=function(a){return _.map(a,"name").join("; ")}}),a.busy=!1,k.getReferencedAbject({ref_object:"HOST"}).then(function(b){_.forEach(b,function(b){_.forEach(a.devicesList,function(a){k.getInstanceReferencedAbject(b.objectId,{ref_object:"HOST",ref_instance:a.instanceId}).then(function(b){b.length&&(a.clusters=b)}).catch(d)})})}).catch(d);var r;a.canRefund=function(){return a.devicesCanRefund=_.filter(a.devicesList,function(b){return a.isCloudHost(b)&&!b.clusters}),!!a.devicesCanRefund.length},a.getDevicesCanRefundIps=function(){return _.map(a.devicesCanRefund,"ip").join("\n")},a.refund=function(){a.busy=!0,a.taskData={};var b=_.map(a.devicesCanRefund,function(a){return{ip:a.ip,instanceId:a.instanceId}});j.refund(b).then(function(a){var b=a.taskId;p(b,q)}).catch(function(b){d(b),a.busy=!1})};var s;a.showStepDetail=function(b){if("wait"!==b.status&&"executing"!==b.status){s&&s.dismiss();var c=a.$new();c.step=b,c.isCloudHostTask=!0,s=n.open({templateUrl:"views/flows/_task-step-detail.html",scope:c,backdrop:!1,windowClass:"no-backdrop",size:"lg",controller:"FLowsTaskStepDetailCtrl"})}},a.retryDeploy=function(b){var c=_.find(b.taskInfo.stepList,{status:"failed"});return c?void i.retryStep(b.taskId,c.stepId).then(function(){var b=a.taskData.mainTaskId;p(b,q)}).catch(function(a){d(a,"重试")}):void m.alert({type:"warning",message:"没有找到暂停的步骤！"})},a.$on("destroy",function(){r&&h.cancel(r)})}]),angular.module("settings",["settings.keys"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("settings",{abstract:!0,url:"/settings",templateUrl:"views/settings/abstract.html",controller:"SettingsAbstractCtrl"}),b.when("/settings","/settings/keys")}]).controller("SettingsAbstractCtrl",["$scope","$state",function(a,b){a.$state=b}]),angular.module("settings.keys",["settings.service"]).config(["$stateProvider","$urlRouterProvider",function(a){a.state("settings.keys",{abstract:!0,url:"/keys",template:"<ui-view />"}).state("settings.keys.index",{url:"?q&page&pageSize",templateUrl:"views/settings/keys/graphs.html",controller:"SettingsKeysIndexCtrl",reloadOnSearch:!1,resolve:{keysData:["$stateParams","Keys",function(a,b){return b.getKeysList()}]}}).state("settings.keys.create",{url:"/create",templateUrl:"views/settings/keys/create.html",controller:"SettingsKeysCreateCtrl"})}]).controller("SettingsKeysIndexCtrl",["$scope","$state","$stateParams","Keys","handleAjaxError","keysData","toastr","$uibModal","checkPermission",function(a,b,c,d,e,f,g,h,i){var j=_.orderBy(f.list,["ctime"],["desc"]),k=j;a.filters={q:""},a.keyPermission=i("cmdb.cloudKey"),a.totalKeys=k.length,a.page=+c.page||1,a.pageSize=+c.pageSize||15,a.filters.q=c.q||"",a.search=function(){var d=a.filters.q;b.go(b.current.name,angular.extend({},c,{q:d,page:1}),{reload:!1}),k=""===d?j:_.filter(j,function(a){return _.includes(a.company,d)||_.includes(a.name,d)}),a.pageChange()},a.pageChange=function(){b.go(b.current.name,angular.extend({},c,{page:a.page}),{reload:!1}),a.keysList=k.slice((a.page-1)*a.pageSize,a.page*a.pageSize-1),a.totalKeys=k.length},a.search(),a.deleteKey=function(c){if(a.keyPermission){var d=h.open({templateUrl:"views/settings/keys/_delete-key.html",controller:"SettingsKeysDeleteCtrl",resolve:{key:c}});d.result.then(function(){g.success("删除成功"),b.reload()})}}}]).controller("SettingsKeysDeleteCtrl",["$scope","$uibModalInstance","handleAjaxError","toastr","Keys","key",function(a,b,c,d,e,f){a.key=f,a.busy=!1,a.delete=function(){a.busy=!0,e.deleteKey(f._id).then(function(a){b.close(a)}).catch(c).finally(function(){a.busy=!1})},a.cancel=function(){b.dismiss()}}]).controller("SettingsKeysCreateCtrl",["$scope","$state","$stateParams","Dialog","toastr","handleAjaxError","Keys",function(a,b,c,d,e,f,g){function h(){j=null,a.formData.secretFile=null}function i(c,h){g.createKey(c,h).then(function(){e.success("创建密钥成功"),a.storing=!1,b.go("settings.keys.index")}).catch(function(b){130313===b.data.code?d.confirm({message:"已存在相同密钥，确认覆盖吗？",isDanger:!0,confirmText:"覆盖",resolved:function(){i(c,{force:!0})},reject:function(){a.storing=!1}}):(f(b),a.storing=!1)})}a.storing=!1,a.formData={company:"Amazon Web Services",name:"",accessKey:"",secretKey:"",secretFile:null};var j;a.drop=function(a){j=a},a.$watch("invalidFile",function(a){a&&d.alert({type:"warning",message:a.name+": 文件不符合条件",callback:h})}),a.submit=function(){if(!j)return void d.alert({type:"warning",message:"请选择私钥文件"});a.storing=!0;var b=angular.copy(a.formData),c={name:b.name,company:b.company,key_id:b.accessKey,secret:b.secretKey,secretFile:j};i(c)}}]),angular.module("settings.service",[]).factory("Keys",["RequestWrapper","Upload",function(a,b){return{getKeysList:function(b){return a.object({method:"GET",url:"/api/keys/list",params:b})},createKey:function(a,c){return b.upload({url:"/api/keys/create",data:a,params:c})},getKey:function(b,c){return a.object({method:"GET",url:"/api/keys/"+b,params:c})},updateKey:function(b,c){return a.object({method:"PUT",url:"/api/keys/"+b,data:c})},deleteKey:function(b){return a.object({method:"DELETE",url:"/api/keys/"+b})}}}]),angular.module("userManage.route",[]).config(["$stateProvider",function(a){a.state("userManage",{abstract:!0,url:"/user",templateUrl:"views/userManage/userManage.html",controller:"userManageAbstractCtrl",resolve:{modelData:["CmdbModelService",function(a){return a.fetchModel("USER")}]}}).state("userManage.list",{url:"",templateUrl:"views/userManage/user-list.html",controller:"userListCtrl",resolve:{userList:["UserManage","$stateParams",function(a,b){var c={page:b.page,pageSize:b.pageSize,state:b.state};return a.fetchUserList(c)}],roleList:["Permission",function(a){return a.fetchRoleList()}]}}).state("userManage.detail",{url:"/:name",templateUrl:"views/userManage/user-detail.html",controller:"userDetailCtrl",resolve:{userDetail:["UserManage","$stateParams",function(a,b){var c=b.name;return a.fetchUserDetail(c)}],systemData:["Permission",function(a){return a.fetchRoleList({role:"系统管理员"})}],roleList:["Permission",function(a){return a.fetchRoleList()}]}}).state("userManage.edit",{url:"/:name/edit",templateUrl:"views/userManage/user-edit.html",controller:"userDetailCtrl",resolve:{userDetail:["UserManage","$stateParams",function(a,b){var c=b.name;return a.fetchUserDetail(c)}],systemData:["Permission",function(a){return a.fetchRoleList({role:"系统管理员"})}],roleList:["Permission",function(a){return a.fetchRoleList()}]}}).state("userGroup",{url:"/group",abstract:!0,templateUrl:"views/userManage/userManage.html",controller:"userManageAbstractCtrl",resolve:{modelData:["CmdbModelService",function(a){return a.fetchModel("USER")}]}}).state("userGroup.list",{url:"",templateUrl:"views/userManage/user-group-list.html",controller:"userGroupListCtrl",resolve:{userGroupList:["UserManage",function(a){return a.fetchAllUserGroupList()}],userList:["UserManage","$stateParams",function(a,b){var c={page:b.page,pageSize:b.pageSize,state:b.state};return a.fetchUserList(c)}],roleList:["Permission",function(a){return a.fetchRoleList()}]}})}]),angular.module("userManage.ctrl",[]).controller("userManageAbstractCtrl",["$scope","modelData","$state",function(a,b,c){var d=["name","user_email","user_tel","user_type","user_active","user_memo"];a.extraAttrList=_.filter(b.attrList,function(a){return!_.includes(d,a.id)}),a.navUserActive=function(){return c.includes("userManage")},a.navUserGroupActive=function(){return c.includes("userGroup")}}]).controller("userListCtrl",["$scope","$stateParams","$state","Utils","roleList","userList","checkPermission",function(a,b,c,d,e,f,g){function h(a){var b={};return angular.forEach(a,function(c,d){b[d]=a[d]===c?null:c}),b}function i(b){var e=l.page,f=l.pageSize,g=(l.q||"").toLowerCase(),i=_.filter(m,function(a){var b=a.name.toLowerCase(),c=a.user_email&&a.user_email.toLowerCase(),d=null!==a.user_tel&&a.user_tel?a.user_tel.toString():null;return b.indexOf(g)!==-1||c&&c.indexOf(g)!==-1||null!==d&&d.indexOf(g)!==-1});a.showUserList=i.slice((e-1)*f,e*f),a.totalItems=i.length,a.searched=!!g,b||c.go(c.current.name,h(l),{location:"replace"}),d.scrollToContentTop()}a.active=!0,a.roleList=_.sortBy(e,["name"]),a.allRoleActive="active",a.lockUserActive="",a.searchId=-1,a.hasVisitPermission=function(){return g("cmdb:USER_instance_access")},_.forEach(f,function(a){var b=a.name,c="";_.forEach(e,function(a){_.includes(a.user,b)&&(c=""===c?a.role:c+"; "+a.role)}),a.role=c}),a.pageSizeList=[20,50,100];var j=_.sortBy(_.filter(f,{state:"valid"}),function(a){return a.name.toLowerCase()}),k=_.filter(f,{state:"invalid"}),l={page:1,pageSize:a.pageSizeList[0]},m=j;a.filters=l,a.totalItems=f.length,a.buttonShow="全部角色 ",a.searchByName=function(){l.page=1,i()},a.searchByRole=function(b,c){l.page=1,a.filters.q="","all"===b?(m=j,a.buttonShow="全部角色 ",a.allRoleActive="active",a.lockUserActive="",a.searchId=-1):"locked"===b?(a.buttonShow="已屏蔽用户 ",a.lockUserActive="active",m=k,a.allRoleActive="",a.searchId=-1):(a.buttonShow=b.role+" ",a.searchId=c,a.allRoleActive="",a.lockUserActive="",m=_.filter(j,function(a){var c=a.role.split(";"),d=[];return _.forEach(c,function(a){d.push(a.replace(/(^\s*)|(\s*$)/g,""))}),_.includes(d,b.role)})),a.totalItems=m.length,a.showUserList=m.slice((l.page-1)*l.pageSize,l.page*l.pageSize)},a.totalItems=m.length,a.showUserList=m.slice((l.page-1)*l.pageSize,l.page*l.pageSize),a.pageChange=function(a){"pageSize"===a&&(l.page=1),i()}}]).controller("userDetailCtrl",["$scope","$state","$timeout","UserManage","userDetail","roleList","Permission","systemData","USERNAME","IS_SYSTEM_ADMIN","handleAjaxError","toastr","Dialog","checkPermission",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(b,c){_.forEach(b,function(b){var d=_.findIndex(f,{role:b}),e=f[d].id;g.addUser(e,c).then(function(b){b.code?a.modifyRoleSucceed.addSucceed=!1:a.modifyRoleSucceed.addSucceed=!0}).catch(function(a){k(a,"添加角色")}).finally(function(){a.modifyRoleSucceed.addSucceed&&l.success("添加角色成功")})})}function p(b,c){_.forEach(b,function(b){var d=_.findIndex(f,{
role:b}),e=f[d].id;g.deleteUser(e,c).then(function(b){b.code?a.modifyRoleSucceed.removeSucceed=!1:a.modifyRoleSucceed.removeSucceed=!0}).catch(function(a){k(a,"删除角色")}).finally(function(){a.modifyRoleSucceed.removeSucceed&&l.success("删除角色成功!")})})}a.currentUserName=e.name,a.isEdit=!1,a.hasManagePermission=function(){return n("cmdb:USER_instance_manage")},a.isAdmin=function(){return j},a.isSelf=function(){return a.currentUserName===i},a.selectedRole=void 0===e.role?[]:e.role.split(",");var q=[],r=[];a.userDetail=e,a.canLock="valid"===e.state,a.newUserInfo={role:a.selectedRole,email:e.user_email,tel:e.user_tel,password:"",passwordSecond:""},a.checkboxRole=[],a.roleList=[],_.forEach(f,function(b){a.roleList.push(b.role),_.includes(a.selectedRole,b.role)?a.checkboxRole.push(!0):a.checkboxRole.push(!1)}),a.edit=function(){a.isEdit=!0},a.addRoleTag=function(a){q.push(a)},a.removeRoleTag=function(a){r.push(a)},a.modifyRoleSucceed={addSucceed:void 0,removeSucceed:void 0},a.savePwd=function(c){if(!c.$invalid)return a.newUserInfo.password!==a.newUserInfo.passwordSecond?void m.alert({type:"warning",message:"两次输入的密码不一致,请重新输入！"}):void d.modifyUserPwd(a.currentUserName,a.newUserInfo.password).then(function(){l.success("用户密码修改成功!"),b.go("userManage.detail",{name:a.currentUserName},{reload:!0})}).catch(function(c){k(c,"修改密码"),b.go("userManage.detail",{name:a.currentUserName})}).finally(function(){})},a.saveBaseInfo=function(e){e.$invalid||d.modifyUserBaseInfo(a.currentUserName,a.newUserInfo.email,a.newUserInfo.tel).then(function(){l.success("基础信息修改成功!"),c(function(){b.go("userManage.detail",{name:a.currentUserName},{reload:!0})},200)}).catch(function(c){k(c,"基础信息修改"),b.go("userManage.detail",{name:a.currentUserName})})},a.saveRole=function(){var d=[];_.forEach(a.checkboxRole,function(b,c){b&&d.push(a.roleList[c])}),_.forEach(d,function(b){_.includes(a.selectedRole,b)||q.push(b)}),_.forEach(a.selectedRole,function(a){_.includes(d,a)||r.push(a)}),q.length&&o(q,a.currentUserName),r.length&&p(r,a.currentUserName),c(function(){b.go("userManage.detail",{name:a.currentUserName},{reload:!0})},200)},a.$watch("modifyRoleSucceed",function(a,b){a!==b&&(a.addSucceed&&a.removeSucceed?l.success("用户角色修改成功!"):a.addSucceed&&!a.removeSucceed?l.error("添加角色成功，删除角色失败!"):!a.addSucceed&&a.removeSucceed?l.error("删除角色成功，添加角色失败!"):l.error("用户角色修改失败!"))}),a.cancel=function(){b.go("userManage.detail",{name:a.currentUserName},{reload:!0})},a.deleteUser=function(){m.confirm({type:"warning",message:"确定删除该用户吗？",html:!0,resolved:function(){d.deleteUser(a.currentUserName).then(function(){l.success("删除用户成功!"),b.go("userManage.list")}).catch(function(a){k(a)})},rejected:function(){return!1}})},a.lockUser=function(){m.confirm({type:"warning",message:"确定禁用该用户吗？禁用后,该用户将无法登录",html:!0,resolved:function(){d.lockUser(a.currentUserName).then(function(){l.success("用户已被禁用!"),b.go("userManage.detail",{name:a.currentUserName},{reload:!0})}).catch(function(a){k(a)})},rejected:function(){return!1}})},a.unlockUser=function(){m.confirm({type:"warning",message:"确定取消禁用该用户吗？取消后,该用户可正常登录",html:!0,resolved:function(){d.unlockUser(a.currentUserName).then(function(){l.success("取消禁用成功!"),b.go("userManage.detail",{name:a.currentUserName},{reload:!0})}).catch(function(a){k(a)})},rejected:function(){return!1}})}}]).controller("userGroupListCtrl",["$scope","$state","userGroupList","UserManage","$uibModal","handleAjaxError","checkPermission","Dialog","toastr","userList",function(a,b,c,d,e,f,g,h,i,j){function k(b){return b.slice((a.filter.page-1)*a.filter.itemsPerPage,a.filter.page*a.filter.itemsPerPage)}function l(a){return _.orderBy(a,"_ts","desc")}function m(a){return _.filter(j,{instanceId:a})[0].name}function n(a){return _.filter(c,{instanceId:a})[0].name}var o=a.userGroupList=c;a.pageSizeList=[20,50,100],a.filter={page:1,q:"",itemsPerPage:a.pageSizeList[0]},a.hasManagePermission=function(){return g("cmdb:USER_GROUP_instance_manage")},a.hasVisitPermission=function(){return g("cmdb:USER_GROUP_instance_access")},a.totalItems=a.userGroupList.length,a.showGroupList=k(l(a.userGroupList)),a.pageChange=function(b){"pageSize"===b&&(a.filter.page=1),a.showGroupList=k(l(o))},a.searchByName=function(){""===a.filter.q?(o=a.userGroupList,a.showGroupList=k(l(o)),a.totalItems=o.length):(o=_.filter(a.userGroupList,function(b){return b.name.toLowerCase().indexOf(a.filter.q.toLowerCase())!==-1}),a.showGroupList=k(l(o)),a.totalItems=o.length)};var p=a.$new(!0);p.form={users:[]},p.isEdit=!1,p.usersInGroup=[],p.userList=j,a.createUserGroup=function(){var a=e.open({templateUrl:"views/userManage/_add_user_group.html",controller:"addUserGroupCtrl",scope:p,backdrop:!1});a.result.then(function(a){a&&b.reload()})},a.deleteUserGroup=function(a){h.confirm({type:"warning",message:"确定要删除用户组"+n(a)+"吗?",resolved:function(){d.deleteUserGroup(a).then(function(){i.success("删除用户组成功!"),b.reload()}).catch(function(a){f(a)})},rejected:function(){return!1}})},a.usersInGroup=[],a.locateThisGroup=function(b){a.currentGroupId=b;var d=_.find(c,{instanceId:b});a.usersInGroup=[],_.forEach(d._members,function(b){a.usersInGroup.push(b.instanceId)}),a.description=d.description},a.modifyGroupInfo=function(d){var f=_.find(c,{instanceId:d}),g=a.$new(!0);g.group={id:f.instanceId,name:f.name,description:f._description,users:[]},_.forEach(f._members,function(a){g.group.users.push(a.instanceId)}),g.form={users:a.usersInGroup},g.userList=j,g.isEdit=!0;var h=e.open({templateUrl:"views/userManage/_add_user_group.html",controller:"addUserGroupCtrl",scope:g,backdrop:!1});h.result.then(function(a){a&&b.reload()})},a.newForm={users:[]},a.$watch("newForm.users",function(c){if(c.length){var e=c;_.forEach(a.usersInGroup,function(a){e.push(a)});var g={_description:a.description,_members:e};d.modifyUserGroup(a.currentGroupId,g).then(function(){i.success("添加用户成功"),b.reload()}).catch(function(a){f(a)}).finally(function(){a.completed=!0})}}),a.groupDeleteUser=function(c,e){a.locateThisGroup(c);var g=_.filter(a.usersInGroup,function(a){return a!==e}),j={_description:a.description,_members:g};h.confirm({type:"warning",message:"确定要将用户"+m(e)+"从用户组"+n(c)+"中删除吗?",resolved:function(){d.modifyUserGroup(c,j).then(function(){i.success("删除用户成功"),b.reload()}).catch(function(a){f(a)})}})}}]).controller("addUserGroupCtrl",["$scope","UserManage","toastr","$uibModalInstance","handleAjaxError",function(a,b,c,d,e){a.isEdit||(a.group={name:"",description:"",users:[]},a.form={users:[]}),a.$ok=function(f){if(a.click=!0,!f.groupName.$error.pattern&&!f.groupName.$error.required){var g={name:a.group.name,_description:a.group.description,_members:a.group.users},h=!1;a.isEdit?b.modifyUserGroup(a.group.id,g).then(function(){c.success("修改用户组成功!"),h=!0}).catch(function(a){e(a)}).finally(function(){a.click=!1,d.close(h)}):b.createUserGroup(g).then(function(){c.success("添加用户组成功!"),h=!0}).catch(function(a){e(a)}).finally(function(){a.click=!1,d.close(h)})}},a.$dismiss=function(){a.newGroupName="",d.close()},a.$watch("form.users",function(b){b.length&&_.forEach(b,function(b){a.group.users.push(b)})}),a.getUserName=function(b){return _.filter(a.userList,{instanceId:b})[0].name},a.deleteUser=function(b){_.remove(a.group.users,function(a){return a===b})}}]),angular.module("userManage.service",[]).factory("UserManage",["RequestWrapper",function(a){return{fetchUserList:function(b){return a.array({url:"/api/userManage-list",method:"GET",params:b})},fetchUserDetail:function(b){return a.object({url:"/api/userManage-detail/"+b,method:"GET"})},deleteUser:function(b){return a.object({url:"/api/userManage-detail/"+b,method:"DELETE"})},modifyUserBaseInfo:function(b,c,d){return a.object({url:"/api/userManage-detail/"+b,method:"PUT",data:{email:c,phone:d}})},modifyUserPwd:function(b,c){return a.object({url:"/api/userManage-detail/"+b,method:"PUT",data:{password:c}})},lockUser:function(b){return a.object({url:"/api/userManage-detail/"+b+"/_block",method:"PUT"})},unlockUser:function(b){return a.object({url:"/api/userManage-detail/"+b+"/_unblock",method:"PUT"})},fetchAllUserGroupList:function(){return a.array({url:"/api/user-group-list",method:"GET"})},createUserGroup:function(b){return a.object({url:"/api/add-user-group",method:"PUT",data:b})},deleteUserGroup:function(b){return a.object({url:"/api/delete-user-group/"+b,method:"DELETE"})},modifyUserGroup:function(b,c){return a.object({url:"/api/modify-user-group/"+b,method:"PUT",data:c})}}}]),angular.module("externals",[]).factory("Externals",["$q","EXTERNAL_LINKS","BUILT_IN_EXTERNAL_LINKS",function(a,b,c){return{getLinkById:function(d,e){var f=a.defer(),g=d&&(_.find(b&&b.links,{id:d})||_.find(c,{id:d}));return g&&g.src?(_.isFunction(g.src)&&(g={id:g.id,src:g.src(e)}),f.resolve(g)):f.reject(),f.promise}}}]).controller("ExternalsCtrl",["$scope","$sce","linkData",function(a,b,c){function d(){var a=e.height();a-=g,f.hasClass("body-nav-breaked")&&(a-=g),$("#externals-iframe").css("height",a)}var e=$(window),f=$(document.body),g=50;e.on("resize",d),d(),a.src=b.trustAsResourceUrl(c.src),f.addClass("body-externals"),a.$on("$destroy",function(){f.removeClass("body-externals"),e.off("resize",d)})}]);